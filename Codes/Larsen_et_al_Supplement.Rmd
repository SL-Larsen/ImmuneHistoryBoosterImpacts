---
title: "Supplementary figures"
author: "SLL, PPM, ANMK"
date: "January 2024"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(slider)
library(Hmisc) # for mean cl normal which gives confidence intervals
library(tidyverse)
library(cowplot)
library(MetBrewer)
library(MexBrewer)
library(ggpubr)
library(viridis)
library(RColorBrewer)
library(ggh4x)
library(oce)
library(ggrepel)

#library(feathers)
library(PNWColors)


library(tidyverse)
library(readxl)
library(scales)
library(Hmisc)
```


## Load ABM data

```{r}

## protection grids ##

serotypes <- read_csv("../Data/ABM_Parameters_Data/paramScale_MonOm.csv")


## outputs of model ##

## get ABM seed populations for each country ##
pop_ABM <- read_csv("../Data/ABM_Parameters_Data/Grid_Param.csv") %>% select(Name, child, adult, old) %>% 
  summarise(Name,start_pop = 2*(child + adult+ old)) %>% 
  distinct() %>% 
  arrange(Name) %>% 
  rename(country = Name)

## change time to date
start_sims <- as.Date("2020-03-15", "%Y-%m-%d") 

dataAll <- read_csv("../Data/ABM Main Runs/dataAll.csv")%>% 
  left_join(pop_ABM) %>%
  group_by(ID_runs, time) %>% 
  filter(cum_sum_Inf == max(cum_sum_Inf)) %>%
  ungroup() %>%
  mutate(time = start_sims + time) ## take out this line to get back to days instead of dates 

dataHistories <- read_csv("../Data/ABM Main Runs/dataHistories.csv") 

dataHistories899 <- read_csv("../Data/ABM Main Runs/dataHistories899.csv")


## supp1 - slow booster rollout, comparable to first vaccine intervention
data_supp1_slow_rollout <- read_csv("../Data/ABM Supplement/supp1-slow_rollout/dataAll.csv")%>% 
  left_join(pop_ABM) %>% 
  group_by(ID_runs, time) %>% 
  filter(cum_sum_Inf == max(cum_sum_Inf)) %>%
  ungroup() %>% 
  mutate(time = start_sims + time) ## take out this line to get back to days instead of dates 

## supp2 - vaccinating through Omicron*
data_supp2_vaccine_star<- read_csv("../Data/ABM Supplement/supp2-vaccine_star/dataAll.csv")%>% 
  left_join(pop_ABM) %>%
  group_by(ID_runs, time) %>% 
  filter(cum_sum_Inf == max(cum_sum_Inf)) %>%
  ungroup() %>% 
  mutate(time = start_sims + time) ## take out this line to get back to days instead of dates 

## supp3 - "same efficacy" booster scenario
data_supp3_same_efficacy<- read_csv("../Data/ABM Supplement/supp3-same_efficacy/dataAll.csv")%>% 
  left_join(pop_ABM) %>%
  group_by(ID_runs, time) %>% 
  filter(cum_sum_Inf == max(cum_sum_Inf)) %>%
  ungroup() %>% 
  mutate(time = start_sims + time) ## take out this line to get back to days instead of dates 

## supp4 - "same endpoint" booster scenario
data_supp4_same_endpoint<- read_csv("../Data/ABM Supplement/supp4-same_endpoint/dataAll.csv")%>% 
  left_join(pop_ABM) %>%
  group_by(ID_runs, time) %>% 
  filter(cum_sum_Inf == max(cum_sum_Inf)) %>%
  ungroup() %>% 
  mutate(time = start_sims + time) ## take out this line to get back to days instead of dates 


## supp5 - Malaysia boosting
data_supp5_boost_Malaysia<- read_csv("../Data/ABM Supplement/supp5-boost_like_Malaysia/dataAll.csv")%>% 
  left_join(pop_ABM) %>% 
  group_by(ID_runs, time) %>% 
  filter(cum_sum_Inf == max(cum_sum_Inf)) %>%
  ungroup() %>% 
  mutate(time = start_sims + time) ## take out this line to get back to days instead of dates 

## WHO data ##

start <- as.Date("2020-01-03", "%Y-%m-%d")


dataWHO <- read_csv("../Data/WHO_cases/WHO-COVID-19-global-data.csv") %>% 
  filter(Country %in% c("Ecuador", "India", "Malaysia")) %>% 
  arrange(Date_reported) %>% 
  #mutate(time = difftime(as.Date(Date_reported, "%Y-%m-%d"), start, units = "days")) %>% 
  #mutate(time = gsub(" days", "", time),
         #time = as.numeric(time)) %>% 
  select(Date_reported, Country, New_cases, Cumulative_deaths) %>% 
  mutate(population = case_when(
    Country == "Ecuador" ~ 15735139,
    Country == "Malaysia" ~ 28552712,
    Country == "India"~ 1155561222
  )) %>% 
  mutate(infs_perc = New_cases/population,
         deaths_perc = Cumulative_deaths/population)

## vaccine trends ##

dataTexampAll <- read_csv("../Data/vaccine_trends/dataTexampAll.csv") %>%
  filter(Name %in% c("India", "Ecuador","Malaysia"))

```
## S16 - ABM histories
```{r}

datHistBar <-dataHistories %>% 
  filter(time == max(time)) %>%
  #filter(time >= 21*30) %>% filter(time == min(time)) %>% ## december 2021
    mutate(history_counts = round(history_counts, 1)) %>%
  mutate(history_types= recode(history_types,
                               WT_vaccine = "WT + vaccine",
                               Delta_vaccine = "Delta + vaccine",
                               Omicron_vaccine = "Omicron + vaccine",
                               two = "Two events, other",
                               three = "Three events, other",
                               four = "Four or more immune events"
                               
  )) %>%
  mutate(history_types = fct_relevel(
    history_types,
    c("Naive", "Vaccine","Vaccine + booster","WT", "WT + vaccine", "WT + vaccine + booster",
      "Delta", "Delta + vaccine", "Delta + vaccine + booster",
      "Omicron", "Omicron + vaccine", "Omicron + vaccine + booster",
      "Omicron*", "Omicron* + vaccine", "Omicron* + vaccine + booster",
      "Two events, other", "Three events, other", "Four or more immune events"
    )
  ))

```

```{r}

colors <- c("#4B859F", "#0D3660","#6E8740", "#005B40", "#EE8768", 
            "#BD451D", "#E18A8D", "#7C2529",
            "#DFB81F", "#BC8400", "#6e500c")

S16 <- datHistBar %>%
  mutate(country = case_when(
    country == "Ecuador" ~ "Ecuador-like",
    country == "India" ~ "India-like",
    country == "Malaysia" ~ "Malaysia-like"
  )) %>%
  pivot_wider(names_from = name, values_from = history_counts) %>%
  ggplot(aes(x = country, fill = history_types, color= history_types)) +
  geom_bar(aes(y=Mean), stat="identity", position=position_dodge(0.7),  
           alpha=0.5, size = 0.6, width = 0.6) + theme_classic() +
  geom_errorbar(aes(ymin  = Lower, ymax  = Upper),
           stat="identity", position=position_dodge(0.7),  
           size = 0.6, width = 0.3, show.legend=FALSE) + 
  scale_y_continuous("History prevalence (%)", limits = c(0, 42), expand = c(0,0)) +
  scale_x_discrete("Country", expand = c(0,0)) + 
  #facet_wrap(~country, scales = "free") + 
  scale_fill_manual("Immune history", values = colors) + 
  scale_color_manual("Immune history", values = colors) +
  guides(color = guide_legend(nrow = 3), fill = guide_legend(nrow = 2)) +  theme_bw() +
  theme(axis.text = element_text(size = 11, color = "black"),
        axis.title = element_text(size = 12, color = "black"),
        axis.line = element_blank(),
        axis.ticks = element_line(color = "black"),
        plot.title = element_text(colour = "black", size = 13.5, face = "bold"),
        plot.title.position = "plot",
        plot.subtitle = element_text(colour = "black", size = 12.5),
        plot.margin = unit(c(0.1, 0.1, 0.1, 0.1), "cm"),
        legend.position = "bottom",
        legend.margin=margin(1,1.5,0.5,0.5,unit = "line"),
        strip.text = element_text(colour = "black", size = 10.5, hjust = 0),
        strip.background = element_rect(colour="white", fill="white"),
        panel.border = element_rect(colour = "black", fill=NA),
        panel.spacing = unit(0.5, "cm"), aspect.ratio=0.2)
S16

ggsave("../Supplement/S16_history_dist.pdf", width = 10, height = 4)

rm(datHistBar, dataHistories)

```


## S26 - ODE histories 899

```{r}

datHistBar_2 <-dataHistories899 %>% 
  #filter(time >= 21*30) %>% filter(time == min(time)) %>% ## december 2021
    mutate(history_counts = round(history_counts, 1)) %>%
  mutate(history_types= recode(history_types,
                               WT_vaccine = "WT + vaccine",
                               Delta_vaccine = "Delta + vaccine",
                               Omicron_vaccine = "Omicron + vaccine",
                               two = "Two events, other",
                               three = "Three events, other",
                               four = "Four or more immune events"
                               
  )) %>%
  mutate(history_types = fct_relevel(
    history_types,
    c("Naive", "Vaccine","Vaccine + booster","WT", "WT + vaccine", "WT + vaccine + booster",
      "Delta", "Delta + vaccine", "Delta + vaccine + booster",
      "Omicron", "Omicron + vaccine", "Omicron + vaccine + booster",
      "Omicron*", "Omicron* + vaccine", "Omicron* + vaccine + booster",
      "Two events, other", "Three events, other", "Four or more immune events"
    )
  ))

```
```{r}

colors <- c("#4B859F", "#0D3660","#6E8740", "#005B40", "#EE8768", 
            "#BD451D", "#E18A8D", "#7C2529",
            "#DFB81F", "#BC8400", "#6e500c")

S26 <- datHistBar_2 %>%
  mutate(country = case_when(
    country == "Ecuador" ~ "Ecuador-like",
    country == "India" ~ "India-like",
    country == "Malaysia" ~ "Malaysia-like"
  )) %>%
  pivot_wider(names_from = name, values_from = history_counts) %>%
  filter(history_types != "Vaccine_boost", 
         history_types != "WT_vaccine_boost",
         history_types != "Delta_vaccine_boost",
         history_types != "Omicron_vaccine_boost") %>%
  #pivot_wider(names_from = name, values_from = history_counts) %>%
  ggplot(aes(x = country, fill = history_types, color= history_types)) +
  geom_bar(aes(y=Mean), stat="identity", position=position_dodge(0.7),  
           alpha=0.5, size = 0.6, width = 0.6) + theme_classic() +
  geom_errorbar(aes(ymin  = Lower, ymax  = Upper),
           stat="identity", position=position_dodge(0.7),  
           size = 0.6, width = 0.3, show.legend=FALSE) + 
  scale_y_continuous("History prevalence (%)", limits = c(0, 42), expand = c(0,0)) +
  scale_x_discrete("Country", expand = c(0,0)) + 
  #facet_wrap(~country, scales = "free") + 
  scale_fill_manual("Immune history", values = colors) + 
  scale_color_manual("Immune history", values = colors) +
  guides(color = guide_legend(nrow = 3), fill = guide_legend(nrow = 2)) +  theme_bw() +
  theme(axis.text = element_text(size = 11, color = "black"),
        axis.title = element_text(size = 12, color = "black"),
        axis.line = element_blank(),
        axis.ticks = element_line(color = "black"),
        plot.title = element_text(colour = "black", size = 13.5, face = "bold"),
        plot.title.position = "plot",
        plot.subtitle = element_text(colour = "black", size = 12.5),
        plot.margin = unit(c(0.1, 0.1, 0.1, 0.1), "cm"),
        legend.position = "bottom",
        legend.margin=margin(1,1.5,0.5,0.5,unit = "line"),
        strip.text = element_text(colour = "black", size = 10.5, hjust = 0),
        strip.background = element_rect(colour="white", fill="white"),
        panel.border = element_rect(colour = "black", fill=NA),
        panel.spacing = unit(0.5, "cm"), aspect.ratio=0.2)
S26

ggsave("../Supplement/S28_history_dist_day899.pdf", width = 10, height = 4)

#rm(datHistBar_2, data_key_times)



```

## S18 ABM deaths 
```{r}

colors <- c("#0D3660","#BC8400","#7C2529", "#005B40")


dat_raw_deaths <-   dataAll %>% 
  mutate(country = case_when(
    country == "Ecuador" ~ "Ecuador-like",
    country == "India" ~ "India-like",
    country == "Malaysia" ~ "Malaysia-like"
  )) %>%
  filter(vaccine_star == "no") %>% 
  filter(time >= start_sims + 900) %>% 
  group_by(SAR, booster, country, replicate, scenario) %>% 
  mutate(deaths10K = 10000*deaths_over_time/start_pop) %>%
  #mutate(deaths_high = max(deaths), deaths_low = min(deaths))
  summarise(
    death_compare_10K = max(deaths10K)-min(deaths10K)
  ) %>%
  ungroup()

plot_raw_deaths_data <- dat_raw_deaths %>% 
  mutate(booster = case_when(
    scenario == "penalty" ~ "Bivalent",
    scenario == "Ompenalty" ~ "Monovalent (Omicron)",
    scenario == "WTpenalty" ~ "Monovalent (WT)",
    scenario == "no booster" ~ "No booster"
  )) %>% 
  mutate(Booster = fct_relevel(booster, "Monovalent")) %>% 
  mutate(SAR = recode(SAR,`0.427` = "100%",
    `0.4697` = "110%", `0.5551` = "130%")) %>%
  mutate(SAR = fct_relevel(SAR, c("100%", "110%", "130%"))) %>% 
  filter(SAR != "100%") %>%
  group_by(SAR,country,Booster,) %>%
  summarise(x  = smean.cl.normal(death_compare_10K), 
            name = c("Mean","Lower","Upper")) %>% ungroup() %>%
  pivot_wider(names_from = name, values_from = x) %>%
  mutate(Booster = fct_relevel(Booster, 
       c("No booster", "Monovalent (WT)","Monovalent (Omicron)", "Bivalent")))

plot_raw_deaths_ABM <- plot_raw_deaths_data %>% 
  ggplot(aes(x = SAR, fill = Booster, color = Booster,
                     group = interaction(Booster, SAR))) + 
  geom_bar(aes(y=Mean), stat="identity", position=position_dodge(0.7),  
           alpha=0.5, size = 0.6, width = 0.6) + theme_classic() +
  geom_errorbar(aes(ymin  = Lower, ymax  = Upper),
           stat="identity", position=position_dodge(0.7),  
           size = 0.6, width = 0.3, show.legend=FALSE) + 
  scale_fill_manual("Booster", values = colors) +
  scale_color_manual("Booster", values = colors) +
  facet_wrap(~country, scales = "free", nrow = 1) +
  scale_y_continuous("Deaths per 10,000", limits = c(0,9), 
                     expand = expansion(mult = c(0,0)), breaks = c(0,3,6,9), labels = c(0,3,6,9)) +
  scale_x_discrete("Infectiousness relative to Omicron") +
  ggtitle("Deaths per 10,000 - History specific model") + #, subtitle = "Variant-specific model") + 
  theme(axis.text = element_text(size = 11, color = "black"),
        axis.title.x = element_text(size = 12, color = "black",vjust = -1),
        axis.title.y = element_text(size = 12, color = "black",vjust = +3),
        axis.line = element_line(color = "black"),
        axis.ticks = element_line(color = "black"),
        plot.title = element_text(colour = "black", size = 13.5, face = "bold"),
        plot.subtitle = element_text(colour = "black", size = 12.5),
        plot.title.position = "plot",
        plot.margin = unit(c(t=0.2, r=1, b=0.5, l=1.5), "cm"),
        #legend.position = "none",
        # legend.margin=margin(t=0.5,r=0.5,b=0.5,l=0.5,unit = "line"),
        # legend.key.height= unit(0.4, 'cm'),
        # legend.key.width= unit(0.4, 'cm'),
        # legend.title = element_text(size = 11, color = "black"),
        # legend.text = element_text(size = 10, color = "black"),
        strip.text = element_text(colour = "black", size = 11, hjust = 0),
        strip.background = element_rect(colour="white", fill="white"),
        panel.spacing = unit(0.5, "cm")) #, aspect.ratio=0.7)
plot_raw_deaths_ABM
  


```

```{r}
ggsave("../Supplement/S18_ABMdeaths10k.pdf", plot_raw_deaths_ABM, height = 6, width = 13)
```


## ABM figs
### S1: slow vaccine rollout

#### Booster protection values

Taking the booster values and chunking into pre-booster and post-booster

```{r}

## grab prebooster values
dat_barplot_scenarios1_supp1 <- serotypes %>%
  select(history,Omicron_star) %>% 
  filter(history %in% c("Vaccine", "WT_vaccine", "Omicron_vaccine","Omicron_star_vaccine",  "Delta_vaccine")) %>% 
  rename(immunity = Omicron_star) %>% 
  select(history, immunity) %>% 
  mutate(history = recode(history, 
                          Delta_vaccine = "Delta + vaccine",
                          Omicron_vaccine = "Omicron + vaccine",
                          WT_vaccine = "WT + vaccine",
                          Vaccine = "Vaccine only", 
                          Omicron_star_vaccine = "Omicron* + vaccine")) %>% 
  rename(prebooster = immunity)

## grab postbooster values
dat_barplot_scenarios2_supp1 <- serotypes %>%
  select(history,Bivalent_penalty, Monovalent_WTpenalty, Monovalent_Ompenalty,
         Bivalent_efficacy, Monovalent_WTefficacy,
         Monovalent_Omefficacy,
         Bivalent_endpoint, Monovalent_WTendpoint,
         Monovalent_Omendpoint) %>% 
  filter(history %in% c("Vaccine", "WT_vaccine", "Omicron_vaccine", "Delta_vaccine", "Omicron_star_vaccine")) %>% 
  pivot_longer(-history, values_to = "immunity") %>% 
  separate(name, into = c("booster", "scenario"), sep = "_") %>% 
  mutate(history = recode(history, 
                          Delta_vaccine = "Delta + vaccine",
                          Omicron_vaccine = "Omicron + vaccine",
                          WT_vaccine = "WT + vaccine",
                          Vaccine = "Vaccine only", 
                          Omicron_star_vaccine = "Omicron* + vaccine")) %>% 
  rename(postbooster = immunity)

## combine pre and post booster
data_protection_supp1 <- left_join(dat_barplot_scenarios2_supp1, dat_barplot_scenarios1_supp1, by = "history") %>% 
  ## reverse everything; now we want protection instead of the scale-down parameter
  mutate(postbooster = 1-postbooster,
         prebooster = 1-prebooster,
         postbooster = postbooster-prebooster) %>% pivot_longer(postbooster:prebooster, names_to = "type", values_to = "immunity") %>%
  mutate(booster = if_else(substr(scenario, 1, 2) == "Om",
                           "Monovalent (Omicron)",
                           booster),
         booster = if_else(substr(scenario, 1, 2) == "WT",
                           "Monovalent (WT)",
                           booster))

```


#### Plot protection

```{r}
colors <- c("#BC8400","#7C2529","#005B40")

plot_supp1_protection <- data_protection_supp1 %>% mutate(history = fct_relevel(history, 
        c("Omicron* + vaccine", "Omicron + vaccine","Delta + vaccine", 
          "WT + vaccine","Vaccine only"))) %>% 
  mutate(Scenario = recode(scenario, endpoint = "Same endpoint",
    efficacy = "Same efficacy", penalty = "History dependent",
    WTpenalty = "History dependent", Ompenalty = "History dependent",
    "no booster" = "No booster")) %>%
  mutate(scenario = fct_relevel(Scenario, 
        c("Same endpoint", "Same efficacy", "History dependent"))) %>%
  mutate(booster = fct_relevel(booster, 
         c("Monovalent (WT)", "Monovalent (Omicron)", "Bivalent"))) %>%
  mutate(type = recode(type, prebooster = "Pre-booster", 
                       postbooster = "Post-booster")) %>% 
  mutate(type = fct_relevel(type, c("Post-booster"))) %>% 
  filter(Scenario == "History dependent") %>% 
  ggplot(aes(alpha = type,y=immunity, x=history, group = type)) +
  geom_bar(aes(fill=booster), position="stack", stat="identity", color="black") + 
  scale_fill_manual("Booster", values = colors, guide = "none") +
  scale_y_continuous("Total protection", limits = c(0,1), expand= c(0,0),
                       breaks = c(0,0.3,0.6,0.9), 
                       labels = scales::percent_format(accuracy = 1)) +
  facet_wrap(~booster, ncol = 1, scales = "free") +
  scale_alpha_manual("Booster status", 
          values = c("Post-booster" = 0.4, "Pre-booster" = 1.6 )) + 
  scale_x_discrete("Immune history") + 
  theme_classic() + coord_flip() + 
  ggtitle("Booster scenarios - History specific model") + 
  theme(axis.text = element_text(size = 11, color = "black"), #  angle = 90
        axis.title.x = element_text(size = 12, color = "black",vjust = -1),
        axis.title.y = element_text(size = 12, color = "black",vjust = +3),
        axis.line = element_line(color = "black"),
        axis.ticks = element_line(color = "black"),
        plot.title = element_text(colour = "black", size = 13.5, face = "bold"),
        plot.subtitle = element_text(colour = "black", size = 12.5),
        plot.margin = unit(c(t=0.2, r=1.5, b=0.5, l=1.5), "cm"),
        legend.position = "top", plot.title.position = "plot",
        strip.text = element_text(colour = "black", size = 11, hjust = 0),
        strip.background = element_rect(colour="white", fill="white"),
        legend.key.height= unit(0.4, 'cm'),
        legend.key.width= unit(0.4, 'cm'),
        legend.title = element_text(size = 11, color = "black"),
        legend.text = element_text(size = 10, color = "black"),
        legend.margin=margin(t=0.8,r=0.5,b=0.2,l=-4,unit = "line"),
        panel.spacing = unit(0.5, "cm")) # , aspect.ratio=1) + 
plot_supp1_protection
```

#### Data infections
Infections plot - this code duplicates the no booster scenario so that it appears as a comparison across all panels

```{r}

data_infections_WT <- data_supp1_slow_rollout %>% 
  filter(vaccine_star == "no", boost_shape == "functional", speed=="slow") %>%
  filter(scenario %in% c("WTpenalty", "WTendpoint", "WTefficacy")) %>% 
  filter(booster == "Monovalent") %>% 
  mutate(booster = "Monovalent (WT)")

data_infections_Om <- data_supp1_slow_rollout %>% 
  filter(vaccine_star == "no", boost_shape == "functional", speed=="slow") %>%
  filter(scenario %in% c("Ompenalty", "Omendpoint", "Omefficacy")) %>% 
  filter(booster == "Monovalent") %>% 
  mutate(booster = "Monovalent (Omicron)")

data_infections_Biv <- data_supp1_slow_rollout %>% 
  filter(vaccine_star == "no", boost_shape == "functional", speed=="slow") %>%
  filter(booster == "Bivalent")

data_infections_NoBoost_penalty <- data_supp1_slow_rollout %>% 
  filter(vaccine_star == "no", boost_shape == "no booster") %>%
  mutate(scenario = "penalty")%>% 
  mutate(booster = "No booster")


data_infections2_supp1 <- rbind(data_infections_WT, data_infections_Om) %>%
  rbind(data_infections_Biv) %>%
  rbind(data_infections_NoBoost_penalty)

rm(data_infections_WT, data_infections_Om,
   data_infections_Biv,data_infections_NoBoost_penalty)

gc()
```
#### Plot infections
```{r}
colors <- c("#0D3660","#BC8400","#7C2529", "#005B40")

dat_supp1 <- data_infections2_supp1 %>% filter(time >= start_sims + 900) %>%
  #mutate(time = time/30, 
 mutate(SAR = recode(SAR, `0.427` = "100%",
    `0.4697` = "110%", `0.5551` = "130%")) %>%
  mutate(SAR = fct_relevel(SAR, c("100%", "110%", "130%"))) %>% 
  mutate(Scenario = recode(scenario,
    endpoint = "Same endpoint",efficacy = "Same efficacy",
    penalty = "History dependent",WTpenalty = "History dependent",
    Ompenalty = "History dependent", "no booster" = "No booster")) %>%
  mutate(scenario = fct_relevel(Scenario, 
       c("No booster", "Same endpoint","Same efficacy","History dependent"))) %>% 
  mutate(booster = fct_relevel(booster, 
       c("No booster","Monovalent (WT)","Monovalent (Omicron)", "Bivalent"))) %>% 
  filter(scenario == "History dependent", SAR != "100%") %>%
  mutate(inf10K = 10000*infections_over_time/start_pop) %>%
  group_by(time,country,booster,scenario,SAR) %>%
  summarise(x  = smean.cl.normal(inf10K), 
            name = c("Mean","Lower","Upper")) %>% ungroup() %>%
  pivot_wider(names_from = name, values_from = x)

rm(data_infections2_supp1)
gc()
  
plot_supp1 <- dat_supp1 %>%
  mutate(country = case_when(
    country == "Ecuador" ~ "Ecuador-like",
    country == "India" ~ "India-like",
    country == "Malaysia" ~ "Malaysia-like"
  )) %>%
  ggplot(aes(x = time, fill = booster, 
            color = booster, linetype = SAR, 
            group = interaction(country, scenario, booster, SAR))) +
  geom_ribbon(aes(ymin = Lower, ymax = Upper), alpha = 0.5) + 
  geom_line(aes(y=Mean), alpha = 0) + theme_classic() + 
  scale_fill_manual("Booster type", values = colors) +
  scale_color_manual("Booster type", values = colors) + 
  ylab("Infections per 10,000") +
  facet_wrap(~country, scales = "free") + 
  ggh4x::facetted_pos_scales(y = list(
  country == "Ecuador-like" ~ scale_y_continuous(limits = c(0, NA), breaks = c(0,20,40,60,80)),
  country == "India-like" ~ scale_y_continuous(limits = c(0, NA)),
  country == "Malaysia-setting" ~ scale_y_continuous(limits = c(0, NA), 
                                             breaks = c(0,30,60,90,120)))) + 
  #scale_y_continuous(, limits = c(0,NA)) + # expand = c(0,0) 
  #scale_x_continuous("Time (months)", expand = c(0,0.5), breaks = c(30,32,34,36)) +
  scale_x_date("Date", expand = c(0,0), date_breaks = "1 month", date_labels =  "%b %Y") + 
  ggtitle("Infections during Omicron* - History specific model", "Conservative booster rollout") + #, "Variant-specific model") +
  guides(linetype = guide_legend(override.aes = list(alpha = 1, fill=NA))) +
  scale_linetype_manual("Infectiousness", values = c("dashed")) +
  theme(axis.text = element_text(size = 11, color = "black"),
        #axis.title.x = element_text(size = 12, color = "black",vjust = -1),
        axis.text.x=element_text(angle=60, hjust=1),
        axis.title.y = element_text(size = 12, color = "black",vjust = +3),
        axis.line = element_line(color = "black"),
        axis.ticks = element_line(color = "black"),
        plot.title = element_text(colour = "black", size = 13.5, face = "bold"),
        plot.subtitle = element_text(colour = "black", size = 12.5),
        plot.title.position = "plot",
        plot.margin = unit(c(t=0.2, r=1, b=0.2, l=1.5), "cm"),
        legend.position = "top",
        strip.text = element_text(colour = "black", size = 11, hjust = 0),
        strip.background = element_rect(colour="white", fill="white"),
        legend.margin=margin(t=0.8,r=0.5,b=0.2,l=0,unit = "line"),
        legend.key.height= unit(0.4, 'cm'),
        legend.key.width= unit(0.4, 'cm'),
        legend.title = element_text(size = 11, color = "black"),
        legend.text = element_text(size = 10, color = "black"),
        panel.spacing = unit(0.5, "cm")) #, aspect.ratio=1,
        #panel.grid.major = element_line(color = "grey95"),
        #panel.grid.minor = element_line(color = "grey95")) 
plot_supp1
```
#### Data Deaths

Calculating the deaths averted

```{r}
df_compare_supp1 <-   data_supp1_slow_rollout %>% 
  filter(boost == "no", vaccine_star == "no") %>% 
  filter(time >= start_sims + 900) %>% 
  group_by(SAR, country, replicate) %>% 
  mutate(deaths10K = 10000*deaths_over_time/start_pop) %>%
  #mutate(deaths_high = max(deaths), deaths_low = min(deaths))
  summarise(
    death_compare_10K = max(deaths10K)-min(deaths10K)
  ) %>%
  ungroup()

df_avert_supp1 <-  data_supp1_slow_rollout %>% 
  filter(boost == "yes", vaccine_star == "no", boost_shape == "functional", speed=="slow") %>% 
  #filter(time >= 900/365) %>% 
  filter(time >= start_sims + 900) %>%
  group_by(SAR, scenario, booster, country, replicate) %>% ## matching each booster scenario to a no booster scenario
  mutate(deaths10K = 10000*deaths_over_time/start_pop) %>%
  summarise(
    deaths_10K = max(deaths10K, na.rm = T)-min(deaths10K, na.rm = T)
  ) %>%
  ungroup()

df_avert_rr_supp1 <- left_join(df_avert_supp1, df_compare_supp1, by = c("SAR", "country", "replicate")) %>%
  group_by(SAR, country, booster, scenario, replicate) %>%
  mutate(da10K = death_compare_10K-deaths_10K,
         da_perc = da10K/death_compare_10K) %>%
ungroup() %>%
  select(
    SAR, country, replicate, scenario = scenario, booster = booster, death_compare_10K, deaths_10K, da10K, da_perc)

  

# df_avert_rr <- left_join(df_avert, df_compare, by = c("SAR", "country", "replicate")) %>% 
#   group_by(SAR, country, booster, scenario, replicate) %>% 
#   mutate(rr = deaths/death_compare,
#          da = 1-rr) %>%
# ungroup() %>% 
#   select(
#     SAR, country, replicate, scenario = scenario, booster = booster, da)


df_avert_rr_splitWT <- df_avert_rr_supp1 %>% 
  filter(scenario %in% c("WTpenalty", "WTendpoint", "WTefficacy")) %>% 
  filter(booster == "Monovalent") %>% 
  mutate(booster = "Monovalent (WT)")
df_avert_rr_splitOm <- df_avert_rr_supp1 %>% 
  filter(scenario %in% c("Ompenalty", "Omendpoint", "Omefficacy")) %>% 
  filter(booster == "Monovalent") %>% 
  mutate(booster = "Monovalent (Omicron)")

df_avert_rr2_supp1 <- df_avert_rr_supp1 %>%
  filter(booster == "Bivalent" | booster == "no booster" | booster == "No booster") %>%
  rbind(df_avert_rr_splitWT) %>% 
  rbind(df_avert_rr_splitOm)

rm(df_avert_rr_splitOm, df_avert_rr_splitWT)

```

#### Plot deaths averted

```{r}
colors <- c("#BC8400","#7C2529","#005B40")

comparisons <- list( c("Bivalent", "Monovalent (WT)"), 
                        c("Bivalent", "Monovalent (Omicron)"), 
                        c("Monovalent (WT)", "Monovalent (Omicron)"))

dat_supp1_da <- df_avert_rr2_supp1 %>% 
  mutate(Booster = fct_relevel(booster, "Monovalent")) %>% 
  mutate(SAR = recode(SAR,`0.427` = "100%",
    `0.4697` = "110%", `0.5551` = "130%")) %>%
  mutate(SAR = fct_relevel(SAR, c("100%", "110%", "130%"))) %>% 
  mutate(Scenario = recode(scenario, endpoint = "Same endpoint",
    efficacy = "Same efficacy", penalty = "History dependent",
    WTpenalty = "History dependent", Ompenalty = "History dependent",
    "no booster" = "No booster")) %>%
  filter(Scenario == "History dependent" | Scenario == "No booster") %>%
  filter(SAR != "100%") %>% mutate(Scenario = fct_relevel(Scenario, 
        c("Same endpoint", "Same efficacy", "History dependent"))) %>%
  group_by(SAR,country,Scenario,Booster,) %>%
  summarise(x  = smean.cl.normal(da10K), 
            name = c("Mean","Lower","Upper")) %>% ungroup() %>%
  pivot_wider(names_from = name, values_from = x) %>%
  mutate(Booster = fct_relevel(Booster, 
       c("Monovalent (WT)","Monovalent (Omicron)", "Bivalent")))

plot_supp1_da <- dat_supp1_da %>%
  mutate(country = case_when(
    country == "Ecuador" ~ "Ecuador-like",
    country == "India" ~ "India-like",
    country == "Malaysia" ~ "Malaysia-like"
  )) %>%
  
  ggplot(aes(x = SAR, fill = Booster, color = Booster,
                     group = interaction(Booster, SAR, Scenario))) + 
  geom_bar(aes(y=Mean), stat="identity", position=position_dodge(0.7),  
           alpha=0.5, size = 0.6, width = 0.6) + theme_classic() +
  geom_errorbar(aes(ymin  = Lower, ymax  = Upper),
           stat="identity", position=position_dodge(0.7),  
           size = 0.6, width = 0.3, show.legend=FALSE) + 
      geom_text(aes(label = round(Mean, 2), y = Upper + 0.2), position=position_dodge(0.7), size = 3) + ## this line adds the labels
  scale_fill_manual("Booster", values = colors) +
  scale_color_manual("Booster", values = colors) +
  facet_wrap(~country, scales = "free", nrow = 1) +
  scale_y_continuous("Deaths averted per 10,000", limits = c(0,5), 
                     expand = expansion(mult = c(0,0))) +
  scale_x_discrete("Infectiousness relative to Omicron") +
  ggtitle("Deaths averted - History specific model", "Conservative booster rollout") + #, subtitle = "Variant-specific model") + 
  theme(axis.text = element_text(size = 11, color = "black"),
        axis.title.x = element_text(size = 12, color = "black",vjust = -1),
        axis.title.y = element_text(size = 12, color = "black",vjust = +3),
        axis.line = element_line(color = "black"),
        axis.ticks = element_line(color = "black"),
        plot.title = element_text(colour = "black", size = 13.5, face = "bold"),
        plot.subtitle = element_text(colour = "black", size = 12.5),
        plot.title.position = "plot",
        plot.margin = unit(c(t=0.2, r=1, b=0.5, l=1.5), "cm"),
        legend.position = "none",
        # legend.margin=margin(t=0.5,r=0.5,b=0.5,l=0.5,unit = "line"),
        # legend.key.height= unit(0.4, 'cm'),
        # legend.key.width= unit(0.4, 'cm'),
        # legend.title = element_text(size = 11, color = "black"),
        # legend.text = element_text(size = 10, color = "black"),
        strip.text = element_text(colour = "black", size = 11, hjust = 0),
        strip.background = element_rect(colour="white", fill="white"),
        panel.spacing = unit(0.5, "cm")) #, aspect.ratio=0.7)
plot_supp1_da
```
#### Save S1
```{r}
plot2BC_supp1 <- plot_grid(plot_supp1,plot_supp1_da, nrow = 2, labels = c("B", "C"),
                     rel_heights = c(1.1, 1))

plot2_supp1 <- plot_grid(plot_supp1_protection, plot2BC_supp1, nrow = 1, labels = c("A", ""), 
                   rel_widths = c(0.5, 1))
ggsave("../Supplement/S1_slow_rollout.pdf", plot2_supp1, height = 7.5, width = 15)
```


#### Table of relative benefit
```{r}
dat_supp1_rel_benefit <- df_avert_rr2_supp1 %>% 
  mutate(Booster = fct_relevel(booster, "Monovalent")) %>% 
  mutate(SAR = recode(SAR,`0.427` = "100%",
    `0.4697` = "110%", `0.5551` = "130%")) %>%
  mutate(SAR = fct_relevel(SAR, c("100%", "110%", "130%"))) %>% 
  mutate(Scenario = recode(scenario, endpoint = "Same endpoint",
    efficacy = "Same efficacy", penalty = "History dependent",
    WTpenalty = "History dependent", Ompenalty = "History dependent",
    "no booster" = "No booster")) %>%
  filter(Scenario == "History dependent" | Scenario == "No booster") %>%
  filter(SAR != "100%") %>% mutate(Scenario = fct_relevel(Scenario, 
        c("Same endpoint", "Same efficacy", "History dependent"))) %>%
  group_by(SAR,country,Scenario,Booster,) %>%
  summarise(x  = smean.cl.normal(da10K), 
            name = c("Mean","Lower","Upper")) %>% ungroup() %>%
  pivot_wider(names_from = name, values_from = x) %>%
  mutate(Booster = fct_relevel(Booster, 
       c("Monovalent (WT)","Monovalent (Omicron)", "Bivalent"))) %>%
  select(SAR, country, Scenario, Booster, Mean) %>% 
  #filter(Booster == "Monovalent (WT)" | Booster == "Bivalent") %>%
  pivot_wider(names_from = "Booster", values_from = "Mean") %>% 
  mutate(`Bivalent` = round(round(`Bivalent`,2)/round(`Monovalent (WT)`,2),2)) %>% 
  mutate(`Monovalent (Omicron)` = round(round(`Monovalent (Omicron)`,2)/round(`Monovalent (WT)`,2),2)) %>% 
  select(SAR, country, Scenario, `Bivalent`, `Monovalent (Omicron)`) %>% 
  pivot_longer(4:5, names_to = "Booster", values_to = "Relative Benefit")

write_csv(dat_supp1_rel_benefit,"../Supplement Tables/Table_slow_rollout_rel_benefit.csv")
```




### S2: vaccinate through Omicron*

#### Booster protection values

Taking the booster values and chunking into pre-booster and post-booster

```{r}

## grab prebooster values
dat_barplot_scenarios1_supp2 <- serotypes %>%
  select(history,Omicron_star) %>% 
  filter(history %in% c("Vaccine", "WT_vaccine", "Omicron_vaccine","Omicron_star_vaccine",  "Delta_vaccine")) %>% 
  rename(immunity = Omicron_star) %>% 
  select(history, immunity) %>% 
  mutate(history = recode(history, 
                          Delta_vaccine = "Delta + vaccine",
                          Omicron_vaccine = "Omicron + vaccine",
                          WT_vaccine = "WT + vaccine",
                          Vaccine = "Vaccine only", 
                          Omicron_star_vaccine = "Omicron* + vaccine")) %>% 
  rename(prebooster = immunity)

## grab postbooster values
dat_barplot_scenarios2_supp2 <- serotypes %>%
  select(history,Bivalent_penalty, Monovalent_WTpenalty, Monovalent_Ompenalty,
         Bivalent_efficacy, Monovalent_WTefficacy,
         Monovalent_Omefficacy,
         Bivalent_endpoint, Monovalent_WTendpoint,
         Monovalent_Omendpoint) %>% 
  filter(history %in% c("Vaccine", "WT_vaccine", "Omicron_vaccine", "Delta_vaccine", "Omicron_star_vaccine")) %>% 
  pivot_longer(-history, values_to = "immunity") %>% 
  separate(name, into = c("booster", "scenario"), sep = "_") %>% 
  mutate(history = recode(history, 
                          Delta_vaccine = "Delta + vaccine",
                          Omicron_vaccine = "Omicron + vaccine",
                          WT_vaccine = "WT + vaccine",
                          Vaccine = "Vaccine only", 
                          Omicron_star_vaccine = "Omicron* + vaccine")) %>% 
  rename(postbooster = immunity)

## combine pre and post booster
data_protection_supp2 <- left_join(dat_barplot_scenarios2_supp2, dat_barplot_scenarios1_supp2, by = "history") %>% 
  ## reverse everything; now we want protection instead of the scale-down parameter
  mutate(postbooster = 1-postbooster,
         prebooster = 1-prebooster,
         postbooster = postbooster-prebooster) %>% pivot_longer(postbooster:prebooster, names_to = "type", values_to = "immunity") %>%
  mutate(booster = if_else(substr(scenario, 1, 2) == "Om",
                           "Monovalent (Omicron)",
                           booster),
         booster = if_else(substr(scenario, 1, 2) == "WT",
                           "Monovalent (WT)",
                           booster))

```


#### Plot protection

```{r}
colors <- c("#BC8400","#7C2529","#005B40")

plot_supp2_protection <- data_protection_supp2 %>% mutate(history = fct_relevel(history, 
        c("Omicron* + vaccine", "Omicron + vaccine","Delta + vaccine", 
          "WT + vaccine","Vaccine only"))) %>% 
  mutate(Scenario = recode(scenario, endpoint = "Same endpoint",
    efficacy = "Same efficacy", penalty = "History dependent",
    WTpenalty = "History dependent", Ompenalty = "History dependent",
    "no booster" = "No booster")) %>%
  mutate(scenario = fct_relevel(Scenario, 
        c("Same endpoint", "Same efficacy", "History dependent"))) %>%
  mutate(booster = fct_relevel(booster, 
         c("Monovalent (WT)", "Monovalent (Omicron)", "Bivalent"))) %>%
  mutate(type = recode(type, prebooster = "Pre-booster", 
                       postbooster = "Post-booster")) %>% 
  mutate(type = fct_relevel(type, c("Post-booster"))) %>% 
  filter(Scenario == "History dependent") %>% 
  ggplot(aes(alpha = type,y=immunity, x=history, group = type)) +
  geom_bar(aes(fill=booster), position="stack", stat="identity", color="black") + 
  scale_fill_manual("Booster", values = colors, guide = "none") +
  scale_y_continuous("Total protection", limits = c(0,1), expand= c(0,0),
                       breaks = c(0,0.3,0.6,0.9), 
                       labels = scales::percent_format(accuracy = 1)) +
  facet_wrap(~booster, ncol = 1, scales = "free") +
  scale_alpha_manual("Booster status", 
          values = c("Post-booster" = 0.4, "Pre-booster" = 1.6 )) + 
  scale_x_discrete("Immune history") + 
  theme_classic() + coord_flip() + 
  ggtitle("Booster scenarios - History specific model") + 
  theme(axis.text = element_text(size = 11, color = "black"), #  angle = 90
        axis.title.x = element_text(size = 12, color = "black",vjust = -1),
        axis.title.y = element_text(size = 12, color = "black",vjust = +3),
        axis.line = element_line(color = "black"),
        axis.ticks = element_line(color = "black"),
        plot.title = element_text(colour = "black", size = 13.5, face = "bold"),
        plot.subtitle = element_text(colour = "black", size = 12.5),
        plot.margin = unit(c(t=0.2, r=1.5, b=0.5, l=1.5), "cm"),
        legend.position = "top", plot.title.position = "plot",
        strip.text = element_text(colour = "black", size = 11, hjust = 0),
        strip.background = element_rect(colour="white", fill="white"),
        legend.key.height= unit(0.4, 'cm'),
        legend.key.width= unit(0.4, 'cm'),
        legend.title = element_text(size = 11, color = "black"),
        legend.text = element_text(size = 10, color = "black"),
        legend.margin=margin(t=0.8,r=0.5,b=0.2,l=-4,unit = "line"),
        panel.spacing = unit(0.5, "cm")) # , aspect.ratio=1) + 
plot_supp2_protection
```

#### Data infections
Infections plot - this code duplicates the no booster scenario so that it appears as a comparison across all panels

```{r}

data_infections_WT <- data_supp2_vaccine_star %>% 
  filter(vaccine_star == "yes", boost_shape == "functional", speed=="fast") %>%
  filter(scenario %in% c("WTpenalty", "WTendpoint", "WTefficacy")) %>% 
  filter(booster == "Monovalent") %>% 
  mutate(booster = "Monovalent (WT)")

data_infections_Om <- data_supp2_vaccine_star %>% 
  filter(vaccine_star == "yes", boost_shape == "functional", speed=="fast") %>%
  filter(scenario %in% c("Ompenalty", "Omendpoint", "Omefficacy")) %>% 
  filter(booster == "Monovalent") %>% 
  mutate(booster = "Monovalent (Omicron)")

data_infections_Biv <- data_supp2_vaccine_star %>% 
  filter(vaccine_star == "yes", boost_shape == "functional", speed=="fast") %>%
  filter(booster == "Bivalent")

data_infections_NoBoost_penalty <- data_supp2_vaccine_star %>% 
  filter(vaccine_star == "yes", boost_shape == "no booster") %>%
  mutate(scenario = "penalty")%>% 
  mutate(booster = "No booster")


data_infections2_supp2 <- rbind(data_infections_WT, data_infections_Om) %>%
  rbind(data_infections_Biv) %>%
  rbind(data_infections_NoBoost_penalty)

rm(data_infections_WT, data_infections_Om,
   data_infections_Biv,data_infections_NoBoost_penalty)

gc()

```
#### Plot infections
```{r}
colors <- c("#0D3660","#BC8400","#7C2529", "#005B40")

dat_supp2 <- data_infections2_supp2 %>% filter(time >= start_sims + 900) %>%
  #mutate(time = time/30, 
  mutate(SAR = recode(SAR, `0.427` = "100%",
    `0.4697` = "110%", `0.5551` = "130%")) %>%
  mutate(SAR = fct_relevel(SAR, c("100%", "110%", "130%"))) %>% 
  mutate(Scenario = recode(scenario,
    endpoint = "Same endpoint",efficacy = "Same efficacy",
    penalty = "History dependent",WTpenalty = "History dependent",
    Ompenalty = "History dependent", "no booster" = "No booster")) %>%
  mutate(scenario = fct_relevel(Scenario, 
       c("No booster", "Same endpoint","Same efficacy","History dependent"))) %>% 
  mutate(booster = fct_relevel(booster, 
       c("No booster","Monovalent (WT)","Monovalent (Omicron)", "Bivalent"))) %>% 
  filter(scenario == "History dependent", SAR != "100%") %>%
  mutate(inf10K = 10000*infections_over_time/start_pop) %>%
  group_by(time,country,booster,scenario,SAR) %>%
  summarise(x  = smean.cl.normal(inf10K), 
            name = c("Mean","Lower","Upper")) %>% ungroup() %>%
  pivot_wider(names_from = name, values_from = x)

rm(data_infections2_supp2)
gc()
  
plot_supp2 <- dat_supp2 %>%
  mutate(country = case_when(
    country == "Ecuador" ~ "Ecuador-like",
    country == "India" ~ "India-like",
    country == "Malaysia" ~ "Malaysia-like"
  )) %>%
  ggplot(aes(x = time, fill = booster, 
            color = booster, linetype = SAR, 
            group = interaction(country, scenario, booster, SAR))) +
  geom_ribbon(aes(ymin = Lower, ymax = Upper), alpha = 0.5) + 
  geom_line(aes(y=Mean), alpha = 0) + theme_classic() + 
  scale_fill_manual("Booster type", values = colors) +
  scale_color_manual("Booster type", values = colors) + 
  ylab("Infections per 10,000") +
  facet_wrap(~country, scales = "free") + 
  ggh4x::facetted_pos_scales(y = list(
  country == "Ecuador-like" ~ scale_y_continuous(limits = c(0, NA), breaks = c(0,20,40,60,80)),
  country == "India-like" ~ scale_y_continuous(limits = c(0, NA)),
  country == "Malaysia-like" ~ scale_y_continuous(limits = c(0, NA), 
                                             breaks = c(0,30,60,90,120)))) + 
  #scale_y_continuous(, limits = c(0,NA)) + # expand = c(0,0) 
  #scale_x_continuous("Time (months)", expand = c(0,0.5), breaks = c(30,32,34,36)) +
    scale_x_date("Date", expand = c(0,0), date_breaks = "1 month", date_labels =  "%b %Y") + 
  ggtitle("Infections during Omicron* - History specific model", "Vaccinate through Omicron*") + #, "Variant-specific model") +
  guides(linetype = guide_legend(override.aes = list(alpha = 1, fill=NA))) +
  scale_linetype_manual("Infectiousness", values = c("dashed")) +
  theme(axis.text = element_text(size = 11, color = "black"),
        axis.text.x=element_text(angle=60, hjust=1),
        #axis.title.x = element_text(size = 12, color = "black",vjust = -1),
        axis.title.y = element_text(size = 12, color = "black",vjust = +3),
        axis.line = element_line(color = "black"),
        axis.ticks = element_line(color = "black"),
        plot.title = element_text(colour = "black", size = 13.5, face = "bold"),
        plot.subtitle = element_text(colour = "black", size = 12.5),
        plot.title.position = "plot",
        plot.margin = unit(c(t=0.2, r=1, b=0.2, l=1.5), "cm"),
        legend.position = "top",
        strip.text = element_text(colour = "black", size = 11, hjust = 0),
        strip.background = element_rect(colour="white", fill="white"),
        legend.margin=margin(t=0.8,r=0.5,b=0.2,l=0,unit = "line"),
        legend.key.height= unit(0.4, 'cm'),
        legend.key.width= unit(0.4, 'cm'),
        legend.title = element_text(size = 11, color = "black"),
        legend.text = element_text(size = 10, color = "black"),
        panel.spacing = unit(0.5, "cm")) #, aspect.ratio=1,
        #panel.grid.major = element_line(color = "grey95"),
        #panel.grid.minor = element_line(color = "grey95")) 
plot_supp2
```

#### Data Deaths

Calculating the deaths averted

```{r}
df_compare_supp2 <-   data_supp2_vaccine_star %>% 
  filter(boost == "no", vaccine_star == "yes") %>% 
  filter(time >= start_sims + 900) %>% 
  group_by(SAR, country, replicate) %>% 
  mutate(deaths10K = 10000*deaths_over_time/start_pop) %>%
  #mutate(deaths_high = max(deaths), deaths_low = min(deaths))
  summarise(
    death_compare_10K = max(deaths10K)-min(deaths10K)
  ) %>%
  ungroup()

df_avert_supp2 <-  data_supp2_vaccine_star %>% 
  filter(boost == "yes", vaccine_star == "yes", boost_shape == "functional", speed=="fast") %>% 
  #filter(time >= 900/365) %>% 
  filter(time >= start_sims + 900) %>%
  group_by(SAR, scenario, booster, country, replicate) %>% ## matching each booster scenario to a no booster scenario
  mutate(deaths10K = 10000*deaths_over_time/start_pop) %>%
  summarise(
    deaths_10K = max(deaths10K, na.rm = T)-min(deaths10K, na.rm = T)
  ) %>%
  ungroup()

df_avert_rr_supp2 <- left_join(df_avert_supp2, df_compare_supp2, by = c("SAR", "country", "replicate")) %>%
  group_by(SAR, country, booster, scenario, replicate) %>%
  mutate(da10K = death_compare_10K-deaths_10K,
         da_perc = da10K/death_compare_10K) %>%
ungroup() %>%
  select(
    SAR, country, replicate, scenario = scenario, booster = booster, death_compare_10K, deaths_10K, da10K, da_perc)

  

# df_avert_rr <- left_join(df_avert, df_compare, by = c("SAR", "country", "replicate")) %>% 
#   group_by(SAR, country, booster, scenario, replicate) %>% 
#   mutate(rr = deaths/death_compare,
#          da = 1-rr) %>%
# ungroup() %>% 
#   select(
#     SAR, country, replicate, scenario = scenario, booster = booster, da)


df_avert_rr_splitWT <- df_avert_rr_supp2 %>% 
  filter(scenario %in% c("WTpenalty", "WTendpoint", "WTefficacy")) %>% 
  filter(booster == "Monovalent") %>% 
  mutate(booster = "Monovalent (WT)")
df_avert_rr_splitOm <- df_avert_rr_supp2 %>% 
  filter(scenario %in% c("Ompenalty", "Omendpoint", "Omefficacy")) %>% 
  filter(booster == "Monovalent") %>% 
  mutate(booster = "Monovalent (Omicron)")

df_avert_rr2_supp2 <- df_avert_rr_supp2 %>%
  filter(booster == "Bivalent" | booster == "no booster" | booster == "No booster") %>%
  rbind(df_avert_rr_splitWT) %>% 
  rbind(df_avert_rr_splitOm)

rm(df_avert_rr_splitOm, df_avert_rr_splitWT)

```

#### Plot deaths averted

```{r}
colors <- c("#BC8400","#7C2529","#005B40")

comparisons <- list( c("Bivalent", "Monovalent (WT)"), 
                        c("Bivalent", "Monovalent (Omicron)"), 
                        c("Monovalent (WT)", "Monovalent (Omicron)"))

dat_supp2_da <- df_avert_rr2_supp2 %>% 
  mutate(Booster = fct_relevel(booster, "Monovalent")) %>% 
  mutate(SAR = recode(SAR,`0.427` = "100%",
    `0.4697` = "110%", `0.5551` = "130%")) %>%
  mutate(SAR = fct_relevel(SAR, c("100%", "110%", "130%"))) %>% 
  mutate(Scenario = recode(scenario, endpoint = "Same endpoint",
    efficacy = "Same efficacy", penalty = "History dependent",
    WTpenalty = "History dependent", Ompenalty = "History dependent",
    "no booster" = "No booster")) %>%
  filter(Scenario == "History dependent" | Scenario == "No booster") %>%
  filter(SAR != "100%") %>% mutate(Scenario = fct_relevel(Scenario, 
        c("Same endpoint", "Same efficacy", "History dependent"))) %>%
  group_by(SAR,country,Scenario,Booster,) %>%
  summarise(x  = smean.cl.normal(da10K), 
            name = c("Mean","Lower","Upper")) %>% ungroup() %>%
  pivot_wider(names_from = name, values_from = x) %>%
  mutate(Booster = fct_relevel(Booster, 
       c("Monovalent (WT)","Monovalent (Omicron)", "Bivalent")))

plot_supp2_da <- dat_supp2_da %>%
  mutate(country = case_when(
    country == "Ecuador" ~ "Ecuador-like",
    country == "India" ~ "India-like",
    country == "Malaysia" ~ "Malaysia-like"
  )) %>%
  
  ggplot(aes(x = SAR, fill = Booster, color = Booster,
                     group = interaction(Booster, SAR, Scenario))) + 
  geom_bar(aes(y=Mean), stat="identity", position=position_dodge(0.7),  
           alpha=0.5, size = 0.6, width = 0.6) + theme_classic() +
  geom_errorbar(aes(ymin  = Lower, ymax  = Upper),
           stat="identity", position=position_dodge(0.7),  
           size = 0.6, width = 0.3, show.legend=FALSE) + 
      geom_text(aes(label = round(Mean, 2), y = Upper + 0.2), position=position_dodge(0.7), size = 3) + ## this line adds the labels
  scale_fill_manual("Booster", values = colors) +
  scale_color_manual("Booster", values = colors) +
  facet_wrap(~country, scales = "free", nrow = 1) +
  scale_y_continuous("Deaths averted per 10,000", limits = c(0,5), 
                     expand = expansion(mult = c(0,0))) +
  scale_x_discrete("Infectiousness relative to Omicron") +
  ggtitle("Deaths averted - History specific model", "Vaccinate through Omicron*") + #, subtitle = "Variant-specific model") + 
  theme(axis.text = element_text(size = 11, color = "black"),
        axis.title.x = element_text(size = 12, color = "black",vjust = -1),
        axis.title.y = element_text(size = 12, color = "black",vjust = +3),
        axis.line = element_line(color = "black"),
        axis.ticks = element_line(color = "black"),
        plot.title = element_text(colour = "black", size = 13.5, face = "bold"),
        plot.subtitle = element_text(colour = "black", size = 12.5),
        plot.title.position = "plot",
        plot.margin = unit(c(t=0.2, r=1, b=0.5, l=1.5), "cm"),
        legend.position = "none",
        # legend.margin=margin(t=0.5,r=0.5,b=0.5,l=0.5,unit = "line"),
        # legend.key.height= unit(0.4, 'cm'),
        # legend.key.width= unit(0.4, 'cm'),
        # legend.title = element_text(size = 11, color = "black"),
        # legend.text = element_text(size = 10, color = "black"),
        strip.text = element_text(colour = "black", size = 11, hjust = 0),
        strip.background = element_rect(colour="white", fill="white"),
        panel.spacing = unit(0.5, "cm")) #, aspect.ratio=0.7)
plot_supp2_da
```

#### Save S2
```{r}
plot2BC_supp2 <- plot_grid(plot_supp2,plot_supp2_da, nrow = 2, labels = c("B", "C"),
                     rel_heights = c(1.1, 1))

plot2_supp2 <- plot_grid(plot_supp2_protection, plot2BC_supp2, nrow = 1, labels = c("A", ""), 
                   rel_widths = c(0.5, 1))
ggsave("../Supplement/S2_vaccine_star.pdf", plot2_supp2, height = 7.5, width = 15)
```

#### Table of relative benefit

```{r}
dat_supp2_rel_benefit <- df_avert_rr2_supp2 %>% 
  mutate(Booster = fct_relevel(booster, "Monovalent")) %>% 
  mutate(SAR = recode(SAR,`0.427` = "100%",
    `0.4697` = "110%", `0.5551` = "130%")) %>%
  mutate(SAR = fct_relevel(SAR, c("100%", "110%", "130%"))) %>% 
  mutate(Scenario = recode(scenario, endpoint = "Same endpoint",
    efficacy = "Same efficacy", penalty = "History dependent",
    WTpenalty = "History dependent", Ompenalty = "History dependent",
    "no booster" = "No booster")) %>%
  filter(Scenario == "History dependent" | Scenario == "No booster") %>%
  filter(SAR != "100%") %>% mutate(Scenario = fct_relevel(Scenario, 
        c("Same endpoint", "Same efficacy", "History dependent"))) %>%
  group_by(SAR,country,Scenario,Booster,) %>%
  summarise(x  = smean.cl.normal(da10K), 
            name = c("Mean","Lower","Upper")) %>% ungroup() %>%
  pivot_wider(names_from = name, values_from = x) %>%
  mutate(Booster = fct_relevel(Booster, 
       c("Monovalent (WT)","Monovalent (Omicron)", "Bivalent"))) %>%
  select(SAR, country, Scenario, Booster, Mean) %>% 
  #filter(Booster == "Monovalent (WT)" | Booster == "Bivalent") %>%
  pivot_wider(names_from = "Booster", values_from = "Mean") %>% 
  mutate(`Bivalent` = round(round(`Bivalent`,2)/round(`Monovalent (WT)`,2),2)) %>% 
  mutate(`Monovalent (Omicron)` = round(round(`Monovalent (Omicron)`,2)/round(`Monovalent (WT)`,2),2)) %>% 
  select(SAR, country, Scenario, `Bivalent`, `Monovalent (Omicron)`) %>% 
  pivot_longer(4:5, names_to = "Booster", values_to = "Relative Benefit")

write_csv(dat_supp2_rel_benefit,"../Supplement Tables/Table_vaccinate_through_omicron_rel_benefit.csv")

```



### S3: same efficacy booster scenario

#### Booster protection values

Taking the booster values and chunking into pre-booster and post-booster

```{r}

## grab prebooster values
dat_barplot_scenarios1_supp3 <- serotypes %>%
  select(history,Omicron_star) %>% 
  filter(history %in% c("Vaccine", "WT_vaccine", "Omicron_vaccine","Omicron_star_vaccine",  "Delta_vaccine")) %>% 
  rename(immunity = Omicron_star) %>% 
  select(history, immunity) %>% 
  mutate(history = recode(history, 
                          Delta_vaccine = "Delta + vaccine",
                          Omicron_vaccine = "Omicron + vaccine",
                          WT_vaccine = "WT + vaccine",
                          Vaccine = "Vaccine only", 
                          Omicron_star_vaccine = "Omicron* + vaccine")) %>% 
  rename(prebooster = immunity)

## grab postbooster values
dat_barplot_scenarios2_supp3 <- serotypes %>%
  select(history,Bivalent_penalty, Monovalent_WTpenalty, Monovalent_Ompenalty,
         Bivalent_efficacy, Monovalent_WTefficacy,
         Monovalent_Omefficacy,
         Bivalent_endpoint, Monovalent_WTendpoint,
         Monovalent_Omendpoint) %>% 
  filter(history %in% c("Vaccine", "WT_vaccine", "Omicron_vaccine", "Delta_vaccine", "Omicron_star_vaccine")) %>% 
  pivot_longer(-history, values_to = "immunity") %>% 
  separate(name, into = c("booster", "scenario"), sep = "_") %>% 
  mutate(history = recode(history, 
                          Delta_vaccine = "Delta + vaccine",
                          Omicron_vaccine = "Omicron + vaccine",
                          WT_vaccine = "WT + vaccine",
                          Vaccine = "Vaccine only", 
                          Omicron_star_vaccine = "Omicron* + vaccine")) %>% 
  rename(postbooster = immunity)

## combine pre and post booster
data_protection_supp3 <- left_join(dat_barplot_scenarios2_supp3, dat_barplot_scenarios1_supp3, by = "history") %>% 
  ## reverse everything; now we want protection instead of the scale-down parameter
  mutate(postbooster = 1-postbooster,
         prebooster = 1-prebooster,
         postbooster = postbooster-prebooster) %>% pivot_longer(postbooster:prebooster, names_to = "type", values_to = "immunity") %>%
  mutate(booster = if_else(substr(scenario, 1, 2) == "Om",
                           "Monovalent (Omicron)",
                           booster),
         booster = if_else(substr(scenario, 1, 2) == "WT",
                           "Monovalent (WT)",
                           booster))

```


#### Plot protection

```{r}
colors <- c("#BC8400","#7C2529","#005B40")

plot_supp3_protection <- data_protection_supp3 %>% mutate(history = fct_relevel(history, 
        c("Omicron* + vaccine", "Omicron + vaccine","Delta + vaccine", 
          "WT + vaccine","Vaccine only"))) %>% 
  mutate(Scenario = recode(scenario, endpoint = "Same endpoint",
    efficacy = "Same efficacy", 
    WTefficacy = "Same efficacy", 
    Omefficacy = "Same efficacy", 
    penalty = "History dependent",
    WTpenalty = "History dependent", Ompenalty = "History dependent",
    "no booster" = "No booster")) %>%
  mutate(scenario = fct_relevel(Scenario, 
        c("Same endpoint", "Same efficacy", "History dependent"))) %>%
  mutate(booster = fct_relevel(booster, 
         c("Monovalent (WT)", "Monovalent (Omicron)", "Bivalent"))) %>%
  mutate(type = recode(type, prebooster = "Pre-booster", 
                       postbooster = "Post-booster")) %>% 
  mutate(type = fct_relevel(type, c("Post-booster"))) %>% 
  filter(Scenario == "Same efficacy") %>% 
  ggplot(aes(alpha = type,y=immunity, x=history, group = type)) +
  geom_bar(aes(fill=booster), position="stack", stat="identity", color="black") + 
  scale_fill_manual("Booster", values = colors, guide = "none") +
  scale_y_continuous("Total protection", limits = c(0,1), expand= c(0,0),
                       breaks = c(0,0.3,0.6,0.9), 
                       labels = scales::percent_format(accuracy = 1)) +
  facet_wrap(~booster, ncol = 1, scales = "free") +
  scale_alpha_manual("Booster status", 
          values = c("Post-booster" = 0.4, "Pre-booster" = 1.6 )) + 
  scale_x_discrete("Immune history") + 
  theme_classic() + coord_flip() + 
  ggtitle("Booster scenarios - History specific model", "Same efficacy") + 
  theme(axis.text = element_text(size = 11, color = "black"), #  angle = 90
        axis.title.x = element_text(size = 12, color = "black",vjust = -1),
        axis.title.y = element_text(size = 12, color = "black",vjust = +3),
        axis.line = element_line(color = "black"),
        axis.ticks = element_line(color = "black"),
        plot.title = element_text(colour = "black", size = 13.5, face = "bold"),
        plot.subtitle = element_text(colour = "black", size = 12.5),
        plot.margin = unit(c(t=0.2, r=1.5, b=0.5, l=1.5), "cm"),
        legend.position = "top", plot.title.position = "plot",
        strip.text = element_text(colour = "black", size = 11, hjust = 0),
        strip.background = element_rect(colour="white", fill="white"),
        legend.key.height= unit(0.4, 'cm'),
        legend.key.width= unit(0.4, 'cm'),
        legend.title = element_text(size = 11, color = "black"),
        legend.text = element_text(size = 10, color = "black"),
        legend.margin=margin(t=0.8,r=0.5,b=0.2,l=-4,unit = "line"),
        panel.spacing = unit(0.5, "cm")) # , aspect.ratio=1) + 
plot_supp3_protection
```



#### Data infections
Infections plot - this code duplicates the no booster scenario so that it appears as a comparison across all panels

```{r}

data_infections_WT <- data_supp3_same_efficacy %>% 
  filter(vaccine_star == "no", boost_shape == "functional", speed=="fast") %>%
  filter(scenario %in% c("WTefficacy")) %>% 
  mutate(scenario = "efficacy") %>%
  filter(booster == "Monovalent") %>% 
  mutate(booster = "Monovalent (WT)")

data_infections_Om <- data_supp3_same_efficacy %>% 
  filter(vaccine_star == "no", boost_shape == "functional", speed=="fast") %>%
  filter(scenario %in% c("Omefficacy")) %>% 
    mutate(scenario = "efficacy") %>%
  filter(booster == "Monovalent") %>% 
  mutate(booster = "Monovalent (Omicron)")

data_infections_Biv <- data_supp3_same_efficacy %>% 
  filter(vaccine_star == "no", boost_shape == "functional", speed=="fast") %>%
  filter(booster == "Bivalent")

data_infections_NoBoost_efficacy <- data_supp3_same_efficacy %>% 
  filter(vaccine_star == "no", boost_shape == "no booster") %>%
  mutate(scenario = "efficacy")%>% 
  mutate(booster = "No booster")


data_infections2_supp3 <- rbind(data_infections_WT, data_infections_Om) %>%
  rbind(data_infections_Biv) %>%
  rbind(data_infections_NoBoost_efficacy)

rm(data_infections_WT, data_infections_Om,
   data_infections_Biv,data_infections_NoBoost_efficacy)

gc()

```
#### Plot infections
```{r}
colors <- c("#0D3660","#BC8400","#7C2529", "#005B40")

dat_supp3 <- data_infections2_supp3 %>% filter(time >= start_sims + 900) %>%
  #mutate(time = time/30, 
  mutate(SAR = recode(SAR, `0.427` = "100%",
    `0.4697` = "110%", `0.5551` = "130%")) %>%
  mutate(SAR = fct_relevel(SAR, c("100%", "110%", "130%"))) %>% 
  mutate(Scenario = recode(scenario,
    efficacy = "Same efficacy",
     "no booster" = "No booster")) %>%
  mutate(scenario = fct_relevel(Scenario, 
       c("No booster","Same efficacy"))) %>% 
  mutate(booster = fct_relevel(booster, 
       c("No booster","Monovalent (WT)","Monovalent (Omicron)", "Bivalent"))) %>% 
  filter(SAR != "100%") %>%
  mutate(inf10K = 10000*infections_over_time/start_pop) %>%
  group_by(time,country,booster,scenario,SAR) %>%
  summarise(x  = smean.cl.normal(inf10K), 
            name = c("Mean","Lower","Upper")) %>% ungroup() %>%
  pivot_wider(names_from = name, values_from = x)

rm(data_infections2_supp3)
gc()

  
plot_supp3 <- dat_supp3 %>%
  mutate(country = case_when(
    country == "Ecuador" ~ "Ecuador-like",
    country == "India" ~ "India-like",
    country == "Malaysia" ~ "Malaysia-like"
  )) %>%
  ggplot(aes(x = time, fill = booster, 
            color = booster, linetype = SAR, 
            group = interaction(country, scenario, booster, SAR))) +
  geom_ribbon(aes(ymin = Lower, ymax = Upper), alpha = 0.5) + 
  geom_line(aes(y=Mean), alpha = 0) + theme_classic() + 
  scale_fill_manual("Booster type", values = colors) +
  scale_color_manual("Booster type", values = colors) + 
  ylab("Infections per 10,000") +
  facet_wrap(~country, scales = "free") + 
  ggh4x::facetted_pos_scales(y = list(
  country == "Ecuador-like" ~ scale_y_continuous(limits = c(0, NA), breaks = c(0,20,40,60,80)),
  country == "India-like" ~ scale_y_continuous(limits = c(0, NA)),
  country == "Malaysia-like" ~ scale_y_continuous(limits = c(0, NA), 
                                             breaks = c(0,30,60,90,120)))) + 
  #scale_y_continuous(, limits = c(0,NA)) + # expand = c(0,0) 
 # scale_x_continuous("Time (months)", expand = c(0,0.5), breaks = c(30,32,34,36)) +
      scale_x_date("Date", expand = c(0,0), date_breaks = "1 month", date_labels =  "%b %Y") + 
  ggtitle("Infections during Omicron* - History specific model", "Same efficacy") + #, "Variant-specific model") +
  guides(linetype = guide_legend(override.aes = list(alpha = 1, fill=NA))) +
  scale_linetype_manual("Infectiousness", values = c("dashed")) +
  theme(axis.text = element_text(size = 11, color = "black"),
        axis.text.x=element_text(angle=60, hjust=1),
        #axis.title.x = element_text(size = 12, color = "black",vjust = -1),
        axis.title.y = element_text(size = 12, color = "black",vjust = +3),
        axis.line = element_line(color = "black"),
        axis.ticks = element_line(color = "black"),
        plot.title = element_text(colour = "black", size = 13.5, face = "bold"),
        plot.subtitle = element_text(colour = "black", size = 12.5),
        plot.title.position = "plot",
        plot.margin = unit(c(t=0.2, r=1, b=0.2, l=1.5), "cm"),
        legend.position = "top",
        strip.text = element_text(colour = "black", size = 11, hjust = 0),
        strip.background = element_rect(colour="white", fill="white"),
        legend.margin=margin(t=0.8,r=0.5,b=0.2,l=0,unit = "line"),
        legend.key.height= unit(0.4, 'cm'),
        legend.key.width= unit(0.4, 'cm'),
        legend.title = element_text(size = 11, color = "black"),
        legend.text = element_text(size = 10, color = "black"),
        panel.spacing = unit(0.5, "cm")) #, aspect.ratio=1,
        #panel.grid.major = element_line(color = "grey95"),
        #panel.grid.minor = element_line(color = "grey95")) 
plot_supp3
```


#### Data Deaths

Calculating the deaths averted

```{r}
df_compare_supp3 <- data_supp3_same_efficacy %>% 
  filter(boost == "no", vaccine_star == "no") %>% 
  filter(time >= start_sims + 900) %>% 
  group_by(SAR, country, replicate) %>% 
  mutate(deaths10K = 10000*deaths_over_time/start_pop) %>%
  #mutate(deaths_high = max(deaths), deaths_low = min(deaths))
  summarise(
    death_compare_10K = max(deaths10K)-min(deaths10K)
  ) %>%
  ungroup()

df_avert_supp3 <-  data_supp3_same_efficacy %>% 
  filter(boost == "yes", vaccine_star == "no", boost_shape == "functional", speed=="fast") %>% 
  #filter(time >= 900/365) %>% 
  filter(time >= start_sims + 900) %>%
  group_by(SAR, scenario, booster, country, replicate) %>% ## matching each booster scenario to a no booster scenario
  mutate(deaths10K = 10000*deaths_over_time/start_pop) %>%
  summarise(
    deaths_10K = max(deaths10K, na.rm = T)-min(deaths10K, na.rm = T)
  ) %>%
  ungroup()

df_avert_rr_supp3 <- left_join(df_avert_supp3, df_compare_supp3, by = c("SAR", "country", "replicate")) %>%
  group_by(SAR, country, booster, scenario, replicate) %>%
  mutate(da10K = death_compare_10K-deaths_10K,
         da_perc = da10K/death_compare_10K) %>%
ungroup() %>%
  select(
    SAR, country, replicate, scenario = scenario, booster = booster, death_compare_10K, deaths_10K, da10K, da_perc)

  

# df_avert_rr <- left_join(df_avert, df_compare, by = c("SAR", "country", "replicate")) %>% 
#   group_by(SAR, country, booster, scenario, replicate) %>% 
#   mutate(rr = deaths/death_compare,
#          da = 1-rr) %>%
# ungroup() %>% 
#   select(
#     SAR, country, replicate, scenario = scenario, booster = booster, da)


df_avert_rr_splitWT <- df_avert_rr_supp3 %>% 
  filter(scenario %in% c("WTefficacy")) %>%
  mutate(scenario = "efficacy") %>%
  filter(booster == "Monovalent") %>% 
  mutate(booster = "Monovalent (WT)")
df_avert_rr_splitOm <- df_avert_rr_supp3 %>% 
  filter(scenario %in% c("Omefficacy")) %>% 
  mutate(scenario = "efficacy") %>%
  filter(booster == "Monovalent") %>% 
  mutate(booster = "Monovalent (Omicron)")

df_avert_rr2_supp3 <- df_avert_rr_supp3 %>%
  filter(booster == "Bivalent" | booster == "no booster" | booster == "No booster") %>%
  rbind(df_avert_rr_splitWT) %>% 
  rbind(df_avert_rr_splitOm)

rm(df_avert_rr_splitOm, df_avert_rr_splitWT)

```

#### Plot deaths averted

```{r}
colors <- c("#BC8400","#7C2529","#005B40")

comparisons <- list( c("Bivalent", "Monovalent (WT)"), 
                        c("Bivalent", "Monovalent (Omicron)"), 
                        c("Monovalent (WT)", "Monovalent (Omicron)"))

dat_supp3_da <- df_avert_rr2_supp3 %>% 
  mutate(Booster = fct_relevel(booster, "Monovalent")) %>% 
  mutate(SAR = recode(SAR,`0.427` = "100%",
    `0.4697` = "110%", `0.5551` = "130%")) %>%
  mutate(SAR = fct_relevel(SAR, c("100%", "110%", "130%"))) %>% 
  mutate(Scenario = recode(scenario, endpoint = "Same endpoint",
    efficacy = "Same efficacy", penalty = "History dependent",
    WTpenalty = "History dependent", Ompenalty = "History dependent",
    "no booster" = "No booster")) %>%
  filter(Scenario == "Same efficacy" | Scenario == "No booster") %>%
  filter(SAR != "100%") %>% mutate(Scenario = fct_relevel(Scenario, 
        c("Same endpoint", "Same efficacy", "History dependent"))) %>%
  group_by(SAR,country,Scenario,Booster,) %>%
  summarise(x  = smean.cl.normal(da10K), 
            name = c("Mean","Lower","Upper")) %>% ungroup() %>%
  pivot_wider(names_from = name, values_from = x) %>%
  mutate(Booster = fct_relevel(Booster, 
       c("Monovalent (WT)","Monovalent (Omicron)", "Bivalent")))

plot_supp3_da <- dat_supp3_da %>%
  mutate(country = case_when(
    country == "Ecuador" ~ "Ecuador-like",
    country == "India" ~ "India-like",
    country == "Malaysia" ~ "Malaysia-like"
  )) %>%
  ggplot(aes(x = SAR, fill = Booster, color = Booster,
                     group = interaction(Booster, SAR, Scenario))) + 
  geom_bar(aes(y=Mean), stat="identity", position=position_dodge(0.7),  
           alpha=0.5, size = 0.6, width = 0.6) + theme_classic() +
  geom_errorbar(aes(ymin  = Lower, ymax  = Upper),
           stat="identity", position=position_dodge(0.7),  
           size = 0.6, width = 0.3, show.legend=FALSE) + 
      geom_text(aes(label = round(Mean, 2), y = Upper + 0.2), position=position_dodge(0.7), size = 3) + ## this line adds the labels
  scale_fill_manual("Booster", values = colors) +
  scale_color_manual("Booster", values = colors) +
  facet_wrap(~country, scales = "free", nrow = 1) +
  scale_y_continuous("Deaths averted per 10,000", limits = c(0,5), 
                     expand = expansion(mult = c(0,0))) +
  scale_x_discrete("Infectiousness relative to Omicron") +
  ggtitle("Deaths averted - History specific model", "Same efficacy") + #, subtitle = "Variant-specific model") + 
  theme(axis.text = element_text(size = 11, color = "black"),
        axis.title.x = element_text(size = 12, color = "black",vjust = -1),
        axis.title.y = element_text(size = 12, color = "black",vjust = +3),
        axis.line = element_line(color = "black"),
        axis.ticks = element_line(color = "black"),
        plot.title = element_text(colour = "black", size = 13.5, face = "bold"),
        plot.subtitle = element_text(colour = "black", size = 12.5),
        plot.title.position = "plot",
        plot.margin = unit(c(t=0.2, r=1, b=0.5, l=1.5), "cm"),
        legend.position = "none",
        # legend.margin=margin(t=0.5,r=0.5,b=0.5,l=0.5,unit = "line"),
        # legend.key.height= unit(0.4, 'cm'),
        # legend.key.width= unit(0.4, 'cm'),
        # legend.title = element_text(size = 11, color = "black"),
        # legend.text = element_text(size = 10, color = "black"),
        strip.text = element_text(colour = "black", size = 11, hjust = 0),
        strip.background = element_rect(colour="white", fill="white"),
        panel.spacing = unit(0.5, "cm")) #, aspect.ratio=0.7)
plot_supp3_da
```

#### Save S3
```{r}
plot2BC_supp3 <- plot_grid(plot_supp3,plot_supp3_da, nrow = 2, labels = c("B", "C"),
                     rel_heights = c(1.1, 1))

plot2_supp3 <- plot_grid(plot_supp3_protection, plot2BC_supp3, nrow = 1, labels = c("A", ""), 
                   rel_widths = c(0.5, 1))
ggsave("../Supplement/S3_same_efficacy.pdf", plot2_supp3, height = 7.5, width = 15)
```


#### Table of relative benefit
```{r}
dat_supp3_rel_benefit <- df_avert_rr2_supp3 %>% 
  mutate(Booster = fct_relevel(booster, "Monovalent")) %>% 
  mutate(SAR = recode(SAR,`0.427` = "100%",
    `0.4697` = "110%", `0.5551` = "130%")) %>%
  mutate(SAR = fct_relevel(SAR, c("100%", "110%", "130%"))) %>% 
  mutate(Scenario = recode(scenario, endpoint = "Same endpoint",
    efficacy = "Same efficacy", penalty = "History dependent",
    WTpenalty = "History dependent", Ompenalty = "History dependent",
    "no booster" = "No booster")) %>%
  filter(Scenario == "Same efficacy" | Scenario == "No booster") %>%
  filter(SAR != "100%") %>% mutate(Scenario = fct_relevel(Scenario, 
        c("Same endpoint", "Same efficacy", "History dependent"))) %>%
  group_by(SAR,country,Scenario,Booster,) %>%
  summarise(x  = smean.cl.normal(da10K), 
            name = c("Mean","Lower","Upper")) %>% ungroup() %>%
  pivot_wider(names_from = name, values_from = x) %>%
  mutate(Booster = fct_relevel(Booster, 
       c("Monovalent (WT)","Monovalent (Omicron)", "Bivalent"))) %>%
  select(SAR, country, Scenario, Booster, Mean) %>% 
  #filter(Booster == "Monovalent (WT)" | Booster == "Bivalent") %>%
  pivot_wider(names_from = "Booster", values_from = "Mean") %>% 
  mutate(`Bivalent` = round(round(`Bivalent`,2)/round(`Monovalent (WT)`,2),2)) %>% 
  mutate(`Monovalent (Omicron)` = round(round(`Monovalent (Omicron)`,2)/round(`Monovalent (WT)`,2),2)) %>% 
  select(SAR, country, Scenario, `Bivalent`, `Monovalent (Omicron)`) %>% 
  pivot_longer(4:5, names_to = "Booster", values_to = "Relative Benefit")

write_csv(dat_supp3_rel_benefit,"../Supplement Tables/Table_same_efficacy_rel_benefit.csv")

```




### S4: same endpoint booster scenario


#### Booster protection values

Taking the booster values and chunking into pre-booster and post-booster

```{r}

## grab prebooster values
dat_barplot_scenarios1_supp4 <- serotypes %>%
  select(history,Omicron_star) %>% 
  filter(history %in% c("Vaccine", "WT_vaccine", "Omicron_vaccine","Omicron_star_vaccine",  "Delta_vaccine")) %>% 
  rename(immunity = Omicron_star) %>% 
  select(history, immunity) %>% 
  mutate(history = recode(history, 
                          Delta_vaccine = "Delta + vaccine",
                          Omicron_vaccine = "Omicron + vaccine",
                          WT_vaccine = "WT + vaccine",
                          Vaccine = "Vaccine only", 
                          Omicron_star_vaccine = "Omicron* + vaccine")) %>% 
  rename(prebooster = immunity)

## grab postbooster values
dat_barplot_scenarios2_supp4 <- serotypes %>%
  select(history,Bivalent_penalty, Monovalent_WTpenalty, Monovalent_Ompenalty,
         Bivalent_efficacy, Monovalent_WTefficacy,
         Monovalent_Omefficacy,
         Bivalent_endpoint, Monovalent_WTendpoint,
         Monovalent_Omendpoint) %>% 
  filter(history %in% c("Vaccine", "WT_vaccine", "Omicron_vaccine", "Delta_vaccine", "Omicron_star_vaccine")) %>% 
  pivot_longer(-history, values_to = "immunity") %>% 
  separate(name, into = c("booster", "scenario"), sep = "_") %>% 
  mutate(history = recode(history, 
                          Delta_vaccine = "Delta + vaccine",
                          Omicron_vaccine = "Omicron + vaccine",
                          WT_vaccine = "WT + vaccine",
                          Vaccine = "Vaccine only", 
                          Omicron_star_vaccine = "Omicron* + vaccine")) %>% 
  rename(postbooster = immunity)

## combine pre and post booster
data_protection_supp4 <- left_join(dat_barplot_scenarios2_supp4, dat_barplot_scenarios1_supp4, by = "history") %>% 
  ## reverse everything; now we want protection instead of the scale-down parameter
  mutate(postbooster = 1-postbooster,
         prebooster = 1-prebooster,
         postbooster = postbooster-prebooster) %>% pivot_longer(postbooster:prebooster, names_to = "type", values_to = "immunity") %>%
  mutate(booster = if_else(substr(scenario, 1, 2) == "Om",
                           "Monovalent (Omicron)",
                           booster),
         booster = if_else(substr(scenario, 1, 2) == "WT",
                           "Monovalent (WT)",
                           booster))

```


#### Plot protection

```{r}
colors <- c("#BC8400","#7C2529","#005B40")

plot_supp4_protection <- data_protection_supp4 %>% mutate(history = fct_relevel(history, 
        c("Omicron* + vaccine", "Omicron + vaccine","Delta + vaccine", 
          "WT + vaccine","Vaccine only"))) %>% 
  mutate(Scenario = recode(scenario, endpoint = "Same endpoint",
    WTendpoint = "Same endpoint", 
    Omendpoint = "Same endpoint", 
    "no booster" = "No booster")) %>%
  mutate(scenario = fct_relevel(Scenario, 
        c("Same endpoint", "Same efficacy", "History dependent"))) %>%
  mutate(booster = fct_relevel(booster, 
         c("Monovalent (WT)", "Monovalent (Omicron)", "Bivalent"))) %>%
  mutate(type = recode(type, prebooster = "Pre-booster", 
                       postbooster = "Post-booster")) %>% 
  mutate(type = fct_relevel(type, c("Post-booster"))) %>% 
  filter(Scenario == "Same endpoint") %>% 
  ggplot(aes(alpha = type,y=immunity, x=history, group = type)) +
  geom_bar(aes(fill=booster), position="stack", stat="identity", color="black") + 
  scale_fill_manual("Booster", values = colors, guide = "none") +
  scale_y_continuous("Total protection", limits = c(0,1), expand= c(0,0),
                       breaks = c(0,0.3,0.6,0.9), 
                       labels = scales::percent_format(accuracy = 1)) +
  facet_wrap(~booster, ncol = 1, scales = "free") +
  scale_alpha_manual("Booster status", 
          values = c("Post-booster" = 0.4, "Pre-booster" = 1.6 )) + 
  scale_x_discrete("Immune history") + 
  theme_classic() + coord_flip() + 
  ggtitle("Booster scenarios - History specific model", "Same endpoint") + 
  theme(axis.text = element_text(size = 11, color = "black"), #  angle = 90
        axis.title.x = element_text(size = 12, color = "black",vjust = -1),
        axis.title.y = element_text(size = 12, color = "black",vjust = +3),
        axis.line = element_line(color = "black"),
        axis.ticks = element_line(color = "black"),
        plot.title = element_text(colour = "black", size = 13.5, face = "bold"),
        plot.subtitle = element_text(colour = "black", size = 12.5),
        plot.margin = unit(c(t=0.2, r=1.5, b=0.5, l=1.5), "cm"),
        legend.position = "top", plot.title.position = "plot",
        strip.text = element_text(colour = "black", size = 11, hjust = 0),
        strip.background = element_rect(colour="white", fill="white"),
        legend.key.height= unit(0.4, 'cm'),
        legend.key.width= unit(0.4, 'cm'),
        legend.title = element_text(size = 11, color = "black"),
        legend.text = element_text(size = 10, color = "black"),
        legend.margin=margin(t=0.8,r=0.5,b=0.2,l=-4,unit = "line"),
        panel.spacing = unit(0.5, "cm")) # , aspect.ratio=1) + 
plot_supp4_protection
```


#### Data infections
Infections plot - this code duplicates the no booster scenario so that it appears as a comparison across all panels

```{r}

data_infections_WT <- data_supp4_same_endpoint %>% 
  filter(vaccine_star == "no", boost_shape == "functional", speed=="fast") %>%
  filter(scenario %in% c("WTendpoint")) %>% 
  mutate(scenario = "endpoint") %>%
  filter(booster == "Monovalent") %>% 
  mutate(booster = "Monovalent (WT)")

data_infections_Om <- data_supp4_same_endpoint %>% 
  filter(vaccine_star == "no", boost_shape == "functional", speed=="fast") %>%
  filter(scenario %in% c("Omendpoint")) %>% 
    mutate(scenario = "endpoint") %>%
  filter(booster == "Monovalent") %>% 
  mutate(booster = "Monovalent (Omicron)")

data_infections_Biv <- data_supp4_same_endpoint %>% 
  filter(vaccine_star == "no", boost_shape == "functional", speed=="fast") %>%
  filter(booster == "Bivalent")

data_infections_NoBoost_endpoint <- data_supp4_same_endpoint %>% 
  filter(vaccine_star == "no", boost_shape == "no booster") %>%
  mutate(scenario = "endpoint")%>% 
  mutate(booster = "No booster")


data_infections2_supp4 <- rbind(data_infections_WT, data_infections_Om) %>%
  rbind(data_infections_Biv) %>%
  rbind(data_infections_NoBoost_endpoint)

rm(data_infections_WT, data_infections_Om,
   data_infections_Biv,data_infections_NoBoost_endpoint)

gc()

```
#### Plot infections
```{r}
colors <- c("#0D3660","#BC8400","#7C2529", "#005B40")

dat_supp4 <- data_infections2_supp4 %>% filter(time >= start_sims + 900) %>%
  #mutate(time = time/30, 
  mutate(SAR = recode(SAR, `0.427` = "100%",
    `0.4697` = "110%", `0.5551` = "130%")) %>%
  mutate(SAR = fct_relevel(SAR, c("100%", "110%", "130%"))) %>% 
  mutate(Scenario = recode(scenario,
    endpoint = "Same endpoint",
     "no booster" = "No booster")) %>%
  mutate(scenario = fct_relevel(Scenario, 
       c("No booster","Same endpoint"))) %>% 
  mutate(booster = fct_relevel(booster, 
       c("No booster","Monovalent (WT)","Monovalent (Omicron)", "Bivalent"))) %>% 
  filter(SAR != "100%") %>%
  mutate(inf10K = 10000*infections_over_time/start_pop) %>%
  group_by(time,country,booster,scenario,SAR) %>%
  summarise(x  = smean.cl.normal(inf10K), 
            name = c("Mean","Lower","Upper")) %>% ungroup() %>%
  pivot_wider(names_from = name, values_from = x)

rm(data_infections2_supp4)
gc()

  
plot_supp4 <- dat_supp4 %>%
  mutate(country = case_when(
    country == "Ecuador" ~ "Ecuador-like",
    country == "India" ~ "India-like",
    country == "Malaysia" ~ "Malaysia-like"
  )) %>%
  
  ggplot(aes(x = time, fill = booster, 
            color = booster, linetype = SAR, 
            group = interaction(country, scenario, booster, SAR))) +
  geom_ribbon(aes(ymin = Lower, ymax = Upper), alpha = 0.5) + 
  geom_line(aes(y=Mean), alpha = 0) + theme_classic() + 
  scale_fill_manual("Booster type", values = colors) +
  scale_color_manual("Booster type", values = colors) + 
  ylab("Infections per 10,000") +
  facet_wrap(~country, scales = "free") + 
  ggh4x::facetted_pos_scales(y = list(
  country == "Ecuador-like" ~ scale_y_continuous(limits = c(0, NA), breaks = c(0,20,40,60,80)),
  country == "India-like" ~ scale_y_continuous(limits = c(0, NA)),
  country == "Malaysia-like" ~ scale_y_continuous(limits = c(0, NA), 
                                             breaks = c(0,30,60,90,120)))) + 
  #scale_y_continuous(, limits = c(0,NA)) + # expand = c(0,0) 
  #scale_x_continuous("Time (months)", expand = c(0,0.5), breaks = c(30,32,34,36)) +
  scale_x_date("Date", expand = c(0,0), date_breaks = "1 month", date_labels =  "%b %Y") + 
  ggtitle("Infections during Omicron* - History specific model", "Same endpoint") + #, "Variant-specific model") +
  guides(linetype = guide_legend(override.aes = list(alpha = 1, fill=NA))) +
  scale_linetype_manual("Infectiousness", values = c("dashed")) +
  theme(axis.text = element_text(size = 11, color = "black"),
        #axis.title.x = element_text(size = 12, color = "black",vjust = -1),
                axis.text.x=element_text(angle=60, hjust=1),
        axis.title.y = element_text(size = 12, color = "black",vjust = +3),
        axis.line = element_line(color = "black"),
        axis.ticks = element_line(color = "black"),
        plot.title = element_text(colour = "black", size = 13.5, face = "bold"),
        plot.subtitle = element_text(colour = "black", size = 12.5),
        plot.title.position = "plot",
        plot.margin = unit(c(t=0.2, r=1, b=0.2, l=1.5), "cm"),
        legend.position = "top",
        strip.text = element_text(colour = "black", size = 11, hjust = 0),
        strip.background = element_rect(colour="white", fill="white"),
        legend.margin=margin(t=0.8,r=0.5,b=0.2,l=0,unit = "line"),
        legend.key.height= unit(0.4, 'cm'),
        legend.key.width= unit(0.4, 'cm'),
        legend.title = element_text(size = 11, color = "black"),
        legend.text = element_text(size = 10, color = "black"),
        panel.spacing = unit(0.5, "cm")) #, aspect.ratio=1,
        #panel.grid.major = element_line(color = "grey95"),
        #panel.grid.minor = element_line(color = "grey95")) 
plot_supp4
```

#### Data Deaths

Calculating the deaths averted

```{r}
df_compare_supp4 <- data_supp4_same_endpoint %>% 
  filter(boost == "no", vaccine_star == "no") %>% 
  filter(time >= start_sims + 900) %>% 
  group_by(SAR, country, replicate) %>% 
  mutate(deaths10K = 10000*deaths_over_time/start_pop) %>%
  #mutate(deaths_high = max(deaths), deaths_low = min(deaths))
  summarise(
    death_compare_10K = max(deaths10K)-min(deaths10K)
  ) %>%
  ungroup()

df_avert_supp4 <-  data_supp4_same_endpoint %>% 
  filter(boost == "yes", vaccine_star == "no", boost_shape == "functional", speed=="fast") %>% 
  #filter(time >= 900/365) %>% 
  filter(time >= start_sims + 900) %>%
  group_by(SAR, scenario, booster, country, replicate) %>% ## matching each booster scenario to a no booster scenario
  mutate(deaths10K = 10000*deaths_over_time/start_pop) %>%
  summarise(
    deaths_10K = max(deaths10K, na.rm = T)-min(deaths10K, na.rm = T)
  ) %>%
  ungroup()

df_avert_rr_supp4 <- left_join(df_avert_supp4, df_compare_supp4, by = c("SAR", "country", "replicate")) %>%
  group_by(SAR, country, booster, scenario, replicate) %>%
  mutate(da10K = death_compare_10K-deaths_10K,
         da_perc = da10K/death_compare_10K) %>%
ungroup() %>%
  select(
    SAR, country, replicate, scenario = scenario, booster = booster, death_compare_10K, deaths_10K, da10K, da_perc)

  

# df_avert_rr <- left_join(df_avert, df_compare, by = c("SAR", "country", "replicate")) %>% 
#   group_by(SAR, country, booster, scenario, replicate) %>% 
#   mutate(rr = deaths/death_compare,
#          da = 1-rr) %>%
# ungroup() %>% 
#   select(
#     SAR, country, replicate, scenario = scenario, booster = booster, da)


df_avert_rr_splitWT <- df_avert_rr_supp4 %>% 
  filter(scenario %in% c("WTendpoint")) %>%
  mutate(scenario = "endpoint") %>%
  filter(booster == "Monovalent") %>% 
  mutate(booster = "Monovalent (WT)")
df_avert_rr_splitOm <- df_avert_rr_supp4 %>% 
  filter(scenario %in% c("Omendpoint")) %>% 
  mutate(scenario = "endpoint") %>%
  filter(booster == "Monovalent") %>% 
  mutate(booster = "Monovalent (Omicron)")

df_avert_rr2_supp4 <- df_avert_rr_supp4 %>%
  filter(booster == "Bivalent" | booster == "no booster" | booster == "No booster") %>%
  rbind(df_avert_rr_splitWT) %>% 
  rbind(df_avert_rr_splitOm)

rm(df_avert_rr_splitOm, df_avert_rr_splitWT)

```

#### Plot deaths averted

```{r}
colors <- c("#BC8400","#7C2529","#005B40")

comparisons <- list( c("Bivalent", "Monovalent (WT)"), 
                        c("Bivalent", "Monovalent (Omicron)"), 
                        c("Monovalent (WT)", "Monovalent (Omicron)"))

dat_supp4_da <- df_avert_rr2_supp4 %>% 
  mutate(Booster = fct_relevel(booster, "Monovalent")) %>% 
  mutate(SAR = recode(SAR,`0.427` = "100%",
    `0.4697` = "110%", `0.5551` = "130%")) %>%
  mutate(SAR = fct_relevel(SAR, c("100%", "110%", "130%"))) %>% 
  mutate(Scenario = recode(scenario, endpoint = "Same endpoint",
    efficacy = "Same efficacy", penalty = "History dependent",
    WTpenalty = "History dependent", Ompenalty = "History dependent",
    "no booster" = "No booster")) %>%
  filter(Scenario == "Same endpoint" | Scenario == "No booster") %>%
  filter(SAR != "100%") %>% mutate(Scenario = fct_relevel(Scenario, 
        c("Same endpoint", "Same efficacy", "History dependent"))) %>%
  group_by(SAR,country,Scenario,Booster,) %>%
  summarise(x  = smean.cl.normal(da10K), 
            name = c("Mean","Lower","Upper")) %>% ungroup() %>%
  pivot_wider(names_from = name, values_from = x) %>%
  mutate(Booster = fct_relevel(Booster, 
       c("Monovalent (WT)","Monovalent (Omicron)", "Bivalent")))

plot_supp4_da <- dat_supp4_da %>%
  mutate(country = case_when(
    country == "Ecuador" ~ "Ecuador-like",
    country == "India" ~ "India-like",
    country == "Malaysia" ~ "Malaysia-like"
  )) %>%
  ggplot(aes(x = SAR, fill = Booster, color = Booster,
                     group = interaction(Booster, SAR, Scenario))) + 
  geom_bar(aes(y=Mean), stat="identity", position=position_dodge(0.7),  
           alpha=0.5, size = 0.6, width = 0.6) + theme_classic() +
  geom_errorbar(aes(ymin  = Lower, ymax  = Upper),
           stat="identity", position=position_dodge(0.7),  
           size = 0.6, width = 0.3, show.legend=FALSE) + 
      geom_text(aes(label = round(Mean, 2), y = Upper + 0.2), position=position_dodge(0.7), size = 3) + ## this line adds the labels
  scale_fill_manual("Booster", values = colors) +
  scale_color_manual("Booster", values = colors) +
  facet_wrap(~country, scales = "free", nrow = 1) +
  scale_y_continuous("Deaths averted per 10,000", limits = c(0,5), 
                     expand = expansion(mult = c(0,0))) +
  scale_x_discrete("Infectiousness relative to Omicron") +
  ggtitle("Deaths averted - History specific model", "Same endpoint") + #, subtitle = "Variant-specific model") + 
  theme(axis.text = element_text(size = 11, color = "black"),
        axis.title.x = element_text(size = 12, color = "black",vjust = -1),
        axis.title.y = element_text(size = 12, color = "black",vjust = +3),
        axis.line = element_line(color = "black"),
        axis.ticks = element_line(color = "black"),
        plot.title = element_text(colour = "black", size = 13.5, face = "bold"),
        plot.subtitle = element_text(colour = "black", size = 12.5),
        plot.title.position = "plot",
        plot.margin = unit(c(t=0.2, r=1, b=0.5, l=1.5), "cm"),
        legend.position = "none",
        # legend.margin=margin(t=0.5,r=0.5,b=0.5,l=0.5,unit = "line"),
        # legend.key.height= unit(0.4, 'cm'),
        # legend.key.width= unit(0.4, 'cm'),
        # legend.title = element_text(size = 11, color = "black"),
        # legend.text = element_text(size = 10, color = "black"),
        strip.text = element_text(colour = "black", size = 11, hjust = 0),
        strip.background = element_rect(colour="white", fill="white"),
        panel.spacing = unit(0.5, "cm")) #, aspect.ratio=0.7)
plot_supp4_da
```


#### Save S4
```{r}
plot2BC_supp4 <- plot_grid(plot_supp4,plot_supp4_da, nrow = 2, labels = c("B", "C"),
                     rel_heights = c(1.1, 1))

plot2_supp4 <- plot_grid(plot_supp4_protection, plot2BC_supp4, nrow = 1, labels = c("A", ""), 
                   rel_widths = c(0.5, 1))
ggsave("../Supplement/S4_same_endpoint.pdf", plot2_supp4, height = 7.5, width = 15)
```

#### Table of relative benefit
```{r}
dat_supp4_rel_benefit <- df_avert_rr2_supp4 %>% 
  mutate(Booster = fct_relevel(booster, "Monovalent")) %>% 
  mutate(SAR = recode(SAR,`0.427` = "100%",
    `0.4697` = "110%", `0.5551` = "130%")) %>%
  mutate(SAR = fct_relevel(SAR, c("100%", "110%", "130%"))) %>% 
  mutate(Scenario = recode(scenario, endpoint = "Same endpoint",
    efficacy = "Same efficacy", penalty = "History dependent",
    WTpenalty = "History dependent", Ompenalty = "History dependent",
    "no booster" = "No booster")) %>%
  filter(Scenario == "Same endpoint" | Scenario == "No booster") %>%
  filter(SAR != "100%") %>% mutate(Scenario = fct_relevel(Scenario, 
        c("Same endpoint", "Same efficacy", "History dependent"))) %>%
  group_by(SAR,country,Scenario,Booster,) %>%
  summarise(x  = smean.cl.normal(da10K), 
            name = c("Mean","Lower","Upper")) %>% ungroup() %>%
  pivot_wider(names_from = name, values_from = x) %>%
  mutate(Booster = fct_relevel(Booster, 
       c("Monovalent (WT)","Monovalent (Omicron)", "Bivalent"))) %>%
  select(SAR, country, Scenario, Booster, Mean) %>% 
  #filter(Booster == "Monovalent (WT)" | Booster == "Bivalent") %>%
  pivot_wider(names_from = "Booster", values_from = "Mean") %>% 
  mutate(`Bivalent` = round(round(`Bivalent`,2)/round(`Monovalent (WT)`,2),2)) %>% 
  mutate(`Monovalent (Omicron)` = round(round(`Monovalent (Omicron)`,2)/round(`Monovalent (WT)`,2),2)) %>% 
  select(SAR, country, Scenario, `Bivalent`, `Monovalent (Omicron)`) %>% 
  pivot_longer(4:5, names_to = "Booster", values_to = "Relative Benefit")

write_csv(dat_supp4_rel_benefit,"../Supplement Tables/Table_same_endpoint_rel_benefit.csv")

```




### S5: Boost like Malaysia

#### Booster protection values

Taking the booster values and chunking into pre-booster and post-booster

```{r}

## grab prebooster values
dat_barplot_scenarios1_supp5 <- serotypes %>%
  select(history,Omicron_star) %>% 
  filter(history %in% c("Vaccine", "WT_vaccine", "Omicron_vaccine","Omicron_star_vaccine",  "Delta_vaccine")) %>% 
  rename(immunity = Omicron_star) %>% 
  select(history, immunity) %>% 
  mutate(history = recode(history, 
                          Delta_vaccine = "Delta + vaccine",
                          Omicron_vaccine = "Omicron + vaccine",
                          WT_vaccine = "WT + vaccine",
                          Vaccine = "Vaccine only", 
                          Omicron_star_vaccine = "Omicron* + vaccine")) %>% 
  rename(prebooster = immunity)

## grab postbooster values
dat_barplot_scenarios2_supp5 <- serotypes %>%
  select(history,Bivalent_penalty, Monovalent_WTpenalty, Monovalent_Ompenalty,
         Bivalent_efficacy, Monovalent_WTefficacy,
         Monovalent_Omefficacy,
         Bivalent_endpoint, Monovalent_WTendpoint,
         Monovalent_Omendpoint) %>% 
  filter(history %in% c("Vaccine", "WT_vaccine", "Omicron_vaccine", "Delta_vaccine", "Omicron_star_vaccine")) %>% 
  pivot_longer(-history, values_to = "immunity") %>% 
  separate(name, into = c("booster", "scenario"), sep = "_") %>% 
  mutate(history = recode(history, 
                          Delta_vaccine = "Delta + vaccine",
                          Omicron_vaccine = "Omicron + vaccine",
                          WT_vaccine = "WT + vaccine",
                          Vaccine = "Vaccine only", 
                          Omicron_star_vaccine = "Omicron* + vaccine")) %>% 
  rename(postbooster = immunity)

## combine pre and post booster
data_protection_supp5 <- left_join(dat_barplot_scenarios2_supp5, dat_barplot_scenarios1_supp5, by = "history") %>% 
  ## reverse everything; now we want protection instead of the scale-down parameter
  mutate(postbooster = 1-postbooster,
         prebooster = 1-prebooster,
         postbooster = postbooster-prebooster) %>% pivot_longer(postbooster:prebooster, names_to = "type", values_to = "immunity") %>%
  mutate(booster = if_else(substr(scenario, 1, 2) == "Om",
                           "Monovalent (Omicron)",
                           booster),
         booster = if_else(substr(scenario, 1, 2) == "WT",
                           "Monovalent (WT)",
                           booster))

```


#### Plot protection

```{r}
colors <- c("#BC8400","#7C2529","#005B40")

plot_supp5_protection <- data_protection_supp5 %>% mutate(history = fct_relevel(history, 
        c("Omicron* + vaccine", "Omicron + vaccine","Delta + vaccine", 
          "WT + vaccine","Vaccine only"))) %>% 
  mutate(Scenario = recode(scenario, endpoint = "Same endpoint",
    efficacy = "Same efficacy", penalty = "History dependent",
    WTpenalty = "History dependent", Ompenalty = "History dependent",
    "no booster" = "No booster")) %>%
  mutate(scenario = fct_relevel(Scenario, 
        c("Same endpoint", "Same efficacy", "History dependent"))) %>%
  mutate(booster = fct_relevel(booster, 
         c("Monovalent (WT)", "Monovalent (Omicron)", "Bivalent"))) %>%
  mutate(type = recode(type, prebooster = "Pre-booster", 
                       postbooster = "Post-booster")) %>% 
  mutate(type = fct_relevel(type, c("Post-booster"))) %>% 
  filter(Scenario == "History dependent") %>% 
  ggplot(aes(alpha = type,y=immunity, x=history, group = type)) +
  geom_bar(aes(fill=booster), position="stack", stat="identity", color="black") + 
  scale_fill_manual("Booster", values = colors, guide = "none") +
  scale_y_continuous("Total protection", limits = c(0,1), expand= c(0,0),
                       breaks = c(0,0.3,0.6,0.9), 
                       labels = scales::percent_format(accuracy = 1)) +
  facet_wrap(~booster, ncol = 1, scales = "free") +
  scale_alpha_manual("Booster status", 
          values = c("Post-booster" = 0.4, "Pre-booster" = 1.6 )) + 
  scale_x_discrete("Immune history") + 
  theme_classic() + coord_flip() + 
  ggtitle("Booster scenarios - History specific model") + 
  theme(axis.text = element_text(size = 11, color = "black"), #  angle = 90
        axis.title.x = element_text(size = 12, color = "black",vjust = -1),
        axis.title.y = element_text(size = 12, color = "black",vjust = +3),
        axis.line = element_line(color = "black"),
        axis.ticks = element_line(color = "black"),
        plot.title = element_text(colour = "black", size = 13.5, face = "bold"),
        plot.subtitle = element_text(colour = "black", size = 12.5),
        plot.margin = unit(c(t=0.2, r=1.5, b=0.5, l=1.5), "cm"),
        legend.position = "top", plot.title.position = "plot",
        strip.text = element_text(colour = "black", size = 11, hjust = 0),
        strip.background = element_rect(colour="white", fill="white"),
        legend.key.height= unit(0.4, 'cm'),
        legend.key.width= unit(0.4, 'cm'),
        legend.title = element_text(size = 11, color = "black"),
        legend.text = element_text(size = 10, color = "black"),
        legend.margin=margin(t=0.8,r=0.5,b=0.2,l=-4,unit = "line"),
        panel.spacing = unit(0.5, "cm")) # , aspect.ratio=1) + 
plot_supp5_protection
```


#### Data infections
Infections plot - this code duplicates the no booster scenario so that it appears as a comparison across all panels

```{r}

data_infections_WT <- data_supp5_boost_Malaysia %>% 
  filter(vaccine_star == "no", boost_shape == "functional", speed=="fast") %>%
  filter(scenario %in% c("WTpenalty")) %>% 
  mutate(scenario = "penalty") %>%
  filter(booster == "Monovalent") %>% 
  mutate(booster = "Monovalent (WT)")

data_infections_Om <- data_supp5_boost_Malaysia %>% 
  filter(vaccine_star == "no", boost_shape == "functional", speed=="fast") %>%
  filter(scenario %in% c("Ompenalty")) %>% 
    mutate(scenario = "penalty") %>%
  filter(booster == "Monovalent") %>% 
  mutate(booster = "Monovalent (Omicron)")

data_infections_Biv <- data_supp5_boost_Malaysia %>% 
  filter(vaccine_star == "no", boost_shape == "functional", speed=="fast") %>%
  filter(booster == "Bivalent")

data_infections_NoBoost_penalty <- data_supp5_boost_Malaysia %>% 
  filter(vaccine_star == "no", boost_shape == "no booster") %>%
  mutate(scenario = "penalty")%>% 
  mutate(booster = "No booster")


data_infections2_supp5 <- rbind(data_infections_WT, data_infections_Om) %>%
  rbind(data_infections_Biv) %>%
  rbind(data_infections_NoBoost_penalty)

rm(data_infections_WT, data_infections_Om,
   data_infections_Biv,data_infections_NoBoost_penalty)

gc()

```
#### Plot infections
```{r}
colors <- c("#0D3660","#BC8400","#7C2529", "#005B40")

dat_supp5 <- data_infections2_supp5 %>% filter(time >= start_sims + 900) %>%
  #mutate(time = time/30, 
  mutate(SAR = recode(SAR, `0.427` = "100%",
    `0.4697` = "110%", `0.5551` = "130%")) %>%
  mutate(SAR = fct_relevel(SAR, c("100%", "110%", "130%"))) %>% 
  mutate(Scenario = recode(scenario,
    endpoint = "Same endpoint",
     "no booster" = "No booster")) %>%
  mutate(scenario = fct_relevel(Scenario, 
       c("No booster","Same endpoint"))) %>% 
  mutate(booster = fct_relevel(booster, 
       c("No booster","Monovalent (WT)","Monovalent (Omicron)", "Bivalent"))) %>% 
  filter(SAR != "100%") %>%
  mutate(inf10K = 10000*infections_over_time/start_pop) %>%
  group_by(time,country,booster,scenario,SAR) %>%
  summarise(x  = smean.cl.normal(inf10K), 
            name = c("Mean","Lower","Upper")) %>% ungroup() %>%
  pivot_wider(names_from = name, values_from = x)

rm(data_infections2_supp5)
gc()

  
plot_supp5 <- dat_supp5 %>%
  mutate(country = case_when(
    country == "Ecuador" ~ "Ecuador-like",
    country == "India" ~ "India-like",
    country == "Malaysia" ~ "Malaysia-like"
  )) %>%
  ggplot(aes(x = time, fill = booster, 
            color = booster, linetype = SAR, 
            group = interaction(country, scenario, booster, SAR))) +
  geom_ribbon(aes(ymin = Lower, ymax = Upper), alpha = 0.5) + 
  geom_line(aes(y=Mean), alpha = 0) + theme_classic() + 
  scale_fill_manual("Booster type", values = colors) +
  scale_color_manual("Booster type", values = colors) + 
  ylab("Infections per 10,000") +
  facet_wrap(~country, scales = "free") + 
  ggh4x::facetted_pos_scales(y = list(
  country == "Ecuador-like" ~ scale_y_continuous(limits = c(0, NA), breaks = c(0,20,40,60,80)),
  country == "India-like" ~ scale_y_continuous(limits = c(0, NA)),
  country == "Malaysia-like" ~ scale_y_continuous(limits = c(0, NA), 
                                             breaks = c(0,30,60,90,120)))) + 
  #scale_y_continuous(, limits = c(0,NA)) + # expand = c(0,0) 
  #scale_x_continuous("Time (months)", expand = c(0,0.5), breaks = c(30,32,34,36)) +
    scale_x_date("Date", expand = c(0,0), date_breaks = "1 month", date_labels =  "%b %Y") + 
  ggtitle("Infections during Omicron* - History specific model", "Boost like Malaysia") + #, "Variant-specific model") +
  guides(linetype = guide_legend(override.aes = list(alpha = 1, fill=NA))) +
  scale_linetype_manual("Infectiousness", values = c("dashed")) +
  theme(axis.text = element_text(size = 11, color = "black"),
        #axis.title.x = element_text(size = 12, color = "black",vjust = -1),
        axis.text.x=element_text(angle=60, hjust=1),
        axis.title.y = element_text(size = 12, color = "black",vjust = +3),
        axis.line = element_line(color = "black"),
        axis.ticks = element_line(color = "black"),
        plot.title = element_text(colour = "black", size = 13.5, face = "bold"),
        plot.subtitle = element_text(colour = "black", size = 12.5),
        plot.title.position = "plot",
        plot.margin = unit(c(t=0.2, r=1, b=0.2, l=1.5), "cm"),
        legend.position = "top",
        strip.text = element_text(colour = "black", size = 11, hjust = 0),
        strip.background = element_rect(colour="white", fill="white"),
        legend.margin=margin(t=0.8,r=0.5,b=0.2,l=0,unit = "line"),
        legend.key.height= unit(0.4, 'cm'),
        legend.key.width= unit(0.4, 'cm'),
        legend.title = element_text(size = 11, color = "black"),
        legend.text = element_text(size = 10, color = "black"),
        panel.spacing = unit(0.5, "cm")) #, aspect.ratio=1,
        #panel.grid.major = element_line(color = "grey95"),
        #panel.grid.minor = element_line(color = "grey95")) 
plot_supp5
```

#### Data Deaths

Calculating the deaths averted

```{r}
df_compare_supp5 <- data_supp5_boost_Malaysia %>% 
  filter(boost == "no", vaccine_star == "no") %>% 
  filter(time >= start_sims + 900) %>% 
  group_by(SAR, country, replicate) %>% 
  mutate(deaths10K = 10000*deaths_over_time/start_pop) %>%
  #mutate(deaths_high = max(deaths), deaths_low = min(deaths))
  summarise(
    death_compare_10K = max(deaths10K)-min(deaths10K)
  ) %>%
  ungroup()

df_avert_supp5 <-  data_supp5_boost_Malaysia %>% 
  filter(boost == "yes", vaccine_star == "no", boost_shape == "functional", speed=="fast") %>% 
  #filter(time >= 900/365) %>% 
  filter(time >= start_sims + 900) %>%
  group_by(SAR, scenario, booster, country, replicate) %>% ## matching each booster scenario to a no booster scenario
  mutate(deaths10K = 10000*deaths_over_time/start_pop) %>%
  summarise(
    deaths_10K = max(deaths10K, na.rm = T)-min(deaths10K, na.rm = T)
  ) %>%
  ungroup()

df_avert_rr_supp5 <- left_join(df_avert_supp5, df_compare_supp5, by = c("SAR", "country", "replicate")) %>%
  group_by(SAR, country, booster, scenario, replicate) %>%
  mutate(da10K = death_compare_10K-deaths_10K,
         da_perc = da10K/death_compare_10K) %>%
ungroup() %>%
  select(
    SAR, country, replicate, scenario = scenario, booster = booster, death_compare_10K, deaths_10K, da10K, da_perc)

  

# df_avert_rr <- left_join(df_avert, df_compare, by = c("SAR", "country", "replicate")) %>% 
#   group_by(SAR, country, booster, scenario, replicate) %>% 
#   mutate(rr = deaths/death_compare,
#          da = 1-rr) %>%
# ungroup() %>% 
#   select(
#     SAR, country, replicate, scenario = scenario, booster = booster, da)


df_avert_rr_splitWT <- df_avert_rr_supp5 %>% 
  filter(scenario %in% c("WTpenalty")) %>%
  mutate(scenario = "penalty") %>%
  filter(booster == "Monovalent") %>% 
  mutate(booster = "Monovalent (WT)")
df_avert_rr_splitOm <- df_avert_rr_supp5 %>% 
  filter(scenario %in% c("Ompenalty")) %>% 
  mutate(scenario = "penalty") %>%
  filter(booster == "Monovalent") %>% 
  mutate(booster = "Monovalent (Omicron)")

df_avert_rr2_supp5 <- df_avert_rr_supp5 %>%
  filter(booster == "Bivalent" | booster == "no booster" | booster == "No booster") %>%
  rbind(df_avert_rr_splitWT) %>% 
  rbind(df_avert_rr_splitOm)

rm(df_avert_rr_splitOm, df_avert_rr_splitWT)

```

#### Plot deaths averted

```{r}
colors <- c("#BC8400","#7C2529","#005B40")

comparisons <- list( c("Bivalent", "Monovalent (WT)"), 
                        c("Bivalent", "Monovalent (Omicron)"), 
                        c("Monovalent (WT)", "Monovalent (Omicron)"))

dat_supp5_da <- df_avert_rr2_supp5 %>% 
  mutate(Booster = fct_relevel(booster, "Monovalent")) %>% 
  mutate(SAR = recode(SAR,`0.427` = "100%",
    `0.4697` = "110%", `0.5551` = "130%")) %>%
  mutate(SAR = fct_relevel(SAR, c("100%", "110%", "130%"))) %>% 
  mutate(Scenario = recode(scenario, penalty = "History dependent",
    WTpenalty = "History dependent", Ompenalty = "History dependent",
    "no booster" = "No booster")) %>%
  filter(Scenario == "History dependent" | Scenario == "No booster") %>%
  filter(SAR != "100%") %>% mutate(Scenario = fct_relevel(Scenario, 
        c("Same endpoint", "Same efficacy", "History dependent"))) %>%
  group_by(SAR,country,Scenario,Booster,) %>%
  summarise(x  = smean.cl.normal(da10K), 
            name = c("Mean","Lower","Upper")) %>% ungroup() %>%
  pivot_wider(names_from = name, values_from = x) %>%
  mutate(Booster = fct_relevel(Booster, 
       c("Monovalent (WT)","Monovalent (Omicron)", "Bivalent")))

plot_supp5_da <- dat_supp5_da %>%
  mutate(country = case_when(
    country == "Ecuador" ~ "Ecuador-like",
    country == "India" ~ "India-like",
    country == "Malaysia" ~ "Malaysia-like"
  )) %>%
  ggplot(aes(x = SAR, fill = Booster, color = Booster,
                     group = interaction(Booster, SAR, Scenario))) + 
  geom_bar(aes(y=Mean), stat="identity", position=position_dodge(0.7),  
           alpha=0.5, size = 0.6, width = 0.6) + theme_classic() +
  geom_errorbar(aes(ymin  = Lower, ymax  = Upper),
           stat="identity", position=position_dodge(0.7),  
           size = 0.6, width = 0.3, show.legend=FALSE) + 
      geom_text(aes(label = round(Mean, 2), y = Upper + 0.2), position=position_dodge(0.7), size = 3) + ## this line adds the labels
  scale_fill_manual("Booster", values = colors) +
  scale_color_manual("Booster", values = colors) +
  facet_wrap(~country, scales = "free", nrow = 1) +
  scale_y_continuous("Deaths averted per 10,000", limits = c(0,8.5), 
                     expand = expansion(mult = c(0,0))) +
  scale_x_discrete("Infectiousness relative to Omicron") +
  ggtitle("Deaths averted - History specific model", "Boost like Malaysia") + #, subtitle = "Variant-specific model") + 
  theme(axis.text = element_text(size = 11, color = "black"),
        axis.title.x = element_text(size = 12, color = "black",vjust = -1),
        axis.title.y = element_text(size = 12, color = "black",vjust = +3),
        axis.line = element_line(color = "black"),
        axis.ticks = element_line(color = "black"),
        plot.title = element_text(colour = "black", size = 13.5, face = "bold"),
        plot.subtitle = element_text(colour = "black", size = 12.5),
        plot.title.position = "plot",
        plot.margin = unit(c(t=0.2, r=1, b=0.5, l=1.5), "cm"),
        legend.position = "none",
        # legend.margin=margin(t=0.5,r=0.5,b=0.5,l=0.5,unit = "line"),
        # legend.key.height= unit(0.4, 'cm'),
        # legend.key.width= unit(0.4, 'cm'),
        # legend.title = element_text(size = 11, color = "black"),
        # legend.text = element_text(size = 10, color = "black"),
        strip.text = element_text(colour = "black", size = 11, hjust = 0),
        strip.background = element_rect(colour="white", fill="white"),
        panel.spacing = unit(0.5, "cm")) #, aspect.ratio=0.7)
plot_supp5_da
```


#### Save S5
```{r}
plot2BC_supp5 <- plot_grid(plot_supp5,plot_supp5_da, nrow = 2, labels = c("B", "C"),
                     rel_heights = c(1.1, 1))

plot2_supp5 <- plot_grid(plot_supp5_protection, plot2BC_supp5, nrow = 1, labels = c("A", ""), 
                   rel_widths = c(0.5, 1))
ggsave("../Supplement/S5_Malaysia_boost.pdf", plot2_supp5, height = 7.5, width = 15)
```


#### Table of relative benefit

```{r}
dat_supp5_rel_benefit <- df_avert_rr2_supp5 %>% 
  mutate(Booster = fct_relevel(booster, "Monovalent")) %>% 
  mutate(SAR = recode(SAR,`0.427` = "100%",
    `0.4697` = "110%", `0.5551` = "130%")) %>%
  mutate(SAR = fct_relevel(SAR, c("100%", "110%", "130%"))) %>% 
  mutate(Scenario = recode(scenario, penalty = "History dependent",
    WTpenalty = "History dependent", Ompenalty = "History dependent",
    "no booster" = "No booster")) %>%
  filter(Scenario == "History dependent" | Scenario == "No booster") %>%
  filter(SAR != "100%") %>% mutate(Scenario = fct_relevel(Scenario, 
        c("Same endpoint", "Same efficacy", "History dependent"))) %>%
  group_by(SAR,country,Scenario,Booster,) %>%
  summarise(x  = smean.cl.normal(da10K), 
            name = c("Mean","Lower","Upper")) %>% ungroup() %>%
  pivot_wider(names_from = name, values_from = x) %>%
  mutate(Booster = fct_relevel(Booster, 
       c("Monovalent (WT)","Monovalent (Omicron)", "Bivalent"))) %>%
  select(SAR, country, Scenario, Booster, Mean) %>% 
  #filter(Booster == "Monovalent (WT)" | Booster == "Bivalent") %>%
  pivot_wider(names_from = "Booster", values_from = "Mean") %>% 
  mutate(`Bivalent` = round(round(`Bivalent`,2)/round(`Monovalent (WT)`,2),2)) %>% 
  mutate(`Monovalent (Omicron)` = round(round(`Monovalent (Omicron)`,2)/round(`Monovalent (WT)`,2),2)) %>% 
  select(SAR, country, Scenario, `Bivalent`, `Monovalent (Omicron)`) %>% 
  pivot_longer(4:5, names_to = "Booster", values_to = "Relative Benefit")

write_csv(dat_supp5_rel_benefit,"../Supplement Tables/Table_boost_Malaysia_rel_benefit.csv")
```




### S6: Pre-star booster
#### Booster protection values

Taking the booster values and chunking into pre-booster and post-booster

```{r}

## grab prebooster values
dat_barplot_scenarios1_prestar <- serotypes %>%
  select(history,Omicron_star) %>% 
  filter(history %in% c("Vaccine", "WT_vaccine", "Omicron_vaccine","Omicron_star_vaccine",  "Delta_vaccine")) %>% 
  rename(immunity = Omicron_star) %>% 
  select(history, immunity) %>% 
  mutate(history = recode(history, 
                          Delta_vaccine = "Delta + vaccine",
                          Omicron_vaccine = "Omicron + vaccine",
                          WT_vaccine = "WT + vaccine",
                          Vaccine = "Vaccine only", 
                          Omicron_star_vaccine = "Omicron* + vaccine")) %>% 
  rename(prebooster = immunity)

## grab postbooster values
dat_barplot_scenarios2_prestar <- serotypes %>%
  select(history,
         Bivalent_penalty_Omicron, 
         Monovalent_WTpenalty_Omicron, 
         Monovalent_Ompenalty_Omicron,
         Bivalent_efficacy_Omicron, 
         Monovalent_WTefficacy_Omicron,
         Monovalent_Omefficacy_Omicron,
         Bivalent_endpoint_Omicron, 
         Monovalent_WTendpoint_Omicron,
         Monovalent_Omendpoint_Omicron) %>% 
  filter(history %in% c("Vaccine", "WT_vaccine", "Omicron_vaccine", "Delta_vaccine", "Omicron_star_vaccine")) %>% 
  pivot_longer(-history, values_to = "immunity") %>% 
  separate(name, into = c("booster", "scenario"), sep = "_") %>% 
  mutate(history = recode(history, 
                          Delta_vaccine = "Delta + vaccine",
                          Omicron_vaccine = "Omicron + vaccine",
                          WT_vaccine = "WT + vaccine",
                          Vaccine = "Vaccine only", 
                          Omicron_star_vaccine = "Omicron* + vaccine")) %>% 
  rename(postbooster = immunity)

## combine pre and post booster
data_protection_prestar <- left_join(dat_barplot_scenarios2_prestar, dat_barplot_scenarios1_prestar, by = "history") %>% 
  ## reverse everything; now we want protection instead of the scale-down parameter
  mutate(postbooster = 1-postbooster,
         prebooster = 1-prebooster,
         postbooster = postbooster-prebooster) %>% pivot_longer(postbooster:prebooster, names_to = "type", values_to = "immunity") %>%
  mutate(booster = if_else(substr(scenario, 1, 2) == "Om",
                           "Monovalent (Omicron)",
                           booster),
         booster = if_else(substr(scenario, 1, 2) == "WT",
                           "Monovalent (WT)",
                           booster))

```


#### Plot protection

```{r}
colors <- c("#BC8400","#7C2529","#005B40")

plot_prestar_protection <- data_protection_prestar %>% mutate(history = fct_relevel(history, 
        c("Omicron* + vaccine", "Omicron + vaccine","Delta + vaccine", 
          "WT + vaccine","Vaccine only"))) %>% 
  mutate(Scenario = recode(scenario, 
    endpoint = "Same endpoint",
    WTendpoint = "Same endpoint",
    Omendpoint = "Same endpoint",
    efficacy = "Same efficacy",
    WTefficacy = "Same efficacy",
    Omefficacy = "Same efficacy",
    penalty = "History dependent",
    WTpenalty = "History dependent", Ompenalty = "History dependent",
    "no booster" = "No booster")) %>%
  mutate(scenario = fct_relevel(Scenario, 
        c("Same endpoint", "Same efficacy", "History dependent"))) %>%
  mutate(booster = fct_relevel(booster, 
         c("Monovalent (WT)", "Monovalent (Omicron)", "Bivalent"))) %>%
  mutate(type = recode(type, prebooster = "Pre-booster", 
                       postbooster = "Post-booster")) %>% 
  mutate(type = fct_relevel(type, c("Post-booster"))) %>% 
  ggplot(aes(alpha = type,y=immunity, x=history, group = type)) +
  geom_bar(aes(fill=booster), position="stack", stat="identity", color="black") + 
  scale_fill_manual("Booster", values = colors, guide = "none") +
  scale_y_continuous("Total protection", limits = c(0,1), expand= c(0,0),
                       breaks = c(0,0.3,0.6,0.9), 
                       labels = scales::percent_format(accuracy = 1)) +
  facet_grid(scenario~booster, scales = "free") +
  scale_alpha_manual("Booster status", 
          values = c("Post-booster" = 0.4, "Pre-booster" = 1.6 )) + 
  scale_x_discrete("Immune history") + 
  theme_classic() + coord_flip() + 
  ggtitle("Booster efficacy during Omicron - History specific model") + 
  theme(axis.text = element_text(size = 11, color = "black"), #  angle = 90
        axis.title.x = element_text(size = 12, color = "black",vjust = -1),
        axis.title.y = element_text(size = 12, color = "black",vjust = +3),
        axis.line = element_line(color = "black"),
        axis.ticks = element_line(color = "black"),
        plot.title = element_text(colour = "black", size = 13.5, face = "bold"),
        plot.subtitle = element_text(colour = "black", size = 12.5),
        plot.margin = unit(c(t=0.2, r=1.5, b=0.5, l=1.5), "cm"),
        legend.position = "top", plot.title.position = "plot",
        strip.text = element_text(colour = "black", size = 11, hjust = 0),
        strip.background = element_rect(colour="white", fill="white"),
        legend.key.height= unit(0.4, 'cm'),
        legend.key.width= unit(0.4, 'cm'),
        legend.title = element_text(size = 11, color = "black"),
        legend.text = element_text(size = 10, color = "black"),
        legend.margin=margin(t=0.8,r=0.5,b=0.2,l=-4,unit = "line"),
        panel.spacing = unit(0.5, "cm")) # , aspect.ratio=1) + 
plot_prestar_protection
```


#### Save S6
```{r}

ggsave("../Supplement/S6_pre_omicron_boosters.pdf", plot_prestar_protection, height = 7.5, width = 15)
```

### S7: WHO case data

#### Plot cases
```{r}
plot_real_cases <- dataWHO %>% 
  mutate(time = as.Date(Date_reported, "%Y-%m-%d")) %>%
  filter(time < start_sims + 900) %>%
  group_by(Country) %>% 
  mutate(infs10K=10000*infs_perc) %>%
  mutate(infs10K = slide_index_mean(infs10K, time, after = 7)) %>%
  #mutate(infs = despike(infs, reference = "median"), k = 7) %>% # smooth over a 7 day rolling median window
  ungroup() %>%
  #mutate(months = time/30) %>%
  ggplot(aes(x = time, y = infs10K, color = Country)) + 
  geom_line(size = 0.8) + 
  scale_color_manual("Country", values = c("#05878a", "#5a175d", "#dd9933")) + 
  theme_minimal() +
  scale_y_continuous("Confirmed new cases per 10,000") +
  #scale_x_continuous("Time (months)") +
    scale_x_date("Date", expand = c(0,0), date_breaks = "4 month", date_labels =  "%b %Y") + 
  geom_vline(aes(xintercept = 840/30), size = 1, color = "blue") +
  theme(axis.text = element_text(size = 11, color = "black"),
        axis.text.x=element_text(angle=60, hjust=1),
        axis.title = element_text(size = 12, color = "black"),
        axis.line = element_blank(),
        axis.ticks = element_line(color = "black"),
        plot.title = element_text(colour = "black", size = 13.5, face = "bold"),
        plot.subtitle = element_text(colour = "black", size = 12.5),
        plot.margin = unit(c(0, 0, 0, 0), "cm"),
        legend.position = "none",
        strip.text = element_text(colour = "black", size = 10.5, hjust = 0),
        strip.background = element_rect(colour="white", fill="white"),
        panel.border = element_rect(colour = "black", fill=NA),
        panel.spacing = unit(0.5, "cm"), aspect.ratio=1) + 
  facet_wrap(~Country, scales = "free") +
  ggtitle("WHO confirmed cases")
plot_real_cases
```

#### Save
```{r}

ggsave("../Supplement/S7_WHO_cases.pdf", plot_real_cases, height = 3, width = 8)
```

### S8: Pre-omicron infections

#### clear data
```{r}

rm(data_protection_prestar, data_protection_supp1, data_protection_supp2, data_protection_supp3, 
   data_protection_supp4, data_protection_supp5)
rm(dat_supp1, dat_supp1_da, dat_supp2, dat_supp2_da, dat_supp3, dat_supp3_da, dat_supp4, dat_supp4_da, dat_supp5, dat_supp5_da, data_supp3_same_efficacy, data_supp4_same_endpoint, data_supp5_boost_Malaysia)


rm(df_avert_rr_supp1)

gc()
```


#### Data infections
Infections plot - this code duplicates the no booster scenario so that it appears as a comparison across all panels

```{r}

data_infections_WT <- dataAll %>% 
  filter(vaccine_star == "no", boost_shape == "functional", speed=="fast") %>%
  filter(scenario %in% c("WTpenalty", "WTendpoint", "WTefficacy")) %>% 
  filter(booster == "Monovalent") %>% 
  mutate(booster = "Monovalent (WT)")

data_infections_Om <- dataAll %>% 
  filter(vaccine_star == "no", boost_shape == "functional", speed=="fast") %>%
  filter(scenario %in% c("Ompenalty", "Omendpoint", "Omefficacy")) %>% 
  filter(booster == "Monovalent") %>% 
  mutate(booster = "Monovalent (Omicron)")

data_infections_Biv <- dataAll%>% 
  filter(vaccine_star == "no", boost_shape == "functional", speed=="fast") %>%
  filter(booster == "Bivalent")

data_infections_NoBoost_penalty <- dataAll %>% 
  filter(vaccine_star == "no", boost_shape == "no booster") %>%
  mutate(scenario = "penalty")%>% 
  mutate(booster = "No booster")


data_infections2_preOm <- rbind(data_infections_WT, data_infections_Om) %>%
  rbind(data_infections_Biv) %>%
  rbind(data_infections_NoBoost_penalty)

rm(data_infections_WT, data_infections_Om,
   data_infections_Biv,data_infections_NoBoost_penalty)

gc()
```
#### Plot infections
```{r}
colors <- c("#0D3660","#BC8400","#7C2529", "#005B40")

dat_preOm <- data_infections2_preOm %>% 
  filter(time < start_sims + 900) %>%
  #mutate(time = time/30, 
  mutate(SAR = recode(SAR, `0.427` = "100%",
    `0.4697` = "110%", `0.5551` = "130%")) %>%
  mutate(SAR = fct_relevel(SAR, c("100%", "110%", "130%"))) %>% 
  mutate(Scenario = recode(scenario,
    endpoint = "Same endpoint",efficacy = "Same efficacy",
    penalty = "History dependent",WTpenalty = "History dependent",
    Ompenalty = "History dependent", "no booster" = "No booster")) %>%
  mutate(scenario = fct_relevel(Scenario, 
       c("No booster", "Same endpoint","Same efficacy","History dependent"))) %>% 
  mutate(booster = fct_relevel(booster, 
       c("No booster","Monovalent (WT)","Monovalent (Omicron)", "Bivalent"))) %>% 
  filter(scenario == "History dependent", SAR == "130%") %>%
  mutate(inf10K = 10000*infections_over_time/start_pop) %>%
  group_by(time,country,booster,scenario,SAR) %>%
  summarise(x  = smean.cl.normal(inf10K), 
            name = c("Mean","Lower","Upper")) %>% ungroup() %>%
  pivot_wider(names_from = name, values_from = x)

rm(data_infections2_preOm)
gc()
  
plot_preOm <- dat_preOm %>%
  mutate(country = case_when(
    country == "Ecuador" ~ "Ecuador-like",
    country == "India" ~ "India-like",
    country == "Malaysia" ~ "Malaysia-like"
  )) %>%
  ggplot(aes(x = time, fill = booster, 
            color = booster, linetype = SAR, 
            group = interaction(country, scenario, booster, SAR))) +
  geom_ribbon(aes(ymin = Lower, ymax = Upper), alpha = 0.5) + 
  geom_line(aes(y=Mean), alpha = 0) + theme_classic() + 
  scale_fill_manual("Booster type", values = colors) +
  scale_color_manual("Booster type", values = colors) + 
  ylab("Infections per 10,000") +
  geom_vline(xintercept = 28, color="blue", linetype="solid", size=1.3) +
  facet_grid(country~booster, scales = "free") + 
  #ggh4x::facetted_pos_scales(y = list(
  #country == "Ecuador" ~ scale_y_continuous(limits = c(0, NA), breaks = c(0,20,40,60,80)),
  #country == "India" ~ scale_y_continuous(limits = c(0, NA)),
  #country == "Malaysia" ~ scale_y_continuous(limits = c(0, NA), 
  #                                           breaks = c(0,30,60,90,120)))) + 
  #scale_y_continuous(, limits = c(0,NA)) + # expand = c(0,0) 
  #scale_x_continuous("Time (months)", expand = c(0,0.5), breaks = c(0,4,8,12,16,20,24,28,32,34)) +
      scale_x_date("Date", expand = c(0,0), date_breaks = "4 month", date_labels =  "%b %Y") + 
  ggtitle("Infections pre-Omicron* - History specific model") + #, "Variant-specific model") +
  guides(linetype = guide_legend(override.aes = list(alpha = 1, fill=NA))) +
  scale_linetype_manual("Infectiousness", values = c("solid","dashed")) +
  theme(axis.text = element_text(size = 11, color = "black"),
        #axis.title.x = element_text(size = 12, color = "black",vjust = -1),
                axis.text.x=element_text(angle=60, hjust=1),
        axis.title.y = element_text(size = 12, color = "black",vjust = +3),
        axis.line = element_line(color = "black"),
        axis.ticks = element_line(color = "black"),
        plot.title = element_text(colour = "black", size = 13.5, face = "bold"),
        plot.subtitle = element_text(colour = "black", size = 12.5),
        plot.title.position = "plot",
        plot.margin = unit(c(t=0.2, r=1, b=0.2, l=1.5), "cm"),
        legend.position = "top",
        strip.text = element_text(colour = "black", size = 11, hjust = 0),
        strip.background = element_rect(colour="white", fill="white"),
        legend.margin=margin(t=0.8,r=0.5,b=0.2,l=0,unit = "line"),
        legend.key.height= unit(0.4, 'cm'),
        legend.key.width= unit(0.4, 'cm'),
        legend.title = element_text(size = 11, color = "black"),
        legend.text = element_text(size = 10, color = "black"),
        panel.spacing = unit(0.5, "cm")) #, aspect.ratio=1,
        #panel.grid.major = element_line(color = "grey95"),
        #panel.grid.minor = element_line(color = "grey95")) 
plot_preOm
```
#### Save
```{r}

ggsave("../Supplement/S8_pre_Omicron.pdf", plot_preOm, height =5, width = 12)
```


### Supp 9: Vaccine + Booster curves

#### Splines

Vaccination function - splines
```{r}

type_III_resp <- function (t, Vmax, WVH, k) {
  
  return(Vmax*(t^k)/((WVH^k) + (t^k)))
}

vacc_weekly <- function (Vmax, WVH, k, country, SES){
  datOut <- tibble(Week = 1:157, Vac = type_III_resp(1:157, Vmax,WVH, k)) %>%
    mutate(dailyVac =  c(Vac[1],diff(Vac)),
           VacCumSum = cumsum(dailyVac)) %>% 
    arrange(Week) %>%
    mutate(Day = Week*7-7+1, dailyVac=dailyVac/7, country = country, SES = SES)
  return(datOut)
  
  #vaccF <- splinefun(x = datOut$Day, y = datOut$dailyVac)
  #return(vaccF)
}
```

#### Get trends
```{r}

#### Slow trends ####

vacc_low_India <- vacc_weekly(0.7833, 32.06, 2.54, "India", "Low")
vacc_high_India <- vacc_weekly(0.9279, 23.42, 2.83, "India", "High") %>% 
  rbind(vacc_low_India)
rm(vacc_low_India)
  
vacc_low_Ecuador <- vacc_weekly(0.7872, 30.57, 3.87, "Ecuador", "Low")%>% 
  rbind(vacc_high_India)
rm(vacc_high_India)
vacc_high_Ecuador <- vacc_weekly(1, 24.49, 3.05, "Ecuador", "High") %>% 
  rbind(vacc_low_Ecuador)
rm(vacc_low_Ecuador)
  
vacc_low_Malaysia <-vacc_weekly(0.7171, 21.28, 4.97, "Malaysia", "Low") %>% 
  rbind(vacc_high_Ecuador)
rm(vacc_high_Ecuador)
vacc_high_Malaysia <-vacc_weekly(0.9654, 19.92, 5.50, "Malaysia", "High") %>% 
  rbind(vacc_low_Malaysia)
rm(vacc_low_Malaysia)

vacc_full <- vacc_high_Malaysia
rm(vacc_high_Malaysia)

vacc_truncate <- vacc_full %>% filter(Day <= 600) %>% filter(Day == max(Day)) %>% 
  select(country, SES, day596 = VacCumSum)

vacc_full <- vacc_full %>% left_join(vacc_truncate, by=c("country", "SES"))
# 
# #### faster trends - boosters ####
# 
# vacc_low_India <- vacc_weekly(0.27, 32.06-10, 2.54, "India", "Low")
# vacc_high_India <- vacc_weekly(0.26, 23.42-10, 2.83, "India", "High") %>% 
#   rbind(vacc_low_India)
# rm(vacc_low_India)
#   
# vacc_low_Ecuador <- vacc_weekly(0.71, 30.57-10, 3.87, "Ecuador", "Low")%>% 
#   rbind(vacc_high_India)
# rm(vacc_high_India)
# vacc_high_Ecuador <- vacc_weekly(0.70, 24.49-10, 3.05, "Ecuador", "High") %>% 
#   rbind(vacc_low_Ecuador)
# rm(vacc_low_Ecuador)
#   
# vacc_low_Malaysia <-vacc_weekly(0.67, 21.28-10, 4.97, "Malaysia", "Low") %>% 
#   rbind(vacc_high_Ecuador)
# rm(vacc_high_Ecuador)
# vacc_high_Malaysia <-vacc_weekly(0.67, 19.92-10, 5.50, "Malaysia", "High") %>% 
#   rbind(vacc_low_Malaysia)
# rm(vacc_low_Malaysia)
# 
# boost_full_fast <- vacc_high_Malaysia
# rm(vacc_high_Malaysia)
# 
# boost_truncate_fast <- boost_full_fast %>% filter(Day <= 600) %>% filter(Day == max(Day)) %>% 
#   select(country, SES, day596 = VacCumSum)
# 
# boost_full_fast <- boost_full_fast %>% left_join(boost_truncate_fast, by=c("country", "SES"))
# 
# #### slower trends - boosters ####
# 
# vacc_low_India <- vacc_weekly(0.27, 32.06, 2.54, "India", "Low")
# vacc_high_India <- vacc_weekly(0.26, 23.42, 2.83, "India", "High") %>% 
#   rbind(vacc_low_India)
# rm(vacc_low_India)
#   
# vacc_low_Ecuador <- vacc_weekly(0.71, 30.57, 3.87, "Ecuador", "Low")%>% 
#   rbind(vacc_high_India)
# rm(vacc_high_India)
# vacc_high_Ecuador <- vacc_weekly(0.70, 24.49, 3.05, "Ecuador", "High") %>% 
#   rbind(vacc_low_Ecuador)
# rm(vacc_low_Ecuador)
#   
# vacc_low_Malaysia <-vacc_weekly(0.67, 21.28, 4.97, "Malaysia", "Low") %>% 
#   rbind(vacc_high_Ecuador)
# rm(vacc_high_Ecuador)
# vacc_high_Malaysia <-vacc_weekly(0.67, 19.92, 5.50, "Malaysia", "High") %>% 
#   rbind(vacc_low_Malaysia)
# rm(vacc_low_Malaysia)
# 
# boost_full <- vacc_high_Malaysia
# rm(vacc_high_Malaysia)
# 
# boost_truncate <- boost_full %>% filter(Day <= 600) %>% filter(Day == max(Day)) %>% 
#   select(country, SES, day596 = VacCumSum)
# 
# boost_full <- boost_full %>% left_join(boost_truncate, by=c("country", "SES"))
# 
# #### get both rates ####
# 
# boost_full <- boost_full %>% mutate(speed = "observed")
# boost_full_fast <- boost_full_fast %>% mutate(speed = "faster")
# 
# speed_boost <- rbind(boost_full, boost_full_fast)

```

#### Observed data
```{r}

vax_fit <- dataTexampAll %>% 
  #filter(type == "predicted") %>% 
  pivot_longer(H:L, names_to = "SES", values_to = "vaccinated") %>% 
  mutate(vaccinated = 100*vaccinated) %>%
  filter(week*7 < 600) %>%
  ggplot(aes(x= week*7, y = vaccinated)) +
  geom_line(data=. %>% filter(type == "predicted") %>% rename(Fit = SES), 
            aes(linetype = Fit, color = Name), size = 0.75) + 
  geom_point(data=. %>% filter(type == "observed") %>% rename(Observed = SES), 
          aes(shape = Observed, color = Name), size = 0.9, alpha = 0.5) +
  scale_y_continuous("First-dose Vaccinated (%)", limits = c(0,100)) +
  scale_x_continuous("Days since vaccination started", limits = c(0,930-320), labels = c(0,100,200,300,400,500,600), breaks = c(0,100,200,300,400,500,600)) +
  ggtitle("Observed vaccination","Primary series") +
  scale_color_manual("Country", values = c("#05878a", "#5a175d", "#dd9933")) + 
  theme_minimal() +
      geom_vline(xintercept = 900-320, color="red", linetype="solid", size=1.3) +
  #facet_wrap(~Name) +
  guides(shape = guide_legend(override.aes = list(size=0.8, alpha = 0.6)), 
         color = guide_legend(order = 1)) + 
    theme(axis.text = element_text(size = 14, color = "black"),
        axis.title = element_text(size = 14, color = "black"),
        axis.line = element_blank(),
        axis.ticks = element_line(color = "black"),
        plot.title = element_text(colour = "black", size = 15, face = "bold"),
        plot.subtitle = element_text(colour = "black", size = 13),
        plot.margin = unit(c(0, 0, 0, 0), "cm"),
        legend.position = "right",
        legend.title = element_text(size = 14, color = "black"),
        legend.text = element_text(size = 13, color = "black"),
        strip.text = element_text(colour = "black", size = 14, hjust = 0),
        strip.background = element_rect(colour="white", fill="white"),
        panel.border = element_rect(colour = "black", fill=NA),
        panel.spacing = unit(0.5, "cm"), aspect.ratio=0.3)
vax_fit
  
```

#### model vaccination - main text
```{r}

vax_trends_model <- read_csv("../Data/ABM Main Runs/dataAll.csv")%>% 
  left_join(pop_ABM) %>%
  group_by(ID_runs, time) %>% 
  filter(cum_sum_Inf == max(cum_sum_Inf)) %>%
  ungroup() %>% 
    filter(scenario == "no booster", vaccine_star == "no") %>% 
  group_by(country, time) %>% 
  summarise(vaccinated = 100*mean(vaccinated_over_time/start_pop)) %>% 
  ungroup() %>% 
filter(time >= 320, time < 900) %>% 
  mutate(time = time - 320) %>% 
  mutate(time = time) %>% 
  mutate(country = case_when(
    country == "Ecuador" ~ "Ecuador-like",
    country == "India" ~ "India-like",
    country == "Malaysia" ~ "Malaysia-like"
  )) %>%
  ggplot(aes(x = time, y = vaccinated, group = interaction(country))) + 
  geom_line(aes(color = country), size = 1) + 
  #facet_grid(~country)+ 
  theme_minimal() + 
      geom_vline(xintercept = 900-320, color="red", linetype="solid", size=1.3) +
  scale_color_manual("Country", values = c("#05878a", "#5a175d", "#dd9933")) + 
  scale_y_continuous("Vaccinated (%)", limits = c(0,100)) +
  scale_x_continuous("Days since vaccination started", limits = c(0,1095-320)) +
  ggtitle("HSM vaccination rates","Main text")+
  guides(shape = guide_legend(override.aes = list(size=0.8, alpha = 0.6)), 
         color = guide_legend(order = 1)) + 
    theme(axis.text = element_text(size = 14, color = "black"),
        axis.title = element_text(size = 14, color = "black"),
        axis.line = element_blank(),
        axis.ticks = element_line(color = "black"),
        plot.title = element_text(colour = "black", size = 15, face = "bold"),
        plot.subtitle = element_text(colour = "black", size = 13),
        plot.margin = unit(c(0, 0, 0, 0), "cm"),
        legend.position = "none",
        legend.title = element_text(size = 14, color = "black"),
        legend.text = element_text(size = 13, color = "black"),
        strip.text = element_text(colour = "black", size = 14, hjust = 0),
        strip.background = element_rect(colour="white", fill="white"),
        panel.border = element_rect(colour = "black", fill=NA),
        panel.spacing = unit(0.5, "cm"), aspect.ratio=1)
vax_trends_model

```

#### model vaccinated through end
```{r}

vax_trends_model_star <- read_csv("../Data/ABM Supplement/supp2-vaccine_star/dataAll.csv")%>% 
  left_join(pop_ABM) %>%
  group_by(ID_runs, time) %>% 
  filter(cum_sum_Inf == max(cum_sum_Inf)) %>%
  ungroup() %>%  
  filter(scenario == "no booster") %>%
  group_by(country, time) %>% 
    summarise(vaccinated = 100*mean(vaccinated_over_time/start_pop)) %>%
  ungroup() %>% 
  filter(time >= 320, time < 1095) %>% 
  mutate(time = time - 320) %>% 
  mutate(time = time) %>% 
  
  mutate(country = case_when(
    country == "Ecuador" ~ "Ecuador-like",
    country == "India" ~ "India-like",
    country == "Malaysia" ~ "Malaysia-like"
  )) %>%
  ggplot(aes(x = time, y = vaccinated, group = interaction(country))) + 
  geom_line(aes(color = country), size = 1) + 
    geom_vline(xintercept = 900-320, color="red", linetype="solid", size=1.3) +
  #facet_grid(~country)+ 
  theme_minimal() + 
  scale_color_manual("Country", values = c("#05878a", "#5a175d", "#dd9933")) + 
  scale_y_continuous("Vaccinated (%)", limits = c(0,100)) +
  scale_x_continuous("Days since vaccination started", limits = c(0,1095-320)) +
  ggtitle("HSM vaccination rates", "Continue through Omicron*")+
  guides(shape = guide_legend(override.aes = list(size=0.8, alpha = 0.6)), 
         color = guide_legend(order = 1)) + 
    theme(axis.text = element_text(size = 14, color = "black"),
        axis.title = element_text(size = 14, color = "black"),
        axis.line = element_blank(),
        axis.ticks = element_line(color = "black"),
        plot.title = element_text(colour = "black", size = 15, face = "bold"),
        plot.subtitle = element_text(colour = "black", size = 13),
        plot.margin = unit(c(0, 0, 0, 0), "cm"),
        legend.position = "none",
        legend.title = element_text(size = 14, color = "black"),
        legend.text = element_text(size = 13, color = "black"),
        strip.text = element_text(colour = "black", size = 14, hjust = 0),
        strip.background = element_rect(colour="white", fill="white"),
        panel.border = element_rect(colour = "black", fill=NA),
        panel.spacing = unit(0.5, "cm"), aspect.ratio=1)
vax_trends_model_star

```


#### Model boosting - main text
```{r}
boost_trends_model <- read_csv("../Data/ABM Main Runs/dataAll.csv")%>% 
  left_join(pop_ABM) %>%
  group_by(ID_runs, time) %>% 
  filter(cum_sum_Inf == max(cum_sum_Inf)) %>%
  ungroup()  %>% 
  filter(SAR == 1.3*0.427, scenario == "penalty", boost_shape == "functional") %>% 
  group_by(country, SAR, scenario, booster, boost, time) %>% 
  summarise(boosted = 100*mean(boosted_over_time/(vaccinated_over_time))) %>% 
  ungroup() %>% 
  filter(time >= 840) %>% 
  mutate(time = time - 840) %>% 
  
  mutate(country = case_when(
    country == "Ecuador" ~ "Ecuador-like",
    country == "India" ~ "India-like",
    country == "Malaysia" ~ "Malaysia-like"
  )) %>%
  ggplot(aes(x = time, y = boosted, group = interaction(country, scenario,boost, booster))) + 
  geom_line(aes(color = country), size = 1) + 
  #facet_grid(~country)+ 
  theme_minimal() + 
      geom_vline(xintercept = 900-840, color="red", linetype="solid", size=1.3) +
  scale_color_manual("Country", values = c("#05878a", "#5a175d", "#dd9933")) + 
  scale_y_continuous("Boosted (% of vaccinated)", limits = c(0,100)) +
  scale_x_continuous("Days since boosting started") +
  ggtitle("HSM boosting","Main text") +
  guides(shape = guide_legend(override.aes = list(size=0.8, alpha = 0.6)), 
         color = guide_legend(order = 1)) + 
    theme(axis.text = element_text(size = 14, color = "black"),
        axis.title = element_text(size = 14, color = "black"),
        axis.line = element_blank(),
        axis.ticks = element_line(color = "black"),
        plot.title = element_text(colour = "black", size = 15, face = "bold"),
        plot.subtitle = element_text(colour = "black", size = 13),
        plot.margin = unit(c(0, 0, 0, 0), "cm"),
        legend.position = "none",
        legend.title = element_text(size = 14, color = "black"),
        legend.text = element_text(size = 13, color = "black"),
        strip.text = element_text(colour = "black", size = 14, hjust = 0),
        strip.background = element_rect(colour="white", fill="white"),
        panel.border = element_rect(colour = "black", fill=NA),
        panel.spacing = unit(0.5, "cm"), aspect.ratio=1)
boost_trends_model

```

#### Model boosting - conservative
```{r}
boost_trends_model_conservative <- read_csv("../Data/ABM Supplement/supp1-slow_rollout/dataAll.csv")%>% 
  left_join(pop_ABM) %>% 
  group_by(ID_runs, time) %>% 
  filter(cum_sum_Inf == max(cum_sum_Inf)) %>%
  ungroup()  %>% 
  filter(SAR == 1.3*0.427, scenario == "penalty", boost_shape == "functional") %>% 
  group_by(country, SAR, scenario, booster, boost, time) %>% 
  summarise(boosted = 100*mean(boosted_over_time/(vaccinated_over_time))) %>% 
  ungroup() %>% 
  filter(time >= 840) %>% 
  mutate(time = time - 840) %>% 
  
  mutate(country = case_when(
    country == "Ecuador" ~ "Ecuador-like",
    country == "India" ~ "India-like",
    country == "Malaysia" ~ "Malaysia-like"
  )) %>%
  ggplot(aes(x = time, y = boosted, group = interaction(country, scenario,boost, booster))) + 
  geom_line(aes(color = country), size = 1) + 
  #facet_grid(~country)+ 
  theme_minimal() + 
      geom_vline(xintercept = 900-840, color="red", linetype="solid", size=1.3) +
  scale_color_manual("Country", values = c("#05878a", "#5a175d", "#dd9933")) + 
  scale_y_continuous("Boosted (% of vaccinated)", limits = c(0,100)) +
  scale_x_continuous("Days since boosting started") +
  ggtitle("HSM boosting", "Conservative rollout speed") +
  guides(shape = guide_legend(override.aes = list(size=0.8, alpha = 0.6)), 
         color = guide_legend(order = 1)) + 
    theme(axis.text = element_text(size = 14, color = "black"),
        axis.title = element_text(size = 14, color = "black"),
        axis.line = element_blank(),
        axis.ticks = element_line(color = "black"),
        plot.title = element_text(colour = "black", size = 15, face = "bold"),
        plot.subtitle = element_text(colour = "black", size = 13),
        plot.margin = unit(c(0, 0, 0, 0), "cm"),
        legend.position = "right",
        legend.title = element_text(size = 14, color = "black"),
        legend.text = element_text(size = 13, color = "black"),
        strip.text = element_text(colour = "black", size = 14, hjust = 0),
        strip.background = element_rect(colour="white", fill="white"),
        panel.border = element_rect(colour = "black", fill=NA),
        panel.spacing = unit(0.5, "cm"), aspect.ratio=1)
boost_trends_model_conservative

```

#### Save
```{r}


bottom <- plot_grid(vax_trends_model, vax_trends_model_star, boost_trends_model, boost_trends_model_conservative, labels = c("B", "C", "D", "E"), nrow = 1, rel_widths = c(1,1,1,1.5))

S9 <- plot_grid(vax_fit,bottom, labels = c("A",""), nrow = 2, rel_heights = c(1,1))

ggsave("../Supplement/S9_vaccine_booster_curves.pdf", S9, height = 8, width = 15)
ggsave("../Supplement/S9_vaccine_booster_curves.png", S9, height = 8, width = 15)

```


## ODE

### read data
```{r}
df_AvertedODE <- read_csv("../Data/ODE Supplement/df_AvertedODE_total.csv")
fast <- read_csv("../Data/ODE Supplement/fast_total.csv")
model_out_dat_total <- read_csv("../Data/ODE Supplement/model_out_data_total.csv")

start_sims <- as.Date("2020-03-15", "%Y-%m-%d") 

```


#### S10 - booster start time
```{r}

mycolors <- rev(c("#BD451D","#428740"))

plot_S10 <- df_AvertedODE %>%
  mutate(relativeFOI = case_when(
    relax == 0 ~ "100% infectiousness",
    relax == 0.1 ~ "110% infectiousness",
    relax == 0.3 ~ "130% infectiousness"
  )) %>%
  mutate(boost.speed = case_when(
    boost.speed == "fast" ~ "Main text\n boosting",
    boost.speed == "slow" ~ "Conservative\n boosting"
  )) %>%
  filter(relativeFOI != "100% infectiousness") %>%
  mutate(deathsaverted_per100k = DeathsComp_per100k-deaths_100k) %>%
  mutate(deathsaverted_per10k = deathsaverted_per100k/10) %>%
  mutate(country = case_when(
    country == "Ecuador" ~ "Ecuador-like",
    country == "India" ~ "India-like",
    country == "Malaysia" ~ "Malaysia-like"
  )) %>%
  ggplot(aes(x=boost.speed, y=deathsaverted_per10k, fill=Booster))+
  geom_point(aes(color=Booster, shape = boost.start.time), size = 2)+
  facet_grid(relativeFOI~country)+
  labs(x='Boosting speed', y='Deaths averted per 10k')+
  scale_color_manual(values = mycolors) +
  scale_shape_manual("Booster start time", values =c(16,17)) +
  theme_bw() +
  ggtitle("Hybrid immunity model", "Booster timing") +
    theme(axis.text = element_text(size = 11, color = "black"), #  angle = 90
        axis.title.x = element_text(size = 12, color = "black",vjust = -1),
        axis.title.y = element_text(size = 12, color = "black",vjust = +3),
        axis.line = element_line(color = "black"),
        axis.ticks = element_line(color = "black"),
        plot.title = element_text(colour = "black", size = 13.5, face = "bold"),
        plot.subtitle = element_text(colour = "black", size = 12.5),
        plot.margin = unit(c(t=0.2, r=1.5, b=0.5, l=1.5), "cm"),
        legend.position = "right", plot.title.position = "plot",
        strip.text = element_text(colour = "black", size = 11, hjust = 0),
        strip.background = element_rect(colour="white", fill="white"),
        legend.key.height= unit(0.4, 'cm'),
        legend.key.width= unit(0.4, 'cm'),
        legend.title = element_text(size = 11, color = "black"),
        legend.text = element_text(size = 10, color = "black"),
        panel.spacing = unit(0.5, "cm") , aspect.ratio=0.6)
plot_S10

ggsave("../Supplement/S10_Booster_start.pdf", plot_S10,width = 12, height = 4)
```



#### S11 - deaths averted per 10k
```{r}
#colors <- c("#0D3660","#BD451D","#428740")
mycolors <- rev(c("#BD451D","#428740"))

## what is the duplicated value??

plotS11 <- fast %>%
  mutate(relativeFOI = case_when(
    relax == 0 ~ "100% infectiousness",
    relax == 0.1 ~ "110% infectiousness",
    relax == 0.3 ~ "130% infectiousness"
  )) %>%
  filter(relativeFOI != "100% infectiousness") %>%
  mutate(deathsaverted_10k = deathsaverted_per100k/10) %>%
    mutate(boost.speed = case_when(
    boost.speed == "fast" ~ "Main text\n boosting",
    boost.speed == "slow" ~ "Conservative\n boosting"
  )) %>%
  mutate(country = case_when(
    country == "Ecuador" ~ "Ecuador-like",
    country == "India" ~ "India-like",
    country == "Malaysia" ~ "Malaysia-like"
  )) %>%
  ggplot(aes(x=relativeFOI, y=deathsaverted_10k, fill=Booster))+
  geom_bar(stat='identity', position=position_dodge(), alpha=0.8, size = 0.6, width = 0.6)+
  labs(x='Force of infection relative to Omicron', y='Deaths averted per 10k')+
  theme_bw()+
    ggtitle("Hybrid immunity model", "Deaths averted per 10k") +
    facet_grid(boost.speed~country)+
  scale_color_manual("Booster", values = mycolors) +
  scale_fill_manual("Booster",values = mycolors) + 
    theme(axis.text = element_text(size = 11, color = "black"), #  angle = 90
        axis.title.x = element_text(size = 12, color = "black",vjust = -1),
        axis.title.y = element_text(size = 12, color = "black",vjust = +3),
        axis.line = element_line(color = "black"),
        axis.ticks = element_line(color = "black"),
        plot.title = element_text(colour = "black", size = 13.5, face = "bold"),
        plot.subtitle = element_text(colour = "black", size = 12.5),
        plot.margin = unit(c(t=0.2, r=1.5, b=0.5, l=1.5), "cm"),
        legend.position = "top", plot.title.position = "plot",
        strip.text = element_text(colour = "black", size = 11, hjust = 0),
        strip.background = element_rect(colour="white", fill="white"),
        legend.key.height= unit(0.4, 'cm'),
        legend.key.width= unit(0.4, 'cm'),
        legend.title = element_text(size = 11, color = "black"),
        legend.text = element_text(size = 10, color = "black"),
        legend.margin=margin(t=0.8,r=0.5,b=0.2,l=-4,unit = "line"),
        panel.spacing = unit(0.5, "cm") , aspect.ratio=0.8)
plotS11

ggsave("../Supplement/S11_da_per_10k.pdf", width = 12.5, height = 8)


```

#### S12 - cases, 60 days prior boosting
```{r}

mycolors <- rev(c("#0D3660","#BD451D","#428740"))

noboost_fast <- model_out_dat_total %>% 
  mutate(relativeFOI = case_when(
    relax == 0 ~ "100% infectiousness",
    relax == 0.1 ~ "110%",
    relax == 0.3 ~ "130%"
  )) %>%
  filter(relativeFOI != "100% infectiousness") %>%
  filter(Booster == "None") %>%
  mutate(boost.speed = case_when(
    boost.speed == "fast" ~ "Main text\nboosting",
    boost.speed == "slow" ~ "Conservative\nboosting"
  )) %>%
  mutate(I_10k = I_100k/10) %>% 
  mutate(boost.speed = "Main text\nboosting")

noboost_slow <- model_out_dat_total %>% 
  mutate(relativeFOI = case_when(
    relax == 0 ~ "100% infectiousness",
    relax == 0.1 ~ "110%",
    relax == 0.3 ~ "130%"
  )) %>%
  filter(relativeFOI != "100% infectiousness") %>%
  filter(Booster == "None") %>%
  mutate(boost.speed = case_when(
    boost.speed == "fast" ~ "Main text\nboosting",
    boost.speed == "slow" ~ "Conservative\nboosting"
  )) %>%
  mutate(I_10k = I_100k/10) %>% 
  mutate(boost.speed = "Conservative\nboosting")



S12 <- model_out_dat_total %>% 
  mutate(relativeFOI = case_when(
    relax == 0 ~ "100% infectiousness",
    relax == 0.1 ~ "110%",
    relax == 0.3 ~ "130%"
  )) %>%
  filter(relativeFOI != "100% infectiousness") %>%
  filter(boost.start == "60") %>%
  mutate(boost.speed = case_when(
    boost.speed == "fast" ~ "Main text\nboosting",
    boost.speed == "slow" ~ "Conservative\nboosting"
  )) %>%
  mutate(I_10k = I_100k/10) %>%
  rbind(noboost_slow) %>%
  rbind(noboost_fast) %>%
  mutate(time = start_sims + time + 900) %>%
  mutate(country = case_when(
    country == "Ecuador" ~ "Ecuador-like",
    country == "India" ~ "India-like",
    country == "Malaysia" ~ "Malaysia-like"
  )) %>%
  ggplot(aes(x=time, y=I_10k, group=sweepnum))+
  geom_line(aes(color=Booster, linetype=relativeFOI), size = 0.7)+
  facet_grid(boost.speed~country)+
  theme_bw()+
  scale_color_manual(values = mycolors)+#geom_line(data=model_out_noboost, aes(x=time, y=Iprop, group=sweepnum))+
  scale_linetype_manual("Infectiousness relative to Omicron",values = c("solid", "dashed")) +
  labs(y='Infections per 10k') + 
      scale_x_date("Date", expand = c(0,0), date_breaks = "1 month", date_labels =  "%b %Y") + 

  ggtitle("Hybrid immunity model", "Boost 60 days prior to Omicron*") +
    theme(axis.text = element_text(size = 11, color = "black"), #  angle = 90
        #axis.title.x = element_text(size = 12, color = "black",vjust = -1),
        axis.text.x=element_text(angle=60, hjust=1),
        axis.title.y = element_text(size = 12, color = "black",vjust = +3),
        axis.line = element_line(color = "black"),
        axis.ticks = element_line(color = "black"),
        plot.title = element_text(colour = "black", size = 13.5, face = "bold"),
        plot.subtitle = element_text(colour = "black", size = 12.5),
        plot.margin = unit(c(t=0.2, r=1.5, b=0.5, l=1.5), "cm"),
        legend.position = "right", plot.title.position = "plot",
        strip.text = element_text(colour = "black", size = 11, hjust = 0),
        strip.background = element_rect(colour="white", fill="white"),
        legend.key.height= unit(0.4, 'cm'),
        legend.key.width= unit(0.4, 'cm'),
        legend.title = element_text(size = 11, color = "black"),
        legend.text = element_text(size = 10, color = "black"),
        panel.spacing = unit(0.5, "cm") , aspect.ratio=0.5)
S12

ggsave("../Supplement/S12_cases_60daysprior.pdf", width = 12, height = 8)


```


#### S13 - cases, 0 days prior boosting
```{r}

mycolors <- rev(c("#0D3660","#BD451D","#428740"))


S13 <- model_out_dat_total %>% 
  mutate(relativeFOI = case_when(
    relax == 0 ~ "100% infectiousness",
    relax == 0.1 ~ "110%",
    relax == 0.3 ~ "130%"
  )) %>%
  filter(relativeFOI != "100% infectiousness") %>%
  filter(boost.start == "0") %>%
  mutate(boost.speed = case_when(
    boost.speed == "fast" ~ "Main text\nboosting",
    boost.speed == "slow" ~ "Conservative\nboosting"
  )) %>%
  mutate(I_10k = I_100k/10) %>%
  rbind(noboost_slow) %>%
  rbind(noboost_fast) %>%
  mutate(time = start_sims + time + 900) %>%
  mutate(country = case_when(
    country == "Ecuador" ~ "Ecuador-like",
    country == "India" ~ "India-like",
    country == "Malaysia" ~ "Malaysia-like"
  )) %>%
  ggplot(aes(x=time, y=I_10k, group=sweepnum))+
  geom_line(aes(color=Booster, linetype=relativeFOI), size = 0.7)+
  facet_grid(boost.speed~country, scales = "free")+
  theme_bw()+
  scale_color_manual(values = mycolors)+#geom_line(data=model_out_noboost, aes(x=time, y=Iprop, group=sweepnum))+
  scale_linetype_manual("Infectiousness relative to Omicron",values = c("solid", "dashed")) +
  labs(y='Infections per 10k') + 
      scale_x_date("Date", expand = c(0,0), date_breaks = "1 month", date_labels =  "%b %Y") + 
  ggtitle("Hybrid immunity model", "Boost 0 days prior to Omicron*") +
    theme(axis.text = element_text(size = 11, color = "black"), #  angle = 90
        #axis.title.x = element_text(size = 12, color = "black",vjust = -1),
        axis.text.x=element_text(angle=60, hjust=1),
        axis.title.y = element_text(size = 12, color = "black",vjust = +3),
        axis.line = element_line(color = "black"),
        axis.ticks = element_line(color = "black"),
        plot.title = element_text(colour = "black", size = 13.5, face = "bold"),
        plot.subtitle = element_text(colour = "black", size = 12.5),
        plot.margin = unit(c(t=0.2, r=1.5, b=0.5, l=1.5), "cm"),
        legend.position = "right", plot.title.position = "plot",
        strip.text = element_text(colour = "black", size = 11, hjust = 0),
        strip.background = element_rect(colour="white", fill="white"),
        legend.key.height= unit(0.4, 'cm'),
        legend.key.width= unit(0.4, 'cm'),
        legend.title = element_text(size = 11, color = "black"),
        legend.text = element_text(size = 10, color = "black"),
        panel.spacing = unit(0.5, "cm") , aspect.ratio=0.5)
S13

ggsave("../Supplement/S13_cases_0daysprior.pdf", width = 12, height = 8)


```


#### S14 - boosting,  0 days prior
```{r}
S14 <- model_out_dat_total %>%
  mutate(relativeFOI = case_when(
    relax == 0 ~ "100% infectiousness",
    relax == 0.1 ~ "110% infectiousness",
    relax == 0.3 ~ "130% infectiousness"
  )) %>%
  filter(relativeFOI == "130% infectiousness") %>%
  filter(boost.start == "0") %>%
  mutate(Speed = case_when(
    boost.speed == "fast" ~ "Main text\nboosting",
    boost.speed == "slow" ~ "Conservative\nboosting"
  )) %>%
  filter(Booster == "Bivalent") %>%
  mutate(country = case_when(
    country == "Ecuador" ~ "Ecuador-like",
    country == "India" ~ "India-like",
    country == "Malaysia" ~ "Malaysia-like"
  )) %>%
  select(time, pboost.coverage_of_vaccinated, sweepnum, Speed, country) %>%
  ggplot(aes(x=time, y=100*pboost.coverage_of_vaccinated, group=country))+
  geom_line(aes(color=country,), size = 0.7)+
  facet_wrap(~Speed)+
  theme_bw()+
        geom_vline(xintercept = 0, color="red", linetype="solid", size=1.3) +
scale_color_manual("Country", values = c("#05878a", "#5a175d", "#dd9933")) + 
  scale_y_continuous("Boosted (% of vaccinated)", limits = c(0,100)) +
  scale_x_continuous("Days since boosting started", limits = c(0,260)) +
  ggtitle("Hybrid immunity model", "Boosting 0 days before Omicron*")+
      theme(axis.text = element_text(size = 11, color = "black"), #  angle = 90
        axis.title.x = element_text(size = 12, color = "black",vjust = -1),
        axis.title.y = element_text(size = 12, color = "black",vjust = +3),
        axis.line = element_line(color = "black"),
        axis.ticks = element_line(color = "black"),
        plot.title = element_text(colour = "black", size = 13.5, face = "bold"),
        plot.subtitle = element_text(colour = "black", size = 12.5),
        plot.margin = unit(c(t=0.2, r=1.5, b=0.5, l=1.5), "cm"),
        legend.position = "right", plot.title.position = "plot",
        strip.text = element_text(colour = "black", size = 11, hjust = 0),
        strip.background = element_rect(colour="white", fill="white"),
        legend.key.height= unit(0.4, 'cm'),
        legend.key.width= unit(0.4, 'cm'),
        legend.title = element_text(size = 11, color = "black"),
        legend.text = element_text(size = 10, color = "black"),
        panel.spacing = unit(0.5, "cm") , aspect.ratio=1)
S14

ggsave("../Supplement/S14_boostercurve_0daysprior.pdf", width = 6, height = 3)

```

#### S15 - boosting, 60 days prior
```{r}

S15 <- model_out_dat_total %>%
  mutate(relativeFOI = case_when(
    relax == 0 ~ "100% infectiousness",
    relax == 0.1 ~ "110% infectiousness",
    relax == 0.3 ~ "130% infectiousness"
  )) %>%
  filter(relativeFOI == "130% infectiousness") %>%
  filter(boost.start == "60") %>%
  mutate(Speed = case_when(
    boost.speed == "fast" ~ "Main text\nboosting",
    boost.speed == "slow" ~ "Conservative\nboosting"
  )) %>%
  filter(Booster == "Bivalent") %>%
  mutate(time = time + 60) %>%
  select(time, pboost.coverage_of_vaccinated, sweepnum, Speed, country) %>%
  mutate(country = case_when(
    country == "Ecuador" ~ "Ecuador-like",
    country == "India" ~ "India-like",
    country == "Malaysia" ~ "Malaysia-like"
  )) %>%
  ggplot(aes(x=time, y=100*pboost.coverage_of_vaccinated, group=country))+
  geom_line(aes(color=country,), size = 0.7)+
  facet_wrap(~Speed)+
        geom_vline(xintercept = 900-840, color="red", linetype="solid", size=1.3) +
  theme_bw()+
scale_color_manual("Country", values = c("#05878a", "#5a175d", "#dd9933")) + 
  scale_y_continuous("Boosted (% of vaccinated)", limits = c(0,100)) +
  scale_x_continuous("Days since boosting started", limits = c(0,260)) +  ggtitle("Hybrid immunity model", "Boosting 60 days before Omicron*")+
      theme(axis.text = element_text(size = 11, color = "black"), #  angle = 90
        axis.title.x = element_text(size = 12, color = "black",vjust = -1),
        axis.title.y = element_text(size = 12, color = "black",vjust = +3),
        axis.line = element_line(color = "black"),
        axis.ticks = element_line(color = "black"),
        plot.title = element_text(colour = "black", size = 13.5, face = "bold"),
        plot.subtitle = element_text(colour = "black", size = 12.5),
        plot.margin = unit(c(t=0.2, r=1.5, b=0.5, l=1.5), "cm"),
        legend.position = "right", plot.title.position = "plot",
        strip.text = element_text(colour = "black", size = 11, hjust = 0),
        strip.background = element_rect(colour="white", fill="white"),
        legend.key.height= unit(0.4, 'cm'),
        legend.key.width= unit(0.4, 'cm'),
        legend.title = element_text(size = 11, color = "black"),
        legend.text = element_text(size = 10, color = "black"),
        panel.spacing = unit(0.5, "cm") , aspect.ratio=1)
S15

ggsave("../Supplement/S15_boostercurve_60daysprior.pdf", width = 6, height = 3)

```



### load data
```{r}

Ec_ts <- read_csv("../Data/ODE Main Runs/Ecuador_ts.csv") %>%
  mutate(country = "Ecuador") %>%
  rename(sd = sd0)
Ma_ts <- read_csv("../Data/ODE Main Runs/Malaysia_ts.csv") %>% 
  mutate(country = "Malaysia")
In_ts <- read_csv("../Data/ODE Main Runs/India_ts.csv") %>% 
  mutate(country = "India")

ODE_ts <- rbind(Ec_ts, Ma_ts) %>% rbind(In_ts)

Ec_grid <- read_csv("../Data/ODE Main Runs/Ecuador_grid_da.csv")
Ma_grid <- read_csv("../Data/ODE Main Runs/Malaysia_grid_da.csv")
In_grid <- read_csv("../Data/ODE Main Runs/India_grid_da.csv")
```

#### S31 - difference in deaths
```{r}
#mycolors<-colorRampPalette(c("#d35c79", "#d69481","#c9b1cf","#bccab4", "#7aaf97","#009593"))(21)[-c(1,2,3,4,5,6,7,8,11)]

# mycolors<-(colorRampPalette(rev(c("#009b9f", "#43b7b9","#a7d3d5", "#e4c1d8","#d691c1","#c75daa"))))(21)[-c(1,2,3,4,5,6,7,8,11)]

#mycolors <- c("#DADAEB", "#E0F3F8","#ABD9E9","#74ADD1","#4575B4","#313695")

#mycolors <- rev(c("#8c96c6","#DADAEB","#b3cde0","#6497b1","#005b96","#03396c","#011f4b","#011128"))

mycolors <- pnw_palette(name="Lake",n=10,type="continuous")

dataPlaces <- ODE_ts %>% 
  select(cp, base.imm, country) %>% 
  mutate(cp = as.numeric(cp), base.imm = as.numeric(base.imm)) %>%
  distinct() %>% 
  filter(country == "Ecuador")

## get grid calculations
dat4E_diff <- Ec_grid %>% 
  mutate(base.imm = as.numeric(base.imm), cp= as.numeric(cp))%>%
  mutate(relax = case_when(relax == 0.1 ~ "Infectiousness 110%",
                           relax == 0.3 ~ "Infectiousness 130%")) %>%
  mutate(deaths_10k_comp = deaths_100k_comp/10,
         deaths_10k = deaths_100k/10,
         da10k = pmax(0,deaths_10k_comp-deaths_10k)) %>%
  select(base.imm, cp, relax,Booster, da10k) %>%
  pivot_wider(values_from = da10k, names_from = Booster) %>% 
  filter(base.imm <= 0.9) %>%
  mutate(comp10k = Bivalent-Monovalent, gain = round(Bivalent/Monovalent,2))

plot4E_diff <- dat4E_diff %>% 
    filter(base.imm <= 0.9) %>%
  ggplot(aes(x = base.imm, y = cp)) + 
  geom_tile(aes(fill = comp10k)) + facet_wrap(~relax, ncol = 1) + theme_classic() +
# scale_fill_stepsn("Relative benefit\nof bivalent",colours = mycolors, 
#                     breaks = seq(-0.45,2.25,0.45), 
#                     limits=c(-.45,2.25),
#                     labels =c(-0.45,0,0.45,0.9,1.35,1.8,2.25),
#                     guide = "colorbar") +
  scale_fill_stepsn("Bivalent -\n monovalent",colours = rev(mycolors), 
                    breaks = seq(0,2.8,0.2), 
                    limits=c(0,2.8),
                    labels =c(0,"",0.4,"",0.8,"",1.2,"",1.6,"",2.0,"",2.4,"",2.8),
                    guide = "colorbar") +
  geom_point(data = dataPlaces, color= "black", fill = "black", size = 2) +
  # geom_text_repel(data = dataPlaces, color= "black", fill = "white", size = 2, aes(label = country)) +
  guides(fill = guide_colourbar(title.position="top", title.hjust = 0.5)) + 
  scale_y_continuous("Cross protection",labels = 
          scales::percent_format(accuracy = 1), 
          breaks = c(0,0.3,0.6,0.9), expand = c(0,0)) +
  scale_x_continuous("Prior infection",labels = 
          scales::percent_format(accuracy = 1), 
          breaks = c(0,0.3,0.6,0.9), expand = c(0,0)) +
  ggtitle("Difference in deaths averted","         Ecuador-like") +
    theme(axis.text = element_text(size = 11, color = "black"),
        axis.title = element_text(size = 12, color = "black"),
        axis.line = element_blank(),
        axis.ticks = element_line(color = "black"),
        plot.title = element_text(colour = "black", size = 13.5, face = "bold"),
        plot.subtitle = element_text(colour = "black", size = 12.5),
        plot.margin = unit(c(t=0.2, r=0.2, b=0.2, l=0.2), "cm"),
        legend.key.width= unit(0.95, 'cm'),
        legend.position = "none",
        #legend.position = "bottom", 
        plot.title.position = "plot",
        legend.title = element_text(size = 11, color = "black"),
        legend.text = element_text(size = 10, color = "black"),
        strip.text.x = element_text(colour = "black", size = 11, hjust = 0),
        strip.text.y = element_text(colour = "black", size = 10, hjust = 0),
        strip.background = element_rect(colour="white", fill="white"),
        panel.border = element_rect(colour = "black", fill=NA),
        panel.spacing = unit(0.3, "cm"), aspect.ratio=1)
plot4E_diff
```

```{r}

dataPlaces <- ODE_ts %>% 
  select(cp, base.imm, country) %>% 
  mutate(cp = as.numeric(cp), base.imm = as.numeric(base.imm)) %>%
  distinct() %>% 
  filter(country == "India")

## get grid calculations
dat4I_diff <- In_grid %>% 
  mutate(base.imm = as.numeric(base.imm), cp= as.numeric(cp))%>%
  mutate(relax = case_when(relax == 0.1 ~ "Infectiousness 110%",
                           relax == 0.3 ~ "Infectiousness 130%")) %>%
  mutate(deaths_10k_comp = deaths_100k_comp/10,
         deaths_10k = deaths_100k/10,
         da10k = pmax(0,deaths_10k_comp -deaths_10k)) %>%
  select(base.imm, cp, relax,Booster, da10k) %>%
  pivot_wider(values_from = da10k, names_from = Booster) %>% 
  filter(base.imm <= 0.9) %>%
  mutate(comp10k = Bivalent-Monovalent, gain = round(Bivalent/Monovalent,2))

plot4I_diff <- dat4I_diff %>% 
    filter(base.imm <= 0.9) %>%
  ggplot(aes(x = base.imm, y = cp)) + 
  geom_tile(aes(fill = comp10k)) + facet_wrap(~relax, ncol = 1) + theme_classic() +
# scale_fill_stepsn("Relative benefit\nof bivalent",colours = mycolors, 
#                     breaks = seq(-0.45,2.25,0.45), 
#                     limits=c(-.45,2.25),
#                     labels =c(-0.45,0,0.45,0.9,1.35,1.8,2.25),
#                     guide = "colorbar") +
  scale_fill_stepsn("Bivalent -\n monovalent",colours = rev(mycolors), 
                    breaks = seq(0,2.8,0.2), 
                    limits=c(0,2.8),
                    labels =c(0,"",0.4,"",0.8,"",1.2,"",1.6,"",2.0,"",2.4,"",2.8),
                    guide = "colorbar") +
  geom_point(data = dataPlaces, color= "black", fill = "black", size = 2) +
  # geom_text_repel(data = dataPlaces, color= "black", fill = "white", size = 2, aes(label = country)) +
  guides(fill = guide_colourbar(title.position="top", title.hjust = 0.5)) + 
  scale_y_continuous("Cross protection",labels = 
          scales::percent_format(accuracy = 1), 
          breaks = c(0,0.3,0.6,0.9), expand = c(0,0)) +
  scale_x_continuous("Prior infection",labels = 
          scales::percent_format(accuracy = 1), 
          breaks = c(0,0.3,0.6,0.9), expand = c(0,0)) +
  ggtitle("","         India-like") +
    theme(axis.text = element_text(size = 11, color = "black"),
        axis.title = element_text(size = 12, color = "black"),
        axis.line = element_blank(),
        axis.ticks = element_line(color = "black"),
        plot.title = element_text(colour = "black", size = 13.5, face = "bold"),
        plot.subtitle = element_text(colour = "black", size = 12.5),
        plot.margin = unit(c(t=0.2, r=0.2, b=0.2, l=0.2), "cm"),
        legend.key.width= unit(0.95, 'cm'),
        legend.position = "none",
        #legend.position = "bottom", 
        plot.title.position = "plot",
        legend.title = element_text(size = 11, color = "black"),
        legend.text = element_text(size = 10, color = "black"),
        strip.text.x = element_text(colour = "black", size = 11, hjust = 0),
        strip.text.y = element_text(colour = "black", size = 10, hjust = 0),
        strip.background = element_rect(colour="white", fill="white"),
        panel.border = element_rect(colour = "black", fill=NA),
        panel.spacing = unit(0.3, "cm"), aspect.ratio=1)
plot4I_diff


```

```{r}

#colours = c("#d35c79", "#d69481","#dec0a3","#bccab4", "#7aaf97","#009593")

#mycolors <- colorRampPalette(brewer.pal(6, "Blues"))(nb.cols)

dataPlaces <- ODE_ts %>% 
  select(cp, base.imm, country) %>% 
  mutate(cp = as.numeric(cp), base.imm = as.numeric(base.imm)) %>%
  distinct() %>%
  filter(country == "Malaysia")

## get grid calculations
dat4M_diff <- Ma_grid %>% 
  mutate(base.imm = as.numeric(base.imm), cp= as.numeric(cp))%>%
  mutate(relax = case_when(relax == 0.1 ~ "Infectiousness 110%",
                           relax == 0.3 ~ "Infectiousness 130%")) %>%
  mutate(deaths_10k_comp = deaths_100k_comp/10,
         deaths_10k = deaths_100k/10,
         da10k = pmax(0,deaths_10k_comp -deaths_10k)) %>%
  select(base.imm, cp, relax,Booster, da10k) %>%
  pivot_wider(values_from = da10k, names_from = Booster) %>% 
    filter(base.imm <= 0.9) %>%
  mutate(comp10k = Bivalent-Monovalent, gain = round(Bivalent/Monovalent,2))

plot4M_diff <- dat4M_diff %>% 
  filter(base.imm <= 0.9) %>%
  ggplot(aes(x = base.imm, y = cp)) + 
  geom_tile(aes(fill = comp10k)) + facet_wrap(~relax, ncol = 1) + theme_classic() +
# scale_fill_stepsn("Relative benefit\nof bivalent",colours = mycolors, 
#                     breaks = seq(-0.45,2.25,0.45), 
#                     limits=c(-.45,2.25),
#                     #labels =c(-0.45,"",0,"",0.45,"",0.9,"",1.35,"",1.8,"",2.25),
#                     guide = "colorbar") +
  scale_fill_stepsn("Bivalent -\n monovalent",colours = rev(mycolors), 
                    breaks = seq(0,2.8,0.2), 
                    limits=c(0,2.8),
                    labels =c(0,"",0.4,"",0.8,"",1.2,"",1.6,"",2.0,"",2.4,"",2.8),
                    guide = "colorbar") +
  geom_point(data = dataPlaces, color= "black", fill = "black", size = 2) +
  # geom_text_repel(data = dataPlaces, color= "black", fill = "white", size = 2, aes(label = country)) +
  guides(fill = guide_colourbar(title.position="top", title.hjust = 0.5)) + 
  scale_y_continuous("Cross protection",labels = 
          scales::percent_format(accuracy = 1), 
          breaks = c(0,0.3,0.6,0.9), expand = c(0,0)) +
  scale_x_continuous("Prior infection",labels = 
          scales::percent_format(accuracy = 1), 
          breaks = c(0,0.3,0.6,0.9), expand = c(0,0)) +
  ggtitle("","         Malaysia-like") +
    theme(axis.text = element_text(size = 11, color = "black"),
        axis.title = element_text(size = 12, color = "black"),
        axis.line = element_blank(),
        axis.ticks = element_line(color = "black"),
        plot.title = element_text(colour = "black", size = 13.5, face = "bold"),
        plot.subtitle = element_text(colour = "black", size = 12.5),
        plot.margin = unit(c(t=0.2, r=0.2, b=0.2, l=0.2), "cm"),
        legend.key.height= unit(1.2, 'cm'),
        legend.position = "right",
        #legend.position = "bottom", 
        plot.title.position = "plot",
        legend.title = element_text(size = 11, color = "black"),
        legend.text = element_text(size = 10, color = "black"),
        strip.text.x = element_text(colour = "black", size = 11, hjust = 0),
        strip.text.y = element_text(colour = "black", size = 10, hjust = 0),
        strip.background = element_rect(colour="white", fill="white"),
        panel.border = element_rect(colour = "black", fill=NA),
        panel.spacing = unit(0.3, "cm"), aspect.ratio=1)
plot4M_diff


```

```{r}
show_diff <- plot_grid(plot4E_diff,plot4I_diff,plot4M_diff, nrow = 1, rel_widths = c(1,1,1.8))
ggsave("../Supplement/S31_death_diff.pdf", show_diff, height = 6, width = 11)
```

#### S17 - deaths per 10k grid
```{r}

mycolors <- rev(pnw_palette("Moth", n = 11))

dataPlaces <- ODE_ts %>% 
  select(cp, base.imm, country) %>% 
  mutate(cp = as.numeric(cp), base.imm = as.numeric(base.imm)) %>%
  distinct() %>% 
  filter(country == "Ecuador")

Ec_grid_noboost <- Ec_grid %>% 
  filter(Booster == "Bivalent") %>% ## just grab one set of runs
  mutate(base.imm = as.numeric(base.imm), cp= as.numeric(cp))%>%
  mutate(relax = case_when(relax == 0.1 ~ "110% Infectiousness",
                           relax == 0.3 ~ "130% Infectiousness")) %>%
  mutate(deaths_10k = deaths_100k_comp/10) %>%
  mutate(Booster = "No booster") %>% 
  select(base.imm, cp, relax, deaths_10k, Booster)


plot17E <- Ec_grid  %>% 
  mutate(base.imm = as.numeric(base.imm), cp= as.numeric(cp))%>%
  mutate(relax = case_when(relax == 0.1 ~ "110% Infectiousness",
                           relax == 0.3 ~ "130% Infectiousness")) %>%
  mutate(deaths_10k = deaths_100k/10)  %>% 
  select(base.imm, cp, relax, deaths_10k, Booster) %>%
  rbind(Ec_grid_noboost) %>%
      filter(base.imm <= 0.9) %>%
  ggplot(aes(x = base.imm, y = cp)) + 
  geom_tile(aes(fill = deaths_10k)) + facet_grid(Booster~relax) + 
  geom_point(data = dataPlaces, color= "black", fill = "black", size = 2) +
  #geom_text_repel(data = dataPlaces, color= "black", fill = "white", size = 2, aes(label = country)) +
  theme_classic() +
  scale_fill_stepsn("Deaths per 10,000",colors=mycolors,
                    breaks = seq(0,11,1), limits=c(0,11),
                    labels =c(0,"", 2, "", 4, "", 6, "", 8, "", 10,"")) +
  # scale_fill_stepsn("Deaths averted per 10,000",colors=mycolors, 
  #                   breaks = seq(0,1.6,0.1), limits=c(0,1.6),
  #                   labels =c(0,"",0.2,"",0.4,"",0.6,"",0.8,
  #                             "",1.0,"",1.2,"",1.4,"",1.6)) + 
  theme_classic() +
  guides(fill = guide_colourbar(title.position="top", title.hjust = 0.5)) + 
  scale_y_continuous("Cross protection",labels = 
          scales::percent_format(accuracy = 1), 
          breaks = c(0,0.3,0.6,0.9), expand = c(0,0)) +
  scale_x_continuous("Prior infection",labels = 
          scales::percent_format(accuracy = 1), 
          breaks = c(0,0.3,0.6,0.9), expand = c(0,0)) +
  ggtitle("Deaths per 10,000 - Hybrid immunity model","         Ecuador-like") +
    theme(axis.text = element_text(size = 11, color = "black"),
        axis.title = element_text(size = 12, color = "black"),
        axis.line = element_blank(),
        axis.ticks = element_line(color = "black"),
        plot.title = element_text(colour = "black", size = 13.5, face = "bold"),
        plot.subtitle = element_text(colour = "black", size = 12.5),
        plot.margin = unit(c(t=0.2, r=0.2, b=0.2, l=0.2), "cm"),
        legend.key.width= unit(1.2, 'cm'),
        legend.position = "none", 
        plot.title.position = "plot",
        legend.title = element_text(size = 11, color = "black"),
        legend.text = element_text(size = 9, color = "black"),
        strip.text.x = element_text(colour = "black", size = 11, hjust = 0),
        strip.text.y = element_text(colour = "black", size = 10, hjust = 0),
        strip.background = element_rect(colour="white", fill="white"),
        panel.border = element_rect(colour = "black", fill=NA),
        panel.spacing = unit(0.3, "cm"), aspect.ratio=1)
plot17E
```




```{r}

dataPlaces <- ODE_ts %>% 
  select(cp, base.imm, country) %>% 
  mutate(cp = as.numeric(cp), base.imm = as.numeric(base.imm)) %>%
  distinct() %>% 
  filter(country == "India")

In_grid_noboost <- In_grid %>% 
  filter(Booster == "Bivalent") %>% ## just grab one set of runs
  mutate(base.imm = as.numeric(base.imm), cp= as.numeric(cp))%>%
  mutate(relax = case_when(relax == 0.1 ~ "110% Infectiousness",
                           relax == 0.3 ~ "130% Infectiousness")) %>%
  mutate(deaths_10k = deaths_100k_comp/10) %>%
  mutate(Booster = "No booster") %>% 
  select(base.imm, cp, relax, deaths_10k, Booster)


plot17I <- In_grid  %>% 
  mutate(base.imm = as.numeric(base.imm), cp= as.numeric(cp))%>%
  mutate(relax = case_when(relax == 0.1 ~ "110% Infectiousness",
                           relax == 0.3 ~ "130% Infectiousness")) %>%
  mutate(deaths_10k = deaths_100k/10)  %>% 
  select(base.imm, cp, relax, deaths_10k, Booster) %>%
  rbind(In_grid_noboost) %>%
      filter(base.imm <= 0.9) %>%
  ggplot(aes(x = base.imm, y = cp)) + 
  geom_tile(aes(fill = deaths_10k)) + facet_grid(Booster~relax) + 
  geom_point(data = dataPlaces, color= "black", fill = "black", size = 2) +
  #geom_text_repel(data = dataPlaces, color= "black", fill = "white", size = 2, aes(label = country)) +
  theme_classic() +
 scale_fill_stepsn("Deaths per 10,000",colors=mycolors,
                    breaks = seq(0,11,1), limits=c(0,11),
                    labels =c(0,"", 2, "", 4, "", 6, "", 8, "", 10,"")) +
  # scale_fill_stepsn("Deaths averted per 10,000",colors=mycolors, 
  #                   breaks = seq(0,1.6,0.1), limits=c(0,1.6),
  #                   labels =c(0,"",0.2,"",0.4,"",0.6,"",0.8,
  #                             "",1.0,"",1.2,"",1.4,"",1.6)) + 
  theme_classic() +
  guides(fill = guide_colourbar(title.position="top", title.hjust = 0.5)) + 
  scale_y_continuous("Cross protection",labels = 
          scales::percent_format(accuracy = 1), 
          breaks = c(0,0.3,0.6,0.9), expand = c(0,0)) +
  scale_x_continuous("Prior infection",labels = 
          scales::percent_format(accuracy = 1), 
          breaks = c(0,0.3,0.6,0.9), expand = c(0,0)) +
  ggtitle("","         India-like") +
    theme(axis.text = element_text(size = 11, color = "black"),
        axis.title = element_text(size = 12, color = "black"),
        axis.line = element_blank(),
        axis.ticks = element_line(color = "black"),
        plot.title = element_text(colour = "black", size = 13.5, face = "bold"),
        plot.subtitle = element_text(colour = "black", size = 12.5),
        plot.margin = unit(c(t=0.2, r=0.2, b=0.2, l=0.2), "cm"),
        legend.key.width= unit(1.2, 'cm'),
        legend.position = "none", 
        plot.title.position = "plot",
        legend.title = element_text(size = 11, color = "black"),
        legend.text = element_text(size = 9, color = "black"),
        strip.text.x = element_text(colour = "black", size = 11, hjust = 0),
        strip.text.y = element_text(colour = "black", size = 10, hjust = 0),
        strip.background = element_rect(colour="white", fill="white"),
        panel.border = element_rect(colour = "black", fill=NA),
        panel.spacing = unit(0.3, "cm"), aspect.ratio=1)
plot17I
```



```{r}

dataPlaces <- ODE_ts %>% 
  select(cp, base.imm, country) %>% 
  mutate(cp = as.numeric(cp), base.imm = as.numeric(base.imm)) %>%
  distinct() %>% 
  filter(country == "Malaysia")

Ma_grid_noboost <- Ma_grid %>% 
  filter(Booster == "Bivalent") %>% ## just grab one set of runs
  mutate(base.imm = as.numeric(base.imm), cp= as.numeric(cp))%>%
  mutate(relax = case_when(relax == 0.1 ~ "110% Infectiousness",
                           relax == 0.3 ~ "130% Infectiousness")) %>%
  mutate(deaths_10k = deaths_100k_comp/10) %>%
  mutate(Booster = "No booster") %>% 
  select(base.imm, cp, relax, deaths_10k, Booster)


plot17M <- Ma_grid  %>% 
  mutate(base.imm = as.numeric(base.imm), cp= as.numeric(cp))%>%
  mutate(relax = case_when(relax == 0.1 ~ "110% Infectiousness",
                           relax == 0.3 ~ "130% Infectiousness")) %>%
  mutate(deaths_10k = deaths_100k/10)  %>% 
  select(base.imm, cp, relax, deaths_10k, Booster) %>%
  rbind(Ma_grid_noboost) %>%
      filter(base.imm <= 0.9) %>%
  ggplot(aes(x = base.imm, y = cp)) + 
  geom_tile(aes(fill = deaths_10k)) + facet_grid(Booster~relax) +
  geom_point(data = dataPlaces, color= "black", fill = "black", size = 2) +
  #geom_text_repel(data = dataPlaces, color= "black", fill = "white", size = 2, aes(label = country)) +
  theme_classic() +
 scale_fill_stepsn("Deaths per 10,000",colors=mycolors,
                    breaks = seq(0,11,1), limits=c(0,11),
                    labels =c(0,"", 2, "", 4, "", 6, "", 8, "", 10,"")) +
  # scale_fill_stepsn("Deaths averted per 10,000",colors=mycolors, 
  #                   breaks = seq(0,1.6,0.1), limits=c(0,1.6),
  #                   labels =c(0,"",0.2,"",0.4,"",0.6,"",0.8,
  #                             "",1.0,"",1.2,"",1.4,"",1.6)) + 
  theme_classic() +
  guides(fill = guide_colourbar(title.position="top", title.hjust = 0.5)) + 
  scale_y_continuous("Cross protection",labels = 
          scales::percent_format(accuracy = 1), 
          breaks = c(0,0.3,0.6,0.9), expand = c(0,0)) +
  scale_x_continuous("Prior infection",labels = 
          scales::percent_format(accuracy = 1), 
          breaks = c(0,0.3,0.6,0.9), expand = c(0,0)) +
  ggtitle("","         Malaysia-like") +
    theme(axis.text = element_text(size = 11, color = "black"),
        axis.title = element_text(size = 12, color = "black"),
        axis.line = element_blank(),
        axis.ticks = element_line(color = "black"),
        plot.title = element_text(colour = "black", size = 13.5, face = "bold"),
        plot.subtitle = element_text(colour = "black", size = 12.5),
        plot.margin = unit(c(t=0.2, r=0.2, b=0.2, l=0.2), "cm"),
        legend.key.width= unit(0.5, 'cm'),
        legend.position = "right", 
        plot.title.position = "plot",
        legend.title = element_text(size = 11, color = "black"),
        legend.text = element_text(size = 9, color = "black"),
        strip.text.x = element_text(colour = "black", size = 11, hjust = 0),
        strip.text.y = element_text(colour = "black", size = 10, hjust = 0),
        strip.background = element_rect(colour="white", fill="white"),
        panel.border = element_rect(colour = "black", fill=NA),
        panel.spacing = unit(0.3, "cm"), aspect.ratio=1)
plot17M
```

```{r}
plot3B <- plot_grid(plot17E,plot17I,plot17M, nrow = 1, rel_widths = c(1,1,1.8))
ggsave("../Supplement/S17_ODEdeaths10k.pdf", plot3B, height = 6, width = 16)
```


#### S19 - deaths per 10k bars
```{r}
#colors <- c("#0D3660","#BD451D","#428740")
mycolors <- rev(c("#0D3660","#BD451D","#428740"))

##noboost
death_noboost <- fast %>% 
  filter(Booster == "Bivalent") %>% ## just grab one set of runs
  mutate(relativeFOI = case_when(
    relax == 0 ~ "100% infectiousness",
    relax == 0.1 ~ "110% infectiousness",
    relax == 0.3 ~ "130% infectiousness"
  )) %>%
  filter(relativeFOI != "100% infectiousness") %>%
  #mutate(deaths10k) %>%
    mutate(boost.speed = case_when(
    boost.speed == "fast" ~ "Main text\n boosting",
    boost.speed == "slow" ~ "Conservative\n boosting"
  )) %>%
  mutate(deaths_10k = DeathsComp_per100k/10) %>%
  mutate(Booster = "No booster") %>% 
  select(relativeFOI, boost.speed, Booster, deaths_10k, country)


plotS19 <- fast %>%
  mutate(country = case_when(
    country == "Ecuador" ~ "Ecuador-like",
    country == "India" ~ "India-like",
    country == "Malaysia" ~ "Malaysia-like"
  )) %>%
  mutate(relativeFOI = case_when(
    relax == 0 ~ "100% infectiousness",
    relax == 0.1 ~ "110% infectiousness",
    relax == 0.3 ~ "130% infectiousness"
  )) %>%
  filter(relativeFOI != "100% infectiousness") %>%
  mutate(deaths_10k = deaths_100k/10) %>%
    mutate(boost.speed = case_when(
    boost.speed == "fast" ~ "Main text\n boosting",
    boost.speed == "slow" ~ "Conservative\n boosting"
  )) %>%
  select(relativeFOI, boost.speed, Booster, deaths_10k, country) %>%
  rbind(death_noboost) %>%
  ggplot(aes(x=relativeFOI, y=deaths_10k, fill=Booster))+
  geom_bar(stat='identity', position=position_dodge(), alpha=0.8, size = 0.6, width = 0.6)+
  labs(x='Force of infection relative to Omicron', y='Deaths per 10k')+
  theme_bw()+
    ggtitle("Hybrid immunity model", "Deaths per 10k") +
    facet_grid(boost.speed~country)+
  scale_color_manual("Booster", values = mycolors) +
  scale_fill_manual("Booster",values = mycolors) + 
    theme(axis.text = element_text(size = 11, color = "black"), #  angle = 90
        axis.title.x = element_text(size = 12, color = "black",vjust = -1),
        axis.title.y = element_text(size = 12, color = "black",vjust = +3),
        axis.line = element_line(color = "black"),
        axis.ticks = element_line(color = "black"),
        plot.title = element_text(colour = "black", size = 13.5, face = "bold"),
        plot.subtitle = element_text(colour = "black", size = 12.5),
        plot.margin = unit(c(t=0.2, r=1.5, b=0.5, l=1.5), "cm"),
        legend.position = "top", plot.title.position = "plot",
        strip.text = element_text(colour = "black", size = 11, hjust = 0),
        strip.background = element_rect(colour="white", fill="white"),
        legend.key.height= unit(0.4, 'cm'),
        legend.key.width= unit(0.4, 'cm'),
        legend.title = element_text(size = 11, color = "black"),
        legend.text = element_text(size = 10, color = "black"),
        legend.margin=margin(t=0.8,r=0.5,b=0.2,l=-4,unit = "line"),
        panel.spacing = unit(0.5, "cm") , aspect.ratio=0.8)
plotS19

ggsave("../Supplement/S19_da_per_10k.pdf", width = 12.5, height = 8)


```


## read data -- R0 calibrated beta, no reduction in infectiousness

```{r}

## ODE data ##

Ec_ts20 <- read_csv("../Data/ODE Supplement/Ecuador_ts_altbeta.csv") %>%
  mutate(country = "Ecuador") %>%
  rename(sd = sd0)
Ma_ts20 <- read_csv("../Data/ODE Supplement/Malaysia_ts_altbeta.csv") %>% 
  mutate(country = "Malaysia")
In_ts20 <- read_csv("../Data/ODE Supplement/India_ts_altbeta.csv") %>% 
  mutate(country = "India")

ODE_ts20 <- rbind(Ec_ts20, Ma_ts20) %>% rbind(In_ts20)

Ec_da20 <- read_csv("../Data/ODE Supplement/Ecuador_run_da_altbeta.csv")%>%
  mutate(country = "Ecuador")
Ma_da20 <- read_csv("../Data/ODE Supplement/Malaysia_run_da_altbeta.csv")%>% 
  mutate(country = "Malaysia")
In_da20 <- read_csv("../Data/ODE Supplement/India_run_da_altbeta.csv")%>% 
  mutate(country = "India")

ODE_da20 <- rbind(Ec_da20, Ma_da20) %>% rbind(In_da20)

Ec_grid20 <- read_csv("../Data/ODE Supplement/Ecuador_grid_da_altbeta.csv")
Ma_grid20 <- read_csv("../Data/ODE Supplement/Malaysia_grid_da_altbeta.csv")
In_grid20 <- read_csv("../Data/ODE Supplement/India_grid_da_altbeta.csv")
  
## WHO
start <- as.Date("2020-01-03", "%Y-%m-%d")

dataWHO <- read_csv("../Data/WHO_cases/WHO-COVID-19-global-data.csv") %>% 
  filter(Country %in% c("Ecuador", "India", "Malaysia")) %>% 
  arrange(Date_reported) %>% 
  mutate(time = difftime(as.Date(Date_reported, "%Y-%m-%d"), start, units = "days")) %>% 
  mutate(time = gsub(" days", "", time),
         time = as.numeric(time)) %>% 
  select(time, Country, New_cases, Cumulative_deaths) %>% 
  mutate(population = case_when(
    Country == "Ecuador" ~ 15735139,
    Country == "Malaysia" ~ 28552712,
    Country == "India"~ 1155561222
  )) %>% 
  mutate(infs_perc = New_cases/population,
         deaths_perc = Cumulative_deaths/population)

## change time to date
start_sims <- as.Date("2020-03-15", "%Y-%m-%d") 

```


### S20 - Fig. 3 alt beta - HIM

#### 3A - Infections

```{r}

colors <- c("#0D3660","#BD451D","#428740")

pop_vec <- dataWHO%>% select(population, country = Country) %>% distinct()

plot3A20 <- ODE_ts20 %>% 
  left_join(pop_vec) %>% 
    mutate(country = case_when(
    country == "Ecuador" ~ "Ecuador-like",
    country == "India" ~ "India-like",
    country == "Malaysia" ~ "Malaysia-like"
  )) %>%
  filter((boost.speed == "fast" & boost.start==60) | Booster == "None") %>%
  #mutate(time = (time+900)/30) %>%
  mutate(time = start_sims + time + 900) %>%
  filter(time < start_sims + 1095) %>%
  filter(relax == 0.1 | relax == 0.3) %>% 
    mutate(SAR = recode(
    relax,
    `0.1` = "110%",
    `0.3` = "130%"
  )) %>%
  mutate(SAR = fct_relevel(SAR, c("110%", "130%"))) %>% 
  mutate(booster = gsub("None", "No booster", Booster)) %>% 
  mutate(booster = fct_relevel(booster, c("No booster","Monovalent", "Bivalent"))) %>% 
  filter(name== "Iall") %>% 
  mutate(Infectiousness = SAR) %>%
  ## don't want infections to be *100, want to use percent scale
  ggplot(aes(x = time,y=10000*value/(population), color = booster, group = interaction(country, booster, SAR))) +
  geom_line(aes(linetype = Infectiousness), size= 1.2) +
  scale_fill_manual("Booster type", values = colors) +
  scale_color_manual("Booster type", values = colors) +
  theme_classic() + ylab("Infections per 10,000") +
  facet_wrap(~country, scales = "free") + 
  ggh4x::facetted_pos_scales(y = list(
  country == "Ecuador-like" ~ scale_y_continuous(limits = c(0, 300), breaks = c(0,50,100,150,200,250,300)),
  country == "India-like" ~ scale_y_continuous(limits = c(0, NA),
                                          breaks = c(0,70,140,210,280,350,420)),
  country == "Malaysia-like" ~ scale_y_continuous(limits = c(0, NA),
                                             breaks = c(0,30,60,90,120, 150)))) +
  #   country == "Ecuador" ~ scale_y_continuous(limits = c(0, NA), breaks = c(0,10,20,30,1000)),
  # country == "India" ~ scale_y_continuous(limits = c(0, NA),
  #                                         breaks = c(0,10,20,30,40,1000)),
  # country == "Malaysia" ~ scale_y_continuous(limits = c(0, NA), 
  #                                            breaks = c(0,15,30,45,60,75,1000)))) + 

  #scale_y_continuous("Infections per 10,000") + 
  #scale_x_continuous("Time (months)", expand = c(0,0.5), breaks = c(30,32,34,36)) +
  scale_x_date("Date", expand = c(0,0), date_breaks = "1 month", date_labels =  "%b %Y") + 
  ggtitle("Infections, recalibrated") + 
  theme(axis.text = element_text(size = 11, color = "black"),
        axis.title = element_text(size = 12, color = "black"),
        axis.text.x=element_text(angle=60, hjust=1),
        axis.line = element_line(color = "black"),
        axis.ticks = element_line(color = "black"),
        plot.title = element_text(colour = "black", size = 13.5, face = "bold"),
        plot.subtitle = element_text(colour = "black", size = 12.5),
        legend.position = "bottom", plot.title.position = "plot", 
        legend.title = element_text(size = 11, color = "black"),
        legend.text = element_text(size = 10, color = "black"),
        plot.margin = unit(c(t=0.2, r=1, b=0.2, l=1.5), "cm"),
        strip.text = element_text(colour = "black", size = 11, hjust = 0),
        strip.background = element_rect(colour="white", fill="white"),
        #panel.border = element_rect(colour = "black", fill=NA),
        panel.spacing = unit(0.5, "cm"))
plot3A20
```

#### 3B - Deaths adverted grids

```{r}
 #mycolors <- met.brewer("Isfahan1", n = 20)[11:20]
# 
 mycolors <- c("#e0ecf4","#bfd3e6","#9ebcda","#8c96c6","#807dba","#6F5784",
               "#54436E","#403255","#2D223C","#19013b")

#mycolors <-met.brewer("Hokusai1", n = 44)[28:44]

#mycolors <- rev(met.brewer("Hokusai1", n = 11)[0:8])


dataPlaces <- ODE_ts20 %>% 
  select(cp, base.imm, country) %>% 
  mutate(cp = as.numeric(cp), base.imm = as.numeric(base.imm)) %>%
  distinct() %>% 
  filter(country == "Ecuador")

plot3BE20 <- Ec_grid20  %>% 
  mutate(base.imm = as.numeric(base.imm), cp= as.numeric(cp))%>%
  mutate(relax = case_when(relax == 0.1 ~ "Infectiousness 110%",
                           relax == 0.3 ~ "Infectiousness 130%")) %>%
  mutate(deaths_10k_comp = deaths_100k_comp/10,
         deaths_10k = deaths_100k/10, 
         da10K = pmax(0,deaths_10k_comp-deaths_10k)) %>%
  filter(base.imm <= 0.9) %>%
  ggplot(aes(x = base.imm, y = cp)) + 
  geom_tile(aes(fill = da10K)) + facet_grid(relax~Booster) + 
  geom_point(data = dataPlaces, color= "black", fill = "black", size = 2) +
  #geom_text_repel(data = dataPlaces, color= "black", fill = "white", size = 2, aes(label = country)) +
  theme_classic() +
  scale_fill_stepsn("Deaths averted per 10,000",colors=mycolors,
                    breaks = seq(0,2.4,0.3), limits=c(0,2.4),
                    labels =c(0,"",0.6,"",1.2,"",1.8,"",2.4)) +
  # scale_fill_stepsn("Deaths averted per 10,000",colors=mycolors, 
  #                   breaks = seq(0,1.6,0.1), limits=c(0,1.6),
  #                   labels =c(0,"",0.2,"",0.4,"",0.6,"",0.8,
  #                             "",1.0,"",1.2,"",1.4,"",1.6)) + 
  theme_classic() +
  guides(fill = guide_colourbar(title.position="top", title.hjust = 0.5)) + 
  scale_y_continuous("Cross protection",labels = 
          scales::percent_format(accuracy = 1), 
          breaks = c(0,0.3,0.6,0.9), expand = c(0,0)) +
  scale_x_continuous("Prior infection",labels = 
          scales::percent_format(accuracy = 1), 
          breaks = c(0,0.3,0.6,0.9), expand = c(0,0)) +
  ggtitle("Deaths averted, recalibrated","         Ecuador-like") +
    theme(axis.text = element_text(size = 11, color = "black"),
        axis.title = element_text(size = 12, color = "black"),
        axis.line = element_blank(),
        axis.ticks = element_line(color = "black"),
        plot.title = element_text(colour = "black", size = 13.5, face = "bold"),
        plot.subtitle = element_text(colour = "black", size = 12.5),
        plot.margin = unit(c(t=0.2, r=0.2, b=0.2, l=0.2), "cm"),
        legend.key.width= unit(1.2, 'cm'),
        legend.position = "bottom", plot.title.position = "plot",
        legend.title = element_text(size = 11, color = "black"),
        legend.text = element_text(size = 9, color = "black"),
        strip.text.x = element_text(colour = "black", size = 11, hjust = 0),
        strip.text.y = element_text(colour = "black", size = 10, hjust = 0),
        strip.background = element_rect(colour="white", fill="white"),
        panel.border = element_rect(colour = "black", fill=NA),
        panel.spacing = unit(0.3, "cm"), aspect.ratio=1)
plot3BE20

dataPlaces <- ODE_ts20 %>% 
  select(cp, base.imm, country) %>% 
  mutate(cp = as.numeric(cp), base.imm = as.numeric(base.imm)) %>%
  distinct() %>% 
  filter(country == "India")

mycolors <-met.brewer("Hokusai1", n = 44)[28:44]

plot3BI20 <- In_grid20 %>% 
  mutate(base.imm = as.numeric(base.imm), cp= as.numeric(cp))%>%
  mutate(relax = case_when(relax == 0.1 ~ "Infectiousness 110%",
                           relax == 0.3 ~ "Infectiousness 130%")) %>%
    mutate(deaths_10k_comp = deaths_100k_comp/10,
         deaths_10k = deaths_100k/10,
         da10K = pmax(0,deaths_10k_comp-deaths_10k)) %>%
  filter(base.imm <= 0.9) %>%
  ggplot(aes(x = base.imm, y = cp)) + 
  geom_tile(aes(fill = da10K)) + facet_grid(relax~Booster) + 
  geom_point(data = dataPlaces, color= "black", fill = "black", size = 2) +
  #geom_text_repel(data = dataPlaces, color= "black", fill = "white", size = 2, aes(label = country)) +
  scale_fill_stepsn("Deaths averted per 10,000",colors=mycolors,
                    breaks = seq(0,1.4,0.2), limits=c(0,1.4),
                    labels =c(0,"",0.4,"",0.8,"",1.2,"")) +
  # scale_fill_stepsn("Deaths averted per 10,000",colors=mycolors, 
  #                   breaks = seq(0,1.6,0.1), limits=c(0,1.6),
  #                   labels =c(0,"",0.2,"",0.4,"",0.6,"",0.8,
  #                             "",1.0,"",1.2,"",1.4,"",1.6)) + 
  theme_classic() +
    scale_y_continuous("Cross protection",labels = scales::percent_format(accuracy = 1), breaks = c(0,0.3,0.6,0.9), expand = c(0,0)) +
    scale_x_continuous("Prior infection",labels = scales::percent_format(accuracy = 1), breaks = c(0,0.3,0.6,0.9), expand = c(0,0)) +
  guides(fill = guide_colourbar(title.position="top", title.hjust = 0.5)) + 
    theme(axis.text = element_text(size = 11, color = "black"),
        axis.title = element_text(size = 12, color = "black"),
        axis.line = element_blank(),
        axis.ticks = element_line(color = "black"),
        plot.title = element_text(colour = "black", size = 13.5, face = "bold"),
        plot.subtitle = element_text(colour = "black", size = 12.5),
        plot.margin = unit(c(t=0.2, r=0.2, b=0.2, l=0.2), "cm"),
        legend.key.width= unit(1.2, 'cm'), legend.position = "bottom",
        legend.title = element_text(size = 11, color = "black"),
        legend.text = element_text(size = 9, color = "black"),
        strip.text.x = element_text(colour = "black", size = 11, hjust = 0),
        strip.text.y = element_text(colour = "black", size = 10, hjust = 0),
        strip.background = element_rect(colour="white", fill="white"),
        panel.border = element_rect(colour = "black", fill=NA),
        panel.spacing = unit(0.3, "cm"), aspect.ratio=1)+
  ggtitle(" ","India-like")
plot3BI20

#mycolors <- met.brewer("VanGogh3", n = 10)
mycolors <- rev(met.brewer("Hokusai1", n = 11)[0:8])

#mycolors <-met.brewer("Hokusai1", n = 44)[28:44]


dataPlaces <- ODE_ts20 %>% 
  select(cp, base.imm, country) %>% 
  mutate(cp = as.numeric(cp), base.imm = as.numeric(base.imm)) %>%
  distinct() %>% 
  filter(country == "Malaysia")

plot3BM20 <- Ma_grid20 %>% 
  mutate(base.imm = as.numeric(base.imm), cp= as.numeric(cp))%>%
  mutate(relax = case_when(relax == 0.1 ~ "Infectiousness 110%",
                           relax == 0.3 ~"Infectiousness 130%")) %>%
    mutate(deaths_10k_comp = deaths_100k_comp/10,
         deaths_10k = deaths_100k/10,
         da10K = pmax(0,deaths_10k_comp-deaths_10k)) %>%
  filter(base.imm <= 0.9) %>%
  ggplot(aes(x = base.imm, y = cp)) + 
  geom_tile(aes(fill = da10K)) + facet_grid(relax~Booster) + 
  geom_point(data = dataPlaces, color= "black", fill = "black", size = 2) +
  #geom_text_repel(data = dataPlaces, color= "black", fill = "white", size = 2, aes(label = country)) +
  scale_fill_stepsn("Deaths averted per 10,000",colors=mycolors,
                    breaks = seq(0,4.0,0.5), limits=c(0,4.0),
                    labels =c(0,"",1.0,"",2.0,"",3.0,"",4.0)) +
  # scale_fill_stepsn("Deaths averted per 10,000",colors=mycolors, 
  #                   breaks = seq(0,3.2,0.2), limits=c(0,3.2),
  #                   labels =c(0,"",0.4,"",0.8,"",1.2,"",1.6,
  #                             "",2.0,"",2.4,"",2.8,"",3.2)) + 
  theme_classic() +
  guides(fill = guide_colourbar(title.position="top", title.hjust = 0.5)) + 
  theme_classic() +
  scale_y_continuous("Cross protection",labels = scales::percent_format(accuracy = 1), breaks = c(0,0.3,0.6,0.9), expand = c(0,0)) +
    scale_x_continuous("Prior infection",labels = scales::percent_format(accuracy = 1), breaks = c(0,0.3,0.6,0.9), expand = c(0,0)) +
    theme(axis.text = element_text(size = 11, color = "black"),
        axis.title = element_text(size = 12, color = "black"),
        axis.line = element_blank(),
        axis.ticks = element_line(color = "black"),
        plot.title = element_text(colour = "black", size = 13.5, face = "bold"),
        plot.subtitle = element_text(colour = "black", size = 12.5),
        plot.margin = unit(c(t=0.2, r=0.2, b=0.2, l=0.2), "cm"),
        legend.key.width= unit(1.2, 'cm'),
        legend.position = "bottom",
        legend.title = element_text(size = 11, color = "black"),
        legend.text = element_text(size = 10, color = "black"),
        strip.text.x = element_text(colour = "black", size = 11, hjust = 0),
        strip.text.y = element_text(colour = "black", size = 10, hjust = 0),
        strip.background = element_rect(colour="white", fill="white"),
        panel.border = element_rect(colour = "black", fill=NA),
        panel.spacing = unit(0.3, "cm"), aspect.ratio=1)+
  ggtitle(" ","Malaysia-like")
plot3BM20
```


#### Save figure 3
```{r}
plot3B20 <- plot_grid(plot3BE20,plot3BI20,plot3BM20, nrow = 1)
plot3B20 <- plot_grid(NULL,plot3B20,ncol=2, rel_widths = c(0.03,1))
plot320 <- plot_grid(plot3A20,plot3B20, nrow = 2, labels = c("A", "B"),
                     rel_heights = c(0.7, 1))
ggsave("../Supplement/S20-altbeta_fig3.pdf", plot320, height = 9, width = 13)
```


### S21 - Fig. 4 alt beta - HIM


#### 4E Ecuador
```{r}

#mycolors<-colorRampPalette(c("#d35c79", "#d69481","#c9b1cf","#bccab4", "#7aaf97","#009593"))(21)[-c(1,2,3,4,5,6,7,8,11)]

# mycolors<-(colorRampPalette(rev(c("#009b9f", "#43b7b9","#a7d3d5", "#e4c1d8","#d691c1","#c75daa"))))(21)[-c(1,2,3,4,5,6,7,8,11)]

#mycolors <- c("#DADAEB", "#E0F3F8","#ABD9E9","#74ADD1","#4575B4","#313695")

mycolors <- c("#011f4b", "#0f345f", "#1f4972", "#326085", "#467798", "#5d88a6", "#7499b4", "#8aaac3", "#a4b8d0", "#bdc7db", "#d3d7e7", "#e8e8f2","#fbdfba", "#F5AE52")

dataPlaces <- ODE_ts20 %>% 
  select(cp, base.imm, country) %>% 
  mutate(cp = as.numeric(cp), base.imm = as.numeric(base.imm)) %>%
  distinct() %>% 
  filter(country == "Ecuador")

## get grid calculations
dat4E20 <- Ec_grid20 %>% 
  mutate(base.imm = as.numeric(base.imm), cp= as.numeric(cp))%>%
  mutate(relax = case_when(relax == 0.1 ~ "Infectiousness 110%",
                           relax == 0.3 ~ "Infectiousness 130%")) %>%
  mutate(deaths_10k_comp = deaths_100k_comp/10,
         deaths_10k = deaths_100k/10,
         da10k = pmax(0,deaths_10k_comp-deaths_10k)) %>%
  select(base.imm, cp, relax,Booster, da10k) %>%
  pivot_wider(values_from = da10k, names_from = Booster) %>% 
  mutate(comp10k = Bivalent-Monovalent, gain = round(Bivalent/Monovalent,2))

plot4E20 <- dat4E20 %>% 
    filter(base.imm <= 0.9) %>%
  ggplot(aes(x = base.imm, y = cp)) + 
  geom_tile(aes(fill = gain)) + facet_wrap(~relax, ncol = 1) + theme_classic() +
# scale_fill_stepsn("Relative benefit\nof bivalent",colours = mycolors, 
#                     breaks = seq(-0.45,2.25,0.45), 
#                     limits=c(-.45,2.25),
#                     labels =c(-0.45,0,0.45,0.9,1.35,1.8,2.25),
#                     guide = "colorbar") +
  scale_fill_stepsn("Relative benefit\nof bivalent",colours = rev(mycolors), 
                    breaks = seq(1,8,0.5), 
                    limits=c(1,8),
                    labels =c(1,"",2,"",3,"",4,"",5,"",6,"",7,"",8),
                    guide = "colorbar")+
  geom_point(data = dataPlaces, color= "black", fill = "black", size = 2) +
  # geom_text_repel(data = dataPlaces, color= "black", fill = "white", size = 2, aes(label = country)) +
  guides(fill = guide_colourbar(title.position="top", title.hjust = 0.5)) + 
  scale_y_continuous("Cross protection",labels = 
          scales::percent_format(accuracy = 1), 
          breaks = c(0,0.3,0.6,0.9), expand = c(0,0)) +
  scale_x_continuous("Prior infection",labels = 
          scales::percent_format(accuracy = 1), 
          breaks = c(0,0.3,0.6,0.9), expand = c(0,0)) +
  ggtitle("Gains - recalibrated","         Ecuador-like") +
    theme(axis.text = element_text(size = 11, color = "black"),
        axis.title = element_text(size = 12, color = "black"),
        axis.line = element_blank(),
        axis.ticks = element_line(color = "black"),
        plot.title = element_text(colour = "black", size = 13.5, face = "bold"),
        plot.subtitle = element_text(colour = "black", size = 12.5),
        plot.margin = unit(c(t=0.2, r=0.2, b=0.2, l=0.2), "cm"),
        legend.key.width= unit(0.95, 'cm'),
        legend.position = "none",
        #legend.position = "bottom", 
        plot.title.position = "plot",
        legend.title = element_text(size = 11, color = "black"),
        legend.text = element_text(size = 10, color = "black"),
        strip.text.x = element_text(colour = "black", size = 11, hjust = 0),
        strip.text.y = element_text(colour = "black", size = 10, hjust = 0),
        strip.background = element_rect(colour="white", fill="white"),
        panel.border = element_rect(colour = "black", fill=NA),
        panel.spacing = unit(0.3, "cm"), aspect.ratio=1)
plot4E20

```


#### 4I India
```{r}

dataPlaces <- ODE_ts20 %>% 
  select(cp, base.imm, country) %>% 
  mutate(cp = as.numeric(cp), base.imm = as.numeric(base.imm)) %>%
  distinct() %>% 
  filter(country == "India")

## get grid calculations
dat4I20 <- In_grid20 %>% 
  mutate(base.imm = as.numeric(base.imm), cp= as.numeric(cp))%>%
  mutate(relax = case_when(relax == 0.1 ~ "Infectiousness 110%",
                           relax == 0.3 ~ "Infectiousness 130%")) %>%
  mutate(deaths_10k_comp = deaths_100k_comp/10,
         deaths_10k = deaths_100k/10,
         da10k = pmax(0,deaths_10k_comp -deaths_10k)) %>%
  select(base.imm, cp, relax,Booster, da10k) %>%
  pivot_wider(values_from = da10k, names_from = Booster) %>% 
  mutate(comp10k = Bivalent-Monovalent, gain = round(Bivalent/Monovalent,2))

plot4I20 <- dat4I20 %>% 
    filter(base.imm <= 0.9) %>%
  ggplot(aes(x = base.imm, y = cp)) + 
  geom_tile(aes(fill = gain)) + facet_wrap(~relax, ncol = 1) + theme_classic() +
# scale_fill_stepsn("Relative benefit\nof bivalent",colours = mycolors, 
#                     breaks = seq(-0.45,2.25,0.45), 
#                     limits=c(-.45,2.25),
#                     labels =c(-0.45,0,0.45,0.9,1.35,1.8,2.25),
#                     guide = "colorbar") +
  scale_fill_stepsn("Relative benefit\nof bivalent",colours = rev(mycolors), 
                    breaks = seq(1,8,0.5), 
                    limits=c(1,8),
                    labels =c(1,"",2,"",3,"",4,"",5,"",6,"",7,"",8),
                    guide = "colorbar")+
  geom_point(data = dataPlaces, color= "black", fill = "black", size = 2) +
  # geom_text_repel(data = dataPlaces, color= "black", fill = "white", size = 2, aes(label = country)) +
  guides(fill = guide_colourbar(title.position="top", title.hjust = 0.5)) + 
  scale_y_continuous("Cross protection",labels = 
          scales::percent_format(accuracy = 1), 
          breaks = c(0,0.3,0.6,0.9), expand = c(0,0)) +
  scale_x_continuous("Prior infection",labels = 
          scales::percent_format(accuracy = 1), 
          breaks = c(0,0.3,0.6,0.9), expand = c(0,0)) +
  ggtitle("","         India-like") +
    theme(axis.text = element_text(size = 11, color = "black"),
        axis.title = element_text(size = 12, color = "black"),
        axis.line = element_blank(),
        axis.ticks = element_line(color = "black"),
        plot.title = element_text(colour = "black", size = 13.5, face = "bold"),
        plot.subtitle = element_text(colour = "black", size = 12.5),
        plot.margin = unit(c(t=0.2, r=0.2, b=0.2, l=0.2), "cm"),
        legend.key.width= unit(0.95, 'cm'),
        legend.position = "none",
        #legend.position = "bottom", 
        plot.title.position = "plot",
        legend.title = element_text(size = 11, color = "black"),
        legend.text = element_text(size = 10, color = "black"),
        strip.text.x = element_text(colour = "black", size = 11, hjust = 0),
        strip.text.y = element_text(colour = "black", size = 10, hjust = 0),
        strip.background = element_rect(colour="white", fill="white"),
        panel.border = element_rect(colour = "black", fill=NA),
        panel.spacing = unit(0.3, "cm"), aspect.ratio=1)
plot4I20


```


#### 4M Malaysia
```{r}

#colours = c("#d35c79", "#d69481","#dec0a3","#bccab4", "#7aaf97","#009593")

#mycolors <- colorRampPalette(brewer.pal(6, "Blues"))(nb.cols)

dataPlaces <- ODE_ts20 %>% 
  select(cp, base.imm, country) %>% 
  mutate(cp = as.numeric(cp), base.imm = as.numeric(base.imm)) %>%
  distinct() %>%
  filter(country == "Malaysia")

## get grid calculations
dat4M20 <- Ma_grid20 %>% 
  mutate(base.imm = as.numeric(base.imm), cp= as.numeric(cp))%>%
  mutate(relax = case_when(relax == 0.1 ~ "Infectiousness 110%",
                           relax == 0.3 ~ "Infectiousness 130%")) %>%
  mutate(deaths_10k_comp = deaths_100k_comp/10,
         deaths_10k = deaths_100k/10,
         da10k = pmax(0,deaths_10k_comp -deaths_10k)) %>%
  select(base.imm, cp, relax,Booster, da10k) %>%
  pivot_wider(values_from = da10k, names_from = Booster) %>% 
  mutate(comp10k = Bivalent-Monovalent, gain = round(Bivalent/Monovalent,2))

plot4M20 <- dat4M20 %>% 
  filter(base.imm <= 0.9) %>%
  ggplot(aes(x = base.imm, y = cp)) + 
  geom_tile(aes(fill = gain)) + facet_wrap(~relax, ncol = 1) + theme_classic() +
# scale_fill_stepsn("Relative benefit\nof bivalent",colours = mycolors, 
#                     breaks = seq(-0.45,2.25,0.45), 
#                     limits=c(-.45,2.25),
#                     #labels =c(-0.45,"",0,"",0.45,"",0.9,"",1.35,"",1.8,"",2.25),
#                     guide = "colorbar") +
  scale_fill_stepsn("Relative benefit\nof bivalent",colours = rev(mycolors), 
                    breaks = seq(1,8,0.5), 
                    limits=c(1,8),
                    labels =c(1,"",2,"",3,"",4,"",5,"",6,"",7,"",8),
                    guide = "colorbar")+
  geom_point(data = dataPlaces, color= "black", fill = "black", size = 2) +
  # geom_text_repel(data = dataPlaces, color= "black", fill = "white", size = 2, aes(label = country)) +
  guides(fill = guide_colourbar(title.position="top", title.hjust = 0.5)) + 
  scale_y_continuous("Cross protection",labels = 
          scales::percent_format(accuracy = 1), 
          breaks = c(0,0.3,0.6,0.9), expand = c(0,0)) +
  scale_x_continuous("Prior infection",labels = 
          scales::percent_format(accuracy = 1), 
          breaks = c(0,0.3,0.6,0.9), expand = c(0,0)) +
  ggtitle("","         Malaysia-like") +
    theme(axis.text = element_text(size = 11, color = "black"),
        axis.title = element_text(size = 12, color = "black"),
        axis.line = element_blank(),
        axis.ticks = element_line(color = "black"),
        plot.title = element_text(colour = "black", size = 13.5, face = "bold"),
        plot.subtitle = element_text(colour = "black", size = 12.5),
        plot.margin = unit(c(t=0.2, r=0.2, b=0.2, l=0.2), "cm"),
        legend.key.width= unit(0.5, 'cm'),
        legend.position = "right",
        #legend.position = "bottom", 
        plot.title.position = "plot",
        legend.title = element_text(size = 11, color = "black"),
        legend.text = element_text(size = 10, color = "black"),
        strip.text.x = element_text(colour = "black", size = 11, hjust = 0),
        strip.text.y = element_text(colour = "black", size = 10, hjust = 0),
        strip.background = element_rect(colour="white", fill="white"),
        panel.border = element_rect(colour = "black", fill=NA),
        panel.spacing = unit(0.3, "cm"), aspect.ratio=1)
plot4M20


```

#### Save fig. 4
```{r}

# plot4 <- plot_grid(plot4AE, plot4AI, plot4AM, plot4E, plot4I, plot4M, nrow = 2, labels = c("A","","","B","",""))
# 
# plot4A <- plot_grid(plot4AE, plot4AI, plot4AM, nrow = 1,
#                     rel_widths = c(1,1,1.57))
# plot4B <- plot_grid(plot4E, plot4I, plot4M, nrow = 1,
#                     rel_widths = c(1,1,1.45))

# plot4 <- plot_grid(plot4A, plot4B, nrow = 2, labels = c("A", "B"))

plot420 <- plot_grid(plot4E20,plot4I20,plot4M20, nrow = 1, rel_widths = c(1,1,1.51))
ggsave("../Supplement/S21-altbeta_fig4.pdf", plot420, height = 6, width = 9.4)

```




## read data -- change R0, ABM calibrated, no reduction in infectiousness

```{r}

## ODE data ##

Ec_ts22 <- read_csv("../Data/ODE Supplement/Ecuador_ts_altbetaR0.csv") %>%
  mutate(country = "Ecuador") %>%
  rename(sd = sd0)
Ma_ts22 <- read_csv("../Data/ODE Supplement/Malaysia_ts_altbetaR0.csv") %>% 
  mutate(country = "Malaysia")
In_ts22 <- read_csv("../Data/ODE Supplement/India_ts_altbetaR0.csv") %>% 
  mutate(country = "India")

ODE_ts22 <- rbind(Ec_ts22, Ma_ts22) %>% rbind(In_ts22)

Ec_da22 <- read_csv("../Data/ODE Supplement/Ecuador_run_da_altbetaR0.csv")%>%
  mutate(country = "Ecuador")
Ma_da22 <- read_csv("../Data/ODE Supplement/Malaysia_run_da_altbetaR0.csv")%>% 
  mutate(country = "Malaysia")
In_da22 <- read_csv("../Data/ODE Supplement/India_run_da_altbetaR0.csv")%>% 
  mutate(country = "India")

ODE_da22 <- rbind(Ec_da22, Ma_da22) %>% rbind(In_da22)

Ec_grid22 <- read_csv("../Data/ODE Supplement/Ecuador_grid_da_altbetaR0.csv")
Ma_grid22 <- read_csv("../Data/ODE Supplement/Malaysia_grid_da_altbetaR0.csv")
In_grid22 <- read_csv("../Data/ODE Supplement/India_grid_da_altbetaR0.csv")
  
## WHO
start <- as.Date("2020-01-03", "%Y-%m-%d")

dataWHO <- read_csv("../Data/WHO_cases/WHO-COVID-19-global-data.csv") %>% 
  filter(Country %in% c("Ecuador", "India", "Malaysia")) %>% 
  arrange(Date_reported) %>% 
  mutate(time = difftime(as.Date(Date_reported, "%Y-%m-%d"), start, units = "days")) %>% 
  mutate(time = gsub(" days", "", time),
         time = as.numeric(time)) %>% 
  select(time, Country, New_cases, Cumulative_deaths) %>% 
  mutate(population = case_when(
    Country == "Ecuador" ~ 15735139,
    Country == "Malaysia" ~ 28552712,
    Country == "India"~ 1155561222
  )) %>% 
  mutate(infs_perc = New_cases/population,
         deaths_perc = Cumulative_deaths/population)

## change time to date
start_sims <- as.Date("2020-03-15", "%Y-%m-%d") 

```


### S22 - Fig. 3 alt beta - HIM

#### 3A - Infections

```{r}

colors <- c("#0D3660","#BD451D","#428740")

pop_vec <- dataWHO%>% select(population, country = Country) %>% distinct()

plot3A22 <- ODE_ts22 %>% 
  left_join(pop_vec) %>% 
    mutate(country = case_when(
    country == "Ecuador" ~ "Ecuador-like",
    country == "India" ~ "India-like",
    country == "Malaysia" ~ "Malaysia-like"
  )) %>%
  filter((boost.speed == "fast" & boost.start==60) | Booster == "None") %>%
  #mutate(time = (time+900)/30) %>%
  mutate(time = start_sims + time + 900) %>%
  filter(time < start_sims + 1095) %>%
  filter(relax == 0.1 | relax == 0.3) %>% 
    mutate(SAR = recode(
    relax,
    `0.1` = "110%",
    `0.3` = "130%"
  )) %>%
  mutate(SAR = fct_relevel(SAR, c("110%", "130%"))) %>% 
  mutate(booster = gsub("None", "No booster", Booster)) %>% 
  mutate(booster = fct_relevel(booster, c("No booster","Monovalent", "Bivalent"))) %>% 
  filter(name== "Iall") %>% 
  mutate(Infectiousness = SAR) %>%
  ## don't want infections to be *100, want to use percent scale
  ggplot(aes(x = time,y=10000*value/(population), color = booster, group = interaction(country, booster, SAR))) +
  geom_line(aes(linetype = Infectiousness), size= 1.2) +
  scale_fill_manual("Booster type", values = colors) +
  scale_color_manual("Booster type", values = colors) +
  theme_classic() + ylab("Infections per 10,000") +
  facet_wrap(~country, scales = "free") + 
  ggh4x::facetted_pos_scales(y = list(
  # country == "Ecuador" ~ scale_y_continuous(limits = c(0, 300), breaks = c(0,50,100,150,200,250,300)),
  # country == "India" ~ scale_y_continuous(limits = c(0, NA),
  #                                         breaks = c(0,70,140,210,280,350,420)),
  # country == "Malaysia" ~ scale_y_continuous(limits = c(0, NA), 
  #                                            breaks = c(0,30,60,90,120, 150)))) + 
    country == "Ecuador-like" ~ scale_y_continuous(limits = c(0, 1200), breaks = c(0,300,600,900,1200)),
  country == "India-like" ~ scale_y_continuous(limits = c(0, 1800),
                                          breaks = c(0,450,900,1350,1800)),
  country == "Malaysia-like" ~ scale_y_continuous(limits = c(0, 900), 
                                             breaks = c(0,300,600,900)))) + 
  scale_x_date("Date", expand = c(0,0), date_breaks = "1 month", date_labels =  "%b %Y") + 
  #scale_y_continuous("Infections per 10,000") + 
  #scale_x_continuous("Time (months)", expand = c(0,0.5), breaks = c(30,32,34,36)) +
  ggtitle("Infections, adjust transmission") + 
  theme(axis.text = element_text(size = 11, color = "black"),
       axis.text.x=element_text(angle=60, hjust=1),
        axis.title = element_text(size = 12, color = "black"),
        axis.line = element_line(color = "black"),
        axis.ticks = element_line(color = "black"),
        plot.title = element_text(colour = "black", size = 13.5, face = "bold"),
        plot.subtitle = element_text(colour = "black", size = 12.5),
        legend.position = "bottom", plot.title.position = "plot", 
        legend.title = element_text(size = 11, color = "black"),
        legend.text = element_text(size = 10, color = "black"),
        plot.margin = unit(c(t=0.2, r=1, b=0.2, l=1.5), "cm"),
        strip.text = element_text(colour = "black", size = 11, hjust = 0),
        strip.background = element_rect(colour="white", fill="white"),
        #panel.border = element_rect(colour = "black", fill=NA),
        panel.spacing = unit(0.5, "cm"))
plot3A22
```

#### 3B - Deaths adverted grids

```{r}
 #mycolors <- met.brewer("Isfahan1", n = 20)[11:20]
# 
 mycolors <- c("#e0ecf4","#bfd3e6","#9ebcda","#8c96c6","#807dba","#6F5784",
               "#54436E","#403255","#2D223C","#19013b")

#mycolors <-met.brewer("Hokusai1", n = 44)[28:44]

#mycolors <- rev(met.brewer("Hokusai1", n = 11)[0:8])


dataPlaces <- ODE_ts22 %>% 
  select(cp, base.imm, country) %>% 
  mutate(cp = as.numeric(cp), base.imm = as.numeric(base.imm)) %>%
  distinct() %>% 
  filter(country == "Ecuador")

plot3BE22 <- Ec_grid22  %>% 
  mutate(base.imm = as.numeric(base.imm), cp= as.numeric(cp))%>%
  mutate(relax = case_when(relax == 0.1 ~ "Infectiousness 110%",
                           relax == 0.3 ~ "Infectiousness 130%")) %>%
  mutate(deaths_10k_comp = deaths_100k_comp/10,
         deaths_10k = deaths_100k/10, 
         da10K = pmax(0,deaths_10k_comp-deaths_10k)) %>%
  filter(base.imm <= 0.9) %>%
  ggplot(aes(x = base.imm, y = cp)) + 
  geom_tile(aes(fill = da10K)) + facet_grid(relax~Booster) + 
  geom_point(data = dataPlaces, color= "black", fill = "black", size = 2) +
  #geom_text_repel(data = dataPlaces, color= "black", fill = "white", size = 2, aes(label = country)) +
  theme_classic() +
  scale_fill_stepsn("Deaths averted per 10,000",colors=mycolors,
                    breaks = seq(0,3.2,0.4), limits=c(0,3.2),
                    labels =c(0,"",0.8,"",1.6,"",2.4,"",3.2)) +
  # scale_fill_stepsn("Deaths averted per 10,000",colors=mycolors, 
  #                   breaks = seq(0,1.6,0.1), limits=c(0,1.6),
  #                   labels =c(0,"",0.2,"",0.4,"",0.6,"",0.8,
  #                             "",1.0,"",1.2,"",1.4,"",1.6)) + 
  theme_classic() +
  guides(fill = guide_colourbar(title.position="top", title.hjust = 0.5)) + 
  scale_y_continuous("Cross protection",labels = 
          scales::percent_format(accuracy = 1), 
          breaks = c(0,0.3,0.6,0.9), expand = c(0,0)) +
  scale_x_continuous("Prior infection",labels = 
          scales::percent_format(accuracy = 1), 
          breaks = c(0,0.3,0.6,0.9), expand = c(0,0)) +
  ggtitle("Deaths averted, adjust transmission","         Ecuador-like") +
    theme(axis.text = element_text(size = 11, color = "black"),
        axis.title = element_text(size = 12, color = "black"),
        axis.line = element_blank(),
        axis.ticks = element_line(color = "black"),
        plot.title = element_text(colour = "black", size = 13.5, face = "bold"),
        plot.subtitle = element_text(colour = "black", size = 12.5),
        plot.margin = unit(c(t=0.2, r=0.2, b=0.2, l=0.2), "cm"),
        legend.key.width= unit(1.2, 'cm'),
        legend.position = "bottom", plot.title.position = "plot",
        legend.title = element_text(size = 11, color = "black"),
        legend.text = element_text(size = 9, color = "black"),
        strip.text.x = element_text(colour = "black", size = 11, hjust = 0),
        strip.text.y = element_text(colour = "black", size = 10, hjust = 0),
        strip.background = element_rect(colour="white", fill="white"),
        panel.border = element_rect(colour = "black", fill=NA),
        panel.spacing = unit(0.3, "cm"), aspect.ratio=1)
plot3BE22

dataPlaces <- ODE_ts22 %>% 
  select(cp, base.imm, country) %>% 
  mutate(cp = as.numeric(cp), base.imm = as.numeric(base.imm)) %>%
  distinct() %>% 
  filter(country == "India")

mycolors <-met.brewer("Hokusai1", n = 44)[28:44]

plot3BI22 <- In_grid22 %>% 
  mutate(base.imm = as.numeric(base.imm), cp= as.numeric(cp))%>%
  mutate(relax = case_when(relax == 0.1 ~ "Infectiousness 110%",
                           relax == 0.3 ~ "Infectiousness 130%")) %>%
    mutate(deaths_10k_comp = deaths_100k_comp/10,
         deaths_10k = deaths_100k/10,
         da10K = pmax(0,deaths_10k_comp-deaths_10k)) %>%
  filter(base.imm <= 0.9) %>%
  ggplot(aes(x = base.imm, y = cp)) + 
  geom_tile(aes(fill = da10K)) + facet_grid(relax~Booster) + 
  geom_point(data = dataPlaces, color= "black", fill = "black", size = 2) +
  #geom_text_repel(data = dataPlaces, color= "black", fill = "white", size = 2, aes(label = country)) +
  scale_fill_stepsn("Deaths averted per 10,000",colors=mycolors,
                    breaks = seq(0,1.3,0.1), limits=c(0,1.3),
                    labels =c(0,"",0.2,"",0.4,"",0.6,"",0.8,"",1.0,"",1.2,"")) +
  # scale_fill_stepsn("Deaths averted per 10,000",colors=mycolors, 
  #                   breaks = seq(0,1.6,0.1), limits=c(0,1.6),
  #                   labels =c(0,"",0.2,"",0.4,"",0.6,"",0.8,
  #                             "",1.0,"",1.2,"",1.4,"",1.6)) + 
  theme_classic() +
    scale_y_continuous("Cross protection",labels = scales::percent_format(accuracy = 1), breaks = c(0,0.3,0.6,0.9), expand = c(0,0)) +
    scale_x_continuous("Prior infection",labels = scales::percent_format(accuracy = 1), breaks = c(0,0.3,0.6,0.9), expand = c(0,0)) +
  guides(fill = guide_colourbar(title.position="top", title.hjust = 0.5)) + 
    theme(axis.text = element_text(size = 11, color = "black"),
        axis.title = element_text(size = 12, color = "black"),
        axis.line = element_blank(),
        axis.ticks = element_line(color = "black"),
        plot.title = element_text(colour = "black", size = 13.5, face = "bold"),
        plot.subtitle = element_text(colour = "black", size = 12.5),
        plot.margin = unit(c(t=0.2, r=0.2, b=0.2, l=0.2), "cm"),
        legend.key.width= unit(1.2, 'cm'), legend.position = "bottom",
        legend.title = element_text(size = 11, color = "black"),
        legend.text = element_text(size = 9, color = "black"),
        strip.text.x = element_text(colour = "black", size = 11, hjust = 0),
        strip.text.y = element_text(colour = "black", size = 10, hjust = 0),
        strip.background = element_rect(colour="white", fill="white"),
        panel.border = element_rect(colour = "black", fill=NA),
        panel.spacing = unit(0.3, "cm"), aspect.ratio=1)+
  ggtitle(" ","India-like")
plot3BI22

#mycolors <- met.brewer("VanGogh3", n = 10)
mycolors <- rev(met.brewer("Hokusai1", n = 11)[0:8])

#mycolors <-met.brewer("Hokusai1", n = 44)[28:44]


dataPlaces <- ODE_ts22 %>% 
  select(cp, base.imm, country) %>% 
  mutate(cp = as.numeric(cp), base.imm = as.numeric(base.imm)) %>%
  distinct() %>% 
  filter(country == "Malaysia")

plot3BM22 <- Ma_grid22 %>% 
  mutate(base.imm = as.numeric(base.imm), cp= as.numeric(cp))%>%
  mutate(relax = case_when(relax == 0.1 ~ "Infectiousness 110%",
                           relax == 0.3 ~"Infectiousness 130%")) %>%
    mutate(deaths_10k_comp = deaths_100k_comp/10,
         deaths_10k = deaths_100k/10,
         da10K = pmax(0,deaths_10k_comp-deaths_10k)) %>%
  filter(base.imm <= 0.9) %>%
  ggplot(aes(x = base.imm, y = cp)) + 
  geom_tile(aes(fill = da10K)) + facet_grid(relax~Booster) + 
  geom_point(data = dataPlaces, color= "black", fill = "black", size = 2) +
  #geom_text_repel(data = dataPlaces, color= "black", fill = "white", size = 2, aes(label = country)) +
  scale_fill_stepsn("Deaths averted per 10,000",colors=mycolors,
                    breaks = seq(0,5,0.5), limits=c(0,5),
                    labels =c(0,"",1.0,"",2.0,"",3.0,"",4.0,"",5.0)) +
  # scale_fill_stepsn("Deaths averted per 10,000",colors=mycolors, 
  #                   breaks = seq(0,3.2,0.2), limits=c(0,3.2),
  #                   labels =c(0,"",0.4,"",0.8,"",1.2,"",1.6,
  #                             "",2.0,"",2.4,"",2.8,"",3.2)) + 
  theme_classic() +
  guides(fill = guide_colourbar(title.position="top", title.hjust = 0.5)) + 
  theme_classic() +
  scale_y_continuous("Cross protection",labels = scales::percent_format(accuracy = 1), breaks = c(0,0.3,0.6,0.9), expand = c(0,0)) +
    scale_x_continuous("Prior infection",labels = scales::percent_format(accuracy = 1), breaks = c(0,0.3,0.6,0.9), expand = c(0,0)) +
    theme(axis.text = element_text(size = 11, color = "black"),
        axis.title = element_text(size = 12, color = "black"),
        axis.line = element_blank(),
        axis.ticks = element_line(color = "black"),
        plot.title = element_text(colour = "black", size = 13.5, face = "bold"),
        plot.subtitle = element_text(colour = "black", size = 12.5),
        plot.margin = unit(c(t=0.2, r=0.2, b=0.2, l=0.2), "cm"),
        legend.key.width= unit(1.2, 'cm'),
        legend.position = "bottom",
        legend.title = element_text(size = 11, color = "black"),
        legend.text = element_text(size = 10, color = "black"),
        strip.text.x = element_text(colour = "black", size = 11, hjust = 0),
        strip.text.y = element_text(colour = "black", size = 10, hjust = 0),
        strip.background = element_rect(colour="white", fill="white"),
        panel.border = element_rect(colour = "black", fill=NA),
        panel.spacing = unit(0.3, "cm"), aspect.ratio=1)+
  ggtitle(" ","Malaysia-like")
plot3BM22
```


#### Save figure 3
```{r}
plot3B22 <- plot_grid(plot3BE22,plot3BI22,plot3BM22, nrow = 1)
plot3B22 <- plot_grid(NULL,plot3B22,ncol=2, rel_widths = c(0.03,1))
plot322 <- plot_grid(plot3A22,plot3B22, nrow = 2, labels = c("A", "B"),
                     rel_heights = c(0.7, 1))
ggsave("../Supplement/S22-altbeta_matchABM_fig3.pdf", plot322, height = 9, width = 13)
```


### S23 - Fig. 4 alt beta - HIM


#### 4E Ecuador
```{r}

#mycolors<-colorRampPalette(c("#d35c79", "#d69481","#c9b1cf","#bccab4", "#7aaf97","#009593"))(21)[-c(1,2,3,4,5,6,7,8,11)]

# mycolors<-(colorRampPalette(rev(c("#009b9f", "#43b7b9","#a7d3d5", "#e4c1d8","#d691c1","#c75daa"))))(21)[-c(1,2,3,4,5,6,7,8,11)]

#mycolors <- c("#DADAEB", "#E0F3F8","#ABD9E9","#74ADD1","#4575B4","#313695")

mycolors <- c("#011f4b", "#0f345f", "#1f4972", "#326085", "#467798", "#5d88a6", "#7499b4", "#8aaac3", "#a4b8d0", "#bdc7db", "#d3d7e7", "#e8e8f2","#fbdfba", "#F5AE52")

dataPlaces <- ODE_ts22 %>% 
  select(cp, base.imm, country) %>% 
  mutate(cp = as.numeric(cp), base.imm = as.numeric(base.imm)) %>%
  distinct() %>% 
  filter(country == "Ecuador")

## get grid calculations
dat4E22 <- Ec_grid22 %>% 
  mutate(base.imm = as.numeric(base.imm), cp= as.numeric(cp))%>%
  mutate(relax = case_when(relax == 0.1 ~ "Infectiousness 110%",
                           relax == 0.3 ~ "Infectiousness 130%")) %>%
  mutate(deaths_10k_comp = deaths_100k_comp/10,
         deaths_10k = deaths_100k/10,
         da10k = pmax(0,deaths_10k_comp-deaths_10k)) %>%
  select(base.imm, cp, relax,Booster, da10k) %>%
  pivot_wider(values_from = da10k, names_from = Booster) %>% 
  mutate(comp10k = Bivalent-Monovalent, gain = round(Bivalent/Monovalent,2))

plot4E22 <- dat4E22 %>% 
    filter(base.imm <= 0.9) %>%
  ggplot(aes(x = base.imm, y = cp)) + 
  geom_tile(aes(fill = gain)) + facet_wrap(~relax, ncol = 1) + theme_classic() +
# scale_fill_stepsn("Relative benefit\nof bivalent",colours = mycolors, 
#                     breaks = seq(-0.45,2.25,0.45), 
#                     limits=c(-.45,2.25),
#                     labels =c(-0.45,0,0.45,0.9,1.35,1.8,2.25),
#                     guide = "colorbar") +
  scale_fill_stepsn("Relative benefit\nof bivalent",colours = rev(mycolors), 
                    breaks = seq(1,8,0.5), 
                    limits=c(1,8),
                    labels =c(1,"",2,"",3,"",4,"",5,"",6,"",7,"",353),
                    guide = "colorbar")+
  geom_point(data = dataPlaces, color= "black", fill = "black", size = 2) +
  # geom_text_repel(data = dataPlaces, color= "black", fill = "white", size = 2, aes(label = country)) +
  guides(fill = guide_colourbar(title.position="top", title.hjust = 0.5)) + 
  scale_y_continuous("Cross protection",labels = 
          scales::percent_format(accuracy = 1), 
          breaks = c(0,0.3,0.6,0.9), expand = c(0,0)) +
  scale_x_continuous("Prior infection",labels = 
          scales::percent_format(accuracy = 1), 
          breaks = c(0,0.3,0.6,0.9), expand = c(0,0)) +
  ggtitle("Gains - adjust transmission","         Ecuador-like") +
    theme(axis.text = element_text(size = 11, color = "black"),
        axis.title = element_text(size = 12, color = "black"),
        axis.line = element_blank(),
        axis.ticks = element_line(color = "black"),
        plot.title = element_text(colour = "black", size = 13.5, face = "bold"),
        plot.subtitle = element_text(colour = "black", size = 12.5),
        plot.margin = unit(c(t=0.2, r=0.2, b=0.2, l=0.2), "cm"),
        legend.key.width= unit(0.95, 'cm'),
        legend.position = "none",
        #legend.position = "bottom", 
        plot.title.position = "plot",
        legend.title = element_text(size = 11, color = "black"),
        legend.text = element_text(size = 10, color = "black"),
        strip.text.x = element_text(colour = "black", size = 11, hjust = 0),
        strip.text.y = element_text(colour = "black", size = 10, hjust = 0),
        strip.background = element_rect(colour="white", fill="white"),
        panel.border = element_rect(colour = "black", fill=NA),
        panel.spacing = unit(0.3, "cm"), aspect.ratio=1)
plot4E22

```


#### 4I India
```{r}

dataPlaces <- ODE_ts22 %>% 
  select(cp, base.imm, country) %>% 
  mutate(cp = as.numeric(cp), base.imm = as.numeric(base.imm)) %>%
  distinct() %>% 
  filter(country == "India")

## get grid calculations
dat4I22 <- In_grid22 %>% 
  mutate(base.imm = as.numeric(base.imm), cp= as.numeric(cp))%>%
  mutate(relax = case_when(relax == 0.1 ~ "Infectiousness 110%",
                           relax == 0.3 ~ "Infectiousness 130%")) %>%
  mutate(deaths_10k_comp = deaths_100k_comp/10,
         deaths_10k = deaths_100k/10,
         da10k = pmax(0,deaths_10k_comp -deaths_10k)) %>%
  select(base.imm, cp, relax,Booster, da10k) %>%
  pivot_wider(values_from = da10k, names_from = Booster) %>% 
  mutate(comp10k = Bivalent-Monovalent, gain = round(Bivalent/Monovalent,2))

plot4I22 <- dat4I22 %>% 
    filter(base.imm <= 0.9) %>%
  ggplot(aes(x = base.imm, y = cp)) + 
  geom_tile(aes(fill = gain)) + facet_wrap(~relax, ncol = 1) + theme_classic() +
# scale_fill_stepsn("Relative benefit\nof bivalent",colours = mycolors, 
#                     breaks = seq(-0.45,2.25,0.45), 
#                     limits=c(-.45,2.25),
#                     labels =c(-0.45,0,0.45,0.9,1.35,1.8,2.25),
  scale_fill_stepsn("Relative benefit\nof bivalent",colours = rev(mycolors), 
                    breaks = seq(1,8,0.5), 
                    limits=c(1,8),
                    labels =c(1,"",2,"",3,"",4,"",5,"",6,"",7,"",353),
                    guide = "colorbar")+
  geom_point(data = dataPlaces, color= "black", fill = "black", size = 2) +
  # geom_text_repel(data = dataPlaces, color= "black", fill = "white", size = 2, aes(label = country)) +
  guides(fill = guide_colourbar(title.position="top", title.hjust = 0.5)) + 
  scale_y_continuous("Cross protection",labels = 
          scales::percent_format(accuracy = 1), 
          breaks = c(0,0.3,0.6,0.9), expand = c(0,0)) +
  scale_x_continuous("Prior infection",labels = 
          scales::percent_format(accuracy = 1), 
          breaks = c(0,0.3,0.6,0.9), expand = c(0,0)) +
  ggtitle("","         India-like") +
    theme(axis.text = element_text(size = 11, color = "black"),
        axis.title = element_text(size = 12, color = "black"),
        axis.line = element_blank(),
        axis.ticks = element_line(color = "black"),
        plot.title = element_text(colour = "black", size = 13.5, face = "bold"),
        plot.subtitle = element_text(colour = "black", size = 12.5),
        plot.margin = unit(c(t=0.2, r=0.2, b=0.2, l=0.2), "cm"),
        legend.key.width= unit(0.95, 'cm'),
        legend.position = "none",
        #legend.position = "bottom", 
        plot.title.position = "plot",
        legend.title = element_text(size = 11, color = "black"),
        legend.text = element_text(size = 10, color = "black"),
        strip.text.x = element_text(colour = "black", size = 11, hjust = 0),
        strip.text.y = element_text(colour = "black", size = 10, hjust = 0),
        strip.background = element_rect(colour="white", fill="white"),
        panel.border = element_rect(colour = "black", fill=NA),
        panel.spacing = unit(0.3, "cm"), aspect.ratio=1)
plot4I22


```


#### 4M Malaysia
```{r}

#colours = c("#d35c79", "#d69481","#dec0a3","#bccab4", "#7aaf97","#009593")

#mycolors <- colorRampPalette(brewer.pal(6, "Blues"))(nb.cols)

dataPlaces <- ODE_ts22 %>% 
  select(cp, base.imm, country) %>% 
  mutate(cp = as.numeric(cp), base.imm = as.numeric(base.imm)) %>%
  distinct() %>%
  filter(country == "Malaysia")

## get grid calculations
dat4M22 <- Ma_grid22 %>% 
  mutate(base.imm = as.numeric(base.imm), cp= as.numeric(cp))%>%
  mutate(relax = case_when(relax == 0.1 ~ "Infectiousness 110%",
                           relax == 0.3 ~ "Infectiousness 130%")) %>%
  mutate(deaths_10k_comp = deaths_100k_comp/10,
         deaths_10k = deaths_100k/10,
         da10k = pmax(0,deaths_10k_comp -deaths_10k)) %>%
  select(base.imm, cp, relax,Booster, da10k) %>%
  pivot_wider(values_from = da10k, names_from = Booster) %>% 
  mutate(comp10k = Bivalent-Monovalent, gain = round(Bivalent/Monovalent,2))

plot4M22 <- dat4M22 %>% 
  filter(base.imm <= 0.9) %>%
  ggplot(aes(x = base.imm, y = cp)) + 
  geom_tile(aes(fill = gain)) + facet_wrap(~relax, ncol = 1) + theme_classic() +
# scale_fill_stepsn("Relative benefit\nof bivalent",colours = mycolors, 
#                     breaks = seq(-0.45,2.25,0.45), 
#                     limits=c(-.45,2.25),
#                     #labels =c(-0.45,"",0,"",0.45,"",0.9,"",1.35,"",1.8,"",2.25),
#                     guide = "colorbar") +
  scale_fill_stepsn("Relative benefit\nof bivalent",colours = rev(mycolors), 
                    breaks = seq(1,8,0.5), 
                    limits=c(1,8),
                    labels =c(1,"",2,"",3,"",4,"",5,"",6,"",7,"",353),
                    guide = "colorbar")+
  geom_point(data = dataPlaces, color= "black", fill = "black", size = 2) +
  # geom_text_repel(data = dataPlaces, color= "black", fill = "white", size = 2, aes(label = country)) +
  guides(fill = guide_colourbar(title.position="top", title.hjust = 0.5)) + 
  scale_y_continuous("Cross protection",labels = 
          scales::percent_format(accuracy = 1), 
          breaks = c(0,0.3,0.6,0.9), expand = c(0,0)) +
  scale_x_continuous("Prior infection",labels = 
          scales::percent_format(accuracy = 1), 
          breaks = c(0,0.3,0.6,0.9), expand = c(0,0)) +
  ggtitle("","         Malaysia-like") +
    theme(axis.text = element_text(size = 11, color = "black"),
        axis.title = element_text(size = 12, color = "black"),
        axis.line = element_blank(),
        axis.ticks = element_line(color = "black"),
        plot.title = element_text(colour = "black", size = 13.5, face = "bold"),
        plot.subtitle = element_text(colour = "black", size = 12.5),
        plot.margin = unit(c(t=0.2, r=0.2, b=0.2, l=0.2), "cm"),
        legend.key.width= unit(0.5, 'cm'),
        legend.position = "right",
        #legend.position = "bottom", 
        plot.title.position = "plot",
        legend.title = element_text(size = 11, color = "black"),
        legend.text = element_text(size = 10, color = "black"),
        strip.text.x = element_text(colour = "black", size = 11, hjust = 0),
        strip.text.y = element_text(colour = "black", size = 10, hjust = 0),
        strip.background = element_rect(colour="white", fill="white"),
        panel.border = element_rect(colour = "black", fill=NA),
        panel.spacing = unit(0.3, "cm"), aspect.ratio=1)
plot4M22


```

#### Save fig. 4
```{r}

# plot4 <- plot_grid(plot4AE, plot4AI, plot4AM, plot4E, plot4I, plot4M, nrow = 2, labels = c("A","","","B","",""))
# 
# plot4A <- plot_grid(plot4AE, plot4AI, plot4AM, nrow = 1,
#                     rel_widths = c(1,1,1.57))
# plot4B <- plot_grid(plot4E, plot4I, plot4M, nrow = 1,
#                     rel_widths = c(1,1,1.45))

# plot4 <- plot_grid(plot4A, plot4B, nrow = 2, labels = c("A", "B"))

plot422 <- plot_grid(plot4E22,plot4I22,plot4M22, nrow = 1, rel_widths = c(1,1,1.51))
ggsave("../Supplement/S23-altbeta_matchABM_fig4.pdf", plot422, height = 6, width = 9.4)

```


### Deaths grid for S20 and S21
#### S24 - deaths per 10k grid
```{r}

mycolors <- rev(pnw_palette("Moth", n = 11))

dataPlaces <- ODE_ts20 %>% 
  select(cp, base.imm, country) %>% 
  mutate(cp = as.numeric(cp), base.imm = as.numeric(base.imm)) %>%
  distinct() %>% 
  filter(country == "Ecuador")

Ec_grid_noboost20 <- Ec_grid20 %>% 
  filter(Booster == "Bivalent") %>% ## just grab one set of runs
  mutate(base.imm = as.numeric(base.imm), cp= as.numeric(cp))%>%
  mutate(relax = case_when(relax == 0.1 ~ "110% Infectiousness",
                           relax == 0.3 ~ "130% Infectiousness")) %>%
  mutate(deaths_10k = deaths_100k_comp/10) %>%
  mutate(Booster = "No booster") %>% 
  select(base.imm, cp, relax, deaths_10k, Booster)


plot17E20 <- Ec_grid20  %>% 
  mutate(base.imm = as.numeric(base.imm), cp= as.numeric(cp))%>%
  mutate(relax = case_when(relax == 0.1 ~ "110% Infectiousness",
                           relax == 0.3 ~ "130% Infectiousness")) %>%
  mutate(deaths_10k = deaths_100k/10)  %>% 
  select(base.imm, cp, relax, deaths_10k, Booster) %>%
  rbind(Ec_grid_noboost20) %>%
      filter(base.imm <= 0.9) %>%
  ggplot(aes(x = base.imm, y = cp)) + 
  geom_tile(aes(fill = deaths_10k)) + facet_grid(Booster~relax) + 
  geom_point(data = dataPlaces, color= "black", fill = "black", size = 2) +
  #geom_text_repel(data = dataPlaces, color= "black", fill = "white", size = 2, aes(label = country)) +
  theme_classic() +
  scale_fill_stepsn("Deaths per 10,000",colors=mycolors,
                    breaks = seq(0,12,1), limits=c(0,12),
                    labels =c(0,"", 2, "", 4, "", 6, "", 8, "", 10,"",12)) +
  # scale_fill_stepsn("Deaths averted per 10,000",colors=mycolors, 
  #                   breaks = seq(0,1.6,0.1), limits=c(0,1.6),
  #                   labels =c(0,"",0.2,"",0.4,"",0.6,"",0.8,
  #                             "",1.0,"",1.2,"",1.4,"",1.6)) + 
  theme_classic() +
  guides(fill = guide_colourbar(title.position="top", title.hjust = 0.5)) + 
  scale_y_continuous("Cross protection",labels = 
          scales::percent_format(accuracy = 1), 
          breaks = c(0,0.3,0.6,0.9), expand = c(0,0)) +
  scale_x_continuous("Prior infection",labels = 
          scales::percent_format(accuracy = 1), 
          breaks = c(0,0.3,0.6,0.9), expand = c(0,0)) +
  ggtitle("Deaths per 10,000 - Recalibrated","         Ecuador-like") +
    theme(axis.text = element_text(size = 11, color = "black"),
        axis.title = element_text(size = 12, color = "black"),
        axis.line = element_blank(),
        axis.ticks = element_line(color = "black"),
        plot.title = element_text(colour = "black", size = 13.5, face = "bold"),
        plot.subtitle = element_text(colour = "black", size = 12.5),
        plot.margin = unit(c(t=0.2, r=0.2, b=0.2, l=0.2), "cm"),
        legend.key.width= unit(1.2, 'cm'),
        legend.position = "none", 
        plot.title.position = "plot",
        legend.title = element_text(size = 11, color = "black"),
        legend.text = element_text(size = 9, color = "black"),
        strip.text.x = element_text(colour = "black", size = 11, hjust = 0),
        strip.text.y = element_text(colour = "black", size = 10, hjust = 0),
        strip.background = element_rect(colour="white", fill="white"),
        panel.border = element_rect(colour = "black", fill=NA),
        panel.spacing = unit(0.3, "cm"), aspect.ratio=1)
plot17E20
```




```{r}

dataPlaces <- ODE_ts20 %>% 
  select(cp, base.imm, country) %>% 
  mutate(cp = as.numeric(cp), base.imm = as.numeric(base.imm)) %>%
  distinct() %>% 
  filter(country == "India")

In_grid_noboost20 <- In_grid20 %>% 
  filter(Booster == "Bivalent") %>% ## just grab one set of runs
  mutate(base.imm = as.numeric(base.imm), cp= as.numeric(cp))%>%
  mutate(relax = case_when(relax == 0.1 ~ "110% Infectiousness",
                           relax == 0.3 ~ "130% Infectiousness")) %>%
  mutate(deaths_10k = deaths_100k_comp/10) %>%
  mutate(Booster = "No booster") %>% 
  select(base.imm, cp, relax, deaths_10k, Booster)


plot17I20 <- In_grid20  %>% 
  mutate(base.imm = as.numeric(base.imm), cp= as.numeric(cp))%>%
  mutate(relax = case_when(relax == 0.1 ~ "110% Infectiousness",
                           relax == 0.3 ~ "130% Infectiousness")) %>%
  mutate(deaths_10k = deaths_100k/10)  %>% 
  select(base.imm, cp, relax, deaths_10k, Booster) %>%
  rbind(In_grid_noboost20) %>%
      filter(base.imm <= 0.9) %>%
  ggplot(aes(x = base.imm, y = cp)) + 
  geom_tile(aes(fill = deaths_10k)) + facet_grid(Booster~relax) + 
  geom_point(data = dataPlaces, color= "black", fill = "black", size = 2) +
  #geom_text_repel(data = dataPlaces, color= "black", fill = "white", size = 2, aes(label = country)) +
  theme_classic() +
  scale_fill_stepsn("Deaths per 10,000",colors=mycolors,
                    breaks = seq(0,12,1), limits=c(0,12),
                    labels =c(0,"", 2, "", 4, "", 6, "", 8, "", 10,"",12)) +
  # scale_fill_stepsn("Deaths averted per 10,000",colors=mycolors, 
  #                   breaks = seq(0,1.6,0.1), limits=c(0,1.6),
  #                   labels =c(0,"",0.2,"",0.4,"",0.6,"",0.8,
  #                             "",1.0,"",1.2,"",1.4,"",1.6)) + 
  theme_classic() +
  guides(fill = guide_colourbar(title.position="top", title.hjust = 0.5)) + 
  scale_y_continuous("Cross protection",labels = 
          scales::percent_format(accuracy = 1), 
          breaks = c(0,0.3,0.6,0.9), expand = c(0,0)) +
  scale_x_continuous("Prior infection",labels = 
          scales::percent_format(accuracy = 1), 
          breaks = c(0,0.3,0.6,0.9), expand = c(0,0)) +
  ggtitle("","         India-like") +
    theme(axis.text = element_text(size = 11, color = "black"),
        axis.title = element_text(size = 12, color = "black"),
        axis.line = element_blank(),
        axis.ticks = element_line(color = "black"),
        plot.title = element_text(colour = "black", size = 13.5, face = "bold"),
        plot.subtitle = element_text(colour = "black", size = 12.5),
        plot.margin = unit(c(t=0.2, r=0.2, b=0.2, l=0.2), "cm"),
        legend.key.width= unit(1.2, 'cm'),
        legend.position = "none", 
        plot.title.position = "plot",
        legend.title = element_text(size = 11, color = "black"),
        legend.text = element_text(size = 9, color = "black"),
        strip.text.x = element_text(colour = "black", size = 11, hjust = 0),
        strip.text.y = element_text(colour = "black", size = 10, hjust = 0),
        strip.background = element_rect(colour="white", fill="white"),
        panel.border = element_rect(colour = "black", fill=NA),
        panel.spacing = unit(0.3, "cm"), aspect.ratio=1)
plot17I20
```



```{r}

dataPlaces <- ODE_ts20 %>% 
  select(cp, base.imm, country) %>% 
  mutate(cp = as.numeric(cp), base.imm = as.numeric(base.imm)) %>%
  distinct() %>% 
  filter(country == "Malaysia")

Ma_grid_noboost20 <- Ma_grid20 %>% 
  filter(Booster == "Bivalent") %>% ## just grab one set of runs
  mutate(base.imm = as.numeric(base.imm), cp= as.numeric(cp))%>%
  mutate(relax = case_when(relax == 0.1 ~ "110% Infectiousness",
                           relax == 0.3 ~ "130% Infectiousness")) %>%
  mutate(deaths_10k = deaths_100k_comp/10) %>%
  mutate(Booster = "No booster") %>% 
  select(base.imm, cp, relax, deaths_10k, Booster)


plot17M20 <- Ma_grid20  %>% 
  mutate(base.imm = as.numeric(base.imm), cp= as.numeric(cp))%>%
  mutate(relax = case_when(relax == 0.1 ~ "110% Infectiousness",
                           relax == 0.3 ~ "130% Infectiousness")) %>%
  mutate(deaths_10k = deaths_100k/10)  %>% 
  select(base.imm, cp, relax, deaths_10k, Booster) %>%
  rbind(Ma_grid_noboost20) %>%
      filter(base.imm <= 0.9) %>%
  ggplot(aes(x = base.imm, y = cp)) + 
  geom_tile(aes(fill = deaths_10k)) + facet_grid(Booster~relax) +
  geom_point(data = dataPlaces, color= "black", fill = "black", size = 2) +
  #geom_text_repel(data = dataPlaces, color= "black", fill = "white", size = 2, aes(label = country)) +
  theme_classic() +
  scale_fill_stepsn("Deaths per 10,000",colors=mycolors,
                    breaks = seq(0,12,1), limits=c(0,12),
                    labels =c(0,"", 2, "", 4, "", 6, "", 8, "", 10,"",12)) +
  # scale_fill_stepsn("Deaths averted per 10,000",colors=mycolors, 
  #                   breaks = seq(0,1.6,0.1), limits=c(0,1.6),
  #                   labels =c(0,"",0.2,"",0.4,"",0.6,"",0.8,
  #                             "",1.0,"",1.2,"",1.4,"",1.6)) + 
  theme_classic() +
  guides(fill = guide_colourbar(title.position="top", title.hjust = 0.5)) + 
  scale_y_continuous("Cross protection",labels = 
          scales::percent_format(accuracy = 1), 
          breaks = c(0,0.3,0.6,0.9), expand = c(0,0)) +
  scale_x_continuous("Prior infection",labels = 
          scales::percent_format(accuracy = 1), 
          breaks = c(0,0.3,0.6,0.9), expand = c(0,0)) +
  ggtitle("","         Malaysia-like") +
    theme(axis.text = element_text(size = 11, color = "black"),
        axis.title = element_text(size = 12, color = "black"),
        axis.line = element_blank(),
        axis.ticks = element_line(color = "black"),
        plot.title = element_text(colour = "black", size = 13.5, face = "bold"),
        plot.subtitle = element_text(colour = "black", size = 12.5),
        plot.margin = unit(c(t=0.2, r=0.2, b=0.2, l=0.2), "cm"),
        legend.key.width= unit(0.5, 'cm'),
        legend.position = "right", 
        plot.title.position = "plot",
        legend.title = element_text(size = 11, color = "black"),
        legend.text = element_text(size = 9, color = "black"),
        strip.text.x = element_text(colour = "black", size = 11, hjust = 0),
        strip.text.y = element_text(colour = "black", size = 10, hjust = 0),
        strip.background = element_rect(colour="white", fill="white"),
        panel.border = element_rect(colour = "black", fill=NA),
        panel.spacing = unit(0.3, "cm"), aspect.ratio=1)
plot17M20
```

```{r}
plot3B1720 <- plot_grid(plot17E20,plot17I20,plot17M20, nrow = 1, rel_widths = c(1,1,1.8))
ggsave("../Supplement/S24_ODEdeaths10k.pdf", plot3B1720, height = 6, width = 16)
```



### Deaths grid for S22 and S23
#### S25 - deaths per 10k grid
```{r}

mycolors <- rev(pnw_palette("Moth", n = 11))

dataPlaces <- ODE_ts22 %>% 
  select(cp, base.imm, country) %>% 
  mutate(cp = as.numeric(cp), base.imm = as.numeric(base.imm)) %>%
  distinct() %>% 
  filter(country == "Ecuador")

Ec_grid_noboost22 <- Ec_grid22 %>% 
  filter(Booster == "Bivalent") %>% ## just grab one set of runs
  mutate(base.imm = as.numeric(base.imm), cp= as.numeric(cp))%>%
  mutate(relax = case_when(relax == 0.1 ~ "110% Infectiousness",
                           relax == 0.3 ~ "130% Infectiousness")) %>%
  mutate(deaths_10k = deaths_100k_comp/10) %>%
  mutate(Booster = "No booster") %>% 
  select(base.imm, cp, relax, deaths_10k, Booster)


plot17E22 <- Ec_grid22  %>% 
  mutate(base.imm = as.numeric(base.imm), cp= as.numeric(cp))%>%
  mutate(relax = case_when(relax == 0.1 ~ "110% Infectiousness",
                           relax == 0.3 ~ "130% Infectiousness")) %>%
  mutate(deaths_10k = deaths_100k/10)  %>% 
  select(base.imm, cp, relax, deaths_10k, Booster) %>%
  rbind(Ec_grid_noboost22) %>%
      filter(base.imm <= 0.9) %>%
  ggplot(aes(x = base.imm, y = cp)) + 
  geom_tile(aes(fill = deaths_10k)) + facet_grid(Booster~relax) + 
  geom_point(data = dataPlaces, color= "black", fill = "black", size = 2) +
  #geom_text_repel(data = dataPlaces, color= "black", fill = "white", size = 2, aes(label = country)) +
  theme_classic() +
  scale_fill_stepsn("Deaths per 10,000",colors=mycolors,
                    breaks = seq(0,16,2), limits=c(0,16),
                    labels =c(0, 2, 4,6,8,10,12,14,16)) +
  # scale_fill_stepsn("Deaths averted per 10,000",colors=mycolors, 
  #                   breaks = seq(0,1.6,0.1), limits=c(0,1.6),
  #                   labels =c(0,"",0.2,"",0.4,"",0.6,"",0.8,
  #                             "",1.0,"",1.2,"",1.4,"",1.6)) + 
  theme_classic() +
  guides(fill = guide_colourbar(title.position="top", title.hjust = 0.5)) + 
  scale_y_continuous("Cross protection",labels = 
          scales::percent_format(accuracy = 1), 
          breaks = c(0,0.3,0.6,0.9), expand = c(0,0)) +
  scale_x_continuous("Prior infection",labels = 
          scales::percent_format(accuracy = 1), 
          breaks = c(0,0.3,0.6,0.9), expand = c(0,0)) +
  ggtitle("Deaths per 10,000 - adjust transmission","         Ecuador-like") +
    theme(axis.text = element_text(size = 11, color = "black"),
        axis.title = element_text(size = 12, color = "black"),
        axis.line = element_blank(),
        axis.ticks = element_line(color = "black"),
        plot.title = element_text(colour = "black", size = 13.5, face = "bold"),
        plot.subtitle = element_text(colour = "black", size = 12.5),
        plot.margin = unit(c(t=0.2, r=0.2, b=0.2, l=0.2), "cm"),
        legend.key.width= unit(1.2, 'cm'),
        legend.position = "none", 
        plot.title.position = "plot",
        legend.title = element_text(size = 11, color = "black"),
        legend.text = element_text(size = 9, color = "black"),
        strip.text.x = element_text(colour = "black", size = 11, hjust = 0),
        strip.text.y = element_text(colour = "black", size = 10, hjust = 0),
        strip.background = element_rect(colour="white", fill="white"),
        panel.border = element_rect(colour = "black", fill=NA),
        panel.spacing = unit(0.3, "cm"), aspect.ratio=1)
plot17E22
```




```{r}

dataPlaces <- ODE_ts22 %>% 
  select(cp, base.imm, country) %>% 
  mutate(cp = as.numeric(cp), base.imm = as.numeric(base.imm)) %>%
  distinct() %>% 
  filter(country == "India")

In_grid_noboost22 <- In_grid22 %>% 
  filter(Booster == "Bivalent") %>% ## just grab one set of runs
  mutate(base.imm = as.numeric(base.imm), cp= as.numeric(cp))%>%
  mutate(relax = case_when(relax == 0.1 ~ "110% Infectiousness",
                           relax == 0.3 ~ "130% Infectiousness")) %>%
  mutate(deaths_10k = deaths_100k_comp/10) %>%
  mutate(Booster = "No booster") %>% 
  select(base.imm, cp, relax, deaths_10k, Booster)


plot17I22 <- In_grid22  %>% 
  mutate(base.imm = as.numeric(base.imm), cp= as.numeric(cp))%>%
  mutate(relax = case_when(relax == 0.1 ~ "110% Infectiousness",
                           relax == 0.3 ~ "130% Infectiousness")) %>%
  mutate(deaths_10k = deaths_100k/10)  %>% 
  select(base.imm, cp, relax, deaths_10k, Booster) %>%
  rbind(In_grid_noboost22) %>%
      filter(base.imm <= 0.9) %>%
  ggplot(aes(x = base.imm, y = cp)) + 
  geom_tile(aes(fill = deaths_10k)) + facet_grid(Booster~relax) + 
  geom_point(data = dataPlaces, color= "black", fill = "black", size = 2) +
  #geom_text_repel(data = dataPlaces, color= "black", fill = "white", size = 2, aes(label = country)) +
  theme_classic() +
  scale_fill_stepsn("Deaths per 10,000",colors=mycolors,
                    breaks = seq(0,16,2), limits=c(0,16),
                    labels =c(0, 2, 4,6,8,10,12,14,16)) +
  # scale_fill_stepsn("Deaths averted per 10,000",colors=mycolors, 
  #                   breaks = seq(0,1.6,0.1), limits=c(0,1.6),
  #                   labels =c(0,"",0.2,"",0.4,"",0.6,"",0.8,
  #                             "",1.0,"",1.2,"",1.4,"",1.6)) + 
  theme_classic() +
  guides(fill = guide_colourbar(title.position="top", title.hjust = 0.5)) + 
  scale_y_continuous("Cross protection",labels = 
          scales::percent_format(accuracy = 1), 
          breaks = c(0,0.3,0.6,0.9), expand = c(0,0)) +
  scale_x_continuous("Prior infection",labels = 
          scales::percent_format(accuracy = 1), 
          breaks = c(0,0.3,0.6,0.9), expand = c(0,0)) +
  ggtitle("","         India-like") +
    theme(axis.text = element_text(size = 11, color = "black"),
        axis.title = element_text(size = 12, color = "black"),
        axis.line = element_blank(),
        axis.ticks = element_line(color = "black"),
        plot.title = element_text(colour = "black", size = 13.5, face = "bold"),
        plot.subtitle = element_text(colour = "black", size = 12.5),
        plot.margin = unit(c(t=0.2, r=0.2, b=0.2, l=0.2), "cm"),
        legend.key.width= unit(1.2, 'cm'),
        legend.position = "none", 
        plot.title.position = "plot",
        legend.title = element_text(size = 11, color = "black"),
        legend.text = element_text(size = 9, color = "black"),
        strip.text.x = element_text(colour = "black", size = 11, hjust = 0),
        strip.text.y = element_text(colour = "black", size = 10, hjust = 0),
        strip.background = element_rect(colour="white", fill="white"),
        panel.border = element_rect(colour = "black", fill=NA),
        panel.spacing = unit(0.3, "cm"), aspect.ratio=1)
plot17I22
```



```{r}

dataPlaces <- ODE_ts22 %>% 
  select(cp, base.imm, country) %>% 
  mutate(cp = as.numeric(cp), base.imm = as.numeric(base.imm)) %>%
  distinct() %>% 
  filter(country == "Malaysia")

Ma_grid_noboost22 <- Ma_grid22 %>% 
  filter(Booster == "Bivalent") %>% ## just grab one set of runs
  mutate(base.imm = as.numeric(base.imm), cp= as.numeric(cp))%>%
  mutate(relax = case_when(relax == 0.1 ~ "110% Infectiousness",
                           relax == 0.3 ~ "130% Infectiousness")) %>%
  mutate(deaths_10k = deaths_100k_comp/10) %>%
  mutate(Booster = "No booster") %>% 
  select(base.imm, cp, relax, deaths_10k, Booster)


plot17M22 <- Ma_grid22  %>% 
  mutate(base.imm = as.numeric(base.imm), cp= as.numeric(cp))%>%
  mutate(relax = case_when(relax == 0.1 ~ "110% Infectiousness",
                           relax == 0.3 ~ "130% Infectiousness")) %>%
  mutate(deaths_10k = deaths_100k/10)  %>% 
  select(base.imm, cp, relax, deaths_10k, Booster) %>%
  rbind(Ma_grid_noboost22) %>%
      filter(base.imm <= 0.9) %>%
  ggplot(aes(x = base.imm, y = cp)) + 
  geom_tile(aes(fill = deaths_10k)) + facet_grid(Booster~relax) +
  geom_point(data = dataPlaces, color= "black", fill = "black", size = 2) +
  #geom_text_repel(data = dataPlaces, color= "black", fill = "white", size = 2, aes(label = country)) +
  theme_classic() +
  scale_fill_stepsn("Deaths per 10,000",colors=mycolors,
                    breaks = seq(0,16,2), limits=c(0,16),
                    labels =c(0, 2, 4,6,8,10,12,14,16)) +
  # scale_fill_stepsn("Deaths averted per 10,000",colors=mycolors, 
  #                   breaks = seq(0,1.6,0.1), limits=c(0,1.6),
  #                   labels =c(0,"",0.2,"",0.4,"",0.6,"",0.8,
  #                             "",1.0,"",1.2,"",1.4,"",1.6)) + 
  theme_classic() +
  guides(fill = guide_colourbar(title.position="top", title.hjust = 0.5)) + 
  scale_y_continuous("Cross protection",labels = 
          scales::percent_format(accuracy = 1), 
          breaks = c(0,0.3,0.6,0.9), expand = c(0,0)) +
  scale_x_continuous("Prior infection",labels = 
          scales::percent_format(accuracy = 1), 
          breaks = c(0,0.3,0.6,0.9), expand = c(0,0)) +
  ggtitle("","         Malaysia-like") +
    theme(axis.text = element_text(size = 11, color = "black"),
        axis.title = element_text(size = 12, color = "black"),
        axis.line = element_blank(),
        axis.ticks = element_line(color = "black"),
        plot.title = element_text(colour = "black", size = 13.5, face = "bold"),
        plot.subtitle = element_text(colour = "black", size = 12.5),
        plot.margin = unit(c(t=0.2, r=0.2, b=0.2, l=0.2), "cm"),
        legend.key.width= unit(0.5, 'cm'),
        legend.position = "right", 
        plot.title.position = "plot",
        legend.title = element_text(size = 11, color = "black"),
        legend.text = element_text(size = 9, color = "black"),
        strip.text.x = element_text(colour = "black", size = 11, hjust = 0),
        strip.text.y = element_text(colour = "black", size = 10, hjust = 0),
        strip.background = element_rect(colour="white", fill="white"),
        panel.border = element_rect(colour = "black", fill=NA),
        panel.spacing = unit(0.3, "cm"), aspect.ratio=1)
plot17M22
```

```{r}
plot3B1722 <- plot_grid(plot17E22,plot17I22,plot17M22, nrow = 1, rel_widths = c(1,1,1.8))
ggsave("../Supplement/S25_ODEdeaths10k.pdf", plot3B1722, height = 6, width = 16)
```

## Change base wane
### Read data 
```{r}

## change time to date
start_sims <- as.Date("2020-03-15", "%Y-%m-%d") 

## ODE data ##
Ec_tswane <- read_csv("../Data/ODE Supplement/Ecuador_ts base.wane.csv") %>%
  mutate(country = "Ecuador") %>%
  rename(sd = sd0)
Ma_tswane <- read_csv("../Data/ODE Supplement/Malaysia_ts base.wane.csv") %>% 
  mutate(country = "Malaysia")
In_tswane <- read_csv("../Data/ODE Supplement/India_ts base.wane.csv") %>% 
  mutate(country = "India")

ODE_tswane <- rbind(Ec_tswane, Ma_tswane) %>% rbind(In_tswane)

Ec_dawane <- read_csv("../Data/ODE Supplement/Ecuador_run_da base.wane.csv")%>%
  mutate(country = "Ecuador")
Ma_dawane <- read_csv("../Data/ODE Supplement/Malaysia_run_da base.wane.csv")%>% 
  mutate(country = "Malaysia")
In_dawane <- read_csv("../Data/ODE Supplement/India_run_da base.wane.csv")%>% 
  mutate(country = "India")

ODE_dawane <- rbind(Ec_dawane, Ma_dawane) %>% rbind(In_dawane)

Ec_gridwane <- read_csv("../Data/ODE Supplement/Ecuador_grid_da base.wane.csv")
Ma_gridwane <- read_csv("../Data/ODE Supplement/Malaysia_grid_da base.wane.csv")
In_gridwane <- read_csv("../Data/ODE Supplement/India_grid_da base.wane.csv")
  
## WHO
start <- as.Date("2020-01-03", "%Y-%m-%d")

dataWHO <- read_csv("../Data/WHO_cases/WHO-COVID-19-global-data.csv") %>% 
  filter(Country %in% c("Ecuador", "India", "Malaysia")) %>% 
  arrange(Date_reported) %>% 
  mutate(time = difftime(as.Date(Date_reported, "%Y-%m-%d"), start, units = "days")) %>% 
  mutate(time = gsub(" days", "", time),
         time = as.numeric(time)) %>% 
  select(time, Country, New_cases, Cumulative_deaths) %>% 
  mutate(population = case_when(
    Country == "Ecuador" ~ 15735139,
    Country == "Malaysia" ~ 28552712,
    Country == "India"~ 1155561222
  )) %>% 
  mutate(infs_perc = New_cases/population,
         deaths_perc = Cumulative_deaths/population)

```

#### 3A - Infections

```{r}

colors <- c("#0D3660","#BD451D","#428740")

pop_vec <- dataWHO%>% select(population, country = Country) %>% distinct()

plot3Awane <- ODE_tswane %>% 
  left_join(pop_vec) %>% 
  filter((boost.speed == "fast" & boost.start==60) | Booster == "None") %>%
  #mutate(time = (time+900)/30) %>%
  mutate(time = start_sims + time + 900) %>%
  filter(time < start_sims + 1095) %>%
  filter(relax == 0.1 | relax == 0.3) %>% 
    mutate(SAR = recode(
    relax,
    `0.1` = "110%",
    `0.3` = "130%"
  )) %>%
  mutate(country = case_when(
    country == "Ecuador" ~ "Ecuador-like",
    country == "India" ~ "India-like",
    country == "Malaysia" ~ "Malaysia-like"
  )) %>%
  mutate(SAR = fct_relevel(SAR, c("110%", "130%"))) %>% 
  mutate(booster = gsub("None", "No booster", Booster)) %>% 
  mutate(booster = fct_relevel(booster, c("No booster","Monovalent", "Bivalent"))) %>% 
  filter(name== "Iall") %>% 
  mutate(Infectiousness = SAR) %>%
  ## don't want infections to be *100, want to use percent scale
  ggplot(aes(x = time,y=10000*value/(population), color = booster, group = interaction(country, booster, SAR))) +
  geom_line(aes(linetype = Infectiousness), size= 1.2) +
  scale_fill_manual("Booster type", values = colors) +
  scale_color_manual("Booster type", values = colors) +
  theme_classic() + ylab("Infections per 10,000") +
  facet_wrap(~country, scales = "free") + 
  ggh4x::facetted_pos_scales(y = list(
  country == "Ecuador-like" ~ scale_y_continuous(limits = c(0, 200), breaks = c(0,50,100,150,200)),
  country == "India-like" ~ scale_y_continuous(limits = c(0, NA),
                                          breaks = c(0,50,100,150,200,250,300,350)),
  country == "Malaysia-like" ~ scale_y_continuous(limits = c(0, 200), breaks = c(0,50,100,150,200)))) +
  #   country == "Ecuador" ~ scale_y_continuous(limits = c(0, NA), breaks = c(0,10,20,30,1000)),
  # country == "India" ~ scale_y_continuous(limits = c(0, NA),
  #                                         breaks = c(0,10,20,30,40,1000)),
  # country == "Malaysia" ~ scale_y_continuous(limits = c(0, NA), 
  #                                            breaks = c(0,15,30,45,60,75,1000)))) + 

  #scale_y_continuous("Infections per 10,000") + 
  #scale_x_continuous("Time (months)", expand = c(0,0.5), breaks = c(30,32,34,36)) +
    scale_x_date("Date", expand = c(0,0), date_breaks = "1 month", date_labels =  "%b %Y") + 
  ggtitle("Infections, 75% waned") + 
  theme(axis.text = element_text(size = 11, color = "black"),
               axis.text.x=element_text(angle=60, hjust=1),
        axis.title = element_text(size = 12, color = "black"),
        axis.line = element_line(color = "black"),
        axis.ticks = element_line(color = "black"),
        plot.title = element_text(colour = "black", size = 13.5, face = "bold"),
        plot.subtitle = element_text(colour = "black", size = 12.5),
        legend.position = "bottom", plot.title.position = "plot", 
        legend.title = element_text(size = 11, color = "black"),
        legend.text = element_text(size = 10, color = "black"),
        plot.margin = unit(c(t=0.2, r=1, b=0.2, l=1.5), "cm"),
        strip.text = element_text(colour = "black", size = 11, hjust = 0),
        strip.background = element_rect(colour="white", fill="white"),
        #panel.border = element_rect(colour = "black", fill=NA),
        panel.spacing = unit(0.5, "cm"))
plot3Awane
```


#### 3B - Deaths adverted grids

```{r}
 #mycolors <- met.brewer("Isfahan1", n = 20)[11:20]
# 
 mycolors <- c("#e0ecf4","#bfd3e6","#9ebcda","#8c96c6","#807dba","#6F5784",
               "#54436E","#403255","#2D223C","#19013b")

#mycolors <-met.brewer("Hokusai1", n = 44)[28:44]

#mycolors <- rev(met.brewer("Hokusai1", n = 11)[0:8])


dataPlaces <- ODE_tswane %>% 
  select(cp, base.imm, country) %>% 
  mutate(cp = as.numeric(cp), base.imm = as.numeric(base.imm)) %>%
  distinct() %>% 
  filter(country == "Ecuador")

plot3BEwane <- Ec_gridwane  %>% 
  mutate(base.imm = as.numeric(base.imm), cp= as.numeric(cp))%>%
  mutate(relax = case_when(relax == 0.1 ~ "Infectiousness 110%",
                           relax == 0.3 ~ "Infectiousness 130%")) %>%
  mutate(deaths_10k_comp = deaths_100k_comp/10,
         deaths_10k = deaths_100k/10, 
         da10K = pmax(0,deaths_10k_comp-deaths_10k)) %>%
  filter(base.imm <= 0.9) %>%
  ggplot(aes(x = base.imm, y = cp)) + 
  geom_tile(aes(fill = da10K)) + facet_grid(relax~Booster) + 
  geom_point(data = dataPlaces, color= "black", fill = "black", size = 2) +
  #geom_text_repel(data = dataPlaces, color= "black", fill = "white", size = 2, aes(label = country)) +
  theme_classic() +
  scale_fill_stepsn("Deaths averted per 10,000",colors=mycolors,
                    breaks = seq(0,2.4,0.3), limits=c(0,2.4),
                    labels =c(0,"",0.6,"",1.2,"",1.8,"",2.4)) +
  # scale_fill_stepsn("Deaths averted per 10,000",colors=mycolors, 
  #                   breaks = seq(0,1.6,0.1), limits=c(0,1.6),
  #                   labels =c(0,"",0.2,"",0.4,"",0.6,"",0.8,
  #                             "",1.0,"",1.2,"",1.4,"",1.6)) + 
  theme_classic() +
  guides(fill = guide_colourbar(title.position="top", title.hjust = 0.5)) + 
  scale_y_continuous("Cross protection",labels = 
          scales::percent_format(accuracy = 1), 
          breaks = c(0,0.3,0.6,0.9), expand = c(0,0)) +
  scale_x_continuous("Prior infection",labels = 
          scales::percent_format(accuracy = 1), 
          breaks = c(0,0.3,0.6,0.9), expand = c(0,0)) +
  ggtitle("Deaths averted, 75% waned","         Ecuador-like") +
    theme(axis.text = element_text(size = 11, color = "black"),
        axis.title = element_text(size = 12, color = "black"),
        axis.line = element_blank(),
        axis.ticks = element_line(color = "black"),
        plot.title = element_text(colour = "black", size = 13.5, face = "bold"),
        plot.subtitle = element_text(colour = "black", size = 12.5),
        plot.margin = unit(c(t=0.2, r=0.2, b=0.2, l=0.2), "cm"),
        legend.key.width= unit(1.2, 'cm'),
        legend.position = "bottom", plot.title.position = "plot",
        legend.title = element_text(size = 11, color = "black"),
        legend.text = element_text(size = 9, color = "black"),
        strip.text.x = element_text(colour = "black", size = 11, hjust = 0),
        strip.text.y = element_text(colour = "black", size = 10, hjust = 0),
        strip.background = element_rect(colour="white", fill="white"),
        panel.border = element_rect(colour = "black", fill=NA),
        panel.spacing = unit(0.3, "cm"), aspect.ratio=1)
plot3BEwane

dataPlaces <- ODE_tswane %>% 
  select(cp, base.imm, country) %>% 
  mutate(cp = as.numeric(cp), base.imm = as.numeric(base.imm)) %>%
  distinct() %>% 
  filter(country == "India")

mycolors <-met.brewer("Hokusai1", n = 44)[28:44]

plot3BIwane <- In_gridwane %>% 
  mutate(base.imm = as.numeric(base.imm), cp= as.numeric(cp))%>%
  mutate(relax = case_when(relax == 0.1 ~ "Infectiousness 110%",
                           relax == 0.3 ~ "Infectiousness 130%")) %>%
    mutate(deaths_10k_comp = deaths_100k_comp/10,
         deaths_10k = deaths_100k/10,
         da10K = pmax(0,deaths_10k_comp-deaths_10k)) %>%
  filter(base.imm <= 0.9) %>%
  ggplot(aes(x = base.imm, y = cp)) + 
  geom_tile(aes(fill = da10K)) + facet_grid(relax~Booster) + 
  geom_point(data = dataPlaces, color= "black", fill = "black", size = 2) +
  #geom_text_repel(data = dataPlaces, color= "black", fill = "white", size = 2, aes(label = country)) +
  scale_fill_stepsn("Deaths averted per 10,000",colors=mycolors,
                    breaks = seq(0,1.5,0.25), limits=c(0,1.5),
                    labels =c(0,"",0.5,"",1.0,"",1.5)) +
  # scale_fill_stepsn("Deaths averted per 10,000",colors=mycolors, 
  #                   breaks = seq(0,1.6,0.1), limits=c(0,1.6),
  #                   labels =c(0,"",0.2,"",0.4,"",0.6,"",0.8,
  #                             "",1.0,"",1.2,"",1.4,"",1.6)) + 
  theme_classic() +
    scale_y_continuous("Cross protection",labels = scales::percent_format(accuracy = 1), breaks = c(0,0.3,0.6,0.9), expand = c(0,0)) +
    scale_x_continuous("Prior infection",labels = scales::percent_format(accuracy = 1), breaks = c(0,0.3,0.6,0.9), expand = c(0,0)) +
  guides(fill = guide_colourbar(title.position="top", title.hjust = 0.5)) + 
    theme(axis.text = element_text(size = 11, color = "black"),
        axis.title = element_text(size = 12, color = "black"),
        axis.line = element_blank(),
        axis.ticks = element_line(color = "black"),
        plot.title = element_text(colour = "black", size = 13.5, face = "bold"),
        plot.subtitle = element_text(colour = "black", size = 12.5),
        plot.margin = unit(c(t=0.2, r=0.2, b=0.2, l=0.2), "cm"),
        legend.key.width= unit(1.2, 'cm'), legend.position = "bottom",
        legend.title = element_text(size = 11, color = "black"),
        legend.text = element_text(size = 9, color = "black"),
        strip.text.x = element_text(colour = "black", size = 11, hjust = 0),
        strip.text.y = element_text(colour = "black", size = 10, hjust = 0),
        strip.background = element_rect(colour="white", fill="white"),
        panel.border = element_rect(colour = "black", fill=NA),
        panel.spacing = unit(0.3, "cm"), aspect.ratio=1)+
  ggtitle(" ","India-like")
plot3BIwane

#mycolors <- met.brewer("VanGogh3", n = 10)
mycolors <- rev(met.brewer("Hokusai1", n = 11)[0:8])

#mycolors <-met.brewer("Hokusai1", n = 44)[28:44]


dataPlaces <- ODE_tswane %>% 
  select(cp, base.imm, country) %>% 
  mutate(cp = as.numeric(cp), base.imm = as.numeric(base.imm)) %>%
  distinct() %>% 
  filter(country == "Malaysia")

plot3BMwane <- Ma_gridwane %>% 
  mutate(base.imm = as.numeric(base.imm), cp= as.numeric(cp))%>%
  mutate(relax = case_when(relax == 0.1 ~ "Infectiousness 110%",
                           relax == 0.3 ~"Infectiousness 130%")) %>%
    mutate(deaths_10k_comp = deaths_100k_comp/10,
         deaths_10k = deaths_100k/10,
         da10K = pmax(0,deaths_10k_comp-deaths_10k)) %>%
  filter(base.imm <= 0.9) %>%
  ggplot(aes(x = base.imm, y = cp)) + 
  geom_tile(aes(fill = da10K)) + facet_grid(relax~Booster) + 
  geom_point(data = dataPlaces, color= "black", fill = "black", size = 2) +
  #geom_text_repel(data = dataPlaces, color= "black", fill = "white", size = 2, aes(label = country)) +
  scale_fill_stepsn("Deaths averted per 10,000",colors=mycolors,
                    breaks = seq(0,3.5,0.5), limits=c(0,3.5),
                    labels =c(0,"",1.0,"",2.0,"",3.0,"")) +
  # scale_fill_stepsn("Deaths averted per 10,000",colors=mycolors, 
  #                   breaks = seq(0,3.2,0.2), limits=c(0,3.2),
  #                   labels =c(0,"",0.4,"",0.8,"",1.2,"",1.6,
  #                             "",2.0,"",2.4,"",2.8,"",3.2)) + 
  theme_classic() +
  guides(fill = guide_colourbar(title.position="top", title.hjust = 0.5)) + 
  theme_classic() +
  scale_y_continuous("Cross protection",labels = scales::percent_format(accuracy = 1), breaks = c(0,0.3,0.6,0.9), expand = c(0,0)) +
    scale_x_continuous("Prior infection",labels = scales::percent_format(accuracy = 1), breaks = c(0,0.3,0.6,0.9), expand = c(0,0)) +
    theme(axis.text = element_text(size = 11, color = "black"),
        axis.title = element_text(size = 12, color = "black"),
        axis.line = element_blank(),
        axis.ticks = element_line(color = "black"),
        plot.title = element_text(colour = "black", size = 13.5, face = "bold"),
        plot.subtitle = element_text(colour = "black", size = 12.5),
        plot.margin = unit(c(t=0.2, r=0.2, b=0.2, l=0.2), "cm"),
        legend.key.width= unit(1.2, 'cm'),
        legend.position = "bottom",
        legend.title = element_text(size = 11, color = "black"),
        legend.text = element_text(size = 10, color = "black"),
        strip.text.x = element_text(colour = "black", size = 11, hjust = 0),
        strip.text.y = element_text(colour = "black", size = 10, hjust = 0),
        strip.background = element_rect(colour="white", fill="white"),
        panel.border = element_rect(colour = "black", fill=NA),
        panel.spacing = unit(0.3, "cm"), aspect.ratio=1)+
  ggtitle(" ","Malaysia-like")
plot3BMwane
```


#### Save figure 3
```{r}
plot3Bwane <- plot_grid(plot3BEwane,plot3BIwane,plot3BMwane, nrow = 1)
plot3Bwane <- plot_grid(NULL,plot3Bwane,ncol=2, rel_widths = c(0.03,1))
plot3wane <- plot_grid(plot3Awane,plot3Bwane, nrow = 2, labels = c("A", "B"),
                     rel_heights = c(0.7, 1))
ggsave("../Supplement/S27-waning_fig3.pdf", plot3wane, height = 9, width = 13)
```



#### 4E Ecuador
```{r}

#mycolors<-colorRampPalette(c("#d35c79", "#d69481","#c9b1cf","#bccab4", "#7aaf97","#009593"))(21)[-c(1,2,3,4,5,6,7,8,11)]

# mycolors<-(colorRampPalette(rev(c("#009b9f", "#43b7b9","#a7d3d5", "#e4c1d8","#d691c1","#c75daa"))))(21)[-c(1,2,3,4,5,6,7,8,11)]

#mycolors <- c("#DADAEB", "#E0F3F8","#ABD9E9","#74ADD1","#4575B4","#313695")

mycolors <- c("#011f4b", "#0f345f", "#1f4972", "#326085", "#467798", "#5d88a6", "#7499b4", "#8aaac3", "#a4b8d0", "#bdc7db", "#d3d7e7", "#e8e8f2","#fbdfba", "#F5AE52")

dataPlaces <- ODE_tswane %>% 
  select(cp, base.imm, country) %>% 
  mutate(cp = as.numeric(cp), base.imm = as.numeric(base.imm)) %>%
  distinct() %>% 
  filter(country == "Ecuador")

## get grid calculations
dat4Ewane <- Ec_gridwane %>% 
  mutate(base.imm = as.numeric(base.imm), cp= as.numeric(cp))%>%
  mutate(relax = case_when(relax == 0.1 ~ "Infectiousness 110%",
                           relax == 0.3 ~ "Infectiousness 130%")) %>%
  mutate(deaths_10k_comp = deaths_100k_comp/10,
         deaths_10k = deaths_100k/10,
         da10k = pmax(0,deaths_10k_comp-deaths_10k)) %>%
  select(base.imm, cp, relax,Booster, da10k) %>%
  pivot_wider(values_from = da10k, names_from = Booster) %>% 
  mutate(comp10k = Bivalent-Monovalent, gain = round(Bivalent/Monovalent,2))

plot4Ewane <- dat4Ewane %>% 
    filter(base.imm <= 0.9) %>%
  ggplot(aes(x = base.imm, y = cp)) + 
  geom_tile(aes(fill = gain)) + facet_wrap(~relax, ncol = 1) + theme_classic() +
# scale_fill_stepsn("Relative benefit\nof bivalent",colours = mycolors, 
#                     breaks = seq(-0.45,2.25,0.45), 
#                     limits=c(-.45,2.25),
#                     labels =c(-0.45,0,0.45,0.9,1.35,1.8,2.25),
#                     guide = "colorbar") +
  scale_fill_stepsn("Relative benefit\nof bivalent",colours = rev(mycolors), 
                    breaks = seq(1,8,0.5), 
                    limits=c(1,8),
                    labels =c(1,"",2,"",3,"",4,"",5,"",6,"",7,"",8),
                    guide = "colorbar")+
  geom_point(data = dataPlaces, color= "black", fill = "black", size = 2) +
  # geom_text_repel(data = dataPlaces, color= "black", fill = "white", size = 2, aes(label = country)) +
  guides(fill = guide_colourbar(title.position="top", title.hjust = 0.5)) + 
  scale_y_continuous("Cross protection",labels = 
          scales::percent_format(accuracy = 1), 
          breaks = c(0,0.3,0.6,0.9), expand = c(0,0)) +
  scale_x_continuous("Prior infection",labels = 
          scales::percent_format(accuracy = 1), 
          breaks = c(0,0.3,0.6,0.9), expand = c(0,0)) +
  ggtitle("Gains - 75% waned","         Ecuador-like") +
    theme(axis.text = element_text(size = 11, color = "black"),
        axis.title = element_text(size = 12, color = "black"),
        axis.line = element_blank(),
        axis.ticks = element_line(color = "black"),
        plot.title = element_text(colour = "black", size = 13.5, face = "bold"),
        plot.subtitle = element_text(colour = "black", size = 12.5),
        plot.margin = unit(c(t=0.2, r=0.2, b=0.2, l=0.2), "cm"),
        legend.key.width= unit(0.95, 'cm'),
        legend.position = "none",
        #legend.position = "bottom", 
        plot.title.position = "plot",
        legend.title = element_text(size = 11, color = "black"),
        legend.text = element_text(size = 10, color = "black"),
        strip.text.x = element_text(colour = "black", size = 11, hjust = 0),
        strip.text.y = element_text(colour = "black", size = 10, hjust = 0),
        strip.background = element_rect(colour="white", fill="white"),
        panel.border = element_rect(colour = "black", fill=NA),
        panel.spacing = unit(0.3, "cm"), aspect.ratio=1)
plot4Ewane

```


#### 4I India
```{r}

dataPlaces <- ODE_tswane %>% 
  select(cp, base.imm, country) %>% 
  mutate(cp = as.numeric(cp), base.imm = as.numeric(base.imm)) %>%
  distinct() %>% 
  filter(country == "India")

## get grid calculations
dat4Iwane <- In_gridwane %>% 
  mutate(base.imm = as.numeric(base.imm), cp= as.numeric(cp))%>%
  mutate(relax = case_when(relax == 0.1 ~ "Infectiousness 110%",
                           relax == 0.3 ~ "Infectiousness 130%")) %>%
  mutate(deaths_10k_comp = deaths_100k_comp/10,
         deaths_10k = deaths_100k/10,
         da10k = pmax(0,deaths_10k_comp -deaths_10k)) %>%
  select(base.imm, cp, relax,Booster, da10k) %>%
  pivot_wider(values_from = da10k, names_from = Booster) %>% 
  mutate(comp10k = Bivalent-Monovalent, gain = round(Bivalent/Monovalent,2))

plot4Iwane <- dat4Iwane %>% 
    filter(base.imm <= 0.9) %>%
  ggplot(aes(x = base.imm, y = cp)) + 
  geom_tile(aes(fill = gain)) + facet_wrap(~relax, ncol = 1) + theme_classic() +
# scale_fill_stepsn("Relative benefit\nof bivalent",colours = mycolors, 
#                     breaks = seq(-0.45,2.25,0.45), 
#                     limits=c(-.45,2.25),
#                     labels =c(-0.45,0,0.45,0.9,1.35,1.8,2.25),
#                     guide = "colorbar") +
  scale_fill_stepsn("Relative benefit\nof bivalent",colours = rev(mycolors), 
                    breaks = seq(1,8,0.5), 
                    limits=c(1,8),
                    labels =c(1,"",2,"",3,"",4,"",5,"",6,"",7,"",8),
                    guide = "colorbar")+
  geom_point(data = dataPlaces, color= "black", fill = "black", size = 2) +
  # geom_text_repel(data = dataPlaces, color= "black", fill = "white", size = 2, aes(label = country)) +
  guides(fill = guide_colourbar(title.position="top", title.hjust = 0.5)) + 
  scale_y_continuous("Cross protection",labels = 
          scales::percent_format(accuracy = 1), 
          breaks = c(0,0.3,0.6,0.9), expand = c(0,0)) +
  scale_x_continuous("Prior infection",labels = 
          scales::percent_format(accuracy = 1), 
          breaks = c(0,0.3,0.6,0.9), expand = c(0,0)) +
  ggtitle("","         India-like") +
    theme(axis.text = element_text(size = 11, color = "black"),
        axis.title = element_text(size = 12, color = "black"),
        axis.line = element_blank(),
        axis.ticks = element_line(color = "black"),
        plot.title = element_text(colour = "black", size = 13.5, face = "bold"),
        plot.subtitle = element_text(colour = "black", size = 12.5),
        plot.margin = unit(c(t=0.2, r=0.2, b=0.2, l=0.2), "cm"),
        legend.key.width= unit(0.95, 'cm'),
        legend.position = "none",
        #legend.position = "bottom", 
        plot.title.position = "plot",
        legend.title = element_text(size = 11, color = "black"),
        legend.text = element_text(size = 10, color = "black"),
        strip.text.x = element_text(colour = "black", size = 11, hjust = 0),
        strip.text.y = element_text(colour = "black", size = 10, hjust = 0),
        strip.background = element_rect(colour="white", fill="white"),
        panel.border = element_rect(colour = "black", fill=NA),
        panel.spacing = unit(0.3, "cm"), aspect.ratio=1)
plot4Iwane


```


#### 4M Malaysia
```{r}

#colours = c("#d35c79", "#d69481","#dec0a3","#bccab4", "#7aaf97","#009593")

#mycolors <- colorRampPalette(brewer.pal(6, "Blues"))(nb.cols)

dataPlaces <- ODE_tswane %>% 
  select(cp, base.imm, country) %>% 
  mutate(cp = as.numeric(cp), base.imm = as.numeric(base.imm)) %>%
  distinct() %>%
  filter(country == "Malaysia")

## get grid calculations
dat4Mwane <- Ma_gridwane %>% 
  mutate(base.imm = as.numeric(base.imm), cp= as.numeric(cp))%>%
  mutate(relax = case_when(relax == 0.1 ~ "Infectiousness 110%",
                           relax == 0.3 ~ "Infectiousness 130%")) %>%
  mutate(deaths_10k_comp = deaths_100k_comp/10,
         deaths_10k = deaths_100k/10,
         da10k = pmax(0,deaths_10k_comp -deaths_10k)) %>%
  select(base.imm, cp, relax,Booster, da10k) %>%
  pivot_wider(values_from = da10k, names_from = Booster) %>% 
  mutate(comp10k = Bivalent-Monovalent, gain = round(Bivalent/Monovalent,2))

plot4Mwane <- dat4Mwane %>% 
  filter(base.imm <= 0.9) %>%
  ggplot(aes(x = base.imm, y = cp)) + 
  geom_tile(aes(fill = gain)) + facet_wrap(~relax, ncol = 1) + theme_classic() +
# scale_fill_stepsn("Relative benefit\nof bivalent",colours = mycolors, 
#                     breaks = seq(-0.45,2.25,0.45), 
#                     limits=c(-.45,2.25),
#                     #labels =c(-0.45,"",0,"",0.45,"",0.9,"",1.35,"",1.8,"",2.25),
#                     guide = "colorbar") +
  scale_fill_stepsn("Relative benefit\nof bivalent",colours = rev(mycolors), 
                    breaks = seq(1,8,0.5), 
                    limits=c(1,8),
                    labels =c(1,"",2,"",3,"",4,"",5,"",6,"",7,"",8),
                    guide = "colorbar")+
  geom_point(data = dataPlaces, color= "black", fill = "black", size = 2) +
  # geom_text_repel(data = dataPlaces, color= "black", fill = "white", size = 2, aes(label = country)) +
  guides(fill = guide_colourbar(title.position="top", title.hjust = 0.5)) + 
  scale_y_continuous("Cross protection",labels = 
          scales::percent_format(accuracy = 1), 
          breaks = c(0,0.3,0.6,0.9), expand = c(0,0)) +
  scale_x_continuous("Prior infection",labels = 
          scales::percent_format(accuracy = 1), 
          breaks = c(0,0.3,0.6,0.9), expand = c(0,0)) +
  ggtitle("","         Malaysia-like") +
    theme(axis.text = element_text(size = 11, color = "black"),
        axis.title = element_text(size = 12, color = "black"),
        axis.line = element_blank(),
        axis.ticks = element_line(color = "black"),
        plot.title = element_text(colour = "black", size = 13.5, face = "bold"),
        plot.subtitle = element_text(colour = "black", size = 12.5),
        plot.margin = unit(c(t=0.2, r=0.2, b=0.2, l=0.2), "cm"),
        legend.key.width= unit(0.5, 'cm'),
        legend.position = "right",
        #legend.position = "bottom", 
        plot.title.position = "plot",
        legend.title = element_text(size = 11, color = "black"),
        legend.text = element_text(size = 10, color = "black"),
        strip.text.x = element_text(colour = "black", size = 11, hjust = 0),
        strip.text.y = element_text(colour = "black", size = 10, hjust = 0),
        strip.background = element_rect(colour="white", fill="white"),
        panel.border = element_rect(colour = "black", fill=NA),
        panel.spacing = unit(0.3, "cm"), aspect.ratio=1)
plot4Mwane


```

#### Save fig. 4
```{r}

# plot4 <- plot_grid(plot4AE, plot4AI, plot4AM, plot4E, plot4I, plot4M, nrow = 2, labels = c("A","","","B","",""))
# 
# plot4A <- plot_grid(plot4AE, plot4AI, plot4AM, nrow = 1,
#                     rel_widths = c(1,1,1.57))
# plot4B <- plot_grid(plot4E, plot4I, plot4M, nrow = 1,
#                     rel_widths = c(1,1,1.45))

# plot4 <- plot_grid(plot4A, plot4B, nrow = 2, labels = c("A", "B"))

plot4wane <- plot_grid(plot4Ewane,plot4Iwane,plot4Mwane, nrow = 1, rel_widths = c(1,1,1.51))
ggsave("../Supplement/S29-waning_fig4.pdf", plot4wane, height = 6, width = 9.4)

```



#### Deaths grid for base wane
##### S30 - deaths per 10k grid
```{r}

mycolors <- rev(pnw_palette("Moth", n = 11))

dataPlaces <- ODE_tswane %>% 
  select(cp, base.imm, country) %>% 
  mutate(cp = as.numeric(cp), base.imm = as.numeric(base.imm)) %>%
  distinct() %>% 
  filter(country == "Ecuador")

Ec_grid_noboostwane <- Ec_gridwane %>% 
  filter(Booster == "Bivalent") %>% ## just grab one set of runs
  mutate(base.imm = as.numeric(base.imm), cp= as.numeric(cp))%>%
  mutate(relax = case_when(relax == 0.1 ~ "110% Infectiousness",
                           relax == 0.3 ~ "130% Infectiousness")) %>%
  mutate(deaths_10k = deaths_100k_comp/10) %>%
  mutate(Booster = "No booster") %>% 
  select(base.imm, cp, relax, deaths_10k, Booster)


plot17Ewane <- Ec_gridwane  %>% 
  mutate(base.imm = as.numeric(base.imm), cp= as.numeric(cp))%>%
  mutate(relax = case_when(relax == 0.1 ~ "110% Infectiousness",
                           relax == 0.3 ~ "130% Infectiousness")) %>%
  mutate(deaths_10k = deaths_100k/10)  %>% 
  select(base.imm, cp, relax, deaths_10k, Booster) %>%
  rbind(Ec_grid_noboostwane) %>%
      filter(base.imm <= 0.9) %>%
  ggplot(aes(x = base.imm, y = cp)) + 
  geom_tile(aes(fill = deaths_10k)) + facet_grid(Booster~relax) + 
  geom_point(data = dataPlaces, color= "black", fill = "black", size = 2) +
  #geom_text_repel(data = dataPlaces, color= "black", fill = "white", size = 2, aes(label = country)) +
  theme_classic() +
  scale_fill_stepsn("Deaths per 10,000",colors=mycolors,
                    breaks = seq(0,12,2), limits=c(0,12),
                    labels =c(0, 2, 4,6,8,10,12)) +
  # scale_fill_stepsn("Deaths averted per 10,000",colors=mycolors, 
  #                   breaks = seq(0,1.6,0.1), limits=c(0,1.6),
  #                   labels =c(0,"",0.2,"",0.4,"",0.6,"",0.8,
  #                             "",1.0,"",1.2,"",1.4,"",1.6)) + 
  theme_classic() +
  guides(fill = guide_colourbar(title.position="top", title.hjust = 0.5)) + 
  scale_y_continuous("Cross protection",labels = 
          scales::percent_format(accuracy = 1), 
          breaks = c(0,0.3,0.6,0.9), expand = c(0,0)) +
  scale_x_continuous("Prior infection",labels = 
          scales::percent_format(accuracy = 1), 
          breaks = c(0,0.3,0.6,0.9), expand = c(0,0)) +
  ggtitle("Deaths per 10,000 - 75% waned","         Ecuador-like") +
    theme(axis.text = element_text(size = 11, color = "black"),
        axis.title = element_text(size = 12, color = "black"),
        axis.line = element_blank(),
        axis.ticks = element_line(color = "black"),
        plot.title = element_text(colour = "black", size = 13.5, face = "bold"),
        plot.subtitle = element_text(colour = "black", size = 12.5),
        plot.margin = unit(c(t=0.2, r=0.2, b=0.2, l=0.2), "cm"),
        legend.key.width= unit(1.2, 'cm'),
        legend.position = "none", 
        plot.title.position = "plot",
        legend.title = element_text(size = 11, color = "black"),
        legend.text = element_text(size = 9, color = "black"),
        strip.text.x = element_text(colour = "black", size = 11, hjust = 0),
        strip.text.y = element_text(colour = "black", size = 10, hjust = 0),
        strip.background = element_rect(colour="white", fill="white"),
        panel.border = element_rect(colour = "black", fill=NA),
        panel.spacing = unit(0.3, "cm"), aspect.ratio=1)
plot17Ewane
```




```{r}

dataPlaces <- ODE_tswane %>% 
  select(cp, base.imm, country) %>% 
  mutate(cp = as.numeric(cp), base.imm = as.numeric(base.imm)) %>%
  distinct() %>% 
  filter(country == "India")

In_grid_noboostwane <- In_gridwane %>% 
  filter(Booster == "Bivalent") %>% ## just grab one set of runs
  mutate(base.imm = as.numeric(base.imm), cp= as.numeric(cp))%>%
  mutate(relax = case_when(relax == 0.1 ~ "110% Infectiousness",
                           relax == 0.3 ~ "130% Infectiousness")) %>%
  mutate(deaths_10k = deaths_100k_comp/10) %>%
  mutate(Booster = "No booster") %>% 
  select(base.imm, cp, relax, deaths_10k, Booster)


plot17Iwane <- In_gridwane  %>% 
  mutate(base.imm = as.numeric(base.imm), cp= as.numeric(cp))%>%
  mutate(relax = case_when(relax == 0.1 ~ "110% Infectiousness",
                           relax == 0.3 ~ "130% Infectiousness")) %>%
  mutate(deaths_10k = deaths_100k/10)  %>% 
  select(base.imm, cp, relax, deaths_10k, Booster) %>%
  rbind(In_grid_noboostwane) %>%
      filter(base.imm <= 0.9) %>%
  ggplot(aes(x = base.imm, y = cp)) + 
  geom_tile(aes(fill = deaths_10k)) + facet_grid(Booster~relax) + 
  geom_point(data = dataPlaces, color= "black", fill = "black", size = 2) +
  #geom_text_repel(data = dataPlaces, color= "black", fill = "white", size = 2, aes(label = country)) +
  theme_classic() +
  scale_fill_stepsn("Deaths per 10,000",colors=mycolors,
                    breaks = seq(0,12,2), limits=c(0,12),
                    labels =c(0, 2, 4,6,8,10,12)) +
  # scale_fill_stepsn("Deaths averted per 10,000",colors=mycolors, 
  #                   breaks = seq(0,1.6,0.1), limits=c(0,1.6),
  #                   labels =c(0,"",0.2,"",0.4,"",0.6,"",0.8,
  #                             "",1.0,"",1.2,"",1.4,"",1.6)) + 
  theme_classic() +
  guides(fill = guide_colourbar(title.position="top", title.hjust = 0.5)) + 
  scale_y_continuous("Cross protection",labels = 
          scales::percent_format(accuracy = 1), 
          breaks = c(0,0.3,0.6,0.9), expand = c(0,0)) +
  scale_x_continuous("Prior infection",labels = 
          scales::percent_format(accuracy = 1), 
          breaks = c(0,0.3,0.6,0.9), expand = c(0,0)) +
  ggtitle("","         India-like") +
    theme(axis.text = element_text(size = 11, color = "black"),
        axis.title = element_text(size = 12, color = "black"),
        axis.line = element_blank(),
        axis.ticks = element_line(color = "black"),
        plot.title = element_text(colour = "black", size = 13.5, face = "bold"),
        plot.subtitle = element_text(colour = "black", size = 12.5),
        plot.margin = unit(c(t=0.2, r=0.2, b=0.2, l=0.2), "cm"),
        legend.key.width= unit(1.2, 'cm'),
        legend.position = "none", 
        plot.title.position = "plot",
        legend.title = element_text(size = 11, color = "black"),
        legend.text = element_text(size = 9, color = "black"),
        strip.text.x = element_text(colour = "black", size = 11, hjust = 0),
        strip.text.y = element_text(colour = "black", size = 10, hjust = 0),
        strip.background = element_rect(colour="white", fill="white"),
        panel.border = element_rect(colour = "black", fill=NA),
        panel.spacing = unit(0.3, "cm"), aspect.ratio=1)
plot17Iwane
```



```{r}

dataPlaces <- ODE_tswane %>% 
  select(cp, base.imm, country) %>% 
  mutate(cp = as.numeric(cp), base.imm = as.numeric(base.imm)) %>%
  distinct() %>% 
  filter(country == "Malaysia")

Ma_grid_noboostwane <- Ma_gridwane %>% 
  filter(Booster == "Bivalent") %>% ## just grab one set of runs
  mutate(base.imm = as.numeric(base.imm), cp= as.numeric(cp))%>%
  mutate(relax = case_when(relax == 0.1 ~ "110% Infectiousness",
                           relax == 0.3 ~ "130% Infectiousness")) %>%
  mutate(deaths_10k = deaths_100k_comp/10) %>%
  mutate(Booster = "No booster") %>% 
  select(base.imm, cp, relax, deaths_10k, Booster)


plot17Mwane <- Ma_gridwane  %>% 
  mutate(base.imm = as.numeric(base.imm), cp= as.numeric(cp))%>%
  mutate(relax = case_when(relax == 0.1 ~ "110% Infectiousness",
                           relax == 0.3 ~ "130% Infectiousness")) %>%
  mutate(deaths_10k = deaths_100k/10)  %>% 
  select(base.imm, cp, relax, deaths_10k, Booster) %>%
  rbind(Ma_grid_noboostwane) %>%
      filter(base.imm <= 0.9) %>%
  ggplot(aes(x = base.imm, y = cp)) + 
  geom_tile(aes(fill = deaths_10k)) + facet_grid(Booster~relax) +
  geom_point(data = dataPlaces, color= "black", fill = "black", size = 2) +
  #geom_text_repel(data = dataPlaces, color= "black", fill = "white", size = 2, aes(label = country)) +
  theme_classic() +
  scale_fill_stepsn("Deaths per 10,000",colors=mycolors,
                    breaks = seq(0,12,2), limits=c(0,12),
                    labels =c(0, 2, 4,6,8,10,12)) +
  # scale_fill_stepsn("Deaths averted per 10,000",colors=mycolors, 
  #                   breaks = seq(0,1.6,0.1), limits=c(0,1.6),
  #                   labels =c(0,"",0.2,"",0.4,"",0.6,"",0.8,
  #                             "",1.0,"",1.2,"",1.4,"",1.6)) + 
  theme_classic() +
  guides(fill = guide_colourbar(title.position="top", title.hjust = 0.5)) + 
  scale_y_continuous("Cross protection",labels = 
          scales::percent_format(accuracy = 1), 
          breaks = c(0,0.3,0.6,0.9), expand = c(0,0)) +
  scale_x_continuous("Prior infection",labels = 
          scales::percent_format(accuracy = 1), 
          breaks = c(0,0.3,0.6,0.9), expand = c(0,0)) +
  ggtitle("","         Malaysia-like") +
    theme(axis.text = element_text(size = 11, color = "black"),
        axis.title = element_text(size = 12, color = "black"),
        axis.line = element_blank(),
        axis.ticks = element_line(color = "black"),
        plot.title = element_text(colour = "black", size = 13.5, face = "bold"),
        plot.subtitle = element_text(colour = "black", size = 12.5),
        plot.margin = unit(c(t=0.2, r=0.2, b=0.2, l=0.2), "cm"),
        legend.key.width= unit(0.5, 'cm'),
        legend.position = "right", 
        plot.title.position = "plot",
        legend.title = element_text(size = 11, color = "black"),
        legend.text = element_text(size = 9, color = "black"),
        strip.text.x = element_text(colour = "black", size = 11, hjust = 0),
        strip.text.y = element_text(colour = "black", size = 10, hjust = 0),
        strip.background = element_rect(colour="white", fill="white"),
        panel.border = element_rect(colour = "black", fill=NA),
        panel.spacing = unit(0.3, "cm"), aspect.ratio=1)
plot17Mwane
```

```{r}
plot3B17wane <- plot_grid(plot17Ewane,plot17Iwane,plot17Mwane, nrow = 1, rel_widths = c(1,1,1.8))
ggsave("../Supplement/S30_ODEdeaths10k_wane.pdf", plot3B17wane, height = 6, width = 16)
```

## Tables
### Compare ODE and ABM main runs
#### Load data
```{r}
Ec_da_tab <- read_csv("../Data/ODE Main Runs/Ecuador_run_da.csv")%>%
  mutate(country = "Ecuador")
Ma_da_tab <- read_csv("../Data/ODE Main Runs/Malaysia_run_da.csv")%>% 
  mutate(country = "Malaysia")
In_da_tab <- read_csv("../Data/ODE Main Runs/India_run_da.csv")%>% 
  mutate(country = "India")

ODE_da_tab <- rbind(Ec_da_tab, Ma_da_tab) %>% rbind(In_da_tab)


pop_ABM_tab <- read_csv("../Data/ABM_Parameters_Data/Grid_Param.csv") %>% select(Name, child, adult, old) %>% 
  summarise(Name,start_pop = 2*(child + adult+ old)) %>% 
  distinct() %>% 
  arrange(Name) %>% 
  rename(country = Name)

dataAll_tab <- read_csv("../Data/ABM Main Runs/dataAll.csv") %>% 
  left_join(pop_ABM_tab) %>% 
  group_by(ID_runs, time) %>% 
  filter(cum_sum_Inf == max(cum_sum_Inf)) %>%
  ungroup() 
```

#### Calculate ABM deaths averted
Calculating the deaths averted

```{r}
df_compare_tab <-  dataAll_tab %>% 
  filter(boost == "no", vaccine_star == "no") %>% 
  filter(time >= 900) %>% 
  group_by(SAR, country, replicate) %>% 
  mutate(deaths10K = 10000*deaths_over_time/start_pop) %>%
  #mutate(deaths_high = max(deaths), deaths_low = min(deaths))
  summarise(
    death_compare_10K = max(deaths10K)-min(deaths10K)
  ) %>%
  ungroup()

df_avert_tab <- dataAll_tab %>% 
  filter(boost == "yes", vaccine_star == "no", boost_shape == "functional", speed=="fast") %>% 
  #filter(time >= 900/365) %>% 
  filter(time >= 900) %>%
  group_by(SAR, scenario, booster, country, replicate) %>% ## matching each booster scenario to a no booster scenario
  mutate(deaths10K = 10000*deaths_over_time/start_pop) %>%
  summarise(
    deaths_10K = max(deaths10K, na.rm = T)-min(deaths10K, na.rm = T)
  ) %>%
  ungroup()

df_avert_rr_tab <- left_join(df_avert_tab, df_compare_tab, by = c("SAR", "country", "replicate")) %>%
  group_by(SAR, country, booster, scenario, replicate) %>%
  mutate(da10K = death_compare_10K-deaths_10K,
         da_perc = da10K/death_compare_10K) %>%
ungroup() %>%
  select(
    SAR, country, replicate, scenario = scenario, booster = booster, death_compare_10K, deaths_10K, da10K, da_perc)

  

# df_avert_rr <- left_join(df_avert, df_compare, by = c("SAR", "country", "replicate")) %>% 
#   group_by(SAR, country, booster, scenario, replicate) %>% 
#   mutate(rr = deaths/death_compare,
#          da = 1-rr) %>%
# ungroup() %>% 
#   select(
#     SAR, country, replicate, scenario = scenario, booster = booster, da)


df_avert_rr_splitWT_tab <- df_avert_rr_tab %>% 
  filter(scenario %in% c("WTpenalty", "WTendpoint", "WTefficacy")) %>% 
  filter(booster == "Monovalent") %>% 
  mutate(booster = "Monovalent (WT)")
df_avert_rr_splitOm_tab <- df_avert_rr_tab %>% 
  filter(scenario %in% c("Ompenalty", "Omendpoint", "Omefficacy")) %>% 
  filter(booster == "Monovalent") %>% 
  mutate(booster = "Monovalent (Omicron)")

df_avert_rr2_tab <- df_avert_rr_tab %>%
  filter(booster == "Bivalent" | booster == "no booster" | booster == "No booster") %>%
  rbind(df_avert_rr_splitWT_tab) %>% 
  rbind(df_avert_rr_splitOm_tab)

rm(df_avert_rr_splitOm_tab, df_avert_rr_splitWT_tab)


dat2C_tab <- df_avert_rr2_tab %>% 
  mutate(Booster = fct_relevel(booster, "Monovalent")) %>% 
  mutate(SAR = recode(SAR,`0.427` = "100%",
    `0.4697` = "110%", `0.5551` = "130%")) %>%
  mutate(SAR = fct_relevel(SAR, c("100%", "110%", "130%"))) %>% 
  mutate(Scenario = recode(scenario, endpoint = "Same endpoint",
    efficacy = "Same efficacy", penalty = "History dependent",
    WTpenalty = "History dependent", Ompenalty = "History dependent",
    "no booster" = "No booster")) %>%
  filter(Scenario == "History dependent" | Scenario == "No booster") %>%
  filter(SAR != "100%") %>% mutate(Scenario = fct_relevel(Scenario, 
        c("Same endpoint", "Same efficacy", "History dependent"))) %>%
  group_by(SAR,country,Scenario,Booster,) %>%
  summarise(x  = smean.cl.normal(da10K), 
            name = c("Mean","Lower","Upper")) %>% ungroup() %>%
  pivot_wider(names_from = name, values_from = x) %>%
  mutate(Booster = fct_relevel(Booster, 
       c("Monovalent (WT)","Monovalent (Omicron)", "Bivalent")))

```

#### Homogenize format
```{r}
ODE_dat2C_tab <- ODE_da_tab %>% 
  filter(boost.start == "60",boost.speed == "fast", relax!=0) %>% 
  select(deaths_100k, deaths_100k_comp, Booster, country,relax) %>%
  mutate(Mean = (deaths_100k_comp/10)-(deaths_100k/10)) %>% 
  mutate(SAR = if_else(
    relax == 0.1, "110%", "130%"
  )) %>% 
  mutate(Booster = gsub("Monovalent", "Monovalent (WT)", Booster)) %>% 
  select(Country = country, SAR, Booster, HIM = Mean)

ABM_dat2C_tab <- dat2C_tab %>% 
  select(Country = country, SAR, Booster, HSM = Mean, Lower, Upper) %>% 
  left_join(ODE_dat2C_tab) %>% 
  select(Country, SAR, Booster, HIM, HSM, Lower, Upper) %>% 
  arrange(Country) %>% 
  mutate(HIM = round(HIM,2),
         HSM = round(HSM,2),
         Lower = round(Lower,2),
         Upper = round(Upper,2))

write_csv(ABM_dat2C_tab,"../Supplement Tables/Table_Compare_Deaths.csv")

```


### Deaths averted in alternate scenarios
```{r}
ODE_calibrated_R0 <- ODE_da20 %>% 
  filter(boost.start == "60",boost.speed == "fast", relax!=0) %>% 
  select(deaths_100k, deaths_100k_comp, Booster, country,relax) %>%
  mutate(Mean = (deaths_100k_comp/10)-(deaths_100k/10)) %>% 
  mutate(SAR = if_else(
    relax == 0.1, "110%", "130%"
  )) %>% 
  select(Country = country, SAR, Booster, HIM = Mean) %>% 
  mutate(Beta = "Change infectiousness, calibrated")

ABMR0 <- ODE_da22  %>% 
  filter(boost.start == "60",boost.speed == "fast", relax!=0) %>% 
  select(deaths_100k, deaths_100k_comp, Booster, country,relax) %>%
  mutate(Mean = (deaths_100k_comp/10)-(deaths_100k/10)) %>% 
  mutate(SAR = if_else(
    relax == 0.1, "110%", "130%"
  )) %>% 
  select(Country = country, SAR, Booster, HIM = Mean) %>% 
  mutate(Beta = "Change infectiousness, uncalibrated")

Main_R0 <- ODE_da_tab %>% 
  filter(boost.start == "60",boost.speed == "fast", relax!=0) %>% 
  select(deaths_100k, deaths_100k_comp, Booster, country,relax) %>%
  mutate(Mean = (deaths_100k_comp/10)-(deaths_100k/10)) %>% 
  mutate(SAR = if_else(
    relax == 0.1, "110%", "130%"
  )) %>% 
  select(Country = country, SAR, Booster, HIM = Mean) %>% 
  mutate(Beta = "Main text")

DA_Table_Ref <- rbind(ODE_calibrated_R0, ABMR0) %>% rbind(Main_R0) %>%
  mutate(HIM = round(HIM, 2)) %>%
  pivot_wider(names_from = Beta, values_from = HIM) %>% 
  select(1,2,3,6,5,4) %>%
  arrange(Country, SAR)

write_csv(DA_Table_Ref,"../Supplement Tables/Table_Compare_ODE_Scenarios.csv")

```


### Get relative benefit
```{r}

vax_through <- read_csv("../Supplement Tables/Table_vaccinate_through_omicron_rel_benefit.csv") %>% 
  mutate(Analysis = "Vaccinate through Omicron*")

slow_rollout <- read_csv("../Supplement Tables/Table_slow_rollout_rel_benefit.csv") %>% 
  mutate(Analysis = "Conservative vaccine rollout")

same_endpoint <- read_csv("../Supplement Tables/Table_same_endpoint_rel_benefit.csv") %>% 
  mutate(Analysis = "Same endpoint scenario")

same_efficacy <- read_csv("../Supplement Tables/Table_same_efficacy_rel_benefit.csv") %>% 
  mutate(Analysis = "Same efficacy scenario")

boost_Malaysia <- read_csv("../Supplement Tables/Table_boost_Malaysia_rel_benefit.csv") %>% 
  mutate(Analysis = "Boost like Malaysia")

full_relative_benefit <- rbind(same_efficacy, same_endpoint) %>% 
  rbind(slow_rollout) %>% rbind(vax_through) %>% rbind(boost_Malaysia) %>% 
  rename(Country = country) %>% 
  select(Country, Analysis, Booster, `Relative Benefit`) %>% 
  arrange(Country, Analysis, Booster) %>% 
  mutate(`Relative Benefit` = round(`Relative Benefit`, 2))

write_csv(full_relative_benefit, "../Supplement Tables/Table_full_relative_benefit.csv")


```



### Main text relative benefit

```{r}
pop_ABM <- read_csv("../Data/ABM_Parameters_Data/Grid_Param.csv") %>% select(Name, child, adult, old) %>% 
  summarise(Name,start_pop = 2*(child + adult+ old)) %>% 
  distinct() %>% 
  arrange(Name) %>% 
  rename(country = Name)

dataAll <- read_csv("../Data/ABM Main Runs/dataAll.csv") %>% 
  left_join(pop_ABM) %>% 
  group_by(ID_runs, time) %>% 
  filter(cum_sum_Inf == max(cum_sum_Inf)) %>%
  ungroup() 
```

```{r}
df_compare <-  dataAll %>% 
  filter(boost == "no", vaccine_star == "no") %>% 
  filter(time >= 900) %>% 
  group_by(SAR, country, replicate) %>% 
  mutate(deaths10K = 10000*deaths_over_time/start_pop) %>%
  #mutate(deaths_high = max(deaths), deaths_low = min(deaths))
  summarise(
    death_compare_10K = max(deaths10K)-min(deaths10K)
  ) %>%
  ungroup()

df_avert <- dataAll %>% 
  filter(boost == "yes", vaccine_star == "no", boost_shape == "functional", speed=="fast") %>% 
  #filter(time >= 900/365) %>% 
  filter(time >= 900) %>%
  group_by(SAR, scenario, booster, country, replicate) %>% ## matching each booster scenario to a no booster scenario
  mutate(deaths10K = 10000*deaths_over_time/start_pop) %>%
  summarise(
    deaths_10K = max(deaths10K, na.rm = T)-min(deaths10K, na.rm = T)
  ) %>%
  ungroup()

df_avert_rr <- left_join(df_avert, df_compare, by = c("SAR", "country", "replicate")) %>%
  group_by(SAR, country, booster, scenario, replicate) %>%
  mutate(da10K = death_compare_10K-deaths_10K,
         da_perc = da10K/death_compare_10K) %>%
ungroup() %>%
  select(
    SAR, country, replicate, scenario = scenario, booster = booster, death_compare_10K, deaths_10K, da10K, da_perc)

  

# df_avert_rr <- left_join(df_avert, df_compare, by = c("SAR", "country", "replicate")) %>% 
#   group_by(SAR, country, booster, scenario, replicate) %>% 
#   mutate(rr = deaths/death_compare,
#          da = 1-rr) %>%
# ungroup() %>% 
#   select(
#     SAR, country, replicate, scenario = scenario, booster = booster, da)


df_avert_rr_splitWT <- df_avert_rr %>% 
  filter(scenario %in% c("WTpenalty", "WTendpoint", "WTefficacy")) %>% 
  filter(booster == "Monovalent") %>% 
  mutate(booster = "Monovalent (WT)")
df_avert_rr_splitOm <- df_avert_rr %>% 
  filter(scenario %in% c("Ompenalty", "Omendpoint", "Omefficacy")) %>% 
  filter(booster == "Monovalent") %>% 
  mutate(booster = "Monovalent (Omicron)")

df_avert_rr2 <- df_avert_rr %>%
  filter(booster == "Bivalent" | booster == "no booster" | booster == "No booster") %>%
  rbind(df_avert_rr_splitWT) %>% 
  rbind(df_avert_rr_splitOm)

rm(df_avert_rr_splitOm, df_avert_rr_splitWT)

```

```{r}
dat_full <- df_avert_rr2 %>% 
  mutate(Booster = fct_relevel(booster, "Monovalent")) %>% 
  mutate(SAR = recode(SAR,`0.427` = "100%",
    `0.4697` = "110%", `0.5551` = "130%")) %>%
  mutate(SAR = fct_relevel(SAR, c("100%", "110%", "130%"))) %>% 
  mutate(Scenario = recode(scenario, endpoint = "Same endpoint",
    efficacy = "Same efficacy", penalty = "History dependent",
    WTpenalty = "History dependent", Ompenalty = "History dependent",
    "no booster" = "No booster")) %>%
  filter(Scenario == "History dependent" | Scenario == "No booster") %>%
  filter(SAR != "100%") %>% mutate(Scenario = fct_relevel(Scenario, 
        c("Same endpoint", "Same efficacy", "History dependent"))) %>%
  group_by(SAR,country,Scenario,Booster,) %>%
  summarise(x  = smean.cl.normal(da10K), 
            name = c("Mean","Lower","Upper")) %>% ungroup() %>%
  pivot_wider(names_from = name, values_from = x) %>%
  mutate(Booster = fct_relevel(Booster, 
       c("Monovalent (WT)","Monovalent (Omicron)", "Bivalent"))) %>%
  select(SAR, country, Scenario, Booster, Mean) %>% 
  #filter(Booster == "Monovalent (WT)" | Booster == "Bivalent") %>%
  pivot_wider(names_from = "Booster", values_from = "Mean") %>% 
  mutate(`Bivalent` = round(round(`Bivalent`,2)/round(`Monovalent (WT)`,2),2)) %>% 
  mutate(`Monovalent (Omicron)` = round(round(`Monovalent (Omicron)`,2)/round(`Monovalent (WT)`,2),2)) %>% 
  select(SAR, country, Scenario, `Bivalent`, `Monovalent (Omicron)`) %>% 
  pivot_longer(4:5, names_to = "Booster", values_to = "Relative Benefit")

write_csv(dat_full,"../Supplement Tables/Table_main_relative_benefit.csv")
```

### Infections averted ABM main text
<!-- #### Data -->
<!-- ```{r} -->

<!-- ## get ABM seed populations for each country ## -->
<!-- pop_ABM <- read_csv("../Data/ABM_Parameters_Data/Grid_Param.csv") %>% select(Name, child, adult, old) %>%  -->
<!--   summarise(Name,start_pop = 2*(child + adult+ old)) %>%  -->
<!--   distinct() %>%  -->
<!--   arrange(Name) %>%  -->
<!--   rename(country = Name) -->

<!-- dataAll <- read_csv("../Data/ABM Main Runs/dataAll.csv") %>%  -->
<!--   left_join(pop_ABM) %>% -->
<!--   group_by(ID_runs, time) %>%  -->
<!--   filter(cum_sum_Inf == max(cum_sum_Inf)) %>% -->
<!--   ungroup()  -->

<!-- df_compare_inf <-  dataAll %>%  -->
<!--   filter(boost == "no", vaccine_star == "no") %>%  -->
<!--   filter(time >= 900) %>%  -->
<!--   group_by(SAR, country, replicate) %>%  -->
<!--   mutate(infs10K = 10000*cum_sum_Inf/start_pop) %>% -->
<!--   #mutate(deaths_high = max(deaths), deaths_low = min(deaths)) -->
<!--   summarise( -->
<!--     infs_compare_10K = max(infs10K)-min(infs10K) -->
<!--   ) %>% -->
<!--   ungroup() -->

<!-- df_avert_inf <- dataAll %>%  -->
<!--   filter(boost == "yes", vaccine_star == "no", boost_shape == "functional", speed=="fast") %>%  -->
<!--   #filter(time >= 900/365) %>%  -->
<!--   filter(time >= 900) %>% -->
<!--   group_by(SAR, scenario, booster, country, replicate) %>% ## matching each booster scenario to a no booster scenario -->
<!--   mutate(infs10K = 10000*cum_sum_Inf/start_pop) %>% -->
<!--   summarise( -->
<!--     infs_10K = max(infs10K, na.rm = T)-min(infs10K, na.rm = T) -->
<!--   ) %>% -->
<!--   ungroup() -->

<!-- df_avert_rr_inf <- left_join(df_avert_inf, df_compare_inf, by = c("SAR", "country", "replicate")) %>% -->
<!--   group_by(SAR, country, booster, scenario, replicate) %>% -->
<!--   mutate(ia10K = infs_compare_10K-infs_10K, -->
<!--          ia_perc = ia10K/infs_compare_10K) %>% -->
<!-- ungroup() %>% -->
<!--   select( -->
<!--     SAR, country, replicate, scenario = scenario, booster = booster, infs_compare_10K, infs_10K, ia10K, ia_perc) -->



<!-- # df_avert_rr <- left_join(df_avert, df_compare, by = c("SAR", "country", "replicate")) %>%  -->
<!-- #   group_by(SAR, country, booster, scenario, replicate) %>%  -->
<!-- #   mutate(rr = deaths/death_compare, -->
<!-- #          da = 1-rr) %>% -->
<!-- # ungroup() %>%  -->
<!-- #   select( -->
<!-- #     SAR, country, replicate, scenario = scenario, booster = booster, da) -->


<!-- df_avert_rr_splitWT_infs <- df_avert_rr_inf %>%  -->
<!--   filter(scenario %in% c("WTpenalty", "WTendpoint", "WTefficacy")) %>%  -->
<!--   filter(booster == "Monovalent") %>%  -->
<!--   mutate(booster = "Monovalent (WT)") -->
<!-- df_avert_rr_splitOm_infs <- df_avert_rr_inf %>%  -->
<!--   filter(scenario %in% c("Ompenalty", "Omendpoint", "Omefficacy")) %>%  -->
<!--   filter(booster == "Monovalent") %>%  -->
<!--   mutate(booster = "Monovalent (Omicron)") -->

<!-- df_avert_rr2_infs <- df_avert_rr_inf %>% -->
<!--   filter(booster == "Bivalent" | booster == "no booster" | booster == "No booster") %>% -->
<!--   rbind(df_avert_rr_splitWT_infs) %>%  -->
<!--   rbind(df_avert_rr_splitOm_infs) -->

<!-- rm(df_avert_rr_splitOm_infs, df_avert_rr_splitWT_infs) -->

<!-- ``` -->

<!-- #### plot -->
<!-- ```{r} -->
<!-- colors <- c("#BC8400","#7C2529","#005B40") -->

<!-- comparisons <- list( c("Bivalent", "Monovalent (WT)"),  -->
<!--                         c("Bivalent", "Monovalent (Omicron)"),  -->
<!--                         c("Monovalent (WT)", "Monovalent (Omicron)")) -->

<!-- dat2C_infs <- df_avert_rr2_infs %>%  -->
<!--   mutate(Booster = fct_relevel(booster, "Monovalent")) %>%  -->
<!--   mutate(SAR = recode(SAR,`0.427` = "100%", -->
<!--     `0.4697` = "110%", `0.5551` = "130%")) %>% -->
<!--   mutate(SAR = fct_relevel(SAR, c("100%", "110%", "130%"))) %>%  -->
<!--   mutate(Scenario = recode(scenario, endpoint = "Same endpoint", -->
<!--     efficacy = "Same efficacy", penalty = "History dependent", -->
<!--     WTpenalty = "History dependent", Ompenalty = "History dependent", -->
<!--     "no booster" = "No booster")) %>% -->
<!--   filter(Scenario == "History dependent" | Scenario == "No booster") %>% -->
<!--   filter(SAR != "100%") %>% mutate(Scenario = fct_relevel(Scenario,  -->
<!--         c("Same endpoint", "Same efficacy", "History dependent"))) %>% -->
<!--   group_by(SAR,country,Scenario,Booster,) %>% -->
<!--   summarise(x  = smean.cl.normal(ia10K),  -->
<!--             name = c("Mean","Lower","Upper")) %>% ungroup() %>% -->
<!--   pivot_wider(names_from = name, values_from = x) %>% -->
<!--   mutate(Booster = fct_relevel(Booster,  -->
<!--        c("Monovalent (WT)","Monovalent (Omicron)", "Bivalent")))  -->

<!-- plot2C_infs <- dat2C_infs %>% ggplot(aes(x = SAR, fill = Booster, color = Booster, -->
<!--                      group = interaction(Booster, SAR, Scenario))) +  -->
<!--   geom_bar(aes(y=Mean), stat="identity", position=position_dodge(0.7),   -->
<!--            alpha=0.5, size = 0.6, width = 0.6) + theme_classic() + -->
<!--   geom_errorbar(aes(ymin  = Lower, ymax  = Upper), -->
<!--            stat="identity", position=position_dodge(0.7),   -->
<!--            size = 0.6, width = 0.3, show.legend=FALSE) +  -->
<!--   geom_text(aes(label = round(Mean, 0), y = Upper + 40), position=position_dodge(0.7), size = 3) + ## this line adds the labels -->
<!--   scale_fill_manual("Booster", values = colors) + -->
<!--   scale_color_manual("Booster", values = colors) + -->
<!--   facet_wrap(~country, scales = "free", nrow = 1) + -->
<!--   #scale_y_continuous("Deaths averted per 10,000", limits = c(0,4.7),  -->
<!--                      #expand = expansion(mult = c(0,0))) + -->
<!--   scale_y_continuous("Infections averted per 10,000", limits = c(0,1400),  -->
<!--                      expand = expansion(mult = c(0,0))) + -->
<!--   scale_x_discrete("Infectiousness relative to Omicron") + -->
<!--   ggtitle("Infections averted - History specific model") + #, subtitle = "Variant-specific model") +  -->
<!--   theme(axis.text = element_text(size = 11, color = "black"), -->
<!--         axis.title.x = element_text(size = 12, color = "black",vjust = -1), -->
<!--         axis.title.y = element_text(size = 12, color = "black",vjust = +3), -->
<!--         axis.line = element_line(color = "black"), -->
<!--         axis.ticks = element_line(color = "black"), -->
<!--         plot.title = element_text(colour = "black", size = 13.5, face = "bold"), -->
<!--         plot.subtitle = element_text(colour = "black", size = 12.5), -->
<!--         plot.title.position = "plot", -->
<!--         plot.margin = unit(c(t=0.2, r=1, b=0.5, l=1.5), "cm"), -->
<!--         legend.position = "none", -->
<!--         # legend.margin=margin(t=0.5,r=0.5,b=0.5,l=0.5,unit = "line"), -->
<!--         # legend.key.height= unit(0.4, 'cm'), -->
<!--         # legend.key.width= unit(0.4, 'cm'), -->
<!--         # legend.title = element_text(size = 11, color = "black"), -->
<!--         # legend.text = element_text(size = 10, color = "black"), -->
<!--         strip.text = element_text(colour = "black", size = 11, hjust = 0), -->
<!--         strip.background = element_rect(colour="white", fill="white"), -->
<!--         panel.spacing = unit(0.5, "cm")) #, aspect.ratio=0.7) -->
<!-- plot2C_infs -->
<!-- ``` -->

<!-- ```{r} -->
<!-- ggsave("../Supplement/S27_ABM_infsaverted_10k.pdf", plot2C_infs, height = 6, width = 12) -->

<!-- ``` -->

## Additional analyses - delay boosting
### Delay by 30 days
```{r}

## change time to date
start_sims <- as.Date("2020-03-15", "%Y-%m-%d") 


## get ABM seed populations for each country ##
pop_ABM <- read_csv("../Data/ABM_Parameters_Data/Grid_Param.csv") %>% select(Name, child, adult, old) %>% 
  summarise(Name,start_pop = 2*(child + adult+ old)) %>% 
  distinct() %>% 
  arrange(Name) %>% 
  rename(country = Name)

df_delayed_rollout_870 <- read_csv("../Data/ABM Supplement/supp6-delayed_rollout/dataAll.csv") %>%
  left_join(pop_ABM) %>%
  group_by(ID_runs, time) %>% 
  filter(cum_sum_Inf == max(cum_sum_Inf)) %>%
  ungroup() %>% 
  filter(t_boost_start == 870) %>% 
  mutate(time = start_sims + time)

## grab main text 
dataAll_2 <- read_csv("../Data/ABM Main Runs/dataAll.csv") %>% 
  filter(SAR == max(SAR)) %>%
  left_join(pop_ABM) %>%
  group_by(ID_runs, time) %>% 
  filter(cum_sum_Inf == max(cum_sum_Inf)) %>%
  ungroup() %>% 
  mutate(t_boost_start = 870, .after = "speed") %>% 
  filter(booster != "Monovalent" & booster != "Bivalent") %>% 
  mutate(time = start_sims + time)

df_delayed_rollout_870 <- df_delayed_rollout_870 %>% rbind(dataAll_2)


```

```{r}

rm(dataAll_2)
gc()

data_infections_WT <- df_delayed_rollout_870 %>% 
  filter(vaccine_star == "no", boost_shape == "functional", speed=="fast") %>%
  filter(scenario %in% c("WTpenalty", "WTendpoint", "WTefficacy")) %>% 
  filter(booster == "Monovalent") %>% 
  mutate(booster = "Monovalent (WT)")

data_infections_Om <- df_delayed_rollout_870 %>% 
  filter(vaccine_star == "no", boost_shape == "functional", speed=="fast") %>%
  filter(scenario %in% c("Ompenalty", "Omendpoint", "Omefficacy")) %>% 
  filter(booster == "Monovalent") %>% 
  mutate(booster = "Monovalent (Omicron)")

data_infections_Biv <- df_delayed_rollout_870 %>% 
  filter(vaccine_star == "no", boost_shape == "functional", speed=="fast") %>%
  filter(booster == "Bivalent")

data_infections_NoBoost_penalty <- df_delayed_rollout_870 %>% 
  filter(vaccine_star == "no", boost_shape == "no booster") %>%
  mutate(scenario = "penalty")%>% 
  mutate(booster = "No booster")

gc()

data_infections2_delayedrollout_870 <- rbind(data_infections_WT, data_infections_Om) %>%
  rbind(data_infections_Biv) %>%
  rbind(data_infections_NoBoost_penalty)

rm(data_infections_WT, data_infections_Om,
   data_infections_Biv,data_infections_NoBoost_penalty)

gc()
```
#### Plot infections
```{r}
colors <- c("#0D3660","#BC8400","#7C2529", "#005B40")

dat_supp_delayedrollout_870 <- data_infections2_delayedrollout_870 %>% 
  filter(time >= start_sims + 900) %>%
  #mutate(time = time/30,
  mutate(SAR = recode(SAR, `0.427` = "100%",
    `0.4697` = "110%", `0.5551` = "130%")) %>%
  mutate(SAR = fct_relevel(SAR, c("100%", "110%", "130%"))) %>% 
  mutate(Scenario = recode(scenario,
    endpoint = "Same endpoint",efficacy = "Same efficacy",
    penalty = "History dependent",WTpenalty = "History dependent",
    Ompenalty = "History dependent", "no booster" = "No booster")) %>%
  mutate(scenario = fct_relevel(Scenario, 
       c("No booster", "Same endpoint","Same efficacy","History dependent"))) %>% 
  mutate(booster = fct_relevel(booster, 
       c("No booster","Monovalent (WT)","Monovalent (Omicron)", "Bivalent"))) %>% 
  filter(scenario == "History dependent", SAR != "100%") %>%
  mutate(inf10K = 10000*infections_over_time/start_pop) %>%
  group_by(time,country,booster,scenario,SAR, t_boost_start) %>%
  summarise(x  = smean.cl.normal(inf10K), 
            name = c("Mean","Lower","Upper")) %>% ungroup() %>%
  pivot_wider(names_from = name, values_from = x)

rm(data_infections2_delayedrollout_870)
gc()
  
plot_supp_delayedrollout_870 <- dat_supp_delayedrollout_870 %>%
  mutate(country = case_when(
    country == "Ecuador" ~ "Ecuador-like",
    country == "India" ~ "India-like",
    country == "Malaysia" ~ "Malaysia-like"
  )) %>%
  ggplot(aes(x = time, fill = booster, 
            color = booster, linetype = SAR, 
            group = interaction(country, scenario, booster, SAR))) +
  geom_ribbon(aes(ymin = Lower, ymax = Upper), alpha = 0.5) + 
  geom_line(aes(y=Mean), alpha = 0) + theme_classic() + 
  scale_fill_manual("Booster type", values = colors) +
  scale_color_manual("Booster type", values = colors) + 
  ylab("Infections per 10,000") +
  facet_wrap(~country, scales = "free") + 
  ggh4x::facetted_pos_scales(y = list(
  country == "Ecuador-like" ~ scale_y_continuous(limits = c(0, NA), breaks = c(0,20,40,60,80)),
  country == "India-like" ~ scale_y_continuous(limits = c(0, NA)),
  country == "Malaysia-like" ~ scale_y_continuous(limits = c(0, NA), 
                                             breaks = c(0,30,60,90,120)))) + 
  #scale_y_continuous(, limits = c(0,NA)) + # expand = c(0,0) 
  #scale_x_continuous("Time (months)", expand = c(0,0.5), breaks = c(30,32,34,36)) +
    scale_x_date("Date", expand = c(0,0), date_breaks = "1 month", date_labels =  "%b %Y") + 
  ggtitle("Infections during Omicron* - History specific model", "Boosting delayed by 30 days") + #, "Variant-specific model") +
  guides(linetype = guide_legend(override.aes = list(alpha = 1, fill=NA))) +
  scale_linetype_manual("Infectiousness", values = c("dashed")) +
  theme(axis.text = element_text(size = 11, color = "black"),
        axis.title.x = element_text(size = 12, color = "black",vjust = -1),               
        axis.text.x=element_text(angle=60, hjust=1),
        axis.title.y = element_text(size = 12, color = "black",vjust = +3),
        axis.line = element_line(color = "black"),
        axis.ticks = element_line(color = "black"),
        plot.title = element_text(colour = "black", size = 13.5, face = "bold"),
        plot.subtitle = element_text(colour = "black", size = 12.5),
        plot.title.position = "plot",
        plot.margin = unit(c(t=0.2, r=1, b=0.2, l=1.5), "cm"),
        legend.position = "top",
        strip.text = element_text(colour = "black", size = 11, hjust = 0),
        strip.background = element_rect(colour="white", fill="white"),
        legend.margin=margin(t=0.8,r=0.5,b=0.2,l=0,unit = "line"),
        legend.key.height= unit(0.4, 'cm'),
        legend.key.width= unit(0.4, 'cm'),
        legend.title = element_text(size = 11, color = "black"),
        legend.text = element_text(size = 10, color = "black"),
        panel.spacing = unit(0.5, "cm")) #, aspect.ratio=1,
        #panel.grid.major = element_line(color = "grey95"),
        #panel.grid.minor = element_line(color = "grey95")) 
plot_supp_delayedrollout_870
```
#### Data Deaths

Calculating the deaths averted

```{r}
df_compare_delayedrollout_870 <-  df_delayed_rollout_870 %>% 
  filter(boost == "no", vaccine_star == "no") %>% 
  filter(time >= start_sims + 900) %>% 
  group_by(SAR, country, replicate) %>% 
  mutate(deaths10K = 10000*deaths_over_time/start_pop) %>%
  #mutate(deaths_high = max(deaths), deaths_low = min(deaths))
  summarise(
    death_compare_10K = max(deaths10K)-min(deaths10K)
  ) %>%
  ungroup()

df_avert_delayedrollout_870 <- df_delayed_rollout_870 %>% 
  filter(boost == "yes", vaccine_star == "no", boost_shape == "functional", speed=="fast") %>% 
  #filter(time >= 900/365) %>% 
  filter(time >= start_sims + 900) %>%
  group_by(SAR, scenario, booster, country, replicate) %>% ## matching each booster scenario to a no booster scenario
  mutate(deaths10K = 10000*deaths_over_time/start_pop) %>%
  summarise(
    deaths_10K = max(deaths10K, na.rm = T)-min(deaths10K, na.rm = T)
  ) %>%
  ungroup()

df_avert_rr_dr870 <- left_join(df_avert_delayedrollout_870, df_compare_delayedrollout_870, by = c("SAR", "country", "replicate")) %>%
  group_by(SAR, country, booster, scenario, replicate) %>%
  mutate(da10K = death_compare_10K-deaths_10K,
         da_perc = da10K/death_compare_10K) %>%
ungroup() %>%
  select(
    SAR, country, replicate, scenario = scenario, booster = booster, death_compare_10K, deaths_10K, da10K, da_perc)

  

# df_avert_rr <- left_join(df_avert, df_compare, by = c("SAR", "country", "replicate")) %>% 
#   group_by(SAR, country, booster, scenario, replicate) %>% 
#   mutate(rr = deaths/death_compare,
#          da = 1-rr) %>%
# ungroup() %>% 
#   select(
#     SAR, country, replicate, scenario = scenario, booster = booster, da)


df_avert_rr_splitWT <- df_avert_rr_dr870 %>% 
  filter(scenario %in% c("WTpenalty", "WTendpoint", "WTefficacy")) %>% 
  filter(booster == "Monovalent") %>% 
  mutate(booster = "Monovalent (WT)")
df_avert_rr_splitOm <- df_avert_rr_dr870 %>% 
  filter(scenario %in% c("Ompenalty", "Omendpoint", "Omefficacy")) %>% 
  filter(booster == "Monovalent") %>% 
  mutate(booster = "Monovalent (Omicron)")

df_avert_rr2_dr870 <- df_avert_rr_dr870 %>%
  filter(booster == "Bivalent" | booster == "no booster" | booster == "No booster") %>%
  rbind(df_avert_rr_splitWT) %>% 
  rbind(df_avert_rr_splitOm)

rm(df_avert_rr_splitOm, df_avert_rr_splitWT)

```

#### Plot deaths averted

```{r}
colors <- c("#BC8400","#7C2529","#005B40")

comparisons <- list( c("Bivalent", "Monovalent (WT)"), 
                        c("Bivalent", "Monovalent (Omicron)"), 
                        c("Monovalent (WT)", "Monovalent (Omicron)"))

dat_dr870_da <- df_avert_rr2_dr870 %>% 
  mutate(Booster = fct_relevel(booster, "Monovalent")) %>% 
  mutate(SAR = recode(SAR,`0.427` = "100%",
    `0.4697` = "110%", `0.5551` = "130%")) %>%
  mutate(SAR = fct_relevel(SAR, c("100%", "110%", "130%"))) %>% 
  mutate(Scenario = recode(scenario, endpoint = "Same endpoint",
    efficacy = "Same efficacy", penalty = "History dependent",
    WTpenalty = "History dependent", Ompenalty = "History dependent",
    "no booster" = "No booster")) %>%
  filter(Scenario == "History dependent" | Scenario == "No booster") %>%
  filter(SAR != "100%") %>% mutate(Scenario = fct_relevel(Scenario, 
        c("Same endpoint", "Same efficacy", "History dependent"))) %>%
  group_by(SAR,country,Scenario,Booster,) %>%
  summarise(x  = smean.cl.normal(da10K), 
            name = c("Mean","Lower","Upper")) %>% ungroup() %>%
  pivot_wider(names_from = name, values_from = x) %>%
  mutate(Booster = fct_relevel(Booster, 
       c("Monovalent (WT)","Monovalent (Omicron)", "Bivalent")))

plot_dr870_da <- dat_dr870_da %>%
  mutate(country = case_when(
    country == "Ecuador" ~ "Ecuador-like",
    country == "India" ~ "India-like",
    country == "Malaysia" ~ "Malaysia-like"
  )) %>%
  ggplot(aes(x = SAR, fill = Booster, color = Booster,
                     group = interaction(Booster, SAR, Scenario))) + 
  geom_bar(aes(y=Mean), stat="identity", position=position_dodge(0.7),  
           alpha=0.5, size = 0.6, width = 0.6) + theme_classic() +
  geom_errorbar(aes(ymin  = Lower, ymax  = Upper),
           stat="identity", position=position_dodge(0.7),  
           size = 0.6, width = 0.3, show.legend=FALSE) + 
    geom_text(aes(label = round(Mean, 2), y = Upper + 0.2), position=position_dodge(0.7), size = 3) + ## this line adds the labels
  scale_fill_manual("Booster", values = colors) +
  scale_color_manual("Booster", values = colors) +
  facet_wrap(~country, scales = "free", nrow = 1) +
  scale_y_continuous("Deaths averted per 10,000", limits = c(0,5), 
                     expand = expansion(mult = c(0,0))) + 
  scale_x_discrete("Infectiousness relative to Omicron") +
  ggtitle("Deaths averted - History specific model", "Boosting delayed by 30 days") + #, subtitle = "Variant-specific model") + 
  theme(axis.text = element_text(size = 11, color = "black"),
        axis.title.x = element_text(size = 12, color = "black",vjust = -1),
        axis.title.y = element_text(size = 12, color = "black",vjust = +3),
        axis.line = element_line(color = "black"),
        axis.ticks = element_line(color = "black"),
        plot.title = element_text(colour = "black", size = 13.5, face = "bold"),
        plot.subtitle = element_text(colour = "black", size = 12.5),
        plot.title.position = "plot",
        plot.margin = unit(c(t=0.2, r=1, b=0.5, l=1.5), "cm"),
        legend.position = "none",
        # legend.margin=margin(t=0.5,r=0.5,b=0.5,l=0.5,unit = "line"),
        # legend.key.height= unit(0.4, 'cm'),
        # legend.key.width= unit(0.4, 'cm'),
        # legend.title = element_text(size = 11, color = "black"),
        # legend.text = element_text(size = 10, color = "black"),
        strip.text = element_text(colour = "black", size = 11, hjust = 0),
        strip.background = element_rect(colour="white", fill="white"),
        panel.spacing = unit(0.5, "cm")) #, aspect.ratio=0.7)
plot_dr870_da
```

```{r}

plot_grid870 <- plot_grid(plot_supp_delayedrollout_870, plot_dr870_da, nrow = 2, labels = c("A", "B"))
ggsave("../Supplement/SR-delay870.pdf", plot_grid870, height = 6, width = 9.4)
```

### Delay by 60 days
```{r}

## change time to date
start_sims <- as.Date("2020-03-15", "%Y-%m-%d") 

## get ABM seed populations for each country ##
pop_ABM <- read_csv("../Data/ABM_Parameters_Data/Grid_Param.csv") %>% select(Name, child, adult, old) %>% 
  summarise(Name,start_pop = 2*(child + adult+ old)) %>% 
  distinct() %>% 
  arrange(Name) %>% 
  rename(country = Name)

df_delayed_rollout_900 <- read_csv("../Data/ABM Supplement/supp6-delayed_rollout/dataAll.csv") %>%
  left_join(pop_ABM) %>%
  group_by(ID_runs, time) %>% 
  filter(cum_sum_Inf == max(cum_sum_Inf)) %>%
  ungroup() %>% 
  filter(t_boost_start == 900)

## grab main text 
dataAll_2 <- read_csv("../Data/ABM Main Runs/dataAll.csv") %>% 
  filter(SAR == max(SAR)) %>%
  left_join(pop_ABM) %>%
  group_by(ID_runs, time) %>% 
  filter(cum_sum_Inf == max(cum_sum_Inf)) %>%
  ungroup() %>% 
  mutate(t_boost_start = 900, .after = "speed") %>% 
  filter(booster != "Monovalent" & booster != "Bivalent")

df_delayed_rollout_900 <- df_delayed_rollout_900 %>% rbind(dataAll_2)

```

```{r}

rm(dataAll_2)
gc()

data_infections_WT <- df_delayed_rollout_900 %>% 
  filter(vaccine_star == "no", boost_shape == "functional", speed=="fast") %>%
  filter(scenario %in% c("WTpenalty", "WTendpoint", "WTefficacy")) %>% 
  filter(booster == "Monovalent") %>% 
  mutate(booster = "Monovalent (WT)")

data_infections_Om <- df_delayed_rollout_900 %>% 
  filter(vaccine_star == "no", boost_shape == "functional", speed=="fast") %>%
  filter(scenario %in% c("Ompenalty", "Omendpoint", "Omefficacy")) %>% 
  filter(booster == "Monovalent") %>% 
  mutate(booster = "Monovalent (Omicron)")

data_infections_Biv <- df_delayed_rollout_900 %>% 
  filter(vaccine_star == "no", boost_shape == "functional", speed=="fast") %>%
  filter(booster == "Bivalent")

data_infections_NoBoost_penalty <- df_delayed_rollout_900 %>% 
  filter(vaccine_star == "no", boost_shape == "no booster") %>%
  mutate(scenario = "penalty")%>% 
  mutate(booster = "No booster")

gc()

data_infections2_delayedrollout_900 <- rbind(data_infections_WT, data_infections_Om) %>%
  rbind(data_infections_Biv) %>%
  rbind(data_infections_NoBoost_penalty)

rm(data_infections_WT, data_infections_Om,
   data_infections_Biv,data_infections_NoBoost_penalty)

gc()
```
#### Plot infections
```{r}
colors <- c("#0D3660","#BC8400","#7C2529", "#005B40")

dat_supp_delayedrollout_900 <- data_infections2_delayedrollout_900 %>% 
  mutate(time = start_sims + time) %>%
  filter(time >= start_sims + 900) %>%
  #mutate(time = time/30, 
  mutate(SAR = recode(SAR, `0.427` = "100%",
    `0.4697` = "110%", `0.5551` = "130%")) %>%
  mutate(SAR = fct_relevel(SAR, c("100%", "110%", "130%"))) %>% 
  mutate(Scenario = recode(scenario,
    endpoint = "Same endpoint",efficacy = "Same efficacy",
    penalty = "History dependent",WTpenalty = "History dependent",
    Ompenalty = "History dependent", "no booster" = "No booster")) %>%
  mutate(scenario = fct_relevel(Scenario, 
       c("No booster", "Same endpoint","Same efficacy","History dependent"))) %>% 
  mutate(booster = fct_relevel(booster, 
       c("No booster","Monovalent (WT)","Monovalent (Omicron)", "Bivalent"))) %>% 
  filter(scenario == "History dependent", SAR != "100%") %>%
  mutate(inf10K = 10000*infections_over_time/start_pop) %>%
  group_by(time,country,booster,scenario,SAR, t_boost_start) %>%
  summarise(x  = smean.cl.normal(inf10K), 
            name = c("Mean","Lower","Upper")) %>% ungroup() %>%
  pivot_wider(names_from = name, values_from = x)

rm(data_infections2_delayedrollout_900)
gc()
  
plot_supp_delayedrollout_900 <- dat_supp_delayedrollout_900 %>%
  mutate(country = case_when(
    country == "Ecuador" ~ "Ecuador-like",
    country == "India" ~ "India-like",
    country == "Malaysia" ~ "Malaysia-like"
  )) %>%
  ggplot(aes(x = time, fill = booster, 
            color = booster, linetype = SAR, 
            group = interaction(country, scenario, booster, SAR))) +
  geom_ribbon(aes(ymin = Lower, ymax = Upper), alpha = 0.5) + 
  geom_line(aes(y=Mean), alpha = 0) + theme_classic() + 
  scale_fill_manual("Booster type", values = colors) +
  scale_color_manual("Booster type", values = colors) + 
  ylab("Infections per 10,000") +
  facet_wrap(~country, scales = "free") + 
  ggh4x::facetted_pos_scales(y = list(
  country == "Ecuador-like" ~ scale_y_continuous(limits = c(0, NA), breaks = c(0,20,40,60,80)),
  country == "India-like" ~ scale_y_continuous(limits = c(0, NA)),
  country == "Malaysia-like" ~ scale_y_continuous(limits = c(0, NA), 
                                             breaks = c(0,30,60,90,120)))) + 
  #scale_y_continuous(, limits = c(0,NA)) + # expand = c(0,0) 
 # scale_x_continuous("Time (months)", expand = c(0,0.5), breaks = c(30,32,34,36)) +
    scale_x_date("Date", expand = c(0,0), date_breaks = "1 month", date_labels =  "%b %Y") +
  ggtitle("Infections during Omicron* - History specific model", "Boosting delayed by 60 days") + #, "Variant-specific model") +
  guides(linetype = guide_legend(override.aes = list(alpha = 1, fill=NA))) +
  scale_linetype_manual("Infectiousness", values = c("dashed")) +
  theme(axis.text = element_text(size = 11, color = "black"),
        axis.text.x=element_text(angle=60, hjust=1),
        axis.title.x = element_text(size = 12, color = "black",vjust = -1),
        axis.title.y = element_text(size = 12, color = "black",vjust = +3),
        axis.line = element_line(color = "black"),
        axis.ticks = element_line(color = "black"),
        plot.title = element_text(colour = "black", size = 13.5, face = "bold"),
        plot.subtitle = element_text(colour = "black", size = 12.5),
        plot.title.position = "plot",
        plot.margin = unit(c(t=0.2, r=1, b=0.2, l=1.5), "cm"),
        legend.position = "top",
        strip.text = element_text(colour = "black", size = 11, hjust = 0),
        strip.background = element_rect(colour="white", fill="white"),
        legend.margin=margin(t=0.8,r=0.5,b=0.2,l=0,unit = "line"),
        legend.key.height= unit(0.4, 'cm'),
        legend.key.width= unit(0.4, 'cm'),
        legend.title = element_text(size = 11, color = "black"),
        legend.text = element_text(size = 10, color = "black"),
        panel.spacing = unit(0.5, "cm")) #, aspect.ratio=1,
        #panel.grid.major = element_line(color = "grey95"),
        #panel.grid.minor = element_line(color = "grey95")) 
plot_supp_delayedrollout_900
```
#### Data Deaths

Calculating the deaths averted

```{r}
df_compare_delayedrollout_900 <-  df_delayed_rollout_900 %>% 
  filter(boost == "no", vaccine_star == "no") %>% 
  filter(time >= 900) %>% 
  group_by(SAR, country, replicate) %>% 
  mutate(deaths10K = 10000*deaths_over_time/start_pop) %>%
  #mutate(deaths_high = max(deaths), deaths_low = min(deaths))
  summarise(
    death_compare_10K = max(deaths10K)-min(deaths10K)
  ) %>%
  ungroup()

df_avert_delayedrollout_900 <- df_delayed_rollout_900 %>% 
  filter(boost == "yes", vaccine_star == "no", boost_shape == "functional", speed=="fast") %>% 
  #filter(time >= 900/365) %>% 
  filter(time >= 900) %>%
  group_by(SAR, scenario, booster, country, replicate) %>% ## matching each booster scenario to a no booster scenario
  mutate(deaths10K = 10000*deaths_over_time/start_pop) %>%
  summarise(
    deaths_10K = max(deaths10K, na.rm = T)-min(deaths10K, na.rm = T)
  ) %>%
  ungroup()

df_avert_rr_dr900 <- left_join(df_avert_delayedrollout_900, df_compare_delayedrollout_900, by = c("SAR", "country", "replicate")) %>%
  group_by(SAR, country, booster, scenario, replicate) %>%
  mutate(da10K = death_compare_10K-deaths_10K,
         da_perc = da10K/death_compare_10K) %>%
ungroup() %>%
  select(
    SAR, country, replicate, scenario = scenario, booster = booster, death_compare_10K, deaths_10K, da10K, da_perc)

  

# df_avert_rr <- left_join(df_avert, df_compare, by = c("SAR", "country", "replicate")) %>% 
#   group_by(SAR, country, booster, scenario, replicate) %>% 
#   mutate(rr = deaths/death_compare,
#          da = 1-rr) %>%
# ungroup() %>% 
#   select(
#     SAR, country, replicate, scenario = scenario, booster = booster, da)


df_avert_rr_splitWT <- df_avert_rr_dr900 %>% 
  filter(scenario %in% c("WTpenalty", "WTendpoint", "WTefficacy")) %>% 
  filter(booster == "Monovalent") %>% 
  mutate(booster = "Monovalent (WT)")
df_avert_rr_splitOm <- df_avert_rr_dr900 %>% 
  filter(scenario %in% c("Ompenalty", "Omendpoint", "Omefficacy")) %>% 
  filter(booster == "Monovalent") %>% 
  mutate(booster = "Monovalent (Omicron)")

df_avert_rr2_dr900 <- df_avert_rr_dr900 %>%
  filter(booster == "Bivalent" | booster == "no booster" | booster == "No booster") %>%
  rbind(df_avert_rr_splitWT) %>% 
  rbind(df_avert_rr_splitOm)

rm(df_avert_rr_splitOm, df_avert_rr_splitWT)

```

#### Plot deaths averted

```{r}
colors <- c("#BC8400","#7C2529","#005B40")

comparisons <- list( c("Bivalent", "Monovalent (WT)"), 
                        c("Bivalent", "Monovalent (Omicron)"), 
                        c("Monovalent (WT)", "Monovalent (Omicron)"))

dat_dr900_da <- df_avert_rr2_dr900 %>% 
  mutate(Booster = fct_relevel(booster, "Monovalent")) %>% 
  mutate(SAR = recode(SAR,`0.427` = "100%",
    `0.4697` = "110%", `0.5551` = "130%")) %>%
  mutate(SAR = fct_relevel(SAR, c("100%", "110%", "130%"))) %>% 
  mutate(Scenario = recode(scenario, endpoint = "Same endpoint",
    efficacy = "Same efficacy", penalty = "History dependent",
    WTpenalty = "History dependent", Ompenalty = "History dependent",
    "no booster" = "No booster")) %>%
  filter(Scenario == "History dependent" | Scenario == "No booster") %>%
  filter(SAR != "100%") %>% mutate(Scenario = fct_relevel(Scenario, 
        c("Same endpoint", "Same efficacy", "History dependent"))) %>%
  group_by(SAR,country,Scenario,Booster,) %>%
  summarise(x  = smean.cl.normal(da10K), 
            name = c("Mean","Lower","Upper")) %>% ungroup() %>%
  pivot_wider(names_from = name, values_from = x) %>%
  mutate(Booster = fct_relevel(Booster, 
       c("Monovalent (WT)","Monovalent (Omicron)", "Bivalent")))

plot_dr900_da <- dat_dr900_da %>% 
  mutate(country = case_when(
    country == "Ecuador" ~ "Ecuador-like",
    country == "India" ~ "India-like",
    country == "Malaysia" ~ "Malaysia-like"
  )) %>%
  ggplot(aes(x = SAR, fill = Booster, color = Booster,
                     group = interaction(Booster, SAR, Scenario))) + 
  geom_bar(aes(y=Mean), stat="identity", position=position_dodge(0.7),  
           alpha=0.5, size = 0.6, width = 0.6) + theme_classic() +
  geom_errorbar(aes(ymin  = Lower, ymax  = Upper),
           stat="identity", position=position_dodge(0.7),  
           size = 0.6, width = 0.3, show.legend=FALSE) + 
    geom_text(aes(label = round(Mean, 2), y = Upper + 0.2), position=position_dodge(0.7), size = 3) + ## this line adds the labels
  scale_fill_manual("Booster", values = colors) +
  scale_color_manual("Booster", values = colors) +
  facet_wrap(~country, scales = "free", nrow = 1) +
  scale_y_continuous("Deaths averted per 10,000", limits = c(0,5), 
                     expand = expansion(mult = c(0,0))) + 
  scale_x_discrete("Infectiousness relative to Omicron") +
  ggtitle("Deaths averted - History specific model", "Boosting delayed by 60 days") + #, subtitle = "Variant-specific model") + 
  theme(axis.text = element_text(size = 11, color = "black"),
        axis.title.x = element_text(size = 12, color = "black",vjust = -1),
        axis.title.y = element_text(size = 12, color = "black",vjust = +3),
        axis.line = element_line(color = "black"),
        axis.ticks = element_line(color = "black"),
        plot.title = element_text(colour = "black", size = 13.5, face = "bold"),
        plot.subtitle = element_text(colour = "black", size = 12.5),
        plot.title.position = "plot",
        plot.margin = unit(c(t=0.2, r=1, b=0.5, l=1.5), "cm"),
        legend.position = "none",
        # legend.margin=margin(t=0.5,r=0.5,b=0.5,l=0.5,unit = "line"),
        # legend.key.height= unit(0.4, 'cm'),
        # legend.key.width= unit(0.4, 'cm'),
        # legend.title = element_text(size = 11, color = "black"),
        # legend.text = element_text(size = 10, color = "black"),
        strip.text = element_text(colour = "black", size = 11, hjust = 0),
        strip.background = element_rect(colour="white", fill="white"),
        panel.spacing = unit(0.5, "cm")) #, aspect.ratio=0.7)
plot_dr900_da
```


```{r}
plot_grid900 <- plot_grid(plot_supp_delayedrollout_900, plot_dr900_da, nrow = 2, labels = c("A", "B"))
ggsave("../Supplement/SR-delay900.pdf", plot_grid900, height = 6, width = 9.4)
```


### Delay by 90 days
```{r}

## change time to date
start_sims <- as.Date("2020-03-15", "%Y-%m-%d") 

## get ABM seed populations for each country ##
pop_ABM <- read_csv("../Data/ABM_Parameters_Data/Grid_Param.csv") %>% select(Name, child, adult, old) %>% 
  summarise(Name,start_pop = 2*(child + adult+ old)) %>% 
  distinct() %>% 
  arrange(Name) %>% 
  rename(country = Name)

df_delayed_rollout_930 <- read_csv("../Data/ABM Supplement/supp6-delayed_rollout/dataAll.csv") %>%
  left_join(pop_ABM) %>%
  group_by(ID_runs, time) %>% 
  filter(cum_sum_Inf == max(cum_sum_Inf)) %>%
  ungroup() %>% 
  filter(t_boost_start == 930)

## grab main text 
dataAll_2 <- read_csv("../Data/ABM Main Runs/dataAll.csv") %>% 
  filter(SAR == max(SAR)) %>%
  left_join(pop_ABM) %>%
  group_by(ID_runs, time) %>% 
  filter(cum_sum_Inf == max(cum_sum_Inf)) %>%
  ungroup() %>% 
  mutate(t_boost_start = 930, .after = "speed") %>% 
  filter(booster != "Monovalent" & booster != "Bivalent")

df_delayed_rollout_930 <- df_delayed_rollout_930 %>% rbind(dataAll_2)

```

```{r}

rm(dataAll_2)
gc()

data_infections_WT <- df_delayed_rollout_930 %>% 
  filter(vaccine_star == "no", boost_shape == "functional", speed=="fast") %>%
  filter(scenario %in% c("WTpenalty", "WTendpoint", "WTefficacy")) %>% 
  filter(booster == "Monovalent") %>% 
  mutate(booster = "Monovalent (WT)")

data_infections_Om <- df_delayed_rollout_930 %>% 
  filter(vaccine_star == "no", boost_shape == "functional", speed=="fast") %>%
  filter(scenario %in% c("Ompenalty", "Omendpoint", "Omefficacy")) %>% 
  filter(booster == "Monovalent") %>% 
  mutate(booster = "Monovalent (Omicron)")

data_infections_Biv <- df_delayed_rollout_930 %>% 
  filter(vaccine_star == "no", boost_shape == "functional", speed=="fast") %>%
  filter(booster == "Bivalent")

data_infections_NoBoost_penalty <- df_delayed_rollout_930 %>% 
  filter(vaccine_star == "no", boost_shape == "no booster") %>%
  mutate(scenario = "penalty")%>% 
  mutate(booster = "No booster")

gc()

data_infections2_delayedrollout_930 <- rbind(data_infections_WT, data_infections_Om) %>%
  rbind(data_infections_Biv) %>%
  rbind(data_infections_NoBoost_penalty)

rm(data_infections_WT, data_infections_Om,
   data_infections_Biv,data_infections_NoBoost_penalty)

gc()
```
#### Plot infections
```{r}
colors <- c("#0D3660","#BC8400","#7C2529", "#005B40")

dat_supp_delayedrollout_930 <- data_infections2_delayedrollout_930 %>%
  mutate(time = start_sims + time) %>%
  filter(time >= start_sims + 900) %>%
  #mutate(time = time/30, 
    mutate(SAR = recode(SAR, `0.427` = "100%",
    `0.4697` = "110%", `0.5551` = "130%")) %>%
  mutate(SAR = fct_relevel(SAR, c("100%", "110%", "130%"))) %>% 
  mutate(Scenario = recode(scenario,
    endpoint = "Same endpoint",efficacy = "Same efficacy",
    penalty = "History dependent",WTpenalty = "History dependent",
    Ompenalty = "History dependent", "no booster" = "No booster")) %>%
  mutate(scenario = fct_relevel(Scenario, 
       c("No booster", "Same endpoint","Same efficacy","History dependent"))) %>% 
  mutate(booster = fct_relevel(booster, 
       c("No booster","Monovalent (WT)","Monovalent (Omicron)", "Bivalent"))) %>% 
  filter(scenario == "History dependent", SAR != "100%") %>%
  mutate(inf10K = 10000*infections_over_time/start_pop) %>%
  group_by(time,country,booster,scenario,SAR, t_boost_start) %>%
  summarise(x  = smean.cl.normal(inf10K), 
            name = c("Mean","Lower","Upper")) %>% ungroup() %>%
  pivot_wider(names_from = name, values_from = x)

rm(data_infections2_delayedrollout_930)
gc()
  
plot_supp_delayedrollout_930 <- dat_supp_delayedrollout_930 %>%
  mutate(country = case_when(
    country == "Ecuador" ~ "Ecuador-like",
    country == "India" ~ "India-like",
    country == "Malaysia" ~ "Malaysia-like"
  )) %>%
  ggplot(aes(x = time, fill = booster, 
            color = booster, linetype = SAR, 
            group = interaction(country, scenario, booster, SAR))) +
  geom_ribbon(aes(ymin = Lower, ymax = Upper), alpha = 0.5) + 
  geom_line(aes(y=Mean), alpha = 0) + theme_classic() + 
  scale_fill_manual("Booster type", values = colors) +
  scale_color_manual("Booster type", values = colors) + 
  ylab("Infections per 10,000") +
  facet_wrap(~country, scales = "free") + 
  ggh4x::facetted_pos_scales(y = list(
  country == "Ecuador-like" ~ scale_y_continuous(limits = c(0, NA), breaks = c(0,20,40,60,80)),
  country == "India-like" ~ scale_y_continuous(limits = c(0, NA)),
  country == "Malaysia-like" ~ scale_y_continuous(limits = c(0, NA), 
                                             breaks = c(0,30,60,90,120)))) + 
  #scale_y_continuous(, limits = c(0,NA)) + # expand = c(0,0) 
  #scale_x_continuous("Time (months)", expand = c(0,0.5), breaks = c(30,32,34,36)) +
    scale_x_date("Date", expand = c(0,0), date_breaks = "1 month", date_labels =  "%b %Y") +
  ggtitle("Infections during Omicron* - History specific model", "Boosting delayed by 90 days") + #, "Variant-specific model") +
  guides(linetype = guide_legend(override.aes = list(alpha = 1, fill=NA))) +
  scale_linetype_manual("Infectiousness", values = c("dashed")) +
  theme(axis.text = element_text(size = 11, color = "black"),
        axis.title.x = element_text(size = 12, color = "black",vjust = -1),
        axis.text.x=element_text(angle=60, hjust=1),
        axis.title.y = element_text(size = 12, color = "black",vjust = +3),
        axis.line = element_line(color = "black"),
        axis.ticks = element_line(color = "black"),
        plot.title = element_text(colour = "black", size = 13.5, face = "bold"),
        plot.subtitle = element_text(colour = "black", size = 12.5),
        plot.title.position = "plot",
        plot.margin = unit(c(t=0.2, r=1, b=0.2, l=1.5), "cm"),
        legend.position = "top",
        strip.text = element_text(colour = "black", size = 11, hjust = 0),
        strip.background = element_rect(colour="white", fill="white"),
        legend.margin=margin(t=0.8,r=0.5,b=0.2,l=0,unit = "line"),
        legend.key.height= unit(0.4, 'cm'),
        legend.key.width= unit(0.4, 'cm'),
        legend.title = element_text(size = 11, color = "black"),
        legend.text = element_text(size = 10, color = "black"),
        panel.spacing = unit(0.5, "cm")) #, aspect.ratio=1,
        #panel.grid.major = element_line(color = "grey95"),
        #panel.grid.minor = element_line(color = "grey95")) 
plot_supp_delayedrollout_930
```
#### Data Deaths

Calculating the deaths averted

```{r}
df_compare_delayedrollout_930 <-  df_delayed_rollout_930 %>% 
  filter(boost == "no", vaccine_star == "no") %>% 
  filter(time >= 900) %>% 
  group_by(SAR, country, replicate) %>% 
  mutate(deaths10K = 10000*deaths_over_time/start_pop) %>%
  #mutate(deaths_high = max(deaths), deaths_low = min(deaths))
  summarise(
    death_compare_10K = max(deaths10K)-min(deaths10K)
  ) %>%
  ungroup()

df_avert_delayedrollout_930 <- df_delayed_rollout_930 %>% 
  filter(boost == "yes", vaccine_star == "no", boost_shape == "functional", speed=="fast") %>% 
  #filter(time >= 930/365) %>% 
  filter(time >= 900) %>%
  group_by(SAR, scenario, booster, country, replicate) %>% ## matching each booster scenario to a no booster scenario
  mutate(deaths10K = 10000*deaths_over_time/start_pop) %>%
  summarise(
    deaths_10K = max(deaths10K, na.rm = T)-min(deaths10K, na.rm = T)
  ) %>%
  ungroup()

df_avert_rr_dr930 <- left_join(df_avert_delayedrollout_930, df_compare_delayedrollout_930, by = c("SAR", "country", "replicate")) %>%
  group_by(SAR, country, booster, scenario, replicate) %>%
  mutate(da10K = death_compare_10K-deaths_10K,
         da_perc = da10K/death_compare_10K) %>%
ungroup() %>%
  select(
    SAR, country, replicate, scenario = scenario, booster = booster, death_compare_10K, deaths_10K, da10K, da_perc)

  

# df_avert_rr <- left_join(df_avert, df_compare, by = c("SAR", "country", "replicate")) %>% 
#   group_by(SAR, country, booster, scenario, replicate) %>% 
#   mutate(rr = deaths/death_compare,
#          da = 1-rr) %>%
# ungroup() %>% 
#   select(
#     SAR, country, replicate, scenario = scenario, booster = booster, da)


df_avert_rr_splitWT <- df_avert_rr_dr930 %>% 
  filter(scenario %in% c("WTpenalty", "WTendpoint", "WTefficacy")) %>% 
  filter(booster == "Monovalent") %>% 
  mutate(booster = "Monovalent (WT)")
df_avert_rr_splitOm <- df_avert_rr_dr930 %>% 
  filter(scenario %in% c("Ompenalty", "Omendpoint", "Omefficacy")) %>% 
  filter(booster == "Monovalent") %>% 
  mutate(booster = "Monovalent (Omicron)")

df_avert_rr2_dr930 <- df_avert_rr_dr930 %>%
  filter(booster == "Bivalent" | booster == "no booster" | booster == "No booster") %>%
  rbind(df_avert_rr_splitWT) %>% 
  rbind(df_avert_rr_splitOm)

rm(df_avert_rr_splitOm, df_avert_rr_splitWT)

```

#### Plot deaths averted

```{r}
colors <- c("#BC8400","#7C2529","#005B40")

comparisons <- list( c("Bivalent", "Monovalent (WT)"), 
                        c("Bivalent", "Monovalent (Omicron)"), 
                        c("Monovalent (WT)", "Monovalent (Omicron)"))

dat_dr930_da <- df_avert_rr2_dr930 %>% 
  mutate(Booster = fct_relevel(booster, "Monovalent")) %>% 
  mutate(SAR = recode(SAR,`0.427` = "100%",
    `0.4697` = "110%", `0.5551` = "130%")) %>%
  mutate(SAR = fct_relevel(SAR, c("100%", "110%", "130%"))) %>% 
  mutate(Scenario = recode(scenario, endpoint = "Same endpoint",
    efficacy = "Same efficacy", penalty = "History dependent",
    WTpenalty = "History dependent", Ompenalty = "History dependent",
    "no booster" = "No booster")) %>%
  filter(Scenario == "History dependent" | Scenario == "No booster") %>%
  filter(SAR != "100%") %>% mutate(Scenario = fct_relevel(Scenario, 
        c("Same endpoint", "Same efficacy", "History dependent"))) %>%
  group_by(SAR,country,Scenario,Booster,) %>%
  summarise(x  = smean.cl.normal(da10K), 
            name = c("Mean","Lower","Upper")) %>% ungroup() %>%
  pivot_wider(names_from = name, values_from = x) %>%
  mutate(Booster = fct_relevel(Booster, 
       c("Monovalent (WT)","Monovalent (Omicron)", "Bivalent")))

plot_dr930_da <- dat_dr930_da %>% 
  mutate(country = case_when(
    country == "Ecuador" ~ "Ecuador-like",
    country == "India" ~ "India-like",
    country == "Malaysia" ~ "Malaysia-like"
  )) %>%
  ggplot(aes(x = SAR, fill = Booster, color = Booster,
                     group = interaction(Booster, SAR, Scenario))) + 
  geom_bar(aes(y=Mean), stat="identity", position=position_dodge(0.7),  
           alpha=0.5, size = 0.6, width = 0.6) + theme_classic() +
  geom_errorbar(aes(ymin  = Lower, ymax  = Upper),
           stat="identity", position=position_dodge(0.7),  
           size = 0.6, width = 0.3, show.legend=FALSE) + 
    geom_text(aes(label = round(Mean, 2), y = Upper + 0.2), position=position_dodge(0.7), size = 3) + ## this line adds the labels
  scale_fill_manual("Booster", values = colors) +
  scale_color_manual("Booster", values = colors) +
  facet_wrap(~country, scales = "free", nrow = 1) +
  scale_y_continuous("Deaths averted per 10,000", limits = c(0,5), 
                     expand = expansion(mult = c(0,0))) + 
  scale_x_discrete("Infectiousness relative to Omicron") +
  ggtitle("Deaths averted - History specific model", "Boosting delayed by 90 days") + #, subtitle = "Variant-specific model") + 
  theme(axis.text = element_text(size = 11, color = "black"),
        axis.title.x = element_text(size = 12, color = "black",vjust = -1),
        axis.title.y = element_text(size = 12, color = "black",vjust = +3),
        axis.line = element_line(color = "black"),
        axis.ticks = element_line(color = "black"),
        plot.title = element_text(colour = "black", size = 13.5, face = "bold"),
        plot.subtitle = element_text(colour = "black", size = 12.5),
        plot.title.position = "plot",
        plot.margin = unit(c(t=0.2, r=1, b=0.5, l=1.5), "cm"),
        legend.position = "none",
        # legend.margin=margin(t=0.5,r=0.5,b=0.5,l=0.5,unit = "line"),
        # legend.key.height= unit(0.4, 'cm'),
        # legend.key.width= unit(0.4, 'cm'),
        # legend.title = element_text(size = 11, color = "black"),
        # legend.text = element_text(size = 10, color = "black"),
        strip.text = element_text(colour = "black", size = 11, hjust = 0),
        strip.background = element_rect(colour="white", fill="white"),
        panel.spacing = unit(0.5, "cm")) #, aspect.ratio=0.7)
plot_dr930_da
```


```{r}
plot_grid930 <- plot_grid(plot_supp_delayedrollout_930, plot_dr930_da, nrow = 2, labels = c("A", "B"))
ggsave("../Supplement/SR-delay930.pdf", plot_grid930, height = 6, width = 9.4)
```



### No mono attenuation
```{r}

## change time to date
start_sims <- as.Date("2020-03-15", "%Y-%m-%d") 

## get ABM seed populations for each country ##
pop_ABM <- read_csv("../Data/ABM_Parameters_Data/Grid_Param.csv") %>% select(Name, child, adult, old) %>% 
  summarise(Name,start_pop = 2*(child + adult+ old)) %>% 
  distinct() %>% 
  arrange(Name) %>% 
  rename(country = Name)

df_100eff <- read_csv("../Data/ABM Supplement/supp7-100boostereff/dataAll.csv") %>%
  left_join(pop_ABM) %>%
  group_by(ID_runs, time) %>% 
  filter(cum_sum_Inf == max(cum_sum_Inf)) %>%
  ungroup() %>% 
  filter(booster != "Bivalent")

## grab main text 
dataAll_2 <- read_csv("../Data/ABM Main Runs/dataAll.csv") %>% 
  filter(SAR == max(SAR)) %>%
  left_join(pop_ABM) %>%
  group_by(ID_runs, time) %>% 
  filter(cum_sum_Inf == max(cum_sum_Inf)) %>%
  ungroup() %>% 
  filter(booster != "Monovalent") 

df_100eff <- df_100eff %>% rbind(dataAll_2)

rm(dataAll_2)
gc()

```

#### Get serotype data 
#### titers
```{r}

########## Man. paper #########

## neutralizing antibody titres
dataMan <- read_excel("../Data/ABM_Parameters_Data/Manali et al/New_Supplementary_Data_File.xlsx") %>% 
  select(doses = `Number of Vaccine Doses`, Group, 
         WT = `Wuhan Titre`, Delta = `Delta Titre`, Omicron = `Omicron Titre`) %>% 
  filter(doses > 1 | doses == 0) %>% ## 2 or more doses
  filter(Group != "I_Av" & Group != "I_A" & Group != "N") %>%
  mutate(
    History = case_when(
      Group == "I_Wv" ~ "WT_vaccine",
      Group == "I_W" ~ "WT",
      Group == "I_Dv" ~ "Delta_vaccine",
      Group == "I_D" ~ "Delta",
      Group == "V" ~ "Vaccine")) %>% 
  select(History, WT, Delta, Omicron) %>% 
  pivot_longer(WT:Omicron, names_to = "Variant", values_to = "Titre")

######## data_Surya #######
  
##unvaccinated and hybrid individuals, NT50 - 2-3 doses
data_Surya <- read_excel("../Data/ABM_Parameters_Data/Suryawanshi et al. 2022/reformat.xlsx") %>% 
  select(History = history, WT = WA1, Delta, Omicron) %>% 
  pivot_longer(WT:Omicron, names_to = "Variant", values_to = "Titre")


######### Test plot ########

test_Man <- dataMan %>% mutate(paper = "Man") 
test_Surya <- data_Surya %>% mutate(paper = "Surya")

plot_check <- test_Man %>% rbind(test_Surya) %>% 
  filter(History != "Naive") %>% 
  group_by(History, Variant, paper) %>%
  mutate(Titre = as.numeric(Titre), 
         Titre = if_else(Titre < 1, 1, Titre)) %>% ## clean out -Inf values - if someone's titre is 0, approximate it by 1
  mutate(Titre = log10(Titre)) %>% 
  summarise(Titre = mean(Titre, na.rm = T)) %>% 
  ggplot(aes(x = History, y = Titre, group = History, fill = History)) + 
  geom_col(position = "dodge") + 
  facet_grid(paper~Variant)
plot_check

#ggsave("Show_titres.pdf", plot_check, width = 12, height = 8)


########## Get full table #########

## get an immunity table combining all sources
fullDat <- rbind(dataMan, data_Surya) %>% 
  filter(History != "Naive") %>% 
  mutate(Titre = as.numeric(Titre)) %>% 
  mutate(
    Titre = if_else(Titre < 1, 1, Titre), ## clean out -Inf - if titre is between 0-1, approximate it by 1
    Titre = log10(Titre) ## get log scale titre
  ) %>% 
  group_by(History, Variant) %>% 
  summarise(
    Titre = mean(Titre, na.rm = T), ## grab mean log titre
         minuslogTitre = -Titre) %>% ## get minus log titre since we want to scale a reduction in a param
  ungroup() %>% 
  mutate(paramfinal = rescale(minuslogTitre, to = c(0.05, 0.95))) %>% 
  arrange(paramfinal) %>% 
  select(Serotype = History, variant = Variant, paramfinal) %>% 
  mutate(paramfinal = round(paramfinal, 2))

## test 
plot <- fullDat %>% 
  mutate(variant = fct_relevel(variant, c("WT", "Delta", "Omicron"))) %>% 
  ggplot(aes(x = variant, y = Serotype, fill = 1-paramfinal)) + 
  geom_tile() + 
  scale_fill_viridis_c()
plot

## get transition between WT to Delta
fullDat_transition <- fullDat %>% 
  pivot_wider(names_from = "variant", values_from = "paramfinal") %>% 
  mutate(diffWT_to_DT = round(mean(Delta-WT),2), diffDT_to_Om = round(mean(Omicron-Delta),2))

lineage_change <- fullDat_transition$diffWT_to_DT[1]

## transition from WT to Delta: lineage_change
  
savefile <- fullDat %>% 
  pivot_wider(names_from = Serotype, values_from = paramfinal)


## get the difference from a vaccine to get the Omicron serotype
diff_file <- savefile %>% 
  mutate(Delta_vax_diff = Delta_vaccine - Delta,
         WT_vax_diff = WT_vaccine - WT,
         Omicron_vax_diff = Omicron_vaccine - Omicron,
         Vax_diff = Vaccine - 1) ##this is the base change for ppl getting a vaccine


savefile <- savefile %>% 
  ## rule: Omicron = Omicron_vaccine - vaccine benefit i.e. the change for Delta
  #mutate(Omicron = Omicron_vaccine - diff_file$Delta_vax_diff) %>% 
  mutate(Omicron_star = if_else(Omicron+lineage_change <= 1, Omicron + lineage_change, 1),
         Omicron_star_vaccine = if_else(Omicron_vaccine + lineage_change <=1, Omicron_vaccine+lineage_change, 1))


#### New scheme ####

Booster_Bump_WT <- diff_file %>% filter(variant == "WT") %>% select("WT_vax_diff")
Booster_Bump_Delta <- diff_file %>% filter(variant == "WT") %>% select("Delta_vax_diff")
Booster_Bump_Omicron <- diff_file %>% filter(variant == "WT") %>% select("Omicron_vax_diff")
Booster_Bump_Vaccine <- diff_file %>% filter(variant == "WT") %>% select("Vax_diff")

avg_change <- (Booster_Bump_WT$WT_vax_diff + 
                 Booster_Bump_Delta$Delta_vax_diff +
                 Booster_Bump_Omicron$Omicron_vax_diff +
                 Booster_Bump_Vaccine$Vax_diff)/4


######## make omicron* wave ########

savefile <- savefile %>% pivot_longer(-variant, 
                                      names_to = "history", 
                                      values_to = "paramfinal") %>% 
  pivot_wider(names_from = variant, values_from = paramfinal) %>% 
  mutate(Omicron_star = if_else(history == "Omicron_star" | history == "Omicron_star_vaccine",
                                Omicron-lineage_change, 
                                Omicron + lineage_change)) %>% 
  mutate(Omicron_star = if_else(Omicron_star <= 1, Omicron_star, 1)) %>%
  mutate(Omicron_star = if_else(Omicron_star >=0, Omicron_star, 0))

####### add bivalent and monovalent (40% of bivalent) booster ##########

## Assume that the bivalent takes us back to original vaccine efficacy, the monovalent is 40% of the bivalent


###### hypothesis 1: history penalty ######

## how to treat Omicron* in this regime - like an Omicron lineage?

savefile <- savefile %>% 
  mutate(Bivalent_penalty = case_when(
    history %in% c("Vaccine")  ~ Omicron_star + Booster_Bump_Vaccine$Vax_diff,
    history %in% c("Delta_vaccine") ~ Omicron_star + Booster_Bump_Delta$Delta_vax_diff,
    history %in% c("WT_vaccine") ~ Omicron_star + 0.5*(Booster_Bump_WT$WT_vax_diff + Booster_Bump_Omicron$Omicron_vax_diff),
    history %in% c("Omicron_vaccine","Omicron_star_vaccine") ~ Omicron_star + 0.5*(Booster_Bump_Omicron$Omicron_vax_diff + Booster_Bump_WT$WT_vax_diff),
    .default = NA
  )) %>%
  mutate(Monovalent_WTpenalty = case_when(
    history %in% c("Vaccine")  ~ Omicron_star + 1*Booster_Bump_Vaccine$Vax_diff,
    history %in% c("Delta_vaccine") ~ Omicron_star + 1*Booster_Bump_Delta$Delta_vax_diff,
    history %in% c("WT_vaccine") ~ Omicron_star + 1*Booster_Bump_WT$WT_vax_diff,
    history %in% c("Omicron_vaccine", "Omicron_star_vaccine") ~ Omicron_star + 1*Booster_Bump_Omicron$Omicron_vax_diff,
    .default = NA
  )) %>% 
  mutate(Monovalent_Ompenalty = case_when(
    history %in% c("Vaccine")  ~ Omicron_star + 1*Booster_Bump_Vaccine$Vax_diff,
    history %in% c("Delta_vaccine") ~ Omicron_star + 1*Booster_Bump_Delta$Delta_vax_diff,
    history %in% c("WT_vaccine") ~ Omicron_star + 1*Booster_Bump_Omicron$Omicron_vax_diff,
    history %in% c("Omicron_vaccine","Omicron_star_vaccine") ~ Omicron_star + 1*Booster_Bump_WT$WT_vax_diff,
    .default = NA
  )) 

###### hypothesis 2: everyone gets same benefit --  average change in the data ######

savefile <- savefile %>% 
  mutate(Bivalent_efficacy = case_when(
    history %in% c("Vaccine")  ~ Omicron_star + (avg_change),
    history %in% c("Delta_vaccine") ~ Omicron_star + (avg_change),
    history %in% c("WT_vaccine") ~ Omicron_star + (avg_change),
    history %in% c("Omicron_vaccine", "Omicron_star_vaccine") ~ Omicron_star + (avg_change),
    .default = NA
  )) %>%
  mutate(Monovalent_efficacy = case_when(
    history %in% c("Vaccine")  ~ Omicron_star + 1*(avg_change),
    history %in% c("Delta_vaccine") ~ Omicron_star + 1*(avg_change),
    history %in% c("WT_vaccine") ~ Omicron_star + 1*(avg_change),
    history %in% c("Omicron_vaccine", "Omicron_star_vaccine") ~ Omicron_star + 1*(avg_change),
    .default = NA
  ))

####### hypothesis 3: everyone goes to the min protection  of the same efficacy scenarios #####

bivalent_peak <- min(savefile$Bivalent_efficacy,na.rm = T)
monovalent_peak <- min(savefile$Monovalent_efficacy,na.rm = T)


savefile <- savefile %>% 
  mutate(Bivalent_endpoint = case_when(
    history %in% c("Vaccine")  ~ bivalent_peak,
    history %in% c("Delta_vaccine") ~ bivalent_peak,
    history %in% c("WT_vaccine") ~ bivalent_peak,
    history %in% c("Omicron_vaccine", "Omicron_star_vaccine") ~ bivalent_peak,
    .default = NA
  )) %>%
  mutate(Monovalent_endpoint = case_when(
    history %in% c("Vaccine")  ~ monovalent_peak, ## 40% of the max protection
    history %in% c("Delta_vaccine") ~ monovalent_peak,
    history %in% c("WT_vaccine") ~ monovalent_peak,
    history %in% c("Omicron_vaccine", "Omicron_star_vaccine") ~ monovalent_peak,
    .default = NA
  ))

######## make unknown serotypes #########

######## serotype of length 2 - unknown #######
adds <- savefile %>%
  mutate(history = case_when(
    history %in% c("WT", "Delta", "Vaccine", "Omicron", "Omicron_star") ~ "length 1",
    history %in% c("WT_vaccine", "Omicron_vaccine", "Delta_vaccine", "Omicron_star_vaccine") ~ "length 2"
  )) %>% 
  group_by(history) %>% 
  ## average for each wave by length
  summarise(WT = mean(WT), Delta = mean(Delta), Omicron = mean(Omicron), Omicron_star = mean(Omicron_star)) %>%
  filter(history == "length 2") %>%
  ungroup() %>% mutate(Bivalent_penalty = NA, Monovalent_WTpenalty = NA, Monovalent_Ompenalty = NA,
                       # Monovalent_Omstarpenalty = NA,
                       Bivalent_efficacy = NA, Monovalent_efficacy = NA,
                       Bivalent_endpoint = NA, Monovalent_endpoint = NA)

savefile <- rbind(savefile, adds)

######### add length 4+ ########

new_row = c(history = "length 4+", WT = as.numeric(0.05), 
            Delta = as.numeric(0.05), Omicron = as.numeric(0.05),
            Omicron_star = as.numeric(0.05), 
            Bivalent_penalty = NA, Monovalent_WTpenalty = NA, Monovalent_Ompenalty = NA,
            Bivalent_efficacy = NA, Monovalent_efficacy = NA,
            Bivalent_endpoint = NA, Monovalent_endpoint = NA)

savefile <- rbind(savefile, new_row) %>%
  mutate(WT = as.numeric(WT), Delta = as.numeric(Delta), 
         Omicron = as.numeric(Omicron), Omicron_star = as.numeric(Omicron_star),
         Bivalent_penalty = as.numeric(Bivalent_penalty), 
         Monovalent_WTpenalty = as.numeric(Monovalent_WTpenalty),
         Monovalent_Ompenalty = as.numeric(Monovalent_Ompenalty),
         Bivalent_efficacy = as.numeric(Bivalent_efficacy),
         Monovalent_efficacy = as.numeric(Monovalent_efficacy), 
         Bivalent_endpoint = as.numeric(Bivalent_endpoint),
         Monovalent_endpoint = as.numeric(Monovalent_endpoint))


######## add length 3 halfway between length 2 and length 3 ########

means <- savefile %>% filter(history == "length 2" | history == "length 4+") %>%
  summarise(WT = mean(WT), Delta = mean(Delta), Omicron = mean(Omicron), Omicron_star = mean(Omicron_star)) %>%
  mutate(Bivalent_penalty = NA, Monovalent_WTpenalty = NA, Monovalent_Ompenalty = NA,
         Bivalent_efficacy = NA, Monovalent_efficacy = NA,
         Bivalent_endpoint = NA, Monovalent_endpoint = NA) %>%
  add_column(history = "length 3", .before = "WT")

savefile <- rbind(savefile, means)

##### Get Omicron column - but bump bivalent by 0.05 and monovalent Omicron by 0.1

savefile <- savefile %>% 
  mutate(Monovalent_Omefficacy = Monovalent_efficacy,
         Monovalent_Omendpoint = Monovalent_endpoint) %>%
  rename(Monovalent_WTendpoint=Monovalent_endpoint,
         Monovalent_WTefficacy = Monovalent_efficacy) %>%
  pivot_longer(Bivalent_penalty:Monovalent_Omendpoint, 
               values_to = "protection_star", 
               names_to = "scenario") %>%
  mutate(protection_om = protection_star - 0.10) %>% ## account for adding the same bar but to an Omicron history instead of Omicron*
  mutate(protection_om = case_when(
    substr(scenario, 1, 3) == "Biv" ~ protection_om - 0.05,
    scenario %in% c("Monovalent_Omefficacy", "Monovalent_Ompenalty","Monovalent_Omendpoint") ~ protection_om-0.1,
    scenario %in% c("Monovalent_WTefficacy", "Monovalent_WTendpoint", "Monovalent_WTpenalty") ~ protection_om
  )) %>% 
  mutate(scenario_om = paste(scenario, "_Omicron"),
         scenario_om = gsub(" ", "", scenario_om))


test1 <- savefile %>% select(-c(scenario_om, protection_om))%>%
  mutate(protection_star = if_else(protection_star <= 1, protection_star, 1),
         protection_star = if_else(protection_star >=0, protection_star, 0)) %>%
  pivot_wider(names_from = scenario, values_from = protection_star) 

test2 <- savefile %>% select(-c(scenario,protection_star)) %>%
  mutate(protection_om = if_else(protection_om <= 1, protection_om, 1),
         protection_om = if_else(protection_om >=0, protection_om, 0)) %>%
  pivot_wider(names_from = scenario_om, values_from = protection_om)

test_full <- left_join(test1, test2, by = c("history", "WT", "Delta","Omicron", "Omicron_star"))


savefile_supplement <- test_full %>% arrange(history) %>% 
  pivot_longer(2:23, names_to = "type", values_to = "values") %>% 
  mutate(values = round(values, 2),
         values = if_else(
           values > 1, 1, values
         )) %>% 
  mutate(values = round(values, 2),
         values = if_else(
           values < 0, 0, values
         )) %>% 
  pivot_wider(names_from = "type", values_from = "values") %>% 
  arrange(history)

serotypes <- savefile_supplement
```

#### Booster protection values

Taking the booster values and chunking into pre-booster and post-booster

```{r}

## grab prebooster values
dat_barplot_scenarios1_100eff <- serotypes %>%
  select(history,Omicron_star) %>% 
  filter(history %in% c("Vaccine", "WT_vaccine", "Omicron_vaccine","Omicron_star_vaccine",  "Delta_vaccine")) %>% 
  rename(immunity = Omicron_star) %>% 
  select(history, immunity) %>% 
  mutate(history = recode(history, 
                          Delta_vaccine = "Delta + vaccine",
                          Omicron_vaccine = "Omicron + vaccine",
                          WT_vaccine = "WT + vaccine",
                          Vaccine = "Vaccine only", 
                          Omicron_star_vaccine = "Omicron* + vaccine")) %>% 
  rename(prebooster = immunity)

## grab postbooster values
dat_barplot_scenarios2_100eff <- serotypes %>%
  select(history,Bivalent_penalty, Monovalent_WTpenalty, Monovalent_Ompenalty,
         Bivalent_efficacy, Monovalent_WTefficacy,
         Monovalent_Omefficacy,
         Bivalent_endpoint, Monovalent_WTendpoint,
         Monovalent_Omendpoint) %>% 
  filter(history %in% c("Vaccine", "WT_vaccine", "Omicron_vaccine", "Delta_vaccine", "Omicron_star_vaccine")) %>% 
  pivot_longer(-history, values_to = "immunity") %>% 
  separate(name, into = c("booster", "scenario"), sep = "_") %>% 
  mutate(history = recode(history, 
                          Delta_vaccine = "Delta + vaccine",
                          Omicron_vaccine = "Omicron + vaccine",
                          WT_vaccine = "WT + vaccine",
                          Vaccine = "Vaccine only", 
                          Omicron_star_vaccine = "Omicron* + vaccine")) %>% 
  rename(postbooster = immunity)

## combine pre and post booster
data_protection_100eff <- left_join(dat_barplot_scenarios2_100eff, dat_barplot_scenarios1_100eff, by = "history") %>% 
  ## reverse everything; now we want protection instead of the scale-down parameter
  mutate(postbooster = 1-postbooster,
         prebooster = 1-prebooster,
         postbooster = postbooster-prebooster) %>% pivot_longer(postbooster:prebooster, names_to = "type", values_to = "immunity") %>%
  mutate(booster = if_else(substr(scenario, 1, 2) == "Om",
                           "Monovalent (Omicron)",
                           booster),
         booster = if_else(substr(scenario, 1, 2) == "WT",
                           "Monovalent (WT)",
                           booster))

```


#### Plot protection

```{r}
colors <- c("#BC8400","#7C2529","#005B40")

plot_100eff_protection <- data_protection_100eff %>% mutate(history = fct_relevel(history, 
        c("Omicron* + vaccine", "Omicron + vaccine","Delta + vaccine", 
          "WT + vaccine","Vaccine only"))) %>% 
  mutate(Scenario = recode(scenario, endpoint = "Same endpoint",
    efficacy = "Same efficacy", penalty = "History dependent",
    WTpenalty = "History dependent", Ompenalty = "History dependent",
    "no booster" = "No booster")) %>%
  mutate(scenario = fct_relevel(Scenario, 
        c("Same endpoint", "Same efficacy", "History dependent"))) %>%
  mutate(booster = fct_relevel(booster, 
         c("Monovalent (WT)", "Monovalent (Omicron)", "Bivalent"))) %>%
  mutate(type = recode(type, prebooster = "Pre-booster", 
                       postbooster = "Post-booster")) %>% 
  mutate(type = fct_relevel(type, c("Post-booster"))) %>% 
  filter(Scenario == "History dependent") %>% 
  ggplot(aes(alpha = type,y=immunity, x=history, group = type)) +
  geom_bar(aes(fill=booster), position="stack", stat="identity", color="black") + 
  scale_fill_manual("Booster", values = colors, guide = "none") +
  scale_y_continuous("Total protection", limits = c(0,1), expand= c(0,0),
                       breaks = c(0,0.3,0.6,0.9), 
                       labels = scales::percent_format(accuracy = 1)) +
  facet_wrap(~booster, ncol = 1, scales = "free") +
  scale_alpha_manual("Booster status", 
          values = c("Post-booster" = 0.4, "Pre-booster" = 1.6 )) + 
  scale_x_discrete("Immune history") + 
  theme_classic() + coord_flip() + 
  ggtitle("Booster scenarios - History specific model") + 
  theme(axis.text = element_text(size = 11, color = "black"), #  angle = 90
        axis.title.x = element_text(size = 12, color = "black",vjust = -1),
        axis.title.y = element_text(size = 12, color = "black",vjust = +3),
        axis.line = element_line(color = "black"),
        axis.ticks = element_line(color = "black"),
        plot.title = element_text(colour = "black", size = 13.5, face = "bold"),
        plot.subtitle = element_text(colour = "black", size = 12.5),
        plot.margin = unit(c(t=0.2, r=1.5, b=0.5, l=1.5), "cm"),
        legend.position = "top", plot.title.position = "plot",
        strip.text = element_text(colour = "black", size = 11, hjust = 0),
        strip.background = element_rect(colour="white", fill="white"),
        legend.key.height= unit(0.4, 'cm'),
        legend.key.width= unit(0.4, 'cm'),
        legend.title = element_text(size = 11, color = "black"),
        legend.text = element_text(size = 10, color = "black"),
        legend.margin=margin(t=0.8,r=0.5,b=0.2,l=-4,unit = "line"),
        panel.spacing = unit(0.5, "cm")) # , aspect.ratio=1) + 
plot_100eff_protection
```


#### Infections data
```{r}

rm(dataAll_2)
gc()

data_infections_WT <- df_100eff %>% 
  filter(vaccine_star == "no", boost_shape == "functional", speed=="fast") %>%
  filter(scenario %in% c("WTpenalty", "WTendpoint", "WTefficacy")) %>% 
  filter(booster == "Monovalent") %>% 
  mutate(booster = "Monovalent (WT)")

data_infections_Om <- df_100eff %>% 
  filter(vaccine_star == "no", boost_shape == "functional", speed=="fast") %>%
  filter(scenario %in% c("Ompenalty", "Omendpoint", "Omefficacy")) %>% 
  filter(booster == "Monovalent") %>% 
  mutate(booster = "Monovalent (Omicron)")

data_infections_Biv <- df_100eff %>% 
  filter(vaccine_star == "no", boost_shape == "functional", speed=="fast") %>%
  filter(booster == "Bivalent")

data_infections_NoBoost_penalty <- df_100eff %>% 
  filter(vaccine_star == "no", boost_shape == "no booster") %>%
  mutate(scenario = "penalty")%>% 
  mutate(booster = "No booster")

gc()

data_infections2_100eff <- rbind(data_infections_WT, data_infections_Om) %>%
  rbind(data_infections_Biv) %>%
  rbind(data_infections_NoBoost_penalty)

rm(data_infections_WT, data_infections_Om,
   data_infections_Biv,data_infections_NoBoost_penalty)

gc()
```
#### Plot infections
```{r}
colors <- c("#0D3660","#BC8400","#7C2529", "#005B40")

dat_supp_100eff <- data_infections2_100eff %>%
  mutate(time = start_sims + time) %>%
  filter(time >= start_sims + 900) %>%
  #mutate(time = time/30, 
  mutate(SAR = recode(SAR, `0.427` = "100%",
    `0.4697` = "110%", `0.5551` = "130%")) %>%
  mutate(SAR = fct_relevel(SAR, c("100%", "110%", "130%"))) %>% 
  mutate(Scenario = recode(scenario,
    endpoint = "Same endpoint",efficacy = "Same efficacy",
    penalty = "History dependent",WTpenalty = "History dependent",
    Ompenalty = "History dependent", "no booster" = "No booster")) %>%
  mutate(scenario = fct_relevel(Scenario, 
       c("No booster", "Same endpoint","Same efficacy","History dependent"))) %>% 
  mutate(booster = fct_relevel(booster, 
       c("No booster","Monovalent (WT)","Monovalent (Omicron)", "Bivalent"))) %>% 
  filter(scenario == "History dependent", SAR != "100%") %>%
  mutate(inf10K = 10000*infections_over_time/start_pop) %>%
  group_by(time,country,booster,scenario,SAR) %>%
  summarise(x  = smean.cl.normal(inf10K), 
            name = c("Mean","Lower","Upper")) %>% ungroup() %>%
  pivot_wider(names_from = name, values_from = x)

rm(data_infections2_100eff)
gc()
  
plot_supp_100eff <- dat_supp_100eff %>%
  mutate(country = case_when(
    country == "Ecuador" ~ "Ecuador-like",
    country == "India" ~ "India-like",
    country == "Malaysia" ~ "Malaysia-like"
  )) %>%
  
  ggplot(aes(x = time, fill = booster, 
            color = booster, linetype = SAR, 
            group = interaction(country, scenario, booster, SAR))) +
  geom_ribbon(aes(ymin = Lower, ymax = Upper), alpha = 0.5) + 
  geom_line(aes(y=Mean), alpha = 0) + theme_classic() + 
  scale_fill_manual("Booster type", values = colors) +
  scale_color_manual("Booster type", values = colors) + 
  ylab("Infections per 10,000") +
  facet_wrap(~country, scales = "free") + 
  ggh4x::facetted_pos_scales(y = list(
  country == "Ecuador-like" ~ scale_y_continuous(limits = c(0, NA), breaks = c(0,20,40,60,80)),
  country == "India-like" ~ scale_y_continuous(limits = c(0, NA)),
  country == "Malaysia-like" ~ scale_y_continuous(limits = c(0, NA), 
                                             breaks = c(0,30,60,90,120)))) + 
  #scale_y_continuous(, limits = c(0,NA)) + # expand = c(0,0) 
  #scale_x_continuous("Time (months)", expand = c(0,0.5), breaks = c(30,32,34,36)) +
    scale_x_date("Date", expand = c(0,0), date_breaks = "1 month", date_labels =  "%b %Y") +
  ggtitle("Infections during Omicron* - History specific model", "Booster efficacy of monovalent \n is not attenuated") + #, "Variant-specific model") +
  guides(linetype = guide_legend(override.aes = list(alpha = 1, fill=NA))) +
  scale_linetype_manual("Infectiousness", values = c("dashed")) +
  theme(axis.text = element_text(size = 11, color = "black"),
        axis.title.x = element_text(size = 12, color = "black",vjust = -1),
        axis.text.x=element_text(angle=60, hjust=1),
        axis.title.y = element_text(size = 12, color = "black",vjust = +3),
        axis.line = element_line(color = "black"),
        axis.ticks = element_line(color = "black"),
        plot.title = element_text(colour = "black", size = 13.5, face = "bold"),
        plot.subtitle = element_text(colour = "black", size = 12.5),
        plot.title.position = "plot",
        plot.margin = unit(c(t=0.2, r=1, b=0.2, l=1.5), "cm"),
        legend.position = "top",
        strip.text = element_text(colour = "black", size = 11, hjust = 0),
        strip.background = element_rect(colour="white", fill="white"),
        legend.margin=margin(t=0.8,r=0.5,b=0.2,l=0,unit = "line"),
        legend.key.height= unit(0.4, 'cm'),
        legend.key.width= unit(0.4, 'cm'),
        legend.title = element_text(size = 11, color = "black"),
        legend.text = element_text(size = 10, color = "black"),
        panel.spacing = unit(0.5, "cm")) #, aspect.ratio=1,
        #panel.grid.major = element_line(color = "grey95"),
        #panel.grid.minor = element_line(color = "grey95")) 
plot_supp_100eff
```
#### Data Deaths

Calculating the deaths averted

```{r}
df_compare_100eff <-  df_100eff %>% 
  filter(boost == "no", vaccine_star == "no") %>% 
  filter(time >= 900) %>% 
  group_by(SAR, country, replicate) %>% 
  mutate(deaths10K = 10000*deaths_over_time/start_pop) %>%
  #mutate(deaths_high = max(deaths), deaths_low = min(deaths))
  summarise(
    death_compare_10K = max(deaths10K)-min(deaths10K)
  ) %>%
  ungroup()

df_avert_100eff <- df_100eff %>% 
  filter(boost == "yes", vaccine_star == "no", boost_shape == "functional", speed=="fast") %>% 
  #filter(time >= 930/365) %>% 
  filter(time >= 900) %>%
  group_by(SAR, scenario, booster, country, replicate) %>% ## matching each booster scenario to a no booster scenario
  mutate(deaths10K = 10000*deaths_over_time/start_pop) %>%
  summarise(
    deaths_10K = max(deaths10K, na.rm = T)-min(deaths10K, na.rm = T)
  ) %>%
  ungroup()

df_avert_rr_100eff <- left_join(df_avert_100eff, df_compare_100eff, by = c("SAR", "country", "replicate")) %>%
  group_by(SAR, country, booster, scenario, replicate) %>%
  mutate(da10K = death_compare_10K-deaths_10K,
         da_perc = da10K/death_compare_10K) %>%
ungroup() %>%
  select(
    SAR, country, replicate, scenario = scenario, booster = booster, death_compare_10K, deaths_10K, da10K, da_perc)

  

# df_avert_rr <- left_join(df_avert, df_compare, by = c("SAR", "country", "replicate")) %>% 
#   group_by(SAR, country, booster, scenario, replicate) %>% 
#   mutate(rr = deaths/death_compare,
#          da = 1-rr) %>%
# ungroup() %>% 
#   select(
#     SAR, country, replicate, scenario = scenario, booster = booster, da)


df_avert_rr_splitWT <- df_avert_rr_100eff %>% 
  filter(scenario %in% c("WTpenalty", "WTendpoint", "WTefficacy")) %>% 
  filter(booster == "Monovalent") %>% 
  mutate(booster = "Monovalent (WT)")
df_avert_rr_splitOm <- df_avert_rr_100eff %>% 
  filter(scenario %in% c("Ompenalty", "Omendpoint", "Omefficacy")) %>% 
  filter(booster == "Monovalent") %>% 
  mutate(booster = "Monovalent (Omicron)")

df_avert_rr2_100eff <- df_avert_rr_100eff %>%
  filter(booster == "Bivalent" | booster == "no booster" | booster == "No booster") %>%
  rbind(df_avert_rr_splitWT) %>% 
  rbind(df_avert_rr_splitOm)

rm(df_avert_rr_splitOm, df_avert_rr_splitWT)

```

#### Plot deaths averted

```{r}
colors <- c("#BC8400","#7C2529","#005B40")

comparisons <- list( c("Bivalent", "Monovalent (WT)"), 
                        c("Bivalent", "Monovalent (Omicron)"), 
                        c("Monovalent (WT)", "Monovalent (Omicron)"))

dat_100eff_da <- df_avert_rr2_100eff %>% 
  mutate(Booster = fct_relevel(booster, "Monovalent")) %>% 
  mutate(SAR = recode(SAR,`0.427` = "100%",
    `0.4697` = "110%", `0.5551` = "130%")) %>%
  mutate(SAR = fct_relevel(SAR, c("100%", "110%", "130%"))) %>% 
  mutate(Scenario = recode(scenario, endpoint = "Same endpoint",
    efficacy = "Same efficacy", penalty = "History dependent",
    WTpenalty = "History dependent", Ompenalty = "History dependent",
    "no booster" = "No booster")) %>%
  filter(Scenario == "History dependent" | Scenario == "No booster") %>%
  filter(SAR != "100%") %>% mutate(Scenario = fct_relevel(Scenario, 
        c("Same endpoint", "Same efficacy", "History dependent"))) %>%
  group_by(SAR,country,Scenario,Booster,) %>%
  summarise(x  = smean.cl.normal(da10K), 
            name = c("Mean","Lower","Upper")) %>% ungroup() %>%
  pivot_wider(names_from = name, values_from = x) %>%
  mutate(Booster = fct_relevel(Booster, 
       c("Monovalent (WT)","Monovalent (Omicron)", "Bivalent")))

plot_100eff_da <- dat_100eff_da %>%
  mutate(country = case_when(
    country == "Ecuador" ~ "Ecuador-like",
    country == "India" ~ "India-like",
    country == "Malaysia" ~ "Malaysia-like"
  )) %>%
  ggplot(aes(x = SAR, fill = Booster, color = Booster,
                     group = interaction(Booster, SAR, Scenario))) + 
  geom_bar(aes(y=Mean), stat="identity", position=position_dodge(0.7),  
           alpha=0.5, size = 0.6, width = 0.6) + theme_classic() +
  geom_errorbar(aes(ymin  = Lower, ymax  = Upper),
           stat="identity", position=position_dodge(0.7),  
           size = 0.6, width = 0.3, show.legend=FALSE) + 
    geom_text(aes(label = round(Mean, 2), y = Upper + 0.2), position=position_dodge(0.7), size = 3) + ## this line adds the labels
  scale_fill_manual("Booster", values = colors) +
  scale_color_manual("Booster", values = colors) +
  facet_wrap(~country, scales = "free", nrow = 1) +
  scale_y_continuous("Deaths averted per 10,000", limits = c(0,5), 
                     expand = expansion(mult = c(0,0))) + 
  scale_x_discrete("Infectiousness relative to Omicron") +
  ggtitle("Deaths averted - History specific model", "Booster efficacy of monovalent \n is not attenuated") + #, subtitle = "Variant-specific model") + 
  theme(axis.text = element_text(size = 11, color = "black"),
        axis.title.x = element_text(size = 12, color = "black",vjust = -1),
        axis.title.y = element_text(size = 12, color = "black",vjust = +3),
        axis.line = element_line(color = "black"),
        axis.ticks = element_line(color = "black"),
        plot.title = element_text(colour = "black", size = 13.5, face = "bold"),
        plot.subtitle = element_text(colour = "black", size = 12.5),
        plot.title.position = "plot",
        plot.margin = unit(c(t=0.2, r=1, b=0.5, l=1.5), "cm"),
        legend.position = "none",
        # legend.margin=margin(t=0.5,r=0.5,b=0.5,l=0.5,unit = "line"),
        # legend.key.height= unit(0.4, 'cm'),
        # legend.key.width= unit(0.4, 'cm'),
        # legend.title = element_text(size = 11, color = "black"),
        # legend.text = element_text(size = 10, color = "black"),
        strip.text = element_text(colour = "black", size = 11, hjust = 0),
        strip.background = element_rect(colour="white", fill="white"),
        panel.spacing = unit(0.5, "cm")) #, aspect.ratio=0.7)
plot_100eff_da
```


```{r}
plot_grid_BC <- plot_grid(plot_supp_100eff, plot_100eff_da, nrow = 2,labels = c("B", "C"), rel_heights = c(1.1, 1))
plot_grid_100eff <- plot_grid(plot_100eff_protection, plot_grid_BC, nrow = 1, labels = c("A", ""), rel_widths = c(0.5, 1))

ggsave("../Supplement/SR-100eff.pdf", plot_grid_100eff, height = 7.5, width = 15)
```



### Mono 53% attenuation

```{r}

## change time to date
start_sims <- as.Date("2020-03-15", "%Y-%m-%d") 

## get ABM seed populations for each country ##
pop_ABM <- read_csv("../Data/ABM_Parameters_Data/Grid_Param.csv") %>% select(Name, child, adult, old) %>%
  summarise(Name,start_pop = 2*(child + adult+ old)) %>% 
  distinct() %>% 
  arrange(Name) %>% 
  rename(country = Name)

df_53eff <- read_csv("../Data/ABM Supplement/supp8-53boostereff/dataAll.csv") %>%
  left_join(pop_ABM) %>%
  group_by(ID_runs, time) %>% 
  filter(cum_sum_Inf == max(cum_sum_Inf)) %>%
  ungroup()  %>%
  filter(booster != "Bivalent")

## grab main text 
dataAll_2 <- read_csv("../Data/ABM Main Runs/dataAll.csv") %>% 
  filter(SAR == max(SAR)) %>%
  left_join(pop_ABM) %>%
  group_by(ID_runs, time) %>% 
  filter(cum_sum_Inf == max(cum_sum_Inf)) %>%
  ungroup() %>% 
  filter(booster != "Monovalent")

df_53eff <- df_53eff %>% rbind(dataAll_2)

```

#### titers
```{r}

########## Man. paper #########

## neutralizing antibody titres
dataMan <- read_excel("../Data/ABM_Parameters_Data/Manali et al/New_Supplementary_Data_File.xlsx") %>% 
  select(doses = `Number of Vaccine Doses`, Group, 
         WT = `Wuhan Titre`, Delta = `Delta Titre`, Omicron = `Omicron Titre`) %>% 
  filter(doses > 1 | doses == 0) %>% ## 2 or more doses
  filter(Group != "I_Av" & Group != "I_A" & Group != "N") %>%
  mutate(
    History = case_when(
      Group == "I_Wv" ~ "WT_vaccine",
      Group == "I_W" ~ "WT",
      Group == "I_Dv" ~ "Delta_vaccine",
      Group == "I_D" ~ "Delta",
      Group == "V" ~ "Vaccine")) %>% 
  select(History, WT, Delta, Omicron) %>% 
  pivot_longer(WT:Omicron, names_to = "Variant", values_to = "Titre")

######## data_Surya #######
  
##unvaccinated and hybrid individuals, NT50 - 2-3 doses
data_Surya <- read_excel("../Data/ABM_Parameters_Data/Suryawanshi et al. 2022/reformat.xlsx") %>% 
  select(History = history, WT = WA1, Delta, Omicron) %>% 
  pivot_longer(WT:Omicron, names_to = "Variant", values_to = "Titre")


######### Test plot ########

test_Man <- dataMan %>% mutate(paper = "Man") 
test_Surya <- data_Surya %>% mutate(paper = "Surya")

plot_check <- test_Man %>% rbind(test_Surya) %>% 
  filter(History != "Naive") %>% 
  group_by(History, Variant, paper) %>%
  mutate(Titre = as.numeric(Titre), 
         Titre = if_else(Titre < 1, 1, Titre)) %>% ## clean out -Inf values - if someone's titre is 0, approximate it by 1
  mutate(Titre = log10(Titre)) %>% 
  summarise(Titre = mean(Titre, na.rm = T)) %>% 
  ggplot(aes(x = History, y = Titre, group = History, fill = History)) + 
  geom_col(position = "dodge") + 
  facet_grid(paper~Variant)
plot_check

#ggsave("Show_titres.pdf", plot_check, width = 12, height = 8)


########## Get full table #########

## get an immunity table combining all sources
fullDat <- rbind(dataMan, data_Surya) %>% 
  filter(History != "Naive") %>% 
  mutate(Titre = as.numeric(Titre)) %>% 
  mutate(
    Titre = if_else(Titre < 1, 1, Titre), ## clean out -Inf - if titre is between 0-1, approximate it by 1
    Titre = log10(Titre) ## get log scale titre
  ) %>% 
  group_by(History, Variant) %>% 
  summarise(
    Titre = mean(Titre, na.rm = T), ## grab mean log titre
         minuslogTitre = -Titre) %>% ## get minus log titre since we want to scale a reduction in a param
  ungroup() %>% 
  mutate(paramfinal = rescale(minuslogTitre, to = c(0.05, 0.95))) %>% 
  arrange(paramfinal) %>% 
  select(Serotype = History, variant = Variant, paramfinal) %>% 
  mutate(paramfinal = round(paramfinal, 2))

## test 
plot <- fullDat %>% 
  mutate(variant = fct_relevel(variant, c("WT", "Delta", "Omicron"))) %>% 
  ggplot(aes(x = variant, y = Serotype, fill = 1-paramfinal)) + 
  geom_tile() + 
  scale_fill_viridis_c()
plot

## get transition between WT to Delta
fullDat_transition <- fullDat %>% 
  pivot_wider(names_from = "variant", values_from = "paramfinal") %>% 
  mutate(diffWT_to_DT = round(mean(Delta-WT),2), diffDT_to_Om = round(mean(Omicron-Delta),2))

lineage_change <- fullDat_transition$diffWT_to_DT[1]

## transition from WT to Delta: lineage_change
  
savefile <- fullDat %>% 
  pivot_wider(names_from = Serotype, values_from = paramfinal)


## get the difference from a vaccine to get the Omicron serotype
diff_file <- savefile %>% 
  mutate(Delta_vax_diff = Delta_vaccine - Delta,
         WT_vax_diff = WT_vaccine - WT,
         Omicron_vax_diff = Omicron_vaccine - Omicron,
         Vax_diff = Vaccine - 1) ##this is the base change for ppl getting a vaccine


savefile <- savefile %>% 
  ## rule: Omicron = Omicron_vaccine - vaccine benefit i.e. the change for Delta
  #mutate(Omicron = Omicron_vaccine - diff_file$Delta_vax_diff) %>% 
  mutate(Omicron_star = if_else(Omicron+lineage_change <= 1, Omicron + lineage_change, 1),
         Omicron_star_vaccine = if_else(Omicron_vaccine + lineage_change <=1, Omicron_vaccine+lineage_change, 1))


#### New scheme ####

Booster_Bump_WT <- diff_file %>% filter(variant == "WT") %>% select("WT_vax_diff")
Booster_Bump_Delta <- diff_file %>% filter(variant == "WT") %>% select("Delta_vax_diff")
Booster_Bump_Omicron <- diff_file %>% filter(variant == "WT") %>% select("Omicron_vax_diff")
Booster_Bump_Vaccine <- diff_file %>% filter(variant == "WT") %>% select("Vax_diff")

avg_change <- (Booster_Bump_WT$WT_vax_diff + 
                 Booster_Bump_Delta$Delta_vax_diff +
                 Booster_Bump_Omicron$Omicron_vax_diff +
                 Booster_Bump_Vaccine$Vax_diff)/4


######## make omicron* wave ########

savefile <- savefile %>% pivot_longer(-variant, 
                                      names_to = "history", 
                                      values_to = "paramfinal") %>% 
  pivot_wider(names_from = variant, values_from = paramfinal) %>% 
  mutate(Omicron_star = if_else(history == "Omicron_star" | history == "Omicron_star_vaccine",
                                Omicron-lineage_change, 
                                Omicron + lineage_change)) %>% 
  mutate(Omicron_star = if_else(Omicron_star <= 1, Omicron_star, 1)) %>%
  mutate(Omicron_star = if_else(Omicron_star >=0, Omicron_star, 0))

####### add bivalent and monovalent (40% of bivalent) booster ##########

## Assume that the bivalent takes us back to original vaccine efficacy, the monovalent is 40% of the bivalent


###### hypothesis 1: history penalty ######

## how to treat Omicron* in this regime - like an Omicron lineage?

savefile <- savefile %>% 
  mutate(Bivalent_penalty = case_when(
    history %in% c("Vaccine")  ~ Omicron_star + Booster_Bump_Vaccine$Vax_diff,
    history %in% c("Delta_vaccine") ~ Omicron_star + Booster_Bump_Delta$Delta_vax_diff,
    history %in% c("WT_vaccine") ~ Omicron_star + 0.5*(Booster_Bump_WT$WT_vax_diff + Booster_Bump_Omicron$Omicron_vax_diff),
    history %in% c("Omicron_vaccine","Omicron_star_vaccine") ~ Omicron_star + 0.5*(Booster_Bump_Omicron$Omicron_vax_diff + Booster_Bump_WT$WT_vax_diff),
    .default = NA
  )) %>%
  mutate(Monovalent_WTpenalty = case_when(
    history %in% c("Vaccine")  ~ Omicron_star + 0.53*Booster_Bump_Vaccine$Vax_diff,
    history %in% c("Delta_vaccine") ~ Omicron_star + 0.53*Booster_Bump_Delta$Delta_vax_diff,
    history %in% c("WT_vaccine") ~ Omicron_star + 0.53*Booster_Bump_WT$WT_vax_diff,
    history %in% c("Omicron_vaccine", "Omicron_star_vaccine") ~ Omicron_star + 0.53*Booster_Bump_Omicron$Omicron_vax_diff,
    .default = NA
  )) %>% 
  mutate(Monovalent_Ompenalty = case_when(
    history %in% c("Vaccine")  ~ Omicron_star + 0.53*Booster_Bump_Vaccine$Vax_diff,
    history %in% c("Delta_vaccine") ~ Omicron_star + 0.53*Booster_Bump_Delta$Delta_vax_diff,
    history %in% c("WT_vaccine") ~ Omicron_star + 0.53*Booster_Bump_Omicron$Omicron_vax_diff,
    history %in% c("Omicron_vaccine","Omicron_star_vaccine") ~ Omicron_star + 0.53*Booster_Bump_WT$WT_vax_diff,
    .default = NA
  )) 

###### hypothesis 2: everyone gets same benefit --  average change in the data ######

savefile <- savefile %>% 
  mutate(Bivalent_efficacy = case_when(
    history %in% c("Vaccine")  ~ Omicron_star + (avg_change),
    history %in% c("Delta_vaccine") ~ Omicron_star + (avg_change),
    history %in% c("WT_vaccine") ~ Omicron_star + (avg_change),
    history %in% c("Omicron_vaccine", "Omicron_star_vaccine") ~ Omicron_star + (avg_change),
    .default = NA
  )) %>%
  mutate(Monovalent_efficacy = case_when(
    history %in% c("Vaccine")  ~ Omicron_star + 0.53*(avg_change),
    history %in% c("Delta_vaccine") ~ Omicron_star + 0.53*(avg_change),
    history %in% c("WT_vaccine") ~ Omicron_star + 0.53*(avg_change),
    history %in% c("Omicron_vaccine", "Omicron_star_vaccine") ~ Omicron_star + 1*(avg_change),
    .default = NA
  ))

####### hypothesis 3: everyone goes to the min protection  of the same efficacy scenarios #####

bivalent_peak <- min(savefile$Bivalent_efficacy,na.rm = T)
monovalent_peak <- min(savefile$Monovalent_efficacy,na.rm = T)


savefile <- savefile %>% 
  mutate(Bivalent_endpoint = case_when(
    history %in% c("Vaccine")  ~ bivalent_peak,
    history %in% c("Delta_vaccine") ~ bivalent_peak,
    history %in% c("WT_vaccine") ~ bivalent_peak,
    history %in% c("Omicron_vaccine", "Omicron_star_vaccine") ~ bivalent_peak,
    .default = NA
  )) %>%
  mutate(Monovalent_endpoint = case_when(
    history %in% c("Vaccine")  ~ monovalent_peak, ## 40% of the max protection
    history %in% c("Delta_vaccine") ~ monovalent_peak,
    history %in% c("WT_vaccine") ~ monovalent_peak,
    history %in% c("Omicron_vaccine", "Omicron_star_vaccine") ~ monovalent_peak,
    .default = NA
  ))

######## make unknown serotypes #########

######## serotype of length 2 - unknown #######
adds <- savefile %>%
  mutate(history = case_when(
    history %in% c("WT", "Delta", "Vaccine", "Omicron", "Omicron_star") ~ "length 1",
    history %in% c("WT_vaccine", "Omicron_vaccine", "Delta_vaccine", "Omicron_star_vaccine") ~ "length 2"
  )) %>% 
  group_by(history) %>% 
  ## average for each wave by length
  summarise(WT = mean(WT), Delta = mean(Delta), Omicron = mean(Omicron), Omicron_star = mean(Omicron_star)) %>%
  filter(history == "length 2") %>%
  ungroup() %>% mutate(Bivalent_penalty = NA, Monovalent_WTpenalty = NA, Monovalent_Ompenalty = NA,
                       # Monovalent_Omstarpenalty = NA,
                       Bivalent_efficacy = NA, Monovalent_efficacy = NA,
                       Bivalent_endpoint = NA, Monovalent_endpoint = NA)

savefile <- rbind(savefile, adds)

######### add length 4+ ########

new_row = c(history = "length 4+", WT = as.numeric(0.05), 
            Delta = as.numeric(0.05), Omicron = as.numeric(0.05),
            Omicron_star = as.numeric(0.05), 
            Bivalent_penalty = NA, Monovalent_WTpenalty = NA, Monovalent_Ompenalty = NA,
            Bivalent_efficacy = NA, Monovalent_efficacy = NA,
            Bivalent_endpoint = NA, Monovalent_endpoint = NA)

savefile <- rbind(savefile, new_row) %>%
  mutate(WT = as.numeric(WT), Delta = as.numeric(Delta), 
         Omicron = as.numeric(Omicron), Omicron_star = as.numeric(Omicron_star),
         Bivalent_penalty = as.numeric(Bivalent_penalty), 
         Monovalent_WTpenalty = as.numeric(Monovalent_WTpenalty),
         Monovalent_Ompenalty = as.numeric(Monovalent_Ompenalty),
         Bivalent_efficacy = as.numeric(Bivalent_efficacy),
         Monovalent_efficacy = as.numeric(Monovalent_efficacy), 
         Bivalent_endpoint = as.numeric(Bivalent_endpoint),
         Monovalent_endpoint = as.numeric(Monovalent_endpoint))


######## add length 3 halfway between length 2 and length 3 ########

means <- savefile %>% filter(history == "length 2" | history == "length 4+") %>%
  summarise(WT = mean(WT), Delta = mean(Delta), Omicron = mean(Omicron), Omicron_star = mean(Omicron_star)) %>%
  mutate(Bivalent_penalty = NA, Monovalent_WTpenalty = NA, Monovalent_Ompenalty = NA,
         Bivalent_efficacy = NA, Monovalent_efficacy = NA,
         Bivalent_endpoint = NA, Monovalent_endpoint = NA) %>%
  add_column(history = "length 3", .before = "WT")

savefile <- rbind(savefile, means)

##### Get Omicron column - but bump bivalent by 0.05 and monovalent Omicron by 0.1

savefile <- savefile %>% 
  mutate(Monovalent_Omefficacy = Monovalent_efficacy,
         Monovalent_Omendpoint = Monovalent_endpoint) %>%
  rename(Monovalent_WTendpoint=Monovalent_endpoint,
         Monovalent_WTefficacy = Monovalent_efficacy) %>%
  pivot_longer(Bivalent_penalty:Monovalent_Omendpoint, 
               values_to = "protection_star", 
               names_to = "scenario") %>%
  mutate(protection_om = protection_star - 0.10) %>% ## account for adding the same bar but to an Omicron history instead of Omicron*
  mutate(protection_om = case_when(
    substr(scenario, 1, 3) == "Biv" ~ protection_om - 0.05,
    scenario %in% c("Monovalent_Omefficacy", "Monovalent_Ompenalty","Monovalent_Omendpoint") ~ protection_om-0.1,
    scenario %in% c("Monovalent_WTefficacy", "Monovalent_WTendpoint", "Monovalent_WTpenalty") ~ protection_om
  )) %>% 
  mutate(scenario_om = paste(scenario, "_Omicron"),
         scenario_om = gsub(" ", "", scenario_om))


test1 <- savefile %>% select(-c(scenario_om, protection_om))%>%
  mutate(protection_star = if_else(protection_star <= 1, protection_star, 1),
         protection_star = if_else(protection_star >=0, protection_star, 0)) %>%
  pivot_wider(names_from = scenario, values_from = protection_star) 

test2 <- savefile %>% select(-c(scenario,protection_star)) %>%
  mutate(protection_om = if_else(protection_om <= 1, protection_om, 1),
         protection_om = if_else(protection_om >=0, protection_om, 0)) %>%
  pivot_wider(names_from = scenario_om, values_from = protection_om)

test_full <- left_join(test1, test2, by = c("history", "WT", "Delta","Omicron", "Omicron_star"))


savefile_supplement <- test_full %>% arrange(history) %>% 
  pivot_longer(2:23, names_to = "type", values_to = "values") %>% 
  mutate(values = round(values, 2),
         values = if_else(
           values > 1, 1, values
         )) %>% 
  mutate(values = round(values, 2),
         values = if_else(
           values < 0, 0, values
         )) %>% 
  pivot_wider(names_from = "type", values_from = "values") %>% 
  arrange(history)
```

#### Booster protection values

Taking the booster values and chunking into pre-booster and post-booster

```{r}

serotypes <- savefile_supplement

## grab prebooster values
dat_barplot_scenarios1_53eff <- serotypes %>%
  select(history,Omicron_star) %>% 
  filter(history %in% c("Vaccine", "WT_vaccine", "Omicron_vaccine","Omicron_star_vaccine",  "Delta_vaccine")) %>% 
  rename(immunity = Omicron_star) %>% 
  select(history, immunity) %>% 
  mutate(history = recode(history, 
                          Delta_vaccine = "Delta + vaccine",
                          Omicron_vaccine = "Omicron + vaccine",
                          WT_vaccine = "WT + vaccine",
                          Vaccine = "Vaccine only", 
                          Omicron_star_vaccine = "Omicron* + vaccine")) %>% 
  rename(prebooster = immunity)

## grab postbooster values
dat_barplot_scenarios2_53eff <- serotypes %>%
  select(history,Bivalent_penalty, Monovalent_WTpenalty, Monovalent_Ompenalty,
         Bivalent_efficacy, Monovalent_WTefficacy,
         Monovalent_Omefficacy,
         Bivalent_endpoint, Monovalent_WTendpoint,
         Monovalent_Omendpoint) %>% 
  filter(history %in% c("Vaccine", "WT_vaccine", "Omicron_vaccine", "Delta_vaccine", "Omicron_star_vaccine")) %>% 
  pivot_longer(-history, values_to = "immunity") %>% 
  separate(name, into = c("booster", "scenario"), sep = "_") %>% 
  mutate(history = recode(history, 
                          Delta_vaccine = "Delta + vaccine",
                          Omicron_vaccine = "Omicron + vaccine",
                          WT_vaccine = "WT + vaccine",
                          Vaccine = "Vaccine only", 
                          Omicron_star_vaccine = "Omicron* + vaccine")) %>% 
  rename(postbooster = immunity)

## combine pre and post booster
data_protection_53eff <- left_join(dat_barplot_scenarios2_53eff, dat_barplot_scenarios1_53eff, by = "history") %>% 
  ## reverse everything; now we want protection instead of the scale-down parameter
  mutate(postbooster = 1-postbooster,
         prebooster = 1-prebooster,
         postbooster = postbooster-prebooster) %>% pivot_longer(postbooster:prebooster, names_to = "type", values_to = "immunity") %>%
  mutate(booster = if_else(substr(scenario, 1, 2) == "Om",
                           "Monovalent (Omicron)",
                           booster),
         booster = if_else(substr(scenario, 1, 2) == "WT",
                           "Monovalent (WT)",
                           booster))

```


#### Plot protection

```{r}
colors <- c("#BC8400","#7C2529","#005B40")

plot_53eff_protection <- data_protection_53eff %>% mutate(history = fct_relevel(history, 
        c("Omicron* + vaccine", "Omicron + vaccine","Delta + vaccine", 
          "WT + vaccine","Vaccine only"))) %>% 
  mutate(Scenario = recode(scenario, endpoint = "Same endpoint",
    efficacy = "Same efficacy", penalty = "History dependent",
    WTpenalty = "History dependent", Ompenalty = "History dependent",
    "no booster" = "No booster")) %>%
  mutate(scenario = fct_relevel(Scenario, 
        c("Same endpoint", "Same efficacy", "History dependent"))) %>%
  mutate(booster = fct_relevel(booster, 
         c("Monovalent (WT)", "Monovalent (Omicron)", "Bivalent"))) %>%
  mutate(type = recode(type, prebooster = "Pre-booster", 
                       postbooster = "Post-booster")) %>% 
  mutate(type = fct_relevel(type, c("Post-booster"))) %>% 
  filter(Scenario == "History dependent") %>% 
  ggplot(aes(alpha = type,y=immunity, x=history, group = type)) +
  geom_bar(aes(fill=booster), position="stack", stat="identity", color="black") + 
  scale_fill_manual("Booster", values = colors, guide = "none") +
  scale_y_continuous("Total protection", limits = c(0,1), expand= c(0,0),
                       breaks = c(0,0.3,0.6,0.9), 
                       labels = scales::percent_format(accuracy = 1)) +
  facet_wrap(~booster, ncol = 1, scales = "free") +
  scale_alpha_manual("Booster status", 
          values = c("Post-booster" = 0.4, "Pre-booster" = 1.6 )) + 
  scale_x_discrete("Immune history") + 
  theme_classic() + coord_flip() + 
  ggtitle("Booster scenarios - History specific model") + 
  theme(axis.text = element_text(size = 11, color = "black"), #  angle = 90
        axis.title.x = element_text(size = 12, color = "black",vjust = -1),
        axis.title.y = element_text(size = 12, color = "black",vjust = +3),
        axis.line = element_line(color = "black"),
        axis.ticks = element_line(color = "black"),
        plot.title = element_text(colour = "black", size = 13.5, face = "bold"),
        plot.subtitle = element_text(colour = "black", size = 12.5),
        plot.margin = unit(c(t=0.2, r=1.5, b=0.5, l=1.5), "cm"),
        legend.position = "top", plot.title.position = "plot",
        strip.text = element_text(colour = "black", size = 11, hjust = 0),
        strip.background = element_rect(colour="white", fill="white"),
        legend.key.height= unit(0.4, 'cm'),
        legend.key.width= unit(0.4, 'cm'),
        legend.title = element_text(size = 11, color = "black"),
        legend.text = element_text(size = 10, color = "black"),
        legend.margin=margin(t=0.8,r=0.5,b=0.2,l=-4,unit = "line"),
        panel.spacing = unit(0.5, "cm")) # , aspect.ratio=1) + 
plot_53eff_protection
```


#### Infections data
```{r}

rm(dataAll_2)
gc()

data_infections_WT <- df_53eff %>% 
  filter(vaccine_star == "no", boost_shape == "functional", speed=="fast") %>%
  filter(scenario %in% c("WTpenalty", "WTendpoint", "WTefficacy")) %>% 
  filter(booster == "Monovalent") %>% 
  mutate(booster = "Monovalent (WT)")

data_infections_Om <- df_53eff %>% 
  filter(vaccine_star == "no", boost_shape == "functional", speed=="fast") %>%
  filter(scenario %in% c("Ompenalty", "Omendpoint", "Omefficacy")) %>% 
  filter(booster == "Monovalent") %>% 
  mutate(booster = "Monovalent (Omicron)")

data_infections_Biv <- df_53eff %>% 
  filter(vaccine_star == "no", boost_shape == "functional", speed=="fast") %>%
  filter(booster == "Bivalent")

data_infections_NoBoost_penalty <- df_53eff %>% 
  filter(vaccine_star == "no", boost_shape == "no booster") %>%
  mutate(scenario = "penalty")%>% 
  mutate(booster = "No booster")

gc()

data_infections2_53eff <- rbind(data_infections_WT, data_infections_Om) %>%
  rbind(data_infections_Biv) %>%
  rbind(data_infections_NoBoost_penalty)

rm(data_infections_WT, data_infections_Om,
   data_infections_Biv,data_infections_NoBoost_penalty)

gc()
```
#### Plot infections
```{r}
colors <- c("#0D3660","#BC8400","#7C2529", "#005B40")

dat_supp_53eff <- data_infections2_53eff %>%
  mutate(time = start_sims + time) %>%
  filter(time >= start_sims + 900) %>%
  #mutate(time = time/30, 
  mutate(SAR = recode(SAR, `0.427` = "100%",
    `0.4697` = "110%", `0.5551` = "130%")) %>%
  mutate(SAR = fct_relevel(SAR, c("100%", "110%", "130%"))) %>% 
  mutate(Scenario = recode(scenario,
    endpoint = "Same endpoint",efficacy = "Same efficacy",
    penalty = "History dependent",WTpenalty = "History dependent",
    Ompenalty = "History dependent", "no booster" = "No booster")) %>%
  mutate(scenario = fct_relevel(Scenario, 
       c("No booster", "Same endpoint","Same efficacy","History dependent"))) %>% 
  mutate(booster = fct_relevel(booster, 
       c("No booster","Monovalent (WT)","Monovalent (Omicron)", "Bivalent"))) %>% 
  filter(scenario == "History dependent", SAR != "100%") %>%
  mutate(inf10K = 10000*infections_over_time/start_pop) %>%
  group_by(time,country,booster,scenario,SAR) %>%
  summarise(x  = smean.cl.normal(inf10K), 
            name = c("Mean","Lower","Upper")) %>% ungroup() %>%
  pivot_wider(names_from = name, values_from = x)

rm(data_infections2_53eff)
gc()
  
plot_supp_53eff <- dat_supp_53eff %>%
  mutate(country = case_when(
    country == "Ecuador" ~ "Ecuador-like",
    country == "India" ~ "India-like",
    country == "Malaysia" ~ "Malaysia-like"
  )) %>%
  ggplot(aes(x = time, fill = booster, 
            color = booster, linetype = SAR, 
            group = interaction(country, scenario, booster, SAR))) +
  geom_ribbon(aes(ymin = Lower, ymax = Upper), alpha = 0.5) + 
  geom_line(aes(y=Mean), alpha = 0) + theme_classic() + 
  scale_fill_manual("Booster type", values = colors) +
  scale_color_manual("Booster type", values = colors) + 
  ylab("Infections per 10,000") +
  facet_wrap(~country, scales = "free") + 
  ggh4x::facetted_pos_scales(y = list(
  country == "Ecuador-like" ~ scale_y_continuous(limits = c(0, NA), breaks = c(0,20,40,60,80)),
  country == "India-like" ~ scale_y_continuous(limits = c(0, NA)),
  country == "Malaysia-like" ~ scale_y_continuous(limits = c(0, NA), 
                                             breaks = c(0,30,60,90,120)))) + 
  #scale_y_continuous(, limits = c(0,NA)) + # expand = c(0,0) 
  #scale_x_continuous("Time (months)", expand = c(0,0.5), breaks = c(30,32,34,36)) +
    scale_x_date("Date", expand = c(0,0), date_breaks = "1 month", date_labels =  "%b %Y") +
  ggtitle("Infections during Omicron* - History specific model", "Booster efficacy of monovalent \n is 53% of bivalent") + #, "Variant-specific model") +
  guides(linetype = guide_legend(override.aes = list(alpha = 1, fill=NA))) +
  scale_linetype_manual("Infectiousness", values = c("dashed")) +
  theme(axis.text = element_text(size = 11, color = "black"),
        axis.title.x = element_text(size = 12, color = "black",vjust = -1),
        axis.text.x=element_text(angle=60, hjust=1),
        axis.title.y = element_text(size = 12, color = "black",vjust = +3),
        axis.line = element_line(color = "black"),
        axis.ticks = element_line(color = "black"),
        plot.title = element_text(colour = "black", size = 13.5, face = "bold"),
        plot.subtitle = element_text(colour = "black", size = 12.5),
        plot.title.position = "plot",
        plot.margin = unit(c(t=0.2, r=1, b=0.2, l=1.5), "cm"),
        legend.position = "top",
        strip.text = element_text(colour = "black", size = 11, hjust = 0),
        strip.background = element_rect(colour="white", fill="white"),
        legend.margin=margin(t=0.8,r=0.5,b=0.2,l=0,unit = "line"),
        legend.key.height= unit(0.4, 'cm'),
        legend.key.width= unit(0.4, 'cm'),
        legend.title = element_text(size = 11, color = "black"),
        legend.text = element_text(size = 10, color = "black"),
        panel.spacing = unit(0.5, "cm")) #, aspect.ratio=1,
        #panel.grid.major = element_line(color = "grey95"),
        #panel.grid.minor = element_line(color = "grey95")) 
plot_supp_53eff
```
#### Data Deaths

Calculating the deaths averted

```{r}
df_compare_53eff <-  df_53eff %>% 
  filter(boost == "no", vaccine_star == "no") %>% 
  filter(time >= 900) %>% 
  group_by(SAR, country, replicate) %>% 
  mutate(deaths10K = 10000*deaths_over_time/start_pop) %>%
  #mutate(deaths_high = max(deaths), deaths_low = min(deaths))
  summarise(
    death_compare_10K = max(deaths10K)-min(deaths10K)
  ) %>%
  ungroup()

df_avert_53eff <- df_53eff %>% 
  filter(boost == "yes", vaccine_star == "no", boost_shape == "functional", speed=="fast") %>% 
  #filter(time >= 930/365) %>% 
  filter(time >= 900) %>%
  group_by(SAR, scenario, booster, country, replicate) %>% ## matching each booster scenario to a no booster scenario
  mutate(deaths10K = 10000*deaths_over_time/start_pop) %>%
  summarise(
    deaths_10K = max(deaths10K, na.rm = T)-min(deaths10K, na.rm = T)
  ) %>%
  ungroup()

df_avert_rr_53eff <- left_join(df_avert_53eff, df_compare_53eff, by = c("SAR", "country", "replicate")) %>%
  group_by(SAR, country, booster, scenario, replicate) %>%
  mutate(da10K = death_compare_10K-deaths_10K,
         da_perc = da10K/death_compare_10K) %>%
ungroup() %>%
  select(
    SAR, country, replicate, scenario = scenario, booster = booster, death_compare_10K, deaths_10K, da10K, da_perc)

  

# df_avert_rr <- left_join(df_avert, df_compare, by = c("SAR", "country", "replicate")) %>% 
#   group_by(SAR, country, booster, scenario, replicate) %>% 
#   mutate(rr = deaths/death_compare,
#          da = 1-rr) %>%
# ungroup() %>% 
#   select(
#     SAR, country, replicate, scenario = scenario, booster = booster, da)


df_avert_rr_splitWT <- df_avert_rr_53eff %>% 
  filter(scenario %in% c("WTpenalty", "WTendpoint", "WTefficacy")) %>% 
  filter(booster == "Monovalent") %>% 
  mutate(booster = "Monovalent (WT)")
df_avert_rr_splitOm <- df_avert_rr_53eff %>% 
  filter(scenario %in% c("Ompenalty", "Omendpoint", "Omefficacy")) %>% 
  filter(booster == "Monovalent") %>% 
  mutate(booster = "Monovalent (Omicron)")

df_avert_rr2_53eff <- df_avert_rr_53eff %>%
  filter(booster == "Bivalent" | booster == "no booster" | booster == "No booster") %>%
  rbind(df_avert_rr_splitWT) %>% 
  rbind(df_avert_rr_splitOm)

rm(df_avert_rr_splitOm, df_avert_rr_splitWT)

```

#### Plot deaths averted

```{r}
colors <- c("#BC8400","#7C2529","#005B40")

comparisons <- list( c("Bivalent", "Monovalent (WT)"), 
                        c("Bivalent", "Monovalent (Omicron)"), 
                        c("Monovalent (WT)", "Monovalent (Omicron)"))

dat_53eff_da <- df_avert_rr2_53eff %>% 
  mutate(Booster = fct_relevel(booster, "Monovalent")) %>% 
  mutate(SAR = recode(SAR,`0.427` = "100%",
    `0.4697` = "110%", `0.5551` = "130%")) %>%
  mutate(SAR = fct_relevel(SAR, c("100%", "110%", "130%"))) %>% 
  mutate(Scenario = recode(scenario, endpoint = "Same endpoint",
    efficacy = "Same efficacy", penalty = "History dependent",
    WTpenalty = "History dependent", Ompenalty = "History dependent",
    "no booster" = "No booster")) %>%
  filter(Scenario == "History dependent" | Scenario == "No booster") %>%
  filter(SAR != "100%") %>% mutate(Scenario = fct_relevel(Scenario, 
        c("Same endpoint", "Same efficacy", "History dependent"))) %>%
  group_by(SAR,country,Scenario,Booster,) %>%
  summarise(x  = smean.cl.normal(da10K), 
            name = c("Mean","Lower","Upper")) %>% ungroup() %>%
  pivot_wider(names_from = name, values_from = x) %>%
  mutate(Booster = fct_relevel(Booster, 
       c("Monovalent (WT)","Monovalent (Omicron)", "Bivalent")))

plot_53eff_da <- dat_53eff_da %>% 
  mutate(country = case_when(
    country == "Ecuador" ~ "Ecuador-like",
    country == "India" ~ "India-like",
    country == "Malaysia" ~ "Malaysia-like"
  )) %>%
  ggplot(aes(x = SAR, fill = Booster, color = Booster,
                     group = interaction(Booster, SAR, Scenario))) + 
  geom_bar(aes(y=Mean), stat="identity", position=position_dodge(0.7),  
           alpha=0.5, size = 0.6, width = 0.6) + theme_classic() +
  geom_errorbar(aes(ymin  = Lower, ymax  = Upper),
           stat="identity", position=position_dodge(0.7),  
           size = 0.6, width = 0.3, show.legend=FALSE) + 
    geom_text(aes(label = round(Mean, 2), y = Upper + 0.2), position=position_dodge(0.7), size = 3) + ## this line adds the labels
  scale_fill_manual("Booster", values = colors) +
  scale_color_manual("Booster", values = colors) +
  facet_wrap(~country, scales = "free", nrow = 1) +
  scale_y_continuous("Deaths averted per 10,000", limits = c(0,5), 
                     expand = expansion(mult = c(0,0))) + 
  scale_x_discrete("Infectiousness relative to Omicron") +
  ggtitle("Deaths averted - History specific model", "Booster efficacy of monovalent \n is 53% of bivalent") + #, subtitle = "Variant-specific model") + 
  theme(axis.text = element_text(size = 11, color = "black"),
        axis.title.x = element_text(size = 12, color = "black",vjust = -1),
        axis.title.y = element_text(size = 12, color = "black",vjust = +3),
        axis.line = element_line(color = "black"),
        axis.ticks = element_line(color = "black"),
        plot.title = element_text(colour = "black", size = 13.5, face = "bold"),
        plot.subtitle = element_text(colour = "black", size = 12.5),
        plot.title.position = "plot",
        plot.margin = unit(c(t=0.2, r=1, b=0.5, l=1.5), "cm"),
        legend.position = "none",
        # legend.margin=margin(t=0.5,r=0.5,b=0.5,l=0.5,unit = "line"),
        # legend.key.height= unit(0.4, 'cm'),
        # legend.key.width= unit(0.4, 'cm'),
        # legend.title = element_text(size = 11, color = "black"),
        # legend.text = element_text(size = 10, color = "black"),
        strip.text = element_text(colour = "black", size = 11, hjust = 0),
        strip.background = element_rect(colour="white", fill="white"),
        panel.spacing = unit(0.5, "cm")) #, aspect.ratio=0.7)
plot_53eff_da
```


```{r}
plot_grid_BC53 <- plot_grid(plot_supp_53eff, plot_53eff_da, nrow = 2,labels = c("B", "C"), rel_heights = c(1.1, 1))
plot_grid_53eff <- plot_grid(plot_53eff_protection, plot_grid_BC53, nrow = 1, labels = c("A", ""), rel_widths = c(0.5, 1))

ggsave("../Supplement/SR-53eff.pdf", plot_grid_53eff, height = 7.5, width = 15)
```


### HSM Compare absolute vs. relative benefits 
#### Data
```{r}
## get ABM seed populations for each country ##
pop_ABM <- read_csv("../Data/ABM_Parameters_Data/Grid_Param.csv") %>% select(Name, child, adult, old) %>% 
  summarise(Name,start_pop = 2*(child + adult+ old)) %>% 
  distinct() %>% 
  arrange(Name) %>% 
  rename(country = Name)

## change time to date
start_sims <- as.Date("2020-03-15", "%Y-%m-%d") 

dataAll <- read_csv("../Data/ABM Main Runs/dataAll.csv")%>% 
  left_join(pop_ABM) %>%
  group_by(ID_runs, time) %>% 
  filter(cum_sum_Inf == max(cum_sum_Inf)) %>%
  ungroup() %>%
  mutate(time = start_sims + time) ## take out this line to get back to days instead of dates 

```

```{r}
df_compare <-  dataAll %>% 
  filter(boost == "no", vaccine_star == "no") %>% 
  filter(time >= start_sims + 900) %>% 
  group_by(SAR, country, replicate) %>% 
  mutate(deaths10K = 10000*deaths_over_time/start_pop) %>%
  #mutate(deaths_high = max(deaths), deaths_low = min(deaths))
  summarise(
    death_compare_10K = max(deaths10K)-min(deaths10K)
  ) %>%
  ungroup()

df_avert <- dataAll %>% 
  filter(boost == "yes", vaccine_star == "no", boost_shape == "functional", speed=="fast") %>% 
  #filter(time >= 900/365) %>% 
  filter(time >= start_sims + 900) %>%
  group_by(SAR, scenario, booster, country, replicate) %>% ## matching each booster scenario to a no booster scenario
  mutate(deaths10K = 10000*deaths_over_time/start_pop) %>%
  summarise(
    deaths_10K = max(deaths10K, na.rm = T)-min(deaths10K, na.rm = T)
  ) %>%
  ungroup()

df_avert_rr <- left_join(df_avert, df_compare, by = c("SAR", "country", "replicate")) %>%
  group_by(SAR, country, booster, scenario, replicate) %>%
  mutate(da10K = death_compare_10K-deaths_10K,
         da_perc = da10K/death_compare_10K) %>%
ungroup() %>%
  select(
    SAR, country, replicate, scenario = scenario, booster = booster, death_compare_10K, deaths_10K, da10K, da_perc)

  

# df_avert_rr <- left_join(df_avert, df_compare, by = c("SAR", "country", "replicate")) %>% 
#   group_by(SAR, country, booster, scenario, replicate) %>% 
#   mutate(rr = deaths/death_compare,
#          da = 1-rr) %>%
# ungroup() %>% 
#   select(
#     SAR, country, replicate, scenario = scenario, booster = booster, da)


df_avert_rr_splitWT <- df_avert_rr %>% 
  filter(scenario %in% c("WTpenalty", "WTendpoint", "WTefficacy")) %>% 
  filter(booster == "Monovalent") %>% 
  mutate(booster = "Monovalent (WT)")
df_avert_rr_splitOm <- df_avert_rr %>% 
  filter(scenario %in% c("Ompenalty", "Omendpoint", "Omefficacy")) %>% 
  filter(booster == "Monovalent") %>% 
  mutate(booster = "Monovalent (Omicron)")

df_avert_rr2 <- df_avert_rr %>%
  filter(booster == "Bivalent" | booster == "no booster" | booster == "No booster") %>%
  rbind(df_avert_rr_splitWT) %>% 
  rbind(df_avert_rr_splitOm)

rm(df_avert_rr_splitOm, df_avert_rr_splitWT)

```


```{r}

colors <- rev(c("#BCC07B", "#9A81B0"))

plot_compare_omicron <- df_avert_rr2 %>% 
  mutate(country = case_when(
    country == "Ecuador" ~ "Ecuador-like",
    country == "India" ~ "India-like",
    country == "Malaysia" ~ "Malaysia-like"
  )) %>%
  group_by(country, booster, SAR) %>% 
  summarise(da10K = mean(da10K)) %>% 
  ungroup() %>% 
  mutate(da10K = round(da10K, 2)) %>% 
  pivot_wider(names_from = "booster", values_from = da10K) %>% 
  mutate(om_rel = `Monovalent (Omicron)`/`Monovalent (WT)`,
         om_abs = `Monovalent (Omicron)` - `Monovalent (WT)`,
         biv_rel = `Bivalent`/`Monovalent (WT)`,
         biv_abs = `Bivalent`- `Monovalent (WT)`
         ) %>% 
  mutate(SAR = recode(SAR,`0.427` = "100%",
    `0.4697` = "110%", `0.5551` = "130%")) %>%
  mutate(SAR = fct_relevel(SAR, c("100%", "110%", "130%"))) %>% 
  rename(Country = country) %>%
  ggplot(aes(x = om_rel, y = om_abs, color = SAR)) + 
  geom_point(size = 3, aes(shape = Country)) + 
  scale_color_manual("Infectiousness", values = colors) + 
  #facet_wrap(~country)+ 
  theme_bw() + 
  scale_x_continuous("Relative benefit of deaths averted", limits = c(0,1.5)) + 
  scale_y_continuous("Absolute benefit of deaths averted", limits = c(-0.75,0.25)) + 
  theme(axis.text = element_text(size = 11, color = "black"),
        axis.title.x = element_text(size = 12, color = "black",vjust = -1),
        axis.title.y = element_text(size = 12, color = "black",vjust = +3),
        axis.line = element_line(color = "black"),
        axis.ticks = element_line(color = "black"),
        plot.title = element_text(colour = "black", size = 13.5, face = "bold"),
        plot.subtitle = element_text(colour = "black", size = 12.5),
        plot.title.position = "plot",
        plot.margin = unit(c(t=0.2, r=1, b=0.5, l=1.5), "cm"),
        legend.position = "none",
        # legend.margin=margin(t=0.5,r=0.5,b=0.5,l=0.5,unit = "line"),
        # legend.key.height= unit(0.4, 'cm'),
        # legend.key.width= unit(0.4, 'cm'),
        # legend.title = element_text(size = 11, color = "black"),
        # legend.text = element_text(size = 10, color = "black"),
        strip.text = element_text(colour = "black", size = 11, hjust = 0),
        strip.background = element_rect(colour="white", fill="white"),
        panel.spacing = unit(0.5, "cm"), aspect.ratio=1) + 
  ggtitle("Relative vs. Absolute Benefit","Monovalent (Omicron) - HSM")
plot_compare_omicron


```


```{r}

colors <- rev(c("#BCC07B", "#9A81B0"))

plot_compare_bivalent <- df_avert_rr2 %>% 
  mutate(country = case_when(
    country == "Ecuador" ~ "Ecuador-like",
    country == "India" ~ "India-like",
    country == "Malaysia" ~ "Malaysia-like"
  )) %>%
  group_by(country, booster, SAR) %>% 
  summarise(da10K = mean(da10K)) %>% 
  ungroup() %>% 
  mutate(da10K = round(da10K, 2)) %>% 
  pivot_wider(names_from = "booster", values_from = da10K) %>% 
  mutate(om_rel = `Monovalent (Omicron)`/`Monovalent (WT)`,
         om_abs = `Monovalent (Omicron)` - `Monovalent (WT)`,
         biv_rel = `Bivalent`/`Monovalent (WT)`,
         biv_abs = `Bivalent`- `Monovalent (WT)`
         ) %>% 
  mutate(SAR = recode(SAR,`0.427` = "100%",
    `0.4697` = "110%", `0.5551` = "130%")) %>%
  mutate(SAR = fct_relevel(SAR, c("100%", "110%", "130%"))) %>% 
  rename(Country = country) %>%
  ggplot(aes(x = biv_rel, y = biv_abs, color = SAR)) + 
  geom_point(size = 3, aes(shape = Country)) + 
  scale_color_manual("Infectiousness", values = colors) + 
  #facet_wrap(~country)+ 
  theme_bw() + 
  scale_x_continuous("Relative benefit of deaths averted", limits = c(1,2)) + 
  scale_y_continuous("Absolute benefit of deaths averted", limits = c(0,1.5)) + 
  theme(axis.text = element_text(size = 11, color = "black"),
        axis.title.x = element_text(size = 12, color = "black",vjust = -1),
        axis.title.y = element_text(size = 12, color = "black",vjust = +3),
        axis.line = element_line(color = "black"),
        axis.ticks = element_line(color = "black"),
        plot.title = element_text(colour = "black", size = 13.5, face = "bold"),
        plot.subtitle = element_text(colour = "black", size = 12.5),
        plot.title.position = "plot",
        plot.margin = unit(c(t=0.2, r=1, b=0.5, l=1.5), "cm"),
        legend.position = "none",
        # legend.margin=margin(t=0.5,r=0.5,b=0.5,l=0.5,unit = "line"),
        # legend.key.height= unit(0.4, 'cm'),
        # legend.key.width= unit(0.4, 'cm'),
        # legend.title = element_text(size = 11, color = "black"),
        # legend.text = element_text(size = 10, color = "black"),
        strip.text = element_text(colour = "black", size = 11, hjust = 0),
        strip.background = element_rect(colour="white", fill="white"),
        panel.spacing = unit(0.5, "cm"), aspect.ratio=1) + 
  ggtitle("","Bivalent - HSM")
plot_compare_bivalent

```



### HIM Compare absolute vs. relative 
```{r}

df_comp_benefit_HIM <- read_csv("../Data/ODE Supplement/fast_total.csv") %>% 
  mutate(country = case_when(
    country == "Ecuador" ~ "Ecuador-like",
    country == "India" ~ "India-like",
    country == "Malaysia" ~ "Malaysia-like"
  )) %>%
  select(relativeFOI, boost.speed, country, boost.start.time, Booster, deathsaverted_per100k) %>% 
  mutate(deathsaverted_10k = deathsaverted_per100k/10) %>%
  filter(boost.speed == "fast", relativeFOI != "0% increase in FOI") %>% 
  select(-boost.speed) %>% select(-boost.start.time) %>% select(-deathsaverted_per100k) %>%
    mutate(deathsaverted_10k = round(deathsaverted_10k, 2)) %>%
  pivot_wider(names_from = "Booster", values_from = "deathsaverted_10k") %>% 
  mutate(biv_abs = Bivalent - Monovalent,
         biv_rel = Bivalent/Monovalent
         ) %>% 
  rename(Country = country) %>%
  mutate(relativeFOI = case_when(
    relativeFOI == "10% increase in FOI" ~ "110%",
    relativeFOI == "30% increase in FOI" ~ "130%"
  )) %>%
  ggplot(aes(x = biv_rel, y = biv_abs, color = relativeFOI)) +
  geom_point(size = 3, aes(shape = Country)) +
scale_color_manual("Infectiousness", values = colors) + 
  #facet_wrap(~country)+ 
  theme_bw() + 
  scale_x_continuous("Relative benefit of deaths averted", limits = c(1,2)) + 
  scale_y_continuous("Absolute benefit of deaths averted", limits = c(0,0.5)) + 
  theme(axis.text = element_text(size = 11, color = "black"),
        axis.title.x = element_text(size = 12, color = "black",vjust = -1),
        axis.title.y = element_text(size = 12, color = "black",vjust = +3),
        axis.line = element_line(color = "black"),
        axis.ticks = element_line(color = "black"),
        plot.title = element_text(colour = "black", size = 13.5, face = "bold"),
        plot.subtitle = element_text(colour = "black", size = 12.5),
        plot.title.position = "plot",
        plot.margin = unit(c(t=0.2, r=1, b=0.5, l=1.5), "cm"),
        #legend.position = "none",
        # legend.margin=margin(t=0.5,r=0.5,b=0.5,l=0.5,unit = "line"),
        # legend.key.height= unit(0.4, 'cm'),
        # legend.key.width= unit(0.4, 'cm'),
        # legend.title = element_text(size = 11, color = "black"),
        # legend.text = element_text(size = 10, color = "black"),
        strip.text = element_text(colour = "black", size = 11, hjust = 0),
        strip.background = element_rect(colour="white", fill="white"),
        panel.spacing = unit(0.5, "cm"), aspect.ratio=1) + 
  ggtitle("","Bivalent - HIM")
df_comp_benefit_HIM

```


```{r}
plot_grid_compare_da <- plot_grid(plot_compare_omicron, plot_compare_bivalent, df_comp_benefit_HIM, nrow = 1, labels = c("A", "B", "C"), rel_widths = c(1, 0.98, 1.25))

ggsave("../Supplement/SR-compare_averted.pdf", plot_grid_compare_da, height = 5, width = 15)
```


## Add efficacy sweep

```{r}

## change from cp to base immunity 

Malaysia_Efficacy <- read_csv("../Data/ODE Supplement/Malaysia_grid_da_efficacy.csv")
Ecuador_Efficacy <- read_csv("../Data/ODE Supplement/Ecuador_grid_da_efficacy.csv")
India_Efficacy <- read_csv("../Data/ODE Supplement/India_grid_da_efficacy.csv")

```



### 3B - Deaths averted grids

```{r}
 #mycolors <- met.brewer("Isfahan1", n = 20)[11:20]
# 
 mycolors <- c("#e0ecf4","#bfd3e6","#9ebcda","#8c96c6","#807dba","#6F5784",
               "#54436E","#403255","#2D223C","#19013b")

#mycolors <-met.brewer("Hokusai1", n = 44)[28:44]

#mycolors <- rev(met.brewer("Hokusai1", n = 11)[0:8])

plot3BE_efficacy <- Ecuador_Efficacy  %>% 
  mutate(base.imm = as.numeric(base.imm), cp= as.numeric(cp))%>%
  mutate(relax = case_when(relax == 0.1 ~ "Infectiousness 110%",
                           relax == 0.3 ~ "Infectiousness 130%")) %>%
  mutate(deaths_10k_comp = deaths_100k_comp/10,
         deaths_10k = deaths_100k/10, 
         da10K = pmax(0,deaths_10k_comp-deaths_10k)) %>%
  ggplot(aes(x = veh2, y = cp)) + 
  geom_tile(aes(fill = da10K)) + facet_wrap(~relax) + 
  geom_hline(aes(yintercept = 0.665), color= "black", fill = "black", size = 1.5, linetype = "dashed") +
  #geom_text_repel(data = dataPlaces, color= "black", fill = "white", size = 2, aes(label = country)) +
  theme_classic() +
  scale_fill_stepsn("Deaths averted per 10,000",colors=mycolors,
                    breaks = seq(0,2.4,0.3), limits=c(0,2.4),
                    labels =c(0,"",0.6,"",1.2,"",1.8,"",2.4)) +
  # scale_fill_stepsn("Deaths averted per 10,000",colors=mycolors, 
  #                   breaks = seq(0,1.6,0.1), limits=c(0,1.6),
  #                   labels =c(0,"",0.2,"",0.4,"",0.6,"",0.8,
  #                             "",1.0,"",1.2,"",1.4,"",1.6)) + 
  theme_classic() +
  guides(fill = guide_colourbar(title.position="top", title.hjust = 0.5)) + 
  scale_y_continuous("Cross protection",labels = 
          scales::percent_format(accuracy = 1), 
          breaks = c(0,0.3,0.6,0.9), expand = c(0,0)) +
  scale_x_continuous("VE - hospitalization",labels = 
          scales::percent_format(accuracy = 1), 
          breaks = c(0.5,0.7,0.9), expand = c(0,0)) +
  ggtitle("Deaths averted - estimated base immunity","         Ecuador-like") +
    theme(axis.text = element_text(size = 11, color = "black"),
        axis.title = element_text(size = 12, color = "black"),
        axis.line = element_blank(),
        axis.ticks = element_line(color = "black"),
        plot.title = element_text(colour = "black", size = 13.5, face = "bold"),
        plot.subtitle = element_text(colour = "black", size = 12.5),
        plot.margin = unit(c(t=0.2, r=0.2, b=0.2, l=0.2), "cm"),
        legend.key.width= unit(1.2, 'cm'),
        legend.position = "bottom", plot.title.position = "plot",
        legend.title = element_text(size = 11, color = "black"),
        legend.text = element_text(size = 9, color = "black"),
        strip.text.x = element_text(colour = "black", size = 11, hjust = 0),
        strip.text.y = element_text(colour = "black", size = 10, hjust = 0),
        strip.background = element_rect(colour="white", fill="white"),
        panel.border = element_rect(colour = "black", fill=NA),
        panel.spacing = unit(0.3, "cm"), aspect.ratio=1)
plot3BE_efficacy

mycolors <-met.brewer("Hokusai1", n = 44)[28:44]

plot3BI_efficacy <- India_Efficacy %>% 
  mutate(base.imm = as.numeric(base.imm), cp= as.numeric(cp))%>%
  mutate(relax = case_when(relax == 0.1 ~ "Infectiousness 110%",
                           relax == 0.3 ~ "Infectiousness 130%")) %>%
    mutate(deaths_10k_comp = deaths_100k_comp/10,
         deaths_10k = deaths_100k/10,
         da10K = pmax(0,deaths_10k_comp-deaths_10k)) %>%
  ggplot(aes(x = veh2, y = cp)) + 
  geom_tile(aes(fill = da10K)) + facet_wrap(~relax) + 
  geom_hline(aes(yintercept = 0.433), color= "black", fill = "black", size = 1.5, linetype = "dashed") +
  #geom_text_repel(data = dataPlaces, color= "black", fill = "white", size = 2, aes(label = country)) +
  scale_fill_stepsn("Deaths averted per 10,000",colors=mycolors,
                    breaks = seq(0,1.4,0.2), limits=c(0,1.4),
                    labels =c(0,"",0.4,"",0.8,"",1.2,"")) +
  # scale_fill_stepsn("Deaths averted per 10,000",colors=mycolors, 
  #                   breaks = seq(0,1.6,0.1), limits=c(0,1.6),
  #                   labels =c(0,"",0.2,"",0.4,"",0.6,"",0.8,
  #                             "",1.0,"",1.2,"",1.4,"",1.6)) + 
  theme_classic() +
    scale_y_continuous("Cross protection",labels = scales::percent_format(accuracy = 1), breaks = c(0,0.3,0.6,0.9), expand = c(0,0)) +
  scale_x_continuous("VE - hospitalization",labels = 
          scales::percent_format(accuracy = 1), 
          breaks = c(0.5,0.7,0.9), expand = c(0,0)) +
  guides(fill = guide_colourbar(title.position="top", title.hjust = 0.5)) + 
    theme(axis.text = element_text(size = 11, color = "black"),
        axis.title = element_text(size = 12, color = "black"),
        axis.line = element_blank(),
        axis.ticks = element_line(color = "black"),
        plot.title = element_text(colour = "black", size = 13.5, face = "bold"),
        plot.subtitle = element_text(colour = "black", size = 12.5),
        plot.margin = unit(c(t=0.2, r=0.2, b=0.2, l=0.2), "cm"),
        legend.key.width= unit(1.2, 'cm'), legend.position = "bottom",
        legend.title = element_text(size = 11, color = "black"),
        legend.text = element_text(size = 9, color = "black"),
        strip.text.x = element_text(colour = "black", size = 11, hjust = 0),
        strip.text.y = element_text(colour = "black", size = 10, hjust = 0),
        strip.background = element_rect(colour="white", fill="white"),
        panel.border = element_rect(colour = "black", fill=NA),
        panel.spacing = unit(0.3, "cm"), aspect.ratio=1)+
  ggtitle(" ","India-like")
plot3BI_efficacy

#mycolors <- met.brewer("VanGogh3", n = 10)
mycolors <- rev(met.brewer("Hokusai1", n = 11)[0:8])

#mycolors <-met.brewer("Hokusai1", n = 44)[28:44]

plot3BM_efficacy <- Malaysia_Efficacy %>% 
  mutate(base.imm = as.numeric(base.imm), cp= as.numeric(cp))%>%
  mutate(relax = case_when(relax == 0.1 ~ "Infectiousness 110%",
                           relax == 0.3 ~"Infectiousness 130%")) %>%
    mutate(deaths_10k_comp = deaths_100k_comp/10,
         deaths_10k = deaths_100k/10,
         da10K = pmax(0,deaths_10k_comp-deaths_10k)) %>%
  ggplot(aes(x = veh2, y = cp)) + 
  geom_tile(aes(fill = da10K)) + facet_wrap(~relax) + 
  geom_hline(aes(yintercept = 0.728), color= "black", fill = "black", size = 1.5, linetype = "dashed") +
  #geom_text_repel(data = dataPlaces, color= "black", fill = "white", size = 2, aes(label = country)) +
  scale_fill_stepsn("Deaths averted per 10,000",colors=mycolors,
                    breaks = seq(0,3.5,0.5), limits=c(0,3.5),
                    labels =c(0,"",1.0,"",2.0,"",3.0,"")) +
  # scale_fill_stepsn("Deaths averted per 10,000",colors=mycolors, 
  #                   breaks = seq(0,3.2,0.2), limits=c(0,3.2),
  #                   labels =c(0,"",0.4,"",0.8,"",1.2,"",1.6,
  #                             "",2.0,"",2.4,"",2.8,"",3.2)) + 
  theme_classic() +
  guides(fill = guide_colourbar(title.position="top", title.hjust = 0.5)) + 
  theme_classic() +
  scale_y_continuous("Cross protection",labels = scales::percent_format(accuracy = 1), breaks = c(0,0.3,0.6,0.9), expand = c(0,0)) +
  scale_x_continuous("VE - hospitalization",labels = 
          scales::percent_format(accuracy = 1), 
          breaks = c(0.5,0.7,0.9), expand = c(0,0)) +
    theme(axis.text = element_text(size = 11, color = "black"),
        axis.title = element_text(size = 12, color = "black"),
        axis.line = element_blank(),
        axis.ticks = element_line(color = "black"),
        plot.title = element_text(colour = "black", size = 13.5, face = "bold"),
        plot.subtitle = element_text(colour = "black", size = 12.5),
        plot.margin = unit(c(t=0.2, r=0.2, b=0.2, l=0.2), "cm"),
        legend.key.width= unit(1.2, 'cm'),
        legend.position = "bottom",
        legend.title = element_text(size = 11, color = "black"),
        legend.text = element_text(size = 10, color = "black"),
        strip.text.x = element_text(colour = "black", size = 11, hjust = 0),
        strip.text.y = element_text(colour = "black", size = 10, hjust = 0),
        strip.background = element_rect(colour="white", fill="white"),
        panel.border = element_rect(colour = "black", fill=NA),
        panel.spacing = unit(0.3, "cm"), aspect.ratio=1)+
  ggtitle(" ","Malaysia-like")
plot3BM_efficacy
```


### Save efficacy figure
```{r}
plot3B <- plot_grid(plot3BE_efficacy,plot3BI_efficacy,plot3BM_efficacy, nrow = 1, labels = c("A", "B", "C"))

ggsave("../Supplement/Efficacy_Sweep.pdf", plot3B, height = 4.5, width = 13)

#ggsave("../Main/Figure3.pdf", plot3, height = 9, width = 13)
```


## Add efficacy with 90% base imm sweep


```{r}

## change from cp to base immunity 

Malaysia_Efficacy <- read_csv("../Data/ODE Supplement/Malaysia_grid_da_efficacy_90baseimm.csv")
Ecuador_Efficacy <- read_csv("../Data/ODE Supplement/Ecuador_grid_da_efficacy_90baseimm.csv")
India_Efficacy <- read_csv("../Data/ODE Supplement/India_grid_da_efficacy_90baseimm.csv")

```

### 3B - Deaths averted grids

```{r}
 #mycolors <- met.brewer("Isfahan1", n = 20)[11:20]
# 
 mycolors <- c("#e0ecf4","#bfd3e6","#9ebcda","#8c96c6","#807dba","#6F5784",
               "#54436E","#403255","#2D223C","#19013b")

#mycolors <-met.brewer("Hokusai1", n = 44)[28:44]

#mycolors <- rev(met.brewer("Hokusai1", n = 11)[0:8])

plot3BE_efficacy90 <- Ecuador_Efficacy  %>% 
  mutate(base.imm = as.numeric(base.imm), cp= as.numeric(cp))%>%
  mutate(relax = case_when(relax == 0.1 ~ "Infectiousness 110%",
                           relax == 0.3 ~ "Infectiousness 130%")) %>%
  mutate(deaths_10k_comp = deaths_100k_comp/10,
         deaths_10k = deaths_100k/10, 
         da10K = pmax(0,deaths_10k_comp-deaths_10k)) %>%
  ggplot(aes(x = veh2, y = cp)) + 
  geom_tile(aes(fill = da10K)) + facet_wrap(~relax) + 
  geom_hline(aes(yintercept = 0.665), color= "black", fill = "black", size = 1.5, linetype = "dashed") +
  #geom_text_repel(data = dataPlaces, color= "black", fill = "white", size = 2, aes(label = country)) +
  theme_classic() +
  scale_fill_stepsn("Deaths averted per 10,000",colors=mycolors,
                    breaks = seq(0,2.4,0.3), limits=c(0,2.4),
                    labels =c(0,"",0.6,"",1.2,"",1.8,"",2.4)) +
  # scale_fill_stepsn("Deaths averted per 10,000",colors=mycolors, 
  #                   breaks = seq(0,1.6,0.1), limits=c(0,1.6),
  #                   labels =c(0,"",0.2,"",0.4,"",0.6,"",0.8,
  #                             "",1.0,"",1.2,"",1.4,"",1.6)) + 
  theme_classic() +
  guides(fill = guide_colourbar(title.position="top", title.hjust = 0.5)) + 
  scale_y_continuous("Cross protection",labels = 
          scales::percent_format(accuracy = 1), 
          breaks = c(0,0.3,0.6,0.9), expand = c(0,0)) +
  scale_x_continuous("VE - hospitalization",labels = 
          scales::percent_format(accuracy = 1), 
          breaks = c(0.5,0.7,0.9), expand = c(0,0)) +
  ggtitle("Deaths averted - 90% base immunity","         Ecuador-like") +
    theme(axis.text = element_text(size = 11, color = "black"),
        axis.title = element_text(size = 12, color = "black"),
        axis.line = element_blank(),
        axis.ticks = element_line(color = "black"),
        plot.title = element_text(colour = "black", size = 13.5, face = "bold"),
        plot.subtitle = element_text(colour = "black", size = 12.5),
        plot.margin = unit(c(t=0.2, r=0.2, b=0.2, l=0.2), "cm"),
        legend.key.width= unit(1.2, 'cm'),
        legend.position = "bottom", plot.title.position = "plot",
        legend.title = element_text(size = 11, color = "black"),
        legend.text = element_text(size = 9, color = "black"),
        strip.text.x = element_text(colour = "black", size = 11, hjust = 0),
        strip.text.y = element_text(colour = "black", size = 10, hjust = 0),
        strip.background = element_rect(colour="white", fill="white"),
        panel.border = element_rect(colour = "black", fill=NA),
        panel.spacing = unit(0.3, "cm"), aspect.ratio=1)
plot3BE_efficacy90

mycolors <-met.brewer("Hokusai1", n = 44)[28:44]

plot3BI_efficacy90 <- India_Efficacy %>% 
  mutate(base.imm = as.numeric(base.imm), cp= as.numeric(cp))%>%
  mutate(relax = case_when(relax == 0.1 ~ "Infectiousness 110%",
                           relax == 0.3 ~ "Infectiousness 130%")) %>%
    mutate(deaths_10k_comp = deaths_100k_comp/10,
         deaths_10k = deaths_100k/10,
         da10K = pmax(0,deaths_10k_comp-deaths_10k)) %>%
  ggplot(aes(x = veh2, y = cp)) + 
  geom_tile(aes(fill = da10K)) + facet_wrap(~relax) + 
  geom_hline(aes(yintercept = 0.433), color= "black", fill = "black", size = 1.5, linetype = "dashed") +
  #geom_text_repel(data = dataPlaces, color= "black", fill = "white", size = 2, aes(label = country)) +
  scale_fill_stepsn("Deaths averted per 10,000",colors=mycolors,
                    breaks = seq(0,1.4,0.2), limits=c(0,1.4),
                    labels =c(0,"",0.4,"",0.8,"",1.2,"")) +
  # scale_fill_stepsn("Deaths averted per 10,000",colors=mycolors, 
  #                   breaks = seq(0,1.6,0.1), limits=c(0,1.6),
  #                   labels =c(0,"",0.2,"",0.4,"",0.6,"",0.8,
  #                             "",1.0,"",1.2,"",1.4,"",1.6)) + 
  theme_classic() +
    scale_y_continuous("Cross protection",labels = scales::percent_format(accuracy = 1), breaks = c(0,0.3,0.6,0.9), expand = c(0,0)) +
  scale_x_continuous("VE - hospitalization",labels = 
          scales::percent_format(accuracy = 1), 
          breaks = c(0.5,0.7,0.9), expand = c(0,0)) +
  guides(fill = guide_colourbar(title.position="top", title.hjust = 0.5)) + 
    theme(axis.text = element_text(size = 11, color = "black"),
        axis.title = element_text(size = 12, color = "black"),
        axis.line = element_blank(),
        axis.ticks = element_line(color = "black"),
        plot.title = element_text(colour = "black", size = 13.5, face = "bold"),
        plot.subtitle = element_text(colour = "black", size = 12.5),
        plot.margin = unit(c(t=0.2, r=0.2, b=0.2, l=0.2), "cm"),
        legend.key.width= unit(1.2, 'cm'), legend.position = "bottom",
        legend.title = element_text(size = 11, color = "black"),
        legend.text = element_text(size = 9, color = "black"),
        strip.text.x = element_text(colour = "black", size = 11, hjust = 0),
        strip.text.y = element_text(colour = "black", size = 10, hjust = 0),
        strip.background = element_rect(colour="white", fill="white"),
        panel.border = element_rect(colour = "black", fill=NA),
        panel.spacing = unit(0.3, "cm"), aspect.ratio=1)+
  ggtitle(" ","India-like")
plot3BI_efficacy90

#mycolors <- met.brewer("VanGogh3", n = 10)
mycolors <- rev(met.brewer("Hokusai1", n = 11)[0:8])

#mycolors <-met.brewer("Hokusai1", n = 44)[28:44]

plot3BM_efficacy90 <- Malaysia_Efficacy %>% 
  mutate(base.imm = as.numeric(base.imm), cp= as.numeric(cp))%>%
  mutate(relax = case_when(relax == 0.1 ~ "Infectiousness 110%",
                           relax == 0.3 ~"Infectiousness 130%")) %>%
    mutate(deaths_10k_comp = deaths_100k_comp/10,
         deaths_10k = deaths_100k/10,
         da10K = pmax(0,deaths_10k_comp-deaths_10k)) %>%
  ggplot(aes(x = veh2, y = cp)) + 
  geom_tile(aes(fill = da10K)) + facet_wrap(~relax) + 
  geom_hline(aes(yintercept = 0.728), color= "black", fill = "black", size = 1.5, linetype = "dashed") +
  #geom_text_repel(data = dataPlaces, color= "black", fill = "white", size = 2, aes(label = country)) +
  scale_fill_stepsn("Deaths averted per 10,000",colors=mycolors,
                    breaks = seq(0,3.5,0.5), limits=c(0,3.5),
                    labels =c(0,"",1.0,"",2.0,"",3.0,"")) +
  # scale_fill_stepsn("Deaths averted per 10,000",colors=mycolors, 
  #                   breaks = seq(0,3.2,0.2), limits=c(0,3.2),
  #                   labels =c(0,"",0.4,"",0.8,"",1.2,"",1.6,
  #                             "",2.0,"",2.4,"",2.8,"",3.2)) + 
  theme_classic() +
  guides(fill = guide_colourbar(title.position="top", title.hjust = 0.5)) + 
  theme_classic() +
  scale_y_continuous("Cross protection",labels = scales::percent_format(accuracy = 1), breaks = c(0,0.3,0.6,0.9), expand = c(0,0)) +
  scale_x_continuous("VE - hospitalization",labels = 
          scales::percent_format(accuracy = 1), 
          breaks = c(0.5,0.7,0.9), expand = c(0,0)) +
    theme(axis.text = element_text(size = 11, color = "black"),
        axis.title = element_text(size = 12, color = "black"),
        axis.line = element_blank(),
        axis.ticks = element_line(color = "black"),
        plot.title = element_text(colour = "black", size = 13.5, face = "bold"),
        plot.subtitle = element_text(colour = "black", size = 12.5),
        plot.margin = unit(c(t=0.2, r=0.2, b=0.2, l=0.2), "cm"),
        legend.key.width= unit(1.2, 'cm'),
        legend.position = "bottom",
        legend.title = element_text(size = 11, color = "black"),
        legend.text = element_text(size = 10, color = "black"),
        strip.text.x = element_text(colour = "black", size = 11, hjust = 0),
        strip.text.y = element_text(colour = "black", size = 10, hjust = 0),
        strip.background = element_rect(colour="white", fill="white"),
        panel.border = element_rect(colour = "black", fill=NA),
        panel.spacing = unit(0.3, "cm"), aspect.ratio=1)+
  ggtitle(" ","Malaysia-like")
plot3BM_efficacy90
```


### Save efficacy figure
```{r}
plot3B90 <- plot_grid(plot3BE_efficacy90,plot3BI_efficacy90,plot3BM_efficacy90, nrow = 1, labels = c("A", "B", "C"))

ggsave("../Supplement/Efficacy_Sweep90.pdf", plot3B90, height = 4.5, width = 13)

#ggsave("../Main/Figure3.pdf", plot3, height = 9, width = 13)
```



