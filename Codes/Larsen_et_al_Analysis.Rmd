---
title: "Larsen et al Analysis"
author: "SLL, PPM, ANMK"
date: "2023-12-06"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(readxl)
library(scales)
library(Hmisc)
```


<!-- ```{r} -->
<!-- test <- df %>%  -->
<!--   select(Rec_nat_L, Rec_nat_H, Rec_vax_L, Rec_vax_H, N, time) %>% -->
<!--   mutate(time = round(time, 0)) %>% -->
<!--   filter(time == 839 | time == 899) %>%  -->
<!--   group_by(time) %>%  -->
<!--   summarise(Rec = mean(Rec_nat_L + Rec_nat_H + Rec_vax_L + Rec_vax_H)/N) %>% -->
<!--   ungroup() -->
<!-- ``` -->


### ABM Parametrization

#### Make immune history params

```{r}

########## Man. paper #########

## neutralizing antibody titres
dataMan <- read_excel("../Data/ABM_Parameters_Data/Manali et al/New_Supplementary_Data_File.xlsx") %>% 
  select(doses = `Number of Vaccine Doses`, Group, 
         WT = `Wuhan Titre`, Delta = `Delta Titre`, Omicron = `Omicron Titre`) %>% 
  filter(doses > 1 | doses == 0) %>% ## 2 or more doses
  filter(Group != "I_Av" & Group != "I_A" & Group != "N") %>%
  mutate(
    History = case_when(
      Group == "I_Wv" ~ "WT_vaccine",
      Group == "I_W" ~ "WT",
      Group == "I_Dv" ~ "Delta_vaccine",
      Group == "I_D" ~ "Delta",
      Group == "V" ~ "Vaccine")) %>% 
  select(History, WT, Delta, Omicron) %>% 
  pivot_longer(WT:Omicron, names_to = "Variant", values_to = "Titre")

######## data_Surya #######
  
##unvaccinated and hybrid individuals, NT50 - 2-3 doses
data_Surya <- read_excel("../Data/ABM_Parameters_Data/Suryawanshi et al. 2022/reformat.xlsx") %>% 
  select(History = history, WT = WA1, Delta, Omicron) %>% 
  pivot_longer(WT:Omicron, names_to = "Variant", values_to = "Titre")


######### Test plot ########

test_Man <- dataMan %>% mutate(paper = "Man") 
test_Surya <- data_Surya %>% mutate(paper = "Surya")

plot_check <- test_Man %>% rbind(test_Surya) %>% 
  filter(History != "Naive") %>% 
  group_by(History, Variant, paper) %>%
  mutate(Titre = as.numeric(Titre), 
         Titre = if_else(Titre < 1, 1, Titre)) %>% ## clean out -Inf values - if someone's titre is 0, approximate it by 1
  mutate(Titre = log10(Titre)) %>% 
  summarise(Titre = mean(Titre, na.rm = T)) %>% 
  ggplot(aes(x = History, y = Titre, group = History, fill = History)) + 
  geom_col(position = "dodge") + 
  facet_grid(paper~Variant)
plot_check

#ggsave("Show_titres.pdf", plot_check, width = 12, height = 8)


########## Get full table #########

## get an immunity table combining all sources
fullDat <- rbind(dataMan, data_Surya) %>% 
  filter(History != "Naive") %>% 
  mutate(Titre = as.numeric(Titre)) %>% 
  mutate(
    Titre = if_else(Titre < 1, 1, Titre), ## clean out -Inf - if titre is between 0-1, approximate it by 1
    Titre = log10(Titre) ## get log scale titre
  ) %>% 
  group_by(History, Variant) %>% 
  summarise(
    Titre = mean(Titre, na.rm = T), ## grab mean log titre
         minuslogTitre = -Titre) %>% ## get minus log titre since we want to scale a reduction in a param
  ungroup() %>% 
  mutate(paramfinal = rescale(minuslogTitre, to = c(0.05, 0.95))) %>% 
  arrange(paramfinal) %>% 
  select(Serotype = History, variant = Variant, paramfinal) %>% 
  mutate(paramfinal = round(paramfinal, 2))

## test 
plot <- fullDat %>% 
  mutate(variant = fct_relevel(variant, c("WT", "Delta", "Omicron"))) %>% 
  ggplot(aes(x = variant, y = Serotype, fill = 1-paramfinal)) + 
  geom_tile() + 
  scale_fill_viridis_c()
plot

## get transition between WT to Delta
fullDat_transition <- fullDat %>% 
  pivot_wider(names_from = "variant", values_from = "paramfinal") %>% 
  mutate(diffWT_to_DT = round(mean(Delta-WT),2), diffDT_to_Om = round(mean(Omicron-Delta),2))

lineage_change <- fullDat_transition$diffWT_to_DT[1]

## transition from WT to Delta: lineage_change
  
savefile <- fullDat %>% 
  pivot_wider(names_from = Serotype, values_from = paramfinal)


## get the difference from a vaccine to get the Omicron serotype
diff_file <- savefile %>% 
  mutate(Delta_vax_diff = Delta_vaccine - Delta,
         WT_vax_diff = WT_vaccine - WT,
         Omicron_vax_diff = Omicron_vaccine - Omicron,
         Vax_diff = Vaccine - 1) ##this is the base change for ppl getting a vaccine


savefile <- savefile %>% 
  ## rule: Omicron = Omicron_vaccine - vaccine benefit i.e. the change for Delta
  #mutate(Omicron = Omicron_vaccine - diff_file$Delta_vax_diff) %>% 
  mutate(Omicron_star = if_else(Omicron+lineage_change <= 1, Omicron + lineage_change, 1),
         Omicron_star_vaccine = if_else(Omicron_vaccine + lineage_change <=1, Omicron_vaccine+lineage_change, 1))


#### New scheme ####

Booster_Bump_WT <- diff_file %>% filter(variant == "WT") %>% select("WT_vax_diff")
Booster_Bump_Delta <- diff_file %>% filter(variant == "WT") %>% select("Delta_vax_diff")
Booster_Bump_Omicron <- diff_file %>% filter(variant == "WT") %>% select("Omicron_vax_diff")
Booster_Bump_Vaccine <- diff_file %>% filter(variant == "WT") %>% select("Vax_diff")

avg_change <- (Booster_Bump_WT$WT_vax_diff + 
                 Booster_Bump_Delta$Delta_vax_diff +
                 Booster_Bump_Omicron$Omicron_vax_diff +
                 Booster_Bump_Vaccine$Vax_diff)/4


######## make omicron* wave ########

savefile <- savefile %>% pivot_longer(-variant, 
                                      names_to = "history", 
                                      values_to = "paramfinal") %>% 
  pivot_wider(names_from = variant, values_from = paramfinal) %>% 
  mutate(Omicron_star = if_else(history == "Omicron_star" | history == "Omicron_star_vaccine",
                                Omicron-lineage_change, 
                                Omicron + lineage_change)) %>% 
  mutate(Omicron_star = if_else(Omicron_star <= 1, Omicron_star, 1)) %>%
  mutate(Omicron_star = if_else(Omicron_star >=0, Omicron_star, 0))

####### add bivalent and monovalent (40% of bivalent) booster ##########

## Assume that the bivalent takes us back to original vaccine efficacy, the monovalent is 40% of the bivalent


###### hypothesis 1: history penalty ######

## how to treat Omicron* in this regime - like an Omicron lineage?

savefile <- savefile %>% 
  mutate(Bivalent_penalty = case_when(
    history %in% c("Vaccine")  ~ Omicron_star + Booster_Bump_Vaccine$Vax_diff,
    history %in% c("Delta_vaccine") ~ Omicron_star + Booster_Bump_Delta$Delta_vax_diff,
    history %in% c("WT_vaccine") ~ Omicron_star + 0.5*(Booster_Bump_WT$WT_vax_diff + Booster_Bump_Omicron$Omicron_vax_diff),
    history %in% c("Omicron_vaccine","Omicron_star_vaccine") ~ Omicron_star + 0.5*(Booster_Bump_Omicron$Omicron_vax_diff + Booster_Bump_WT$WT_vax_diff),
    .default = NA
  )) %>%
  mutate(Monovalent_WTpenalty = case_when(
    history %in% c("Vaccine")  ~ Omicron_star + 0.4*Booster_Bump_Vaccine$Vax_diff,
    history %in% c("Delta_vaccine") ~ Omicron_star + 0.4*Booster_Bump_Delta$Delta_vax_diff,
    history %in% c("WT_vaccine") ~ Omicron_star + 0.4*Booster_Bump_WT$WT_vax_diff,
    history %in% c("Omicron_vaccine", "Omicron_star_vaccine") ~ Omicron_star + 0.4*Booster_Bump_Omicron$Omicron_vax_diff,
    .default = NA
  )) %>% 
  mutate(Monovalent_Ompenalty = case_when(
    history %in% c("Vaccine")  ~ Omicron_star + 0.4*Booster_Bump_Vaccine$Vax_diff,
    history %in% c("Delta_vaccine") ~ Omicron_star + 0.4*Booster_Bump_Delta$Delta_vax_diff,
    history %in% c("WT_vaccine") ~ Omicron_star + 0.4*Booster_Bump_Omicron$Omicron_vax_diff,
    history %in% c("Omicron_vaccine","Omicron_star_vaccine") ~ Omicron_star + 0.4*Booster_Bump_WT$WT_vax_diff,
    .default = NA
  )) 

###### hypothesis 2: everyone gets same benefit --  average change in the data ######

savefile <- savefile %>% 
  mutate(Bivalent_efficacy = case_when(
    history %in% c("Vaccine")  ~ Omicron_star + (avg_change),
    history %in% c("Delta_vaccine") ~ Omicron_star + (avg_change),
    history %in% c("WT_vaccine") ~ Omicron_star + (avg_change),
    history %in% c("Omicron_vaccine", "Omicron_star_vaccine") ~ Omicron_star + (avg_change),
    .default = NA
  )) %>%
  mutate(Monovalent_efficacy = case_when(
    history %in% c("Vaccine")  ~ Omicron_star + 0.4*(avg_change),
    history %in% c("Delta_vaccine") ~ Omicron_star + 0.4*(avg_change),
    history %in% c("WT_vaccine") ~ Omicron_star + 0.4*(avg_change),
    history %in% c("Omicron_vaccine", "Omicron_star_vaccine") ~ Omicron_star + 0.4*(avg_change),
    .default = NA
  ))

####### hypothesis 3: everyone goes to the min protection  of the same efficacy scenarios #####

bivalent_peak <- min(savefile$Bivalent_efficacy,na.rm = T)
monovalent_peak <- min(savefile$Monovalent_efficacy,na.rm = T)


savefile <- savefile %>% 
  mutate(Bivalent_endpoint = case_when(
    history %in% c("Vaccine")  ~ bivalent_peak,
    history %in% c("Delta_vaccine") ~ bivalent_peak,
    history %in% c("WT_vaccine") ~ bivalent_peak,
    history %in% c("Omicron_vaccine", "Omicron_star_vaccine") ~ bivalent_peak,
    .default = NA
  )) %>%
  mutate(Monovalent_endpoint = case_when(
    history %in% c("Vaccine")  ~ monovalent_peak, ## 40% of the max protection
    history %in% c("Delta_vaccine") ~ monovalent_peak,
    history %in% c("WT_vaccine") ~ monovalent_peak,
    history %in% c("Omicron_vaccine", "Omicron_star_vaccine") ~ monovalent_peak,
    .default = NA
  ))

######## make unknown serotypes #########

######## serotype of length 2 - unknown #######
adds <- savefile %>%
  mutate(history = case_when(
    history %in% c("WT", "Delta", "Vaccine", "Omicron", "Omicron_star") ~ "length 1",
    history %in% c("WT_vaccine", "Omicron_vaccine", "Delta_vaccine", "Omicron_star_vaccine") ~ "length 2"
  )) %>% 
  group_by(history) %>% 
  ## average for each wave by length
  summarise(WT = mean(WT), Delta = mean(Delta), Omicron = mean(Omicron), Omicron_star = mean(Omicron_star)) %>%
  filter(history == "length 2") %>%
  ungroup() %>% mutate(Bivalent_penalty = NA, Monovalent_WTpenalty = NA, Monovalent_Ompenalty = NA,
                       # Monovalent_Omstarpenalty = NA,
                       Bivalent_efficacy = NA, Monovalent_efficacy = NA,
                       Bivalent_endpoint = NA, Monovalent_endpoint = NA)

savefile <- rbind(savefile, adds)

######### add length 4+ ########

new_row = c(history = "length 4+", WT = as.numeric(0.05), 
            Delta = as.numeric(0.05), Omicron = as.numeric(0.05),
            Omicron_star = as.numeric(0.05), 
            Bivalent_penalty = NA, Monovalent_WTpenalty = NA, Monovalent_Ompenalty = NA,
            Bivalent_efficacy = NA, Monovalent_efficacy = NA,
            Bivalent_endpoint = NA, Monovalent_endpoint = NA)

savefile <- rbind(savefile, new_row) %>%
  mutate(WT = as.numeric(WT), Delta = as.numeric(Delta), 
         Omicron = as.numeric(Omicron), Omicron_star = as.numeric(Omicron_star),
         Bivalent_penalty = as.numeric(Bivalent_penalty), 
         Monovalent_WTpenalty = as.numeric(Monovalent_WTpenalty),
         Monovalent_Ompenalty = as.numeric(Monovalent_Ompenalty),
         Bivalent_efficacy = as.numeric(Bivalent_efficacy),
         Monovalent_efficacy = as.numeric(Monovalent_efficacy), 
         Bivalent_endpoint = as.numeric(Bivalent_endpoint),
         Monovalent_endpoint = as.numeric(Monovalent_endpoint))


######## add length 3 halfway between length 2 and length 3 ########

means <- savefile %>% filter(history == "length 2" | history == "length 4+") %>%
  summarise(WT = mean(WT), Delta = mean(Delta), Omicron = mean(Omicron), Omicron_star = mean(Omicron_star)) %>%
  mutate(Bivalent_penalty = NA, Monovalent_WTpenalty = NA, Monovalent_Ompenalty = NA,
         Bivalent_efficacy = NA, Monovalent_efficacy = NA,
         Bivalent_endpoint = NA, Monovalent_endpoint = NA) %>%
  add_column(history = "length 3", .before = "WT")

savefile <- rbind(savefile, means)

##### Get Omicron column - but bump bivalent by 0.05 and monovalent Omicron by 0.1

savefile <- savefile %>% 
  mutate(Monovalent_Omefficacy = Monovalent_efficacy,
         Monovalent_Omendpoint = Monovalent_endpoint) %>%
  rename(Monovalent_WTendpoint=Monovalent_endpoint,
         Monovalent_WTefficacy = Monovalent_efficacy) %>%
  pivot_longer(Bivalent_penalty:Monovalent_Omendpoint, 
               values_to = "protection_star", 
               names_to = "scenario") %>%
  mutate(protection_om = protection_star - 0.10) %>% ## account for adding the same bar but to an Omicron history instead of Omicron*
  mutate(protection_om = case_when(
    substr(scenario, 1, 3) == "Biv" ~ protection_om - 0.05,
    scenario %in% c("Monovalent_Omefficacy", "Monovalent_Ompenalty","Monovalent_Omendpoint") ~ protection_om-0.1,
    scenario %in% c("Monovalent_WTefficacy", "Monovalent_WTendpoint", "Monovalent_WTpenalty") ~ protection_om
  )) %>% 
  mutate(scenario_om = paste(scenario, "_Omicron"),
         scenario_om = gsub(" ", "", scenario_om))


test1 <- savefile %>% select(-c(scenario_om, protection_om))%>%
  mutate(protection_star = if_else(protection_star <= 1, protection_star, 1),
         protection_star = if_else(protection_star >=0, protection_star, 0)) %>%
  pivot_wider(names_from = scenario, values_from = protection_star) 

test2 <- savefile %>% select(-c(scenario,protection_star)) %>%
  mutate(protection_om = if_else(protection_om <= 1, protection_om, 1),
         protection_om = if_else(protection_om >=0, protection_om, 0)) %>%
  pivot_wider(names_from = scenario_om, values_from = protection_om)

test_full <- left_join(test1, test2, by = c("history", "WT", "Delta","Omicron", "Omicron_star"))


savefile <- test_full %>% arrange(history) %>% 
  pivot_longer(2:23, names_to = "type", values_to = "values") %>% 
  mutate(values = round(values, 2),
         values = if_else(
           values > 1, 1, values
         )) %>% 
  mutate(values = round(values, 2),
         values = if_else(
           values < 0, 0, values
         )) %>% 
  pivot_wider(names_from = "type", values_from = "values") %>% 
  arrange(history)

write_csv(savefile , "../Data/ABM_Parameters_Data/paramScale_MonOm.csv")

```


#### Age table
```{r}
##read in data
age_data = read.csv("../Data/ABM_Parameters_Data/lab_agestructure.csv")

#create clean data frame
data_frame_all = as.data.frame(age_data)
data_frame_no_na = na.omit(data_frame_all) 

####get totals####
e_young = with(data_frame_no_na, sum(ECUADOR[AGE<=20]))
e_mid = with(data_frame_no_na, sum(ECUADOR[AGE<=65 & AGE>20]))
e_old = with(data_frame_no_na, sum(ECUADOR[AGE>65]))
e_total = with(data_frame_no_na, sum(ECUADOR))

i_young = with(data_frame_no_na, sum(INDIA[AGE<=20]))
i_mid = with(data_frame_no_na, sum(INDIA[AGE<=65 & AGE>20]))
i_old = with(data_frame_no_na, sum(INDIA[AGE>65]))
i_total = with(data_frame_no_na, sum(INDIA))

m_young = with(data_frame_no_na, sum(MALAYSIA[AGE<=20]))
m_mid = with(data_frame_no_na, sum(MALAYSIA[AGE<=65 & AGE>20]))
m_old = with(data_frame_no_na, sum(MALAYSIA[AGE>65]))
m_total = with(data_frame_no_na, sum(MALAYSIA))

#####create stratified data frame####
age_structure_df = data.frame(
  "ECUADOR" = c(e_young, e_mid, e_old, e_total),
  "INDIA" = c(i_young, i_mid, i_old, i_total),
  "MALAYSIA" = c(m_young, m_mid, m_old, m_total)
)
rownames(age_structure_df) = c("0-20","21-65", "65+", "Total")
print(age_structure_df)
View(age_structure_df)

write.csv(age_structure_df, "../Data/ABM_Parameters_Data/age_table.csv")

```



#### Main text grid
```{r}

b <- c(1)#, 300/90)
SAR <- c(1.1*0.427, 1.3*0.427)#c(0.427) ##, 0.512)
w  <- 1/300
scenario <- c("penalty", "WTpenalty","Ompenalty","efficacy", "endpoint", "Omefficacy", "Omendpoint","WTefficacy", "WTendpoint")
booster <- c("Bivalent", "Monovalent")
vaccine_star <- c("no")
boost_shape <- c("functional")
speed <- c("fast", "slow")

## scale level of protection against infection relative to protection against severity
inf_vs_sev <- c(0.8)

age_wt <- read_csv("../Data/ABM_Parameters_Data/age_table.csv") %>%
  rename(age = 1, Ecuador = 2, India = 3, Malaysia = 4) %>%
  pivot_longer(2:4, names_to = "Name", values_to = "count") %>%
  ## mutate(count = if_else(Name == "India", count/(10^6),count/(10^6))) %>%
  mutate(count = as.integer(count)) %>%
  pivot_wider(names_from = age, values_from = "count") %>%
  rename(child = 2, adult = 3, old = 4) %>% 
  mutate(child = child/Total, adult = adult/Total, old=old/Total)

contact <- read_excel("../Data/ABM_Parameters_Data/ContactRates_AgeCountry.xlsx") %>% 
  mutate(indices = 1:17) %>%
  mutate(Name = case_when(
    indices <=6 ~ "India",
    indices >6 & indices <= 12 ~ "Ecuador",
    indices >12 ~ "Malaysia"
  )) %>% 
  select(age = 1, child = 2, adult = 3, old = 4, Name) %>% 
  mutate(child = as.numeric(child), adult = as.numeric(adult), old = as.numeric(old)) %>%
  filter(!is.na(child)) %>% 
  mutate(tot = child + adult + old) %>% 
  select(Name, age, tot) %>% 
  pivot_wider(names_from = age, values_from = tot) %>% 
  # read_excel("../../../Parametrization Data/Contacts/Contact_Reformat.xlsx") %>%
  mutate(contact_total = 0.25*(child*age_wt$child + adult*age_wt$adult + elderly*age_wt$old)) %>%
  group_by(Name) %>%
  summarise(c_LL = 0.7*0.6*contact_total, c_LH = 0.7*0.4*contact_total, 
            c_HH = 0.4*0.6*contact_total, c_HL = 0.4*0.4*contact_total) %>%
  ungroup()


df <- expand_grid(replicate=1:500, b = b, SAR=SAR, w =w, 
                  booster = booster, scenario = scenario,
                  inf_vs_sev = inf_vs_sev,
                  vaccine_star = vaccine_star,
                  boost_shape = boost_shape,
                  speed = speed
                  ) %>% 
  mutate(remove = case_when(
    booster == "Bivalent" & scenario == "WTpenalty" ~ "yes",
    booster == "Bivalent" & scenario == "Ompenalty" ~ "yes",
    booster == "Bivalent" & scenario == "WTefficacy"~ "yes",
    booster== "Bivalent" & scenario =="Omefficacy"~ "yes",
    booster == "Bivalent" & scenario =="WTendpoint" ~"yes",
    booster == "Bivalent" & scenario == "Omendpoint" ~ "yes",
    booster == "Monovalent" & scenario == "penalty" ~ "yes",
    booster == "Monovalent" & scenario == "efficacy" ~ "yes",
    booster == "Monovalent" & scenario == "endpoint" ~ "yes",
    .default = "no"
  )) %>% 
  filter(remove == "no")
  

test <- df%>%select(booster,scenario) %>%distinct()
  
  ## Rules: Want c_HH to have roughly 1 contact as the basis and then multiply by 0.2. Then 30% reduction in contact for low SES and 
  ## 60% for high SES. Assume 60% of contact is within group, 40% is out group. 
  
age <- read_csv("../Data/ABM_Parameters_Data/age_table.csv") %>%
  rename(age = 1, Ecuador = 2, India = 3, Malaysia = 4) %>%
  pivot_longer(2:4, names_to = "Name", values_to = "count") %>%
 ## mutate(count = if_else(Name == "India", count/(10^6),count/(10^6))) %>%
  mutate(count = as.integer(count)) %>%
  pivot_wider(names_from = age, values_from = "count") %>%
  rename(child = 2, adult = 3, old = 4) %>%
  mutate(child = as.integer(0.5*(10^5)*child/Total), ## CHANGE BACK TO 10^5
         adult = as.integer(0.5*(10^5)*adult/Total),
         old = as.integer(0.5*(10^5)*old/Total)) %>%
  ## check that pop is 500,000
  mutate(Total = child+adult+old) %>%
  mutate(Total = NULL)

paramsH <- read_csv("../Data/ABM_Parameters_Data/paramsTable.csv") %>% filter(Name %in% c("Malaysia", "India", "Ecuador")) %>% filter(SES == "H") %>%
  rename(MH = 3, WH = 4, hH = 5) %>%
  summarise(Name, MH, WH, hH)
paramsL <- read_csv("../Data/ABM_Parameters_Data/paramsTable.csv") %>% filter(Name %in% c("Malaysia", "India", "Ecuador")) %>% filter(SES == "L") %>%
  rename(ML = 3, WL = 4, hL = 5) %>%
  summarise(Name, ML, WL, hL) 
params <- inner_join(paramsH, paramsL)


## calculate booster proportions
## Pops: I: 1B, E: 17.5 m, M: 28.6 m
##Max booster: I: 227 m, E: 10.5 m, M: 17.1

## India: 
## 24.0% of the pop is children
## Based on original vaccines, of the boosted population, we expect 0.93/(0.93 + 0.78) = 0.54% are high SES and 0.78/(0.93+0.78) = 0.46% are low SES
## High SES: Vm = 0.93, 500m, leaves 465m high SES vaccinated, of which 353.4 are non-children -- boosters 227*0.54 = 122.58, 122.58/353.4 = 0.35 of vaccinated get a booster
## Low SES: Vm = 0.78, 500m, leaves 390m low SES vaccinated, of which 296.4 are non-children -- boosters 227*0.46 = 104.42, 104.42/296.4 = .35 of vaccinated get a booster

## Malaysia: 
## 21.5% of the pop is children
## 0.97/(0.97+0.72) = 0.57 and 0.72/(0.97+0.72) = 0.43
## High SES: Vm = 0.97, 14.3m, leaves 13.87 vaccinated of which 10.89 are eligible -- boosters 17.1*0.57 = 9.747, 9.747/10.89 = 0.90 of vaccinated gets boosted 
## Low SES: Vm = 0.72, 14.3m, leaves 10.30 vaccinated of which  8.09 eligible -- boosters 17.1*0.43 = 7.353, 7.353/8.09 = 0.91 of vaccinated get boosted

## Ecuador: 
## 23.6% is children
## 1, 0.79 -- 1/(1+0.79) = 0.56 and 0.44
## High SES: Vm = 1, 8.75m, leaves 8.75m vaccinated of which 6.685 eligible -- boosters 10.5*0.56 = 5.88, 5.88/6.685 = 0.88
## Low SES: Vm = 0.79, 8.75m, leaves 6.9125 vaccinated of which 5.281 eligible-- boosters 10.5*0.44 = 4.62, 4.62/5.281 = 0.87

## what the above numbers mean: of the eligible group (adults), X% gets vaccinated
## these are NOT total pop numbers

fullpar <- inner_join(params, age) %>% 
  mutate(MH_boost = case_when(
    Name == "India" ~ "0.35",
    Name == "Malaysia" ~ "0.90",
    Name == "Ecuador" ~ "0.88"
  ),
  ML_boost = case_when(
    Name == "India" ~ "0.35",
    Name == "Malaysia" ~ "0.91",
    Name == "Ecuador" ~ "0.87"
  )
  ,
 MH_boost = as.numeric(MH_boost),
         ML_boost = as.numeric(ML_boost)
  )


dfM <- df %>% mutate(Name = "Malaysia")
dfE <- df %>% mutate(Name = "Ecuador")
dfI <- df %>% mutate(Name = "India")


stringency <- read_excel("../Data/ABM_Parameters_Data/Stringency.xlsx")

df <- rbind(dfM, dfE) %>%
  rbind(dfI) %>%
  left_join(fullpar) %>%
  left_join(stringency %>% rename(Name = country)) %>%
  arrange(replicate) %>% 
  left_join(contact) %>%
  add_column(variant_test = "NA", .after = "string_om2")
##%>% filter(Name == "India")


serotypes_star <- read_csv("../Data/ABM_Parameters_Data/paramScale_MonOm.csv") %>% 
  select(history, Bivalent_penalty, Bivalent_efficacy, Bivalent_endpoint, 
         Monovalent_WTpenalty,Monovalent_Ompenalty, 
         Monovalent_WTefficacy, Monovalent_Omefficacy,
         Monovalent_WTendpoint, Monovalent_Omendpoint) %>% 
  pivot_longer(Bivalent_penalty:Monovalent_Omendpoint, names_to = "names", values_to = "values") %>% 
  separate(names, into = c("booster", "scenario"), sep = "_") %>%
  filter(!is.na(values)) %>%
  pivot_wider(names_from = history, values_from = values)
  

serotypes_Omicron <- read_csv("../Data/ABM_Parameters_Data/paramScale_MonOm.csv") %>% 
  select(history, Bivalent_penalty_Omicron, Bivalent_efficacy_Omicron, Bivalent_endpoint_Omicron, 
         Monovalent_WTpenalty_Omicron,Monovalent_Ompenalty_Omicron, 
         Monovalent_WTefficacy_Omicron, Monovalent_Omefficacy_Omicron,
         Monovalent_WTendpoint_Omicron, Monovalent_Omendpoint_Omicron) %>% 
  pivot_longer(Bivalent_penalty_Omicron:Monovalent_Omendpoint_Omicron, names_to = "names", values_to = "values") %>% 
  separate(names, into = c("booster", "scenario"), sep = "_") %>%
  filter(!is.na(values)) %>%
  pivot_wider(names_from = history, values_from = values) %>%
  rename(Delta_vaccine_Om = Delta_vaccine,
         Omicron_star_vaccine_Om = Omicron_star_vaccine,
         Omicron_vaccine_Om = Omicron_vaccine,
         Vaccine_Om = Vaccine,
         WT_vaccine_Om = WT_vaccine)

serotypes <- left_join(serotypes_star, serotypes_Omicron, by = c("booster","scenario")) 

df_everything <- left_join(df, serotypes, by = c("booster","scenario")) %>%
  mutate(boost = "yes")

df_everything <- df_everything %>%
  mutate(
    WH_boost = case_when(
      speed == "slow" ~ WH,
      speed== "fast" ~ WH - 10
    ),
    WL_boost = case_when(
      speed == "slow" ~ WL,
      speed== "fast" ~ WL - 10
    )
  )

##### make no booster scenario #######

df_noboost <- df_everything %>% 
  filter(scenario == "WTpenalty", booster == "Monovalent", boost_shape == "functional", speed == "slow") %>% 
  mutate(scenario = "no booster", booster = "no booster", boost_shape = "no booster", speed = "no booster") %>% 
  mutate(boost = "no")
  
df_everything <- rbind(df_everything, df_noboost) %>% arrange(replicate) %>%
  filter(boost_shape == "functional" | boost_shape== "no booster") %>%
  arrange(replicate)

test <- df_everything %>% filter(scenario == "no booster")

##### get non-child proportions #####

nonchild <- age_wt %>% 
  group_by(Name) %>%
  summarise(nonchild = 1-child) %>% 
  ungroup()

df_everything <- df_everything %>% 
  left_join(nonchild)

## filter
df_everything <- df_everything %>% 
  filter(speed != "slow") %>%
  filter(scenario %in% c("no booster", "WTpenalty", "Ompenalty", "penalty"))

## extra filter

# df_everything <- df_everything %>% 
#   filter(scenario =="no booster", Name == "Malaysia")

write_csv(df_everything, "../Data/ABM_Parameters_Data/Grid_Param.csv")

```


### ABM Main Runs
#### Concatenate replicates

##### Read files AS

```{r message=FALSE}
fileNames <- list.files(path="../Data/ABM Main Runs/output_files_AS", 
                     pattern=".csv", all.files=TRUE,full.names=TRUE)

grid_v1 <- read_csv("../Data/ABM_Parameters_Data/Grid_Param.csv") %>%
  mutate(indexID = row_number())

df_info_v1 <- tibble(fileNames = fileNames) %>% 
  mutate(indexID = str_remove(fileNames, "../Data/ABM Main Runs/output_files_AS/output_1x_ID_")) %>%
  mutate(indexID = str_remove(indexID, ".csv")) %>%
  mutate(indexID = parse_number(indexID)) %>% right_join(grid_v1) %>% filter(!is.na(fileNames))

df_v1 <- df_info_v1$fileNames %>% map_dfr(read_csv)

df_v1 <- df_v1 %>% select(-`...1`) %>%
  right_join(grid_v1)

write_csv(df_v1, "../Data/ABM Main Runs/concatenated data/df_AS.csv")
```

<!-- ```{r} -->

<!-- check_test <- df_v1 %>% -->
<!--   mutate(time = round(time,0))%>% -->
<!--   filter(time <=900) %>% -->
<!--   group_by(time, Name) %>% -->
<!--   summarise(infections = 100*mean((Inf_L+Inf_H)/N)) %>% -->
<!--   ungroup() %>% -->
<!--   filter(time >899) -->


<!-- plot1 <- df_v1 %>% -->
<!--   mutate(time = round(time,0))%>% -->
<!--   filter(time <=840) %>% -->
<!--   group_by(time, Name) %>% -->
<!--   summarise(infections = 100*mean((Inf_L+Inf_H)/N)) %>% -->
<!--   ungroup() %>% -->
<!--   #filter(Name == "Ecuador", SAR=="0.4697", scenario == "no booster") %>% -->
<!--   ggplot(aes(x = time, y = infections)) + -->
<!--   geom_line() +  -->
<!--   facet_grid(~Name) -->
<!-- plot1 -->
<!-- ``` -->


##### Read files AS2

```{r message=FALSE}
fileNames <- list.files(path="../Data/ABM Main Runs/output_files_AS2", 
                     pattern=".csv", all.files=TRUE,full.names=TRUE)

grid_v2 <- read_csv("../Data/ABM_Parameters_Data/Grid_Param.csv") %>%
  mutate(indexID = row_number())

df_info_v2 <- tibble(fileNames = fileNames) %>% 
  mutate(indexID = str_remove(fileNames, "../Data/ABM Main Runs/output_files_AS2/output_1x_ID_")) %>%
  mutate(indexID = str_remove(indexID, ".csv")) %>%
  mutate(indexID = parse_number(indexID)) %>% right_join(grid_v2) %>% filter(!is.na(fileNames))

df_v2 <- df_info_v2$fileNames %>% map_dfr(read_csv)

df_v2 <- df_v2 %>% select(-`...1`) %>%
  right_join(grid_v2)

write_csv(df_v2, "../Data/ABM Main Runs/concatenated data/df_AS2.csv")
```

##### Read files AS3

```{r message=FALSE}
fileNames <- list.files(path="../Data/ABM Main Runs/output_files_AS3", 
                     pattern=".csv", all.files=TRUE,full.names=TRUE)

grid_v3 <- read_csv("../Data/ABM_Parameters_Data/Grid_Param.csv") %>%
  mutate(indexID = row_number())

df_info_v3 <- tibble(fileNames = fileNames) %>% 
  mutate(indexID = str_remove(fileNames, "../Data/ABM Main Runs/output_files_AS3/output_1x_ID_")) %>%
  mutate(indexID = str_remove(indexID, ".csv")) %>%
  mutate(indexID = parse_number(indexID)) %>% right_join(grid_v3) %>% filter(!is.na(fileNames))

df_v3 <- df_info_v3$fileNames %>% map_dfr(read_csv)

df_v3 <- df_v3 %>% select(-`...1`) %>%
  right_join(grid_v3)

write_csv(df_v3, "../Data/ABM Main Runs/concatenated data/df_AS3.csv")
```

##### Read files AS4

```{r message=FALSE}
fileNames <- list.files(path="../Data/ABM Main Runs/output_files_AS4", 
                     pattern=".csv", all.files=TRUE,full.names=TRUE)

grid_v4 <- read_csv("../Data/ABM_Parameters_Data/Grid_Param.csv") %>%
  mutate(indexID = row_number())

df_info_v4 <- tibble(fileNames = fileNames) %>% 
  mutate(indexID = str_remove(fileNames, "../Data/ABM Main Runs/output_files_AS4/output_1x_ID_")) %>%
  mutate(indexID = str_remove(indexID, ".csv")) %>%
  mutate(indexID = parse_number(indexID)) %>% right_join(grid_v4) %>% filter(!is.na(fileNames))

df_v4 <- df_info_v4$fileNames %>% map_dfr(read_csv)

df_v4 <- df_v4 %>% select(-`...1`) %>%
  right_join(grid_v4)

write_csv(df_v4, "../Data/ABM Main Runs/concatenated data/df_AS4.csv")
```

<!-- #### Write full file -->
<!-- ```{r} -->

<!-- df_full <- rbind(df_v1, df_v2) %>% rbind(df_v3) %>% rbind(df_v4) -->

<!-- write_csv(df_full, "../Data/ABM Main Runs/concatenated data/df_full.csv") -->

<!-- ``` -->



#### Make files for figures
##### Load data
```{r}

#### Load data ####

serotypes <- read_csv("../Data/ABM_Parameters_Data/paramScale_MonOm.csv")

grid_v1 <- read_csv("../Data/ABM_Parameters_Data/Grid_Param.csv") 

df <- read_csv("../Data/ABM Main Runs/concatenated data/df_AS.csv") %>% 
  select(-c(Exposed_L, Exposed_H, Sus_L, Sus_H, Rec_nat_L, Rec_nat_H, Rec_vax_L, Rec_vax_H, child, adult, old, MH, WH, hH, hL, ML, WL, variant_test, string_om2_duplicate, scale_down, c_LL, c_LH, c_HH, c_HL, nonchild))
gc()

df2 <- read_csv("../Data/ABM Main Runs/concatenated data/df_AS2.csv") %>% 
  select(-c(Exposed_L, Exposed_H, Sus_L, Sus_H, Rec_nat_L, Rec_nat_H, Rec_vax_L, Rec_vax_H, child, adult, old, MH, WH, hH, hL, ML, WL, variant_test, string_om2_duplicate, scale_down, c_LL, c_LH, c_HH, c_HL, nonchild))
gc()

df3 <- read_csv("../Data/ABM Main Runs/concatenated data/df_AS3.csv") %>% 
  select(-c(Exposed_L, Exposed_H, Sus_L, Sus_H, Rec_nat_L, Rec_nat_H, Rec_vax_L, Rec_vax_H, child, adult, old, MH, WH, hH, hL, ML, WL, variant_test, string_om2_duplicate, scale_down, c_LL, c_LH, c_HH, c_HL, nonchild))
gc() 

df4 <- read_csv("../Data/ABM Main Runs/concatenated data/df_AS4.csv") %>% 
  select(-c(Exposed_L, Exposed_H, Sus_L, Sus_H, Rec_nat_L, Rec_nat_H, Rec_vax_L, Rec_vax_H, child, adult, old, MH, WH, hH, hL, ML, WL, variant_test, string_om2_duplicate, scale_down, c_LL, c_LH, c_HH, c_HL, nonchild))
gc()


df <- rbind(df, df2)
rm(df2)
gc()
df <- rbind(df, df3)
rm(df3)
gc()
df <- rbind(df, df4)
rm(df4)
gc()

# df <- df_full #read_csv("../Data/ABM Main Runs/concatenated data/df_full.csv")

```

##### dataAll
```{r}

dataAll <- df %>%
  select(Name, speed, vaccine_star, boost_shape, SAR, booster, scenario, boost, N, Inf_H, Inf_L, Dead_H, Dead_L, cum_cases_H, cum_cases_L, replicate, time, vaccinatedH,vaccinatedL, boostedH, boostedL) %>%
  #pivot_longer(count_Naive:count_Vaccine_boost, names_to = "history_types", values_to = "history_counts") %>%
  select(Name, speed, vaccine_star, boost_shape, SAR, booster, scenario, boost, N, Inf_H, Inf_L, Dead_H, Dead_L, cum_cases_H, cum_cases_L, replicate, time, vaccinatedH, vaccinatedL, boostedH, boostedL) %>% #count_Naive:count_Vaccine_boost) %>%
  mutate(country = Name, 
         time = as.integer(time), 
         infections_over_time = Inf_L+Inf_H, 
         infections_perc_over_time = 100*(Inf_L+Inf_H)/N,
         deaths_over_time = Dead_L + Dead_H, 
         deaths_perc_over_time = 100*(Dead_L + Dead_H)/N,
         cum_sum_Inf = cum_cases_H+cum_cases_L,
         cum_sum_per_N = (cum_cases_H + cum_cases_L)/N,
         boosted_over_time = boostedH+boostedL,
         boosted_perc_over_time = 100*(boostedH + boostedL)/N,
         vaccinated_over_time = vaccinatedH+vaccinatedL,
         vaccinated_perc_over_time = 100*(vaccinatedH + vaccinatedL)/N) %>%
  group_by(scenario, speed, vaccine_star, boost_shape, SAR, booster, boost, country, replicate) %>%
  mutate(ID_runs = cur_group_id()) %>% ungroup() %>%
  # select(ID_runs, speed, SAR, scenario, vaccine_star, boost_shape, booster, boost, country,
  #        replicate, time, N, infections_over_time:cum_sum_Inf, vaccinated, boosted) %>%
  #mutate(history_types = gsub("count_", "", history_types)) %>%
  #mutate(dummy = NULL) %>%
  arrange(ID_runs) %>%
  #filter(seed_WT == "yes") %>%
  select(-ID_runs) %>% filter(!is.na(time)) %>%
  group_by(SAR, scenario, speed,vaccine_star, boost_shape,booster,boost,country,replicate) %>%
  mutate(ID_runs = cur_group_id()) %>% ungroup() #%>%
  #select(SAR, speed, replicate,scenario,vaccine_star, boost_shape,booster,boost,country,time:cum_sum_Inf, vaccinated, boosted)

write_csv(dataAll, "../Data/ABM Main Runs/dataAll.csv")


```

##### dataHistories
```{r}

#### for history plot 

dataHistories <- df %>%
  filter(booster == "no booster", vaccine_star == "no", SAR == 1.1*0.427, time < 840) %>%
  select(Name, N, count_Naive:count_Vaccine_boost, replicate, time) %>%
  # rbind(datahist2) %>%
  # rbind(datahist3) %>%
  # rbind(datahist4) %>%
  mutate(country = Name, time = as.integer(time)) %>%
  group_by(country, replicate) %>%
  mutate(ID_runs = cur_group_id()) %>% ungroup() %>%
  select(ID_runs, country,
         replicate, time, N, count_Naive:count_Vaccine_boost) %>%
  arrange(ID_runs) %>%
  #filter(seed_WT == "yes") %>%
  select(-ID_runs) %>% filter(!is.na(time)) %>%
  group_by(country,replicate) %>%
  mutate(ID_runs = cur_group_id()) %>% ungroup() %>%
  select(replicate,N, country,time, count_Naive:count_Vaccine_boost) %>%
  #mutate(history_counts = 100*history_counts/N) %>%
  group_by(country, time) %>%
  summarise(Naive  = smean.cl.normal(100*count_Naive/N), 
            Vaccine = smean.cl.normal(100*count_Vaccine/N),
            WT = smean.cl.normal(100*count_WT/N),
            WT_vaccine = smean.cl.normal(100*count_WT_vaccine/N),
            Delta = smean.cl.normal(100*count_Delta/N),
            Delta_vaccine = smean.cl.normal(100*count_Delta_vaccine/N),
            Omicron = smean.cl.normal(100*count_Omicron/N),
            Omicron_vaccine = smean.cl.normal(100*count_Omicron_vaccine/N),
            two = smean.cl.normal(100*count_two/N),
            three = smean.cl.normal(100*count_three/N),
            four = smean.cl.normal(100*count_four/N),
            name = c("Mean","Lower","Upper")
            ) %>%
  # summarise(Naive = mean(100*count_Naive/N),
  #           Vaccine = mean(100*count_Vaccine/N),
  #           WT = mean(100*count_WT/N),
  #           WT_vaccine = mean(100*count_WT_vaccine/N),
  #           Delta = mean(100*count_Delta/N),
  #           Delta_vaccine = mean(100*count_Delta_vaccine/N),
  #           Omicron = mean(100*count_Omicron/N),
  #           Omicron_vaccine = mean(100*count_Omicron_vaccine/N),
  #           two = mean(100*count_two/N),
  #           three = mean(100*count_three/N),
  #           four = mean(100*count_four/N)
  # ) %>%
  pivot_longer(Naive:four, names_to = "history_types", values_to = "history_counts") %>%
  ungroup() %>% 
  select(country, time, history_types, history_counts,name)

write_csv(dataHistories, "../Data/ABM Main Runs/dataHistories.csv")

```


##### dataHistories - 899
```{r}

#### for history plot 

dataHistories899 <- df %>%
  mutate(time = as.integer(time)) %>%
  filter(booster == "no booster", vaccine_star == "no", SAR == 1.1*0.427, time == 899) %>%
  select(Name, N, count_Naive:count_Vaccine_boost, replicate, time) %>%
  # rbind(datahist2) %>%
  # rbind(datahist3) %>%
  # rbind(datahist4) %>%
  mutate(country = Name) %>%
  group_by(country, replicate) %>%
  mutate(ID_runs = cur_group_id()) %>% ungroup() %>%
  select(ID_runs, country,
         replicate, time, N, count_Naive:count_Vaccine_boost) %>%
  arrange(ID_runs) %>%
  #filter(seed_WT == "yes") %>%
  select(-ID_runs) %>% filter(!is.na(time)) %>%
  group_by(country,replicate) %>%
  mutate(ID_runs = cur_group_id()) %>% ungroup() %>%
  select(replicate,N, country,time, count_Naive:count_Vaccine_boost) %>%
  #mutate(history_counts = 100*history_counts/N) %>%
  group_by(country, time) %>%
  summarise(Naive  = smean.cl.normal(100*count_Naive/N), 
            Vaccine = smean.cl.normal(100*count_Vaccine/N),
            WT = smean.cl.normal(100*count_WT/N),
            WT_vaccine = smean.cl.normal(100*count_WT_vaccine/N),
            Delta = smean.cl.normal(100*count_Delta/N),
            Delta_vaccine = smean.cl.normal(100*count_Delta_vaccine/N),
            Omicron = smean.cl.normal(100*count_Omicron/N),
            Omicron_vaccine = smean.cl.normal(100*count_Omicron_vaccine/N),
            two = smean.cl.normal(100*count_two/N),
            three = smean.cl.normal(100*count_three/N),
            four = smean.cl.normal(100*count_four/N),
            name = c("Mean","Lower","Upper")
            ) %>%
  # summarise(Naive = mean(100*count_Naive/N),
  #           Vaccine = mean(100*count_Vaccine/N),
  #           WT = mean(100*count_WT/N),
  #           WT_vaccine = mean(100*count_WT_vaccine/N),
  #           Delta = mean(100*count_Delta/N),
  #           Delta_vaccine = mean(100*count_Delta_vaccine/N),
  #           Omicron = mean(100*count_Omicron/N),
  #           Omicron_vaccine = mean(100*count_Omicron_vaccine/N),
  #           two = mean(100*count_two/N),
  #           three = mean(100*count_three/N),
  #           four = mean(100*count_four/N)
  # ) %>%
  pivot_longer(Naive:four, names_to = "history_types", values_to = "history_counts") %>%
  ungroup() %>% 
  select(country, time, history_types, history_counts,name)

write_csv(dataHistories899, "../Data/ABM Main Runs/dataHistories899.csv")

```





##### key_times
```{r}
key_times <- df %>%
  filter(SAR == 1.1*0.427, vaccine_star == "no") %>% ## KEEP THIS FILTER
  mutate(time = as.integer(time)) %>%
  filter(time == 839 | time == 899 | time == 869) %>%
  select(Name, speed,booster, boost, boost_shape, scenario,N, count_Naive:count_Vaccine_boost, replicate, time) %>%
  # rbind(datahist2) %>%
  # rbind(datahist3) %>%
  # rbind(datahist4) %>%
  mutate(country = Name, time = as.integer(time)) %>%
  group_by(scenario, speed,booster, boost, boost_shape, country, replicate) %>%
  mutate(ID_runs = cur_group_id()) %>% ungroup() %>%
  select(ID_runs, country, speed,
         replicate, time, N,booster, boost, boost_shape, scenario, count_Naive:count_Vaccine_boost) %>%
  arrange(ID_runs) %>%
  #filter(seed_WT == "yes") %>%
  select(-ID_runs) %>% filter(!is.na(time)) %>%
  ungroup() %>%
  group_by(scenario, speed,booster, boost, boost_shape, country, replicate) %>%
  mutate(ID_runs = cur_group_id()) %>% ungroup() %>%
  select(replicate,speed,N, country,time, booster, boost, boost_shape,scenario, count_Naive:count_Vaccine_boost) %>%
  #mutate(history_counts = 100*history_counts/N) %>%
  group_by(country, speed,time, scenario, booster, boost, boost_shape,) %>%
  summarise(Naive = mean(100*count_Naive/N),
            Vaccine = mean(100*count_Vaccine/N),
            Vaccine_boost = mean(100*count_Vaccine_boost/N),
            WT = mean(100*count_WT/N),
            WT_vaccine = mean(100*count_WT_vaccine/N),
            WT_vaccine_boost = mean(100*count_WT_vaccine_boost/N),
            Delta = mean(100*count_Delta/N),
            Delta_vaccine = mean(100*count_Delta_vaccine/N),
            Delta_vaccine_boost = mean(100*count_Delta_vaccine_boost/N),
            Omicron = mean(100*count_Omicron/N),
            Omicron_vaccine = mean(100*count_Omicron_vaccine/N),
            Omicron_vaccine_boost = mean(100*count_Omicron_vaccine_boost/N),
            two = mean(100*count_two/N),
            three = mean(100*count_three/N),
            four = mean(100*count_four/N)
  ) %>%
  pivot_longer(Naive:four, names_to = "history_types", values_to = "history_counts") %>%
  ungroup()


write_csv(key_times, "../Data/ABM Main Runs/keyTimes.csv")
```

### ODE Main Runs
#### Make files for figures

##### Malaysia grid
```{r}
#### Malaysia grid ####

end_malaysia_sweep<-readRDS('../Data/ODE outputs/endfile_sweep010224_malaysiagrid_Evax.RDS')
end_malaysia_sweep$popsize<-28552712
end_malaysia_sweep$deaths_100k<-(end_malaysia_sweep$DeathsAll/end_malaysia_sweep$popsize)*100000
end_noboost_malaysia<-subset(end_malaysia_sweep, end_malaysia_sweep$boost.adult==0)
end_boost_malaysia<-subset(end_malaysia_sweep, end_malaysia_sweep$boost.adult>0)
sum(end_malaysia_sweep[1,c(2:217)])

end_boost <-end_boost_malaysia %>% 
  pivot_longer(-c(time, boost.speed, sweepnum, boost.child, cvax,
                  boost.adult, max.boost_h, max.boost_l, max.boost.child, wanevar,
                  child.max,cp,base.imm,sd,relax,boost.start,dWVH,k_h,k_l,
                  vei2,veh2,DeathsAll,popsize,deaths_100k
  ))
end_no_boost <- end_noboost_malaysia %>% 
  pivot_longer(-c(time, boost.speed, sweepnum, boost.child, cvax,
                  boost.adult, max.boost_h, max.boost_l, max.boost.child, wanevar,
                  child.max,cp,base.imm,sd,relax,boost.start,dWVH,k_h,k_l,
                  vei2,veh2,DeathsAll,popsize,deaths_100k
  ))

dfCompODE <- end_noboost_malaysia %>% 
  select(deaths_100k, DeathsAll, cp, relax, 
         base.imm) %>% distinct() %>% 
  rename(deaths_100k_comp = deaths_100k,
         DeathsAll_comp = DeathsAll)

df_AvertedODE <- end_boost %>% 
  left_join(dfCompODE, by = c("relax", "cp", "base.imm")) %>% 
  mutate(
    da = (deaths_100k_comp - deaths_100k)/deaths_100k_comp
  ) %>% 
  distinct() %>% 
  filter(
    veh2==0.657 | (veh2 == max(veh2) & vei2 == max(vei2))
  ) %>% 
  mutate(
    Booster = if_else(
      veh2 == 0.657, "Monovalent",
      "Bivalent"
    )
  )%>%
  mutate(name = NULL, value = NULL) %>%
  distinct()

write_csv(df_AvertedODE, "../Data/ODE Main Runs/Malaysia_grid_da.csv")
```


##### Ecuador grid
```{r}
#### Ecuador grid ####

end_ecuador_sweep<-readRDS('../Data/ODE outputs/endfile_sweep010424_ecuadorgrid.RDS')
end_ecuador_sweep$popsize<-15735139
end_ecuador_sweep$deaths_100k<-(end_ecuador_sweep$DeathsAll/end_ecuador_sweep$popsize)*100000
end_noboost_ecuador<-subset(end_ecuador_sweep, end_ecuador_sweep$boost.adult==0)
end_boost_ecuador<-subset(end_ecuador_sweep, end_ecuador_sweep$boost.adult>0)
sum(end_ecuador_sweep[1,c(2:217)])

end_boost <-end_boost_ecuador %>% 
  pivot_longer(-c(time, boost.speed, sweepnum, boost.child, cvax,
                  boost.adult, max.boost_h, max.boost_l, max.boost.child, wanevar,
                  child.max,cp,base.imm,sd,relax,boost.start,dWVH,k_h,k_l,
                  vei2,veh2,DeathsAll,popsize,deaths_100k
  ))
end_no_boost <- end_noboost_ecuador %>% 
  pivot_longer(-c(time, boost.speed, sweepnum, boost.child, cvax,
                  boost.adult, max.boost_h, max.boost_l, max.boost.child, wanevar,
                  child.max,cp,base.imm,sd,relax,boost.start,dWVH,k_h,k_l,
                  vei2,veh2,DeathsAll,popsize,deaths_100k
  ))

dfCompODE <- end_noboost_ecuador %>% 
  select(deaths_100k, DeathsAll, cp, relax, 
         base.imm) %>% distinct() %>% 
  rename(deaths_100k_comp = deaths_100k,
         DeathsAll_comp = DeathsAll)

df_AvertedODE <- end_boost %>% 
  left_join(dfCompODE, by = c("relax", "cp", "base.imm")) %>% 
  mutate(
    da = (deaths_100k_comp - deaths_100k)/deaths_100k_comp
  ) %>% 
  distinct() %>% 
  filter(
    veh2==0.657 | (veh2 == max(veh2) & vei2 == max(vei2))
  ) %>% 
  mutate(
    Booster = if_else(
      veh2 == 0.657, "Monovalent",
      "Bivalent"
    )
  )%>%
  mutate(name = NULL, value = NULL) %>%
  distinct()

write_csv(df_AvertedODE, "../Data/ODE Main Runs/Ecuador_grid_da.csv")
```

##### India grid
```{r}
#### India grid ####

end_india_sweep<-readRDS('../Data/ODE outputs/endfile_sweep010324_indiagrid_Evax.RDS')
end_india_sweep$popsize<-1155561222
end_india_sweep$deaths_100k<-(end_india_sweep$DeathsAll/end_india_sweep$popsize)*100000
end_noboost_india<-subset(end_india_sweep, end_india_sweep$boost.adult==0)
end_boost_india<-subset(end_india_sweep, end_india_sweep$boost.adult>0)
sum(end_india_sweep[1,c(2:217)])

end_boost <-end_boost_india %>% 
  pivot_longer(-c(time, boost.speed, sweepnum, boost.child, cvax,
                  boost.adult, max.boost_h, max.boost_l, max.boost.child, wanevar,
                  child.max,cp,base.imm,sd,relax,boost.start,dWVH,k_h,k_l,
                  vei2,veh2,DeathsAll,popsize,deaths_100k
  ))
end_no_boost <- end_noboost_india %>% 
  pivot_longer(-c(time, boost.speed, sweepnum, boost.child, cvax,
                  boost.adult, max.boost_h, max.boost_l, max.boost.child, wanevar,
                  child.max,cp,base.imm,sd,relax,boost.start,dWVH,k_h,k_l,
                  vei2,veh2,DeathsAll,popsize,deaths_100k
  ))

dfCompODE <- end_noboost_india %>% 
  select(deaths_100k, DeathsAll, cp, relax, 
         base.imm) %>% distinct() %>% 
  rename(deaths_100k_comp = deaths_100k,
         DeathsAll_comp = DeathsAll)

df_AvertedODE <- end_boost %>% 
  left_join(dfCompODE, by = c("relax", "cp", "base.imm")) %>% 
  mutate(
    da = (deaths_100k_comp - deaths_100k)/deaths_100k_comp
  ) %>% 
  distinct() %>% 
  filter(
    veh2==0.657 | (veh2 == max(veh2) & vei2 == max(vei2))
  ) %>% 
  mutate(
    Booster = if_else(
      veh2 == 0.657, "Monovalent",
      "Bivalent"
    )
  )%>%
  mutate(name = NULL, value = NULL) %>%
  distinct()

write_csv(df_AvertedODE, "../Data/ODE Main Runs/India_grid_da.csv")
```


##### Malaysia deaths averted
```{r}
#### Malaysia runs ####

end_malaysia_sweep<-readRDS('../Data/ODE outputs/endfile_sweep010224_malaysiaboost_Evax.RDS')
end_malaysia_sweep$popsize<-28552712
end_malaysia_sweep$deaths_100k<-(end_malaysia_sweep$DeathsAll/end_malaysia_sweep$popsize)*100000
end_noboost_malaysia<-subset(end_malaysia_sweep, end_malaysia_sweep$boost.adult==0)
end_boost_malaysia<-subset(end_malaysia_sweep, end_malaysia_sweep$boost.adult>0)
sum(end_malaysia_sweep[1,c(2:217)])

end_boost <-end_boost_malaysia %>% 
  pivot_longer(-c(time, boost.speed, sweepnum, boost.child, cvax,
                  boost.adult, max.boost_h, max.boost_l, max.boost.child, wanevar,
                  child.max,cp,base.imm,sd,relax,boost.start,dWVH,k_h,k_l,
                  vei2,veh2,DeathsAll,popsize,deaths_100k
  ))
end_no_boost <- end_noboost_malaysia %>% 
  pivot_longer(-c(time, boost.speed, sweepnum, boost.child, cvax,
                  boost.adult, max.boost_h, max.boost_l, max.boost.child, wanevar,
                  child.max,cp,base.imm,sd,relax,boost.start,dWVH,k_h,k_l,
                  vei2,veh2,DeathsAll,popsize,deaths_100k
  ))

dfCompODE <- end_noboost_malaysia %>% 
  select(deaths_100k, DeathsAll, cp, relax, 
         base.imm) %>% distinct() %>% 
  rename(deaths_100k_comp = deaths_100k,
         DeathsAll_comp = DeathsAll)

df_AvertedODE <- end_boost %>% 
  left_join(dfCompODE, by = c("relax", "cp", "base.imm")) %>% 
  mutate(
    da = (deaths_100k_comp - deaths_100k)/deaths_100k_comp
  ) %>% 
  distinct() %>% 
  filter(
    veh2==0.657 | (veh2 == max(veh2) & vei2 == max(vei2))
  ) %>% 
  mutate(
    Booster = if_else(
      veh2 == 0.657, "Monovalent",
      "Bivalent"
    )
  ) %>%
  mutate(name = NULL, value = NULL) %>%
  distinct()

write_csv(df_AvertedODE, "../Data/ODE Main Runs/Malaysia_run_da.csv")
```

##### Ecuador deaths averted
```{r}

#### Ecuador runs ####

end_ecuador_sweep<-readRDS('../Data/ODE outputs/endfile_sweep010424_ecuadorboost_Evax.RDS') %>% 
  rename(sd = sd0)
end_ecuador_sweep$popsize<-15735139
end_ecuador_sweep$deaths_100k<-(end_ecuador_sweep$DeathsAll/end_ecuador_sweep$popsize)*100000
end_noboost_ecuador<-subset(end_ecuador_sweep, end_ecuador_sweep$boost.adult==0)
end_boost_ecuador<-subset(end_ecuador_sweep, end_ecuador_sweep$boost.adult>0)
sum(end_ecuador_sweep[1,c(2:217)])

end_boost <-end_boost_ecuador %>% 
  pivot_longer(-c(time, boost.speed, sweepnum, boost.child, cvax,
                  boost.adult, max.boost_h, max.boost_l, max.boost.child, wanevar,
                  child.max,cp,base.imm,sd,relax,boost.start,dWVH,k_h,k_l,
                  vei2,veh2,DeathsAll,popsize,deaths_100k
  ))
end_no_boost <- end_noboost_ecuador %>% 
  pivot_longer(-c(time, boost.speed, sweepnum, boost.child, cvax,
                  boost.adult, max.boost_h, max.boost_l, max.boost.child, wanevar,
                  child.max,cp,base.imm,sd,relax,boost.start,dWVH,k_h,k_l,
                  vei2,veh2,DeathsAll,popsize,deaths_100k
  ))

dfCompODE <- end_noboost_ecuador %>% 
  select(deaths_100k, DeathsAll, cp, relax, 
         base.imm) %>% distinct() %>% 
  rename(deaths_100k_comp = deaths_100k,
         DeathsAll_comp = DeathsAll)

df_AvertedODE <- end_boost %>% 
  left_join(dfCompODE, by = c("relax", "cp", "base.imm")) %>% 
  mutate(
    da = (deaths_100k_comp - deaths_100k)/deaths_100k_comp
  ) %>% 
  distinct() %>% 
  filter(
    veh2==0.657 | (veh2 == max(veh2) & vei2 == max(vei2))
  ) %>% 
  mutate(
    Booster = if_else(
      veh2 == 0.657, "Monovalent",
      "Bivalent"
    )
  ) %>%
  mutate(name = NULL, value = NULL) %>%
  distinct()

write_csv(df_AvertedODE, "../Data/ODE Main Runs/Ecuador_run_da.csv")
```

##### India deaths averted
```{r}
#### India runs ####

end_india_sweep<-readRDS('../Data/ODE outputs/endfile_sweep010324_indiaboost_Evax.RDS')
end_india_sweep$popsize<-1155561222
end_india_sweep$deaths_100k<-(end_india_sweep$DeathsAll/end_india_sweep$popsize)*100000
end_noboost_india<-subset(end_india_sweep, end_india_sweep$boost.adult==0)
end_boost_india<-subset(end_india_sweep, end_india_sweep$boost.adult>0)
sum(end_india_sweep[1,c(2:217)])

end_boost <-end_boost_india %>% 
  pivot_longer(-c(time, boost.speed, sweepnum, boost.child, cvax,
                  boost.adult, max.boost_h, max.boost_l, max.boost.child, wanevar,
                  child.max,cp,base.imm,sd,relax,boost.start,dWVH,k_h,k_l,
                  vei2,veh2,DeathsAll,popsize,deaths_100k
  ))
end_no_boost <- end_noboost_india %>% 
  pivot_longer(-c(time, boost.speed, sweepnum, boost.child, cvax,
                  boost.adult, max.boost_h, max.boost_l, max.boost.child, wanevar,
                  child.max,cp,base.imm,sd,relax,boost.start,dWVH,k_h,k_l,
                  vei2,veh2,DeathsAll,popsize,deaths_100k
  ))

dfCompODE <- end_noboost_india %>% 
  select(deaths_100k, DeathsAll, cp, relax, 
         base.imm) %>% distinct() %>% 
  rename(deaths_100k_comp = deaths_100k,
         DeathsAll_comp = DeathsAll)

df_AvertedODE <- end_boost %>% 
  left_join(dfCompODE, by = c("relax", "cp", "base.imm")) %>% 
  mutate(
    da = (deaths_100k_comp - deaths_100k)/deaths_100k_comp
  ) %>% 
  distinct() %>% 
  filter(
    veh2==0.657 | (veh2 == max(veh2) & vei2 == max(vei2))
  ) %>% 
  mutate(
    Booster = if_else(
      veh2 == 0.657, "Monovalent",
      "Bivalent"
    )
  ) %>%
  mutate(name = NULL, value = NULL) %>%
  distinct()

write_csv(df_AvertedODE, "../Data/ODE Main Runs/India_run_da.csv")
```

##### Malaysia time series
```{r}

#### Malaysia time series ####

load('../Data/ODE outputs/sweep_010224_malaysiaboost_Evax.RData')
model_out_dat$sweepnum<-rep(seq(from=1, to=27), each=196)
model_out_dat$Iall<-model_out_dat$Ich+model_out_dat$Ich2+model_out_dat$IVch+model_out_dat$IVch2+model_out_dat$IBch+model_out_dat$IBch2+
  model_out_dat$Iah+model_out_dat$Iah2+model_out_dat$IVah+model_out_dat$IVah2+model_out_dat$IBah+model_out_dat$IBah2+
  model_out_dat$Ieh+model_out_dat$Ieh2+model_out_dat$IVeh+model_out_dat$IVeh2+model_out_dat$IBeh+model_out_dat$IBeh2+
  model_out_dat$Icl+model_out_dat$Icl2+model_out_dat$IVcl+model_out_dat$IVcl2+model_out_dat$IBcl+model_out_dat$IBcl2+
  model_out_dat$Ial+model_out_dat$Ial2+model_out_dat$IVal+model_out_dat$IVal2+model_out_dat$IBal+model_out_dat$IBal2+
  model_out_dat$Iel+model_out_dat$Iel2+model_out_dat$IVel+model_out_dat$IVel2+model_out_dat$IBel+model_out_dat$IBel2+
  #
  model_out_dat$Ach+model_out_dat$Ach2+model_out_dat$AVch+model_out_dat$AVch2+model_out_dat$ABch+model_out_dat$ABch2+
  model_out_dat$Aah+model_out_dat$Aah2+model_out_dat$AVah+model_out_dat$AVah2+model_out_dat$ABah+model_out_dat$ABah2+
  model_out_dat$Aeh+model_out_dat$Aeh2+model_out_dat$AVeh+model_out_dat$AVeh2+model_out_dat$ABeh+model_out_dat$ABeh2+
  model_out_dat$Acl+model_out_dat$Acl2+model_out_dat$AVcl+model_out_dat$AVcl2+model_out_dat$ABcl+model_out_dat$ABcl2+
  model_out_dat$Aal+model_out_dat$Aal2+model_out_dat$AVal+model_out_dat$AVal2+model_out_dat$ABal+model_out_dat$ABal2+
  model_out_dat$Ael+model_out_dat$Ael2+model_out_dat$AVel+model_out_dat$AVel2+model_out_dat$ABel+model_out_dat$ABel2
model_out_dat$popsize<-28552712
model_out_dat$Iprop<-model_out_dat$Iall/model_out_dat$popsize*100
model_out_dat$relativeFOI<-paste(model_out_dat$relax*100, '% increase in FOI', sep='')
model_out_dat$boost.start.time<-paste('Start boosting ', model_out_dat$boost.start, ' days prior to omicron*')
model_out_dat$Booster<-NA
model_out_dat$Booster[which(model_out_dat$boost.adult==0)]<-'None'
model_out_dat$Booster[which(model_out_dat$boost.adult==1 & model_out_dat$veh2==0.657)]<-'Monovalent'
model_out_dat$Booster[which(model_out_dat$boost.adult==1 & model_out_dat$veh2==0.925)]<-'Bivalent'


## Boosted adults
model_out_dat$Nboosted.adult<-model_out_dat$SBah+model_out_dat$SBal+
  model_out_dat$EBah+model_out_dat$EBal+
  model_out_dat$ABah+model_out_dat$ABal+
  model_out_dat$IBah+model_out_dat$IBal+
  model_out_dat$RBah+model_out_dat$RBal+
  model_out_dat$SBah2+model_out_dat$SBal2+
  model_out_dat$EBah2+model_out_dat$EBal2+
  model_out_dat$ABah2+model_out_dat$ABal2+
  model_out_dat$IBah2+model_out_dat$IBal2+
  model_out_dat$RBah2+model_out_dat$RBal2+
  model_out_dat$DBah+model_out_dat$DBal+
  model_out_dat$DBah2+model_out_dat$DBal2

### Vaccinated adults
model_out_dat$Nvax.adult<-model_out_dat$SBah+model_out_dat$SBal+model_out_dat$EBah+model_out_dat$EBal+
    model_out_dat$ABah+model_out_dat$ABal+model_out_dat$IBah+model_out_dat$IBal+
    model_out_dat$RBah+model_out_dat$RBal+
    model_out_dat$SBah2+model_out_dat$SBal2+
    model_out_dat$EBah2+model_out_dat$EBal2+
    model_out_dat$ABah2+model_out_dat$ABal2+
    model_out_dat$IBah2+model_out_dat$IBal2+
    model_out_dat$RBah2+model_out_dat$RBal2+
  
  model_out_dat$SVah+model_out_dat$SVal+model_out_dat$EVah+model_out_dat$EVal+
  model_out_dat$AVah+model_out_dat$AVal+model_out_dat$IVah+model_out_dat$IVal+
  model_out_dat$RVah+model_out_dat$RVal+model_out_dat$SVah+model_out_dat$SVal+
  model_out_dat$EVah2+model_out_dat$EVal2+model_out_dat$AVah2+model_out_dat$AVal2+
  model_out_dat$IVah2+model_out_dat$IVal2+model_out_dat$RVah2+model_out_dat$RVal2+
  
  model_out_dat$DVah+model_out_dat$DVal+model_out_dat$DVah2+model_out_dat$DVal2+
  model_out_dat$DBah+model_out_dat$DBal+model_out_dat$DBah2+model_out_dat$DBal2

## Boosted elderly
model_out_dat$Nboosted.old<-model_out_dat$SBeh+model_out_dat$SBel+
  model_out_dat$EBeh+model_out_dat$EBel+
  model_out_dat$ABeh+model_out_dat$ABel+
  model_out_dat$IBeh+model_out_dat$IBel+
  model_out_dat$RBeh+model_out_dat$RBel+
  model_out_dat$SBeh2+model_out_dat$SBel2+
  model_out_dat$EBeh2+model_out_dat$EBel2+
  model_out_dat$ABeh2+model_out_dat$ABel2+
  model_out_dat$IBeh2+model_out_dat$IBel2+
  model_out_dat$RBeh2+model_out_dat$RBel2+
  model_out_dat$DBeh+model_out_dat$DBel+
  model_out_dat$DBeh2+model_out_dat$DBel2

## Vaccinated elderly
model_out_dat$Nvax.old<-model_out_dat$SBeh+model_out_dat$SBel+
  model_out_dat$EBeh+model_out_dat$EBel+
  model_out_dat$ABeh+model_out_dat$ABel+
  model_out_dat$IBeh+model_out_dat$IBel+
  model_out_dat$RBeh+model_out_dat$RBel+
  model_out_dat$SBeh2+model_out_dat$SBel2+
  model_out_dat$EBeh2+model_out_dat$EBel2+
  model_out_dat$ABeh2+model_out_dat$ABel2+
  model_out_dat$IBeh2+model_out_dat$IBel2+
  model_out_dat$RBeh2+model_out_dat$RBel2+
  model_out_dat$DBeh+model_out_dat$DBel+
  model_out_dat$DBeh2+model_out_dat$DBel2+
  
  model_out_dat$SVeh+model_out_dat$SVel+model_out_dat$EVeh+model_out_dat$EVel+
  model_out_dat$AVeh+model_out_dat$AVel+model_out_dat$IVeh+model_out_dat$IVel+
  model_out_dat$RVeh+model_out_dat$RVel+model_out_dat$SVeh+model_out_dat$SVel+
  model_out_dat$EVeh2+model_out_dat$EVel2+model_out_dat$AVeh2+model_out_dat$AVel2+
  model_out_dat$IVeh2+model_out_dat$IVel2+model_out_dat$RVeh2+model_out_dat$RVel2+
  model_out_dat$DVeh+model_out_dat$DVel+model_out_dat$DVeh2+model_out_dat$DVel2


## Boosted child
model_out_dat$Nboosted.child<-model_out_dat$SBch+model_out_dat$SBcl+
  model_out_dat$EBch+model_out_dat$EBcl+
  model_out_dat$ABch+model_out_dat$ABcl+
  model_out_dat$IBch+model_out_dat$IBcl+
  model_out_dat$RBch+model_out_dat$RBcl+
  model_out_dat$SBch2+model_out_dat$SBcl2+
  model_out_dat$EBch2+model_out_dat$EBcl2+
  model_out_dat$ABch2+model_out_dat$ABcl2+
  model_out_dat$IBch2+model_out_dat$IBcl2+
  model_out_dat$RBch2+model_out_dat$RBcl2+
  model_out_dat$DBch+model_out_dat$DBcl+
  model_out_dat$DBch2+model_out_dat$DBcl2


## Vaccinated child
model_out_dat$Nvax.child<-model_out_dat$SBch+model_out_dat$SBcl+model_out_dat$EBch+model_out_dat$EBcl+
    model_out_dat$ABch+model_out_dat$ABcl+model_out_dat$IBch+model_out_dat$IBcl+
    model_out_dat$RBch+model_out_dat$RBcl+
    model_out_dat$SBch2+model_out_dat$SBcl2+
    model_out_dat$EBch2+model_out_dat$EBcl2+
    model_out_dat$ABch2+model_out_dat$ABcl2+
    model_out_dat$IBch2+model_out_dat$IBcl2+
    model_out_dat$RBch2+model_out_dat$RBcl2+
  
  model_out_dat$SVch+model_out_dat$SVcl+model_out_dat$EVch+model_out_dat$EVcl+
  model_out_dat$AVch+model_out_dat$AVcl+model_out_dat$IVch+model_out_dat$IVcl+
  model_out_dat$RVch+model_out_dat$RVcl+model_out_dat$SVch+model_out_dat$SVcl+
  model_out_dat$EVch2+model_out_dat$EVcl2+model_out_dat$AVch2+model_out_dat$AVcl2+
  model_out_dat$IVch2+model_out_dat$IVcl2+model_out_dat$RVch2+model_out_dat$RVcl2+
  
  model_out_dat$DVch+model_out_dat$DVcl+model_out_dat$DVch2+model_out_dat$DVcl2+
  model_out_dat$DBch+model_out_dat$DBcl+model_out_dat$DBch2+model_out_dat$DBcl2


model_out_dat$pboost.coverage_of_vaccinated<-(model_out_dat$Nboosted.adult+model_out_dat$Nboosted.old + model_out_dat$Nboosted.child)/(model_out_dat$Nvax.adult+model_out_dat$Nvax.old+model_out_dat$Nvax.child)


model_out_dat <- model_out_dat %>% 
  pivot_longer(-c(time, boost.speed, sweepnum, boost.child, cvax, relativeFOI,
                  boost.adult, max.boost_h, max.boost_l, max.boost.child, wanevar,
                  child.max,cp,base.imm,sd,relax,boost.start,dWVH,k_h,k_l,
                  vei2,veh2,popsize, boost.start.time, Booster
  )) %>% 
  filter(name %in% c("Iall", "Iprop", "pboost.coverage_of_vaccinated"))

write_csv(model_out_dat, "../Data/ODE Main Runs/Malaysia_ts.csv")
```

##### Ecuador time series
```{r}

#### Ecuador time series ####

load('../Data/ODE outputs/sweep_010424_ecuadorboost_Evax.RData')
model_out_dat$sweepnum<-rep(seq(from=1, to=27), each=196)
model_out_dat$Iall<-model_out_dat$Ich+model_out_dat$Ich2+model_out_dat$IVch+model_out_dat$IVch2+model_out_dat$IBch+model_out_dat$IBch2+
  model_out_dat$Iah+model_out_dat$Iah2+model_out_dat$IVah+model_out_dat$IVah2+model_out_dat$IBah+model_out_dat$IBah2+
  model_out_dat$Ieh+model_out_dat$Ieh2+model_out_dat$IVeh+model_out_dat$IVeh2+model_out_dat$IBeh+model_out_dat$IBeh2+
  model_out_dat$Icl+model_out_dat$Icl2+model_out_dat$IVcl+model_out_dat$IVcl2+model_out_dat$IBcl+model_out_dat$IBcl2+
  model_out_dat$Ial+model_out_dat$Ial2+model_out_dat$IVal+model_out_dat$IVal2+model_out_dat$IBal+model_out_dat$IBal2+
  model_out_dat$Iel+model_out_dat$Iel2+model_out_dat$IVel+model_out_dat$IVel2+model_out_dat$IBel+model_out_dat$IBel2+
  #
  model_out_dat$Ach+model_out_dat$Ach2+model_out_dat$AVch+model_out_dat$AVch2+model_out_dat$ABch+model_out_dat$ABch2+
  model_out_dat$Aah+model_out_dat$Aah2+model_out_dat$AVah+model_out_dat$AVah2+model_out_dat$ABah+model_out_dat$ABah2+
  model_out_dat$Aeh+model_out_dat$Aeh2+model_out_dat$AVeh+model_out_dat$AVeh2+model_out_dat$ABeh+model_out_dat$ABeh2+
  model_out_dat$Acl+model_out_dat$Acl2+model_out_dat$AVcl+model_out_dat$AVcl2+model_out_dat$ABcl+model_out_dat$ABcl2+
  model_out_dat$Aal+model_out_dat$Aal2+model_out_dat$AVal+model_out_dat$AVal2+model_out_dat$ABal+model_out_dat$ABal2+
  model_out_dat$Ael+model_out_dat$Ael2+model_out_dat$AVel+model_out_dat$AVel2+model_out_dat$ABel+model_out_dat$ABel2
model_out_dat$popsize<-15735139
model_out_dat$Iprop<-model_out_dat$Iall/model_out_dat$popsize*100
model_out_dat$relativeFOI<-paste(model_out_dat$relax*100, '% increase in FOI', sep='')
model_out_dat$boost.start.time<-paste('Start boosting ', model_out_dat$boost.start, ' days prior to omicron*')
model_out_dat$Booster<-NA
model_out_dat$Booster[which(model_out_dat$boost.adult==0)]<-'None'
model_out_dat$Booster[which(model_out_dat$boost.adult==1 & model_out_dat$veh2==0.657)]<-'Monovalent'
model_out_dat$Booster[which(model_out_dat$boost.adult==1 & model_out_dat$veh2==0.925)]<-'Bivalent'

## Boosted adults
model_out_dat$Nboosted.adult<-model_out_dat$SBah+model_out_dat$SBal+
  model_out_dat$EBah+model_out_dat$EBal+
  model_out_dat$ABah+model_out_dat$ABal+
  model_out_dat$IBah+model_out_dat$IBal+
  model_out_dat$RBah+model_out_dat$RBal+
  model_out_dat$SBah2+model_out_dat$SBal2+
  model_out_dat$EBah2+model_out_dat$EBal2+
  model_out_dat$ABah2+model_out_dat$ABal2+
  model_out_dat$IBah2+model_out_dat$IBal2+
  model_out_dat$RBah2+model_out_dat$RBal2+
  model_out_dat$DBah+model_out_dat$DBal+
  model_out_dat$DBah2+model_out_dat$DBal2

### Vaccinated adults
model_out_dat$Nvax.adult<-model_out_dat$SBah+model_out_dat$SBal+model_out_dat$EBah+model_out_dat$EBal+
    model_out_dat$ABah+model_out_dat$ABal+model_out_dat$IBah+model_out_dat$IBal+
    model_out_dat$RBah+model_out_dat$RBal+
    model_out_dat$SBah2+model_out_dat$SBal2+
    model_out_dat$EBah2+model_out_dat$EBal2+
    model_out_dat$ABah2+model_out_dat$ABal2+
    model_out_dat$IBah2+model_out_dat$IBal2+
    model_out_dat$RBah2+model_out_dat$RBal2+
  
  model_out_dat$SVah+model_out_dat$SVal+model_out_dat$EVah+model_out_dat$EVal+
  model_out_dat$AVah+model_out_dat$AVal+model_out_dat$IVah+model_out_dat$IVal+
  model_out_dat$RVah+model_out_dat$RVal+model_out_dat$SVah+model_out_dat$SVal+
  model_out_dat$EVah2+model_out_dat$EVal2+model_out_dat$AVah2+model_out_dat$AVal2+
  model_out_dat$IVah2+model_out_dat$IVal2+model_out_dat$RVah2+model_out_dat$RVal2+
  
  model_out_dat$DVah+model_out_dat$DVal+model_out_dat$DVah2+model_out_dat$DVal2+
  model_out_dat$DBah+model_out_dat$DBal+model_out_dat$DBah2+model_out_dat$DBal2

## Boosted elderly
model_out_dat$Nboosted.old<-model_out_dat$SBeh+model_out_dat$SBel+
  model_out_dat$EBeh+model_out_dat$EBel+
  model_out_dat$ABeh+model_out_dat$ABel+
  model_out_dat$IBeh+model_out_dat$IBel+
  model_out_dat$RBeh+model_out_dat$RBel+
  model_out_dat$SBeh2+model_out_dat$SBel2+
  model_out_dat$EBeh2+model_out_dat$EBel2+
  model_out_dat$ABeh2+model_out_dat$ABel2+
  model_out_dat$IBeh2+model_out_dat$IBel2+
  model_out_dat$RBeh2+model_out_dat$RBel2+
  model_out_dat$DBeh+model_out_dat$DBel+
  model_out_dat$DBeh2+model_out_dat$DBel2

## Vaccinated elderly
model_out_dat$Nvax.old<-model_out_dat$SBeh+model_out_dat$SBel+
  model_out_dat$EBeh+model_out_dat$EBel+
  model_out_dat$ABeh+model_out_dat$ABel+
  model_out_dat$IBeh+model_out_dat$IBel+
  model_out_dat$RBeh+model_out_dat$RBel+
  model_out_dat$SBeh2+model_out_dat$SBel2+
  model_out_dat$EBeh2+model_out_dat$EBel2+
  model_out_dat$ABeh2+model_out_dat$ABel2+
  model_out_dat$IBeh2+model_out_dat$IBel2+
  model_out_dat$RBeh2+model_out_dat$RBel2+
  model_out_dat$DBeh+model_out_dat$DBel+
  model_out_dat$DBeh2+model_out_dat$DBel2+
  
  model_out_dat$SVeh+model_out_dat$SVel+model_out_dat$EVeh+model_out_dat$EVel+
  model_out_dat$AVeh+model_out_dat$AVel+model_out_dat$IVeh+model_out_dat$IVel+
  model_out_dat$RVeh+model_out_dat$RVel+model_out_dat$SVeh+model_out_dat$SVel+
  model_out_dat$EVeh2+model_out_dat$EVel2+model_out_dat$AVeh2+model_out_dat$AVel2+
  model_out_dat$IVeh2+model_out_dat$IVel2+model_out_dat$RVeh2+model_out_dat$RVel2+
  model_out_dat$DVeh+model_out_dat$DVel+model_out_dat$DVeh2+model_out_dat$DVel2


## Boosted child
model_out_dat$Nboosted.child<-model_out_dat$SBch+model_out_dat$SBcl+
  model_out_dat$EBch+model_out_dat$EBcl+
  model_out_dat$ABch+model_out_dat$ABcl+
  model_out_dat$IBch+model_out_dat$IBcl+
  model_out_dat$RBch+model_out_dat$RBcl+
  model_out_dat$SBch2+model_out_dat$SBcl2+
  model_out_dat$EBch2+model_out_dat$EBcl2+
  model_out_dat$ABch2+model_out_dat$ABcl2+
  model_out_dat$IBch2+model_out_dat$IBcl2+
  model_out_dat$RBch2+model_out_dat$RBcl2+
  model_out_dat$DBch+model_out_dat$DBcl+
  model_out_dat$DBch2+model_out_dat$DBcl2


## Vaccinated child
model_out_dat$Nvax.child<-model_out_dat$SBch+model_out_dat$SBcl+model_out_dat$EBch+model_out_dat$EBcl+
    model_out_dat$ABch+model_out_dat$ABcl+model_out_dat$IBch+model_out_dat$IBcl+
    model_out_dat$RBch+model_out_dat$RBcl+
    model_out_dat$SBch2+model_out_dat$SBcl2+
    model_out_dat$EBch2+model_out_dat$EBcl2+
    model_out_dat$ABch2+model_out_dat$ABcl2+
    model_out_dat$IBch2+model_out_dat$IBcl2+
    model_out_dat$RBch2+model_out_dat$RBcl2+
  
  model_out_dat$SVch+model_out_dat$SVcl+model_out_dat$EVch+model_out_dat$EVcl+
  model_out_dat$AVch+model_out_dat$AVcl+model_out_dat$IVch+model_out_dat$IVcl+
  model_out_dat$RVch+model_out_dat$RVcl+model_out_dat$SVch+model_out_dat$SVcl+
  model_out_dat$EVch2+model_out_dat$EVcl2+model_out_dat$AVch2+model_out_dat$AVcl2+
  model_out_dat$IVch2+model_out_dat$IVcl2+model_out_dat$RVch2+model_out_dat$RVcl2+
  
  model_out_dat$DVch+model_out_dat$DVcl+model_out_dat$DVch2+model_out_dat$DVcl2+
  model_out_dat$DBch+model_out_dat$DBcl+model_out_dat$DBch2+model_out_dat$DBcl2


model_out_dat$pboost.coverage_of_vaccinated<-(model_out_dat$Nboosted.adult+model_out_dat$Nboosted.old + model_out_dat$Nboosted.child)/(model_out_dat$Nvax.adult+model_out_dat$Nvax.old+model_out_dat$Nvax.child)


model_out_dat <- model_out_dat %>% 
  pivot_longer(-c(time, boost.speed, sweepnum, boost.child, cvax, relativeFOI,
                  boost.adult, max.boost_h, max.boost_l, max.boost.child, wanevar,
                  child.max,cp,base.imm,sd0,relax,boost.start,dWVH,k_h,k_l,
                  vei2,veh2,popsize, boost.start.time, Booster
  )) %>% 
  filter(name %in% c("Iall", "Iprop", "pboost.coverage_of_vaccinated"))


write_csv(model_out_dat, "../Data/ODE Main Runs/Ecuador_ts.csv")
```

##### India time series
```{r}

#### India time series ####

load('../Data/ODE outputs/sweep_010324_indiaboost_Evax.RData')
model_out_dat$sweepnum<-rep(seq(from=1, to=27), each=196)
model_out_dat$Iall<-model_out_dat$Ich+model_out_dat$Ich2+model_out_dat$IVch+model_out_dat$IVch2+model_out_dat$IBch+model_out_dat$IBch2+
  model_out_dat$Iah+model_out_dat$Iah2+model_out_dat$IVah+model_out_dat$IVah2+model_out_dat$IBah+model_out_dat$IBah2+
  model_out_dat$Ieh+model_out_dat$Ieh2+model_out_dat$IVeh+model_out_dat$IVeh2+model_out_dat$IBeh+model_out_dat$IBeh2+
  model_out_dat$Icl+model_out_dat$Icl2+model_out_dat$IVcl+model_out_dat$IVcl2+model_out_dat$IBcl+model_out_dat$IBcl2+
  model_out_dat$Ial+model_out_dat$Ial2+model_out_dat$IVal+model_out_dat$IVal2+model_out_dat$IBal+model_out_dat$IBal2+
  model_out_dat$Iel+model_out_dat$Iel2+model_out_dat$IVel+model_out_dat$IVel2+model_out_dat$IBel+model_out_dat$IBel2+
  #
  model_out_dat$Ach+model_out_dat$Ach2+model_out_dat$AVch+model_out_dat$AVch2+model_out_dat$ABch+model_out_dat$ABch2+
  model_out_dat$Aah+model_out_dat$Aah2+model_out_dat$AVah+model_out_dat$AVah2+model_out_dat$ABah+model_out_dat$ABah2+
  model_out_dat$Aeh+model_out_dat$Aeh2+model_out_dat$AVeh+model_out_dat$AVeh2+model_out_dat$ABeh+model_out_dat$ABeh2+
  model_out_dat$Acl+model_out_dat$Acl2+model_out_dat$AVcl+model_out_dat$AVcl2+model_out_dat$ABcl+model_out_dat$ABcl2+
  model_out_dat$Aal+model_out_dat$Aal2+model_out_dat$AVal+model_out_dat$AVal2+model_out_dat$ABal+model_out_dat$ABal2+
  model_out_dat$Ael+model_out_dat$Ael2+model_out_dat$AVel+model_out_dat$AVel2+model_out_dat$ABel+model_out_dat$ABel2
model_out_dat$popsize<-1155561222
model_out_dat$Iprop<-model_out_dat$Iall/model_out_dat$popsize*100
model_out_dat$relativeFOI<-paste(model_out_dat$relax*100, '% increase in FOI', sep='')
model_out_dat$boost.start.time<-paste('Start boosting ', model_out_dat$boost.start, ' days prior to omicron*')
model_out_dat$Booster<-NA
model_out_dat$Booster[which(model_out_dat$boost.adult==0)]<-'None'
model_out_dat$Booster[which(model_out_dat$boost.adult==1 & model_out_dat$veh2==0.657)]<-'Monovalent'
model_out_dat$Booster[which(model_out_dat$boost.adult==1 & model_out_dat$veh2==0.925)]<-'Bivalent'


## Boosted adults
model_out_dat$Nboosted.adult<-model_out_dat$SBah+model_out_dat$SBal+
  model_out_dat$EBah+model_out_dat$EBal+
  model_out_dat$ABah+model_out_dat$ABal+
  model_out_dat$IBah+model_out_dat$IBal+
  model_out_dat$RBah+model_out_dat$RBal+
  model_out_dat$SBah2+model_out_dat$SBal2+
  model_out_dat$EBah2+model_out_dat$EBal2+
  model_out_dat$ABah2+model_out_dat$ABal2+
  model_out_dat$IBah2+model_out_dat$IBal2+
  model_out_dat$RBah2+model_out_dat$RBal2+
  model_out_dat$DBah+model_out_dat$DBal+
  model_out_dat$DBah2+model_out_dat$DBal2

### Vaccinated adults
model_out_dat$Nvax.adult<-model_out_dat$SBah+model_out_dat$SBal+model_out_dat$EBah+model_out_dat$EBal+
    model_out_dat$ABah+model_out_dat$ABal+model_out_dat$IBah+model_out_dat$IBal+
    model_out_dat$RBah+model_out_dat$RBal+
    model_out_dat$SBah2+model_out_dat$SBal2+
    model_out_dat$EBah2+model_out_dat$EBal2+
    model_out_dat$ABah2+model_out_dat$ABal2+
    model_out_dat$IBah2+model_out_dat$IBal2+
    model_out_dat$RBah2+model_out_dat$RBal2+
  
  model_out_dat$SVah+model_out_dat$SVal+model_out_dat$EVah+model_out_dat$EVal+
  model_out_dat$AVah+model_out_dat$AVal+model_out_dat$IVah+model_out_dat$IVal+
  model_out_dat$RVah+model_out_dat$RVal+model_out_dat$SVah+model_out_dat$SVal+
  model_out_dat$EVah2+model_out_dat$EVal2+model_out_dat$AVah2+model_out_dat$AVal2+
  model_out_dat$IVah2+model_out_dat$IVal2+model_out_dat$RVah2+model_out_dat$RVal2+
  
  model_out_dat$DVah+model_out_dat$DVal+model_out_dat$DVah2+model_out_dat$DVal2+
  model_out_dat$DBah+model_out_dat$DBal+model_out_dat$DBah2+model_out_dat$DBal2

## Boosted elderly
model_out_dat$Nboosted.old<-model_out_dat$SBeh+model_out_dat$SBel+
  model_out_dat$EBeh+model_out_dat$EBel+
  model_out_dat$ABeh+model_out_dat$ABel+
  model_out_dat$IBeh+model_out_dat$IBel+
  model_out_dat$RBeh+model_out_dat$RBel+
  model_out_dat$SBeh2+model_out_dat$SBel2+
  model_out_dat$EBeh2+model_out_dat$EBel2+
  model_out_dat$ABeh2+model_out_dat$ABel2+
  model_out_dat$IBeh2+model_out_dat$IBel2+
  model_out_dat$RBeh2+model_out_dat$RBel2+
  model_out_dat$DBeh+model_out_dat$DBel+
  model_out_dat$DBeh2+model_out_dat$DBel2

## Vaccinated elderly
model_out_dat$Nvax.old<-model_out_dat$SBeh+model_out_dat$SBel+
  model_out_dat$EBeh+model_out_dat$EBel+
  model_out_dat$ABeh+model_out_dat$ABel+
  model_out_dat$IBeh+model_out_dat$IBel+
  model_out_dat$RBeh+model_out_dat$RBel+
  model_out_dat$SBeh2+model_out_dat$SBel2+
  model_out_dat$EBeh2+model_out_dat$EBel2+
  model_out_dat$ABeh2+model_out_dat$ABel2+
  model_out_dat$IBeh2+model_out_dat$IBel2+
  model_out_dat$RBeh2+model_out_dat$RBel2+
  model_out_dat$DBeh+model_out_dat$DBel+
  model_out_dat$DBeh2+model_out_dat$DBel2+
  
  model_out_dat$SVeh+model_out_dat$SVel+model_out_dat$EVeh+model_out_dat$EVel+
  model_out_dat$AVeh+model_out_dat$AVel+model_out_dat$IVeh+model_out_dat$IVel+
  model_out_dat$RVeh+model_out_dat$RVel+model_out_dat$SVeh+model_out_dat$SVel+
  model_out_dat$EVeh2+model_out_dat$EVel2+model_out_dat$AVeh2+model_out_dat$AVel2+
  model_out_dat$IVeh2+model_out_dat$IVel2+model_out_dat$RVeh2+model_out_dat$RVel2+
  model_out_dat$DVeh+model_out_dat$DVel+model_out_dat$DVeh2+model_out_dat$DVel2


## Boosted child
model_out_dat$Nboosted.child<-model_out_dat$SBch+model_out_dat$SBcl+
  model_out_dat$EBch+model_out_dat$EBcl+
  model_out_dat$ABch+model_out_dat$ABcl+
  model_out_dat$IBch+model_out_dat$IBcl+
  model_out_dat$RBch+model_out_dat$RBcl+
  model_out_dat$SBch2+model_out_dat$SBcl2+
  model_out_dat$EBch2+model_out_dat$EBcl2+
  model_out_dat$ABch2+model_out_dat$ABcl2+
  model_out_dat$IBch2+model_out_dat$IBcl2+
  model_out_dat$RBch2+model_out_dat$RBcl2+
  model_out_dat$DBch+model_out_dat$DBcl+
  model_out_dat$DBch2+model_out_dat$DBcl2


## Vaccinated child
model_out_dat$Nvax.child<-model_out_dat$SBch+model_out_dat$SBcl+model_out_dat$EBch+model_out_dat$EBcl+
    model_out_dat$ABch+model_out_dat$ABcl+model_out_dat$IBch+model_out_dat$IBcl+
    model_out_dat$RBch+model_out_dat$RBcl+
    model_out_dat$SBch2+model_out_dat$SBcl2+
    model_out_dat$EBch2+model_out_dat$EBcl2+
    model_out_dat$ABch2+model_out_dat$ABcl2+
    model_out_dat$IBch2+model_out_dat$IBcl2+
    model_out_dat$RBch2+model_out_dat$RBcl2+
  
  model_out_dat$SVch+model_out_dat$SVcl+model_out_dat$EVch+model_out_dat$EVcl+
  model_out_dat$AVch+model_out_dat$AVcl+model_out_dat$IVch+model_out_dat$IVcl+
  model_out_dat$RVch+model_out_dat$RVcl+model_out_dat$SVch+model_out_dat$SVcl+
  model_out_dat$EVch2+model_out_dat$EVcl2+model_out_dat$AVch2+model_out_dat$AVcl2+
  model_out_dat$IVch2+model_out_dat$IVcl2+model_out_dat$RVch2+model_out_dat$RVcl2+
  
  model_out_dat$DVch+model_out_dat$DVcl+model_out_dat$DVch2+model_out_dat$DVcl2+
  model_out_dat$DBch+model_out_dat$DBcl+model_out_dat$DBch2+model_out_dat$DBcl2


model_out_dat$pboost.coverage_of_vaccinated<-(model_out_dat$Nboosted.adult+model_out_dat$Nboosted.old + model_out_dat$Nboosted.child)/(model_out_dat$Nvax.adult+model_out_dat$Nvax.old+model_out_dat$Nvax.child)


model_out_dat <- model_out_dat %>% 
  pivot_longer(-c(time, boost.speed, sweepnum, boost.child, cvax, relativeFOI,
                  boost.adult, max.boost_h, max.boost_l, max.boost.child, wanevar,
                  child.max,cp,base.imm,sd,relax,boost.start,dWVH,k_h,k_l,
                  vei2,veh2,popsize, boost.start.time, Booster
  )) %>% 
  filter(name %in% c("Iall", "Iprop", "pboost.coverage_of_vaccinated"))


write_csv(model_out_dat, "../Data/ODE Main Runs/India_ts.csv")

```



### ABM Supp 1: slow rollout

#### Supplement grid 1: slow rollout

```{r}

b <- c(1)#, 300/90)
SAR <- c(1.3*0.427)#c(0.427) ##, 0.512)
w  <- 1/300
scenario <- c("penalty", "WTpenalty","Ompenalty")
booster <- c("Bivalent", "Monovalent")
vaccine_star <- c("no")
boost_shape <- c("functional")
speed <- c("slow")

## scale level of protection against infection relative to protection against severity
inf_vs_sev <- c(0.8)

age_wt <- read_csv("../Data/ABM_Parameters_Data/age_table.csv") %>%
  rename(age = 1, Ecuador = 2, India = 3, Malaysia = 4) %>%
  pivot_longer(2:4, names_to = "Name", values_to = "count") %>%
  ## mutate(count = if_else(Name == "India", count/(10^6),count/(10^6))) %>%
  mutate(count = as.integer(count)) %>%
  pivot_wider(names_from = age, values_from = "count") %>%
  rename(child = 2, adult = 3, old = 4) %>% 
  mutate(child = child/Total, adult = adult/Total, old=old/Total)

contact <- read_excel("../Data/ABM_Parameters_Data/ContactRates_AgeCountry.xlsx") %>% 
  mutate(indices = 1:17) %>%
  mutate(Name = case_when(
    indices <=6 ~ "India",
    indices >6 & indices <= 12 ~ "Ecuador",
    indices >12 ~ "Malaysia"
  )) %>% 
  select(age = 1, child = 2, adult = 3, old = 4, Name) %>% 
  mutate(child = as.numeric(child), adult = as.numeric(adult), old = as.numeric(old)) %>%
  filter(!is.na(child)) %>% 
  mutate(tot = child + adult + old) %>% 
  select(Name, age, tot) %>% 
  pivot_wider(names_from = age, values_from = tot) %>% 
  # read_excel("../../../Parametrization Data/Contacts/Contact_Reformat.xlsx") %>%
  mutate(contact_total = 0.25*(child*age_wt$child + adult*age_wt$adult + elderly*age_wt$old)) %>%
  group_by(Name) %>%
  summarise(c_LL = 0.7*0.6*contact_total, c_LH = 0.7*0.4*contact_total, 
            c_HH = 0.4*0.6*contact_total, c_HL = 0.4*0.4*contact_total) %>%
  ungroup()


df <- expand_grid(replicate=1:500, b = b, SAR=SAR, w =w, 
                  booster = booster, scenario = scenario,
                  inf_vs_sev = inf_vs_sev,
                  vaccine_star = vaccine_star,
                  boost_shape = boost_shape,
                  speed = speed
                  ) %>% 
  mutate(remove = case_when(
    booster == "Bivalent" & scenario == "WTpenalty" ~ "yes",
    booster == "Bivalent" & scenario == "Ompenalty" ~ "yes",
    booster == "Bivalent" & scenario == "WTefficacy"~ "yes",
    booster== "Bivalent" & scenario =="Omefficacy"~ "yes",
    booster == "Bivalent" & scenario =="WTendpoint" ~"yes",
    booster == "Bivalent" & scenario == "Omendpoint" ~ "yes",
    booster == "Monovalent" & scenario == "penalty" ~ "yes",
    booster == "Monovalent" & scenario == "efficacy" ~ "yes",
    booster == "Monovalent" & scenario == "endpoint" ~ "yes",
    .default = "no"
  )) %>% 
  filter(remove == "no")
  

test <- df%>%select(booster,scenario) %>%distinct()
  
  ## Rules: Want c_HH to have roughly 1 contact as the basis and then multiply by 0.2. Then 30% reduction in contact for low SES and 
  ## 60% for high SES. Assume 60% of contact is within group, 40% is out group. 
  
age <- read_csv("../Data/ABM_Parameters_Data/age_table.csv") %>%
  rename(age = 1, Ecuador = 2, India = 3, Malaysia = 4) %>%
  pivot_longer(2:4, names_to = "Name", values_to = "count") %>%
 ## mutate(count = if_else(Name == "India", count/(10^6),count/(10^6))) %>%
  mutate(count = as.integer(count)) %>%
  pivot_wider(names_from = age, values_from = "count") %>%
  rename(child = 2, adult = 3, old = 4) %>%
  mutate(child = as.integer(0.5*(10^5)*child/Total), ## CHANGE BACK TO 10^5
         adult = as.integer(0.5*(10^5)*adult/Total),
         old = as.integer(0.5*(10^5)*old/Total)) %>%
  ## check that pop is 500,000
  mutate(Total = child+adult+old) %>%
  mutate(Total = NULL)

paramsH <- read_csv("../Data/ABM_Parameters_Data/paramsTable.csv") %>% filter(Name %in% c("Malaysia", "India", "Ecuador")) %>% filter(SES == "H") %>%
  rename(MH = 3, WH = 4, hH = 5) %>%
  summarise(Name, MH, WH, hH)
paramsL <- read_csv("../Data/ABM_Parameters_Data/paramsTable.csv") %>% filter(Name %in% c("Malaysia", "India", "Ecuador")) %>% filter(SES == "L") %>%
  rename(ML = 3, WL = 4, hL = 5) %>%
  summarise(Name, ML, WL, hL) 
params <- inner_join(paramsH, paramsL)


## calculate booster proportions
## Pops: I: 1B, E: 17.5 m, M: 28.6 m
##Max booster: I: 227 m, E: 10.5 m, M: 17.1

## India: 
## 24.0% of the pop is children
## Based on original vaccines, of the boosted population, we expect 0.93/(0.93 + 0.78) = 0.54% are high SES and 0.78/(0.93+0.78) = 0.46% are low SES
## High SES: Vm = 0.93, 500m, leaves 465m high SES vaccinated, of which 353.4 are non-children -- boosters 227*0.54 = 122.58, 122.58/353.4 = 0.35 of vaccinated get a booster
## Low SES: Vm = 0.78, 500m, leaves 390m low SES vaccinated, of which 296.4 are non-children -- boosters 227*0.46 = 104.42, 104.42/296.4 = .35 of vaccinated get a booster

## Malaysia: 
## 21.5% of the pop is children
## 0.97/(0.97+0.72) = 0.57 and 0.72/(0.97+0.72) = 0.43
## High SES: Vm = 0.97, 14.3m, leaves 13.87 vaccinated of which 10.89 are eligible -- boosters 17.1*0.57 = 9.747, 9.747/10.89 = 0.90 of vaccinated gets boosted 
## Low SES: Vm = 0.72, 14.3m, leaves 10.30 vaccinated of which  8.09 eligible -- boosters 17.1*0.43 = 7.353, 7.353/8.09 = 0.91 of vaccinated get boosted

## Ecuador: 
## 23.6% is children
## 1, 0.79 -- 1/(1+0.79) = 0.56 and 0.44
## High SES: Vm = 1, 8.75m, leaves 8.75m vaccinated of which 6.685 eligible -- boosters 10.5*0.56 = 5.88, 5.88/6.685 = 0.88
## Low SES: Vm = 0.79, 8.75m, leaves 6.9125 vaccinated of which 5.281 eligible-- boosters 10.5*0.44 = 4.62, 4.62/5.281 = 0.87

## what the above numbers mean: of the eligible group (adults), X% gets vaccinated
## these are NOT total pop numbers

fullpar <- inner_join(params, age) %>% 
  mutate(MH_boost = case_when(
    Name == "India" ~ "0.35",
    Name == "Malaysia" ~ "0.90",
    Name == "Ecuador" ~ "0.88"
  ),
  ML_boost = case_when(
    Name == "India" ~ "0.35",
    Name == "Malaysia" ~ "0.91",
    Name == "Ecuador" ~ "0.87"
  )
  ,
 MH_boost = as.numeric(MH_boost),
         ML_boost = as.numeric(ML_boost)
  )


dfM <- df %>% mutate(Name = "Malaysia")
dfE <- df %>% mutate(Name = "Ecuador")
dfI <- df %>% mutate(Name = "India")


stringency <- read_excel("../Data/ABM_Parameters_Data/Stringency.xlsx")

df <- rbind(dfM, dfE) %>%
  rbind(dfI) %>%
  left_join(fullpar) %>%
  left_join(stringency %>% rename(Name = country)) %>%
  arrange(replicate) %>% 
  left_join(contact) %>%
  add_column(variant_test = "NA", .after = "string_om2")
##%>% filter(Name == "India")


serotypes_star <- read_csv("../Data/ABM_Parameters_Data/paramScale_MonOm.csv") %>% 
  select(history, Bivalent_penalty, Bivalent_efficacy, Bivalent_endpoint, 
         Monovalent_WTpenalty,Monovalent_Ompenalty, 
         Monovalent_WTefficacy, Monovalent_Omefficacy,
         Monovalent_WTendpoint, Monovalent_Omendpoint) %>% 
  pivot_longer(Bivalent_penalty:Monovalent_Omendpoint, names_to = "names", values_to = "values") %>% 
  separate(names, into = c("booster", "scenario"), sep = "_") %>%
  filter(!is.na(values)) %>%
  pivot_wider(names_from = history, values_from = values)
  

serotypes_Omicron <- read_csv("../Data/ABM_Parameters_Data/paramScale_MonOm.csv") %>% 
  select(history, Bivalent_penalty_Omicron, Bivalent_efficacy_Omicron, Bivalent_endpoint_Omicron, 
         Monovalent_WTpenalty_Omicron,Monovalent_Ompenalty_Omicron, 
         Monovalent_WTefficacy_Omicron, Monovalent_Omefficacy_Omicron,
         Monovalent_WTendpoint_Omicron, Monovalent_Omendpoint_Omicron) %>% 
  pivot_longer(Bivalent_penalty_Omicron:Monovalent_Omendpoint_Omicron, names_to = "names", values_to = "values") %>% 
  separate(names, into = c("booster", "scenario"), sep = "_") %>%
  filter(!is.na(values)) %>%
  pivot_wider(names_from = history, values_from = values) %>%
  rename(Delta_vaccine_Om = Delta_vaccine,
         Omicron_star_vaccine_Om = Omicron_star_vaccine,
         Omicron_vaccine_Om = Omicron_vaccine,
         Vaccine_Om = Vaccine,
         WT_vaccine_Om = WT_vaccine)

serotypes <- left_join(serotypes_star, serotypes_Omicron, by = c("booster","scenario")) 

df_everything <- left_join(df, serotypes, by = c("booster","scenario")) %>%
  mutate(boost = "yes")

df_everything <- df_everything %>%
  mutate(
    WH_boost = case_when(
      speed == "slow" ~ WH,
      speed== "fast" ~ WH - 10
    ),
    WL_boost = case_when(
      speed == "slow" ~ WL,
      speed== "fast" ~ WL - 10
    )
  )

##### make no booster scenario #######

df_noboost <- df_everything %>% 
  filter(scenario == "WTpenalty", booster == "Monovalent", boost_shape == "functional", speed == "slow") %>% 
  mutate(scenario = "no booster", booster = "no booster", boost_shape = "no booster", speed = "no booster") %>% 
  mutate(boost = "no")
  
df_everything <- rbind(df_everything, df_noboost) %>% arrange(replicate) %>%
  filter(boost_shape == "functional" | boost_shape== "no booster") %>%
  arrange(replicate)

test <- df_everything %>% filter(scenario == "no booster")

##### get non-child proportions #####

nonchild <- age_wt %>% 
  group_by(Name) %>%
  summarise(nonchild = 1-child) %>% 
  ungroup()

df_everything <- df_everything %>% 
  left_join(nonchild)

## filter
df_everything <- df_everything %>% 
  filter(scenario %in% c("no booster", "WTpenalty", "Ompenalty", "penalty"))

## extra filter

# df_everything <- df_everything %>% 
#   filter(scenario =="no booster", Name == "Malaysia")

write_csv(df_everything, "../Data/ABM_Parameters_Data/Grid_Param_supp1.csv")

```

#### Concatenate replicates
##### Read files AS

```{r message=FALSE}
fileNames <- list.files(path="../Data/ABM Supplement/supp1-slow_rollout/output_files_AS", 
                     pattern=".csv", all.files=TRUE,full.names=TRUE)

grid_v1 <- read_csv("../Data/ABM_Parameters_Data/Grid_Param_supp1.csv") %>%
  mutate(indexID = row_number())

df_info_v1 <- tibble(fileNames = fileNames) %>% 
  mutate(indexID = str_remove(fileNames, "../Data/ABM Supplement/supp1-slow_rollout/output_files_AS/output_1x_ID_")) %>%
  mutate(indexID = str_remove(indexID, ".csv")) %>%
  mutate(indexID = parse_number(indexID)) %>% right_join(grid_v1) %>% filter(!is.na(fileNames))

df_v1 <- df_info_v1$fileNames %>% map_dfr(read_csv)

df_v1 <- df_v1 %>% select(-`...1`) %>%
  right_join(grid_v1)

write_csv(df_v1, "../Data/ABM Supplement/supp1-slow_rollout/concatenated data/df_AS.csv")
```

#### Make files for figures
##### Load data
```{r}

#### Load data ####

serotypes <- read_csv("../Data/ABM_Parameters_Data/paramScale_MonOm.csv")

grid_v1 <- read_csv("../Data/ABM_Parameters_Data/Grid_Param_supp1.csv")

df <- read_csv("../Data/ABM Supplement/supp1-slow_rollout/concatenated data/df_AS.csv")

```

##### dataAll
```{r}

dataAll <- df %>%
  select(Name, speed, vaccine_star, boost_shape, SAR, booster, scenario, boost, N, Inf_H, Inf_L, Dead_H, Dead_L, cum_cases_H, cum_cases_L, replicate, time, vaccinatedH,vaccinatedL, boostedH, boostedL) %>%
  #pivot_longer(count_Naive:count_Vaccine_boost, names_to = "history_types", values_to = "history_counts") %>%
  select(Name, speed, vaccine_star, boost_shape, SAR, booster, scenario, boost, N, Inf_H, Inf_L, Dead_H, Dead_L, cum_cases_H, cum_cases_L, replicate, time, vaccinatedH, vaccinatedL, boostedH, boostedL) %>% #count_Naive:count_Vaccine_boost) %>%
  mutate(country = Name, 
         time = as.integer(time), 
         infections_over_time = Inf_L+Inf_H, 
         infections_perc_over_time = 100*(Inf_L+Inf_H)/N,
         deaths_over_time = Dead_L + Dead_H, 
         deaths_perc_over_time = 100*(Dead_L + Dead_H)/N,
         cum_sum_Inf = cum_cases_H+cum_cases_L,
         cum_sum_per_N = (cum_cases_H + cum_cases_L)/N,
         boosted_over_time = boostedH+boostedL,
         boosted_perc_over_time = 100*(boostedH + boostedL)/N,
         vaccinated_over_time = vaccinatedH+vaccinatedL,
         vaccinated_perc_over_time = 100*(vaccinatedH + vaccinatedL)/N) %>%
  group_by(scenario, speed, vaccine_star, boost_shape, SAR, booster, boost, country, replicate) %>%
  mutate(ID_runs = cur_group_id()) %>% ungroup() %>%
  # select(ID_runs, speed, SAR, scenario, vaccine_star, boost_shape, booster, boost, country,
  #        replicate, time, N, infections_over_time:cum_sum_Inf, vaccinated, boosted) %>%
  #mutate(history_types = gsub("count_", "", history_types)) %>%
  #mutate(dummy = NULL) %>%
  arrange(ID_runs) %>%
  #filter(seed_WT == "yes") %>%
  select(-ID_runs) %>% filter(!is.na(time)) %>%
  group_by(SAR, scenario, speed,vaccine_star, boost_shape,booster,boost,country,replicate) %>%
  mutate(ID_runs = cur_group_id()) %>% ungroup() #%>%
  #select(SAR, speed, replicate,scenario,vaccine_star, boost_shape,booster,boost,country,time:cum_sum_Inf, vaccinated, boosted)

write_csv(dataAll, "../Data/ABM Supplement/supp1-slow_rollout/dataAll.csv")
```


### ABM Supp 2: vaccinate through omicron*
#### Supplement Grid 2

```{r}

b <- c(1)#, 300/90)
SAR <- c(1.3*0.427)#c(0.427) ##, 0.512)
w  <- 1/300
scenario <- c("penalty", "WTpenalty","Ompenalty")
booster <- c("Bivalent", "Monovalent")
vaccine_star <- c("yes")
boost_shape <- c("functional")
speed <- c("fast")

## scale level of protection against infection relative to protection against severity
inf_vs_sev <- c(0.8)

age_wt <- read_csv("../Data/ABM_Parameters_Data/age_table.csv") %>%
  rename(age = 1, Ecuador = 2, India = 3, Malaysia = 4) %>%
  pivot_longer(2:4, names_to = "Name", values_to = "count") %>%
  ## mutate(count = if_else(Name == "India", count/(10^6),count/(10^6))) %>%
  mutate(count = as.integer(count)) %>%
  pivot_wider(names_from = age, values_from = "count") %>%
  rename(child = 2, adult = 3, old = 4) %>% 
  mutate(child = child/Total, adult = adult/Total, old=old/Total)

contact <- read_excel("../Data/ABM_Parameters_Data/ContactRates_AgeCountry.xlsx") %>% 
  mutate(indices = 1:17) %>%
  mutate(Name = case_when(
    indices <=6 ~ "India",
    indices >6 & indices <= 12 ~ "Ecuador",
    indices >12 ~ "Malaysia"
  )) %>% 
  select(age = 1, child = 2, adult = 3, old = 4, Name) %>% 
  mutate(child = as.numeric(child), adult = as.numeric(adult), old = as.numeric(old)) %>%
  filter(!is.na(child)) %>% 
  mutate(tot = child + adult + old) %>% 
  select(Name, age, tot) %>% 
  pivot_wider(names_from = age, values_from = tot) %>% 
  # read_excel("../../../Parametrization Data/Contacts/Contact_Reformat.xlsx") %>%
  mutate(contact_total = 0.25*(child*age_wt$child + adult*age_wt$adult + elderly*age_wt$old)) %>%
  group_by(Name) %>%
  summarise(c_LL = 0.7*0.6*contact_total, c_LH = 0.7*0.4*contact_total, 
            c_HH = 0.4*0.6*contact_total, c_HL = 0.4*0.4*contact_total) %>%
  ungroup()


df <- expand_grid(replicate=1:500, b = b, SAR=SAR, w =w, 
                  booster = booster, scenario = scenario,
                  inf_vs_sev = inf_vs_sev,
                  vaccine_star = vaccine_star,
                  boost_shape = boost_shape,
                  speed = speed
                  ) %>% 
  mutate(remove = case_when(
    booster == "Bivalent" & scenario == "WTpenalty" ~ "yes",
    booster == "Bivalent" & scenario == "Ompenalty" ~ "yes",
    booster == "Bivalent" & scenario == "WTefficacy"~ "yes",
    booster== "Bivalent" & scenario =="Omefficacy"~ "yes",
    booster == "Bivalent" & scenario =="WTendpoint" ~"yes",
    booster == "Bivalent" & scenario == "Omendpoint" ~ "yes",
    booster == "Monovalent" & scenario == "penalty" ~ "yes",
    booster == "Monovalent" & scenario == "efficacy" ~ "yes",
    booster == "Monovalent" & scenario == "endpoint" ~ "yes",
    .default = "no"
  )) %>% 
  filter(remove == "no")
  

test <- df%>%select(booster,scenario) %>%distinct()
  
  ## Rules: Want c_HH to have roughly 1 contact as the basis and then multiply by 0.2. Then 30% reduction in contact for low SES and 
  ## 60% for high SES. Assume 60% of contact is within group, 40% is out group. 
  
age <- read_csv("../Data/ABM_Parameters_Data/age_table.csv") %>%
  rename(age = 1, Ecuador = 2, India = 3, Malaysia = 4) %>%
  pivot_longer(2:4, names_to = "Name", values_to = "count") %>%
 ## mutate(count = if_else(Name == "India", count/(10^6),count/(10^6))) %>%
  mutate(count = as.integer(count)) %>%
  pivot_wider(names_from = age, values_from = "count") %>%
  rename(child = 2, adult = 3, old = 4) %>%
  mutate(child = as.integer(0.5*(10^5)*child/Total), ## CHANGE BACK TO 10^5
         adult = as.integer(0.5*(10^5)*adult/Total),
         old = as.integer(0.5*(10^5)*old/Total)) %>%
  ## check that pop is 500,000
  mutate(Total = child+adult+old) %>%
  mutate(Total = NULL)

paramsH <- read_csv("../Data/ABM_Parameters_Data/paramsTable.csv") %>% filter(Name %in% c("Malaysia", "India", "Ecuador")) %>% filter(SES == "H") %>%
  rename(MH = 3, WH = 4, hH = 5) %>%
  summarise(Name, MH, WH, hH)
paramsL <- read_csv("../Data/ABM_Parameters_Data/paramsTable.csv") %>% filter(Name %in% c("Malaysia", "India", "Ecuador")) %>% filter(SES == "L") %>%
  rename(ML = 3, WL = 4, hL = 5) %>%
  summarise(Name, ML, WL, hL) 
params <- inner_join(paramsH, paramsL)


## calculate booster proportions
## Pops: I: 1B, E: 17.5 m, M: 28.6 m
##Max booster: I: 227 m, E: 10.5 m, M: 17.1

## India: 
## 24.0% of the pop is children
## Based on original vaccines, of the boosted population, we expect 0.93/(0.93 + 0.78) = 0.54% are high SES and 0.78/(0.93+0.78) = 0.46% are low SES
## High SES: Vm = 0.93, 500m, leaves 465m high SES vaccinated, of which 353.4 are non-children -- boosters 227*0.54 = 122.58, 122.58/353.4 = 0.35 of vaccinated get a booster
## Low SES: Vm = 0.78, 500m, leaves 390m low SES vaccinated, of which 296.4 are non-children -- boosters 227*0.46 = 104.42, 104.42/296.4 = .35 of vaccinated get a booster

## Malaysia: 
## 21.5% of the pop is children
## 0.97/(0.97+0.72) = 0.57 and 0.72/(0.97+0.72) = 0.43
## High SES: Vm = 0.97, 14.3m, leaves 13.87 vaccinated of which 10.89 are eligible -- boosters 17.1*0.57 = 9.747, 9.747/10.89 = 0.90 of vaccinated gets boosted 
## Low SES: Vm = 0.72, 14.3m, leaves 10.30 vaccinated of which  8.09 eligible -- boosters 17.1*0.43 = 7.353, 7.353/8.09 = 0.91 of vaccinated get boosted

## Ecuador: 
## 23.6% is children
## 1, 0.79 -- 1/(1+0.79) = 0.56 and 0.44
## High SES: Vm = 1, 8.75m, leaves 8.75m vaccinated of which 6.685 eligible -- boosters 10.5*0.56 = 5.88, 5.88/6.685 = 0.88
## Low SES: Vm = 0.79, 8.75m, leaves 6.9125 vaccinated of which 5.281 eligible-- boosters 10.5*0.44 = 4.62, 4.62/5.281 = 0.87

## what the above numbers mean: of the eligible group (adults), X% gets vaccinated
## these are NOT total pop numbers

fullpar <- inner_join(params, age) %>% 
  mutate(MH_boost = case_when(
    Name == "India" ~ "0.35",
    Name == "Malaysia" ~ "0.90",
    Name == "Ecuador" ~ "0.88"
  ),
  ML_boost = case_when(
    Name == "India" ~ "0.35",
    Name == "Malaysia" ~ "0.91",
    Name == "Ecuador" ~ "0.87"
  )
  ,
 MH_boost = as.numeric(MH_boost),
         ML_boost = as.numeric(ML_boost)
  )


dfM <- df %>% mutate(Name = "Malaysia")
dfE <- df %>% mutate(Name = "Ecuador")
dfI <- df %>% mutate(Name = "India")


stringency <- read_excel("../Data/ABM_Parameters_Data/Stringency.xlsx")

df <- rbind(dfM, dfE) %>%
  rbind(dfI) %>%
  left_join(fullpar) %>%
  left_join(stringency %>% rename(Name = country)) %>%
  arrange(replicate) %>% 
  left_join(contact) %>%
  add_column(variant_test = "NA", .after = "string_om2")
##%>% filter(Name == "India")


serotypes_star <- read_csv("../Data/ABM_Parameters_Data/paramScale_MonOm.csv") %>% 
  select(history, Bivalent_penalty, Bivalent_efficacy, Bivalent_endpoint, 
         Monovalent_WTpenalty,Monovalent_Ompenalty, 
         Monovalent_WTefficacy, Monovalent_Omefficacy,
         Monovalent_WTendpoint, Monovalent_Omendpoint) %>% 
  pivot_longer(Bivalent_penalty:Monovalent_Omendpoint, names_to = "names", values_to = "values") %>% 
  separate(names, into = c("booster", "scenario"), sep = "_") %>%
  filter(!is.na(values)) %>%
  pivot_wider(names_from = history, values_from = values)
  

serotypes_Omicron <- read_csv("../Data/ABM_Parameters_Data/paramScale_MonOm.csv") %>% 
  select(history, Bivalent_penalty_Omicron, Bivalent_efficacy_Omicron, Bivalent_endpoint_Omicron, 
         Monovalent_WTpenalty_Omicron,Monovalent_Ompenalty_Omicron, 
         Monovalent_WTefficacy_Omicron, Monovalent_Omefficacy_Omicron,
         Monovalent_WTendpoint_Omicron, Monovalent_Omendpoint_Omicron) %>% 
  pivot_longer(Bivalent_penalty_Omicron:Monovalent_Omendpoint_Omicron, names_to = "names", values_to = "values") %>% 
  separate(names, into = c("booster", "scenario"), sep = "_") %>%
  filter(!is.na(values)) %>%
  pivot_wider(names_from = history, values_from = values) %>%
  rename(Delta_vaccine_Om = Delta_vaccine,
         Omicron_star_vaccine_Om = Omicron_star_vaccine,
         Omicron_vaccine_Om = Omicron_vaccine,
         Vaccine_Om = Vaccine,
         WT_vaccine_Om = WT_vaccine)

serotypes <- left_join(serotypes_star, serotypes_Omicron, by = c("booster","scenario")) 

df_everything <- left_join(df, serotypes, by = c("booster","scenario")) %>%
  mutate(boost = "yes")

df_everything <- df_everything %>%
  mutate(
    WH_boost = case_when(
      speed == "slow" ~ WH,
      speed== "fast" ~ WH - 10
    ),
    WL_boost = case_when(
      speed == "slow" ~ WL,
      speed== "fast" ~ WL - 10
    )
  )

##### make no booster scenario #######

df_noboost <- df_everything %>% 
  filter(scenario == "WTpenalty", booster == "Monovalent", boost_shape == "functional", speed == "fast") %>% 
  mutate(scenario = "no booster", booster = "no booster", boost_shape = "no booster", speed = "no booster") %>% 
  mutate(boost = "no")
  
df_everything <- rbind(df_everything, df_noboost) %>% arrange(replicate) %>%
  filter(boost_shape == "functional" | boost_shape== "no booster") %>%
  arrange(replicate)

test <- df_everything %>% filter(scenario == "no booster")

##### get non-child proportions #####

nonchild <- age_wt %>% 
  group_by(Name) %>%
  summarise(nonchild = 1-child) %>% 
  ungroup()

df_everything <- df_everything %>% 
  left_join(nonchild)

## filter
df_everything <- df_everything %>% 
  filter(scenario %in% c("no booster", "WTpenalty", "Ompenalty", "penalty"))

## extra filter

# df_everything <- df_everything %>% 
#   filter(scenario =="no booster", Name == "Malaysia")

write_csv(df_everything, "../Data/ABM_Parameters_Data/Grid_Param_supp2.csv")

```

#### Concatenate replicates
##### Read files AS

```{r message=FALSE}
fileNames <- list.files(path="../Data/ABM Supplement/supp2-vaccine_star/output_files_AS", 
                     pattern=".csv", all.files=TRUE,full.names=TRUE)

grid_v1 <- read_csv("../Data/ABM_Parameters_Data/Grid_Param_supp2.csv") %>%
  mutate(indexID = row_number())

df_info_v1 <- tibble(fileNames = fileNames) %>% 
  mutate(indexID = str_remove(fileNames, "../Data/ABM Supplement/supp2-vaccine_star/output_files_AS/output_1x_ID_")) %>%
  mutate(indexID = str_remove(indexID, ".csv")) %>%
  mutate(indexID = parse_number(indexID)) %>% right_join(grid_v1) %>% filter(!is.na(fileNames))

df_v1 <- df_info_v1$fileNames %>% map_dfr(read_csv)

df_v1 <- df_v1 %>% select(-`...1`) %>%
  right_join(grid_v1)

write_csv(df_v1, "../Data/ABM Supplement/supp2-vaccine_star/concatenated data/df_AS.csv")
```

#### Make files for figures
##### Load data
```{r}

#### Load data ####

serotypes <- read_csv("../Data/ABM_Parameters_Data/paramScale_MonOm.csv")

grid_v1 <- read_csv("../Data/ABM_Parameters_Data/Grid_Param_supp2.csv")

df <- read_csv("../Data/ABM Supplement/supp2-vaccine_star/concatenated data/df_AS.csv")

```

##### dataAll
```{r}

dataAll <- df %>%
  select(Name, speed, vaccine_star, boost_shape, SAR, booster, scenario, boost, N, Inf_H, Inf_L, Dead_H, Dead_L, cum_cases_H, cum_cases_L, replicate, time, vaccinatedH,vaccinatedL, boostedH, boostedL) %>%
  #pivot_longer(count_Naive:count_Vaccine_boost, names_to = "history_types", values_to = "history_counts") %>%
  select(Name, speed, vaccine_star, boost_shape, SAR, booster, scenario, boost, N, Inf_H, Inf_L, Dead_H, Dead_L, cum_cases_H, cum_cases_L, replicate, time, vaccinatedH, vaccinatedL, boostedH, boostedL) %>% #count_Naive:count_Vaccine_boost) %>%
  mutate(country = Name, 
         time = as.integer(time), 
         infections_over_time = Inf_L+Inf_H, 
         infections_perc_over_time = 100*(Inf_L+Inf_H)/N,
         deaths_over_time = Dead_L + Dead_H, 
         deaths_perc_over_time = 100*(Dead_L + Dead_H)/N,
         cum_sum_Inf = cum_cases_H+cum_cases_L,
         cum_sum_per_N = (cum_cases_H + cum_cases_L)/N,
         boosted_over_time = boostedH+boostedL,
         boosted_perc_over_time = 100*(boostedH + boostedL)/N,
         vaccinated_over_time = vaccinatedH+vaccinatedL,
         vaccinated_perc_over_time = 100*(vaccinatedH + vaccinatedL)/N) %>%
  group_by(scenario, speed, vaccine_star, boost_shape, SAR, booster, boost, country, replicate) %>%
  mutate(ID_runs = cur_group_id()) %>% ungroup() %>%
  # select(ID_runs, speed, SAR, scenario, vaccine_star, boost_shape, booster, boost, country,
  #        replicate, time, N, infections_over_time:cum_sum_Inf, vaccinated, boosted) %>%
  #mutate(history_types = gsub("count_", "", history_types)) %>%
  #mutate(dummy = NULL) %>%
  arrange(ID_runs) %>%
  #filter(seed_WT == "yes") %>%
  select(-ID_runs) %>% filter(!is.na(time)) %>%
  group_by(SAR, scenario, speed,vaccine_star, boost_shape,booster,boost,country,replicate) %>%
  mutate(ID_runs = cur_group_id()) %>% ungroup() #%>%
  #select(SAR, speed, replicate,scenario,vaccine_star, boost_shape,booster,boost,country,time:cum_sum_Inf, vaccinated, boosted)

write_csv(dataAll, "../Data/ABM Supplement/supp2-vaccine_star/dataAll.csv")
```

### ABM Supp 3: same efficacy
#### Supplement Grid 3

```{r}

b <- c(1)#, 300/90)
SAR <- c(1.3*0.427)#c(0.427) ##, 0.512)
w  <- 1/300
scenario <- c("efficacy", "WTefficacy","Omefficacy")
booster <- c("Bivalent", "Monovalent")
vaccine_star <- c("no")
boost_shape <- c("functional")
speed <- c("fast")

## scale level of protection against infection relative to protection against severity
inf_vs_sev <- c(0.8)

age_wt <- read_csv("../Data/ABM_Parameters_Data/age_table.csv") %>%
  rename(age = 1, Ecuador = 2, India = 3, Malaysia = 4) %>%
  pivot_longer(2:4, names_to = "Name", values_to = "count") %>%
  ## mutate(count = if_else(Name == "India", count/(10^6),count/(10^6))) %>%
  mutate(count = as.integer(count)) %>%
  pivot_wider(names_from = age, values_from = "count") %>%
  rename(child = 2, adult = 3, old = 4) %>% 
  mutate(child = child/Total, adult = adult/Total, old=old/Total)

contact <- read_excel("../Data/ABM_Parameters_Data/ContactRates_AgeCountry.xlsx") %>% 
  mutate(indices = 1:17) %>%
  mutate(Name = case_when(
    indices <=6 ~ "India",
    indices >6 & indices <= 12 ~ "Ecuador",
    indices >12 ~ "Malaysia"
  )) %>% 
  select(age = 1, child = 2, adult = 3, old = 4, Name) %>% 
  mutate(child = as.numeric(child), adult = as.numeric(adult), old = as.numeric(old)) %>%
  filter(!is.na(child)) %>% 
  mutate(tot = child + adult + old) %>% 
  select(Name, age, tot) %>% 
  pivot_wider(names_from = age, values_from = tot) %>% 
  # read_excel("../../../Parametrization Data/Contacts/Contact_Reformat.xlsx") %>%
  mutate(contact_total = 0.25*(child*age_wt$child + adult*age_wt$adult + elderly*age_wt$old)) %>%
  group_by(Name) %>%
  summarise(c_LL = 0.7*0.6*contact_total, c_LH = 0.7*0.4*contact_total, 
            c_HH = 0.4*0.6*contact_total, c_HL = 0.4*0.4*contact_total) %>%
  ungroup()


df <- expand_grid(replicate=1:500, b = b, SAR=SAR, w =w, 
                  booster = booster, scenario = scenario,
                  inf_vs_sev = inf_vs_sev,
                  vaccine_star = vaccine_star,
                  boost_shape = boost_shape,
                  speed = speed
                  ) %>% 
  mutate(remove = case_when(
    booster == "Bivalent" & scenario == "WTpenalty" ~ "yes",
    booster == "Bivalent" & scenario == "Ompenalty" ~ "yes",
    booster == "Bivalent" & scenario == "WTefficacy"~ "yes",
    booster== "Bivalent" & scenario =="Omefficacy"~ "yes",
    booster == "Bivalent" & scenario =="WTendpoint" ~"yes",
    booster == "Bivalent" & scenario == "Omendpoint" ~ "yes",
    booster == "Monovalent" & scenario == "penalty" ~ "yes",
    booster == "Monovalent" & scenario == "efficacy" ~ "yes",
    booster == "Monovalent" & scenario == "endpoint" ~ "yes",
    .default = "no"
  )) %>% 
  filter(remove == "no")
  

test <- df%>%select(booster,scenario) %>%distinct()
  
  ## Rules: Want c_HH to have roughly 1 contact as the basis and then multiply by 0.2. Then 30% reduction in contact for low SES and 
  ## 60% for high SES. Assume 60% of contact is within group, 40% is out group. 
  
age <- read_csv("../Data/ABM_Parameters_Data/age_table.csv") %>%
  rename(age = 1, Ecuador = 2, India = 3, Malaysia = 4) %>%
  pivot_longer(2:4, names_to = "Name", values_to = "count") %>%
 ## mutate(count = if_else(Name == "India", count/(10^6),count/(10^6))) %>%
  mutate(count = as.integer(count)) %>%
  pivot_wider(names_from = age, values_from = "count") %>%
  rename(child = 2, adult = 3, old = 4) %>%
  mutate(child = as.integer(0.5*(10^5)*child/Total), ## CHANGE BACK TO 10^5
         adult = as.integer(0.5*(10^5)*adult/Total),
         old = as.integer(0.5*(10^5)*old/Total)) %>%
  ## check that pop is 500,000
  mutate(Total = child+adult+old) %>%
  mutate(Total = NULL)

paramsH <- read_csv("../Data/ABM_Parameters_Data/paramsTable.csv") %>% filter(Name %in% c("Malaysia", "India", "Ecuador")) %>% filter(SES == "H") %>%
  rename(MH = 3, WH = 4, hH = 5) %>%
  summarise(Name, MH, WH, hH)
paramsL <- read_csv("../Data/ABM_Parameters_Data/paramsTable.csv") %>% filter(Name %in% c("Malaysia", "India", "Ecuador")) %>% filter(SES == "L") %>%
  rename(ML = 3, WL = 4, hL = 5) %>%
  summarise(Name, ML, WL, hL) 
params <- inner_join(paramsH, paramsL)


## calculate booster proportions
## Pops: I: 1B, E: 17.5 m, M: 28.6 m
##Max booster: I: 227 m, E: 10.5 m, M: 17.1

## India: 
## 24.0% of the pop is children
## Based on original vaccines, of the boosted population, we expect 0.93/(0.93 + 0.78) = 0.54% are high SES and 0.78/(0.93+0.78) = 0.46% are low SES
## High SES: Vm = 0.93, 500m, leaves 465m high SES vaccinated, of which 353.4 are non-children -- boosters 227*0.54 = 122.58, 122.58/353.4 = 0.35 of vaccinated get a booster
## Low SES: Vm = 0.78, 500m, leaves 390m low SES vaccinated, of which 296.4 are non-children -- boosters 227*0.46 = 104.42, 104.42/296.4 = .35 of vaccinated get a booster

## Malaysia: 
## 21.5% of the pop is children
## 0.97/(0.97+0.72) = 0.57 and 0.72/(0.97+0.72) = 0.43
## High SES: Vm = 0.97, 14.3m, leaves 13.87 vaccinated of which 10.89 are eligible -- boosters 17.1*0.57 = 9.747, 9.747/10.89 = 0.90 of vaccinated gets boosted 
## Low SES: Vm = 0.72, 14.3m, leaves 10.30 vaccinated of which  8.09 eligible -- boosters 17.1*0.43 = 7.353, 7.353/8.09 = 0.91 of vaccinated get boosted

## Ecuador: 
## 23.6% is children
## 1, 0.79 -- 1/(1+0.79) = 0.56 and 0.44
## High SES: Vm = 1, 8.75m, leaves 8.75m vaccinated of which 6.685 eligible -- boosters 10.5*0.56 = 5.88, 5.88/6.685 = 0.88
## Low SES: Vm = 0.79, 8.75m, leaves 6.9125 vaccinated of which 5.281 eligible-- boosters 10.5*0.44 = 4.62, 4.62/5.281 = 0.87

## what the above numbers mean: of the eligible group (adults), X% gets vaccinated
## these are NOT total pop numbers

fullpar <- inner_join(params, age) %>% 
  mutate(MH_boost = case_when(
    Name == "India" ~ "0.35",
    Name == "Malaysia" ~ "0.90",
    Name == "Ecuador" ~ "0.88"
  ),
  ML_boost = case_when(
    Name == "India" ~ "0.35",
    Name == "Malaysia" ~ "0.91",
    Name == "Ecuador" ~ "0.87"
  )
  ,
 MH_boost = as.numeric(MH_boost),
         ML_boost = as.numeric(ML_boost)
  )


dfM <- df %>% mutate(Name = "Malaysia")
dfE <- df %>% mutate(Name = "Ecuador")
dfI <- df %>% mutate(Name = "India")


stringency <- read_excel("../Data/ABM_Parameters_Data/Stringency.xlsx")

df <- rbind(dfM, dfE) %>%
  rbind(dfI) %>%
  left_join(fullpar) %>%
  left_join(stringency %>% rename(Name = country)) %>%
  arrange(replicate) %>% 
  left_join(contact) %>%
  add_column(variant_test = "NA", .after = "string_om2")
##%>% filter(Name == "India")


serotypes_star <- read_csv("../Data/ABM_Parameters_Data/paramScale_MonOm.csv") %>% 
  select(history, Bivalent_penalty, Bivalent_efficacy, Bivalent_endpoint, 
         Monovalent_WTpenalty,Monovalent_Ompenalty, 
         Monovalent_WTefficacy, Monovalent_Omefficacy,
         Monovalent_WTendpoint, Monovalent_Omendpoint) %>% 
  pivot_longer(Bivalent_penalty:Monovalent_Omendpoint, names_to = "names", values_to = "values") %>% 
  separate(names, into = c("booster", "scenario"), sep = "_") %>%
  filter(!is.na(values)) %>%
  pivot_wider(names_from = history, values_from = values)
  

serotypes_Omicron <- read_csv("../Data/ABM_Parameters_Data/paramScale_MonOm.csv") %>% 
  select(history, Bivalent_penalty_Omicron, Bivalent_efficacy_Omicron, Bivalent_endpoint_Omicron, 
         Monovalent_WTpenalty_Omicron,Monovalent_Ompenalty_Omicron, 
         Monovalent_WTefficacy_Omicron, Monovalent_Omefficacy_Omicron,
         Monovalent_WTendpoint_Omicron, Monovalent_Omendpoint_Omicron) %>% 
  pivot_longer(Bivalent_penalty_Omicron:Monovalent_Omendpoint_Omicron, names_to = "names", values_to = "values") %>% 
  separate(names, into = c("booster", "scenario"), sep = "_") %>%
  filter(!is.na(values)) %>%
  pivot_wider(names_from = history, values_from = values) %>%
  rename(Delta_vaccine_Om = Delta_vaccine,
         Omicron_star_vaccine_Om = Omicron_star_vaccine,
         Omicron_vaccine_Om = Omicron_vaccine,
         Vaccine_Om = Vaccine,
         WT_vaccine_Om = WT_vaccine)

serotypes <- left_join(serotypes_star, serotypes_Omicron, by = c("booster","scenario")) 

df_everything <- left_join(df, serotypes, by = c("booster","scenario")) %>%
  mutate(boost = "yes")

df_everything <- df_everything %>%
  mutate(
    WH_boost = case_when(
      speed == "slow" ~ WH,
      speed== "fast" ~ WH - 10
    ),
    WL_boost = case_when(
      speed == "slow" ~ WL,
      speed== "fast" ~ WL - 10
    )
  )

##### make no booster scenario #######

df_noboost <- df_everything %>% 
  filter(scenario == "WTefficacy", booster == "Monovalent", boost_shape == "functional", speed == "fast") %>% 
  mutate(scenario = "no booster", booster = "no booster", boost_shape = "no booster", speed = "no booster") %>% 
  mutate(boost = "no")
  
df_everything <- rbind(df_everything, df_noboost) %>% arrange(replicate) %>%
  filter(boost_shape == "functional" | boost_shape== "no booster") %>%
  arrange(replicate)

test <- df_everything %>% filter(scenario == "no booster")

##### get non-child proportions #####

nonchild <- age_wt %>% 
  group_by(Name) %>%
  summarise(nonchild = 1-child) %>% 
  ungroup()

df_everything <- df_everything %>% 
  left_join(nonchild)

## filter
df_everything <- df_everything %>% 
  filter(scenario %in% c("no booster", "WTefficacy", "Omefficacy", "efficacy"))

## extra filter

# df_everything <- df_everything %>% 
#   filter(scenario =="no booster", Name == "Malaysia")

write_csv(df_everything, "../Data/ABM_Parameters_Data/Grid_Param_supp3.csv")

```


#### Concatenate replicates
##### Read files AS

```{r message=FALSE}
fileNames <- list.files(path="../Data/ABM Supplement/supp3-same_efficacy/output_files_AS", 
                     pattern=".csv", all.files=TRUE,full.names=TRUE)

grid_v1 <- read_csv("../Data/ABM_Parameters_Data/Grid_Param_supp3.csv") %>%
  mutate(indexID = row_number())

df_info_v1 <- tibble(fileNames = fileNames) %>% 
  mutate(indexID = str_remove(fileNames, "../Data/ABM Supplement/supp3-same_efficacy/output_files_AS/output_1x_ID_")) %>%
  mutate(indexID = str_remove(indexID, ".csv")) %>%
  mutate(indexID = parse_number(indexID)) %>% right_join(grid_v1) %>% filter(!is.na(fileNames))

df_v1 <- df_info_v1$fileNames %>% map_dfr(read_csv)

df_v1 <- df_v1 %>% select(-`...1`) %>%
  right_join(grid_v1)

write_csv(df_v1, "../Data/ABM Supplement/supp3-same_efficacy/concatenated data/df_AS.csv")
```


#### Make files for figures
##### Load data
```{r}

#### Load data ####

serotypes <- read_csv("../Data/ABM_Parameters_Data/paramScale_MonOm.csv")

grid_v1 <- read_csv("../Data/ABM_Parameters_Data/Grid_Param_supp3.csv")

df <- read_csv("../Data/ABM Supplement/supp3-same_efficacy/concatenated data/df_AS.csv")

```

##### dataAll
```{r}

dataAll <- df %>%
  select(Name, speed, vaccine_star, boost_shape, SAR, booster, scenario, boost, N, Inf_H, Inf_L, Dead_H, Dead_L, cum_cases_H, cum_cases_L, replicate, time, vaccinatedH,vaccinatedL, boostedH, boostedL) %>%
  #pivot_longer(count_Naive:count_Vaccine_boost, names_to = "history_types", values_to = "history_counts") %>%
  select(Name, speed, vaccine_star, boost_shape, SAR, booster, scenario, boost, N, Inf_H, Inf_L, Dead_H, Dead_L, cum_cases_H, cum_cases_L, replicate, time, vaccinatedH, vaccinatedL, boostedH, boostedL) %>% #count_Naive:count_Vaccine_boost) %>%
  mutate(country = Name, 
         time = as.integer(time), 
         infections_over_time = Inf_L+Inf_H, 
         infections_perc_over_time = 100*(Inf_L+Inf_H)/N,
         deaths_over_time = Dead_L + Dead_H, 
         deaths_perc_over_time = 100*(Dead_L + Dead_H)/N,
         cum_sum_Inf = cum_cases_H+cum_cases_L,
         cum_sum_per_N = (cum_cases_H + cum_cases_L)/N,
         boosted_over_time = boostedH+boostedL,
         boosted_perc_over_time = 100*(boostedH + boostedL)/N,
         vaccinated_over_time = vaccinatedH+vaccinatedL,
         vaccinated_perc_over_time = 100*(vaccinatedH + vaccinatedL)/N) %>%
  group_by(scenario, speed, vaccine_star, boost_shape, SAR, booster, boost, country, replicate) %>%
  mutate(ID_runs = cur_group_id()) %>% ungroup() %>%
  # select(ID_runs, speed, SAR, scenario, vaccine_star, boost_shape, booster, boost, country,
  #        replicate, time, N, infections_over_time:cum_sum_Inf, vaccinated, boosted) %>%
  #mutate(history_types = gsub("count_", "", history_types)) %>%
  #mutate(dummy = NULL) %>%
  arrange(ID_runs) %>%
  #filter(seed_WT == "yes") %>%
  select(-ID_runs) %>% filter(!is.na(time)) %>%
  group_by(SAR, scenario, speed,vaccine_star, boost_shape,booster,boost,country,replicate) %>%
  mutate(ID_runs = cur_group_id()) %>% ungroup() #%>%
  #select(SAR, speed, replicate,scenario,vaccine_star, boost_shape,booster,boost,country,time:cum_sum_Inf, vaccinated, boosted)

write_csv(dataAll, "../Data/ABM Supplement/supp3-same_efficacy/dataAll.csv")
```


### ABM Supp 4: same endpoint
#### Supplement Grid 4

```{r}

b <- c(1)#, 300/90)
SAR <- c(1.3*0.427)#c(0.427) ##, 0.512)
w  <- 1/300
scenario <- c("endpoint", "WTendpoint","Omendpoint")
booster <- c("Bivalent", "Monovalent")
vaccine_star <- c("no")
boost_shape <- c("functional")
speed <- c("fast")

## scale level of protection against infection relative to protection against severity
inf_vs_sev <- c(0.8)

age_wt <- read_csv("../Data/ABM_Parameters_Data/age_table.csv") %>%
  rename(age = 1, Ecuador = 2, India = 3, Malaysia = 4) %>%
  pivot_longer(2:4, names_to = "Name", values_to = "count") %>%
  ## mutate(count = if_else(Name == "India", count/(10^6),count/(10^6))) %>%
  mutate(count = as.integer(count)) %>%
  pivot_wider(names_from = age, values_from = "count") %>%
  rename(child = 2, adult = 3, old = 4) %>% 
  mutate(child = child/Total, adult = adult/Total, old=old/Total)

contact <- read_excel("../Data/ABM_Parameters_Data/ContactRates_AgeCountry.xlsx") %>% 
  mutate(indices = 1:17) %>%
  mutate(Name = case_when(
    indices <=6 ~ "India",
    indices >6 & indices <= 12 ~ "Ecuador",
    indices >12 ~ "Malaysia"
  )) %>% 
  select(age = 1, child = 2, adult = 3, old = 4, Name) %>% 
  mutate(child = as.numeric(child), adult = as.numeric(adult), old = as.numeric(old)) %>%
  filter(!is.na(child)) %>% 
  mutate(tot = child + adult + old) %>% 
  select(Name, age, tot) %>% 
  pivot_wider(names_from = age, values_from = tot) %>% 
  # read_excel("../../../Parametrization Data/Contacts/Contact_Reformat.xlsx") %>%
  mutate(contact_total = 0.25*(child*age_wt$child + adult*age_wt$adult + elderly*age_wt$old)) %>%
  group_by(Name) %>%
  summarise(c_LL = 0.7*0.6*contact_total, c_LH = 0.7*0.4*contact_total, 
            c_HH = 0.4*0.6*contact_total, c_HL = 0.4*0.4*contact_total) %>%
  ungroup()


df <- expand_grid(replicate=1:500, b = b, SAR=SAR, w =w, 
                  booster = booster, scenario = scenario,
                  inf_vs_sev = inf_vs_sev,
                  vaccine_star = vaccine_star,
                  boost_shape = boost_shape,
                  speed = speed
                  ) %>% 
  mutate(remove = case_when(
    booster == "Bivalent" & scenario == "WTpenalty" ~ "yes",
    booster == "Bivalent" & scenario == "Ompenalty" ~ "yes",
    booster == "Bivalent" & scenario == "WTefficacy"~ "yes",
    booster== "Bivalent" & scenario =="Omefficacy"~ "yes",
    booster == "Bivalent" & scenario =="WTendpoint" ~"yes",
    booster == "Bivalent" & scenario == "Omendpoint" ~ "yes",
    booster == "Monovalent" & scenario == "penalty" ~ "yes",
    booster == "Monovalent" & scenario == "efficacy" ~ "yes",
    booster == "Monovalent" & scenario == "endpoint" ~ "yes",
    .default = "no"
  )) %>% 
  filter(remove == "no")
  

test <- df%>%select(booster,scenario) %>%distinct()
  
  ## Rules: Want c_HH to have roughly 1 contact as the basis and then multiply by 0.2. Then 30% reduction in contact for low SES and 
  ## 60% for high SES. Assume 60% of contact is within group, 40% is out group. 
  
age <- read_csv("../Data/ABM_Parameters_Data/age_table.csv") %>%
  rename(age = 1, Ecuador = 2, India = 3, Malaysia = 4) %>%
  pivot_longer(2:4, names_to = "Name", values_to = "count") %>%
 ## mutate(count = if_else(Name == "India", count/(10^6),count/(10^6))) %>%
  mutate(count = as.integer(count)) %>%
  pivot_wider(names_from = age, values_from = "count") %>%
  rename(child = 2, adult = 3, old = 4) %>%
  mutate(child = as.integer(0.5*(10^5)*child/Total), ## CHANGE BACK TO 10^5
         adult = as.integer(0.5*(10^5)*adult/Total),
         old = as.integer(0.5*(10^5)*old/Total)) %>%
  ## check that pop is 500,000
  mutate(Total = child+adult+old) %>%
  mutate(Total = NULL)

paramsH <- read_csv("../Data/ABM_Parameters_Data/paramsTable.csv") %>% filter(Name %in% c("Malaysia", "India", "Ecuador")) %>% filter(SES == "H") %>%
  rename(MH = 3, WH = 4, hH = 5) %>%
  summarise(Name, MH, WH, hH)
paramsL <- read_csv("../Data/ABM_Parameters_Data/paramsTable.csv") %>% filter(Name %in% c("Malaysia", "India", "Ecuador")) %>% filter(SES == "L") %>%
  rename(ML = 3, WL = 4, hL = 5) %>%
  summarise(Name, ML, WL, hL) 
params <- inner_join(paramsH, paramsL)


## calculate booster proportions
## Pops: I: 1B, E: 17.5 m, M: 28.6 m
##Max booster: I: 227 m, E: 10.5 m, M: 17.1

## India: 
## 24.0% of the pop is children
## Based on original vaccines, of the boosted population, we expect 0.93/(0.93 + 0.78) = 0.54% are high SES and 0.78/(0.93+0.78) = 0.46% are low SES
## High SES: Vm = 0.93, 500m, leaves 465m high SES vaccinated, of which 353.4 are non-children -- boosters 227*0.54 = 122.58, 122.58/353.4 = 0.35 of vaccinated get a booster
## Low SES: Vm = 0.78, 500m, leaves 390m low SES vaccinated, of which 296.4 are non-children -- boosters 227*0.46 = 104.42, 104.42/296.4 = .35 of vaccinated get a booster

## Malaysia: 
## 21.5% of the pop is children
## 0.97/(0.97+0.72) = 0.57 and 0.72/(0.97+0.72) = 0.43
## High SES: Vm = 0.97, 14.3m, leaves 13.87 vaccinated of which 10.89 are eligible -- boosters 17.1*0.57 = 9.747, 9.747/10.89 = 0.90 of vaccinated gets boosted 
## Low SES: Vm = 0.72, 14.3m, leaves 10.30 vaccinated of which  8.09 eligible -- boosters 17.1*0.43 = 7.353, 7.353/8.09 = 0.91 of vaccinated get boosted

## Ecuador: 
## 23.6% is children
## 1, 0.79 -- 1/(1+0.79) = 0.56 and 0.44
## High SES: Vm = 1, 8.75m, leaves 8.75m vaccinated of which 6.685 eligible -- boosters 10.5*0.56 = 5.88, 5.88/6.685 = 0.88
## Low SES: Vm = 0.79, 8.75m, leaves 6.9125 vaccinated of which 5.281 eligible-- boosters 10.5*0.44 = 4.62, 4.62/5.281 = 0.87

## what the above numbers mean: of the eligible group (adults), X% gets vaccinated
## these are NOT total pop numbers

fullpar <- inner_join(params, age) %>% 
  mutate(MH_boost = case_when(
    Name == "India" ~ "0.35",
    Name == "Malaysia" ~ "0.90",
    Name == "Ecuador" ~ "0.88"
  ),
  ML_boost = case_when(
    Name == "India" ~ "0.35",
    Name == "Malaysia" ~ "0.91",
    Name == "Ecuador" ~ "0.87"
  )
  ,
 MH_boost = as.numeric(MH_boost),
         ML_boost = as.numeric(ML_boost)
  )


dfM <- df %>% mutate(Name = "Malaysia")
dfE <- df %>% mutate(Name = "Ecuador")
dfI <- df %>% mutate(Name = "India")


stringency <- read_excel("../Data/ABM_Parameters_Data/Stringency.xlsx")

df <- rbind(dfM, dfE) %>%
  rbind(dfI) %>%
  left_join(fullpar) %>%
  left_join(stringency %>% rename(Name = country)) %>%
  arrange(replicate) %>% 
  left_join(contact) %>%
  add_column(variant_test = "NA", .after = "string_om2")
##%>% filter(Name == "India")


serotypes_star <- read_csv("../Data/ABM_Parameters_Data/paramScale_MonOm.csv") %>% 
  select(history, Bivalent_penalty, Bivalent_efficacy, Bivalent_endpoint, 
         Monovalent_WTpenalty,Monovalent_Ompenalty, 
         Monovalent_WTefficacy, Monovalent_Omefficacy,
         Monovalent_WTendpoint, Monovalent_Omendpoint) %>% 
  pivot_longer(Bivalent_penalty:Monovalent_Omendpoint, names_to = "names", values_to = "values") %>% 
  separate(names, into = c("booster", "scenario"), sep = "_") %>%
  filter(!is.na(values)) %>%
  pivot_wider(names_from = history, values_from = values)
  

serotypes_Omicron <- read_csv("../Data/ABM_Parameters_Data/paramScale_MonOm.csv") %>% 
  select(history, Bivalent_penalty_Omicron, Bivalent_efficacy_Omicron, Bivalent_endpoint_Omicron, 
         Monovalent_WTpenalty_Omicron,Monovalent_Ompenalty_Omicron, 
         Monovalent_WTefficacy_Omicron, Monovalent_Omefficacy_Omicron,
         Monovalent_WTendpoint_Omicron, Monovalent_Omendpoint_Omicron) %>% 
  pivot_longer(Bivalent_penalty_Omicron:Monovalent_Omendpoint_Omicron, names_to = "names", values_to = "values") %>% 
  separate(names, into = c("booster", "scenario"), sep = "_") %>%
  filter(!is.na(values)) %>%
  pivot_wider(names_from = history, values_from = values) %>%
  rename(Delta_vaccine_Om = Delta_vaccine,
         Omicron_star_vaccine_Om = Omicron_star_vaccine,
         Omicron_vaccine_Om = Omicron_vaccine,
         Vaccine_Om = Vaccine,
         WT_vaccine_Om = WT_vaccine)

serotypes <- left_join(serotypes_star, serotypes_Omicron, by = c("booster","scenario")) 

df_everything <- left_join(df, serotypes, by = c("booster","scenario")) %>%
  mutate(boost = "yes")

df_everything <- df_everything %>%
  mutate(
    WH_boost = case_when(
      speed == "slow" ~ WH,
      speed== "fast" ~ WH - 10
    ),
    WL_boost = case_when(
      speed == "slow" ~ WL,
      speed== "fast" ~ WL - 10
    )
  )

##### make no booster scenario #######

df_noboost <- df_everything %>% 
  filter(scenario == "WTendpoint", booster == "Monovalent", boost_shape == "functional", speed == "fast") %>% 
  mutate(scenario = "no booster", booster = "no booster", boost_shape = "no booster", speed = "no booster") %>% 
  mutate(boost = "no")
  
df_everything <- rbind(df_everything, df_noboost) %>% arrange(replicate) %>%
  filter(boost_shape == "functional" | boost_shape== "no booster") %>%
  arrange(replicate)

test <- df_everything %>% filter(scenario == "no booster")

##### get non-child proportions #####

nonchild <- age_wt %>% 
  group_by(Name) %>%
  summarise(nonchild = 1-child) %>% 
  ungroup()

df_everything <- df_everything %>% 
  left_join(nonchild)

## filter
df_everything <- df_everything %>% 
  filter(scenario %in% c("no booster", "WTendpoint", "Omendpoint", "endpoint"))

## extra filter

# df_everything <- df_everything %>% 
#   filter(scenario =="no booster", Name == "Malaysia")

write_csv(df_everything, "../Data/ABM_Parameters_Data/Grid_Param_supp4.csv")

```

#### Concatenate replicates
##### Read files AS

```{r message=FALSE}
fileNames <- list.files(path="../Data/ABM Supplement/supp4-same_endpoint/output_files_AS", 
                     pattern=".csv", all.files=TRUE,full.names=TRUE)

grid_v1 <- read_csv("../Data/ABM_Parameters_Data/Grid_Param_supp4.csv") %>%
  mutate(indexID = row_number())

df_info_v1 <- tibble(fileNames = fileNames) %>% 
  mutate(indexID = str_remove(fileNames, "../Data/ABM Supplement/supp4-same_endpoint/output_files_AS/output_1x_ID_")) %>%
  mutate(indexID = str_remove(indexID, ".csv")) %>%
  mutate(indexID = parse_number(indexID)) %>% right_join(grid_v1) %>% filter(!is.na(fileNames))

df_v1 <- df_info_v1$fileNames %>% map_dfr(read_csv)

df_v1 <- df_v1 %>% select(-`...1`) %>%
  right_join(grid_v1)

write_csv(df_v1, "../Data/ABM Supplement/supp4-same_endpoint/concatenated data/df_AS.csv")
```


#### Make files for figures
##### Load data
```{r}

#### Load data ####

serotypes <- read_csv("../Data/ABM_Parameters_Data/paramScale_MonOm.csv")

grid_v1 <- read_csv("../Data/ABM_Parameters_Data/Grid_Param_supp4.csv")

df <- read_csv("../Data/ABM Supplement/supp4-same_endpoint/concatenated data/df_AS.csv")

```

##### dataAll
```{r}

dataAll <- df %>%
  select(Name, speed, vaccine_star, boost_shape, SAR, booster, scenario, boost, N, Inf_H, Inf_L, Dead_H, Dead_L, cum_cases_H, cum_cases_L, replicate, time, vaccinatedH,vaccinatedL, boostedH, boostedL) %>%
  #pivot_longer(count_Naive:count_Vaccine_boost, names_to = "history_types", values_to = "history_counts") %>%
  select(Name, speed, vaccine_star, boost_shape, SAR, booster, scenario, boost, N, Inf_H, Inf_L, Dead_H, Dead_L, cum_cases_H, cum_cases_L, replicate, time, vaccinatedH, vaccinatedL, boostedH, boostedL) %>% #count_Naive:count_Vaccine_boost) %>%
  mutate(country = Name, 
         time = as.integer(time), 
         infections_over_time = Inf_L+Inf_H, 
         infections_perc_over_time = 100*(Inf_L+Inf_H)/N,
         deaths_over_time = Dead_L + Dead_H, 
         deaths_perc_over_time = 100*(Dead_L + Dead_H)/N,
         cum_sum_Inf = cum_cases_H+cum_cases_L,
         cum_sum_per_N = (cum_cases_H + cum_cases_L)/N,
         boosted_over_time = boostedH+boostedL,
         boosted_perc_over_time = 100*(boostedH + boostedL)/N,
         vaccinated_over_time = vaccinatedH+vaccinatedL,
         vaccinated_perc_over_time = 100*(vaccinatedH + vaccinatedL)/N) %>%
  group_by(scenario, speed, vaccine_star, boost_shape, SAR, booster, boost, country, replicate) %>%
  mutate(ID_runs = cur_group_id()) %>% ungroup() %>%
  # select(ID_runs, speed, SAR, scenario, vaccine_star, boost_shape, booster, boost, country,
  #        replicate, time, N, infections_over_time:cum_sum_Inf, vaccinated, boosted) %>%
  #mutate(history_types = gsub("count_", "", history_types)) %>%
  #mutate(dummy = NULL) %>%
  arrange(ID_runs) %>%
  #filter(seed_WT == "yes") %>%
  select(-ID_runs) %>% filter(!is.na(time)) %>%
  group_by(SAR, scenario, speed,vaccine_star, boost_shape,booster,boost,country,replicate) %>%
  mutate(ID_runs = cur_group_id()) %>% ungroup() #%>%
  #select(SAR, speed, replicate,scenario,vaccine_star, boost_shape,booster,boost,country,time:cum_sum_Inf, vaccinated, boosted)

write_csv(dataAll, "../Data/ABM Supplement/supp4-same_endpoint/dataAll.csv")
```


### ABM Supp 5: boost like malaysia
#### Supplement Grid 5
Because this includes setting the k for the boosters, instead of leaving it the same as vaccination, there is a separate model code for this one. 
```{r}

b <- c(1)#, 300/90)
SAR <- c(1.3*0.427)#c(0.427) ##, 0.512)
w  <- 1/300
scenario <- c("penalty", "WTpenalty","Ompenalty")
booster <- c("Bivalent", "Monovalent")
vaccine_star <- c("no")
boost_shape <- c("functional")
speed <- c("fast")

## scale level of protection against infection relative to protection against severity
inf_vs_sev <- c(0.8)

age_wt <- read_csv("../Data/ABM_Parameters_Data/age_table.csv") %>%
  rename(age = 1, Ecuador = 2, India = 3, Malaysia = 4) %>%
  pivot_longer(2:4, names_to = "Name", values_to = "count") %>%
  ## mutate(count = if_else(Name == "India", count/(10^6),count/(10^6))) %>%
  mutate(count = as.integer(count)) %>%
  pivot_wider(names_from = age, values_from = "count") %>%
  rename(child = 2, adult = 3, old = 4) %>% 
  mutate(child = child/Total, adult = adult/Total, old=old/Total)

contact <- read_excel("../Data/ABM_Parameters_Data/ContactRates_AgeCountry.xlsx") %>% 
  mutate(indices = 1:17) %>%
  mutate(Name = case_when(
    indices <=6 ~ "India",
    indices >6 & indices <= 12 ~ "Ecuador",
    indices >12 ~ "Malaysia"
  )) %>% 
  select(age = 1, child = 2, adult = 3, old = 4, Name) %>% 
  mutate(child = as.numeric(child), adult = as.numeric(adult), old = as.numeric(old)) %>%
  filter(!is.na(child)) %>% 
  mutate(tot = child + adult + old) %>% 
  select(Name, age, tot) %>% 
  pivot_wider(names_from = age, values_from = tot) %>% 
  # read_excel("../../../Parametrization Data/Contacts/Contact_Reformat.xlsx") %>%
  mutate(contact_total = 0.25*(child*age_wt$child + adult*age_wt$adult + elderly*age_wt$old)) %>%
  group_by(Name) %>%
  summarise(c_LL = 0.7*0.6*contact_total, c_LH = 0.7*0.4*contact_total, 
            c_HH = 0.4*0.6*contact_total, c_HL = 0.4*0.4*contact_total) %>%
  ungroup()


df <- expand_grid(replicate=1:500, b = b, SAR=SAR, w =w, 
                  booster = booster, scenario = scenario,
                  inf_vs_sev = inf_vs_sev,
                  vaccine_star = vaccine_star,
                  boost_shape = boost_shape,
                  speed = speed
                  ) %>% 
  mutate(remove = case_when(
    booster == "Bivalent" & scenario == "WTpenalty" ~ "yes",
    booster == "Bivalent" & scenario == "Ompenalty" ~ "yes",
    booster == "Bivalent" & scenario == "WTefficacy"~ "yes",
    booster== "Bivalent" & scenario =="Omefficacy"~ "yes",
    booster == "Bivalent" & scenario =="WTendpoint" ~"yes",
    booster == "Bivalent" & scenario == "Omendpoint" ~ "yes",
    booster == "Monovalent" & scenario == "penalty" ~ "yes",
    booster == "Monovalent" & scenario == "efficacy" ~ "yes",
    booster == "Monovalent" & scenario == "endpoint" ~ "yes",
    .default = "no"
  )) %>% 
  filter(remove == "no")
  

test <- df%>%select(booster,scenario) %>%distinct()
  
  ## Rules: Want c_HH to have roughly 1 contact as the basis and then multiply by 0.2. Then 30% reduction in contact for low SES and 
  ## 60% for high SES. Assume 60% of contact is within group, 40% is out group. 
  
age <- read_csv("../Data/ABM_Parameters_Data/age_table.csv") %>%
  rename(age = 1, Ecuador = 2, India = 3, Malaysia = 4) %>%
  pivot_longer(2:4, names_to = "Name", values_to = "count") %>%
 ## mutate(count = if_else(Name == "India", count/(10^6),count/(10^6))) %>%
  mutate(count = as.integer(count)) %>%
  pivot_wider(names_from = age, values_from = "count") %>%
  rename(child = 2, adult = 3, old = 4) %>%
  mutate(child = as.integer(0.5*(10^5)*child/Total), ## CHANGE BACK TO 10^5
         adult = as.integer(0.5*(10^5)*adult/Total),
         old = as.integer(0.5*(10^5)*old/Total)) %>%
  ## check that pop is 500,000
  mutate(Total = child+adult+old) %>%
  mutate(Total = NULL)

paramsH <- read_csv("../Data/ABM_Parameters_Data/paramsTable.csv") %>% filter(Name %in% c("Malaysia", "India", "Ecuador")) %>% filter(SES == "H") %>%
  rename(MH = 3, WH = 4, hH = 5) %>%
  summarise(Name, MH, WH, hH)
paramsL <- read_csv("../Data/ABM_Parameters_Data/paramsTable.csv") %>% filter(Name %in% c("Malaysia", "India", "Ecuador")) %>% filter(SES == "L") %>%
  rename(ML = 3, WL = 4, hL = 5) %>%
  summarise(Name, ML, WL, hL) 
params <- inner_join(paramsH, paramsL)


## calculate booster proportions
## Pops: I: 1B, E: 17.5 m, M: 28.6 m
##Max booster: I: 227 m, E: 10.5 m, M: 17.1

## India: 
## 24.0% of the pop is children
## Based on original vaccines, of the boosted population, we expect 0.93/(0.93 + 0.78) = 0.54% are high SES and 0.78/(0.93+0.78) = 0.46% are low SES
## High SES: Vm = 0.93, 500m, leaves 465m high SES vaccinated, of which 353.4 are non-children -- boosters 227*0.54 = 122.58, 122.58/353.4 = 0.35 of vaccinated get a booster
## Low SES: Vm = 0.78, 500m, leaves 390m low SES vaccinated, of which 296.4 are non-children -- boosters 227*0.46 = 104.42, 104.42/296.4 = .35 of vaccinated get a booster

## Malaysia: 
## 21.5% of the pop is children
## 0.97/(0.97+0.72) = 0.57 and 0.72/(0.97+0.72) = 0.43
## High SES: Vm = 0.97, 14.3m, leaves 13.87 vaccinated of which 10.89 are eligible -- boosters 17.1*0.57 = 9.747, 9.747/10.89 = 0.90 of vaccinated gets boosted 
## Low SES: Vm = 0.72, 14.3m, leaves 10.30 vaccinated of which  8.09 eligible -- boosters 17.1*0.43 = 7.353, 7.353/8.09 = 0.91 of vaccinated get boosted

## Ecuador: 
## 23.6% is children
## 1, 0.79 -- 1/(1+0.79) = 0.56 and 0.44
## High SES: Vm = 1, 8.75m, leaves 8.75m vaccinated of which 6.685 eligible -- boosters 10.5*0.56 = 5.88, 5.88/6.685 = 0.88
## Low SES: Vm = 0.79, 8.75m, leaves 6.9125 vaccinated of which 5.281 eligible-- boosters 10.5*0.44 = 4.62, 4.62/5.281 = 0.87

## what the above numbers mean: of the eligible group (adults), X% gets vaccinated
## these are NOT total pop numbers

fullpar <- inner_join(params, age) %>% 
  mutate(MH_boost = case_when(
    Name == "India" ~ "0.90",
    Name == "Malaysia" ~ "0.90",
    Name == "Ecuador" ~ "0.90"
  ),
  ML_boost = case_when(
    Name == "India" ~ "0.91",
    Name == "Malaysia" ~ "0.91",
    Name == "Ecuador" ~ "0.91"
  )
  ,
 MH_boost = as.numeric(MH_boost),
         ML_boost = as.numeric(ML_boost)
  )


dfM <- df %>% mutate(Name = "Malaysia")
dfE <- df %>% mutate(Name = "Ecuador")
dfI <- df %>% mutate(Name = "India")


stringency <- read_excel("../Data/ABM_Parameters_Data/Stringency.xlsx")

df <- rbind(dfM, dfE) %>%
  rbind(dfI) %>%
  left_join(fullpar) %>%
  left_join(stringency %>% rename(Name = country)) %>%
  arrange(replicate) %>% 
  left_join(contact) %>%
  add_column(variant_test = "NA", .after = "string_om2")
##%>% filter(Name == "India")


serotypes_star <- read_csv("../Data/ABM_Parameters_Data/paramScale_MonOm.csv") %>% 
  select(history, Bivalent_penalty, Bivalent_efficacy, Bivalent_endpoint, 
         Monovalent_WTpenalty,Monovalent_Ompenalty, 
         Monovalent_WTefficacy, Monovalent_Omefficacy,
         Monovalent_WTendpoint, Monovalent_Omendpoint) %>% 
  pivot_longer(Bivalent_penalty:Monovalent_Omendpoint, names_to = "names", values_to = "values") %>% 
  separate(names, into = c("booster", "scenario"), sep = "_") %>%
  filter(!is.na(values)) %>%
  pivot_wider(names_from = history, values_from = values)
  

serotypes_Omicron <- read_csv("../Data/ABM_Parameters_Data/paramScale_MonOm.csv") %>% 
  select(history, Bivalent_penalty_Omicron, Bivalent_efficacy_Omicron, Bivalent_endpoint_Omicron, 
         Monovalent_WTpenalty_Omicron,Monovalent_Ompenalty_Omicron, 
         Monovalent_WTefficacy_Omicron, Monovalent_Omefficacy_Omicron,
         Monovalent_WTendpoint_Omicron, Monovalent_Omendpoint_Omicron) %>% 
  pivot_longer(Bivalent_penalty_Omicron:Monovalent_Omendpoint_Omicron, names_to = "names", values_to = "values") %>% 
  separate(names, into = c("booster", "scenario"), sep = "_") %>%
  filter(!is.na(values)) %>%
  pivot_wider(names_from = history, values_from = values) %>%
  rename(Delta_vaccine_Om = Delta_vaccine,
         Omicron_star_vaccine_Om = Omicron_star_vaccine,
         Omicron_vaccine_Om = Omicron_vaccine,
         Vaccine_Om = Vaccine,
         WT_vaccine_Om = WT_vaccine)

serotypes <- left_join(serotypes_star, serotypes_Omicron, by = c("booster","scenario")) 

df_everything <- left_join(df, serotypes, by = c("booster","scenario")) %>%
  mutate(boost = "yes")

## WH and WL for Malaysia
params2 <- params %>% filter(Name == "Malaysia")

df_everything <- df_everything %>%
  mutate(
    WH_boost = case_when(
      speed == "slow" ~ params2$WH,
      speed== "fast" ~ params2$WH - 10
    ),
    WL_boost = case_when(
      speed == "slow" ~ params2$WL,
      speed== "fast" ~ params2$WL - 10
    )
  )

## add k

df_everything <- df_everything %>%
  mutate(
    kH_boost = params2$hH,
    kL_boost = params2$hL
    )

##### make no booster scenario #######

df_noboost <- df_everything %>% 
  filter(scenario == "WTpenalty", booster == "Monovalent", boost_shape == "functional", speed == "fast") %>% 
  mutate(scenario = "no booster", booster = "no booster", boost_shape = "no booster", speed = "no booster") %>% 
  mutate(boost = "no")
  
df_everything <- rbind(df_everything, df_noboost) %>% arrange(replicate) %>%
  filter(boost_shape == "functional" | boost_shape== "no booster") %>%
  arrange(replicate)

test <- df_everything %>% filter(scenario == "no booster")

##### get non-child proportions #####

nonchild <- age_wt %>% 
  group_by(Name) %>%
  summarise(nonchild = 1-child) %>% 
  ungroup()

df_everything <- df_everything %>% 
  left_join(nonchild)

## filter
df_everything <- df_everything %>% 
  filter(scenario %in% c("no booster", "WTpenalty", "Ompenalty", "penalty"))

## extra filter

# df_everything <- df_everything %>% 
#   filter(scenario =="no booster", Name == "Malaysia")

write_csv(df_everything, "../Data/ABM_Parameters_Data/Grid_Param_supp5.csv")

```


#### Concatenate replicates
##### Read files AS

```{r message=FALSE}
fileNames <- list.files(path="../Data/ABM Supplement/supp5-boost_like_Malaysia/output_files_AS", 
                     pattern=".csv", all.files=TRUE,full.names=TRUE)

grid_v1 <- read_csv("../Data/ABM_Parameters_Data/Grid_Param_supp5.csv") %>%
  mutate(indexID = row_number())

df_info_v1 <- tibble(fileNames = fileNames) %>% 
  mutate(indexID = str_remove(fileNames, "../Data/ABM Supplement/supp5-boost_like_Malaysia/output_files_AS/output_1x_ID_")) %>%
  mutate(indexID = str_remove(indexID, ".csv")) %>%
  mutate(indexID = parse_number(indexID)) %>% right_join(grid_v1) %>% filter(!is.na(fileNames))

df_v1 <- df_info_v1$fileNames %>% map_dfr(read_csv)

df_v1 <- df_v1 %>% select(-`...1`) %>%
  right_join(grid_v1)

write_csv(df_v1, "../Data/ABM Supplement/supp5-boost_like_Malaysia/concatenated data/df_AS.csv")
```


#### Make files for figures
##### Load data
```{r}

#### Load data ####

serotypes <- read_csv("../Data/ABM_Parameters_Data/paramScale_MonOm.csv")

grid_v1 <- read_csv("../Data/ABM_Parameters_Data/Grid_Param_supp5.csv")

df <- read_csv("../Data/ABM Supplement/supp5-boost_like_Malaysia/concatenated data/df_AS.csv")

```

##### dataAll
```{r}

dataAll <- df %>%
  select(Name, speed, vaccine_star, boost_shape, SAR, booster, scenario, boost, N, Inf_H, Inf_L, Dead_H, Dead_L, cum_cases_H, cum_cases_L, replicate, time, vaccinatedH,vaccinatedL, boostedH, boostedL) %>%
  #pivot_longer(count_Naive:count_Vaccine_boost, names_to = "history_types", values_to = "history_counts") %>%
  select(Name, speed, vaccine_star, boost_shape, SAR, booster, scenario, boost, N, Inf_H, Inf_L, Dead_H, Dead_L, cum_cases_H, cum_cases_L, replicate, time, vaccinatedH, vaccinatedL, boostedH, boostedL) %>% #count_Naive:count_Vaccine_boost) %>%
  mutate(country = Name, 
         time = as.integer(time), 
         infections_over_time = Inf_L+Inf_H, 
         infections_perc_over_time = 100*(Inf_L+Inf_H)/N,
         deaths_over_time = Dead_L + Dead_H, 
         deaths_perc_over_time = 100*(Dead_L + Dead_H)/N,
         cum_sum_Inf = cum_cases_H+cum_cases_L,
         cum_sum_per_N = (cum_cases_H + cum_cases_L)/N,
         boosted_over_time = boostedH+boostedL,
         boosted_perc_over_time = 100*(boostedH + boostedL)/N,
         vaccinated_over_time = vaccinatedH+vaccinatedL,
         vaccinated_perc_over_time = 100*(vaccinatedH + vaccinatedL)/N) %>%
  group_by(scenario, speed, vaccine_star, boost_shape, SAR, booster, boost, country, replicate) %>%
  mutate(ID_runs = cur_group_id()) %>% ungroup() %>%
  # select(ID_runs, speed, SAR, scenario, vaccine_star, boost_shape, booster, boost, country,
  #        replicate, time, N, infections_over_time:cum_sum_Inf, vaccinated, boosted) %>%
  #mutate(history_types = gsub("count_", "", history_types)) %>%
  #mutate(dummy = NULL) %>%
  arrange(ID_runs) %>%
  #filter(seed_WT == "yes") %>%
  select(-ID_runs) %>% filter(!is.na(time)) %>%
  group_by(SAR, scenario, speed,vaccine_star, boost_shape,booster,boost,country,replicate) %>%
  mutate(ID_runs = cur_group_id()) %>% ungroup() #%>%
  #select(SAR, speed, replicate,scenario,vaccine_star, boost_shape,booster,boost,country,time:cum_sum_Inf, vaccinated, boosted)

write_csv(dataAll, "../Data/ABM Supplement/supp5-boost_like_Malaysia/dataAll.csv")
```

### ABM Supp 6: Delayed rollout
#### grid 6
```{r}
b <- c(1)#, 300/90)
SAR <- c(1.1*0.427, 1.3*0.427)#c(0.427) ##, 0.512)
w  <- 1/300
scenario <- c("penalty", "WTpenalty","Ompenalty","efficacy", "endpoint", "Omefficacy", "Omendpoint","WTefficacy", "WTendpoint")
booster <- c("Bivalent", "Monovalent")
vaccine_star <- c("no")
boost_shape <- c("functional")
speed <- c("fast", "slow")
t_boost_start <- c(870, 900, 930)

## scale level of protection against infection relative to protection against severity
inf_vs_sev <- c(0.8)

age_wt <- read_csv("../Data/ABM_Parameters_Data/age_table.csv") %>%
  rename(age = 1, Ecuador = 2, India = 3, Malaysia = 4) %>%
  pivot_longer(2:4, names_to = "Name", values_to = "count") %>%
  ## mutate(count = if_else(Name == "India", count/(10^6),count/(10^6))) %>%
  mutate(count = as.integer(count)) %>%
  pivot_wider(names_from = age, values_from = "count") %>%
  rename(child = 2, adult = 3, old = 4) %>% 
  mutate(child = child/Total, adult = adult/Total, old=old/Total)

contact <- read_excel("../Data/ABM_Parameters_Data/ContactRates_AgeCountry.xlsx") %>% 
  mutate(indices = 1:17) %>%
  mutate(Name = case_when(
    indices <=6 ~ "India",
    indices >6 & indices <= 12 ~ "Ecuador",
    indices >12 ~ "Malaysia"
  )) %>% 
  select(age = 1, child = 2, adult = 3, old = 4, Name) %>% 
  mutate(child = as.numeric(child), adult = as.numeric(adult), old = as.numeric(old)) %>%
  filter(!is.na(child)) %>% 
  mutate(tot = child + adult + old) %>% 
  select(Name, age, tot) %>% 
  pivot_wider(names_from = age, values_from = tot) %>% 
  # read_excel("../../../Parametrization Data/Contacts/Contact_Reformat.xlsx") %>%
  mutate(contact_total = 0.25*(child*age_wt$child + adult*age_wt$adult + elderly*age_wt$old)) %>%
  group_by(Name) %>%
  summarise(c_LL = 0.7*0.6*contact_total, c_LH = 0.7*0.4*contact_total, 
            c_HH = 0.4*0.6*contact_total, c_HL = 0.4*0.4*contact_total) %>%
  ungroup()


df <- expand_grid(replicate=1:500, b = b, SAR=SAR, w =w, 
                  booster = booster, scenario = scenario,
                  inf_vs_sev = inf_vs_sev,
                  vaccine_star = vaccine_star,
                  boost_shape = boost_shape,
                  speed = speed,
                  t_boost_start
                  ) %>% 
  mutate(remove = case_when(
    booster == "Bivalent" & scenario == "WTpenalty" ~ "yes",
    booster == "Bivalent" & scenario == "Ompenalty" ~ "yes",
    booster == "Bivalent" & scenario == "WTefficacy"~ "yes",
    booster== "Bivalent" & scenario =="Omefficacy"~ "yes",
    booster == "Bivalent" & scenario =="WTendpoint" ~"yes",
    booster == "Bivalent" & scenario == "Omendpoint" ~ "yes",
    booster == "Monovalent" & scenario == "penalty" ~ "yes",
    booster == "Monovalent" & scenario == "efficacy" ~ "yes",
    booster == "Monovalent" & scenario == "endpoint" ~ "yes",
    .default = "no"
  )) %>% 
  filter(remove == "no")
  

test <- df%>%select(booster,scenario) %>%distinct()
  
  ## Rules: Want c_HH to have roughly 1 contact as the basis and then multiply by 0.2. Then 30% reduction in contact for low SES and 
  ## 60% for high SES. Assume 60% of contact is within group, 40% is out group. 
  
age <- read_csv("../Data/ABM_Parameters_Data/age_table.csv") %>%
  rename(age = 1, Ecuador = 2, India = 3, Malaysia = 4) %>%
  pivot_longer(2:4, names_to = "Name", values_to = "count") %>%
 ## mutate(count = if_else(Name == "India", count/(10^6),count/(10^6))) %>%
  mutate(count = as.integer(count)) %>%
  pivot_wider(names_from = age, values_from = "count") %>%
  rename(child = 2, adult = 3, old = 4) %>%
  mutate(child = as.integer(0.5*(10^5)*child/Total), ## CHANGE BACK TO 10^5
         adult = as.integer(0.5*(10^5)*adult/Total),
         old = as.integer(0.5*(10^5)*old/Total)) %>%
  ## check that pop is 500,000
  mutate(Total = child+adult+old) %>%
  mutate(Total = NULL)

paramsH <- read_csv("../Data/ABM_Parameters_Data/paramsTable.csv") %>% filter(Name %in% c("Malaysia", "India", "Ecuador")) %>% filter(SES == "H") %>%
  rename(MH = 3, WH = 4, hH = 5) %>%
  summarise(Name, MH, WH, hH)
paramsL <- read_csv("../Data/ABM_Parameters_Data/paramsTable.csv") %>% filter(Name %in% c("Malaysia", "India", "Ecuador")) %>% filter(SES == "L") %>%
  rename(ML = 3, WL = 4, hL = 5) %>%
  summarise(Name, ML, WL, hL) 
params <- inner_join(paramsH, paramsL)


## calculate booster proportions
## Pops: I: 1B, E: 17.5 m, M: 28.6 m
##Max booster: I: 227 m, E: 10.5 m, M: 17.1

## India: 
## 24.0% of the pop is children
## Based on original vaccines, of the boosted population, we expect 0.93/(0.93 + 0.78) = 0.54% are high SES and 0.78/(0.93+0.78) = 0.46% are low SES
## High SES: Vm = 0.93, 500m, leaves 465m high SES vaccinated, of which 353.4 are non-children -- boosters 227*0.54 = 122.58, 122.58/353.4 = 0.35 of vaccinated get a booster
## Low SES: Vm = 0.78, 500m, leaves 390m low SES vaccinated, of which 296.4 are non-children -- boosters 227*0.46 = 104.42, 104.42/296.4 = .35 of vaccinated get a booster

## Malaysia: 
## 21.5% of the pop is children
## 0.97/(0.97+0.72) = 0.57 and 0.72/(0.97+0.72) = 0.43
## High SES: Vm = 0.97, 14.3m, leaves 13.87 vaccinated of which 10.89 are eligible -- boosters 17.1*0.57 = 9.747, 9.747/10.89 = 0.90 of vaccinated gets boosted 
## Low SES: Vm = 0.72, 14.3m, leaves 10.30 vaccinated of which  8.09 eligible -- boosters 17.1*0.43 = 7.353, 7.353/8.09 = 0.91 of vaccinated get boosted

## Ecuador: 
## 23.6% is children
## 1, 0.79 -- 1/(1+0.79) = 0.56 and 0.44
## High SES: Vm = 1, 8.75m, leaves 8.75m vaccinated of which 6.685 eligible -- boosters 10.5*0.56 = 5.88, 5.88/6.685 = 0.88
## Low SES: Vm = 0.79, 8.75m, leaves 6.9125 vaccinated of which 5.281 eligible-- boosters 10.5*0.44 = 4.62, 4.62/5.281 = 0.87

## what the above numbers mean: of the eligible group (adults), X% gets vaccinated
## these are NOT total pop numbers

fullpar <- inner_join(params, age) %>% 
  mutate(MH_boost = case_when(
    Name == "India" ~ "0.35",
    Name == "Malaysia" ~ "0.90",
    Name == "Ecuador" ~ "0.88"
  ),
  ML_boost = case_when(
    Name == "India" ~ "0.35",
    Name == "Malaysia" ~ "0.91",
    Name == "Ecuador" ~ "0.87"
  )
  ,
 MH_boost = as.numeric(MH_boost),
         ML_boost = as.numeric(ML_boost)
  )


dfM <- df %>% mutate(Name = "Malaysia")
dfE <- df %>% mutate(Name = "Ecuador")
dfI <- df %>% mutate(Name = "India")


stringency <- read_excel("../Data/ABM_Parameters_Data/Stringency.xlsx")

df <- rbind(dfM, dfE) %>%
  rbind(dfI) %>%
  left_join(fullpar) %>%
  left_join(stringency %>% rename(Name = country)) %>%
  arrange(replicate) %>% 
  left_join(contact) %>%
  add_column(variant_test = "NA", .after = "string_om2")
##%>% filter(Name == "India")


serotypes_star <- read_csv("../Data/ABM_Parameters_Data/paramScale_MonOm.csv") %>% 
  select(history, Bivalent_penalty, Bivalent_efficacy, Bivalent_endpoint, 
         Monovalent_WTpenalty,Monovalent_Ompenalty, 
         Monovalent_WTefficacy, Monovalent_Omefficacy,
         Monovalent_WTendpoint, Monovalent_Omendpoint) %>% 
  pivot_longer(Bivalent_penalty:Monovalent_Omendpoint, names_to = "names", values_to = "values") %>% 
  separate(names, into = c("booster", "scenario"), sep = "_") %>%
  filter(!is.na(values)) %>%
  pivot_wider(names_from = history, values_from = values)
  

serotypes_Omicron <- read_csv("../Data/ABM_Parameters_Data/paramScale_MonOm.csv") %>% 
  select(history, Bivalent_penalty_Omicron, Bivalent_efficacy_Omicron, Bivalent_endpoint_Omicron, 
         Monovalent_WTpenalty_Omicron,Monovalent_Ompenalty_Omicron, 
         Monovalent_WTefficacy_Omicron, Monovalent_Omefficacy_Omicron,
         Monovalent_WTendpoint_Omicron, Monovalent_Omendpoint_Omicron) %>% 
  pivot_longer(Bivalent_penalty_Omicron:Monovalent_Omendpoint_Omicron, names_to = "names", values_to = "values") %>% 
  separate(names, into = c("booster", "scenario"), sep = "_") %>%
  filter(!is.na(values)) %>%
  pivot_wider(names_from = history, values_from = values) %>%
  rename(Delta_vaccine_Om = Delta_vaccine,
         Omicron_star_vaccine_Om = Omicron_star_vaccine,
         Omicron_vaccine_Om = Omicron_vaccine,
         Vaccine_Om = Vaccine,
         WT_vaccine_Om = WT_vaccine)

serotypes <- left_join(serotypes_star, serotypes_Omicron, by = c("booster","scenario")) 

df_everything <- left_join(df, serotypes, by = c("booster","scenario")) %>%
  mutate(boost = "yes")

df_everything <- df_everything %>%
  mutate(
    WH_boost = case_when(
      speed == "slow" ~ WH,
      speed== "fast" ~ WH - 10
    ),
    WL_boost = case_when(
      speed == "slow" ~ WL,
      speed== "fast" ~ WL - 10
    )
  )

##### make no booster scenario #######

# df_noboost <- df_everything %>% 
#   filter(scenario == "WTpenalty", booster == "Monovalent", boost_shape == "functional", speed == "slow") %>% 
#   mutate(scenario = "no booster", booster = "no booster", boost_shape = "no booster", speed = "no booster") %>% 
#   mutate(boost = "no")
#   
# df_everything <- rbind(df_everything, df_noboost) %>% arrange(replicate) %>%
#   filter(boost_shape == "functional" | boost_shape== "no booster") %>%
#   arrange(replicate)
# 
# test <- df_everything %>% filter(scenario == "no booster")

##### get non-child proportions #####

nonchild <- age_wt %>% 
  group_by(Name) %>%
  summarise(nonchild = 1-child) %>% 
  ungroup()

df_everything <- df_everything %>% 
  left_join(nonchild)

## filter
df_everything <- df_everything %>% 
  filter(speed != "slow") %>%
  filter(SAR == 1.3*0.427) %>%
  filter(scenario %in% c("no booster", "WTpenalty", "Ompenalty", "penalty"))

## extra filter

# df_everything <- df_everything %>% 
#   filter(scenario =="no booster", Name == "Malaysia")

write_csv(df_everything, "../Data/ABM_Parameters_Data/Grid_Param_supp6.csv")

```
#### Concatenate replicates
```{r message=FALSE}
fileNames <- list.files(path="../Data/ABM Supplement/supp6-delayed_rollout/output_files_AS_1", 
                     pattern=".csv", all.files=TRUE,full.names=TRUE)

grid_v1 <- read_csv("../Data/ABM_Parameters_Data/Grid_Param_supp6.csv") %>%
  mutate(indexID = row_number())

df_info_v1 <- tibble(fileNames = fileNames) %>% 
  mutate(indexID = str_remove(fileNames, "../Data/ABM Supplement/supp6-delayed_rollout/output_files_AS_1/output_1x_ID_")) %>%
  mutate(indexID = str_remove(indexID, ".csv")) %>%
  mutate(indexID = parse_number(indexID)) %>% right_join(grid_v1) %>% filter(!is.na(fileNames))

df_v1 <- df_info_v1$fileNames %>% map_dfr(read_csv)

df_v1 <- df_v1 %>% select(-`...1`) %>%
  right_join(grid_v1)

write_csv(df_v1, "../Data/ABM Supplement/supp6-delayed_rollout/concatenated data/df_AS1.csv")

gc()

```



##### dataAll
```{r}

dataAll <- df_v1 %>%
  # read_csv("../Data/ABM Supplement/supp6-delayed_rollout/concatenated data/df_AS1.csv") %>%
  # rbind(read_csv("../Data/ABM Supplement/supp6-delayed_rollout/concatenated data/df_AS.csv")) %>%
  select(Name, t_boost_start, speed, vaccine_star, boost_shape, SAR, booster, scenario, boost, N, Inf_H, Inf_L, Dead_H, Dead_L, cum_cases_H, cum_cases_L, replicate, time, vaccinatedH,vaccinatedL, boostedH, boostedL) %>%
  #pivot_longer(count_Naive:count_Vaccine_boost, names_to = "history_types", values_to = "history_counts") %>%
  select(Name, speed, t_boost_start, vaccine_star, boost_shape, SAR, booster, scenario, boost, N, Inf_H, Inf_L, Dead_H, Dead_L, cum_cases_H, cum_cases_L, replicate, time, vaccinatedH, vaccinatedL, boostedH, boostedL) %>% #count_Naive:count_Vaccine_boost) %>%
  mutate(country = Name, 
         time = as.integer(time), 
         infections_over_time = Inf_L+Inf_H, 
         infections_perc_over_time = 100*(Inf_L+Inf_H)/N,
         deaths_over_time = Dead_L + Dead_H, 
         deaths_perc_over_time = 100*(Dead_L + Dead_H)/N,
         cum_sum_Inf = cum_cases_H+cum_cases_L,
         cum_sum_per_N = (cum_cases_H + cum_cases_L)/N,
         boosted_over_time = boostedH+boostedL,
         boosted_perc_over_time = 100*(boostedH + boostedL)/N,
         vaccinated_over_time = vaccinatedH+vaccinatedL,
         vaccinated_perc_over_time = 100*(vaccinatedH + vaccinatedL)/N) %>%
  group_by(scenario, speed, vaccine_star, boost_shape, SAR, booster, boost, country, replicate, t_boost_start,) %>%
  mutate(ID_runs = cur_group_id()) %>% ungroup() %>%
  # select(ID_runs, speed, SAR, scenario, vaccine_star, boost_shape, booster, boost, country,
  #        replicate, time, N, infections_over_time:cum_sum_Inf, vaccinated, boosted) %>%
  #mutate(history_types = gsub("count_", "", history_types)) %>%
  #mutate(dummy = NULL) %>%
  arrange(ID_runs) %>%
  #filter(seed_WT == "yes") %>%
  select(-ID_runs) %>% filter(!is.na(time)) %>%
  group_by(SAR, scenario, speed,vaccine_star, boost_shape,booster,boost,country,replicate, t_boost_start) %>%
  mutate(ID_runs = cur_group_id()) %>% ungroup() #%>%
  #select(SAR, speed, replicate,scenario,vaccine_star, boost_shape,booster,boost,country,time:cum_sum_Inf, vaccinated, boosted)

write_csv(dataAll, "../Data/ABM Supplement/supp6-delayed_rollout/dataAll.csv")

```

### ABM Supp 7: booster efficacy
#### titers
```{r}

########## Man. paper #########

## neutralizing antibody titres
dataMan <- read_excel("../Data/ABM_Parameters_Data/Manali et al/New_Supplementary_Data_File.xlsx") %>% 
  select(doses = `Number of Vaccine Doses`, Group, 
         WT = `Wuhan Titre`, Delta = `Delta Titre`, Omicron = `Omicron Titre`) %>% 
  filter(doses > 1 | doses == 0) %>% ## 2 or more doses
  filter(Group != "I_Av" & Group != "I_A" & Group != "N") %>%
  mutate(
    History = case_when(
      Group == "I_Wv" ~ "WT_vaccine",
      Group == "I_W" ~ "WT",
      Group == "I_Dv" ~ "Delta_vaccine",
      Group == "I_D" ~ "Delta",
      Group == "V" ~ "Vaccine")) %>% 
  select(History, WT, Delta, Omicron) %>% 
  pivot_longer(WT:Omicron, names_to = "Variant", values_to = "Titre")

######## data_Surya #######
  
##unvaccinated and hybrid individuals, NT50 - 2-3 doses
data_Surya <- read_excel("../Data/ABM_Parameters_Data/Suryawanshi et al. 2022/reformat.xlsx") %>% 
  select(History = history, WT = WA1, Delta, Omicron) %>% 
  pivot_longer(WT:Omicron, names_to = "Variant", values_to = "Titre")


######### Test plot ########

test_Man <- dataMan %>% mutate(paper = "Man") 
test_Surya <- data_Surya %>% mutate(paper = "Surya")

plot_check <- test_Man %>% rbind(test_Surya) %>% 
  filter(History != "Naive") %>% 
  group_by(History, Variant, paper) %>%
  mutate(Titre = as.numeric(Titre), 
         Titre = if_else(Titre < 1, 1, Titre)) %>% ## clean out -Inf values - if someone's titre is 0, approximate it by 1
  mutate(Titre = log10(Titre)) %>% 
  summarise(Titre = mean(Titre, na.rm = T)) %>% 
  ggplot(aes(x = History, y = Titre, group = History, fill = History)) + 
  geom_col(position = "dodge") + 
  facet_grid(paper~Variant)
plot_check

#ggsave("Show_titres.pdf", plot_check, width = 12, height = 8)


########## Get full table #########

## get an immunity table combining all sources
fullDat <- rbind(dataMan, data_Surya) %>% 
  filter(History != "Naive") %>% 
  mutate(Titre = as.numeric(Titre)) %>% 
  mutate(
    Titre = if_else(Titre < 1, 1, Titre), ## clean out -Inf - if titre is between 0-1, approximate it by 1
    Titre = log10(Titre) ## get log scale titre
  ) %>% 
  group_by(History, Variant) %>% 
  summarise(
    Titre = mean(Titre, na.rm = T), ## grab mean log titre
         minuslogTitre = -Titre) %>% ## get minus log titre since we want to scale a reduction in a param
  ungroup() %>% 
  mutate(paramfinal = rescale(minuslogTitre, to = c(0.05, 0.95))) %>% 
  arrange(paramfinal) %>% 
  select(Serotype = History, variant = Variant, paramfinal) %>% 
  mutate(paramfinal = round(paramfinal, 2))

## test 
plot <- fullDat %>% 
  mutate(variant = fct_relevel(variant, c("WT", "Delta", "Omicron"))) %>% 
  ggplot(aes(x = variant, y = Serotype, fill = 1-paramfinal)) + 
  geom_tile() + 
  scale_fill_viridis_c()
plot

## get transition between WT to Delta
fullDat_transition <- fullDat %>% 
  pivot_wider(names_from = "variant", values_from = "paramfinal") %>% 
  mutate(diffWT_to_DT = round(mean(Delta-WT),2), diffDT_to_Om = round(mean(Omicron-Delta),2))

lineage_change <- fullDat_transition$diffWT_to_DT[1]

## transition from WT to Delta: lineage_change
  
savefile <- fullDat %>% 
  pivot_wider(names_from = Serotype, values_from = paramfinal)


## get the difference from a vaccine to get the Omicron serotype
diff_file <- savefile %>% 
  mutate(Delta_vax_diff = Delta_vaccine - Delta,
         WT_vax_diff = WT_vaccine - WT,
         Omicron_vax_diff = Omicron_vaccine - Omicron,
         Vax_diff = Vaccine - 1) ##this is the base change for ppl getting a vaccine


savefile <- savefile %>% 
  ## rule: Omicron = Omicron_vaccine - vaccine benefit i.e. the change for Delta
  #mutate(Omicron = Omicron_vaccine - diff_file$Delta_vax_diff) %>% 
  mutate(Omicron_star = if_else(Omicron+lineage_change <= 1, Omicron + lineage_change, 1),
         Omicron_star_vaccine = if_else(Omicron_vaccine + lineage_change <=1, Omicron_vaccine+lineage_change, 1))


#### New scheme ####

Booster_Bump_WT <- diff_file %>% filter(variant == "WT") %>% select("WT_vax_diff")
Booster_Bump_Delta <- diff_file %>% filter(variant == "WT") %>% select("Delta_vax_diff")
Booster_Bump_Omicron <- diff_file %>% filter(variant == "WT") %>% select("Omicron_vax_diff")
Booster_Bump_Vaccine <- diff_file %>% filter(variant == "WT") %>% select("Vax_diff")

avg_change <- (Booster_Bump_WT$WT_vax_diff + 
                 Booster_Bump_Delta$Delta_vax_diff +
                 Booster_Bump_Omicron$Omicron_vax_diff +
                 Booster_Bump_Vaccine$Vax_diff)/4


######## make omicron* wave ########

savefile <- savefile %>% pivot_longer(-variant, 
                                      names_to = "history", 
                                      values_to = "paramfinal") %>% 
  pivot_wider(names_from = variant, values_from = paramfinal) %>% 
  mutate(Omicron_star = if_else(history == "Omicron_star" | history == "Omicron_star_vaccine",
                                Omicron-lineage_change, 
                                Omicron + lineage_change)) %>% 
  mutate(Omicron_star = if_else(Omicron_star <= 1, Omicron_star, 1)) %>%
  mutate(Omicron_star = if_else(Omicron_star >=0, Omicron_star, 0))

####### add bivalent and monovalent (40% of bivalent) booster ##########

## Assume that the bivalent takes us back to original vaccine efficacy, the monovalent is 40% of the bivalent


###### hypothesis 1: history penalty ######

## how to treat Omicron* in this regime - like an Omicron lineage?

savefile <- savefile %>% 
  mutate(Bivalent_penalty = case_when(
    history %in% c("Vaccine")  ~ Omicron_star + Booster_Bump_Vaccine$Vax_diff,
    history %in% c("Delta_vaccine") ~ Omicron_star + Booster_Bump_Delta$Delta_vax_diff,
    history %in% c("WT_vaccine") ~ Omicron_star + 0.5*(Booster_Bump_WT$WT_vax_diff + Booster_Bump_Omicron$Omicron_vax_diff),
    history %in% c("Omicron_vaccine","Omicron_star_vaccine") ~ Omicron_star + 0.5*(Booster_Bump_Omicron$Omicron_vax_diff + Booster_Bump_WT$WT_vax_diff),
    .default = NA
  )) %>%
  mutate(Monovalent_WTpenalty = case_when(
    history %in% c("Vaccine")  ~ Omicron_star + 1*Booster_Bump_Vaccine$Vax_diff,
    history %in% c("Delta_vaccine") ~ Omicron_star + 1*Booster_Bump_Delta$Delta_vax_diff,
    history %in% c("WT_vaccine") ~ Omicron_star + 1*Booster_Bump_WT$WT_vax_diff,
    history %in% c("Omicron_vaccine", "Omicron_star_vaccine") ~ Omicron_star + 1*Booster_Bump_Omicron$Omicron_vax_diff,
    .default = NA
  )) %>% 
  mutate(Monovalent_Ompenalty = case_when(
    history %in% c("Vaccine")  ~ Omicron_star + 1*Booster_Bump_Vaccine$Vax_diff,
    history %in% c("Delta_vaccine") ~ Omicron_star + 1*Booster_Bump_Delta$Delta_vax_diff,
    history %in% c("WT_vaccine") ~ Omicron_star + 1*Booster_Bump_Omicron$Omicron_vax_diff,
    history %in% c("Omicron_vaccine","Omicron_star_vaccine") ~ Omicron_star + 1*Booster_Bump_WT$WT_vax_diff,
    .default = NA
  )) 

###### hypothesis 2: everyone gets same benefit --  average change in the data ######

savefile <- savefile %>% 
  mutate(Bivalent_efficacy = case_when(
    history %in% c("Vaccine")  ~ Omicron_star + (avg_change),
    history %in% c("Delta_vaccine") ~ Omicron_star + (avg_change),
    history %in% c("WT_vaccine") ~ Omicron_star + (avg_change),
    history %in% c("Omicron_vaccine", "Omicron_star_vaccine") ~ Omicron_star + (avg_change),
    .default = NA
  )) %>%
  mutate(Monovalent_efficacy = case_when(
    history %in% c("Vaccine")  ~ Omicron_star + 1*(avg_change),
    history %in% c("Delta_vaccine") ~ Omicron_star + 1*(avg_change),
    history %in% c("WT_vaccine") ~ Omicron_star + 1*(avg_change),
    history %in% c("Omicron_vaccine", "Omicron_star_vaccine") ~ Omicron_star + 1*(avg_change),
    .default = NA
  ))

####### hypothesis 3: everyone goes to the min protection  of the same efficacy scenarios #####

bivalent_peak <- min(savefile$Bivalent_efficacy,na.rm = T)
monovalent_peak <- min(savefile$Monovalent_efficacy,na.rm = T)


savefile <- savefile %>% 
  mutate(Bivalent_endpoint = case_when(
    history %in% c("Vaccine")  ~ bivalent_peak,
    history %in% c("Delta_vaccine") ~ bivalent_peak,
    history %in% c("WT_vaccine") ~ bivalent_peak,
    history %in% c("Omicron_vaccine", "Omicron_star_vaccine") ~ bivalent_peak,
    .default = NA
  )) %>%
  mutate(Monovalent_endpoint = case_when(
    history %in% c("Vaccine")  ~ monovalent_peak, ## 40% of the max protection
    history %in% c("Delta_vaccine") ~ monovalent_peak,
    history %in% c("WT_vaccine") ~ monovalent_peak,
    history %in% c("Omicron_vaccine", "Omicron_star_vaccine") ~ monovalent_peak,
    .default = NA
  ))

######## make unknown serotypes #########

######## serotype of length 2 - unknown #######
adds <- savefile %>%
  mutate(history = case_when(
    history %in% c("WT", "Delta", "Vaccine", "Omicron", "Omicron_star") ~ "length 1",
    history %in% c("WT_vaccine", "Omicron_vaccine", "Delta_vaccine", "Omicron_star_vaccine") ~ "length 2"
  )) %>% 
  group_by(history) %>% 
  ## average for each wave by length
  summarise(WT = mean(WT), Delta = mean(Delta), Omicron = mean(Omicron), Omicron_star = mean(Omicron_star)) %>%
  filter(history == "length 2") %>%
  ungroup() %>% mutate(Bivalent_penalty = NA, Monovalent_WTpenalty = NA, Monovalent_Ompenalty = NA,
                       # Monovalent_Omstarpenalty = NA,
                       Bivalent_efficacy = NA, Monovalent_efficacy = NA,
                       Bivalent_endpoint = NA, Monovalent_endpoint = NA)

savefile <- rbind(savefile, adds)

######### add length 4+ ########

new_row = c(history = "length 4+", WT = as.numeric(0.05), 
            Delta = as.numeric(0.05), Omicron = as.numeric(0.05),
            Omicron_star = as.numeric(0.05), 
            Bivalent_penalty = NA, Monovalent_WTpenalty = NA, Monovalent_Ompenalty = NA,
            Bivalent_efficacy = NA, Monovalent_efficacy = NA,
            Bivalent_endpoint = NA, Monovalent_endpoint = NA)

savefile <- rbind(savefile, new_row) %>%
  mutate(WT = as.numeric(WT), Delta = as.numeric(Delta), 
         Omicron = as.numeric(Omicron), Omicron_star = as.numeric(Omicron_star),
         Bivalent_penalty = as.numeric(Bivalent_penalty), 
         Monovalent_WTpenalty = as.numeric(Monovalent_WTpenalty),
         Monovalent_Ompenalty = as.numeric(Monovalent_Ompenalty),
         Bivalent_efficacy = as.numeric(Bivalent_efficacy),
         Monovalent_efficacy = as.numeric(Monovalent_efficacy), 
         Bivalent_endpoint = as.numeric(Bivalent_endpoint),
         Monovalent_endpoint = as.numeric(Monovalent_endpoint))


######## add length 3 halfway between length 2 and length 3 ########

means <- savefile %>% filter(history == "length 2" | history == "length 4+") %>%
  summarise(WT = mean(WT), Delta = mean(Delta), Omicron = mean(Omicron), Omicron_star = mean(Omicron_star)) %>%
  mutate(Bivalent_penalty = NA, Monovalent_WTpenalty = NA, Monovalent_Ompenalty = NA,
         Bivalent_efficacy = NA, Monovalent_efficacy = NA,
         Bivalent_endpoint = NA, Monovalent_endpoint = NA) %>%
  add_column(history = "length 3", .before = "WT")

savefile <- rbind(savefile, means)

##### Get Omicron column - but bump bivalent by 0.05 and monovalent Omicron by 0.1

savefile <- savefile %>% 
  mutate(Monovalent_Omefficacy = Monovalent_efficacy,
         Monovalent_Omendpoint = Monovalent_endpoint) %>%
  rename(Monovalent_WTendpoint=Monovalent_endpoint,
         Monovalent_WTefficacy = Monovalent_efficacy) %>%
  pivot_longer(Bivalent_penalty:Monovalent_Omendpoint, 
               values_to = "protection_star", 
               names_to = "scenario") %>%
  mutate(protection_om = protection_star - 0.10) %>% ## account for adding the same bar but to an Omicron history instead of Omicron*
  mutate(protection_om = case_when(
    substr(scenario, 1, 3) == "Biv" ~ protection_om - 0.05,
    scenario %in% c("Monovalent_Omefficacy", "Monovalent_Ompenalty","Monovalent_Omendpoint") ~ protection_om-0.1,
    scenario %in% c("Monovalent_WTefficacy", "Monovalent_WTendpoint", "Monovalent_WTpenalty") ~ protection_om
  )) %>% 
  mutate(scenario_om = paste(scenario, "_Omicron"),
         scenario_om = gsub(" ", "", scenario_om))


test1 <- savefile %>% select(-c(scenario_om, protection_om))%>%
  mutate(protection_star = if_else(protection_star <= 1, protection_star, 1),
         protection_star = if_else(protection_star >=0, protection_star, 0)) %>%
  pivot_wider(names_from = scenario, values_from = protection_star) 

test2 <- savefile %>% select(-c(scenario,protection_star)) %>%
  mutate(protection_om = if_else(protection_om <= 1, protection_om, 1),
         protection_om = if_else(protection_om >=0, protection_om, 0)) %>%
  pivot_wider(names_from = scenario_om, values_from = protection_om)

test_full <- left_join(test1, test2, by = c("history", "WT", "Delta","Omicron", "Omicron_star"))


savefile_supplement <- test_full %>% arrange(history) %>% 
  pivot_longer(2:23, names_to = "type", values_to = "values") %>% 
  mutate(values = round(values, 2),
         values = if_else(
           values > 1, 1, values
         )) %>% 
  mutate(values = round(values, 2),
         values = if_else(
           values < 0, 0, values
         )) %>% 
  pivot_wider(names_from = "type", values_from = "values") %>% 
  arrange(history)
```
#### Grid

```{r}

b <- c(1)#, 300/90)
SAR <- c(1.1*0.427, 1.3*0.427)#c(0.427) ##, 0.512)
w  <- 1/300
scenario <- c("penalty", "WTpenalty","Ompenalty","efficacy", "endpoint", "Omefficacy", "Omendpoint","WTefficacy", "WTendpoint")
booster <- c("Bivalent", "Monovalent")
vaccine_star <- c("no")
boost_shape <- c("functional")
speed <- c("fast", "slow")

## scale level of protection against infection relative to protection against severity
inf_vs_sev <- c(0.8)

age_wt <- read_csv("../Data/ABM_Parameters_Data/age_table.csv") %>%
  rename(age = 1, Ecuador = 2, India = 3, Malaysia = 4) %>%
  pivot_longer(2:4, names_to = "Name", values_to = "count") %>%
  ## mutate(count = if_else(Name == "India", count/(10^6),count/(10^6))) %>%
  mutate(count = as.integer(count)) %>%
  pivot_wider(names_from = age, values_from = "count") %>%
  rename(child = 2, adult = 3, old = 4) %>% 
  mutate(child = child/Total, adult = adult/Total, old=old/Total)

contact <- read_excel("../Data/ABM_Parameters_Data/ContactRates_AgeCountry.xlsx") %>% 
  mutate(indices = 1:17) %>%
  mutate(Name = case_when(
    indices <=6 ~ "India",
    indices >6 & indices <= 12 ~ "Ecuador",
    indices >12 ~ "Malaysia"
  )) %>% 
  select(age = 1, child = 2, adult = 3, old = 4, Name) %>% 
  mutate(child = as.numeric(child), adult = as.numeric(adult), old = as.numeric(old)) %>%
  filter(!is.na(child)) %>% 
  mutate(tot = child + adult + old) %>% 
  select(Name, age, tot) %>% 
  pivot_wider(names_from = age, values_from = tot) %>% 
  # read_excel("../../../Parametrization Data/Contacts/Contact_Reformat.xlsx") %>%
  mutate(contact_total = 0.25*(child*age_wt$child + adult*age_wt$adult + elderly*age_wt$old)) %>%
  group_by(Name) %>%
  summarise(c_LL = 0.7*0.6*contact_total, c_LH = 0.7*0.4*contact_total, 
            c_HH = 0.4*0.6*contact_total, c_HL = 0.4*0.4*contact_total) %>%
  ungroup()


df <- expand_grid(replicate=1:500, b = b, SAR=SAR, w =w, 
                  booster = booster, scenario = scenario,
                  inf_vs_sev = inf_vs_sev,
                  vaccine_star = vaccine_star,
                  boost_shape = boost_shape,
                  speed = speed
                  ) %>% 
  mutate(remove = case_when(
    booster == "Bivalent" & scenario == "WTpenalty" ~ "yes",
    booster == "Bivalent" & scenario == "Ompenalty" ~ "yes",
    booster == "Bivalent" & scenario == "WTefficacy"~ "yes",
    booster== "Bivalent" & scenario =="Omefficacy"~ "yes",
    booster == "Bivalent" & scenario =="WTendpoint" ~"yes",
    booster == "Bivalent" & scenario == "Omendpoint" ~ "yes",
    booster == "Monovalent" & scenario == "penalty" ~ "yes",
    booster == "Monovalent" & scenario == "efficacy" ~ "yes",
    booster == "Monovalent" & scenario == "endpoint" ~ "yes",
    .default = "no"
  )) %>% 
  filter(remove == "no")
  

test <- df%>%select(booster,scenario) %>%distinct()
  
  ## Rules: Want c_HH to have roughly 1 contact as the basis and then multiply by 0.2. Then 30% reduction in contact for low SES and 
  ## 60% for high SES. Assume 60% of contact is within group, 40% is out group. 
  
age <- read_csv("../Data/ABM_Parameters_Data/age_table.csv") %>%
  rename(age = 1, Ecuador = 2, India = 3, Malaysia = 4) %>%
  pivot_longer(2:4, names_to = "Name", values_to = "count") %>%
 ## mutate(count = if_else(Name == "India", count/(10^6),count/(10^6))) %>%
  mutate(count = as.integer(count)) %>%
  pivot_wider(names_from = age, values_from = "count") %>%
  rename(child = 2, adult = 3, old = 4) %>%
  mutate(child = as.integer(0.5*(10^5)*child/Total), ## CHANGE BACK TO 10^5
         adult = as.integer(0.5*(10^5)*adult/Total),
         old = as.integer(0.5*(10^5)*old/Total)) %>%
  ## check that pop is 500,000
  mutate(Total = child+adult+old) %>%
  mutate(Total = NULL)

paramsH <- read_csv("../Data/ABM_Parameters_Data/paramsTable.csv") %>% filter(Name %in% c("Malaysia", "India", "Ecuador")) %>% filter(SES == "H") %>%
  rename(MH = 3, WH = 4, hH = 5) %>%
  summarise(Name, MH, WH, hH)
paramsL <- read_csv("../Data/ABM_Parameters_Data/paramsTable.csv") %>% filter(Name %in% c("Malaysia", "India", "Ecuador")) %>% filter(SES == "L") %>%
  rename(ML = 3, WL = 4, hL = 5) %>%
  summarise(Name, ML, WL, hL) 
params <- inner_join(paramsH, paramsL)


## calculate booster proportions
## Pops: I: 1B, E: 17.5 m, M: 28.6 m
##Max booster: I: 227 m, E: 10.5 m, M: 17.1

## India: 
## 24.0% of the pop is children
## Based on original vaccines, of the boosted population, we expect 0.93/(0.93 + 0.78) = 0.54% are high SES and 0.78/(0.93+0.78) = 0.46% are low SES
## High SES: Vm = 0.93, 500m, leaves 465m high SES vaccinated, of which 353.4 are non-children -- boosters 227*0.54 = 122.58, 122.58/353.4 = 0.35 of vaccinated get a booster
## Low SES: Vm = 0.78, 500m, leaves 390m low SES vaccinated, of which 296.4 are non-children -- boosters 227*0.46 = 104.42, 104.42/296.4 = .35 of vaccinated get a booster

## Malaysia: 
## 21.5% of the pop is children
## 0.97/(0.97+0.72) = 0.57 and 0.72/(0.97+0.72) = 0.43
## High SES: Vm = 0.97, 14.3m, leaves 13.87 vaccinated of which 10.89 are eligible -- boosters 17.1*0.57 = 9.747, 9.747/10.89 = 0.90 of vaccinated gets boosted 
## Low SES: Vm = 0.72, 14.3m, leaves 10.30 vaccinated of which  8.09 eligible -- boosters 17.1*0.43 = 7.353, 7.353/8.09 = 0.91 of vaccinated get boosted

## Ecuador: 
## 23.6% is children
## 1, 0.79 -- 1/(1+0.79) = 0.56 and 0.44
## High SES: Vm = 1, 8.75m, leaves 8.75m vaccinated of which 6.685 eligible -- boosters 10.5*0.56 = 5.88, 5.88/6.685 = 0.88
## Low SES: Vm = 0.79, 8.75m, leaves 6.9125 vaccinated of which 5.281 eligible-- boosters 10.5*0.44 = 4.62, 4.62/5.281 = 0.87

## what the above numbers mean: of the eligible group (adults), X% gets vaccinated
## these are NOT total pop numbers

fullpar <- inner_join(params, age) %>% 
  mutate(MH_boost = case_when(
    Name == "India" ~ "0.35",
    Name == "Malaysia" ~ "0.90",
    Name == "Ecuador" ~ "0.88"
  ),
  ML_boost = case_when(
    Name == "India" ~ "0.35",
    Name == "Malaysia" ~ "0.91",
    Name == "Ecuador" ~ "0.87"
  )
  ,
 MH_boost = as.numeric(MH_boost),
         ML_boost = as.numeric(ML_boost)
  )


dfM <- df %>% mutate(Name = "Malaysia")
dfE <- df %>% mutate(Name = "Ecuador")
dfI <- df %>% mutate(Name = "India")


stringency <- read_excel("../Data/ABM_Parameters_Data/Stringency.xlsx")

df <- rbind(dfM, dfE) %>%
  rbind(dfI) %>%
  left_join(fullpar) %>%
  left_join(stringency %>% rename(Name = country)) %>%
  arrange(replicate) %>% 
  left_join(contact) %>%
  add_column(variant_test = "NA", .after = "string_om2")
##%>% filter(Name == "India")


serotypes_star <- savefile_supplement %>% 
  select(history, Bivalent_penalty, Bivalent_efficacy, Bivalent_endpoint, 
         Monovalent_WTpenalty,Monovalent_Ompenalty, 
         Monovalent_WTefficacy, Monovalent_Omefficacy,
         Monovalent_WTendpoint, Monovalent_Omendpoint) %>% 
  pivot_longer(Bivalent_penalty:Monovalent_Omendpoint, names_to = "names", values_to = "values") %>% 
  separate(names, into = c("booster", "scenario"), sep = "_") %>%
  filter(!is.na(values)) %>%
  pivot_wider(names_from = history, values_from = values)
  

serotypes_Omicron <- savefile_supplement %>% 
  select(history, Bivalent_penalty_Omicron, Bivalent_efficacy_Omicron, Bivalent_endpoint_Omicron, 
         Monovalent_WTpenalty_Omicron,Monovalent_Ompenalty_Omicron, 
         Monovalent_WTefficacy_Omicron, Monovalent_Omefficacy_Omicron,
         Monovalent_WTendpoint_Omicron, Monovalent_Omendpoint_Omicron) %>% 
  pivot_longer(Bivalent_penalty_Omicron:Monovalent_Omendpoint_Omicron, names_to = "names", values_to = "values") %>% 
  separate(names, into = c("booster", "scenario"), sep = "_") %>%
  filter(!is.na(values)) %>%
  pivot_wider(names_from = history, values_from = values) %>%
  rename(Delta_vaccine_Om = Delta_vaccine,
         Omicron_star_vaccine_Om = Omicron_star_vaccine,
         Omicron_vaccine_Om = Omicron_vaccine,
         Vaccine_Om = Vaccine,
         WT_vaccine_Om = WT_vaccine)

serotypes <- left_join(serotypes_star, serotypes_Omicron, by = c("booster","scenario")) 

df_everything <- left_join(df, serotypes, by = c("booster","scenario")) %>%
  mutate(boost = "yes")

df_everything <- df_everything %>%
  mutate(
    WH_boost = case_when(
      speed == "slow" ~ WH,
      speed== "fast" ~ WH - 10
    ),
    WL_boost = case_when(
      speed == "slow" ~ WL,
      speed== "fast" ~ WL - 10
    )
  )

##### make no booster scenario #######

# df_noboost <- df_everything %>% 
#   filter(scenario == "WTpenalty", booster == "Monovalent", boost_shape == "functional", speed == "slow") %>% 
#   mutate(scenario = "no booster", booster = "no booster", boost_shape = "no booster", speed = "no booster") %>% 
#   mutate(boost = "no")
#   
# df_everything <- rbind(df_everything, df_noboost) %>% arrange(replicate) %>%
#   filter(boost_shape == "functional" | boost_shape== "no booster") %>%
#   arrange(replicate)
# 
# test <- df_everything %>% filter(scenario == "no booster")

##### get non-child proportions #####

nonchild <- age_wt %>% 
  group_by(Name) %>%
  summarise(nonchild = 1-child) %>% 
  ungroup()

df_everything <- df_everything %>% 
  left_join(nonchild)

## filter
df_everything <- df_everything %>% 
  filter(speed != "slow") %>%
  filter(SAR == 1.3*0.427) %>%
  filter(scenario %in% c("no booster", "WTpenalty", "Ompenalty", "penalty"))

## extra filter

# df_everything <- df_everything %>% 
#   filter(scenario =="no booster", Name == "Malaysia")

write_csv(df_everything, "../Data/ABM_Parameters_Data/Grid_Param_supp7.csv")

```

#### concatenate
```{r message=FALSE}
fileNames <- list.files(path="../Data/ABM Supplement/supp7-100boostereff/output_files_AS", 
                     pattern=".csv", all.files=TRUE,full.names=TRUE)

grid_v1 <- read_csv("../Data/ABM_Parameters_Data/Grid_Param_supp7.csv") %>%
  mutate(indexID = row_number())

df_info_v1 <- tibble(fileNames = fileNames) %>% 
  mutate(indexID = str_remove(fileNames, "../Data/ABM Supplement/supp7-100boostereff/output_files_AS/output_1x_ID_")) %>%
  mutate(indexID = str_remove(indexID, ".csv")) %>%
  mutate(indexID = parse_number(indexID)) %>% right_join(grid_v1) %>% filter(!is.na(fileNames))

df_v1 <- df_info_v1$fileNames %>% map_dfr(read_csv)

df_v1 <- df_v1 %>% select(-`...1`) %>%
  right_join(grid_v1)

write_csv(df_v1, "../Data/ABM Supplement/supp7-100boostereff/concatenated data/df_AS.csv")

gc()

```


##### dataAll
```{r}

dataAll <- df_v1 %>%
  # read_csv("../Data/ABM Supplement/supp6-delayed_rollout/concatenated data/df_AS1.csv") %>%
  # rbind(read_csv("../Data/ABM Supplement/supp6-delayed_rollout/concatenated data/df_AS.csv")) %>%
  select(Name, speed, vaccine_star, boost_shape, SAR, booster, scenario, boost, N, Inf_H, Inf_L, Dead_H, Dead_L, cum_cases_H, cum_cases_L, replicate, time, vaccinatedH,vaccinatedL, boostedH, boostedL) %>%
  #pivot_longer(count_Naive:count_Vaccine_boost, names_to = "history_types", values_to = "history_counts") %>%
  select(Name, speed, vaccine_star, boost_shape, SAR, booster, scenario, boost, N, Inf_H, Inf_L, Dead_H, Dead_L, cum_cases_H, cum_cases_L, replicate, time, vaccinatedH, vaccinatedL, boostedH, boostedL) %>% #count_Naive:count_Vaccine_boost) %>%
  mutate(country = Name, 
         time = as.integer(time), 
         infections_over_time = Inf_L+Inf_H, 
         infections_perc_over_time = 100*(Inf_L+Inf_H)/N,
         deaths_over_time = Dead_L + Dead_H, 
         deaths_perc_over_time = 100*(Dead_L + Dead_H)/N,
         cum_sum_Inf = cum_cases_H+cum_cases_L,
         cum_sum_per_N = (cum_cases_H + cum_cases_L)/N,
         boosted_over_time = boostedH+boostedL,
         boosted_perc_over_time = 100*(boostedH + boostedL)/N,
         vaccinated_over_time = vaccinatedH+vaccinatedL,
         vaccinated_perc_over_time = 100*(vaccinatedH + vaccinatedL)/N) %>%
  group_by(scenario, speed, vaccine_star, boost_shape, SAR, booster, boost, country, replicate) %>%
  mutate(ID_runs = cur_group_id()) %>% ungroup() %>%
  # select(ID_runs, speed, SAR, scenario, vaccine_star, boost_shape, booster, boost, country,
  #        replicate, time, N, infections_over_time:cum_sum_Inf, vaccinated, boosted) %>%
  #mutate(history_types = gsub("count_", "", history_types)) %>%
  #mutate(dummy = NULL) %>%
  arrange(ID_runs) %>%
  #filter(seed_WT == "yes") %>%
  select(-ID_runs) %>% filter(!is.na(time)) %>%
  group_by(SAR, scenario, speed,vaccine_star, boost_shape,booster,boost,country,replicate) %>%
  mutate(ID_runs = cur_group_id()) %>% ungroup() #%>%
  #select(SAR, speed, replicate,scenario,vaccine_star, boost_shape,booster,boost,country,time:cum_sum_Inf, vaccinated, boosted)

write_csv(dataAll, "../Data/ABM Supplement/supp7-100boostereff/dataAll.csv")

```

### ABM Supp 8: Italian booster eff

#### titers
```{r}

########## Man. paper #########

## neutralizing antibody titres
dataMan <- read_excel("../Data/ABM_Parameters_Data/Manali et al/New_Supplementary_Data_File.xlsx") %>% 
  select(doses = `Number of Vaccine Doses`, Group, 
         WT = `Wuhan Titre`, Delta = `Delta Titre`, Omicron = `Omicron Titre`) %>% 
  filter(doses > 1 | doses == 0) %>% ## 2 or more doses
  filter(Group != "I_Av" & Group != "I_A" & Group != "N") %>%
  mutate(
    History = case_when(
      Group == "I_Wv" ~ "WT_vaccine",
      Group == "I_W" ~ "WT",
      Group == "I_Dv" ~ "Delta_vaccine",
      Group == "I_D" ~ "Delta",
      Group == "V" ~ "Vaccine")) %>% 
  select(History, WT, Delta, Omicron) %>% 
  pivot_longer(WT:Omicron, names_to = "Variant", values_to = "Titre")

######## data_Surya #######
  
##unvaccinated and hybrid individuals, NT50 - 2-3 doses
data_Surya <- read_excel("../Data/ABM_Parameters_Data/Suryawanshi et al. 2022/reformat.xlsx") %>% 
  select(History = history, WT = WA1, Delta, Omicron) %>% 
  pivot_longer(WT:Omicron, names_to = "Variant", values_to = "Titre")


######### Test plot ########

test_Man <- dataMan %>% mutate(paper = "Man") 
test_Surya <- data_Surya %>% mutate(paper = "Surya")

plot_check <- test_Man %>% rbind(test_Surya) %>% 
  filter(History != "Naive") %>% 
  group_by(History, Variant, paper) %>%
  mutate(Titre = as.numeric(Titre), 
         Titre = if_else(Titre < 1, 1, Titre)) %>% ## clean out -Inf values - if someone's titre is 0, approximate it by 1
  mutate(Titre = log10(Titre)) %>% 
  summarise(Titre = mean(Titre, na.rm = T)) %>% 
  ggplot(aes(x = History, y = Titre, group = History, fill = History)) + 
  geom_col(position = "dodge") + 
  facet_grid(paper~Variant)
plot_check

#ggsave("Show_titres.pdf", plot_check, width = 12, height = 8)


########## Get full table #########

## get an immunity table combining all sources
fullDat <- rbind(dataMan, data_Surya) %>% 
  filter(History != "Naive") %>% 
  mutate(Titre = as.numeric(Titre)) %>% 
  mutate(
    Titre = if_else(Titre < 1, 1, Titre), ## clean out -Inf - if titre is between 0-1, approximate it by 1
    Titre = log10(Titre) ## get log scale titre
  ) %>% 
  group_by(History, Variant) %>% 
  summarise(
    Titre = mean(Titre, na.rm = T), ## grab mean log titre
         minuslogTitre = -Titre) %>% ## get minus log titre since we want to scale a reduction in a param
  ungroup() %>% 
  mutate(paramfinal = rescale(minuslogTitre, to = c(0.05, 0.95))) %>% 
  arrange(paramfinal) %>% 
  select(Serotype = History, variant = Variant, paramfinal) %>% 
  mutate(paramfinal = round(paramfinal, 2))

## test 
plot <- fullDat %>% 
  mutate(variant = fct_relevel(variant, c("WT", "Delta", "Omicron"))) %>% 
  ggplot(aes(x = variant, y = Serotype, fill = 1-paramfinal)) + 
  geom_tile() + 
  scale_fill_viridis_c()
plot

## get transition between WT to Delta
fullDat_transition <- fullDat %>% 
  pivot_wider(names_from = "variant", values_from = "paramfinal") %>% 
  mutate(diffWT_to_DT = round(mean(Delta-WT),2), diffDT_to_Om = round(mean(Omicron-Delta),2))

lineage_change <- fullDat_transition$diffWT_to_DT[1]

## transition from WT to Delta: lineage_change
  
savefile <- fullDat %>% 
  pivot_wider(names_from = Serotype, values_from = paramfinal)


## get the difference from a vaccine to get the Omicron serotype
diff_file <- savefile %>% 
  mutate(Delta_vax_diff = Delta_vaccine - Delta,
         WT_vax_diff = WT_vaccine - WT,
         Omicron_vax_diff = Omicron_vaccine - Omicron,
         Vax_diff = Vaccine - 1) ##this is the base change for ppl getting a vaccine


savefile <- savefile %>% 
  ## rule: Omicron = Omicron_vaccine - vaccine benefit i.e. the change for Delta
  #mutate(Omicron = Omicron_vaccine - diff_file$Delta_vax_diff) %>% 
  mutate(Omicron_star = if_else(Omicron+lineage_change <= 1, Omicron + lineage_change, 1),
         Omicron_star_vaccine = if_else(Omicron_vaccine + lineage_change <=1, Omicron_vaccine+lineage_change, 1))


#### New scheme ####

Booster_Bump_WT <- diff_file %>% filter(variant == "WT") %>% select("WT_vax_diff")
Booster_Bump_Delta <- diff_file %>% filter(variant == "WT") %>% select("Delta_vax_diff")
Booster_Bump_Omicron <- diff_file %>% filter(variant == "WT") %>% select("Omicron_vax_diff")
Booster_Bump_Vaccine <- diff_file %>% filter(variant == "WT") %>% select("Vax_diff")

avg_change <- (Booster_Bump_WT$WT_vax_diff + 
                 Booster_Bump_Delta$Delta_vax_diff +
                 Booster_Bump_Omicron$Omicron_vax_diff +
                 Booster_Bump_Vaccine$Vax_diff)/4


######## make omicron* wave ########

savefile <- savefile %>% pivot_longer(-variant, 
                                      names_to = "history", 
                                      values_to = "paramfinal") %>% 
  pivot_wider(names_from = variant, values_from = paramfinal) %>% 
  mutate(Omicron_star = if_else(history == "Omicron_star" | history == "Omicron_star_vaccine",
                                Omicron-lineage_change, 
                                Omicron + lineage_change)) %>% 
  mutate(Omicron_star = if_else(Omicron_star <= 1, Omicron_star, 1)) %>%
  mutate(Omicron_star = if_else(Omicron_star >=0, Omicron_star, 0))

####### add bivalent and monovalent (40% of bivalent) booster ##########

## Assume that the bivalent takes us back to original vaccine efficacy, the monovalent is 40% of the bivalent


###### hypothesis 1: history penalty ######

## how to treat Omicron* in this regime - like an Omicron lineage?

savefile <- savefile %>% 
  mutate(Bivalent_penalty = case_when(
    history %in% c("Vaccine")  ~ Omicron_star + Booster_Bump_Vaccine$Vax_diff,
    history %in% c("Delta_vaccine") ~ Omicron_star + Booster_Bump_Delta$Delta_vax_diff,
    history %in% c("WT_vaccine") ~ Omicron_star + 0.5*(Booster_Bump_WT$WT_vax_diff + Booster_Bump_Omicron$Omicron_vax_diff),
    history %in% c("Omicron_vaccine","Omicron_star_vaccine") ~ Omicron_star + 0.5*(Booster_Bump_Omicron$Omicron_vax_diff + Booster_Bump_WT$WT_vax_diff),
    .default = NA
  )) %>%
  mutate(Monovalent_WTpenalty = case_when(
    history %in% c("Vaccine")  ~ Omicron_star + 0.53*Booster_Bump_Vaccine$Vax_diff,
    history %in% c("Delta_vaccine") ~ Omicron_star + 0.53*Booster_Bump_Delta$Delta_vax_diff,
    history %in% c("WT_vaccine") ~ Omicron_star + 0.53*Booster_Bump_WT$WT_vax_diff,
    history %in% c("Omicron_vaccine", "Omicron_star_vaccine") ~ Omicron_star + 0.53*Booster_Bump_Omicron$Omicron_vax_diff,
    .default = NA
  )) %>% 
  mutate(Monovalent_Ompenalty = case_when(
    history %in% c("Vaccine")  ~ Omicron_star + 0.53*Booster_Bump_Vaccine$Vax_diff,
    history %in% c("Delta_vaccine") ~ Omicron_star + 0.53*Booster_Bump_Delta$Delta_vax_diff,
    history %in% c("WT_vaccine") ~ Omicron_star + 0.53*Booster_Bump_Omicron$Omicron_vax_diff,
    history %in% c("Omicron_vaccine","Omicron_star_vaccine") ~ Omicron_star + 0.53*Booster_Bump_WT$WT_vax_diff,
    .default = NA
  )) 

###### hypothesis 2: everyone gets same benefit --  average change in the data ######

savefile <- savefile %>% 
  mutate(Bivalent_efficacy = case_when(
    history %in% c("Vaccine")  ~ Omicron_star + (avg_change),
    history %in% c("Delta_vaccine") ~ Omicron_star + (avg_change),
    history %in% c("WT_vaccine") ~ Omicron_star + (avg_change),
    history %in% c("Omicron_vaccine", "Omicron_star_vaccine") ~ Omicron_star + (avg_change),
    .default = NA
  )) %>%
  mutate(Monovalent_efficacy = case_when(
    history %in% c("Vaccine")  ~ Omicron_star + 0.53*(avg_change),
    history %in% c("Delta_vaccine") ~ Omicron_star + 0.53*(avg_change),
    history %in% c("WT_vaccine") ~ Omicron_star + 0.53*(avg_change),
    history %in% c("Omicron_vaccine", "Omicron_star_vaccine") ~ Omicron_star + 1*(avg_change),
    .default = NA
  ))

####### hypothesis 3: everyone goes to the min protection  of the same efficacy scenarios #####

bivalent_peak <- min(savefile$Bivalent_efficacy,na.rm = T)
monovalent_peak <- min(savefile$Monovalent_efficacy,na.rm = T)


savefile <- savefile %>% 
  mutate(Bivalent_endpoint = case_when(
    history %in% c("Vaccine")  ~ bivalent_peak,
    history %in% c("Delta_vaccine") ~ bivalent_peak,
    history %in% c("WT_vaccine") ~ bivalent_peak,
    history %in% c("Omicron_vaccine", "Omicron_star_vaccine") ~ bivalent_peak,
    .default = NA
  )) %>%
  mutate(Monovalent_endpoint = case_when(
    history %in% c("Vaccine")  ~ monovalent_peak, ## 40% of the max protection
    history %in% c("Delta_vaccine") ~ monovalent_peak,
    history %in% c("WT_vaccine") ~ monovalent_peak,
    history %in% c("Omicron_vaccine", "Omicron_star_vaccine") ~ monovalent_peak,
    .default = NA
  ))

######## make unknown serotypes #########

######## serotype of length 2 - unknown #######
adds <- savefile %>%
  mutate(history = case_when(
    history %in% c("WT", "Delta", "Vaccine", "Omicron", "Omicron_star") ~ "length 1",
    history %in% c("WT_vaccine", "Omicron_vaccine", "Delta_vaccine", "Omicron_star_vaccine") ~ "length 2"
  )) %>% 
  group_by(history) %>% 
  ## average for each wave by length
  summarise(WT = mean(WT), Delta = mean(Delta), Omicron = mean(Omicron), Omicron_star = mean(Omicron_star)) %>%
  filter(history == "length 2") %>%
  ungroup() %>% mutate(Bivalent_penalty = NA, Monovalent_WTpenalty = NA, Monovalent_Ompenalty = NA,
                       # Monovalent_Omstarpenalty = NA,
                       Bivalent_efficacy = NA, Monovalent_efficacy = NA,
                       Bivalent_endpoint = NA, Monovalent_endpoint = NA)

savefile <- rbind(savefile, adds)

######### add length 4+ ########

new_row = c(history = "length 4+", WT = as.numeric(0.05), 
            Delta = as.numeric(0.05), Omicron = as.numeric(0.05),
            Omicron_star = as.numeric(0.05), 
            Bivalent_penalty = NA, Monovalent_WTpenalty = NA, Monovalent_Ompenalty = NA,
            Bivalent_efficacy = NA, Monovalent_efficacy = NA,
            Bivalent_endpoint = NA, Monovalent_endpoint = NA)

savefile <- rbind(savefile, new_row) %>%
  mutate(WT = as.numeric(WT), Delta = as.numeric(Delta), 
         Omicron = as.numeric(Omicron), Omicron_star = as.numeric(Omicron_star),
         Bivalent_penalty = as.numeric(Bivalent_penalty), 
         Monovalent_WTpenalty = as.numeric(Monovalent_WTpenalty),
         Monovalent_Ompenalty = as.numeric(Monovalent_Ompenalty),
         Bivalent_efficacy = as.numeric(Bivalent_efficacy),
         Monovalent_efficacy = as.numeric(Monovalent_efficacy), 
         Bivalent_endpoint = as.numeric(Bivalent_endpoint),
         Monovalent_endpoint = as.numeric(Monovalent_endpoint))


######## add length 3 halfway between length 2 and length 3 ########

means <- savefile %>% filter(history == "length 2" | history == "length 4+") %>%
  summarise(WT = mean(WT), Delta = mean(Delta), Omicron = mean(Omicron), Omicron_star = mean(Omicron_star)) %>%
  mutate(Bivalent_penalty = NA, Monovalent_WTpenalty = NA, Monovalent_Ompenalty = NA,
         Bivalent_efficacy = NA, Monovalent_efficacy = NA,
         Bivalent_endpoint = NA, Monovalent_endpoint = NA) %>%
  add_column(history = "length 3", .before = "WT")

savefile <- rbind(savefile, means)

##### Get Omicron column - but bump bivalent by 0.05 and monovalent Omicron by 0.1

savefile <- savefile %>% 
  mutate(Monovalent_Omefficacy = Monovalent_efficacy,
         Monovalent_Omendpoint = Monovalent_endpoint) %>%
  rename(Monovalent_WTendpoint=Monovalent_endpoint,
         Monovalent_WTefficacy = Monovalent_efficacy) %>%
  pivot_longer(Bivalent_penalty:Monovalent_Omendpoint, 
               values_to = "protection_star", 
               names_to = "scenario") %>%
  mutate(protection_om = protection_star - 0.10) %>% ## account for adding the same bar but to an Omicron history instead of Omicron*
  mutate(protection_om = case_when(
    substr(scenario, 1, 3) == "Biv" ~ protection_om - 0.05,
    scenario %in% c("Monovalent_Omefficacy", "Monovalent_Ompenalty","Monovalent_Omendpoint") ~ protection_om-0.1,
    scenario %in% c("Monovalent_WTefficacy", "Monovalent_WTendpoint", "Monovalent_WTpenalty") ~ protection_om
  )) %>% 
  mutate(scenario_om = paste(scenario, "_Omicron"),
         scenario_om = gsub(" ", "", scenario_om))


test1 <- savefile %>% select(-c(scenario_om, protection_om))%>%
  mutate(protection_star = if_else(protection_star <= 1, protection_star, 1),
         protection_star = if_else(protection_star >=0, protection_star, 0)) %>%
  pivot_wider(names_from = scenario, values_from = protection_star) 

test2 <- savefile %>% select(-c(scenario,protection_star)) %>%
  mutate(protection_om = if_else(protection_om <= 1, protection_om, 1),
         protection_om = if_else(protection_om >=0, protection_om, 0)) %>%
  pivot_wider(names_from = scenario_om, values_from = protection_om)

test_full <- left_join(test1, test2, by = c("history", "WT", "Delta","Omicron", "Omicron_star"))


savefile_supplement <- test_full %>% arrange(history) %>% 
  pivot_longer(2:23, names_to = "type", values_to = "values") %>% 
  mutate(values = round(values, 2),
         values = if_else(
           values > 1, 1, values
         )) %>% 
  mutate(values = round(values, 2),
         values = if_else(
           values < 0, 0, values
         )) %>% 
  pivot_wider(names_from = "type", values_from = "values") %>% 
  arrange(history)
```


#### Grid
```{r}

b <- c(1)#, 300/90)
SAR <- c(1.1*0.427, 1.3*0.427)#c(0.427) ##, 0.512)
w  <- 1/300
scenario <- c("penalty", "WTpenalty","Ompenalty","efficacy", "endpoint", "Omefficacy", "Omendpoint","WTefficacy", "WTendpoint")
booster <- c("Bivalent", "Monovalent")
vaccine_star <- c("no")
boost_shape <- c("functional")
speed <- c("fast", "slow")

## scale level of protection against infection relative to protection against severity
inf_vs_sev <- c(0.8)

age_wt <- read_csv("../Data/ABM_Parameters_Data/age_table.csv") %>%
  rename(age = 1, Ecuador = 2, India = 3, Malaysia = 4) %>%
  pivot_longer(2:4, names_to = "Name", values_to = "count") %>%
  ## mutate(count = if_else(Name == "India", count/(10^6),count/(10^6))) %>%
  mutate(count = as.integer(count)) %>%
  pivot_wider(names_from = age, values_from = "count") %>%
  rename(child = 2, adult = 3, old = 4) %>% 
  mutate(child = child/Total, adult = adult/Total, old=old/Total)

contact <- read_excel("../Data/ABM_Parameters_Data/ContactRates_AgeCountry.xlsx") %>% 
  mutate(indices = 1:17) %>%
  mutate(Name = case_when(
    indices <=6 ~ "India",
    indices >6 & indices <= 12 ~ "Ecuador",
    indices >12 ~ "Malaysia"
  )) %>% 
  select(age = 1, child = 2, adult = 3, old = 4, Name) %>% 
  mutate(child = as.numeric(child), adult = as.numeric(adult), old = as.numeric(old)) %>%
  filter(!is.na(child)) %>% 
  mutate(tot = child + adult + old) %>% 
  select(Name, age, tot) %>% 
  pivot_wider(names_from = age, values_from = tot) %>% 
  # read_excel("../../../Parametrization Data/Contacts/Contact_Reformat.xlsx") %>%
  mutate(contact_total = 0.25*(child*age_wt$child + adult*age_wt$adult + elderly*age_wt$old)) %>%
  group_by(Name) %>%
  summarise(c_LL = 0.7*0.6*contact_total, c_LH = 0.7*0.4*contact_total, 
            c_HH = 0.4*0.6*contact_total, c_HL = 0.4*0.4*contact_total) %>%
  ungroup()


df <- expand_grid(replicate=1:500, b = b, SAR=SAR, w =w, 
                  booster = booster, scenario = scenario,
                  inf_vs_sev = inf_vs_sev,
                  vaccine_star = vaccine_star,
                  boost_shape = boost_shape,
                  speed = speed
                  ) %>% 
  mutate(remove = case_when(
    booster == "Bivalent" & scenario == "WTpenalty" ~ "yes",
    booster == "Bivalent" & scenario == "Ompenalty" ~ "yes",
    booster == "Bivalent" & scenario == "WTefficacy"~ "yes",
    booster== "Bivalent" & scenario =="Omefficacy"~ "yes",
    booster == "Bivalent" & scenario =="WTendpoint" ~"yes",
    booster == "Bivalent" & scenario == "Omendpoint" ~ "yes",
    booster == "Monovalent" & scenario == "penalty" ~ "yes",
    booster == "Monovalent" & scenario == "efficacy" ~ "yes",
    booster == "Monovalent" & scenario == "endpoint" ~ "yes",
    .default = "no"
  )) %>% 
  filter(remove == "no")
  

test <- df%>%select(booster,scenario) %>%distinct()
  
  ## Rules: Want c_HH to have roughly 1 contact as the basis and then multiply by 0.2. Then 30% reduction in contact for low SES and 
  ## 60% for high SES. Assume 60% of contact is within group, 40% is out group. 
  
age <- read_csv("../Data/ABM_Parameters_Data/age_table.csv") %>%
  rename(age = 1, Ecuador = 2, India = 3, Malaysia = 4) %>%
  pivot_longer(2:4, names_to = "Name", values_to = "count") %>%
 ## mutate(count = if_else(Name == "India", count/(10^6),count/(10^6))) %>%
  mutate(count = as.integer(count)) %>%
  pivot_wider(names_from = age, values_from = "count") %>%
  rename(child = 2, adult = 3, old = 4) %>%
  mutate(child = as.integer(0.5*(10^5)*child/Total), ## CHANGE BACK TO 10^5
         adult = as.integer(0.5*(10^5)*adult/Total),
         old = as.integer(0.5*(10^5)*old/Total)) %>%
  ## check that pop is 500,000
  mutate(Total = child+adult+old) %>%
  mutate(Total = NULL)

paramsH <- read_csv("../Data/ABM_Parameters_Data/paramsTable.csv") %>% filter(Name %in% c("Malaysia", "India", "Ecuador")) %>% filter(SES == "H") %>%
  rename(MH = 3, WH = 4, hH = 5) %>%
  summarise(Name, MH, WH, hH)
paramsL <- read_csv("../Data/ABM_Parameters_Data/paramsTable.csv") %>% filter(Name %in% c("Malaysia", "India", "Ecuador")) %>% filter(SES == "L") %>%
  rename(ML = 3, WL = 4, hL = 5) %>%
  summarise(Name, ML, WL, hL) 
params <- inner_join(paramsH, paramsL)


## calculate booster proportions
## Pops: I: 1B, E: 17.5 m, M: 28.6 m
##Max booster: I: 227 m, E: 10.5 m, M: 17.1

## India: 
## 24.0% of the pop is children
## Based on original vaccines, of the boosted population, we expect 0.93/(0.93 + 0.78) = 0.54% are high SES and 0.78/(0.93+0.78) = 0.46% are low SES
## High SES: Vm = 0.93, 500m, leaves 465m high SES vaccinated, of which 353.4 are non-children -- boosters 227*0.54 = 122.58, 122.58/353.4 = 0.35 of vaccinated get a booster
## Low SES: Vm = 0.78, 500m, leaves 390m low SES vaccinated, of which 296.4 are non-children -- boosters 227*0.46 = 104.42, 104.42/296.4 = .35 of vaccinated get a booster

## Malaysia: 
## 21.5% of the pop is children
## 0.97/(0.97+0.72) = 0.57 and 0.72/(0.97+0.72) = 0.43
## High SES: Vm = 0.97, 14.3m, leaves 13.87 vaccinated of which 10.89 are eligible -- boosters 17.1*0.57 = 9.747, 9.747/10.89 = 0.90 of vaccinated gets boosted 
## Low SES: Vm = 0.72, 14.3m, leaves 10.30 vaccinated of which  8.09 eligible -- boosters 17.1*0.43 = 7.353, 7.353/8.09 = 0.91 of vaccinated get boosted

## Ecuador: 
## 23.6% is children
## 1, 0.79 -- 1/(1+0.79) = 0.56 and 0.44
## High SES: Vm = 1, 8.75m, leaves 8.75m vaccinated of which 6.685 eligible -- boosters 10.5*0.56 = 5.88, 5.88/6.685 = 0.88
## Low SES: Vm = 0.79, 8.75m, leaves 6.9125 vaccinated of which 5.281 eligible-- boosters 10.5*0.44 = 4.62, 4.62/5.281 = 0.87

## what the above numbers mean: of the eligible group (adults), X% gets vaccinated
## these are NOT total pop numbers

fullpar <- inner_join(params, age) %>% 
  mutate(MH_boost = case_when(
    Name == "India" ~ "0.35",
    Name == "Malaysia" ~ "0.90",
    Name == "Ecuador" ~ "0.88"
  ),
  ML_boost = case_when(
    Name == "India" ~ "0.35",
    Name == "Malaysia" ~ "0.91",
    Name == "Ecuador" ~ "0.87"
  )
  ,
 MH_boost = as.numeric(MH_boost),
         ML_boost = as.numeric(ML_boost)
  )


dfM <- df %>% mutate(Name = "Malaysia")
dfE <- df %>% mutate(Name = "Ecuador")
dfI <- df %>% mutate(Name = "India")


stringency <- read_excel("../Data/ABM_Parameters_Data/Stringency.xlsx")

df <- rbind(dfM, dfE) %>%
  rbind(dfI) %>%
  left_join(fullpar) %>%
  left_join(stringency %>% rename(Name = country)) %>%
  arrange(replicate) %>% 
  left_join(contact) %>%
  add_column(variant_test = "NA", .after = "string_om2")
##%>% filter(Name == "India")


serotypes_star <- savefile_supplement %>% 
  select(history, Bivalent_penalty, Bivalent_efficacy, Bivalent_endpoint, 
         Monovalent_WTpenalty,Monovalent_Ompenalty, 
         Monovalent_WTefficacy, Monovalent_Omefficacy,
         Monovalent_WTendpoint, Monovalent_Omendpoint) %>% 
  pivot_longer(Bivalent_penalty:Monovalent_Omendpoint, names_to = "names", values_to = "values") %>% 
  separate(names, into = c("booster", "scenario"), sep = "_") %>%
  filter(!is.na(values)) %>%
  pivot_wider(names_from = history, values_from = values)
  

serotypes_Omicron <- savefile_supplement %>% 
  select(history, Bivalent_penalty_Omicron, Bivalent_efficacy_Omicron, Bivalent_endpoint_Omicron, 
         Monovalent_WTpenalty_Omicron,Monovalent_Ompenalty_Omicron, 
         Monovalent_WTefficacy_Omicron, Monovalent_Omefficacy_Omicron,
         Monovalent_WTendpoint_Omicron, Monovalent_Omendpoint_Omicron) %>% 
  pivot_longer(Bivalent_penalty_Omicron:Monovalent_Omendpoint_Omicron, names_to = "names", values_to = "values") %>% 
  separate(names, into = c("booster", "scenario"), sep = "_") %>%
  filter(!is.na(values)) %>%
  pivot_wider(names_from = history, values_from = values) %>%
  rename(Delta_vaccine_Om = Delta_vaccine,
         Omicron_star_vaccine_Om = Omicron_star_vaccine,
         Omicron_vaccine_Om = Omicron_vaccine,
         Vaccine_Om = Vaccine,
         WT_vaccine_Om = WT_vaccine)

serotypes <- left_join(serotypes_star, serotypes_Omicron, by = c("booster","scenario")) 

df_everything <- left_join(df, serotypes, by = c("booster","scenario")) %>%
  mutate(boost = "yes")

df_everything <- df_everything %>%
  mutate(
    WH_boost = case_when(
      speed == "slow" ~ WH,
      speed== "fast" ~ WH - 10
    ),
    WL_boost = case_when(
      speed == "slow" ~ WL,
      speed== "fast" ~ WL - 10
    )
  )

##### make no booster scenario #######

# df_noboost <- df_everything %>% 
#   filter(scenario == "WTpenalty", booster == "Monovalent", boost_shape == "functional", speed == "slow") %>% 
#   mutate(scenario = "no booster", booster = "no booster", boost_shape = "no booster", speed = "no booster") %>% 
#   mutate(boost = "no")
#   
# df_everything <- rbind(df_everything, df_noboost) %>% arrange(replicate) %>%
#   filter(boost_shape == "functional" | boost_shape== "no booster") %>%
#   arrange(replicate)
# 
# test <- df_everything %>% filter(scenario == "no booster")

##### get non-child proportions #####

nonchild <- age_wt %>% 
  group_by(Name) %>%
  summarise(nonchild = 1-child) %>% 
  ungroup()

df_everything <- df_everything %>% 
  left_join(nonchild)

## filter
df_everything <- df_everything %>% 
  filter(speed != "slow") %>%
  filter(SAR == 1.3*0.427) %>%
  filter(scenario %in% c("no booster", "WTpenalty", "Ompenalty", "penalty"))

## extra filter

# df_everything <- df_everything %>% 
#   filter(scenario =="no booster", Name == "Malaysia")

write_csv(df_everything, "../Data/ABM_Parameters_Data/Grid_Param_supp8.csv")

```


#### concatenate
```{r message=FALSE}
fileNames <- list.files(path="../Data/ABM Supplement/supp8-53boostereff/output_files_AS", 
                     pattern=".csv", all.files=TRUE,full.names=TRUE)

grid_v1 <- read_csv("../Data/ABM_Parameters_Data/Grid_Param_supp8.csv") %>%
  mutate(indexID = row_number())

df_info_v1 <- tibble(fileNames = fileNames) %>% 
  mutate(indexID = str_remove(fileNames, "../Data/ABM Supplement/supp8-53boostereff/output_files_AS/output_1x_ID_")) %>%
  mutate(indexID = str_remove(indexID, ".csv")) %>%
  mutate(indexID = parse_number(indexID)) %>% right_join(grid_v1) %>% filter(!is.na(fileNames))

df_v1 <- df_info_v1$fileNames %>% map_dfr(read_csv)

df_v1 <- df_v1 %>% select(-`...1`) %>%
  right_join(grid_v1)

write_csv(df_v1, "../Data/ABM Supplement/supp8-53boostereff/concatenated data/df_AS.csv")

gc()

```

##### dataAll
```{r}

dataAll <- df_v1 %>%
  # read_csv("../Data/ABM Supplement/supp6-delayed_rollout/concatenated data/df_AS1.csv") %>%
  # rbind(read_csv("../Data/ABM Supplement/supp6-delayed_rollout/concatenated data/df_AS.csv")) %>%
  select(Name, speed, vaccine_star, boost_shape, SAR, booster, scenario, boost, N, Inf_H, Inf_L, Dead_H, Dead_L, cum_cases_H, cum_cases_L, replicate, time, vaccinatedH,vaccinatedL, boostedH, boostedL) %>%
  #pivot_longer(count_Naive:count_Vaccine_boost, names_to = "history_types", values_to = "history_counts") %>%
  select(Name, speed, vaccine_star, boost_shape, SAR, booster, scenario, boost, N, Inf_H, Inf_L, Dead_H, Dead_L, cum_cases_H, cum_cases_L, replicate, time, vaccinatedH, vaccinatedL, boostedH, boostedL) %>% #count_Naive:count_Vaccine_boost) %>%
  mutate(country = Name, 
         time = as.integer(time), 
         infections_over_time = Inf_L+Inf_H, 
         infections_perc_over_time = 100*(Inf_L+Inf_H)/N,
         deaths_over_time = Dead_L + Dead_H, 
         deaths_perc_over_time = 100*(Dead_L + Dead_H)/N,
         cum_sum_Inf = cum_cases_H+cum_cases_L,
         cum_sum_per_N = (cum_cases_H + cum_cases_L)/N,
         boosted_over_time = boostedH+boostedL,
         boosted_perc_over_time = 100*(boostedH + boostedL)/N,
         vaccinated_over_time = vaccinatedH+vaccinatedL,
         vaccinated_perc_over_time = 100*(vaccinatedH + vaccinatedL)/N) %>%
  group_by(scenario, speed, vaccine_star, boost_shape, SAR, booster, boost, country, replicate) %>%
  mutate(ID_runs = cur_group_id()) %>% ungroup() %>%
  # select(ID_runs, speed, SAR, scenario, vaccine_star, boost_shape, booster, boost, country,
  #        replicate, time, N, infections_over_time:cum_sum_Inf, vaccinated, boosted) %>%
  #mutate(history_types = gsub("count_", "", history_types)) %>%
  #mutate(dummy = NULL) %>%
  arrange(ID_runs) %>%
  #filter(seed_WT == "yes") %>%
  select(-ID_runs) %>% filter(!is.na(time)) %>%
  group_by(SAR, scenario, speed,vaccine_star, boost_shape,booster,boost,country,replicate) %>%
  mutate(ID_runs = cur_group_id()) %>% ungroup() #%>%
  #select(SAR, speed, replicate,scenario,vaccine_star, boost_shape,booster,boost,country,time:cum_sum_Inf, vaccinated, boosted)

write_csv(dataAll, "../Data/ABM Supplement/supp8-53boostereff/dataAll.csv")

```




### ODE supplement

#### Ecuador data - main runs
```{r}

end_ecuador_sweep<-readRDS('../Data/ODE outputs/endfile_sweep010424_ecuadorboost_Evax.RDS')
end_ecuador_sweep$popsize<-15735139
end_ecuador_sweep$deaths_100k<-(end_ecuador_sweep$DeathsAll/end_ecuador_sweep$popsize)*100000
end_noboost_ecuador<-subset(end_ecuador_sweep, end_ecuador_sweep$boost.adult==0)
end_boost_ecuador<-subset(end_ecuador_sweep, end_ecuador_sweep$boost.adult>0)
sum(end_ecuador_sweep[1,c(2:217)])
require(dplyr)
dfCompODE <- end_noboost_ecuador %>%
  select(deaths_100k, DeathsAll, relax) %>% 
  distinct()
names(dfCompODE)[1]<-'DeathsComp_per100k'
names(dfCompODE)[2]<-'DeathsComp'

df_AvertedODE <- end_boost_ecuador %>% 
  left_join(dfCompODE, by = c("relax")) %>% 
  mutate(da = (DeathsComp_per100k - deaths_100k)/DeathsComp_per100k) %>% 
  distinct() %>% 
  filter(
    veh2==0.657 | (veh2 == max(veh2) & vei2 == max(vei2))
  ) %>% 
  mutate(
    Booster = if_else(
      veh2 == 0.657, "Monovalent",
      "Bivalent"
    )
  )


df_AvertedODE$da_all<-(df_AvertedODE$DeathsComp-df_AvertedODE$DeathsAll)/df_AvertedODE$DeathsComp
dfAvert2<-df_AvertedODE[,c(218:ncol(df_AvertedODE))]
df_AvertedODE$relativeFOI<-paste(df_AvertedODE$relax*100, '% increase in FOI', sep='')
df_AvertedODE$boost.start.time<-paste('Start boosting ', df_AvertedODE$boost.start, ' days prior to omicron*')

fast<-subset(df_AvertedODE, df_AvertedODE$boost.start==60)
fast$deathsaverted_per100k<-fast$DeathsComp_per100k -fast$deaths_100k



load('../Data/ODE outputs/sweep_010424_ecuadorboost_Evax.RData')
model_out_dat$sweepnum<-rep(seq(from=1, to=27), each=196)
model_out_dat$Iall<-model_out_dat$Ich+model_out_dat$Ich2+model_out_dat$IVch+model_out_dat$IVch2+model_out_dat$IBch+model_out_dat$IBch2+
  model_out_dat$Iah+model_out_dat$Iah2+model_out_dat$IVah+model_out_dat$IVah2+model_out_dat$IBah+model_out_dat$IBah2+
  model_out_dat$Ieh+model_out_dat$Ieh2+model_out_dat$IVeh+model_out_dat$IVeh2+model_out_dat$IBeh+model_out_dat$IBeh2+
  model_out_dat$Icl+model_out_dat$Icl2+model_out_dat$IVcl+model_out_dat$IVcl2+model_out_dat$IBcl+model_out_dat$IBcl2+
  model_out_dat$Ial+model_out_dat$Ial2+model_out_dat$IVal+model_out_dat$IVal2+model_out_dat$IBal+model_out_dat$IBal2+
  model_out_dat$Iel+model_out_dat$Iel2+model_out_dat$IVel+model_out_dat$IVel2+model_out_dat$IBel+model_out_dat$IBel2+
  #
  model_out_dat$Ach+model_out_dat$Ach2+model_out_dat$AVch+model_out_dat$AVch2+model_out_dat$ABch+model_out_dat$ABch2+
  model_out_dat$Aah+model_out_dat$Aah2+model_out_dat$AVah+model_out_dat$AVah2+model_out_dat$ABah+model_out_dat$ABah2+
  model_out_dat$Aeh+model_out_dat$Aeh2+model_out_dat$AVeh+model_out_dat$AVeh2+model_out_dat$ABeh+model_out_dat$ABeh2+
  model_out_dat$Acl+model_out_dat$Acl2+model_out_dat$AVcl+model_out_dat$AVcl2+model_out_dat$ABcl+model_out_dat$ABcl2+
  model_out_dat$Aal+model_out_dat$Aal2+model_out_dat$AVal+model_out_dat$AVal2+model_out_dat$ABal+model_out_dat$ABal2+
  model_out_dat$Ael+model_out_dat$Ael2+model_out_dat$AVel+model_out_dat$AVel2+model_out_dat$ABel+model_out_dat$ABel2
model_out_dat$popsize<-15735139
model_out_dat$Iprop<-model_out_dat$Iall/model_out_dat$popsize*100
model_out_dat$I_100k<-model_out_dat$Iall/model_out_dat$popsize*100000
model_out_dat$relativeFOI<-paste(model_out_dat$relax*100, '% increase in FOI', sep='')
model_out_dat$boost.start.time<-paste('Start boosting ', model_out_dat$boost.start, ' days prior to omicron*')
model_out_dat$Booster<-NA
model_out_dat$Booster[which(model_out_dat$boost.adult==0)]<-'None'
model_out_dat$Booster[which(model_out_dat$boost.adult==1 & model_out_dat$veh2==0.657)]<-'Monovalent'
model_out_dat$Booster[which(model_out_dat$boost.adult==1 & model_out_dat$veh2==0.925)]<-'Bivalent'


## Boosted adults
model_out_dat$Nboosted.adult<-model_out_dat$SBah+model_out_dat$SBal+
  model_out_dat$EBah+model_out_dat$EBal+
  model_out_dat$ABah+model_out_dat$ABal+
  model_out_dat$IBah+model_out_dat$IBal+
  model_out_dat$RBah+model_out_dat$RBal+
  model_out_dat$SBah2+model_out_dat$SBal2+
  model_out_dat$EBah2+model_out_dat$EBal2+
  model_out_dat$ABah2+model_out_dat$ABal2+
  model_out_dat$IBah2+model_out_dat$IBal2+
  model_out_dat$RBah2+model_out_dat$RBal2+
  model_out_dat$DBah+model_out_dat$DBal+
  model_out_dat$DBah2+model_out_dat$DBal2

### Vaccinated adults
model_out_dat$Nvax.adult<-model_out_dat$SBah+model_out_dat$SBal+model_out_dat$EBah+model_out_dat$EBal+
    model_out_dat$ABah+model_out_dat$ABal+model_out_dat$IBah+model_out_dat$IBal+
    model_out_dat$RBah+model_out_dat$RBal+
    model_out_dat$SBah2+model_out_dat$SBal2+
    model_out_dat$EBah2+model_out_dat$EBal2+
    model_out_dat$ABah2+model_out_dat$ABal2+
    model_out_dat$IBah2+model_out_dat$IBal2+
    model_out_dat$RBah2+model_out_dat$RBal2+
  
  model_out_dat$SVah+model_out_dat$SVal+model_out_dat$EVah+model_out_dat$EVal+
  model_out_dat$AVah+model_out_dat$AVal+model_out_dat$IVah+model_out_dat$IVal+
  model_out_dat$RVah+model_out_dat$RVal+model_out_dat$SVah+model_out_dat$SVal+
  model_out_dat$EVah2+model_out_dat$EVal2+model_out_dat$AVah2+model_out_dat$AVal2+
  model_out_dat$IVah2+model_out_dat$IVal2+model_out_dat$RVah2+model_out_dat$RVal2+
  
  model_out_dat$DVah+model_out_dat$DVal+model_out_dat$DVah2+model_out_dat$DVal2+
  model_out_dat$DBah+model_out_dat$DBal+model_out_dat$DBah2+model_out_dat$DBal2

## Boosted elderly
model_out_dat$Nboosted.old<-model_out_dat$SBeh+model_out_dat$SBel+
  model_out_dat$EBeh+model_out_dat$EBel+
  model_out_dat$ABeh+model_out_dat$ABel+
  model_out_dat$IBeh+model_out_dat$IBel+
  model_out_dat$RBeh+model_out_dat$RBel+
  model_out_dat$SBeh2+model_out_dat$SBel2+
  model_out_dat$EBeh2+model_out_dat$EBel2+
  model_out_dat$ABeh2+model_out_dat$ABel2+
  model_out_dat$IBeh2+model_out_dat$IBel2+
  model_out_dat$RBeh2+model_out_dat$RBel2+
  model_out_dat$DBeh+model_out_dat$DBel+
  model_out_dat$DBeh2+model_out_dat$DBel2

## Vaccinated elderly
model_out_dat$Nvax.old<-model_out_dat$SBeh+model_out_dat$SBel+
  model_out_dat$EBeh+model_out_dat$EBel+
  model_out_dat$ABeh+model_out_dat$ABel+
  model_out_dat$IBeh+model_out_dat$IBel+
  model_out_dat$RBeh+model_out_dat$RBel+
  model_out_dat$SBeh2+model_out_dat$SBel2+
  model_out_dat$EBeh2+model_out_dat$EBel2+
  model_out_dat$ABeh2+model_out_dat$ABel2+
  model_out_dat$IBeh2+model_out_dat$IBel2+
  model_out_dat$RBeh2+model_out_dat$RBel2+
  model_out_dat$DBeh+model_out_dat$DBel+
  model_out_dat$DBeh2+model_out_dat$DBel2+
  
  model_out_dat$SVeh+model_out_dat$SVel+model_out_dat$EVeh+model_out_dat$EVel+
  model_out_dat$AVeh+model_out_dat$AVel+model_out_dat$IVeh+model_out_dat$IVel+
  model_out_dat$RVeh+model_out_dat$RVel+model_out_dat$SVeh+model_out_dat$SVel+
  model_out_dat$EVeh2+model_out_dat$EVel2+model_out_dat$AVeh2+model_out_dat$AVel2+
  model_out_dat$IVeh2+model_out_dat$IVel2+model_out_dat$RVeh2+model_out_dat$RVel2+
  model_out_dat$DVeh+model_out_dat$DVel+model_out_dat$DVeh2+model_out_dat$DVel2


## Boosted child
model_out_dat$Nboosted.child<-model_out_dat$SBch+model_out_dat$SBcl+
  model_out_dat$EBch+model_out_dat$EBcl+
  model_out_dat$ABch+model_out_dat$ABcl+
  model_out_dat$IBch+model_out_dat$IBcl+
  model_out_dat$RBch+model_out_dat$RBcl+
  model_out_dat$SBch2+model_out_dat$SBcl2+
  model_out_dat$EBch2+model_out_dat$EBcl2+
  model_out_dat$ABch2+model_out_dat$ABcl2+
  model_out_dat$IBch2+model_out_dat$IBcl2+
  model_out_dat$RBch2+model_out_dat$RBcl2+
  model_out_dat$DBch+model_out_dat$DBcl+
  model_out_dat$DBch2+model_out_dat$DBcl2


## Vaccinated child
model_out_dat$Nvax.child<-model_out_dat$SBch+model_out_dat$SBcl+model_out_dat$EBch+model_out_dat$EBcl+
    model_out_dat$ABch+model_out_dat$ABcl+model_out_dat$IBch+model_out_dat$IBcl+
    model_out_dat$RBch+model_out_dat$RBcl+
    model_out_dat$SBch2+model_out_dat$SBcl2+
    model_out_dat$EBch2+model_out_dat$EBcl2+
    model_out_dat$ABch2+model_out_dat$ABcl2+
    model_out_dat$IBch2+model_out_dat$IBcl2+
    model_out_dat$RBch2+model_out_dat$RBcl2+
  
  model_out_dat$SVch+model_out_dat$SVcl+model_out_dat$EVch+model_out_dat$EVcl+
  model_out_dat$AVch+model_out_dat$AVcl+model_out_dat$IVch+model_out_dat$IVcl+
  model_out_dat$RVch+model_out_dat$RVcl+model_out_dat$SVch+model_out_dat$SVcl+
  model_out_dat$EVch2+model_out_dat$EVcl2+model_out_dat$AVch2+model_out_dat$AVcl2+
  model_out_dat$IVch2+model_out_dat$IVcl2+model_out_dat$RVch2+model_out_dat$RVcl2+
  
  model_out_dat$DVch+model_out_dat$DVcl+model_out_dat$DVch2+model_out_dat$DVcl2+
  model_out_dat$DBch+model_out_dat$DBcl+model_out_dat$DBch2+model_out_dat$DBcl2


model_out_dat$pboost.coverage_of_vaccinated<-(model_out_dat$Nboosted.adult+model_out_dat$Nboosted.old + model_out_dat$Nboosted.child)/(model_out_dat$Nvax.adult+model_out_dat$Nvax.old+model_out_dat$Nvax.child)


df_AvertedODE_Ec <- df_AvertedODE %>% mutate(country = "Ecuador")
fast_Ec <- fast%>% mutate(country = "Ecuador")
model_out_dat_Ec <- model_out_dat%>% mutate(country = "Ecuador")

```


#### India data - main runs
```{r}

end_india_sweep<-readRDS('../Data/ODE outputs/endfile_sweep010324_indiaboost_Evax.RDS')
end_india_sweep$popsize<-1155561222
end_india_sweep$deaths_100k<-(end_india_sweep$DeathsAll/end_india_sweep$popsize)*100000
end_noboost_india<-subset(end_india_sweep, end_india_sweep$boost.adult==0)
end_boost_india<-subset(end_india_sweep, end_india_sweep$boost.adult>0)
sum(end_india_sweep[1,c(2:217)])
require(dplyr)
dfCompODE <- end_noboost_india %>%
  select(deaths_100k, DeathsAll, relax) %>% 
  distinct()
names(dfCompODE)[1]<-'DeathsComp_per100k'
names(dfCompODE)[2]<-'DeathsComp'

df_AvertedODE <- end_boost_india %>% 
  left_join(dfCompODE, by = c("relax")) %>% 
  mutate(da = (DeathsComp_per100k - deaths_100k)/DeathsComp_per100k) %>% 
  distinct() %>% 
  filter(
    veh2==0.657 | (veh2 == max(veh2) & vei2 == max(vei2))
  ) %>% 
  mutate(
    Booster = if_else(
      veh2 == 0.657, "Monovalent",
      "Bivalent"
    )
  )


df_AvertedODE$da_all<-(df_AvertedODE$DeathsComp-df_AvertedODE$DeathsAll)/df_AvertedODE$DeathsComp
dfAvert2<-df_AvertedODE[,c(218:ncol(df_AvertedODE))]
df_AvertedODE$relativeFOI<-paste(df_AvertedODE$relax*100, '% increase in FOI', sep='')
df_AvertedODE$boost.start.time<-paste('Start boosting ', df_AvertedODE$boost.start, ' days prior to omicron*')

fast<-subset(df_AvertedODE, df_AvertedODE$boost.start==60)
fast$deathsaverted_per100k<-fast$DeathsComp_per100k -fast$deaths_100k


load('../Data/ODE outputs/sweep_010324_indiaboost_Evax.RData')
model_out_dat$sweepnum<-rep(seq(from=1, to=27), each=196)
model_out_dat$Iall<-model_out_dat$Ich+model_out_dat$Ich2+model_out_dat$IVch+model_out_dat$IVch2+model_out_dat$IBch+model_out_dat$IBch2+
  model_out_dat$Iah+model_out_dat$Iah2+model_out_dat$IVah+model_out_dat$IVah2+model_out_dat$IBah+model_out_dat$IBah2+
  model_out_dat$Ieh+model_out_dat$Ieh2+model_out_dat$IVeh+model_out_dat$IVeh2+model_out_dat$IBeh+model_out_dat$IBeh2+
  model_out_dat$Icl+model_out_dat$Icl2+model_out_dat$IVcl+model_out_dat$IVcl2+model_out_dat$IBcl+model_out_dat$IBcl2+
  model_out_dat$Ial+model_out_dat$Ial2+model_out_dat$IVal+model_out_dat$IVal2+model_out_dat$IBal+model_out_dat$IBal2+
  model_out_dat$Iel+model_out_dat$Iel2+model_out_dat$IVel+model_out_dat$IVel2+model_out_dat$IBel+model_out_dat$IBel2+
  #
  model_out_dat$Ach+model_out_dat$Ach2+model_out_dat$AVch+model_out_dat$AVch2+model_out_dat$ABch+model_out_dat$ABch2+
  model_out_dat$Aah+model_out_dat$Aah2+model_out_dat$AVah+model_out_dat$AVah2+model_out_dat$ABah+model_out_dat$ABah2+
  model_out_dat$Aeh+model_out_dat$Aeh2+model_out_dat$AVeh+model_out_dat$AVeh2+model_out_dat$ABeh+model_out_dat$ABeh2+
  model_out_dat$Acl+model_out_dat$Acl2+model_out_dat$AVcl+model_out_dat$AVcl2+model_out_dat$ABcl+model_out_dat$ABcl2+
  model_out_dat$Aal+model_out_dat$Aal2+model_out_dat$AVal+model_out_dat$AVal2+model_out_dat$ABal+model_out_dat$ABal2+
  model_out_dat$Ael+model_out_dat$Ael2+model_out_dat$AVel+model_out_dat$AVel2+model_out_dat$ABel+model_out_dat$ABel2
model_out_dat$popsize<-1155561222
model_out_dat$Iprop<-model_out_dat$Iall/model_out_dat$popsize*100
model_out_dat$I_100k<-model_out_dat$Iall/model_out_dat$popsize*100000
model_out_dat$relativeFOI<-paste(model_out_dat$relax*100, '% increase in FOI', sep='')
model_out_dat$boost.start.time<-paste('Start boosting ', model_out_dat$boost.start, ' days prior to omicron*')
model_out_dat$Booster<-NA
model_out_dat$Booster[which(model_out_dat$boost.adult==0)]<-'None'
model_out_dat$Booster[which(model_out_dat$boost.adult==1 & model_out_dat$veh2==0.657)]<-'Monovalent'
model_out_dat$Booster[which(model_out_dat$boost.adult==1 & model_out_dat$veh2==0.925)]<-'Bivalent'



## Boosted adults
model_out_dat$Nboosted.adult<-model_out_dat$SBah+model_out_dat$SBal+
  model_out_dat$EBah+model_out_dat$EBal+
  model_out_dat$ABah+model_out_dat$ABal+
  model_out_dat$IBah+model_out_dat$IBal+
  model_out_dat$RBah+model_out_dat$RBal+
  model_out_dat$SBah2+model_out_dat$SBal2+
  model_out_dat$EBah2+model_out_dat$EBal2+
  model_out_dat$ABah2+model_out_dat$ABal2+
  model_out_dat$IBah2+model_out_dat$IBal2+
  model_out_dat$RBah2+model_out_dat$RBal2+
  model_out_dat$DBah+model_out_dat$DBal+
  model_out_dat$DBah2+model_out_dat$DBal2

### Vaccinated adults
model_out_dat$Nvax.adult<-model_out_dat$SBah+model_out_dat$SBal+model_out_dat$EBah+model_out_dat$EBal+
    model_out_dat$ABah+model_out_dat$ABal+model_out_dat$IBah+model_out_dat$IBal+
    model_out_dat$RBah+model_out_dat$RBal+
    model_out_dat$SBah2+model_out_dat$SBal2+
    model_out_dat$EBah2+model_out_dat$EBal2+
    model_out_dat$ABah2+model_out_dat$ABal2+
    model_out_dat$IBah2+model_out_dat$IBal2+
    model_out_dat$RBah2+model_out_dat$RBal2+
  
  model_out_dat$SVah+model_out_dat$SVal+model_out_dat$EVah+model_out_dat$EVal+
  model_out_dat$AVah+model_out_dat$AVal+model_out_dat$IVah+model_out_dat$IVal+
  model_out_dat$RVah+model_out_dat$RVal+model_out_dat$SVah+model_out_dat$SVal+
  model_out_dat$EVah2+model_out_dat$EVal2+model_out_dat$AVah2+model_out_dat$AVal2+
  model_out_dat$IVah2+model_out_dat$IVal2+model_out_dat$RVah2+model_out_dat$RVal2+
  
  model_out_dat$DVah+model_out_dat$DVal+model_out_dat$DVah2+model_out_dat$DVal2+
  model_out_dat$DBah+model_out_dat$DBal+model_out_dat$DBah2+model_out_dat$DBal2

## Boosted elderly
model_out_dat$Nboosted.old<-model_out_dat$SBeh+model_out_dat$SBel+
  model_out_dat$EBeh+model_out_dat$EBel+
  model_out_dat$ABeh+model_out_dat$ABel+
  model_out_dat$IBeh+model_out_dat$IBel+
  model_out_dat$RBeh+model_out_dat$RBel+
  model_out_dat$SBeh2+model_out_dat$SBel2+
  model_out_dat$EBeh2+model_out_dat$EBel2+
  model_out_dat$ABeh2+model_out_dat$ABel2+
  model_out_dat$IBeh2+model_out_dat$IBel2+
  model_out_dat$RBeh2+model_out_dat$RBel2+
  model_out_dat$DBeh+model_out_dat$DBel+
  model_out_dat$DBeh2+model_out_dat$DBel2

## Vaccinated elderly
model_out_dat$Nvax.old<-model_out_dat$SBeh+model_out_dat$SBel+
  model_out_dat$EBeh+model_out_dat$EBel+
  model_out_dat$ABeh+model_out_dat$ABel+
  model_out_dat$IBeh+model_out_dat$IBel+
  model_out_dat$RBeh+model_out_dat$RBel+
  model_out_dat$SBeh2+model_out_dat$SBel2+
  model_out_dat$EBeh2+model_out_dat$EBel2+
  model_out_dat$ABeh2+model_out_dat$ABel2+
  model_out_dat$IBeh2+model_out_dat$IBel2+
  model_out_dat$RBeh2+model_out_dat$RBel2+
  model_out_dat$DBeh+model_out_dat$DBel+
  model_out_dat$DBeh2+model_out_dat$DBel2+
  
  model_out_dat$SVeh+model_out_dat$SVel+model_out_dat$EVeh+model_out_dat$EVel+
  model_out_dat$AVeh+model_out_dat$AVel+model_out_dat$IVeh+model_out_dat$IVel+
  model_out_dat$RVeh+model_out_dat$RVel+model_out_dat$SVeh+model_out_dat$SVel+
  model_out_dat$EVeh2+model_out_dat$EVel2+model_out_dat$AVeh2+model_out_dat$AVel2+
  model_out_dat$IVeh2+model_out_dat$IVel2+model_out_dat$RVeh2+model_out_dat$RVel2+
  model_out_dat$DVeh+model_out_dat$DVel+model_out_dat$DVeh2+model_out_dat$DVel2


## Boosted child
model_out_dat$Nboosted.child<-model_out_dat$SBch+model_out_dat$SBcl+
  model_out_dat$EBch+model_out_dat$EBcl+
  model_out_dat$ABch+model_out_dat$ABcl+
  model_out_dat$IBch+model_out_dat$IBcl+
  model_out_dat$RBch+model_out_dat$RBcl+
  model_out_dat$SBch2+model_out_dat$SBcl2+
  model_out_dat$EBch2+model_out_dat$EBcl2+
  model_out_dat$ABch2+model_out_dat$ABcl2+
  model_out_dat$IBch2+model_out_dat$IBcl2+
  model_out_dat$RBch2+model_out_dat$RBcl2+
  model_out_dat$DBch+model_out_dat$DBcl+
  model_out_dat$DBch2+model_out_dat$DBcl2


## Vaccinated child
model_out_dat$Nvax.child<-model_out_dat$SBch+model_out_dat$SBcl+model_out_dat$EBch+model_out_dat$EBcl+
    model_out_dat$ABch+model_out_dat$ABcl+model_out_dat$IBch+model_out_dat$IBcl+
    model_out_dat$RBch+model_out_dat$RBcl+
    model_out_dat$SBch2+model_out_dat$SBcl2+
    model_out_dat$EBch2+model_out_dat$EBcl2+
    model_out_dat$ABch2+model_out_dat$ABcl2+
    model_out_dat$IBch2+model_out_dat$IBcl2+
    model_out_dat$RBch2+model_out_dat$RBcl2+
  
  model_out_dat$SVch+model_out_dat$SVcl+model_out_dat$EVch+model_out_dat$EVcl+
  model_out_dat$AVch+model_out_dat$AVcl+model_out_dat$IVch+model_out_dat$IVcl+
  model_out_dat$RVch+model_out_dat$RVcl+model_out_dat$SVch+model_out_dat$SVcl+
  model_out_dat$EVch2+model_out_dat$EVcl2+model_out_dat$AVch2+model_out_dat$AVcl2+
  model_out_dat$IVch2+model_out_dat$IVcl2+model_out_dat$RVch2+model_out_dat$RVcl2+
  
  model_out_dat$DVch+model_out_dat$DVcl+model_out_dat$DVch2+model_out_dat$DVcl2+
  model_out_dat$DBch+model_out_dat$DBcl+model_out_dat$DBch2+model_out_dat$DBcl2


model_out_dat$pboost.coverage_of_vaccinated<-(model_out_dat$Nboosted.adult+model_out_dat$Nboosted.old + model_out_dat$Nboosted.child)/(model_out_dat$Nvax.adult+model_out_dat$Nvax.old+model_out_dat$Nvax.child)


df_AvertedODE_In <- df_AvertedODE %>% mutate(country = "India")
fast_In <- fast%>% mutate(country = "India")
model_out_dat_In <- model_out_dat%>% mutate(country = "India")

```



#### Malaysia data - main runs
```{r}

end_malaysia_sweep<-readRDS('../Data/ODE outputs/endfile_sweep010224_malaysiaboost_Evax.RDS')
end_malaysia_sweep$popsize<-28552712
end_malaysia_sweep$deaths_100k<-(end_malaysia_sweep$DeathsAll/end_malaysia_sweep$popsize)*100000
end_noboost_malaysia<-subset(end_malaysia_sweep, end_malaysia_sweep$boost.adult==0)
end_boost_malaysia<-subset(end_malaysia_sweep, end_malaysia_sweep$boost.adult>0)
sum(end_malaysia_sweep[1,c(2:217)])
require(dplyr)
dfCompODE <- end_noboost_malaysia %>%
  select(deaths_100k, DeathsAll, relax) %>% 
  distinct()
names(dfCompODE)[1]<-'DeathsComp_per100k'
names(dfCompODE)[2]<-'DeathsComp'

df_AvertedODE <- end_boost_malaysia %>% 
  left_join(dfCompODE, by = c("relax")) %>% 
  mutate(da = (DeathsComp_per100k - deaths_100k)/DeathsComp_per100k) %>% 
  distinct() %>% 
  filter(
    veh2==0.657 | (veh2 == max(veh2) & vei2 == max(vei2))
  ) %>% 
  mutate(
    Booster = if_else(
      veh2 == 0.657, "Monovalent",
      "Bivalent"
    )
  )

df_AvertedODE$da_all<-(df_AvertedODE$DeathsComp-df_AvertedODE$DeathsAll)/df_AvertedODE$DeathsComp
dfAvert2<-df_AvertedODE[,c(218:ncol(df_AvertedODE))]
df_AvertedODE$relativeFOI<-paste(df_AvertedODE$relax*100, '% increase in FOI', sep='')
df_AvertedODE$boost.start.time<-paste('Start boosting ', df_AvertedODE$boost.start, ' days prior to omicron*')

fast<-subset(df_AvertedODE, df_AvertedODE$boost.start==60)
fast$deathsaverted_per100k<-fast$DeathsComp_per100k -fast$deaths_100k


load('../Data/ODE outputs/sweep_010224_malaysiaboost_Evax.RData')
model_out_dat$sweepnum<-rep(seq(from=1, to=27), each=196)
model_out_dat$Iall<-model_out_dat$Ich+model_out_dat$Ich2+model_out_dat$IVch+model_out_dat$IVch2+model_out_dat$IBch+model_out_dat$IBch2+
  model_out_dat$Iah+model_out_dat$Iah2+model_out_dat$IVah+model_out_dat$IVah2+model_out_dat$IBah+model_out_dat$IBah2+
  model_out_dat$Ieh+model_out_dat$Ieh2+model_out_dat$IVeh+model_out_dat$IVeh2+model_out_dat$IBeh+model_out_dat$IBeh2+
  model_out_dat$Icl+model_out_dat$Icl2+model_out_dat$IVcl+model_out_dat$IVcl2+model_out_dat$IBcl+model_out_dat$IBcl2+
  model_out_dat$Ial+model_out_dat$Ial2+model_out_dat$IVal+model_out_dat$IVal2+model_out_dat$IBal+model_out_dat$IBal2+
  model_out_dat$Iel+model_out_dat$Iel2+model_out_dat$IVel+model_out_dat$IVel2+model_out_dat$IBel+model_out_dat$IBel2+
  #
  model_out_dat$Ach+model_out_dat$Ach2+model_out_dat$AVch+model_out_dat$AVch2+model_out_dat$ABch+model_out_dat$ABch2+
  model_out_dat$Aah+model_out_dat$Aah2+model_out_dat$AVah+model_out_dat$AVah2+model_out_dat$ABah+model_out_dat$ABah2+
  model_out_dat$Aeh+model_out_dat$Aeh2+model_out_dat$AVeh+model_out_dat$AVeh2+model_out_dat$ABeh+model_out_dat$ABeh2+
  model_out_dat$Acl+model_out_dat$Acl2+model_out_dat$AVcl+model_out_dat$AVcl2+model_out_dat$ABcl+model_out_dat$ABcl2+
  model_out_dat$Aal+model_out_dat$Aal2+model_out_dat$AVal+model_out_dat$AVal2+model_out_dat$ABal+model_out_dat$ABal2+
  model_out_dat$Ael+model_out_dat$Ael2+model_out_dat$AVel+model_out_dat$AVel2+model_out_dat$ABel+model_out_dat$ABel2
model_out_dat$popsize<-28552712
model_out_dat$Iprop<-model_out_dat$Iall/model_out_dat$popsize*100
model_out_dat$I_100k<-model_out_dat$Iall/model_out_dat$popsize*100000
model_out_dat$relativeFOI<-paste(model_out_dat$relax*100, '% increase in FOI', sep='')
model_out_dat$boost.start.time<-paste('Start boosting ', model_out_dat$boost.start, ' days prior to omicron*')
model_out_dat$Booster<-NA
model_out_dat$Booster[which(model_out_dat$boost.adult==0)]<-'None'
model_out_dat$Booster[which(model_out_dat$boost.adult==1 & model_out_dat$veh2==0.657)]<-'Monovalent'
model_out_dat$Booster[which(model_out_dat$boost.adult==1 & model_out_dat$veh2==0.925)]<-'Bivalent'



## Boosted adults
model_out_dat$Nboosted.adult<-model_out_dat$SBah+model_out_dat$SBal+
  model_out_dat$EBah+model_out_dat$EBal+
  model_out_dat$ABah+model_out_dat$ABal+
  model_out_dat$IBah+model_out_dat$IBal+
  model_out_dat$RBah+model_out_dat$RBal+
  model_out_dat$SBah2+model_out_dat$SBal2+
  model_out_dat$EBah2+model_out_dat$EBal2+
  model_out_dat$ABah2+model_out_dat$ABal2+
  model_out_dat$IBah2+model_out_dat$IBal2+
  model_out_dat$RBah2+model_out_dat$RBal2+
  model_out_dat$DBah+model_out_dat$DBal+
  model_out_dat$DBah2+model_out_dat$DBal2

### Vaccinated adults
model_out_dat$Nvax.adult<-model_out_dat$SBah+model_out_dat$SBal+model_out_dat$EBah+model_out_dat$EBal+
    model_out_dat$ABah+model_out_dat$ABal+model_out_dat$IBah+model_out_dat$IBal+
    model_out_dat$RBah+model_out_dat$RBal+
    model_out_dat$SBah2+model_out_dat$SBal2+
    model_out_dat$EBah2+model_out_dat$EBal2+
    model_out_dat$ABah2+model_out_dat$ABal2+
    model_out_dat$IBah2+model_out_dat$IBal2+
    model_out_dat$RBah2+model_out_dat$RBal2+
  
  model_out_dat$SVah+model_out_dat$SVal+model_out_dat$EVah+model_out_dat$EVal+
  model_out_dat$AVah+model_out_dat$AVal+model_out_dat$IVah+model_out_dat$IVal+
  model_out_dat$RVah+model_out_dat$RVal+model_out_dat$SVah+model_out_dat$SVal+
  model_out_dat$EVah2+model_out_dat$EVal2+model_out_dat$AVah2+model_out_dat$AVal2+
  model_out_dat$IVah2+model_out_dat$IVal2+model_out_dat$RVah2+model_out_dat$RVal2+
  
  model_out_dat$DVah+model_out_dat$DVal+model_out_dat$DVah2+model_out_dat$DVal2+
  model_out_dat$DBah+model_out_dat$DBal+model_out_dat$DBah2+model_out_dat$DBal2

## Boosted elderly
model_out_dat$Nboosted.old<-model_out_dat$SBeh+model_out_dat$SBel+
  model_out_dat$EBeh+model_out_dat$EBel+
  model_out_dat$ABeh+model_out_dat$ABel+
  model_out_dat$IBeh+model_out_dat$IBel+
  model_out_dat$RBeh+model_out_dat$RBel+
  model_out_dat$SBeh2+model_out_dat$SBel2+
  model_out_dat$EBeh2+model_out_dat$EBel2+
  model_out_dat$ABeh2+model_out_dat$ABel2+
  model_out_dat$IBeh2+model_out_dat$IBel2+
  model_out_dat$RBeh2+model_out_dat$RBel2+
  model_out_dat$DBeh+model_out_dat$DBel+
  model_out_dat$DBeh2+model_out_dat$DBel2

## Vaccinated elderly
model_out_dat$Nvax.old<-model_out_dat$SBeh+model_out_dat$SBel+
  model_out_dat$EBeh+model_out_dat$EBel+
  model_out_dat$ABeh+model_out_dat$ABel+
  model_out_dat$IBeh+model_out_dat$IBel+
  model_out_dat$RBeh+model_out_dat$RBel+
  model_out_dat$SBeh2+model_out_dat$SBel2+
  model_out_dat$EBeh2+model_out_dat$EBel2+
  model_out_dat$ABeh2+model_out_dat$ABel2+
  model_out_dat$IBeh2+model_out_dat$IBel2+
  model_out_dat$RBeh2+model_out_dat$RBel2+
  model_out_dat$DBeh+model_out_dat$DBel+
  model_out_dat$DBeh2+model_out_dat$DBel2+
  
  model_out_dat$SVeh+model_out_dat$SVel+model_out_dat$EVeh+model_out_dat$EVel+
  model_out_dat$AVeh+model_out_dat$AVel+model_out_dat$IVeh+model_out_dat$IVel+
  model_out_dat$RVeh+model_out_dat$RVel+model_out_dat$SVeh+model_out_dat$SVel+
  model_out_dat$EVeh2+model_out_dat$EVel2+model_out_dat$AVeh2+model_out_dat$AVel2+
  model_out_dat$IVeh2+model_out_dat$IVel2+model_out_dat$RVeh2+model_out_dat$RVel2+
  model_out_dat$DVeh+model_out_dat$DVel+model_out_dat$DVeh2+model_out_dat$DVel2


## Boosted child
model_out_dat$Nboosted.child<-model_out_dat$SBch+model_out_dat$SBcl+
  model_out_dat$EBch+model_out_dat$EBcl+
  model_out_dat$ABch+model_out_dat$ABcl+
  model_out_dat$IBch+model_out_dat$IBcl+
  model_out_dat$RBch+model_out_dat$RBcl+
  model_out_dat$SBch2+model_out_dat$SBcl2+
  model_out_dat$EBch2+model_out_dat$EBcl2+
  model_out_dat$ABch2+model_out_dat$ABcl2+
  model_out_dat$IBch2+model_out_dat$IBcl2+
  model_out_dat$RBch2+model_out_dat$RBcl2+
  model_out_dat$DBch+model_out_dat$DBcl+
  model_out_dat$DBch2+model_out_dat$DBcl2


## Vaccinated child
model_out_dat$Nvax.child<-model_out_dat$SBch+model_out_dat$SBcl+model_out_dat$EBch+model_out_dat$EBcl+
    model_out_dat$ABch+model_out_dat$ABcl+model_out_dat$IBch+model_out_dat$IBcl+
    model_out_dat$RBch+model_out_dat$RBcl+
    model_out_dat$SBch2+model_out_dat$SBcl2+
    model_out_dat$EBch2+model_out_dat$EBcl2+
    model_out_dat$ABch2+model_out_dat$ABcl2+
    model_out_dat$IBch2+model_out_dat$IBcl2+
    model_out_dat$RBch2+model_out_dat$RBcl2+
  
  model_out_dat$SVch+model_out_dat$SVcl+model_out_dat$EVch+model_out_dat$EVcl+
  model_out_dat$AVch+model_out_dat$AVcl+model_out_dat$IVch+model_out_dat$IVcl+
  model_out_dat$RVch+model_out_dat$RVcl+model_out_dat$SVch+model_out_dat$SVcl+
  model_out_dat$EVch2+model_out_dat$EVcl2+model_out_dat$AVch2+model_out_dat$AVcl2+
  model_out_dat$IVch2+model_out_dat$IVcl2+model_out_dat$RVch2+model_out_dat$RVcl2+
  
  model_out_dat$DVch+model_out_dat$DVcl+model_out_dat$DVch2+model_out_dat$DVcl2+
  model_out_dat$DBch+model_out_dat$DBcl+model_out_dat$DBch2+model_out_dat$DBcl2


model_out_dat$pboost.coverage_of_vaccinated<-(model_out_dat$Nboosted.adult+model_out_dat$Nboosted.old + model_out_dat$Nboosted.child)/(model_out_dat$Nvax.adult+model_out_dat$Nvax.old+model_out_dat$Nvax.child)


df_AvertedODE_Ma <- df_AvertedODE %>% mutate(country = "Malaysia")
fast_Ma <- fast%>% mutate(country = "Malaysia")
model_out_dat_Ma <- model_out_dat%>% mutate(country = "Malaysia")

```


#### Combine
```{r}

df_AvertedODE_Ec <- df_AvertedODE_Ec %>%
  rename(sd = sd0)
fast_Ec <- fast_Ec%>%
  rename(sd = sd0)
model_out_dat_Ec <- model_out_dat_Ec %>%
  rename(sd = sd0)

df_AvertedODE_total <- df_AvertedODE_In %>% 
  rbind(df_AvertedODE_Ec) %>%
  rbind(df_AvertedODE_Ma)

write_csv(df_AvertedODE_total,"../Data/ODE Supplement/df_AvertedODE_total.csv")

fast_total <- rbind(fast_In, fast_Ec) %>% rbind(fast_Ma)

write_csv(fast_total,"../Data/ODE Supplement/fast_total.csv")

model_out_data_total <- rbind(model_out_dat_Ec, model_out_dat_In) %>%
  rbind(model_out_dat_Ma)

write_csv(model_out_data_total,"../Data/ODE Supplement/model_out_data_total.csv")


```


#### Run w/o reduced infectiousness

##### Malaysia grid
```{r}
#### Malaysia grid ####

end_malaysia_sweep<-readRDS('../Data/ODE outputs SA/endfile_sweep010224_malaysiagrid_Evax.RDS')
end_malaysia_sweep$popsize<-28552712
end_malaysia_sweep$deaths_100k<-(end_malaysia_sweep$DeathsAll/end_malaysia_sweep$popsize)*100000
end_noboost_malaysia<-subset(end_malaysia_sweep, end_malaysia_sweep$boost.adult==0)
end_boost_malaysia<-subset(end_malaysia_sweep, end_malaysia_sweep$boost.adult>0)
sum(end_malaysia_sweep[1,c(2:217)])

end_boost <-end_boost_malaysia %>% 
  pivot_longer(-c(time, boost.speed, sweepnum, boost.child, cvax,
                  boost.adult, max.boost_h, max.boost_l, max.boost.child, wanevar,
                  child.max,cp,base.imm,sd,relax,boost.start,dWVH,k_h,k_l,
                  vei2,veh2,DeathsAll,popsize,deaths_100k
  ))
end_no_boost <- end_noboost_malaysia %>% 
  pivot_longer(-c(time, boost.speed, sweepnum, boost.child, cvax,
                  boost.adult, max.boost_h, max.boost_l, max.boost.child, wanevar,
                  child.max,cp,base.imm,sd,relax,boost.start,dWVH,k_h,k_l,
                  vei2,veh2,DeathsAll,popsize,deaths_100k
  ))

dfCompODE <- end_noboost_malaysia %>% 
  select(deaths_100k, DeathsAll, cp, relax, 
         base.imm) %>% distinct() %>% 
  rename(deaths_100k_comp = deaths_100k,
         DeathsAll_comp = DeathsAll)

df_AvertedODE <- end_boost %>% 
  left_join(dfCompODE, by = c("relax", "cp", "base.imm")) %>% 
  mutate(
    da = (deaths_100k_comp - deaths_100k)/deaths_100k_comp
  ) %>% 
  distinct() %>% 
  filter(
    veh2==0.657 | (veh2 == max(veh2) & vei2 == max(vei2))
  ) %>% 
  mutate(
    Booster = if_else(
      veh2 == 0.657, "Monovalent",
      "Bivalent"
    )
  )%>%
  mutate(name = NULL, value = NULL) %>%
  distinct()

write_csv(df_AvertedODE, "../Data/ODE Supplement/Malaysia_grid_da_altbeta.csv")
```


##### Ecuador grid
```{r}
#### Ecuador grid ####

end_ecuador_sweep<-readRDS('../Data/ODE outputs SA/endfile_sweep010424_ecuadorgrid.RDS')
end_ecuador_sweep$popsize<-15735139
end_ecuador_sweep$deaths_100k<-(end_ecuador_sweep$DeathsAll/end_ecuador_sweep$popsize)*100000
end_noboost_ecuador<-subset(end_ecuador_sweep, end_ecuador_sweep$boost.adult==0)
end_boost_ecuador<-subset(end_ecuador_sweep, end_ecuador_sweep$boost.adult>0)
sum(end_ecuador_sweep[1,c(2:217)])

end_boost <-end_boost_ecuador %>% 
  pivot_longer(-c(time, boost.speed, sweepnum, boost.child, cvax,
                  boost.adult, max.boost_h, max.boost_l, max.boost.child, wanevar,
                  child.max,cp,base.imm,sd,relax,boost.start,dWVH,k_h,k_l,
                  vei2,veh2,DeathsAll,popsize,deaths_100k
  ))
end_no_boost <- end_noboost_ecuador %>% 
  pivot_longer(-c(time, boost.speed, sweepnum, boost.child, cvax,
                  boost.adult, max.boost_h, max.boost_l, max.boost.child, wanevar,
                  child.max,cp,base.imm,sd,relax,boost.start,dWVH,k_h,k_l,
                  vei2,veh2,DeathsAll,popsize,deaths_100k
  ))

dfCompODE <- end_noboost_ecuador %>% 
  select(deaths_100k, DeathsAll, cp, relax, 
         base.imm) %>% distinct() %>% 
  rename(deaths_100k_comp = deaths_100k,
         DeathsAll_comp = DeathsAll)

df_AvertedODE <- end_boost %>% 
  left_join(dfCompODE, by = c("relax", "cp", "base.imm")) %>% 
  mutate(
    da = (deaths_100k_comp - deaths_100k)/deaths_100k_comp
  ) %>% 
  distinct() %>% 
  filter(
    veh2==0.657 | (veh2 == max(veh2) & vei2 == max(vei2))
  ) %>% 
  mutate(
    Booster = if_else(
      veh2 == 0.657, "Monovalent",
      "Bivalent"
    )
  )%>%
  mutate(name = NULL, value = NULL) %>%
  distinct()

write_csv(df_AvertedODE, "../Data/ODE Supplement/Ecuador_grid_da_altbeta.csv")
```

##### India grid
```{r}
#### India grid ####

end_india_sweep<-readRDS('../Data/ODE outputs SA/endfile_sweep010324_indiagrid_Evax.RDS')
end_india_sweep$popsize<-1155561222
end_india_sweep$deaths_100k<-(end_india_sweep$DeathsAll/end_india_sweep$popsize)*100000
end_noboost_india<-subset(end_india_sweep, end_india_sweep$boost.adult==0)
end_boost_india<-subset(end_india_sweep, end_india_sweep$boost.adult>0)
sum(end_india_sweep[1,c(2:217)])

end_boost <-end_boost_india %>% 
  pivot_longer(-c(time, boost.speed, sweepnum, boost.child, cvax,
                  boost.adult, max.boost_h, max.boost_l, max.boost.child, wanevar,
                  child.max,cp,base.imm,sd,relax,boost.start,dWVH,k_h,k_l,
                  vei2,veh2,DeathsAll,popsize,deaths_100k
  ))
end_no_boost <- end_noboost_india %>% 
  pivot_longer(-c(time, boost.speed, sweepnum, boost.child, cvax,
                  boost.adult, max.boost_h, max.boost_l, max.boost.child, wanevar,
                  child.max,cp,base.imm,sd,relax,boost.start,dWVH,k_h,k_l,
                  vei2,veh2,DeathsAll,popsize,deaths_100k
  ))

dfCompODE <- end_noboost_india %>% 
  select(deaths_100k, DeathsAll, cp, relax, 
         base.imm) %>% distinct() %>% 
  rename(deaths_100k_comp = deaths_100k,
         DeathsAll_comp = DeathsAll)

df_AvertedODE <- end_boost %>% 
  left_join(dfCompODE, by = c("relax", "cp", "base.imm")) %>% 
  mutate(
    da = (deaths_100k_comp - deaths_100k)/deaths_100k_comp
  ) %>% 
  distinct() %>% 
  filter(
    veh2==0.657 | (veh2 == max(veh2) & vei2 == max(vei2))
  ) %>% 
  mutate(
    Booster = if_else(
      veh2 == 0.657, "Monovalent",
      "Bivalent"
    )
  )%>%
  mutate(name = NULL, value = NULL) %>%
  distinct()

write_csv(df_AvertedODE, "../Data/ODE Supplement/India_grid_da_altbeta.csv")
```


##### Malaysia deaths averted
```{r}
#### Malaysia runs ####

end_malaysia_sweep<-readRDS('../Data/ODE outputs SA/endfile_sweep010224_malaysiaboost_Evax.RDS')
end_malaysia_sweep$popsize<-28552712
end_malaysia_sweep$deaths_100k<-(end_malaysia_sweep$DeathsAll/end_malaysia_sweep$popsize)*100000
end_noboost_malaysia<-subset(end_malaysia_sweep, end_malaysia_sweep$boost.adult==0)
end_boost_malaysia<-subset(end_malaysia_sweep, end_malaysia_sweep$boost.adult>0)
sum(end_malaysia_sweep[1,c(2:217)])

end_boost <-end_boost_malaysia %>% 
  pivot_longer(-c(time, boost.speed, sweepnum, boost.child, cvax,
                  boost.adult, max.boost_h, max.boost_l, max.boost.child, wanevar,
                  child.max,cp,base.imm,sd,relax,boost.start,dWVH,k_h,k_l,
                  vei2,veh2,DeathsAll,popsize,deaths_100k
  ))
end_no_boost <- end_noboost_malaysia %>% 
  pivot_longer(-c(time, boost.speed, sweepnum, boost.child, cvax,
                  boost.adult, max.boost_h, max.boost_l, max.boost.child, wanevar,
                  child.max,cp,base.imm,sd,relax,boost.start,dWVH,k_h,k_l,
                  vei2,veh2,DeathsAll,popsize,deaths_100k
  ))

dfCompODE <- end_noboost_malaysia %>% 
  select(deaths_100k, DeathsAll, cp, relax, 
         base.imm) %>% distinct() %>% 
  rename(deaths_100k_comp = deaths_100k,
         DeathsAll_comp = DeathsAll)

df_AvertedODE <- end_boost %>% 
  left_join(dfCompODE, by = c("relax", "cp", "base.imm")) %>% 
  mutate(
    da = (deaths_100k_comp - deaths_100k)/deaths_100k_comp
  ) %>% 
  distinct() %>% 
  filter(
    veh2==0.657 | (veh2 == max(veh2) & vei2 == max(vei2))
  ) %>% 
  mutate(
    Booster = if_else(
      veh2 == 0.657, "Monovalent",
      "Bivalent"
    )
  ) %>%
  mutate(name = NULL, value = NULL) %>%
  distinct()

write_csv(df_AvertedODE, "../Data/ODE Supplement/Malaysia_run_da_altbeta.csv")
```

##### Ecuador deaths averted
```{r}

#### Ecuador runs ####

end_ecuador_sweep<-readRDS('../Data/ODE outputs SA/endfile_sweep010424_ecuadorboost_Evax.RDS') %>% 
  rename(sd = sd0)
end_ecuador_sweep$popsize<-15735139
end_ecuador_sweep$deaths_100k<-(end_ecuador_sweep$DeathsAll/end_ecuador_sweep$popsize)*100000
end_noboost_ecuador<-subset(end_ecuador_sweep, end_ecuador_sweep$boost.adult==0)
end_boost_ecuador<-subset(end_ecuador_sweep, end_ecuador_sweep$boost.adult>0)
sum(end_ecuador_sweep[1,c(2:217)])

end_boost <-end_boost_ecuador %>% 
  pivot_longer(-c(time, boost.speed, sweepnum, boost.child, cvax,
                  boost.adult, max.boost_h, max.boost_l, max.boost.child, wanevar,
                  child.max,cp,base.imm,sd,relax,boost.start,dWVH,k_h,k_l,
                  vei2,veh2,DeathsAll,popsize,deaths_100k
  ))
end_no_boost <- end_noboost_ecuador %>% 
  pivot_longer(-c(time, boost.speed, sweepnum, boost.child, cvax,
                  boost.adult, max.boost_h, max.boost_l, max.boost.child, wanevar,
                  child.max,cp,base.imm,sd,relax,boost.start,dWVH,k_h,k_l,
                  vei2,veh2,DeathsAll,popsize,deaths_100k
  ))

dfCompODE <- end_noboost_ecuador %>% 
  select(deaths_100k, DeathsAll, cp, relax, 
         base.imm) %>% distinct() %>% 
  rename(deaths_100k_comp = deaths_100k,
         DeathsAll_comp = DeathsAll)

df_AvertedODE <- end_boost %>% 
  left_join(dfCompODE, by = c("relax", "cp", "base.imm")) %>% 
  mutate(
    da = (deaths_100k_comp - deaths_100k)/deaths_100k_comp
  ) %>% 
  distinct() %>% 
  filter(
    veh2==0.657 | (veh2 == max(veh2) & vei2 == max(vei2))
  ) %>% 
  mutate(
    Booster = if_else(
      veh2 == 0.657, "Monovalent",
      "Bivalent"
    )
  ) %>%
  mutate(name = NULL, value = NULL) %>%
  distinct()

write_csv(df_AvertedODE, "../Data/ODE Supplement/Ecuador_run_da_altbeta.csv")
```

##### India deaths averted
```{r}
#### India runs ####

end_india_sweep<-readRDS('../Data/ODE outputs SA/endfile_sweep010324_indiaboost_Evax.RDS')
end_india_sweep$popsize<-1155561222
end_india_sweep$deaths_100k<-(end_india_sweep$DeathsAll/end_india_sweep$popsize)*100000
end_noboost_india<-subset(end_india_sweep, end_india_sweep$boost.adult==0)
end_boost_india<-subset(end_india_sweep, end_india_sweep$boost.adult>0)
sum(end_india_sweep[1,c(2:217)])

end_boost <-end_boost_india %>% 
  pivot_longer(-c(time, boost.speed, sweepnum, boost.child, cvax,
                  boost.adult, max.boost_h, max.boost_l, max.boost.child, wanevar,
                  child.max,cp,base.imm,sd,relax,boost.start,dWVH,k_h,k_l,
                  vei2,veh2,DeathsAll,popsize,deaths_100k
  ))
end_no_boost <- end_noboost_india %>% 
  pivot_longer(-c(time, boost.speed, sweepnum, boost.child, cvax,
                  boost.adult, max.boost_h, max.boost_l, max.boost.child, wanevar,
                  child.max,cp,base.imm,sd,relax,boost.start,dWVH,k_h,k_l,
                  vei2,veh2,DeathsAll,popsize,deaths_100k
  ))

dfCompODE <- end_noboost_india %>% 
  select(deaths_100k, DeathsAll, cp, relax, 
         base.imm) %>% distinct() %>% 
  rename(deaths_100k_comp = deaths_100k,
         DeathsAll_comp = DeathsAll)

df_AvertedODE <- end_boost %>% 
  left_join(dfCompODE, by = c("relax", "cp", "base.imm")) %>% 
  mutate(
    da = (deaths_100k_comp - deaths_100k)/deaths_100k_comp
  ) %>% 
  distinct() %>% 
  filter(
    veh2==0.657 | (veh2 == max(veh2) & vei2 == max(vei2))
  ) %>% 
  mutate(
    Booster = if_else(
      veh2 == 0.657, "Monovalent",
      "Bivalent"
    )
  ) %>%
  mutate(name = NULL, value = NULL) %>%
  distinct()

write_csv(df_AvertedODE, "../Data/ODE Supplement/India_run_da_altbeta.csv")
```

##### Malaysia time series
```{r}

#### Malaysia time series ####

load('../Data/ODE outputs SA/sweep_010224_malaysiaboost_Evax.RData')
model_out_dat$sweepnum<-rep(seq(from=1, to=27), each=196)
model_out_dat$Iall<-model_out_dat$Ich+model_out_dat$Ich2+model_out_dat$IVch+model_out_dat$IVch2+model_out_dat$IBch+model_out_dat$IBch2+
  model_out_dat$Iah+model_out_dat$Iah2+model_out_dat$IVah+model_out_dat$IVah2+model_out_dat$IBah+model_out_dat$IBah2+
  model_out_dat$Ieh+model_out_dat$Ieh2+model_out_dat$IVeh+model_out_dat$IVeh2+model_out_dat$IBeh+model_out_dat$IBeh2+
  model_out_dat$Icl+model_out_dat$Icl2+model_out_dat$IVcl+model_out_dat$IVcl2+model_out_dat$IBcl+model_out_dat$IBcl2+
  model_out_dat$Ial+model_out_dat$Ial2+model_out_dat$IVal+model_out_dat$IVal2+model_out_dat$IBal+model_out_dat$IBal2+
  model_out_dat$Iel+model_out_dat$Iel2+model_out_dat$IVel+model_out_dat$IVel2+model_out_dat$IBel+model_out_dat$IBel2+
  #
  model_out_dat$Ach+model_out_dat$Ach2+model_out_dat$AVch+model_out_dat$AVch2+model_out_dat$ABch+model_out_dat$ABch2+
  model_out_dat$Aah+model_out_dat$Aah2+model_out_dat$AVah+model_out_dat$AVah2+model_out_dat$ABah+model_out_dat$ABah2+
  model_out_dat$Aeh+model_out_dat$Aeh2+model_out_dat$AVeh+model_out_dat$AVeh2+model_out_dat$ABeh+model_out_dat$ABeh2+
  model_out_dat$Acl+model_out_dat$Acl2+model_out_dat$AVcl+model_out_dat$AVcl2+model_out_dat$ABcl+model_out_dat$ABcl2+
  model_out_dat$Aal+model_out_dat$Aal2+model_out_dat$AVal+model_out_dat$AVal2+model_out_dat$ABal+model_out_dat$ABal2+
  model_out_dat$Ael+model_out_dat$Ael2+model_out_dat$AVel+model_out_dat$AVel2+model_out_dat$ABel+model_out_dat$ABel2
model_out_dat$popsize<-28552712
model_out_dat$Iprop<-model_out_dat$Iall/model_out_dat$popsize*100
model_out_dat$relativeFOI<-paste(model_out_dat$relax*100, '% increase in FOI', sep='')
model_out_dat$boost.start.time<-paste('Start boosting ', model_out_dat$boost.start, ' days prior to omicron*')
model_out_dat$Booster<-NA
model_out_dat$Booster[which(model_out_dat$boost.adult==0)]<-'None'
model_out_dat$Booster[which(model_out_dat$boost.adult==1 & model_out_dat$veh2==0.657)]<-'Monovalent'
model_out_dat$Booster[which(model_out_dat$boost.adult==1 & model_out_dat$veh2==0.925)]<-'Bivalent'


## Boosted adults
model_out_dat$Nboosted.adult<-model_out_dat$SBah+model_out_dat$SBal+
  model_out_dat$EBah+model_out_dat$EBal+
  model_out_dat$ABah+model_out_dat$ABal+
  model_out_dat$IBah+model_out_dat$IBal+
  model_out_dat$RBah+model_out_dat$RBal+
  model_out_dat$SBah2+model_out_dat$SBal2+
  model_out_dat$EBah2+model_out_dat$EBal2+
  model_out_dat$ABah2+model_out_dat$ABal2+
  model_out_dat$IBah2+model_out_dat$IBal2+
  model_out_dat$RBah2+model_out_dat$RBal2+
  model_out_dat$DBah+model_out_dat$DBal+
  model_out_dat$DBah2+model_out_dat$DBal2

### Vaccinated adults
model_out_dat$Nvax.adult<-model_out_dat$SBah+model_out_dat$SBal+model_out_dat$EBah+model_out_dat$EBal+
    model_out_dat$ABah+model_out_dat$ABal+model_out_dat$IBah+model_out_dat$IBal+
    model_out_dat$RBah+model_out_dat$RBal+
    model_out_dat$SBah2+model_out_dat$SBal2+
    model_out_dat$EBah2+model_out_dat$EBal2+
    model_out_dat$ABah2+model_out_dat$ABal2+
    model_out_dat$IBah2+model_out_dat$IBal2+
    model_out_dat$RBah2+model_out_dat$RBal2+
  
  model_out_dat$SVah+model_out_dat$SVal+model_out_dat$EVah+model_out_dat$EVal+
  model_out_dat$AVah+model_out_dat$AVal+model_out_dat$IVah+model_out_dat$IVal+
  model_out_dat$RVah+model_out_dat$RVal+model_out_dat$SVah+model_out_dat$SVal+
  model_out_dat$EVah2+model_out_dat$EVal2+model_out_dat$AVah2+model_out_dat$AVal2+
  model_out_dat$IVah2+model_out_dat$IVal2+model_out_dat$RVah2+model_out_dat$RVal2+
  
  model_out_dat$DVah+model_out_dat$DVal+model_out_dat$DVah2+model_out_dat$DVal2+
  model_out_dat$DBah+model_out_dat$DBal+model_out_dat$DBah2+model_out_dat$DBal2

## Boosted elderly
model_out_dat$Nboosted.old<-model_out_dat$SBeh+model_out_dat$SBel+
  model_out_dat$EBeh+model_out_dat$EBel+
  model_out_dat$ABeh+model_out_dat$ABel+
  model_out_dat$IBeh+model_out_dat$IBel+
  model_out_dat$RBeh+model_out_dat$RBel+
  model_out_dat$SBeh2+model_out_dat$SBel2+
  model_out_dat$EBeh2+model_out_dat$EBel2+
  model_out_dat$ABeh2+model_out_dat$ABel2+
  model_out_dat$IBeh2+model_out_dat$IBel2+
  model_out_dat$RBeh2+model_out_dat$RBel2+
  model_out_dat$DBeh+model_out_dat$DBel+
  model_out_dat$DBeh2+model_out_dat$DBel2

## Vaccinated elderly
model_out_dat$Nvax.old<-model_out_dat$SBeh+model_out_dat$SBel+
  model_out_dat$EBeh+model_out_dat$EBel+
  model_out_dat$ABeh+model_out_dat$ABel+
  model_out_dat$IBeh+model_out_dat$IBel+
  model_out_dat$RBeh+model_out_dat$RBel+
  model_out_dat$SBeh2+model_out_dat$SBel2+
  model_out_dat$EBeh2+model_out_dat$EBel2+
  model_out_dat$ABeh2+model_out_dat$ABel2+
  model_out_dat$IBeh2+model_out_dat$IBel2+
  model_out_dat$RBeh2+model_out_dat$RBel2+
  model_out_dat$DBeh+model_out_dat$DBel+
  model_out_dat$DBeh2+model_out_dat$DBel2+
  
  model_out_dat$SVeh+model_out_dat$SVel+model_out_dat$EVeh+model_out_dat$EVel+
  model_out_dat$AVeh+model_out_dat$AVel+model_out_dat$IVeh+model_out_dat$IVel+
  model_out_dat$RVeh+model_out_dat$RVel+model_out_dat$SVeh+model_out_dat$SVel+
  model_out_dat$EVeh2+model_out_dat$EVel2+model_out_dat$AVeh2+model_out_dat$AVel2+
  model_out_dat$IVeh2+model_out_dat$IVel2+model_out_dat$RVeh2+model_out_dat$RVel2+
  model_out_dat$DVeh+model_out_dat$DVel+model_out_dat$DVeh2+model_out_dat$DVel2


## Boosted child
model_out_dat$Nboosted.child<-model_out_dat$SBch+model_out_dat$SBcl+
  model_out_dat$EBch+model_out_dat$EBcl+
  model_out_dat$ABch+model_out_dat$ABcl+
  model_out_dat$IBch+model_out_dat$IBcl+
  model_out_dat$RBch+model_out_dat$RBcl+
  model_out_dat$SBch2+model_out_dat$SBcl2+
  model_out_dat$EBch2+model_out_dat$EBcl2+
  model_out_dat$ABch2+model_out_dat$ABcl2+
  model_out_dat$IBch2+model_out_dat$IBcl2+
  model_out_dat$RBch2+model_out_dat$RBcl2+
  model_out_dat$DBch+model_out_dat$DBcl+
  model_out_dat$DBch2+model_out_dat$DBcl2


## Vaccinated child
model_out_dat$Nvax.child<-model_out_dat$SBch+model_out_dat$SBcl+model_out_dat$EBch+model_out_dat$EBcl+
    model_out_dat$ABch+model_out_dat$ABcl+model_out_dat$IBch+model_out_dat$IBcl+
    model_out_dat$RBch+model_out_dat$RBcl+
    model_out_dat$SBch2+model_out_dat$SBcl2+
    model_out_dat$EBch2+model_out_dat$EBcl2+
    model_out_dat$ABch2+model_out_dat$ABcl2+
    model_out_dat$IBch2+model_out_dat$IBcl2+
    model_out_dat$RBch2+model_out_dat$RBcl2+
  
  model_out_dat$SVch+model_out_dat$SVcl+model_out_dat$EVch+model_out_dat$EVcl+
  model_out_dat$AVch+model_out_dat$AVcl+model_out_dat$IVch+model_out_dat$IVcl+
  model_out_dat$RVch+model_out_dat$RVcl+model_out_dat$SVch+model_out_dat$SVcl+
  model_out_dat$EVch2+model_out_dat$EVcl2+model_out_dat$AVch2+model_out_dat$AVcl2+
  model_out_dat$IVch2+model_out_dat$IVcl2+model_out_dat$RVch2+model_out_dat$RVcl2+
  
  model_out_dat$DVch+model_out_dat$DVcl+model_out_dat$DVch2+model_out_dat$DVcl2+
  model_out_dat$DBch+model_out_dat$DBcl+model_out_dat$DBch2+model_out_dat$DBcl2


model_out_dat$pboost.coverage_of_vaccinated<-(model_out_dat$Nboosted.adult+model_out_dat$Nboosted.old + model_out_dat$Nboosted.child)/(model_out_dat$Nvax.adult+model_out_dat$Nvax.old+model_out_dat$Nvax.child)


model_out_dat <- model_out_dat %>% 
  pivot_longer(-c(time, boost.speed, sweepnum, boost.child, cvax, relativeFOI,
                  boost.adult, max.boost_h, max.boost_l, max.boost.child, wanevar,
                  child.max,cp,base.imm,sd,relax,boost.start,dWVH,k_h,k_l,
                  vei2,veh2,popsize, boost.start.time, Booster
  )) %>% 
  filter(name %in% c("Iall", "Iprop", "pboost.coverage_of_vaccinated"))

write_csv(model_out_dat, "../Data/ODE Supplement/Malaysia_ts_altbeta.csv")
```

##### Ecuador time series
```{r}

#### Ecuador time series ####

load('../Data/ODE outputs SA/sweep_010424_ecuadorboost_Evax.RData')
model_out_dat$sweepnum<-rep(seq(from=1, to=27), each=196)
model_out_dat$Iall<-model_out_dat$Ich+model_out_dat$Ich2+model_out_dat$IVch+model_out_dat$IVch2+model_out_dat$IBch+model_out_dat$IBch2+
  model_out_dat$Iah+model_out_dat$Iah2+model_out_dat$IVah+model_out_dat$IVah2+model_out_dat$IBah+model_out_dat$IBah2+
  model_out_dat$Ieh+model_out_dat$Ieh2+model_out_dat$IVeh+model_out_dat$IVeh2+model_out_dat$IBeh+model_out_dat$IBeh2+
  model_out_dat$Icl+model_out_dat$Icl2+model_out_dat$IVcl+model_out_dat$IVcl2+model_out_dat$IBcl+model_out_dat$IBcl2+
  model_out_dat$Ial+model_out_dat$Ial2+model_out_dat$IVal+model_out_dat$IVal2+model_out_dat$IBal+model_out_dat$IBal2+
  model_out_dat$Iel+model_out_dat$Iel2+model_out_dat$IVel+model_out_dat$IVel2+model_out_dat$IBel+model_out_dat$IBel2+
  #
  model_out_dat$Ach+model_out_dat$Ach2+model_out_dat$AVch+model_out_dat$AVch2+model_out_dat$ABch+model_out_dat$ABch2+
  model_out_dat$Aah+model_out_dat$Aah2+model_out_dat$AVah+model_out_dat$AVah2+model_out_dat$ABah+model_out_dat$ABah2+
  model_out_dat$Aeh+model_out_dat$Aeh2+model_out_dat$AVeh+model_out_dat$AVeh2+model_out_dat$ABeh+model_out_dat$ABeh2+
  model_out_dat$Acl+model_out_dat$Acl2+model_out_dat$AVcl+model_out_dat$AVcl2+model_out_dat$ABcl+model_out_dat$ABcl2+
  model_out_dat$Aal+model_out_dat$Aal2+model_out_dat$AVal+model_out_dat$AVal2+model_out_dat$ABal+model_out_dat$ABal2+
  model_out_dat$Ael+model_out_dat$Ael2+model_out_dat$AVel+model_out_dat$AVel2+model_out_dat$ABel+model_out_dat$ABel2
model_out_dat$popsize<-15735139
model_out_dat$Iprop<-model_out_dat$Iall/model_out_dat$popsize*100
model_out_dat$relativeFOI<-paste(model_out_dat$relax*100, '% increase in FOI', sep='')
model_out_dat$boost.start.time<-paste('Start boosting ', model_out_dat$boost.start, ' days prior to omicron*')
model_out_dat$Booster<-NA
model_out_dat$Booster[which(model_out_dat$boost.adult==0)]<-'None'
model_out_dat$Booster[which(model_out_dat$boost.adult==1 & model_out_dat$veh2==0.657)]<-'Monovalent'
model_out_dat$Booster[which(model_out_dat$boost.adult==1 & model_out_dat$veh2==0.925)]<-'Bivalent'

## Boosted adults
model_out_dat$Nboosted.adult<-model_out_dat$SBah+model_out_dat$SBal+
  model_out_dat$EBah+model_out_dat$EBal+
  model_out_dat$ABah+model_out_dat$ABal+
  model_out_dat$IBah+model_out_dat$IBal+
  model_out_dat$RBah+model_out_dat$RBal+
  model_out_dat$SBah2+model_out_dat$SBal2+
  model_out_dat$EBah2+model_out_dat$EBal2+
  model_out_dat$ABah2+model_out_dat$ABal2+
  model_out_dat$IBah2+model_out_dat$IBal2+
  model_out_dat$RBah2+model_out_dat$RBal2+
  model_out_dat$DBah+model_out_dat$DBal+
  model_out_dat$DBah2+model_out_dat$DBal2

### Vaccinated adults
model_out_dat$Nvax.adult<-model_out_dat$SBah+model_out_dat$SBal+model_out_dat$EBah+model_out_dat$EBal+
    model_out_dat$ABah+model_out_dat$ABal+model_out_dat$IBah+model_out_dat$IBal+
    model_out_dat$RBah+model_out_dat$RBal+
    model_out_dat$SBah2+model_out_dat$SBal2+
    model_out_dat$EBah2+model_out_dat$EBal2+
    model_out_dat$ABah2+model_out_dat$ABal2+
    model_out_dat$IBah2+model_out_dat$IBal2+
    model_out_dat$RBah2+model_out_dat$RBal2+
  
  model_out_dat$SVah+model_out_dat$SVal+model_out_dat$EVah+model_out_dat$EVal+
  model_out_dat$AVah+model_out_dat$AVal+model_out_dat$IVah+model_out_dat$IVal+
  model_out_dat$RVah+model_out_dat$RVal+model_out_dat$SVah+model_out_dat$SVal+
  model_out_dat$EVah2+model_out_dat$EVal2+model_out_dat$AVah2+model_out_dat$AVal2+
  model_out_dat$IVah2+model_out_dat$IVal2+model_out_dat$RVah2+model_out_dat$RVal2+
  
  model_out_dat$DVah+model_out_dat$DVal+model_out_dat$DVah2+model_out_dat$DVal2+
  model_out_dat$DBah+model_out_dat$DBal+model_out_dat$DBah2+model_out_dat$DBal2

## Boosted elderly
model_out_dat$Nboosted.old<-model_out_dat$SBeh+model_out_dat$SBel+
  model_out_dat$EBeh+model_out_dat$EBel+
  model_out_dat$ABeh+model_out_dat$ABel+
  model_out_dat$IBeh+model_out_dat$IBel+
  model_out_dat$RBeh+model_out_dat$RBel+
  model_out_dat$SBeh2+model_out_dat$SBel2+
  model_out_dat$EBeh2+model_out_dat$EBel2+
  model_out_dat$ABeh2+model_out_dat$ABel2+
  model_out_dat$IBeh2+model_out_dat$IBel2+
  model_out_dat$RBeh2+model_out_dat$RBel2+
  model_out_dat$DBeh+model_out_dat$DBel+
  model_out_dat$DBeh2+model_out_dat$DBel2

## Vaccinated elderly
model_out_dat$Nvax.old<-model_out_dat$SBeh+model_out_dat$SBel+
  model_out_dat$EBeh+model_out_dat$EBel+
  model_out_dat$ABeh+model_out_dat$ABel+
  model_out_dat$IBeh+model_out_dat$IBel+
  model_out_dat$RBeh+model_out_dat$RBel+
  model_out_dat$SBeh2+model_out_dat$SBel2+
  model_out_dat$EBeh2+model_out_dat$EBel2+
  model_out_dat$ABeh2+model_out_dat$ABel2+
  model_out_dat$IBeh2+model_out_dat$IBel2+
  model_out_dat$RBeh2+model_out_dat$RBel2+
  model_out_dat$DBeh+model_out_dat$DBel+
  model_out_dat$DBeh2+model_out_dat$DBel2+
  
  model_out_dat$SVeh+model_out_dat$SVel+model_out_dat$EVeh+model_out_dat$EVel+
  model_out_dat$AVeh+model_out_dat$AVel+model_out_dat$IVeh+model_out_dat$IVel+
  model_out_dat$RVeh+model_out_dat$RVel+model_out_dat$SVeh+model_out_dat$SVel+
  model_out_dat$EVeh2+model_out_dat$EVel2+model_out_dat$AVeh2+model_out_dat$AVel2+
  model_out_dat$IVeh2+model_out_dat$IVel2+model_out_dat$RVeh2+model_out_dat$RVel2+
  model_out_dat$DVeh+model_out_dat$DVel+model_out_dat$DVeh2+model_out_dat$DVel2


## Boosted child
model_out_dat$Nboosted.child<-model_out_dat$SBch+model_out_dat$SBcl+
  model_out_dat$EBch+model_out_dat$EBcl+
  model_out_dat$ABch+model_out_dat$ABcl+
  model_out_dat$IBch+model_out_dat$IBcl+
  model_out_dat$RBch+model_out_dat$RBcl+
  model_out_dat$SBch2+model_out_dat$SBcl2+
  model_out_dat$EBch2+model_out_dat$EBcl2+
  model_out_dat$ABch2+model_out_dat$ABcl2+
  model_out_dat$IBch2+model_out_dat$IBcl2+
  model_out_dat$RBch2+model_out_dat$RBcl2+
  model_out_dat$DBch+model_out_dat$DBcl+
  model_out_dat$DBch2+model_out_dat$DBcl2


## Vaccinated child
model_out_dat$Nvax.child<-model_out_dat$SBch+model_out_dat$SBcl+model_out_dat$EBch+model_out_dat$EBcl+
    model_out_dat$ABch+model_out_dat$ABcl+model_out_dat$IBch+model_out_dat$IBcl+
    model_out_dat$RBch+model_out_dat$RBcl+
    model_out_dat$SBch2+model_out_dat$SBcl2+
    model_out_dat$EBch2+model_out_dat$EBcl2+
    model_out_dat$ABch2+model_out_dat$ABcl2+
    model_out_dat$IBch2+model_out_dat$IBcl2+
    model_out_dat$RBch2+model_out_dat$RBcl2+
  
  model_out_dat$SVch+model_out_dat$SVcl+model_out_dat$EVch+model_out_dat$EVcl+
  model_out_dat$AVch+model_out_dat$AVcl+model_out_dat$IVch+model_out_dat$IVcl+
  model_out_dat$RVch+model_out_dat$RVcl+model_out_dat$SVch+model_out_dat$SVcl+
  model_out_dat$EVch2+model_out_dat$EVcl2+model_out_dat$AVch2+model_out_dat$AVcl2+
  model_out_dat$IVch2+model_out_dat$IVcl2+model_out_dat$RVch2+model_out_dat$RVcl2+
  
  model_out_dat$DVch+model_out_dat$DVcl+model_out_dat$DVch2+model_out_dat$DVcl2+
  model_out_dat$DBch+model_out_dat$DBcl+model_out_dat$DBch2+model_out_dat$DBcl2


model_out_dat$pboost.coverage_of_vaccinated<-(model_out_dat$Nboosted.adult+model_out_dat$Nboosted.old + model_out_dat$Nboosted.child)/(model_out_dat$Nvax.adult+model_out_dat$Nvax.old+model_out_dat$Nvax.child)


model_out_dat <- model_out_dat %>% 
  pivot_longer(-c(time, boost.speed, sweepnum, boost.child, cvax, relativeFOI,
                  boost.adult, max.boost_h, max.boost_l, max.boost.child, wanevar,
                  child.max,cp,base.imm,sd0,relax,boost.start,dWVH,k_h,k_l,
                  vei2,veh2,popsize, boost.start.time, Booster
  )) %>% 
  filter(name %in% c("Iall", "Iprop", "pboost.coverage_of_vaccinated"))


write_csv(model_out_dat, "../Data/ODE Supplement/Ecuador_ts_altbeta.csv")
```

##### India time series
```{r}

#### India time series ####

load('../Data/ODE outputs SA/sweep_010324_indiaboost_Evax.RData')
model_out_dat$sweepnum<-rep(seq(from=1, to=27), each=196)
model_out_dat$Iall<-model_out_dat$Ich+model_out_dat$Ich2+model_out_dat$IVch+model_out_dat$IVch2+model_out_dat$IBch+model_out_dat$IBch2+
  model_out_dat$Iah+model_out_dat$Iah2+model_out_dat$IVah+model_out_dat$IVah2+model_out_dat$IBah+model_out_dat$IBah2+
  model_out_dat$Ieh+model_out_dat$Ieh2+model_out_dat$IVeh+model_out_dat$IVeh2+model_out_dat$IBeh+model_out_dat$IBeh2+
  model_out_dat$Icl+model_out_dat$Icl2+model_out_dat$IVcl+model_out_dat$IVcl2+model_out_dat$IBcl+model_out_dat$IBcl2+
  model_out_dat$Ial+model_out_dat$Ial2+model_out_dat$IVal+model_out_dat$IVal2+model_out_dat$IBal+model_out_dat$IBal2+
  model_out_dat$Iel+model_out_dat$Iel2+model_out_dat$IVel+model_out_dat$IVel2+model_out_dat$IBel+model_out_dat$IBel2+
  #
  model_out_dat$Ach+model_out_dat$Ach2+model_out_dat$AVch+model_out_dat$AVch2+model_out_dat$ABch+model_out_dat$ABch2+
  model_out_dat$Aah+model_out_dat$Aah2+model_out_dat$AVah+model_out_dat$AVah2+model_out_dat$ABah+model_out_dat$ABah2+
  model_out_dat$Aeh+model_out_dat$Aeh2+model_out_dat$AVeh+model_out_dat$AVeh2+model_out_dat$ABeh+model_out_dat$ABeh2+
  model_out_dat$Acl+model_out_dat$Acl2+model_out_dat$AVcl+model_out_dat$AVcl2+model_out_dat$ABcl+model_out_dat$ABcl2+
  model_out_dat$Aal+model_out_dat$Aal2+model_out_dat$AVal+model_out_dat$AVal2+model_out_dat$ABal+model_out_dat$ABal2+
  model_out_dat$Ael+model_out_dat$Ael2+model_out_dat$AVel+model_out_dat$AVel2+model_out_dat$ABel+model_out_dat$ABel2
model_out_dat$popsize<-1155561222
model_out_dat$Iprop<-model_out_dat$Iall/model_out_dat$popsize*100
model_out_dat$relativeFOI<-paste(model_out_dat$relax*100, '% increase in FOI', sep='')
model_out_dat$boost.start.time<-paste('Start boosting ', model_out_dat$boost.start, ' days prior to omicron*')
model_out_dat$Booster<-NA
model_out_dat$Booster[which(model_out_dat$boost.adult==0)]<-'None'
model_out_dat$Booster[which(model_out_dat$boost.adult==1 & model_out_dat$veh2==0.657)]<-'Monovalent'
model_out_dat$Booster[which(model_out_dat$boost.adult==1 & model_out_dat$veh2==0.925)]<-'Bivalent'


## Boosted adults
model_out_dat$Nboosted.adult<-model_out_dat$SBah+model_out_dat$SBal+
  model_out_dat$EBah+model_out_dat$EBal+
  model_out_dat$ABah+model_out_dat$ABal+
  model_out_dat$IBah+model_out_dat$IBal+
  model_out_dat$RBah+model_out_dat$RBal+
  model_out_dat$SBah2+model_out_dat$SBal2+
  model_out_dat$EBah2+model_out_dat$EBal2+
  model_out_dat$ABah2+model_out_dat$ABal2+
  model_out_dat$IBah2+model_out_dat$IBal2+
  model_out_dat$RBah2+model_out_dat$RBal2+
  model_out_dat$DBah+model_out_dat$DBal+
  model_out_dat$DBah2+model_out_dat$DBal2

### Vaccinated adults
model_out_dat$Nvax.adult<-model_out_dat$SBah+model_out_dat$SBal+model_out_dat$EBah+model_out_dat$EBal+
    model_out_dat$ABah+model_out_dat$ABal+model_out_dat$IBah+model_out_dat$IBal+
    model_out_dat$RBah+model_out_dat$RBal+
    model_out_dat$SBah2+model_out_dat$SBal2+
    model_out_dat$EBah2+model_out_dat$EBal2+
    model_out_dat$ABah2+model_out_dat$ABal2+
    model_out_dat$IBah2+model_out_dat$IBal2+
    model_out_dat$RBah2+model_out_dat$RBal2+
  
  model_out_dat$SVah+model_out_dat$SVal+model_out_dat$EVah+model_out_dat$EVal+
  model_out_dat$AVah+model_out_dat$AVal+model_out_dat$IVah+model_out_dat$IVal+
  model_out_dat$RVah+model_out_dat$RVal+model_out_dat$SVah+model_out_dat$SVal+
  model_out_dat$EVah2+model_out_dat$EVal2+model_out_dat$AVah2+model_out_dat$AVal2+
  model_out_dat$IVah2+model_out_dat$IVal2+model_out_dat$RVah2+model_out_dat$RVal2+
  
  model_out_dat$DVah+model_out_dat$DVal+model_out_dat$DVah2+model_out_dat$DVal2+
  model_out_dat$DBah+model_out_dat$DBal+model_out_dat$DBah2+model_out_dat$DBal2

## Boosted elderly
model_out_dat$Nboosted.old<-model_out_dat$SBeh+model_out_dat$SBel+
  model_out_dat$EBeh+model_out_dat$EBel+
  model_out_dat$ABeh+model_out_dat$ABel+
  model_out_dat$IBeh+model_out_dat$IBel+
  model_out_dat$RBeh+model_out_dat$RBel+
  model_out_dat$SBeh2+model_out_dat$SBel2+
  model_out_dat$EBeh2+model_out_dat$EBel2+
  model_out_dat$ABeh2+model_out_dat$ABel2+
  model_out_dat$IBeh2+model_out_dat$IBel2+
  model_out_dat$RBeh2+model_out_dat$RBel2+
  model_out_dat$DBeh+model_out_dat$DBel+
  model_out_dat$DBeh2+model_out_dat$DBel2

## Vaccinated elderly
model_out_dat$Nvax.old<-model_out_dat$SBeh+model_out_dat$SBel+
  model_out_dat$EBeh+model_out_dat$EBel+
  model_out_dat$ABeh+model_out_dat$ABel+
  model_out_dat$IBeh+model_out_dat$IBel+
  model_out_dat$RBeh+model_out_dat$RBel+
  model_out_dat$SBeh2+model_out_dat$SBel2+
  model_out_dat$EBeh2+model_out_dat$EBel2+
  model_out_dat$ABeh2+model_out_dat$ABel2+
  model_out_dat$IBeh2+model_out_dat$IBel2+
  model_out_dat$RBeh2+model_out_dat$RBel2+
  model_out_dat$DBeh+model_out_dat$DBel+
  model_out_dat$DBeh2+model_out_dat$DBel2+
  
  model_out_dat$SVeh+model_out_dat$SVel+model_out_dat$EVeh+model_out_dat$EVel+
  model_out_dat$AVeh+model_out_dat$AVel+model_out_dat$IVeh+model_out_dat$IVel+
  model_out_dat$RVeh+model_out_dat$RVel+model_out_dat$SVeh+model_out_dat$SVel+
  model_out_dat$EVeh2+model_out_dat$EVel2+model_out_dat$AVeh2+model_out_dat$AVel2+
  model_out_dat$IVeh2+model_out_dat$IVel2+model_out_dat$RVeh2+model_out_dat$RVel2+
  model_out_dat$DVeh+model_out_dat$DVel+model_out_dat$DVeh2+model_out_dat$DVel2


## Boosted child
model_out_dat$Nboosted.child<-model_out_dat$SBch+model_out_dat$SBcl+
  model_out_dat$EBch+model_out_dat$EBcl+
  model_out_dat$ABch+model_out_dat$ABcl+
  model_out_dat$IBch+model_out_dat$IBcl+
  model_out_dat$RBch+model_out_dat$RBcl+
  model_out_dat$SBch2+model_out_dat$SBcl2+
  model_out_dat$EBch2+model_out_dat$EBcl2+
  model_out_dat$ABch2+model_out_dat$ABcl2+
  model_out_dat$IBch2+model_out_dat$IBcl2+
  model_out_dat$RBch2+model_out_dat$RBcl2+
  model_out_dat$DBch+model_out_dat$DBcl+
  model_out_dat$DBch2+model_out_dat$DBcl2


## Vaccinated child
model_out_dat$Nvax.child<-model_out_dat$SBch+model_out_dat$SBcl+model_out_dat$EBch+model_out_dat$EBcl+
    model_out_dat$ABch+model_out_dat$ABcl+model_out_dat$IBch+model_out_dat$IBcl+
    model_out_dat$RBch+model_out_dat$RBcl+
    model_out_dat$SBch2+model_out_dat$SBcl2+
    model_out_dat$EBch2+model_out_dat$EBcl2+
    model_out_dat$ABch2+model_out_dat$ABcl2+
    model_out_dat$IBch2+model_out_dat$IBcl2+
    model_out_dat$RBch2+model_out_dat$RBcl2+
  
  model_out_dat$SVch+model_out_dat$SVcl+model_out_dat$EVch+model_out_dat$EVcl+
  model_out_dat$AVch+model_out_dat$AVcl+model_out_dat$IVch+model_out_dat$IVcl+
  model_out_dat$RVch+model_out_dat$RVcl+model_out_dat$SVch+model_out_dat$SVcl+
  model_out_dat$EVch2+model_out_dat$EVcl2+model_out_dat$AVch2+model_out_dat$AVcl2+
  model_out_dat$IVch2+model_out_dat$IVcl2+model_out_dat$RVch2+model_out_dat$RVcl2+
  
  model_out_dat$DVch+model_out_dat$DVcl+model_out_dat$DVch2+model_out_dat$DVcl2+
  model_out_dat$DBch+model_out_dat$DBcl+model_out_dat$DBch2+model_out_dat$DBcl2


model_out_dat$pboost.coverage_of_vaccinated<-(model_out_dat$Nboosted.adult+model_out_dat$Nboosted.old + model_out_dat$Nboosted.child)/(model_out_dat$Nvax.adult+model_out_dat$Nvax.old+model_out_dat$Nvax.child)


model_out_dat <- model_out_dat %>% 
  pivot_longer(-c(time, boost.speed, sweepnum, boost.child, cvax, relativeFOI,
                  boost.adult, max.boost_h, max.boost_l, max.boost.child, wanevar,
                  child.max,cp,base.imm,sd,relax,boost.start,dWVH,k_h,k_l,
                  vei2,veh2,popsize, boost.start.time, Booster
  )) %>% 
  filter(name %in% c("Iall", "Iprop", "pboost.coverage_of_vaccinated"))


write_csv(model_out_dat, "../Data/ODE Supplement/India_ts_altbeta.csv")

```



#### Run w/o reduced infectiousness, match to R0

##### Malaysia grid
```{r}
#### Malaysia grid ####

end_malaysia_sweep<-readRDS('../Data/ODE outputs SA - ABM beta/endfile_sweep010224_malaysiagrid_Evax.RDS')
end_malaysia_sweep$popsize<-28552712
end_malaysia_sweep$deaths_100k<-(end_malaysia_sweep$DeathsAll/end_malaysia_sweep$popsize)*100000
end_noboost_malaysia<-subset(end_malaysia_sweep, end_malaysia_sweep$boost.adult==0)
end_boost_malaysia<-subset(end_malaysia_sweep, end_malaysia_sweep$boost.adult>0)
sum(end_malaysia_sweep[1,c(2:217)])

end_boost <-end_boost_malaysia %>% 
  pivot_longer(-c(time, boost.speed, sweepnum, boost.child, cvax,
                  boost.adult, max.boost_h, max.boost_l, max.boost.child, wanevar,
                  child.max,cp,base.imm,sd,relax,boost.start,dWVH,k_h,k_l,
                  vei2,veh2,DeathsAll,popsize,deaths_100k
  ))
end_no_boost <- end_noboost_malaysia %>% 
  pivot_longer(-c(time, boost.speed, sweepnum, boost.child, cvax,
                  boost.adult, max.boost_h, max.boost_l, max.boost.child, wanevar,
                  child.max,cp,base.imm,sd,relax,boost.start,dWVH,k_h,k_l,
                  vei2,veh2,DeathsAll,popsize,deaths_100k
  ))

dfCompODE <- end_noboost_malaysia %>% 
  select(deaths_100k, DeathsAll, cp, relax, 
         base.imm) %>% distinct() %>% 
  rename(deaths_100k_comp = deaths_100k,
         DeathsAll_comp = DeathsAll)

df_AvertedODE <- end_boost %>% 
  left_join(dfCompODE, by = c("relax", "cp", "base.imm")) %>% 
  mutate(
    da = (deaths_100k_comp - deaths_100k)/deaths_100k_comp
  ) %>% 
  distinct() %>% 
  filter(
    veh2==0.657 | (veh2 == max(veh2) & vei2 == max(vei2))
  ) %>% 
  mutate(
    Booster = if_else(
      veh2 == 0.657, "Monovalent",
      "Bivalent"
    )
  )%>%
  mutate(name = NULL, value = NULL) %>%
  distinct()

write_csv(df_AvertedODE, "../Data/ODE Supplement/Malaysia_grid_da_altbetaR0.csv")
```


##### Ecuador grid
```{r}
#### Ecuador grid ####

end_ecuador_sweep<-readRDS('../Data/ODE outputs SA - ABM beta/endfile_sweep010424_ecuadorgrid.RDS')
end_ecuador_sweep$popsize<-15735139
end_ecuador_sweep$deaths_100k<-(end_ecuador_sweep$DeathsAll/end_ecuador_sweep$popsize)*100000
end_noboost_ecuador<-subset(end_ecuador_sweep, end_ecuador_sweep$boost.adult==0)
end_boost_ecuador<-subset(end_ecuador_sweep, end_ecuador_sweep$boost.adult>0)
sum(end_ecuador_sweep[1,c(2:217)])

end_boost <-end_boost_ecuador %>% 
  pivot_longer(-c(time, boost.speed, sweepnum, boost.child, cvax,
                  boost.adult, max.boost_h, max.boost_l, max.boost.child, wanevar,
                  child.max,cp,base.imm,sd,relax,boost.start,dWVH,k_h,k_l,
                  vei2,veh2,DeathsAll,popsize,deaths_100k
  ))
end_no_boost <- end_noboost_ecuador %>% 
  pivot_longer(-c(time, boost.speed, sweepnum, boost.child, cvax,
                  boost.adult, max.boost_h, max.boost_l, max.boost.child, wanevar,
                  child.max,cp,base.imm,sd,relax,boost.start,dWVH,k_h,k_l,
                  vei2,veh2,DeathsAll,popsize,deaths_100k
  ))

dfCompODE <- end_noboost_ecuador %>% 
  select(deaths_100k, DeathsAll, cp, relax, 
         base.imm) %>% distinct() %>% 
  rename(deaths_100k_comp = deaths_100k,
         DeathsAll_comp = DeathsAll)

df_AvertedODE <- end_boost %>% 
  left_join(dfCompODE, by = c("relax", "cp", "base.imm")) %>% 
  mutate(
    da = (deaths_100k_comp - deaths_100k)/deaths_100k_comp
  ) %>% 
  distinct() %>% 
  filter(
    veh2==0.657 | (veh2 == max(veh2) & vei2 == max(vei2))
  ) %>% 
  mutate(
    Booster = if_else(
      veh2 == 0.657, "Monovalent",
      "Bivalent"
    )
  )%>%
  mutate(name = NULL, value = NULL) %>%
  distinct()

write_csv(df_AvertedODE, "../Data/ODE Supplement/Ecuador_grid_da_altbetaR0.csv")
```

##### India grid
```{r}
#### India grid ####

end_india_sweep<-readRDS('../Data/ODE outputs SA - ABM beta/endfile_sweep010324_indiagrid_Evax.RDS')
end_india_sweep$popsize<-1155561222
end_india_sweep$deaths_100k<-(end_india_sweep$DeathsAll/end_india_sweep$popsize)*100000
end_noboost_india<-subset(end_india_sweep, end_india_sweep$boost.adult==0)
end_boost_india<-subset(end_india_sweep, end_india_sweep$boost.adult>0)
sum(end_india_sweep[1,c(2:217)])

end_boost <-end_boost_india %>% 
  pivot_longer(-c(time, boost.speed, sweepnum, boost.child, cvax,
                  boost.adult, max.boost_h, max.boost_l, max.boost.child, wanevar,
                  child.max,cp,base.imm,sd,relax,boost.start,dWVH,k_h,k_l,
                  vei2,veh2,DeathsAll,popsize,deaths_100k
  ))
end_no_boost <- end_noboost_india %>% 
  pivot_longer(-c(time, boost.speed, sweepnum, boost.child, cvax,
                  boost.adult, max.boost_h, max.boost_l, max.boost.child, wanevar,
                  child.max,cp,base.imm,sd,relax,boost.start,dWVH,k_h,k_l,
                  vei2,veh2,DeathsAll,popsize,deaths_100k
  ))

dfCompODE <- end_noboost_india %>% 
  select(deaths_100k, DeathsAll, cp, relax, 
         base.imm) %>% distinct() %>% 
  rename(deaths_100k_comp = deaths_100k,
         DeathsAll_comp = DeathsAll)

df_AvertedODE <- end_boost %>% 
  left_join(dfCompODE, by = c("relax", "cp", "base.imm")) %>% 
  mutate(
    da = (deaths_100k_comp - deaths_100k)/deaths_100k_comp
  ) %>% 
  distinct() %>% 
  filter(
    veh2==0.657 | (veh2 == max(veh2) & vei2 == max(vei2))
  ) %>% 
  mutate(
    Booster = if_else(
      veh2 == 0.657, "Monovalent",
      "Bivalent"
    )
  )%>%
  mutate(name = NULL, value = NULL) %>%
  distinct()

write_csv(df_AvertedODE, "../Data/ODE Supplement/India_grid_da_altbetaR0.csv")
```


##### Malaysia deaths averted
```{r}
#### Malaysia runs ####

end_malaysia_sweep<-readRDS('../Data/ODE outputs SA - ABM beta/endfile_sweep010224_malaysiaboost_Evax.RDS')
end_malaysia_sweep$popsize<-28552712
end_malaysia_sweep$deaths_100k<-(end_malaysia_sweep$DeathsAll/end_malaysia_sweep$popsize)*100000
end_noboost_malaysia<-subset(end_malaysia_sweep, end_malaysia_sweep$boost.adult==0)
end_boost_malaysia<-subset(end_malaysia_sweep, end_malaysia_sweep$boost.adult>0)
sum(end_malaysia_sweep[1,c(2:217)])

end_boost <-end_boost_malaysia %>% 
  pivot_longer(-c(time, boost.speed, sweepnum, boost.child, cvax,
                  boost.adult, max.boost_h, max.boost_l, max.boost.child, wanevar,
                  child.max,cp,base.imm,sd,relax,boost.start,dWVH,k_h,k_l,
                  vei2,veh2,DeathsAll,popsize,deaths_100k
  ))
end_no_boost <- end_noboost_malaysia %>% 
  pivot_longer(-c(time, boost.speed, sweepnum, boost.child, cvax,
                  boost.adult, max.boost_h, max.boost_l, max.boost.child, wanevar,
                  child.max,cp,base.imm,sd,relax,boost.start,dWVH,k_h,k_l,
                  vei2,veh2,DeathsAll,popsize,deaths_100k
  ))

dfCompODE <- end_noboost_malaysia %>% 
  select(deaths_100k, DeathsAll, cp, relax, 
         base.imm) %>% distinct() %>% 
  rename(deaths_100k_comp = deaths_100k,
         DeathsAll_comp = DeathsAll)

df_AvertedODE <- end_boost %>% 
  left_join(dfCompODE, by = c("relax", "cp", "base.imm")) %>% 
  mutate(
    da = (deaths_100k_comp - deaths_100k)/deaths_100k_comp
  ) %>% 
  distinct() %>% 
  filter(
    veh2==0.657 | (veh2 == max(veh2) & vei2 == max(vei2))
  ) %>% 
  mutate(
    Booster = if_else(
      veh2 == 0.657, "Monovalent",
      "Bivalent"
    )
  ) %>%
  mutate(name = NULL, value = NULL) %>%
  distinct()

write_csv(df_AvertedODE, "../Data/ODE Supplement/Malaysia_run_da_altbetaR0.csv")
```

##### Ecuador deaths averted
```{r}

#### Ecuador runs ####

end_ecuador_sweep<-readRDS('../Data/ODE outputs SA - ABM beta/endfile_sweep010424_ecuadorboost_Evax.RDS') %>% 
  rename(sd = sd0)
end_ecuador_sweep$popsize<-15735139
end_ecuador_sweep$deaths_100k<-(end_ecuador_sweep$DeathsAll/end_ecuador_sweep$popsize)*100000
end_noboost_ecuador<-subset(end_ecuador_sweep, end_ecuador_sweep$boost.adult==0)
end_boost_ecuador<-subset(end_ecuador_sweep, end_ecuador_sweep$boost.adult>0)
sum(end_ecuador_sweep[1,c(2:217)])

end_boost <-end_boost_ecuador %>% 
  pivot_longer(-c(time, boost.speed, sweepnum, boost.child, cvax,
                  boost.adult, max.boost_h, max.boost_l, max.boost.child, wanevar,
                  child.max,cp,base.imm,sd,relax,boost.start,dWVH,k_h,k_l,
                  vei2,veh2,DeathsAll,popsize,deaths_100k
  ))
end_no_boost <- end_noboost_ecuador %>% 
  pivot_longer(-c(time, boost.speed, sweepnum, boost.child, cvax,
                  boost.adult, max.boost_h, max.boost_l, max.boost.child, wanevar,
                  child.max,cp,base.imm,sd,relax,boost.start,dWVH,k_h,k_l,
                  vei2,veh2,DeathsAll,popsize,deaths_100k
  ))

dfCompODE <- end_noboost_ecuador %>% 
  select(deaths_100k, DeathsAll, cp, relax, 
         base.imm) %>% distinct() %>% 
  rename(deaths_100k_comp = deaths_100k,
         DeathsAll_comp = DeathsAll)

df_AvertedODE <- end_boost %>% 
  left_join(dfCompODE, by = c("relax", "cp", "base.imm")) %>% 
  mutate(
    da = (deaths_100k_comp - deaths_100k)/deaths_100k_comp
  ) %>% 
  distinct() %>% 
  filter(
    veh2==0.657 | (veh2 == max(veh2) & vei2 == max(vei2))
  ) %>% 
  mutate(
    Booster = if_else(
      veh2 == 0.657, "Monovalent",
      "Bivalent"
    )
  ) %>%
  mutate(name = NULL, value = NULL) %>%
  distinct()

write_csv(df_AvertedODE, "../Data/ODE Supplement/Ecuador_run_da_altbetaR0.csv")
```

##### India deaths averted
```{r}
#### India runs ####

end_india_sweep<-readRDS('../Data/ODE outputs SA - ABM beta/endfile_sweep010324_indiaboost_Evax.RDS')
end_india_sweep$popsize<-1155561222
end_india_sweep$deaths_100k<-(end_india_sweep$DeathsAll/end_india_sweep$popsize)*100000
end_noboost_india<-subset(end_india_sweep, end_india_sweep$boost.adult==0)
end_boost_india<-subset(end_india_sweep, end_india_sweep$boost.adult>0)
sum(end_india_sweep[1,c(2:217)])

end_boost <-end_boost_india %>% 
  pivot_longer(-c(time, boost.speed, sweepnum, boost.child, cvax,
                  boost.adult, max.boost_h, max.boost_l, max.boost.child, wanevar,
                  child.max,cp,base.imm,sd,relax,boost.start,dWVH,k_h,k_l,
                  vei2,veh2,DeathsAll,popsize,deaths_100k
  ))
end_no_boost <- end_noboost_india %>% 
  pivot_longer(-c(time, boost.speed, sweepnum, boost.child, cvax,
                  boost.adult, max.boost_h, max.boost_l, max.boost.child, wanevar,
                  child.max,cp,base.imm,sd,relax,boost.start,dWVH,k_h,k_l,
                  vei2,veh2,DeathsAll,popsize,deaths_100k
  ))

dfCompODE <- end_noboost_india %>% 
  select(deaths_100k, DeathsAll, cp, relax, 
         base.imm) %>% distinct() %>% 
  rename(deaths_100k_comp = deaths_100k,
         DeathsAll_comp = DeathsAll)

df_AvertedODE <- end_boost %>% 
  left_join(dfCompODE, by = c("relax", "cp", "base.imm")) %>% 
  mutate(
    da = (deaths_100k_comp - deaths_100k)/deaths_100k_comp
  ) %>% 
  distinct() %>% 
  filter(
    veh2==0.657 | (veh2 == max(veh2) & vei2 == max(vei2))
  ) %>% 
  mutate(
    Booster = if_else(
      veh2 == 0.657, "Monovalent",
      "Bivalent"
    )
  ) %>%
  mutate(name = NULL, value = NULL) %>%
  distinct()

write_csv(df_AvertedODE, "../Data/ODE Supplement/India_run_da_altbetaR0.csv")
```

##### Malaysia time series
```{r}

#### Malaysia time series ####

load('../Data/ODE outputs SA - ABM beta/sweep_010224_malaysiaboost_Evax.RData')
model_out_dat$sweepnum<-rep(seq(from=1, to=27), each=196)
model_out_dat$Iall<-model_out_dat$Ich+model_out_dat$Ich2+model_out_dat$IVch+model_out_dat$IVch2+model_out_dat$IBch+model_out_dat$IBch2+
  model_out_dat$Iah+model_out_dat$Iah2+model_out_dat$IVah+model_out_dat$IVah2+model_out_dat$IBah+model_out_dat$IBah2+
  model_out_dat$Ieh+model_out_dat$Ieh2+model_out_dat$IVeh+model_out_dat$IVeh2+model_out_dat$IBeh+model_out_dat$IBeh2+
  model_out_dat$Icl+model_out_dat$Icl2+model_out_dat$IVcl+model_out_dat$IVcl2+model_out_dat$IBcl+model_out_dat$IBcl2+
  model_out_dat$Ial+model_out_dat$Ial2+model_out_dat$IVal+model_out_dat$IVal2+model_out_dat$IBal+model_out_dat$IBal2+
  model_out_dat$Iel+model_out_dat$Iel2+model_out_dat$IVel+model_out_dat$IVel2+model_out_dat$IBel+model_out_dat$IBel2+
  #
  model_out_dat$Ach+model_out_dat$Ach2+model_out_dat$AVch+model_out_dat$AVch2+model_out_dat$ABch+model_out_dat$ABch2+
  model_out_dat$Aah+model_out_dat$Aah2+model_out_dat$AVah+model_out_dat$AVah2+model_out_dat$ABah+model_out_dat$ABah2+
  model_out_dat$Aeh+model_out_dat$Aeh2+model_out_dat$AVeh+model_out_dat$AVeh2+model_out_dat$ABeh+model_out_dat$ABeh2+
  model_out_dat$Acl+model_out_dat$Acl2+model_out_dat$AVcl+model_out_dat$AVcl2+model_out_dat$ABcl+model_out_dat$ABcl2+
  model_out_dat$Aal+model_out_dat$Aal2+model_out_dat$AVal+model_out_dat$AVal2+model_out_dat$ABal+model_out_dat$ABal2+
  model_out_dat$Ael+model_out_dat$Ael2+model_out_dat$AVel+model_out_dat$AVel2+model_out_dat$ABel+model_out_dat$ABel2
model_out_dat$popsize<-28552712
model_out_dat$Iprop<-model_out_dat$Iall/model_out_dat$popsize*100
model_out_dat$relativeFOI<-paste(model_out_dat$relax*100, '% increase in FOI', sep='')
model_out_dat$boost.start.time<-paste('Start boosting ', model_out_dat$boost.start, ' days prior to omicron*')
model_out_dat$Booster<-NA
model_out_dat$Booster[which(model_out_dat$boost.adult==0)]<-'None'
model_out_dat$Booster[which(model_out_dat$boost.adult==1 & model_out_dat$veh2==0.657)]<-'Monovalent'
model_out_dat$Booster[which(model_out_dat$boost.adult==1 & model_out_dat$veh2==0.925)]<-'Bivalent'


## Boosted adults
model_out_dat$Nboosted.adult<-model_out_dat$SBah+model_out_dat$SBal+
  model_out_dat$EBah+model_out_dat$EBal+
  model_out_dat$ABah+model_out_dat$ABal+
  model_out_dat$IBah+model_out_dat$IBal+
  model_out_dat$RBah+model_out_dat$RBal+
  model_out_dat$SBah2+model_out_dat$SBal2+
  model_out_dat$EBah2+model_out_dat$EBal2+
  model_out_dat$ABah2+model_out_dat$ABal2+
  model_out_dat$IBah2+model_out_dat$IBal2+
  model_out_dat$RBah2+model_out_dat$RBal2+
  model_out_dat$DBah+model_out_dat$DBal+
  model_out_dat$DBah2+model_out_dat$DBal2

### Vaccinated adults
model_out_dat$Nvax.adult<-model_out_dat$SBah+model_out_dat$SBal+model_out_dat$EBah+model_out_dat$EBal+
    model_out_dat$ABah+model_out_dat$ABal+model_out_dat$IBah+model_out_dat$IBal+
    model_out_dat$RBah+model_out_dat$RBal+
    model_out_dat$SBah2+model_out_dat$SBal2+
    model_out_dat$EBah2+model_out_dat$EBal2+
    model_out_dat$ABah2+model_out_dat$ABal2+
    model_out_dat$IBah2+model_out_dat$IBal2+
    model_out_dat$RBah2+model_out_dat$RBal2+
  
  model_out_dat$SVah+model_out_dat$SVal+model_out_dat$EVah+model_out_dat$EVal+
  model_out_dat$AVah+model_out_dat$AVal+model_out_dat$IVah+model_out_dat$IVal+
  model_out_dat$RVah+model_out_dat$RVal+model_out_dat$SVah+model_out_dat$SVal+
  model_out_dat$EVah2+model_out_dat$EVal2+model_out_dat$AVah2+model_out_dat$AVal2+
  model_out_dat$IVah2+model_out_dat$IVal2+model_out_dat$RVah2+model_out_dat$RVal2+
  
  model_out_dat$DVah+model_out_dat$DVal+model_out_dat$DVah2+model_out_dat$DVal2+
  model_out_dat$DBah+model_out_dat$DBal+model_out_dat$DBah2+model_out_dat$DBal2

## Boosted elderly
model_out_dat$Nboosted.old<-model_out_dat$SBeh+model_out_dat$SBel+
  model_out_dat$EBeh+model_out_dat$EBel+
  model_out_dat$ABeh+model_out_dat$ABel+
  model_out_dat$IBeh+model_out_dat$IBel+
  model_out_dat$RBeh+model_out_dat$RBel+
  model_out_dat$SBeh2+model_out_dat$SBel2+
  model_out_dat$EBeh2+model_out_dat$EBel2+
  model_out_dat$ABeh2+model_out_dat$ABel2+
  model_out_dat$IBeh2+model_out_dat$IBel2+
  model_out_dat$RBeh2+model_out_dat$RBel2+
  model_out_dat$DBeh+model_out_dat$DBel+
  model_out_dat$DBeh2+model_out_dat$DBel2

## Vaccinated elderly
model_out_dat$Nvax.old<-model_out_dat$SBeh+model_out_dat$SBel+
  model_out_dat$EBeh+model_out_dat$EBel+
  model_out_dat$ABeh+model_out_dat$ABel+
  model_out_dat$IBeh+model_out_dat$IBel+
  model_out_dat$RBeh+model_out_dat$RBel+
  model_out_dat$SBeh2+model_out_dat$SBel2+
  model_out_dat$EBeh2+model_out_dat$EBel2+
  model_out_dat$ABeh2+model_out_dat$ABel2+
  model_out_dat$IBeh2+model_out_dat$IBel2+
  model_out_dat$RBeh2+model_out_dat$RBel2+
  model_out_dat$DBeh+model_out_dat$DBel+
  model_out_dat$DBeh2+model_out_dat$DBel2+
  
  model_out_dat$SVeh+model_out_dat$SVel+model_out_dat$EVeh+model_out_dat$EVel+
  model_out_dat$AVeh+model_out_dat$AVel+model_out_dat$IVeh+model_out_dat$IVel+
  model_out_dat$RVeh+model_out_dat$RVel+model_out_dat$SVeh+model_out_dat$SVel+
  model_out_dat$EVeh2+model_out_dat$EVel2+model_out_dat$AVeh2+model_out_dat$AVel2+
  model_out_dat$IVeh2+model_out_dat$IVel2+model_out_dat$RVeh2+model_out_dat$RVel2+
  model_out_dat$DVeh+model_out_dat$DVel+model_out_dat$DVeh2+model_out_dat$DVel2


## Boosted child
model_out_dat$Nboosted.child<-model_out_dat$SBch+model_out_dat$SBcl+
  model_out_dat$EBch+model_out_dat$EBcl+
  model_out_dat$ABch+model_out_dat$ABcl+
  model_out_dat$IBch+model_out_dat$IBcl+
  model_out_dat$RBch+model_out_dat$RBcl+
  model_out_dat$SBch2+model_out_dat$SBcl2+
  model_out_dat$EBch2+model_out_dat$EBcl2+
  model_out_dat$ABch2+model_out_dat$ABcl2+
  model_out_dat$IBch2+model_out_dat$IBcl2+
  model_out_dat$RBch2+model_out_dat$RBcl2+
  model_out_dat$DBch+model_out_dat$DBcl+
  model_out_dat$DBch2+model_out_dat$DBcl2


## Vaccinated child
model_out_dat$Nvax.child<-model_out_dat$SBch+model_out_dat$SBcl+model_out_dat$EBch+model_out_dat$EBcl+
    model_out_dat$ABch+model_out_dat$ABcl+model_out_dat$IBch+model_out_dat$IBcl+
    model_out_dat$RBch+model_out_dat$RBcl+
    model_out_dat$SBch2+model_out_dat$SBcl2+
    model_out_dat$EBch2+model_out_dat$EBcl2+
    model_out_dat$ABch2+model_out_dat$ABcl2+
    model_out_dat$IBch2+model_out_dat$IBcl2+
    model_out_dat$RBch2+model_out_dat$RBcl2+
  
  model_out_dat$SVch+model_out_dat$SVcl+model_out_dat$EVch+model_out_dat$EVcl+
  model_out_dat$AVch+model_out_dat$AVcl+model_out_dat$IVch+model_out_dat$IVcl+
  model_out_dat$RVch+model_out_dat$RVcl+model_out_dat$SVch+model_out_dat$SVcl+
  model_out_dat$EVch2+model_out_dat$EVcl2+model_out_dat$AVch2+model_out_dat$AVcl2+
  model_out_dat$IVch2+model_out_dat$IVcl2+model_out_dat$RVch2+model_out_dat$RVcl2+
  
  model_out_dat$DVch+model_out_dat$DVcl+model_out_dat$DVch2+model_out_dat$DVcl2+
  model_out_dat$DBch+model_out_dat$DBcl+model_out_dat$DBch2+model_out_dat$DBcl2


model_out_dat$pboost.coverage_of_vaccinated<-(model_out_dat$Nboosted.adult+model_out_dat$Nboosted.old + model_out_dat$Nboosted.child)/(model_out_dat$Nvax.adult+model_out_dat$Nvax.old+model_out_dat$Nvax.child)


model_out_dat <- model_out_dat %>% 
  pivot_longer(-c(time, boost.speed, sweepnum, boost.child, cvax, relativeFOI,
                  boost.adult, max.boost_h, max.boost_l, max.boost.child, wanevar,
                  child.max,cp,base.imm,sd,relax,boost.start,dWVH,k_h,k_l,
                  vei2,veh2,popsize, boost.start.time, Booster
  )) %>% 
  filter(name %in% c("Iall", "Iprop", "pboost.coverage_of_vaccinated"))

write_csv(model_out_dat, "../Data/ODE Supplement/Malaysia_ts_altbetaR0.csv")
```

##### Ecuador time series
```{r}

#### Ecuador time series ####

load('../Data/ODE outputs SA - ABM beta/sweep_010424_ecuadorboost_Evax.RData')
model_out_dat$sweepnum<-rep(seq(from=1, to=27), each=196)
model_out_dat$Iall<-model_out_dat$Ich+model_out_dat$Ich2+model_out_dat$IVch+model_out_dat$IVch2+model_out_dat$IBch+model_out_dat$IBch2+
  model_out_dat$Iah+model_out_dat$Iah2+model_out_dat$IVah+model_out_dat$IVah2+model_out_dat$IBah+model_out_dat$IBah2+
  model_out_dat$Ieh+model_out_dat$Ieh2+model_out_dat$IVeh+model_out_dat$IVeh2+model_out_dat$IBeh+model_out_dat$IBeh2+
  model_out_dat$Icl+model_out_dat$Icl2+model_out_dat$IVcl+model_out_dat$IVcl2+model_out_dat$IBcl+model_out_dat$IBcl2+
  model_out_dat$Ial+model_out_dat$Ial2+model_out_dat$IVal+model_out_dat$IVal2+model_out_dat$IBal+model_out_dat$IBal2+
  model_out_dat$Iel+model_out_dat$Iel2+model_out_dat$IVel+model_out_dat$IVel2+model_out_dat$IBel+model_out_dat$IBel2+
  #
  model_out_dat$Ach+model_out_dat$Ach2+model_out_dat$AVch+model_out_dat$AVch2+model_out_dat$ABch+model_out_dat$ABch2+
  model_out_dat$Aah+model_out_dat$Aah2+model_out_dat$AVah+model_out_dat$AVah2+model_out_dat$ABah+model_out_dat$ABah2+
  model_out_dat$Aeh+model_out_dat$Aeh2+model_out_dat$AVeh+model_out_dat$AVeh2+model_out_dat$ABeh+model_out_dat$ABeh2+
  model_out_dat$Acl+model_out_dat$Acl2+model_out_dat$AVcl+model_out_dat$AVcl2+model_out_dat$ABcl+model_out_dat$ABcl2+
  model_out_dat$Aal+model_out_dat$Aal2+model_out_dat$AVal+model_out_dat$AVal2+model_out_dat$ABal+model_out_dat$ABal2+
  model_out_dat$Ael+model_out_dat$Ael2+model_out_dat$AVel+model_out_dat$AVel2+model_out_dat$ABel+model_out_dat$ABel2
model_out_dat$popsize<-15735139
model_out_dat$Iprop<-model_out_dat$Iall/model_out_dat$popsize*100
model_out_dat$relativeFOI<-paste(model_out_dat$relax*100, '% increase in FOI', sep='')
model_out_dat$boost.start.time<-paste('Start boosting ', model_out_dat$boost.start, ' days prior to omicron*')
model_out_dat$Booster<-NA
model_out_dat$Booster[which(model_out_dat$boost.adult==0)]<-'None'
model_out_dat$Booster[which(model_out_dat$boost.adult==1 & model_out_dat$veh2==0.657)]<-'Monovalent'
model_out_dat$Booster[which(model_out_dat$boost.adult==1 & model_out_dat$veh2==0.925)]<-'Bivalent'

## Boosted adults
model_out_dat$Nboosted.adult<-model_out_dat$SBah+model_out_dat$SBal+
  model_out_dat$EBah+model_out_dat$EBal+
  model_out_dat$ABah+model_out_dat$ABal+
  model_out_dat$IBah+model_out_dat$IBal+
  model_out_dat$RBah+model_out_dat$RBal+
  model_out_dat$SBah2+model_out_dat$SBal2+
  model_out_dat$EBah2+model_out_dat$EBal2+
  model_out_dat$ABah2+model_out_dat$ABal2+
  model_out_dat$IBah2+model_out_dat$IBal2+
  model_out_dat$RBah2+model_out_dat$RBal2+
  model_out_dat$DBah+model_out_dat$DBal+
  model_out_dat$DBah2+model_out_dat$DBal2

### Vaccinated adults
model_out_dat$Nvax.adult<-model_out_dat$SBah+model_out_dat$SBal+model_out_dat$EBah+model_out_dat$EBal+
    model_out_dat$ABah+model_out_dat$ABal+model_out_dat$IBah+model_out_dat$IBal+
    model_out_dat$RBah+model_out_dat$RBal+
    model_out_dat$SBah2+model_out_dat$SBal2+
    model_out_dat$EBah2+model_out_dat$EBal2+
    model_out_dat$ABah2+model_out_dat$ABal2+
    model_out_dat$IBah2+model_out_dat$IBal2+
    model_out_dat$RBah2+model_out_dat$RBal2+
  
  model_out_dat$SVah+model_out_dat$SVal+model_out_dat$EVah+model_out_dat$EVal+
  model_out_dat$AVah+model_out_dat$AVal+model_out_dat$IVah+model_out_dat$IVal+
  model_out_dat$RVah+model_out_dat$RVal+model_out_dat$SVah+model_out_dat$SVal+
  model_out_dat$EVah2+model_out_dat$EVal2+model_out_dat$AVah2+model_out_dat$AVal2+
  model_out_dat$IVah2+model_out_dat$IVal2+model_out_dat$RVah2+model_out_dat$RVal2+
  
  model_out_dat$DVah+model_out_dat$DVal+model_out_dat$DVah2+model_out_dat$DVal2+
  model_out_dat$DBah+model_out_dat$DBal+model_out_dat$DBah2+model_out_dat$DBal2

## Boosted elderly
model_out_dat$Nboosted.old<-model_out_dat$SBeh+model_out_dat$SBel+
  model_out_dat$EBeh+model_out_dat$EBel+
  model_out_dat$ABeh+model_out_dat$ABel+
  model_out_dat$IBeh+model_out_dat$IBel+
  model_out_dat$RBeh+model_out_dat$RBel+
  model_out_dat$SBeh2+model_out_dat$SBel2+
  model_out_dat$EBeh2+model_out_dat$EBel2+
  model_out_dat$ABeh2+model_out_dat$ABel2+
  model_out_dat$IBeh2+model_out_dat$IBel2+
  model_out_dat$RBeh2+model_out_dat$RBel2+
  model_out_dat$DBeh+model_out_dat$DBel+
  model_out_dat$DBeh2+model_out_dat$DBel2

## Vaccinated elderly
model_out_dat$Nvax.old<-model_out_dat$SBeh+model_out_dat$SBel+
  model_out_dat$EBeh+model_out_dat$EBel+
  model_out_dat$ABeh+model_out_dat$ABel+
  model_out_dat$IBeh+model_out_dat$IBel+
  model_out_dat$RBeh+model_out_dat$RBel+
  model_out_dat$SBeh2+model_out_dat$SBel2+
  model_out_dat$EBeh2+model_out_dat$EBel2+
  model_out_dat$ABeh2+model_out_dat$ABel2+
  model_out_dat$IBeh2+model_out_dat$IBel2+
  model_out_dat$RBeh2+model_out_dat$RBel2+
  model_out_dat$DBeh+model_out_dat$DBel+
  model_out_dat$DBeh2+model_out_dat$DBel2+
  
  model_out_dat$SVeh+model_out_dat$SVel+model_out_dat$EVeh+model_out_dat$EVel+
  model_out_dat$AVeh+model_out_dat$AVel+model_out_dat$IVeh+model_out_dat$IVel+
  model_out_dat$RVeh+model_out_dat$RVel+model_out_dat$SVeh+model_out_dat$SVel+
  model_out_dat$EVeh2+model_out_dat$EVel2+model_out_dat$AVeh2+model_out_dat$AVel2+
  model_out_dat$IVeh2+model_out_dat$IVel2+model_out_dat$RVeh2+model_out_dat$RVel2+
  model_out_dat$DVeh+model_out_dat$DVel+model_out_dat$DVeh2+model_out_dat$DVel2


## Boosted child
model_out_dat$Nboosted.child<-model_out_dat$SBch+model_out_dat$SBcl+
  model_out_dat$EBch+model_out_dat$EBcl+
  model_out_dat$ABch+model_out_dat$ABcl+
  model_out_dat$IBch+model_out_dat$IBcl+
  model_out_dat$RBch+model_out_dat$RBcl+
  model_out_dat$SBch2+model_out_dat$SBcl2+
  model_out_dat$EBch2+model_out_dat$EBcl2+
  model_out_dat$ABch2+model_out_dat$ABcl2+
  model_out_dat$IBch2+model_out_dat$IBcl2+
  model_out_dat$RBch2+model_out_dat$RBcl2+
  model_out_dat$DBch+model_out_dat$DBcl+
  model_out_dat$DBch2+model_out_dat$DBcl2


## Vaccinated child
model_out_dat$Nvax.child<-model_out_dat$SBch+model_out_dat$SBcl+model_out_dat$EBch+model_out_dat$EBcl+
    model_out_dat$ABch+model_out_dat$ABcl+model_out_dat$IBch+model_out_dat$IBcl+
    model_out_dat$RBch+model_out_dat$RBcl+
    model_out_dat$SBch2+model_out_dat$SBcl2+
    model_out_dat$EBch2+model_out_dat$EBcl2+
    model_out_dat$ABch2+model_out_dat$ABcl2+
    model_out_dat$IBch2+model_out_dat$IBcl2+
    model_out_dat$RBch2+model_out_dat$RBcl2+
  
  model_out_dat$SVch+model_out_dat$SVcl+model_out_dat$EVch+model_out_dat$EVcl+
  model_out_dat$AVch+model_out_dat$AVcl+model_out_dat$IVch+model_out_dat$IVcl+
  model_out_dat$RVch+model_out_dat$RVcl+model_out_dat$SVch+model_out_dat$SVcl+
  model_out_dat$EVch2+model_out_dat$EVcl2+model_out_dat$AVch2+model_out_dat$AVcl2+
  model_out_dat$IVch2+model_out_dat$IVcl2+model_out_dat$RVch2+model_out_dat$RVcl2+
  
  model_out_dat$DVch+model_out_dat$DVcl+model_out_dat$DVch2+model_out_dat$DVcl2+
  model_out_dat$DBch+model_out_dat$DBcl+model_out_dat$DBch2+model_out_dat$DBcl2


model_out_dat$pboost.coverage_of_vaccinated<-(model_out_dat$Nboosted.adult+model_out_dat$Nboosted.old + model_out_dat$Nboosted.child)/(model_out_dat$Nvax.adult+model_out_dat$Nvax.old+model_out_dat$Nvax.child)


model_out_dat <- model_out_dat %>% 
  pivot_longer(-c(time, boost.speed, sweepnum, boost.child, cvax, relativeFOI,
                  boost.adult, max.boost_h, max.boost_l, max.boost.child, wanevar,
                  child.max,cp,base.imm,sd0,relax,boost.start,dWVH,k_h,k_l,
                  vei2,veh2,popsize, boost.start.time, Booster
  )) %>% 
  filter(name %in% c("Iall", "Iprop", "pboost.coverage_of_vaccinated"))


write_csv(model_out_dat, "../Data/ODE Supplement/Ecuador_ts_altbetaR0.csv")
```

##### India time series
```{r}

#### India time series ####

load('../Data/ODE outputs SA - ABM beta/sweep_010324_indiaboost_Evax.RData')
model_out_dat$sweepnum<-rep(seq(from=1, to=27), each=196)
model_out_dat$Iall<-model_out_dat$Ich+model_out_dat$Ich2+model_out_dat$IVch+model_out_dat$IVch2+model_out_dat$IBch+model_out_dat$IBch2+
  model_out_dat$Iah+model_out_dat$Iah2+model_out_dat$IVah+model_out_dat$IVah2+model_out_dat$IBah+model_out_dat$IBah2+
  model_out_dat$Ieh+model_out_dat$Ieh2+model_out_dat$IVeh+model_out_dat$IVeh2+model_out_dat$IBeh+model_out_dat$IBeh2+
  model_out_dat$Icl+model_out_dat$Icl2+model_out_dat$IVcl+model_out_dat$IVcl2+model_out_dat$IBcl+model_out_dat$IBcl2+
  model_out_dat$Ial+model_out_dat$Ial2+model_out_dat$IVal+model_out_dat$IVal2+model_out_dat$IBal+model_out_dat$IBal2+
  model_out_dat$Iel+model_out_dat$Iel2+model_out_dat$IVel+model_out_dat$IVel2+model_out_dat$IBel+model_out_dat$IBel2+
  #
  model_out_dat$Ach+model_out_dat$Ach2+model_out_dat$AVch+model_out_dat$AVch2+model_out_dat$ABch+model_out_dat$ABch2+
  model_out_dat$Aah+model_out_dat$Aah2+model_out_dat$AVah+model_out_dat$AVah2+model_out_dat$ABah+model_out_dat$ABah2+
  model_out_dat$Aeh+model_out_dat$Aeh2+model_out_dat$AVeh+model_out_dat$AVeh2+model_out_dat$ABeh+model_out_dat$ABeh2+
  model_out_dat$Acl+model_out_dat$Acl2+model_out_dat$AVcl+model_out_dat$AVcl2+model_out_dat$ABcl+model_out_dat$ABcl2+
  model_out_dat$Aal+model_out_dat$Aal2+model_out_dat$AVal+model_out_dat$AVal2+model_out_dat$ABal+model_out_dat$ABal2+
  model_out_dat$Ael+model_out_dat$Ael2+model_out_dat$AVel+model_out_dat$AVel2+model_out_dat$ABel+model_out_dat$ABel2
model_out_dat$popsize<-1155561222
model_out_dat$Iprop<-model_out_dat$Iall/model_out_dat$popsize*100
model_out_dat$relativeFOI<-paste(model_out_dat$relax*100, '% increase in FOI', sep='')
model_out_dat$boost.start.time<-paste('Start boosting ', model_out_dat$boost.start, ' days prior to omicron*')
model_out_dat$Booster<-NA
model_out_dat$Booster[which(model_out_dat$boost.adult==0)]<-'None'
model_out_dat$Booster[which(model_out_dat$boost.adult==1 & model_out_dat$veh2==0.657)]<-'Monovalent'
model_out_dat$Booster[which(model_out_dat$boost.adult==1 & model_out_dat$veh2==0.925)]<-'Bivalent'


## Boosted adults
model_out_dat$Nboosted.adult<-model_out_dat$SBah+model_out_dat$SBal+
  model_out_dat$EBah+model_out_dat$EBal+
  model_out_dat$ABah+model_out_dat$ABal+
  model_out_dat$IBah+model_out_dat$IBal+
  model_out_dat$RBah+model_out_dat$RBal+
  model_out_dat$SBah2+model_out_dat$SBal2+
  model_out_dat$EBah2+model_out_dat$EBal2+
  model_out_dat$ABah2+model_out_dat$ABal2+
  model_out_dat$IBah2+model_out_dat$IBal2+
  model_out_dat$RBah2+model_out_dat$RBal2+
  model_out_dat$DBah+model_out_dat$DBal+
  model_out_dat$DBah2+model_out_dat$DBal2

### Vaccinated adults
model_out_dat$Nvax.adult<-model_out_dat$SBah+model_out_dat$SBal+model_out_dat$EBah+model_out_dat$EBal+
    model_out_dat$ABah+model_out_dat$ABal+model_out_dat$IBah+model_out_dat$IBal+
    model_out_dat$RBah+model_out_dat$RBal+
    model_out_dat$SBah2+model_out_dat$SBal2+
    model_out_dat$EBah2+model_out_dat$EBal2+
    model_out_dat$ABah2+model_out_dat$ABal2+
    model_out_dat$IBah2+model_out_dat$IBal2+
    model_out_dat$RBah2+model_out_dat$RBal2+
  
  model_out_dat$SVah+model_out_dat$SVal+model_out_dat$EVah+model_out_dat$EVal+
  model_out_dat$AVah+model_out_dat$AVal+model_out_dat$IVah+model_out_dat$IVal+
  model_out_dat$RVah+model_out_dat$RVal+model_out_dat$SVah+model_out_dat$SVal+
  model_out_dat$EVah2+model_out_dat$EVal2+model_out_dat$AVah2+model_out_dat$AVal2+
  model_out_dat$IVah2+model_out_dat$IVal2+model_out_dat$RVah2+model_out_dat$RVal2+
  
  model_out_dat$DVah+model_out_dat$DVal+model_out_dat$DVah2+model_out_dat$DVal2+
  model_out_dat$DBah+model_out_dat$DBal+model_out_dat$DBah2+model_out_dat$DBal2

## Boosted elderly
model_out_dat$Nboosted.old<-model_out_dat$SBeh+model_out_dat$SBel+
  model_out_dat$EBeh+model_out_dat$EBel+
  model_out_dat$ABeh+model_out_dat$ABel+
  model_out_dat$IBeh+model_out_dat$IBel+
  model_out_dat$RBeh+model_out_dat$RBel+
  model_out_dat$SBeh2+model_out_dat$SBel2+
  model_out_dat$EBeh2+model_out_dat$EBel2+
  model_out_dat$ABeh2+model_out_dat$ABel2+
  model_out_dat$IBeh2+model_out_dat$IBel2+
  model_out_dat$RBeh2+model_out_dat$RBel2+
  model_out_dat$DBeh+model_out_dat$DBel+
  model_out_dat$DBeh2+model_out_dat$DBel2

## Vaccinated elderly
model_out_dat$Nvax.old<-model_out_dat$SBeh+model_out_dat$SBel+
  model_out_dat$EBeh+model_out_dat$EBel+
  model_out_dat$ABeh+model_out_dat$ABel+
  model_out_dat$IBeh+model_out_dat$IBel+
  model_out_dat$RBeh+model_out_dat$RBel+
  model_out_dat$SBeh2+model_out_dat$SBel2+
  model_out_dat$EBeh2+model_out_dat$EBel2+
  model_out_dat$ABeh2+model_out_dat$ABel2+
  model_out_dat$IBeh2+model_out_dat$IBel2+
  model_out_dat$RBeh2+model_out_dat$RBel2+
  model_out_dat$DBeh+model_out_dat$DBel+
  model_out_dat$DBeh2+model_out_dat$DBel2+
  
  model_out_dat$SVeh+model_out_dat$SVel+model_out_dat$EVeh+model_out_dat$EVel+
  model_out_dat$AVeh+model_out_dat$AVel+model_out_dat$IVeh+model_out_dat$IVel+
  model_out_dat$RVeh+model_out_dat$RVel+model_out_dat$SVeh+model_out_dat$SVel+
  model_out_dat$EVeh2+model_out_dat$EVel2+model_out_dat$AVeh2+model_out_dat$AVel2+
  model_out_dat$IVeh2+model_out_dat$IVel2+model_out_dat$RVeh2+model_out_dat$RVel2+
  model_out_dat$DVeh+model_out_dat$DVel+model_out_dat$DVeh2+model_out_dat$DVel2


## Boosted child
model_out_dat$Nboosted.child<-model_out_dat$SBch+model_out_dat$SBcl+
  model_out_dat$EBch+model_out_dat$EBcl+
  model_out_dat$ABch+model_out_dat$ABcl+
  model_out_dat$IBch+model_out_dat$IBcl+
  model_out_dat$RBch+model_out_dat$RBcl+
  model_out_dat$SBch2+model_out_dat$SBcl2+
  model_out_dat$EBch2+model_out_dat$EBcl2+
  model_out_dat$ABch2+model_out_dat$ABcl2+
  model_out_dat$IBch2+model_out_dat$IBcl2+
  model_out_dat$RBch2+model_out_dat$RBcl2+
  model_out_dat$DBch+model_out_dat$DBcl+
  model_out_dat$DBch2+model_out_dat$DBcl2


## Vaccinated child
model_out_dat$Nvax.child<-model_out_dat$SBch+model_out_dat$SBcl+model_out_dat$EBch+model_out_dat$EBcl+
    model_out_dat$ABch+model_out_dat$ABcl+model_out_dat$IBch+model_out_dat$IBcl+
    model_out_dat$RBch+model_out_dat$RBcl+
    model_out_dat$SBch2+model_out_dat$SBcl2+
    model_out_dat$EBch2+model_out_dat$EBcl2+
    model_out_dat$ABch2+model_out_dat$ABcl2+
    model_out_dat$IBch2+model_out_dat$IBcl2+
    model_out_dat$RBch2+model_out_dat$RBcl2+
  
  model_out_dat$SVch+model_out_dat$SVcl+model_out_dat$EVch+model_out_dat$EVcl+
  model_out_dat$AVch+model_out_dat$AVcl+model_out_dat$IVch+model_out_dat$IVcl+
  model_out_dat$RVch+model_out_dat$RVcl+model_out_dat$SVch+model_out_dat$SVcl+
  model_out_dat$EVch2+model_out_dat$EVcl2+model_out_dat$AVch2+model_out_dat$AVcl2+
  model_out_dat$IVch2+model_out_dat$IVcl2+model_out_dat$RVch2+model_out_dat$RVcl2+
  
  model_out_dat$DVch+model_out_dat$DVcl+model_out_dat$DVch2+model_out_dat$DVcl2+
  model_out_dat$DBch+model_out_dat$DBcl+model_out_dat$DBch2+model_out_dat$DBcl2


model_out_dat$pboost.coverage_of_vaccinated<-(model_out_dat$Nboosted.adult+model_out_dat$Nboosted.old + model_out_dat$Nboosted.child)/(model_out_dat$Nvax.adult+model_out_dat$Nvax.old+model_out_dat$Nvax.child)


model_out_dat <- model_out_dat %>% 
  pivot_longer(-c(time, boost.speed, sweepnum, boost.child, cvax, relativeFOI,
                  boost.adult, max.boost_h, max.boost_l, max.boost.child, wanevar,
                  child.max,cp,base.imm,sd,relax,boost.start,dWVH,k_h,k_l,
                  vei2,veh2,popsize, boost.start.time, Booster
  )) %>% 
  filter(name %in% c("Iall", "Iprop", "pboost.coverage_of_vaccinated"))


write_csv(model_out_dat, "../Data/ODE Supplement/India_ts_altbetaR0.csv")

```




#### Change base.wane

##### Malaysia grid
```{r}
#### Malaysia grid ####

end_malaysia_sweep<-readRDS('../Data/ODE outputs base.wane/endfile_sweep010224_malaysiagrid_Evax.RDS')
end_malaysia_sweep$popsize<-28552712
end_malaysia_sweep$deaths_100k<-(end_malaysia_sweep$DeathsAll/end_malaysia_sweep$popsize)*100000
end_noboost_malaysia<-subset(end_malaysia_sweep, end_malaysia_sweep$boost.adult==0)
end_boost_malaysia<-subset(end_malaysia_sweep, end_malaysia_sweep$boost.adult>0)
sum(end_malaysia_sweep[1,c(2:217)])

end_boost <-end_boost_malaysia %>% 
  pivot_longer(-c(time, boost.speed, sweepnum, boost.child, cvax,
                  boost.adult, max.boost_h, max.boost_l, max.boost.child, wanevar,
                  child.max,cp,base.imm,sd,relax,boost.start,dWVH,k_h,k_l,
                  vei2,veh2,DeathsAll,popsize,deaths_100k
  ))
end_no_boost <- end_noboost_malaysia %>% 
  pivot_longer(-c(time, boost.speed, sweepnum, boost.child, cvax,
                  boost.adult, max.boost_h, max.boost_l, max.boost.child, wanevar,
                  child.max,cp,base.imm,sd,relax,boost.start,dWVH,k_h,k_l,
                  vei2,veh2,DeathsAll,popsize,deaths_100k
  ))

dfCompODE <- end_noboost_malaysia %>% 
  select(deaths_100k, DeathsAll, cp, relax, 
         base.imm) %>% distinct() %>% 
  rename(deaths_100k_comp = deaths_100k,
         DeathsAll_comp = DeathsAll)

df_AvertedODE <- end_boost %>% 
  left_join(dfCompODE, by = c("relax", "cp", "base.imm")) %>% 
  mutate(
    da = (deaths_100k_comp - deaths_100k)/deaths_100k_comp
  ) %>% 
  distinct() %>% 
  filter(
    veh2==0.657 | (veh2 == max(veh2) & vei2 == max(vei2))
  ) %>% 
  mutate(
    Booster = if_else(
      veh2 == 0.657, "Monovalent",
      "Bivalent"
    )
  )%>%
  mutate(name = NULL, value = NULL) %>%
  distinct()

write_csv(df_AvertedODE, "../Data/ODE Supplement/Malaysia_grid_da base.wane.csv")
```


##### Ecuador grid
```{r}
#### Ecuador grid ####

end_ecuador_sweep<-readRDS('../Data/ODE outputs base.wane/endfile_sweep010424_ecuadorgrid.RDS')
end_ecuador_sweep$popsize<-15735139
end_ecuador_sweep$deaths_100k<-(end_ecuador_sweep$DeathsAll/end_ecuador_sweep$popsize)*100000
end_noboost_ecuador<-subset(end_ecuador_sweep, end_ecuador_sweep$boost.adult==0)
end_boost_ecuador<-subset(end_ecuador_sweep, end_ecuador_sweep$boost.adult>0)
sum(end_ecuador_sweep[1,c(2:217)])

end_boost <-end_boost_ecuador %>% 
  pivot_longer(-c(time, boost.speed, sweepnum, boost.child, cvax,
                  boost.adult, max.boost_h, max.boost_l, max.boost.child, wanevar,
                  child.max,cp,base.imm,sd,relax,boost.start,dWVH,k_h,k_l,
                  vei2,veh2,DeathsAll,popsize,deaths_100k
  ))
end_no_boost <- end_noboost_ecuador %>% 
  pivot_longer(-c(time, boost.speed, sweepnum, boost.child, cvax,
                  boost.adult, max.boost_h, max.boost_l, max.boost.child, wanevar,
                  child.max,cp,base.imm,sd,relax,boost.start,dWVH,k_h,k_l,
                  vei2,veh2,DeathsAll,popsize,deaths_100k
  ))

dfCompODE <- end_noboost_ecuador %>% 
  select(deaths_100k, DeathsAll, cp, relax, 
         base.imm) %>% distinct() %>% 
  rename(deaths_100k_comp = deaths_100k,
         DeathsAll_comp = DeathsAll)

df_AvertedODE <- end_boost %>% 
  left_join(dfCompODE, by = c("relax", "cp", "base.imm")) %>% 
  mutate(
    da = (deaths_100k_comp - deaths_100k)/deaths_100k_comp
  ) %>% 
  distinct() %>% 
  filter(
    veh2==0.657 | (veh2 == max(veh2) & vei2 == max(vei2))
  ) %>% 
  mutate(
    Booster = if_else(
      veh2 == 0.657, "Monovalent",
      "Bivalent"
    )
  )%>%
  mutate(name = NULL, value = NULL) %>%
  distinct()

write_csv(df_AvertedODE, "../Data/ODE Supplement/Ecuador_grid_da base.wane.csv")
```

##### India grid
```{r}
#### India grid ####

end_india_sweep<-readRDS('../Data/ODE outputs base.wane/endfile_sweep010324_indiagrid_Evax.RDS')
end_india_sweep$popsize<-1155561222
end_india_sweep$deaths_100k<-(end_india_sweep$DeathsAll/end_india_sweep$popsize)*100000
end_noboost_india<-subset(end_india_sweep, end_india_sweep$boost.adult==0)
end_boost_india<-subset(end_india_sweep, end_india_sweep$boost.adult>0)
sum(end_india_sweep[1,c(2:217)])

end_boost <-end_boost_india %>% 
  pivot_longer(-c(time, boost.speed, sweepnum, boost.child, cvax,
                  boost.adult, max.boost_h, max.boost_l, max.boost.child, wanevar,
                  child.max,cp,base.imm,sd,relax,boost.start,dWVH,k_h,k_l,
                  vei2,veh2,DeathsAll,popsize,deaths_100k
  ))
end_no_boost <- end_noboost_india %>% 
  pivot_longer(-c(time, boost.speed, sweepnum, boost.child, cvax,
                  boost.adult, max.boost_h, max.boost_l, max.boost.child, wanevar,
                  child.max,cp,base.imm,sd,relax,boost.start,dWVH,k_h,k_l,
                  vei2,veh2,DeathsAll,popsize,deaths_100k
  ))

dfCompODE <- end_noboost_india %>% 
  select(deaths_100k, DeathsAll, cp, relax, 
         base.imm) %>% distinct() %>% 
  rename(deaths_100k_comp = deaths_100k,
         DeathsAll_comp = DeathsAll)

df_AvertedODE <- end_boost %>% 
  left_join(dfCompODE, by = c("relax", "cp", "base.imm")) %>% 
  mutate(
    da = (deaths_100k_comp - deaths_100k)/deaths_100k_comp
  ) %>% 
  distinct() %>% 
  filter(
    veh2==0.657 | (veh2 == max(veh2) & vei2 == max(vei2))
  ) %>% 
  mutate(
    Booster = if_else(
      veh2 == 0.657, "Monovalent",
      "Bivalent"
    )
  )%>%
  mutate(name = NULL, value = NULL) %>%
  distinct()

write_csv(df_AvertedODE, "../Data/ODE Supplement/India_grid_da base.wane.csv")
```


##### Malaysia deaths averted
```{r}
#### Malaysia runs ####

end_malaysia_sweep<-readRDS('../Data/ODE outputs base.wane/endfile_sweep010224_malaysiaboost_Evax.RDS')
end_malaysia_sweep$popsize<-28552712
end_malaysia_sweep$deaths_100k<-(end_malaysia_sweep$DeathsAll/end_malaysia_sweep$popsize)*100000
end_noboost_malaysia<-subset(end_malaysia_sweep, end_malaysia_sweep$boost.adult==0)
end_boost_malaysia<-subset(end_malaysia_sweep, end_malaysia_sweep$boost.adult>0)
sum(end_malaysia_sweep[1,c(2:217)])

end_boost <-end_boost_malaysia %>% 
  pivot_longer(-c(time, boost.speed, sweepnum, boost.child, cvax,
                  boost.adult, max.boost_h, max.boost_l, max.boost.child, wanevar,
                  child.max,cp,base.imm,sd,relax,boost.start,dWVH,k_h,k_l,
                  vei2,veh2,DeathsAll,popsize,deaths_100k
  ))
end_no_boost <- end_noboost_malaysia %>% 
  pivot_longer(-c(time, boost.speed, sweepnum, boost.child, cvax,
                  boost.adult, max.boost_h, max.boost_l, max.boost.child, wanevar,
                  child.max,cp,base.imm,sd,relax,boost.start,dWVH,k_h,k_l,
                  vei2,veh2,DeathsAll,popsize,deaths_100k
  ))

dfCompODE <- end_noboost_malaysia %>% 
  select(deaths_100k, DeathsAll, cp, relax, 
         base.imm) %>% distinct() %>% 
  rename(deaths_100k_comp = deaths_100k,
         DeathsAll_comp = DeathsAll)

df_AvertedODE <- end_boost %>% 
  left_join(dfCompODE, by = c("relax", "cp", "base.imm")) %>% 
  mutate(
    da = (deaths_100k_comp - deaths_100k)/deaths_100k_comp
  ) %>% 
  distinct() %>% 
  filter(
    veh2==0.657 | (veh2 == max(veh2) & vei2 == max(vei2))
  ) %>% 
  mutate(
    Booster = if_else(
      veh2 == 0.657, "Monovalent",
      "Bivalent"
    )
  ) %>%
  mutate(name = NULL, value = NULL) %>%
  distinct()

write_csv(df_AvertedODE, "../Data/ODE Supplement/Malaysia_run_da base.wane.csv")
```

##### Ecuador deaths averted
```{r}

#### Ecuador runs ####

end_ecuador_sweep<-readRDS('../Data/ODE outputs base.wane/endfile_sweep010424_ecuadorboost_Evax.RDS') %>% 
  rename(sd = sd0)
end_ecuador_sweep$popsize<-15735139
end_ecuador_sweep$deaths_100k<-(end_ecuador_sweep$DeathsAll/end_ecuador_sweep$popsize)*100000
end_noboost_ecuador<-subset(end_ecuador_sweep, end_ecuador_sweep$boost.adult==0)
end_boost_ecuador<-subset(end_ecuador_sweep, end_ecuador_sweep$boost.adult>0)
sum(end_ecuador_sweep[1,c(2:217)])

end_boost <-end_boost_ecuador %>% 
  pivot_longer(-c(time, boost.speed, sweepnum, boost.child, cvax,
                  boost.adult, max.boost_h, max.boost_l, max.boost.child, wanevar,
                  child.max,cp,base.imm,sd,relax,boost.start,dWVH,k_h,k_l,
                  vei2,veh2,DeathsAll,popsize,deaths_100k
  ))
end_no_boost <- end_noboost_ecuador %>% 
  pivot_longer(-c(time, boost.speed, sweepnum, boost.child, cvax,
                  boost.adult, max.boost_h, max.boost_l, max.boost.child, wanevar,
                  child.max,cp,base.imm,sd,relax,boost.start,dWVH,k_h,k_l,
                  vei2,veh2,DeathsAll,popsize,deaths_100k
  ))

dfCompODE <- end_noboost_ecuador %>% 
  select(deaths_100k, DeathsAll, cp, relax, 
         base.imm) %>% distinct() %>% 
  rename(deaths_100k_comp = deaths_100k,
         DeathsAll_comp = DeathsAll)

df_AvertedODE <- end_boost %>% 
  left_join(dfCompODE, by = c("relax", "cp", "base.imm")) %>% 
  mutate(
    da = (deaths_100k_comp - deaths_100k)/deaths_100k_comp
  ) %>% 
  distinct() %>% 
  filter(
    veh2==0.657 | (veh2 == max(veh2) & vei2 == max(vei2))
  ) %>% 
  mutate(
    Booster = if_else(
      veh2 == 0.657, "Monovalent",
      "Bivalent"
    )
  ) %>%
  mutate(name = NULL, value = NULL) %>%
  distinct()

write_csv(df_AvertedODE, "../Data/ODE Supplement/Ecuador_run_da base.wane.csv")
```

##### India deaths averted
```{r}
#### India runs ####

end_india_sweep<-readRDS('../Data/ODE outputs base.wane/endfile_sweep010324_indiaboost_Evax.RDS')
end_india_sweep$popsize<-1155561222
end_india_sweep$deaths_100k<-(end_india_sweep$DeathsAll/end_india_sweep$popsize)*100000
end_noboost_india<-subset(end_india_sweep, end_india_sweep$boost.adult==0)
end_boost_india<-subset(end_india_sweep, end_india_sweep$boost.adult>0)
sum(end_india_sweep[1,c(2:217)])

end_boost <-end_boost_india %>% 
  pivot_longer(-c(time, boost.speed, sweepnum, boost.child, cvax,
                  boost.adult, max.boost_h, max.boost_l, max.boost.child, wanevar,
                  child.max,cp,base.imm,sd,relax,boost.start,dWVH,k_h,k_l,
                  vei2,veh2,DeathsAll,popsize,deaths_100k
  ))
end_no_boost <- end_noboost_india %>% 
  pivot_longer(-c(time, boost.speed, sweepnum, boost.child, cvax,
                  boost.adult, max.boost_h, max.boost_l, max.boost.child, wanevar,
                  child.max,cp,base.imm,sd,relax,boost.start,dWVH,k_h,k_l,
                  vei2,veh2,DeathsAll,popsize,deaths_100k
  ))

dfCompODE <- end_noboost_india %>% 
  select(deaths_100k, DeathsAll, cp, relax, 
         base.imm) %>% distinct() %>% 
  rename(deaths_100k_comp = deaths_100k,
         DeathsAll_comp = DeathsAll)

df_AvertedODE <- end_boost %>% 
  left_join(dfCompODE, by = c("relax", "cp", "base.imm")) %>% 
  mutate(
    da = (deaths_100k_comp - deaths_100k)/deaths_100k_comp
  ) %>% 
  distinct() %>% 
  filter(
    veh2==0.657 | (veh2 == max(veh2) & vei2 == max(vei2))
  ) %>% 
  mutate(
    Booster = if_else(
      veh2 == 0.657, "Monovalent",
      "Bivalent"
    )
  ) %>%
  mutate(name = NULL, value = NULL) %>%
  distinct()

write_csv(df_AvertedODE, "../Data/ODE Supplement/India_run_da base.wane.csv")
```

##### Malaysia time series
```{r}

#### Malaysia time series ####

load('../Data/ODE outputs base.wane/sweep_010224_malaysiaboost_Evax.RData')
model_out_dat$sweepnum<-rep(seq(from=1, to=27), each=196)
model_out_dat$Iall<-model_out_dat$Ich+model_out_dat$Ich2+model_out_dat$IVch+model_out_dat$IVch2+model_out_dat$IBch+model_out_dat$IBch2+
  model_out_dat$Iah+model_out_dat$Iah2+model_out_dat$IVah+model_out_dat$IVah2+model_out_dat$IBah+model_out_dat$IBah2+
  model_out_dat$Ieh+model_out_dat$Ieh2+model_out_dat$IVeh+model_out_dat$IVeh2+model_out_dat$IBeh+model_out_dat$IBeh2+
  model_out_dat$Icl+model_out_dat$Icl2+model_out_dat$IVcl+model_out_dat$IVcl2+model_out_dat$IBcl+model_out_dat$IBcl2+
  model_out_dat$Ial+model_out_dat$Ial2+model_out_dat$IVal+model_out_dat$IVal2+model_out_dat$IBal+model_out_dat$IBal2+
  model_out_dat$Iel+model_out_dat$Iel2+model_out_dat$IVel+model_out_dat$IVel2+model_out_dat$IBel+model_out_dat$IBel2+
  #
  model_out_dat$Ach+model_out_dat$Ach2+model_out_dat$AVch+model_out_dat$AVch2+model_out_dat$ABch+model_out_dat$ABch2+
  model_out_dat$Aah+model_out_dat$Aah2+model_out_dat$AVah+model_out_dat$AVah2+model_out_dat$ABah+model_out_dat$ABah2+
  model_out_dat$Aeh+model_out_dat$Aeh2+model_out_dat$AVeh+model_out_dat$AVeh2+model_out_dat$ABeh+model_out_dat$ABeh2+
  model_out_dat$Acl+model_out_dat$Acl2+model_out_dat$AVcl+model_out_dat$AVcl2+model_out_dat$ABcl+model_out_dat$ABcl2+
  model_out_dat$Aal+model_out_dat$Aal2+model_out_dat$AVal+model_out_dat$AVal2+model_out_dat$ABal+model_out_dat$ABal2+
  model_out_dat$Ael+model_out_dat$Ael2+model_out_dat$AVel+model_out_dat$AVel2+model_out_dat$ABel+model_out_dat$ABel2
model_out_dat$popsize<-28552712
model_out_dat$Iprop<-model_out_dat$Iall/model_out_dat$popsize*100
model_out_dat$relativeFOI<-paste(model_out_dat$relax*100, '% increase in FOI', sep='')
model_out_dat$boost.start.time<-paste('Start boosting ', model_out_dat$boost.start, ' days prior to omicron*')
model_out_dat$Booster<-NA
model_out_dat$Booster[which(model_out_dat$boost.adult==0)]<-'None'
model_out_dat$Booster[which(model_out_dat$boost.adult==1 & model_out_dat$veh2==0.657)]<-'Monovalent'
model_out_dat$Booster[which(model_out_dat$boost.adult==1 & model_out_dat$veh2==0.925)]<-'Bivalent'


## Boosted adults
model_out_dat$Nboosted.adult<-model_out_dat$SBah+model_out_dat$SBal+
  model_out_dat$EBah+model_out_dat$EBal+
  model_out_dat$ABah+model_out_dat$ABal+
  model_out_dat$IBah+model_out_dat$IBal+
  model_out_dat$RBah+model_out_dat$RBal+
  model_out_dat$SBah2+model_out_dat$SBal2+
  model_out_dat$EBah2+model_out_dat$EBal2+
  model_out_dat$ABah2+model_out_dat$ABal2+
  model_out_dat$IBah2+model_out_dat$IBal2+
  model_out_dat$RBah2+model_out_dat$RBal2+
  model_out_dat$DBah+model_out_dat$DBal+
  model_out_dat$DBah2+model_out_dat$DBal2

### Vaccinated adults
model_out_dat$Nvax.adult<-model_out_dat$SBah+model_out_dat$SBal+model_out_dat$EBah+model_out_dat$EBal+
    model_out_dat$ABah+model_out_dat$ABal+model_out_dat$IBah+model_out_dat$IBal+
    model_out_dat$RBah+model_out_dat$RBal+
    model_out_dat$SBah2+model_out_dat$SBal2+
    model_out_dat$EBah2+model_out_dat$EBal2+
    model_out_dat$ABah2+model_out_dat$ABal2+
    model_out_dat$IBah2+model_out_dat$IBal2+
    model_out_dat$RBah2+model_out_dat$RBal2+
  
  model_out_dat$SVah+model_out_dat$SVal+model_out_dat$EVah+model_out_dat$EVal+
  model_out_dat$AVah+model_out_dat$AVal+model_out_dat$IVah+model_out_dat$IVal+
  model_out_dat$RVah+model_out_dat$RVal+model_out_dat$SVah+model_out_dat$SVal+
  model_out_dat$EVah2+model_out_dat$EVal2+model_out_dat$AVah2+model_out_dat$AVal2+
  model_out_dat$IVah2+model_out_dat$IVal2+model_out_dat$RVah2+model_out_dat$RVal2+
  
  model_out_dat$DVah+model_out_dat$DVal+model_out_dat$DVah2+model_out_dat$DVal2+
  model_out_dat$DBah+model_out_dat$DBal+model_out_dat$DBah2+model_out_dat$DBal2

## Boosted elderly
model_out_dat$Nboosted.old<-model_out_dat$SBeh+model_out_dat$SBel+
  model_out_dat$EBeh+model_out_dat$EBel+
  model_out_dat$ABeh+model_out_dat$ABel+
  model_out_dat$IBeh+model_out_dat$IBel+
  model_out_dat$RBeh+model_out_dat$RBel+
  model_out_dat$SBeh2+model_out_dat$SBel2+
  model_out_dat$EBeh2+model_out_dat$EBel2+
  model_out_dat$ABeh2+model_out_dat$ABel2+
  model_out_dat$IBeh2+model_out_dat$IBel2+
  model_out_dat$RBeh2+model_out_dat$RBel2+
  model_out_dat$DBeh+model_out_dat$DBel+
  model_out_dat$DBeh2+model_out_dat$DBel2

## Vaccinated elderly
model_out_dat$Nvax.old<-model_out_dat$SBeh+model_out_dat$SBel+
  model_out_dat$EBeh+model_out_dat$EBel+
  model_out_dat$ABeh+model_out_dat$ABel+
  model_out_dat$IBeh+model_out_dat$IBel+
  model_out_dat$RBeh+model_out_dat$RBel+
  model_out_dat$SBeh2+model_out_dat$SBel2+
  model_out_dat$EBeh2+model_out_dat$EBel2+
  model_out_dat$ABeh2+model_out_dat$ABel2+
  model_out_dat$IBeh2+model_out_dat$IBel2+
  model_out_dat$RBeh2+model_out_dat$RBel2+
  model_out_dat$DBeh+model_out_dat$DBel+
  model_out_dat$DBeh2+model_out_dat$DBel2+
  
  model_out_dat$SVeh+model_out_dat$SVel+model_out_dat$EVeh+model_out_dat$EVel+
  model_out_dat$AVeh+model_out_dat$AVel+model_out_dat$IVeh+model_out_dat$IVel+
  model_out_dat$RVeh+model_out_dat$RVel+model_out_dat$SVeh+model_out_dat$SVel+
  model_out_dat$EVeh2+model_out_dat$EVel2+model_out_dat$AVeh2+model_out_dat$AVel2+
  model_out_dat$IVeh2+model_out_dat$IVel2+model_out_dat$RVeh2+model_out_dat$RVel2+
  model_out_dat$DVeh+model_out_dat$DVel+model_out_dat$DVeh2+model_out_dat$DVel2


## Boosted child
model_out_dat$Nboosted.child<-model_out_dat$SBch+model_out_dat$SBcl+
  model_out_dat$EBch+model_out_dat$EBcl+
  model_out_dat$ABch+model_out_dat$ABcl+
  model_out_dat$IBch+model_out_dat$IBcl+
  model_out_dat$RBch+model_out_dat$RBcl+
  model_out_dat$SBch2+model_out_dat$SBcl2+
  model_out_dat$EBch2+model_out_dat$EBcl2+
  model_out_dat$ABch2+model_out_dat$ABcl2+
  model_out_dat$IBch2+model_out_dat$IBcl2+
  model_out_dat$RBch2+model_out_dat$RBcl2+
  model_out_dat$DBch+model_out_dat$DBcl+
  model_out_dat$DBch2+model_out_dat$DBcl2


## Vaccinated child
model_out_dat$Nvax.child<-model_out_dat$SBch+model_out_dat$SBcl+model_out_dat$EBch+model_out_dat$EBcl+
    model_out_dat$ABch+model_out_dat$ABcl+model_out_dat$IBch+model_out_dat$IBcl+
    model_out_dat$RBch+model_out_dat$RBcl+
    model_out_dat$SBch2+model_out_dat$SBcl2+
    model_out_dat$EBch2+model_out_dat$EBcl2+
    model_out_dat$ABch2+model_out_dat$ABcl2+
    model_out_dat$IBch2+model_out_dat$IBcl2+
    model_out_dat$RBch2+model_out_dat$RBcl2+
  
  model_out_dat$SVch+model_out_dat$SVcl+model_out_dat$EVch+model_out_dat$EVcl+
  model_out_dat$AVch+model_out_dat$AVcl+model_out_dat$IVch+model_out_dat$IVcl+
  model_out_dat$RVch+model_out_dat$RVcl+model_out_dat$SVch+model_out_dat$SVcl+
  model_out_dat$EVch2+model_out_dat$EVcl2+model_out_dat$AVch2+model_out_dat$AVcl2+
  model_out_dat$IVch2+model_out_dat$IVcl2+model_out_dat$RVch2+model_out_dat$RVcl2+
  
  model_out_dat$DVch+model_out_dat$DVcl+model_out_dat$DVch2+model_out_dat$DVcl2+
  model_out_dat$DBch+model_out_dat$DBcl+model_out_dat$DBch2+model_out_dat$DBcl2


model_out_dat$pboost.coverage_of_vaccinated<-(model_out_dat$Nboosted.adult+model_out_dat$Nboosted.old + model_out_dat$Nboosted.child)/(model_out_dat$Nvax.adult+model_out_dat$Nvax.old+model_out_dat$Nvax.child)


model_out_dat <- model_out_dat %>% 
  pivot_longer(-c(time, boost.speed, sweepnum, boost.child, cvax, relativeFOI,
                  boost.adult, max.boost_h, max.boost_l, max.boost.child, wanevar,
                  child.max,cp,base.imm,sd,relax,boost.start,dWVH,k_h,k_l,
                  vei2,veh2,popsize, boost.start.time, Booster
  )) %>% 
  filter(name %in% c("Iall", "Iprop", "pboost.coverage_of_vaccinated"))

write_csv(model_out_dat, "../Data/ODE Supplement/Malaysia_ts base.wane.csv")
```

##### Ecuador time series
```{r}

#### Ecuador time series ####

load('../Data/ODE outputs base.wane/sweep_010424_ecuadorboost_Evax.RData')
model_out_dat$sweepnum<-rep(seq(from=1, to=27), each=196)
model_out_dat$Iall<-model_out_dat$Ich+model_out_dat$Ich2+model_out_dat$IVch+model_out_dat$IVch2+model_out_dat$IBch+model_out_dat$IBch2+
  model_out_dat$Iah+model_out_dat$Iah2+model_out_dat$IVah+model_out_dat$IVah2+model_out_dat$IBah+model_out_dat$IBah2+
  model_out_dat$Ieh+model_out_dat$Ieh2+model_out_dat$IVeh+model_out_dat$IVeh2+model_out_dat$IBeh+model_out_dat$IBeh2+
  model_out_dat$Icl+model_out_dat$Icl2+model_out_dat$IVcl+model_out_dat$IVcl2+model_out_dat$IBcl+model_out_dat$IBcl2+
  model_out_dat$Ial+model_out_dat$Ial2+model_out_dat$IVal+model_out_dat$IVal2+model_out_dat$IBal+model_out_dat$IBal2+
  model_out_dat$Iel+model_out_dat$Iel2+model_out_dat$IVel+model_out_dat$IVel2+model_out_dat$IBel+model_out_dat$IBel2+
  #
  model_out_dat$Ach+model_out_dat$Ach2+model_out_dat$AVch+model_out_dat$AVch2+model_out_dat$ABch+model_out_dat$ABch2+
  model_out_dat$Aah+model_out_dat$Aah2+model_out_dat$AVah+model_out_dat$AVah2+model_out_dat$ABah+model_out_dat$ABah2+
  model_out_dat$Aeh+model_out_dat$Aeh2+model_out_dat$AVeh+model_out_dat$AVeh2+model_out_dat$ABeh+model_out_dat$ABeh2+
  model_out_dat$Acl+model_out_dat$Acl2+model_out_dat$AVcl+model_out_dat$AVcl2+model_out_dat$ABcl+model_out_dat$ABcl2+
  model_out_dat$Aal+model_out_dat$Aal2+model_out_dat$AVal+model_out_dat$AVal2+model_out_dat$ABal+model_out_dat$ABal2+
  model_out_dat$Ael+model_out_dat$Ael2+model_out_dat$AVel+model_out_dat$AVel2+model_out_dat$ABel+model_out_dat$ABel2
model_out_dat$popsize<-15735139
model_out_dat$Iprop<-model_out_dat$Iall/model_out_dat$popsize*100
model_out_dat$relativeFOI<-paste(model_out_dat$relax*100, '% increase in FOI', sep='')
model_out_dat$boost.start.time<-paste('Start boosting ', model_out_dat$boost.start, ' days prior to omicron*')
model_out_dat$Booster<-NA
model_out_dat$Booster[which(model_out_dat$boost.adult==0)]<-'None'
model_out_dat$Booster[which(model_out_dat$boost.adult==1 & model_out_dat$veh2==0.657)]<-'Monovalent'
model_out_dat$Booster[which(model_out_dat$boost.adult==1 & model_out_dat$veh2==0.925)]<-'Bivalent'

## Boosted adults
model_out_dat$Nboosted.adult<-model_out_dat$SBah+model_out_dat$SBal+
  model_out_dat$EBah+model_out_dat$EBal+
  model_out_dat$ABah+model_out_dat$ABal+
  model_out_dat$IBah+model_out_dat$IBal+
  model_out_dat$RBah+model_out_dat$RBal+
  model_out_dat$SBah2+model_out_dat$SBal2+
  model_out_dat$EBah2+model_out_dat$EBal2+
  model_out_dat$ABah2+model_out_dat$ABal2+
  model_out_dat$IBah2+model_out_dat$IBal2+
  model_out_dat$RBah2+model_out_dat$RBal2+
  model_out_dat$DBah+model_out_dat$DBal+
  model_out_dat$DBah2+model_out_dat$DBal2

### Vaccinated adults
model_out_dat$Nvax.adult<-model_out_dat$SBah+model_out_dat$SBal+model_out_dat$EBah+model_out_dat$EBal+
    model_out_dat$ABah+model_out_dat$ABal+model_out_dat$IBah+model_out_dat$IBal+
    model_out_dat$RBah+model_out_dat$RBal+
    model_out_dat$SBah2+model_out_dat$SBal2+
    model_out_dat$EBah2+model_out_dat$EBal2+
    model_out_dat$ABah2+model_out_dat$ABal2+
    model_out_dat$IBah2+model_out_dat$IBal2+
    model_out_dat$RBah2+model_out_dat$RBal2+
  
  model_out_dat$SVah+model_out_dat$SVal+model_out_dat$EVah+model_out_dat$EVal+
  model_out_dat$AVah+model_out_dat$AVal+model_out_dat$IVah+model_out_dat$IVal+
  model_out_dat$RVah+model_out_dat$RVal+model_out_dat$SVah+model_out_dat$SVal+
  model_out_dat$EVah2+model_out_dat$EVal2+model_out_dat$AVah2+model_out_dat$AVal2+
  model_out_dat$IVah2+model_out_dat$IVal2+model_out_dat$RVah2+model_out_dat$RVal2+
  
  model_out_dat$DVah+model_out_dat$DVal+model_out_dat$DVah2+model_out_dat$DVal2+
  model_out_dat$DBah+model_out_dat$DBal+model_out_dat$DBah2+model_out_dat$DBal2

## Boosted elderly
model_out_dat$Nboosted.old<-model_out_dat$SBeh+model_out_dat$SBel+
  model_out_dat$EBeh+model_out_dat$EBel+
  model_out_dat$ABeh+model_out_dat$ABel+
  model_out_dat$IBeh+model_out_dat$IBel+
  model_out_dat$RBeh+model_out_dat$RBel+
  model_out_dat$SBeh2+model_out_dat$SBel2+
  model_out_dat$EBeh2+model_out_dat$EBel2+
  model_out_dat$ABeh2+model_out_dat$ABel2+
  model_out_dat$IBeh2+model_out_dat$IBel2+
  model_out_dat$RBeh2+model_out_dat$RBel2+
  model_out_dat$DBeh+model_out_dat$DBel+
  model_out_dat$DBeh2+model_out_dat$DBel2

## Vaccinated elderly
model_out_dat$Nvax.old<-model_out_dat$SBeh+model_out_dat$SBel+
  model_out_dat$EBeh+model_out_dat$EBel+
  model_out_dat$ABeh+model_out_dat$ABel+
  model_out_dat$IBeh+model_out_dat$IBel+
  model_out_dat$RBeh+model_out_dat$RBel+
  model_out_dat$SBeh2+model_out_dat$SBel2+
  model_out_dat$EBeh2+model_out_dat$EBel2+
  model_out_dat$ABeh2+model_out_dat$ABel2+
  model_out_dat$IBeh2+model_out_dat$IBel2+
  model_out_dat$RBeh2+model_out_dat$RBel2+
  model_out_dat$DBeh+model_out_dat$DBel+
  model_out_dat$DBeh2+model_out_dat$DBel2+
  
  model_out_dat$SVeh+model_out_dat$SVel+model_out_dat$EVeh+model_out_dat$EVel+
  model_out_dat$AVeh+model_out_dat$AVel+model_out_dat$IVeh+model_out_dat$IVel+
  model_out_dat$RVeh+model_out_dat$RVel+model_out_dat$SVeh+model_out_dat$SVel+
  model_out_dat$EVeh2+model_out_dat$EVel2+model_out_dat$AVeh2+model_out_dat$AVel2+
  model_out_dat$IVeh2+model_out_dat$IVel2+model_out_dat$RVeh2+model_out_dat$RVel2+
  model_out_dat$DVeh+model_out_dat$DVel+model_out_dat$DVeh2+model_out_dat$DVel2


## Boosted child
model_out_dat$Nboosted.child<-model_out_dat$SBch+model_out_dat$SBcl+
  model_out_dat$EBch+model_out_dat$EBcl+
  model_out_dat$ABch+model_out_dat$ABcl+
  model_out_dat$IBch+model_out_dat$IBcl+
  model_out_dat$RBch+model_out_dat$RBcl+
  model_out_dat$SBch2+model_out_dat$SBcl2+
  model_out_dat$EBch2+model_out_dat$EBcl2+
  model_out_dat$ABch2+model_out_dat$ABcl2+
  model_out_dat$IBch2+model_out_dat$IBcl2+
  model_out_dat$RBch2+model_out_dat$RBcl2+
  model_out_dat$DBch+model_out_dat$DBcl+
  model_out_dat$DBch2+model_out_dat$DBcl2


## Vaccinated child
model_out_dat$Nvax.child<-model_out_dat$SBch+model_out_dat$SBcl+model_out_dat$EBch+model_out_dat$EBcl+
    model_out_dat$ABch+model_out_dat$ABcl+model_out_dat$IBch+model_out_dat$IBcl+
    model_out_dat$RBch+model_out_dat$RBcl+
    model_out_dat$SBch2+model_out_dat$SBcl2+
    model_out_dat$EBch2+model_out_dat$EBcl2+
    model_out_dat$ABch2+model_out_dat$ABcl2+
    model_out_dat$IBch2+model_out_dat$IBcl2+
    model_out_dat$RBch2+model_out_dat$RBcl2+
  
  model_out_dat$SVch+model_out_dat$SVcl+model_out_dat$EVch+model_out_dat$EVcl+
  model_out_dat$AVch+model_out_dat$AVcl+model_out_dat$IVch+model_out_dat$IVcl+
  model_out_dat$RVch+model_out_dat$RVcl+model_out_dat$SVch+model_out_dat$SVcl+
  model_out_dat$EVch2+model_out_dat$EVcl2+model_out_dat$AVch2+model_out_dat$AVcl2+
  model_out_dat$IVch2+model_out_dat$IVcl2+model_out_dat$RVch2+model_out_dat$RVcl2+
  
  model_out_dat$DVch+model_out_dat$DVcl+model_out_dat$DVch2+model_out_dat$DVcl2+
  model_out_dat$DBch+model_out_dat$DBcl+model_out_dat$DBch2+model_out_dat$DBcl2


model_out_dat$pboost.coverage_of_vaccinated<-(model_out_dat$Nboosted.adult+model_out_dat$Nboosted.old + model_out_dat$Nboosted.child)/(model_out_dat$Nvax.adult+model_out_dat$Nvax.old+model_out_dat$Nvax.child)


model_out_dat <- model_out_dat %>% 
  pivot_longer(-c(time, boost.speed, sweepnum, boost.child, cvax, relativeFOI,
                  boost.adult, max.boost_h, max.boost_l, max.boost.child, wanevar,
                  child.max,cp,base.imm,sd0,relax,boost.start,dWVH,k_h,k_l,
                  vei2,veh2,popsize, boost.start.time, Booster
  )) %>% 
  filter(name %in% c("Iall", "Iprop", "pboost.coverage_of_vaccinated"))


write_csv(model_out_dat, "../Data/ODE Supplement/Ecuador_ts base.wane.csv")
```

##### India time series
```{r}

#### India time series ####

load('../Data/ODE outputs base.wane/sweep_010324_indiaboost_Evax.RData')
model_out_dat$sweepnum<-rep(seq(from=1, to=27), each=196)
model_out_dat$Iall<-model_out_dat$Ich+model_out_dat$Ich2+model_out_dat$IVch+model_out_dat$IVch2+model_out_dat$IBch+model_out_dat$IBch2+
  model_out_dat$Iah+model_out_dat$Iah2+model_out_dat$IVah+model_out_dat$IVah2+model_out_dat$IBah+model_out_dat$IBah2+
  model_out_dat$Ieh+model_out_dat$Ieh2+model_out_dat$IVeh+model_out_dat$IVeh2+model_out_dat$IBeh+model_out_dat$IBeh2+
  model_out_dat$Icl+model_out_dat$Icl2+model_out_dat$IVcl+model_out_dat$IVcl2+model_out_dat$IBcl+model_out_dat$IBcl2+
  model_out_dat$Ial+model_out_dat$Ial2+model_out_dat$IVal+model_out_dat$IVal2+model_out_dat$IBal+model_out_dat$IBal2+
  model_out_dat$Iel+model_out_dat$Iel2+model_out_dat$IVel+model_out_dat$IVel2+model_out_dat$IBel+model_out_dat$IBel2+
  #
  model_out_dat$Ach+model_out_dat$Ach2+model_out_dat$AVch+model_out_dat$AVch2+model_out_dat$ABch+model_out_dat$ABch2+
  model_out_dat$Aah+model_out_dat$Aah2+model_out_dat$AVah+model_out_dat$AVah2+model_out_dat$ABah+model_out_dat$ABah2+
  model_out_dat$Aeh+model_out_dat$Aeh2+model_out_dat$AVeh+model_out_dat$AVeh2+model_out_dat$ABeh+model_out_dat$ABeh2+
  model_out_dat$Acl+model_out_dat$Acl2+model_out_dat$AVcl+model_out_dat$AVcl2+model_out_dat$ABcl+model_out_dat$ABcl2+
  model_out_dat$Aal+model_out_dat$Aal2+model_out_dat$AVal+model_out_dat$AVal2+model_out_dat$ABal+model_out_dat$ABal2+
  model_out_dat$Ael+model_out_dat$Ael2+model_out_dat$AVel+model_out_dat$AVel2+model_out_dat$ABel+model_out_dat$ABel2
model_out_dat$popsize<-1155561222
model_out_dat$Iprop<-model_out_dat$Iall/model_out_dat$popsize*100
model_out_dat$relativeFOI<-paste(model_out_dat$relax*100, '% increase in FOI', sep='')
model_out_dat$boost.start.time<-paste('Start boosting ', model_out_dat$boost.start, ' days prior to omicron*')
model_out_dat$Booster<-NA
model_out_dat$Booster[which(model_out_dat$boost.adult==0)]<-'None'
model_out_dat$Booster[which(model_out_dat$boost.adult==1 & model_out_dat$veh2==0.657)]<-'Monovalent'
model_out_dat$Booster[which(model_out_dat$boost.adult==1 & model_out_dat$veh2==0.925)]<-'Bivalent'


## Boosted adults
model_out_dat$Nboosted.adult<-model_out_dat$SBah+model_out_dat$SBal+
  model_out_dat$EBah+model_out_dat$EBal+
  model_out_dat$ABah+model_out_dat$ABal+
  model_out_dat$IBah+model_out_dat$IBal+
  model_out_dat$RBah+model_out_dat$RBal+
  model_out_dat$SBah2+model_out_dat$SBal2+
  model_out_dat$EBah2+model_out_dat$EBal2+
  model_out_dat$ABah2+model_out_dat$ABal2+
  model_out_dat$IBah2+model_out_dat$IBal2+
  model_out_dat$RBah2+model_out_dat$RBal2+
  model_out_dat$DBah+model_out_dat$DBal+
  model_out_dat$DBah2+model_out_dat$DBal2

### Vaccinated adults
model_out_dat$Nvax.adult<-model_out_dat$SBah+model_out_dat$SBal+model_out_dat$EBah+model_out_dat$EBal+
    model_out_dat$ABah+model_out_dat$ABal+model_out_dat$IBah+model_out_dat$IBal+
    model_out_dat$RBah+model_out_dat$RBal+
    model_out_dat$SBah2+model_out_dat$SBal2+
    model_out_dat$EBah2+model_out_dat$EBal2+
    model_out_dat$ABah2+model_out_dat$ABal2+
    model_out_dat$IBah2+model_out_dat$IBal2+
    model_out_dat$RBah2+model_out_dat$RBal2+
  
  model_out_dat$SVah+model_out_dat$SVal+model_out_dat$EVah+model_out_dat$EVal+
  model_out_dat$AVah+model_out_dat$AVal+model_out_dat$IVah+model_out_dat$IVal+
  model_out_dat$RVah+model_out_dat$RVal+model_out_dat$SVah+model_out_dat$SVal+
  model_out_dat$EVah2+model_out_dat$EVal2+model_out_dat$AVah2+model_out_dat$AVal2+
  model_out_dat$IVah2+model_out_dat$IVal2+model_out_dat$RVah2+model_out_dat$RVal2+
  
  model_out_dat$DVah+model_out_dat$DVal+model_out_dat$DVah2+model_out_dat$DVal2+
  model_out_dat$DBah+model_out_dat$DBal+model_out_dat$DBah2+model_out_dat$DBal2

## Boosted elderly
model_out_dat$Nboosted.old<-model_out_dat$SBeh+model_out_dat$SBel+
  model_out_dat$EBeh+model_out_dat$EBel+
  model_out_dat$ABeh+model_out_dat$ABel+
  model_out_dat$IBeh+model_out_dat$IBel+
  model_out_dat$RBeh+model_out_dat$RBel+
  model_out_dat$SBeh2+model_out_dat$SBel2+
  model_out_dat$EBeh2+model_out_dat$EBel2+
  model_out_dat$ABeh2+model_out_dat$ABel2+
  model_out_dat$IBeh2+model_out_dat$IBel2+
  model_out_dat$RBeh2+model_out_dat$RBel2+
  model_out_dat$DBeh+model_out_dat$DBel+
  model_out_dat$DBeh2+model_out_dat$DBel2

## Vaccinated elderly
model_out_dat$Nvax.old<-model_out_dat$SBeh+model_out_dat$SBel+
  model_out_dat$EBeh+model_out_dat$EBel+
  model_out_dat$ABeh+model_out_dat$ABel+
  model_out_dat$IBeh+model_out_dat$IBel+
  model_out_dat$RBeh+model_out_dat$RBel+
  model_out_dat$SBeh2+model_out_dat$SBel2+
  model_out_dat$EBeh2+model_out_dat$EBel2+
  model_out_dat$ABeh2+model_out_dat$ABel2+
  model_out_dat$IBeh2+model_out_dat$IBel2+
  model_out_dat$RBeh2+model_out_dat$RBel2+
  model_out_dat$DBeh+model_out_dat$DBel+
  model_out_dat$DBeh2+model_out_dat$DBel2+
  
  model_out_dat$SVeh+model_out_dat$SVel+model_out_dat$EVeh+model_out_dat$EVel+
  model_out_dat$AVeh+model_out_dat$AVel+model_out_dat$IVeh+model_out_dat$IVel+
  model_out_dat$RVeh+model_out_dat$RVel+model_out_dat$SVeh+model_out_dat$SVel+
  model_out_dat$EVeh2+model_out_dat$EVel2+model_out_dat$AVeh2+model_out_dat$AVel2+
  model_out_dat$IVeh2+model_out_dat$IVel2+model_out_dat$RVeh2+model_out_dat$RVel2+
  model_out_dat$DVeh+model_out_dat$DVel+model_out_dat$DVeh2+model_out_dat$DVel2


## Boosted child
model_out_dat$Nboosted.child<-model_out_dat$SBch+model_out_dat$SBcl+
  model_out_dat$EBch+model_out_dat$EBcl+
  model_out_dat$ABch+model_out_dat$ABcl+
  model_out_dat$IBch+model_out_dat$IBcl+
  model_out_dat$RBch+model_out_dat$RBcl+
  model_out_dat$SBch2+model_out_dat$SBcl2+
  model_out_dat$EBch2+model_out_dat$EBcl2+
  model_out_dat$ABch2+model_out_dat$ABcl2+
  model_out_dat$IBch2+model_out_dat$IBcl2+
  model_out_dat$RBch2+model_out_dat$RBcl2+
  model_out_dat$DBch+model_out_dat$DBcl+
  model_out_dat$DBch2+model_out_dat$DBcl2


## Vaccinated child
model_out_dat$Nvax.child<-model_out_dat$SBch+model_out_dat$SBcl+model_out_dat$EBch+model_out_dat$EBcl+
    model_out_dat$ABch+model_out_dat$ABcl+model_out_dat$IBch+model_out_dat$IBcl+
    model_out_dat$RBch+model_out_dat$RBcl+
    model_out_dat$SBch2+model_out_dat$SBcl2+
    model_out_dat$EBch2+model_out_dat$EBcl2+
    model_out_dat$ABch2+model_out_dat$ABcl2+
    model_out_dat$IBch2+model_out_dat$IBcl2+
    model_out_dat$RBch2+model_out_dat$RBcl2+
  
  model_out_dat$SVch+model_out_dat$SVcl+model_out_dat$EVch+model_out_dat$EVcl+
  model_out_dat$AVch+model_out_dat$AVcl+model_out_dat$IVch+model_out_dat$IVcl+
  model_out_dat$RVch+model_out_dat$RVcl+model_out_dat$SVch+model_out_dat$SVcl+
  model_out_dat$EVch2+model_out_dat$EVcl2+model_out_dat$AVch2+model_out_dat$AVcl2+
  model_out_dat$IVch2+model_out_dat$IVcl2+model_out_dat$RVch2+model_out_dat$RVcl2+
  
  model_out_dat$DVch+model_out_dat$DVcl+model_out_dat$DVch2+model_out_dat$DVcl2+
  model_out_dat$DBch+model_out_dat$DBcl+model_out_dat$DBch2+model_out_dat$DBcl2


model_out_dat$pboost.coverage_of_vaccinated<-(model_out_dat$Nboosted.adult+model_out_dat$Nboosted.old + model_out_dat$Nboosted.child)/(model_out_dat$Nvax.adult+model_out_dat$Nvax.old+model_out_dat$Nvax.child)


model_out_dat <- model_out_dat %>% 
  pivot_longer(-c(time, boost.speed, sweepnum, boost.child, cvax, relativeFOI,
                  boost.adult, max.boost_h, max.boost_l, max.boost.child, wanevar,
                  child.max,cp,base.imm,sd,relax,boost.start,dWVH,k_h,k_l,
                  vei2,veh2,popsize, boost.start.time, Booster
  )) %>% 
  filter(name %in% c("Iall", "Iprop", "pboost.coverage_of_vaccinated"))


write_csv(model_out_dat, "../Data/ODE Supplement/India_ts base.wane.csv")

```


## Get Efficacy Sweep

##### Malaysia grid
```{r}
#### Malaysia grid ####

end_malaysia_sweep<-readRDS('../Data/ODE_SA_Efficacy/endfile_sweep010224_malaysiagrid_Evax.RDS')
end_malaysia_sweep$popsize<-28552712
end_malaysia_sweep$deaths_100k<-(end_malaysia_sweep$DeathsAll/end_malaysia_sweep$popsize)*100000
end_noboost_malaysia<-subset(end_malaysia_sweep, end_malaysia_sweep$boost.adult==0)
end_boost_malaysia<-subset(end_malaysia_sweep, end_malaysia_sweep$boost.adult>0)
sum(end_malaysia_sweep[1,c(2:217)])

end_boost <-end_boost_malaysia %>% 
  pivot_longer(-c(time, boost.speed, sweepnum, boost.child, cvax,
                  boost.adult, max.boost_h, max.boost_l, max.boost.child, wanevar,
                  child.max,cp,base.imm,sd,relax,boost.start,dWVH,k_h,k_l,
                  vei2,veh2,DeathsAll,popsize,deaths_100k
  ))
end_no_boost <- end_noboost_malaysia %>% 
  pivot_longer(-c(time, boost.speed, sweepnum, boost.child, cvax,
                  boost.adult, max.boost_h, max.boost_l, max.boost.child, wanevar,
                  child.max,cp,base.imm,sd,relax,boost.start,dWVH,k_h,k_l,
                  vei2,veh2,DeathsAll,popsize,deaths_100k
  ))

dfCompODE <- end_noboost_malaysia %>% 
  select(deaths_100k, DeathsAll, cp, relax, 
         base.imm) %>% 
  distinct() %>% 
  rename(deaths_100k_comp = deaths_100k,
         DeathsAll_comp = DeathsAll)

df_AvertedODE <- end_boost %>% 
  left_join(dfCompODE, by = c("relax", "cp", "base.imm")) %>% 
  mutate(
    da = (deaths_100k_comp - deaths_100k)/deaths_100k_comp
  ) %>% 
  distinct()

write_csv(df_AvertedODE, "../Data/ODE Supplement/Malaysia_grid_da_efficacy.csv")
```


##### Ecuador grid
```{r}
#### Ecuador grid ####

end_ecuador_sweep<-readRDS('../Data/ODE_SA_Efficacy/endfile_sweep010424_ecuadorgrid.RDS')
end_ecuador_sweep$popsize<-15735139
end_ecuador_sweep$deaths_100k<-(end_ecuador_sweep$DeathsAll/end_ecuador_sweep$popsize)*100000
end_noboost_ecuador<-subset(end_ecuador_sweep, end_ecuador_sweep$boost.adult==0)
end_boost_ecuador<-subset(end_ecuador_sweep, end_ecuador_sweep$boost.adult>0)
sum(end_ecuador_sweep[1,c(2:217)])

end_boost <-end_boost_ecuador %>% 
  pivot_longer(-c(time, boost.speed, sweepnum, boost.child, cvax,
                  boost.adult, max.boost_h, max.boost_l, max.boost.child, wanevar,
                  child.max,cp,base.imm,sd,relax,boost.start,dWVH,k_h,k_l,
                  vei2,veh2,DeathsAll,popsize,deaths_100k
  ))
end_no_boost <- end_noboost_ecuador %>% 
  pivot_longer(-c(time, boost.speed, sweepnum, boost.child, cvax,
                  boost.adult, max.boost_h, max.boost_l, max.boost.child, wanevar,
                  child.max,cp,base.imm,sd,relax,boost.start,dWVH,k_h,k_l,
                  vei2,veh2,DeathsAll,popsize,deaths_100k
  ))

dfCompODE <- end_noboost_ecuador %>% 
  select(deaths_100k, DeathsAll, cp, relax, 
         base.imm) %>% distinct() %>% 
  rename(deaths_100k_comp = deaths_100k,
         DeathsAll_comp = DeathsAll)

df_AvertedODE <- end_boost %>% 
  left_join(dfCompODE, by = c("relax", "cp", "base.imm")) %>% 
  mutate(
    da = (deaths_100k_comp - deaths_100k)/deaths_100k_comp
  ) %>% 
  distinct()

write_csv(df_AvertedODE, "../Data/ODE Supplement/Ecuador_grid_da_efficacy.csv")
```

##### India grid
```{r}
#### India grid ####

end_india_sweep<-readRDS('../Data/ODE_SA_Efficacy/endfile_sweep010324_indiagrid_Evax.RDS')
end_india_sweep$popsize<-1155561222
end_india_sweep$deaths_100k<-(end_india_sweep$DeathsAll/end_india_sweep$popsize)*100000
end_noboost_india<-subset(end_india_sweep, end_india_sweep$boost.adult==0)
end_boost_india<-subset(end_india_sweep, end_india_sweep$boost.adult>0)
sum(end_india_sweep[1,c(2:217)])

end_boost <-end_boost_india %>% 
  pivot_longer(-c(time, boost.speed, sweepnum, boost.child, cvax,
                  boost.adult, max.boost_h, max.boost_l, max.boost.child, wanevar,
                  child.max,cp,base.imm,sd,relax,boost.start,dWVH,k_h,k_l,
                  vei2,veh2,DeathsAll,popsize,deaths_100k
  ))
end_no_boost <- end_noboost_india %>% 
  pivot_longer(-c(time, boost.speed, sweepnum, boost.child, cvax,
                  boost.adult, max.boost_h, max.boost_l, max.boost.child, wanevar,
                  child.max,cp,base.imm,sd,relax,boost.start,dWVH,k_h,k_l,
                  vei2,veh2,DeathsAll,popsize,deaths_100k
  ))

dfCompODE <- end_noboost_india %>% 
  select(deaths_100k, DeathsAll, cp, relax, 
         base.imm) %>% distinct() %>% 
  rename(deaths_100k_comp = deaths_100k,
         DeathsAll_comp = DeathsAll)

df_AvertedODE <- end_boost %>% 
  left_join(dfCompODE, by = c("relax", "cp", "base.imm")) %>% 
  mutate(
    da = (deaths_100k_comp - deaths_100k)/deaths_100k_comp
  ) %>% 
  distinct()

write_csv(df_AvertedODE, "../Data/ODE Supplement/India_grid_da_efficacy.csv")
```


## Efficacy 90% baseimm sweep

##### Malaysia grid
```{r}
#### Malaysia grid ####

end_malaysia_sweep<-readRDS('../Data/ODE_SA_Efficacy_HighBaseImm/endfile_sweep010224_malaysiagrid_Evax.RDS')
end_malaysia_sweep$popsize<-28552712
end_malaysia_sweep$deaths_100k<-(end_malaysia_sweep$DeathsAll/end_malaysia_sweep$popsize)*100000
end_noboost_malaysia<-subset(end_malaysia_sweep, end_malaysia_sweep$boost.adult==0)
end_boost_malaysia<-subset(end_malaysia_sweep, end_malaysia_sweep$boost.adult>0)
sum(end_malaysia_sweep[1,c(2:217)])

end_boost <-end_boost_malaysia %>% 
  pivot_longer(-c(time, boost.speed, sweepnum, boost.child, cvax,
                  boost.adult, max.boost_h, max.boost_l, max.boost.child, wanevar,
                  child.max,cp,base.imm,sd,relax,boost.start,dWVH,k_h,k_l,
                  vei2,veh2,DeathsAll,popsize,deaths_100k
  ))
end_no_boost <- end_noboost_malaysia %>% 
  pivot_longer(-c(time, boost.speed, sweepnum, boost.child, cvax,
                  boost.adult, max.boost_h, max.boost_l, max.boost.child, wanevar,
                  child.max,cp,base.imm,sd,relax,boost.start,dWVH,k_h,k_l,
                  vei2,veh2,DeathsAll,popsize,deaths_100k
  ))

dfCompODE <- end_noboost_malaysia %>% 
  select(deaths_100k, DeathsAll, cp, relax, 
         base.imm) %>% 
  distinct() %>% 
  rename(deaths_100k_comp = deaths_100k,
         DeathsAll_comp = DeathsAll)

df_AvertedODE <- end_boost %>% 
  left_join(dfCompODE, by = c("relax", "cp", "base.imm")) %>% 
  mutate(
    da = (deaths_100k_comp - deaths_100k)/deaths_100k_comp
  ) %>% 
  distinct()

write_csv(df_AvertedODE, "../Data/ODE Supplement/Malaysia_grid_da_efficacy_90baseimm.csv")
```


##### Ecuador grid
```{r}
#### Ecuador grid ####

end_ecuador_sweep<-readRDS('../Data/ODE_SA_Efficacy_HighBaseImm/endfile_sweep010424_ecuadorgrid.RDS')
end_ecuador_sweep$popsize<-15735139
end_ecuador_sweep$deaths_100k<-(end_ecuador_sweep$DeathsAll/end_ecuador_sweep$popsize)*100000
end_noboost_ecuador<-subset(end_ecuador_sweep, end_ecuador_sweep$boost.adult==0)
end_boost_ecuador<-subset(end_ecuador_sweep, end_ecuador_sweep$boost.adult>0)
sum(end_ecuador_sweep[1,c(2:217)])

end_boost <-end_boost_ecuador %>% 
  pivot_longer(-c(time, boost.speed, sweepnum, boost.child, cvax,
                  boost.adult, max.boost_h, max.boost_l, max.boost.child, wanevar,
                  child.max,cp,base.imm,sd,relax,boost.start,dWVH,k_h,k_l,
                  vei2,veh2,DeathsAll,popsize,deaths_100k
  ))
end_no_boost <- end_noboost_ecuador %>% 
  pivot_longer(-c(time, boost.speed, sweepnum, boost.child, cvax,
                  boost.adult, max.boost_h, max.boost_l, max.boost.child, wanevar,
                  child.max,cp,base.imm,sd,relax,boost.start,dWVH,k_h,k_l,
                  vei2,veh2,DeathsAll,popsize,deaths_100k
  ))

dfCompODE <- end_noboost_ecuador %>% 
  select(deaths_100k, DeathsAll, cp, relax, 
         base.imm) %>% distinct() %>% 
  rename(deaths_100k_comp = deaths_100k,
         DeathsAll_comp = DeathsAll)

df_AvertedODE <- end_boost %>% 
  left_join(dfCompODE, by = c("relax", "cp", "base.imm")) %>% 
  mutate(
    da = (deaths_100k_comp - deaths_100k)/deaths_100k_comp
  ) %>% 
  distinct()

write_csv(df_AvertedODE, "../Data/ODE Supplement/Ecuador_grid_da_efficacy_90baseimm.csv")
```

##### India grid
```{r}
#### India grid ####

end_india_sweep<-readRDS('../Data/ODE_SA_Efficacy_HighBaseImm/endfile_sweep010324_indiagrid_Evax.RDS')
end_india_sweep$popsize<-1155561222
end_india_sweep$deaths_100k<-(end_india_sweep$DeathsAll/end_india_sweep$popsize)*100000
end_noboost_india<-subset(end_india_sweep, end_india_sweep$boost.adult==0)
end_boost_india<-subset(end_india_sweep, end_india_sweep$boost.adult>0)
sum(end_india_sweep[1,c(2:217)])

end_boost <-end_boost_india %>% 
  pivot_longer(-c(time, boost.speed, sweepnum, boost.child, cvax,
                  boost.adult, max.boost_h, max.boost_l, max.boost.child, wanevar,
                  child.max,cp,base.imm,sd,relax,boost.start,dWVH,k_h,k_l,
                  vei2,veh2,DeathsAll,popsize,deaths_100k
  ))
end_no_boost <- end_noboost_india %>% 
  pivot_longer(-c(time, boost.speed, sweepnum, boost.child, cvax,
                  boost.adult, max.boost_h, max.boost_l, max.boost.child, wanevar,
                  child.max,cp,base.imm,sd,relax,boost.start,dWVH,k_h,k_l,
                  vei2,veh2,DeathsAll,popsize,deaths_100k
  ))

dfCompODE <- end_noboost_india %>% 
  select(deaths_100k, DeathsAll, cp, relax, 
         base.imm) %>% distinct() %>% 
  rename(deaths_100k_comp = deaths_100k,
         DeathsAll_comp = DeathsAll)

df_AvertedODE <- end_boost %>% 
  left_join(dfCompODE, by = c("relax", "cp", "base.imm")) %>% 
  mutate(
    da = (deaths_100k_comp - deaths_100k)/deaths_100k_comp
  ) %>% 
  distinct()

write_csv(df_AvertedODE, "../Data/ODE Supplement/India_grid_da_efficacy_90baseimm.csv")
```
